<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/Web%E5%BA%94%E7%94%A8%E6%BC%8F%E6%B4%9E/CSZ%20CMS/CSZ%20CMS%201.2.7%20%E5%82%A8%E5%AD%98%E5%9E%8Bxss/">
    <link rel="shortcut icon" href="../../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>CSZ CMS 1.2.7 储存型xss - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "CSZ CMS 1.2.7 \u50a8\u5b58\u578bxss", url: "#_top", children: [
              {title: "\u4e00\u3001\u6f0f\u6d1e\u7b80\u4ecb", url: "#_1" },
              {title: "\u4e8c\u3001\u6f0f\u6d1e\u5f71\u54cd", url: "#_2" },
              {title: "\u4e09\u3001\u590d\u73b0\u8fc7\u7a0b", url: "#_3" },
              {title: "\u53c2\u8003\u94fe\u63a5", url: "#_6" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
      <script src="../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../%EF%BC%88CVE-2019-13086%EF%BC%89CSZ%20CMS%201.2.2%20sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../%EF%BC%88CVE-2019-13086%EF%BC%89CSZ%20CMS%201.2.2%20sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        （CVE-2019-13086）CSZ CMS 1.2.2 sql注入漏洞
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../CRMEB/CRMEB%E7%94%B5%E5%95%86%E7%B3%BB%E7%BB%9FPublicController.php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%28CVE-2024-6944%29/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../CRMEB/CRMEB%E7%94%B5%E5%95%86%E7%B3%BB%E7%BB%9FPublicController.php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%28CVE-2024-6944%29/" class="btn btn-xs btn-link">
        CRMEB电商系统PublicController.php反序列化漏洞(CVE-2024-6944)
      </a>
    </div>
    
  </div>

    

    <h1 id="csz-cms-127-xss">CSZ CMS 1.2.7 储存型xss<a class="headerlink" href="#csz-cms-127-xss" title="Permanent link">&para;</a></h1>
<h2 id="_1">一、漏洞简介<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>拥有访问私有消息的未授权用户可以向管理面板嵌入Javascript代码。</p>
<h2 id="_2">二、漏洞影响<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>CSZ CMS 1.2.7</p>
<h2 id="_3">三、复现过程<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<h3 id="_4">漏洞分析<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p>查看数据库中的email_logs可知，将访问的user-agent存储到了数据库中1.png</p>
<p>我们首先观察路由，漏洞点在/member/insertpm页面，查看控制器，找到cszcms/controllers/Member.php</p>
<p>2.png找到insertpm方法：</p>
<p>3.png关注点在下半部分：</p>
<p>$this-&gt;input-&gt;post即是调用的system/core/Input.php的post方法：</p>
<p>4.png当$xss_clean的参数设置为true，则会进行xss过滤，这也是为什么发送信息处并没有出现xss</p>
<p>继续看，$this-&gt;Csz_auth_model-&gt;send_pm方法位于cszcms/models/Csz_auth_model.php中的send_pm():</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/**</span>
<span class="cm">     * Send multiple Private Messages</span>
<span class="cm">     * Send multiple private messages to another users</span>
<span class="cm">     * </span>
<span class="cm">     * @param array $receiver_ids Array of User ids of private message receiver </span>
<span class="cm">     * @param string $title Title/subject</span>
<span class="cm">     * @param string $message Message</span>
<span class="cm">     * @param int $sender_id User id of private message sender</span>
<span class="cm">     * @param string $re_message Reply the original message</span>
<span class="cm">     * </span>
<span class="cm">     * @return array/bool Array with User ID&#39;s as key and TRUE or a specific error message OR FALSE if sender doesn&#39;t exist</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="n">send_pm</span><span class="p">(</span><span class="err">$</span><span class="n">receiver_ids</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">title</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">sender_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">re_message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="err">!$</span><span class="n">sender_id</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">            </span><span class="err">$</span><span class="n">sender_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="k">session</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">(</span><span class="s1">&#39;user_admin_id&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="err">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="err">$</span><span class="n">sender_id</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="err">!$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">is_useractive</span><span class="p">(</span><span class="err">$</span><span class="n">sender_id</span><span class="p">)))</span><span class="w"> </span><span class="err">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">FALSE</span><span class="p">;</span>
<span class="w">        </span><span class="err">}</span><span class="k">else</span><span class="err">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="err">$</span><span class="n">receiver_ids</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">is_numeric</span><span class="p">(</span><span class="err">$</span><span class="n">receiver_ids</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="err">$</span><span class="n">sender_id</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="err">$</span><span class="n">receiver_ids</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="err">$</span><span class="n">re_message</span><span class="p">)</span><span class="err">{</span><span class="w"> </span>
<span class="w">                    </span><span class="err">$</span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;{[&#39;</span><span class="w"> </span><span class="p">.</span><span class="w"> </span><span class="n">str_replace</span><span class="p">(</span><span class="ss">&quot;\r\n&quot;</span><span class="w"> </span><span class="p">.</span><span class="w"> </span><span class="ss">&quot;\r\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;\r\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">re_message</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="w"> </span><span class="ss">&quot;]} &quot;</span><span class="w"> </span><span class="p">.</span><span class="w"> </span><span class="ss">&quot;\r\n&quot;</span><span class="w"> </span><span class="p">.</span><span class="w"> </span><span class="ss">&quot;\r\n&quot;</span><span class="w"> </span><span class="p">.</span><span class="w"> </span><span class="err">$</span><span class="n">message</span><span class="p">;</span>
<span class="w">                </span><span class="err">}</span>
<span class="w">                </span><span class="err">$</span><span class="k">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">array</span><span class="p">(</span>
<span class="w">                    </span><span class="s1">&#39;sender_id&#39;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="err">$</span><span class="n">sender_id</span><span class="p">,</span>
<span class="w">                    </span><span class="s1">&#39;receiver_id&#39;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="err">$</span><span class="n">receiver_ids</span><span class="p">,</span>
<span class="w">                    </span><span class="s1">&#39;title&#39;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="err">$</span><span class="n">title</span><span class="p">,</span>
<span class="w">                    </span><span class="s1">&#39;message&#39;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="err">$</span><span class="n">message</span><span class="p">,</span>
<span class="w">                    </span><span class="s1">&#39;date_sent&#39;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nc">date</span><span class="p">(</span><span class="s1">&#39;Y-m-d H:i:s&#39;</span><span class="p">)</span>
<span class="w">                </span><span class="p">);</span>
<span class="w">                </span><span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">db</span><span class="o">-&gt;</span><span class="k">insert</span><span class="p">(</span><span class="s1">&#39;user_pms&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="k">data</span><span class="p">);</span>
<span class="w">                </span><span class="err">$</span><span class="n">sender_user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">Csz_admin_model</span><span class="o">-&gt;</span><span class="n">getUser</span><span class="p">(</span><span class="err">$</span><span class="n">sender_id</span><span class="p">);</span>
<span class="w">                </span><span class="err">$</span><span class="n">receive_user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">Csz_admin_model</span><span class="o">-&gt;</span><span class="n">getUser</span><span class="p">(</span><span class="err">$</span><span class="n">receiver_ids</span><span class="p">);</span>
<span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="err">$</span><span class="n">receive_user</span><span class="o">-&gt;</span><span class="n">pm_sendmail</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;1&#39;</span><span class="p">)</span><span class="err">{</span>
<span class="w">                    </span><span class="err">$</span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">Csz_model</span><span class="o">-&gt;</span><span class="n">load_config</span><span class="p">();</span>
<span class="w">                    </span><span class="err">$</span><span class="n">message_html</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Dear &#39;</span><span class="w"> </span><span class="p">.</span><span class="w"> </span><span class="err">$</span><span class="n">receive_user</span><span class="o">-&gt;</span><span class="n">name</span><span class="w"> </span><span class="p">.</span><span class="w"> </span><span class="s1">&#39;,&lt;br&gt;&lt;br&gt;&#39;</span><span class="w"> </span><span class="p">.</span><span class="w"> </span><span class="err">$</span><span class="n">message</span><span class="w"> </span><span class="p">.</span><span class="w"> </span><span class="s1">&#39;&lt;br&gt;&lt;br&gt;Best Regards,&lt;br&gt;&#39;</span><span class="p">.</span><span class="err">$</span><span class="n">sender_user</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
<span class="w">                    </span><span class="err">@$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">Csz_model</span><span class="o">-&gt;</span><span class="n">sendEmail</span><span class="p">(</span><span class="err">$</span><span class="n">receive_user</span><span class="o">-&gt;</span><span class="n">email</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;[PM] &#39;</span><span class="w"> </span><span class="p">.</span><span class="w"> </span><span class="err">$</span><span class="n">title</span><span class="w"> </span><span class="p">.</span><span class="w"> </span><span class="s1">&#39; (&#39;</span><span class="p">.</span><span class="err">$</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">site_name</span><span class="p">.</span><span class="s1">&#39;)&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">message_html</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">sender_user</span><span class="o">-&gt;</span><span class="n">email</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">sender_user</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="w">                </span><span class="err">}</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="k">TRUE</span><span class="p">;</span>
<span class="w">            </span><span class="err">}</span><span class="k">else</span><span class="err">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="k">FALSE</span><span class="p">;</span>
<span class="w">            </span><span class="err">}</span>
<span class="w">        </span><span class="err">}</span>
<span class="w">    </span><span class="err">}</span>
</code></pre></div>

<p>调用了@$this-&gt;Csz_model-&gt;sendEmail方法，位于cszcms/models/Csz_model.php，我们继续跟进：</p>
<div class="codehilite"><pre><span></span><code><span class="n">public</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">sendEmail</span><span class="p">(</span><span class="o">$</span><span class="n">to_email</span><span class="p">,</span><span class="w"> </span><span class="o">$</span><span class="n">subject</span><span class="p">,</span><span class="w"> </span><span class="o">$</span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="o">$</span><span class="n">from_email</span><span class="p">,</span><span class="w"> </span><span class="o">$</span><span class="n">from_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="o">$</span><span class="n">bcc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="o">$</span><span class="n">reply_to</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="o">$</span><span class="n">alt_message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="o">$</span><span class="n">attach_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">array</span><span class="p">(),</span><span class="w"> </span><span class="o">$</span><span class="n">save_log</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TRUE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="nb">load</span><span class="o">-&gt;</span><span class="n">library</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="o">$</span><span class="n">load_conf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">load_config</span><span class="p">();</span>
<span class="w">        </span><span class="o">$</span><span class="n">protocal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="n">load_conf</span><span class="o">-&gt;</span><span class="n">email_protocal</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!$</span><span class="n">protocal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="o">$</span><span class="n">protocal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;mail&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="o">$</span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">array</span><span class="p">();</span>
<span class="w">        </span><span class="o">$</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;useragent&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">Csz_admin_model</span><span class="o">-&gt;</span><span class="n">cszGenerateMeta</span><span class="p">();</span>
<span class="w">        </span><span class="o">$</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;protocol&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="n">protocal</span><span class="p">;</span><span class="w">  </span><span class="o">/*</span><span class="w"> </span><span class="n">mail</span><span class="p">,</span><span class="w"> </span><span class="n">sendmail</span><span class="p">,</span><span class="w"> </span><span class="n">smtp</span><span class="w"> </span><span class="o">*/</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">$</span><span class="n">protocal</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;smtp&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="o">$</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;smtp_host&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="n">load_conf</span><span class="o">-&gt;</span><span class="n">smtp_host</span><span class="p">;</span>
<span class="w">            </span><span class="o">$</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;smtp_user&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="n">load_conf</span><span class="o">-&gt;</span><span class="n">smtp_user</span><span class="p">;</span>
<span class="w">            </span><span class="o">$</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;smtp_pass&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="n">load_conf</span><span class="o">-&gt;</span><span class="n">smtp_pass</span><span class="p">;</span>
<span class="w">            </span><span class="o">$</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;smtp_port&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="n">load_conf</span><span class="o">-&gt;</span><span class="n">smtp_port</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">$</span><span class="n">protocal</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;sendmail&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">$</span><span class="n">load_conf</span><span class="o">-&gt;</span><span class="n">sendmail_path</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="o">$</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;mailpath&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="n">load_conf</span><span class="o">-&gt;</span><span class="n">sendmail_path</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="o">$</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;mailtype&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;html&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="o">$</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;charset&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;utf-8&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="o">$</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;wordwrap&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TRUE</span><span class="p">;</span>
<span class="w">        </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">email</span><span class="o">-&gt;</span><span class="n">initialize</span><span class="p">(</span><span class="o">$</span><span class="n">config</span><span class="p">);</span>
<span class="w">        </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">email</span><span class="o">-&gt;</span><span class="n">set_newline</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">email</span><span class="o">-&gt;</span><span class="n">from</span><span class="p">(</span><span class="o">$</span><span class="n">from_email</span><span class="p">,</span><span class="w"> </span><span class="o">$</span><span class="n">from_name</span><span class="p">);</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">change</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">yours</span>
<span class="w">        </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">email</span><span class="o">-&gt;</span><span class="n">to</span><span class="p">(</span><span class="o">$</span><span class="n">to_email</span><span class="p">);</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">change</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">yours</span>
<span class="w">        </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">email</span><span class="o">-&gt;</span><span class="n">subject</span><span class="p">(</span><span class="o">$</span><span class="n">subject</span><span class="p">);</span>
<span class="w">        </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">email</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">(</span><span class="o">$</span><span class="n">message</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">$</span><span class="n">bcc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">email</span><span class="o">-&gt;</span><span class="n">bcc</span><span class="p">(</span><span class="o">$</span><span class="n">bcc</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">$</span><span class="n">reply_to</span><span class="p">){</span>
<span class="w">            </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">email</span><span class="o">-&gt;</span><span class="n">reply_to</span><span class="p">(</span><span class="o">$</span><span class="n">reply_to</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">$</span><span class="n">alt_message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">email</span><span class="o">-&gt;</span><span class="n">set_alt_message</span><span class="p">(</span><span class="o">$</span><span class="n">alt_message</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">is_array</span><span class="p">(</span><span class="o">$</span><span class="n">attach_file</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">empty</span><span class="p">(</span><span class="o">$</span><span class="n">attach_file</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">foreach</span><span class="w"> </span><span class="p">(</span><span class="o">$</span><span class="n">attach_file</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">$</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">email</span><span class="o">-&gt;</span><span class="n">attach</span><span class="p">(</span><span class="o">$</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;attachment&#39;</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">email</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="o">$</span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;success&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="o">$</span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">email</span><span class="o">-&gt;</span><span class="n">print_debugger</span><span class="p">(</span><span class="n">FALSE</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">$</span><span class="n">save_log</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="n">TRUE</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">$</span><span class="n">load_conf</span><span class="o">-&gt;</span><span class="n">email_logs</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">){</span>
<span class="w">            </span><span class="o">$</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">array</span><span class="p">(</span>
<span class="w">                </span><span class="s1">&#39;to_email&#39;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">$</span><span class="n">to_email</span><span class="p">,</span>
<span class="w">                </span><span class="s1">&#39;from_email&#39;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">$</span><span class="n">from_email</span><span class="p">,</span>
<span class="w">                </span><span class="s1">&#39;from_name&#39;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">$</span><span class="n">from_name</span><span class="p">,</span>
<span class="w">                </span><span class="s1">&#39;subject&#39;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">$</span><span class="n">subject</span><span class="p">,</span>
<span class="w">                </span><span class="s1">&#39;message&#39;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">$</span><span class="n">message</span><span class="p">,</span>
<span class="w">                </span><span class="s1">&#39;email_result&#39;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">$</span><span class="n">result</span><span class="p">,</span>
<span class="w">            </span><span class="p">);</span>
<span class="w">            </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;user_agent&#39;</span><span class="p">,</span><span class="w"> </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">user_agent</span><span class="p">(),</span><span class="w"> </span><span class="n">TRUE</span><span class="p">);</span>
<span class="w">            </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;ip_address&#39;</span><span class="p">,</span><span class="w"> </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">ip_address</span><span class="p">(),</span><span class="w"> </span><span class="n">TRUE</span><span class="p">);</span>
<span class="w">            </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;timestamp_create&#39;</span><span class="p">,</span><span class="w"> </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">timeNow</span><span class="p">(),</span><span class="w"> </span><span class="n">TRUE</span><span class="p">);</span>
<span class="w">            </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">insert</span><span class="p">(</span><span class="s1">&#39;email_logs&#39;</span><span class="p">,</span><span class="w"> </span><span class="o">$</span><span class="n">data</span><span class="p">);</span>
<span class="w">            </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">cache_delete_all</span><span class="p">();</span>
<span class="w">            </span><span class="n">unset</span><span class="p">(</span><span class="o">$</span><span class="n">data</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">unset</span><span class="p">(</span><span class="o">$</span><span class="n">to_email</span><span class="p">,</span><span class="w"> </span><span class="o">$</span><span class="n">subject</span><span class="p">,</span><span class="w"> </span><span class="o">$</span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="o">$</span><span class="n">from_email</span><span class="p">,</span><span class="w"> </span><span class="o">$</span><span class="n">from_name</span><span class="p">,</span><span class="w"> </span><span class="o">$</span><span class="n">bcc</span><span class="p">,</span><span class="w"> </span><span class="o">$</span><span class="n">reply_to</span><span class="p">,</span><span class="w"> </span><span class="o">$</span><span class="n">alt_message</span><span class="p">,</span><span class="w"> </span><span class="o">$</span><span class="n">attach_file</span><span class="p">,</span><span class="w"> </span><span class="o">$</span><span class="n">save_log</span><span class="p">,</span><span class="w"> </span><span class="o">$</span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="o">$</span><span class="n">load_conf</span><span class="p">,</span><span class="w"> </span><span class="o">$</span><span class="n">protocal</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">$</span><span class="n">result</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>

<p>关键就在于后面的数据库操作：</p>
<div class="codehilite"><pre><span></span><code><span class="err">$</span><span class="nx">this</span><span class="o">-&gt;</span><span class="nx">db</span><span class="o">-&gt;</span><span class="nx">set</span><span class="p">(</span><span class="err">&#39;</span><span class="nx">user_agent</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="nx">this</span><span class="o">-&gt;</span><span class="nx">input</span><span class="o">-&gt;</span><span class="nx">user_agent</span><span class="p">(),</span><span class="w"> </span><span class="nx">TRUE</span><span class="p">);</span>
<span class="w">        </span><span class="err">$</span><span class="nx">this</span><span class="o">-&gt;</span><span class="nx">db</span><span class="o">-&gt;</span><span class="nx">set</span><span class="p">(</span><span class="err">&#39;</span><span class="nx">ip_address</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="nx">this</span><span class="o">-&gt;</span><span class="nx">input</span><span class="o">-&gt;</span><span class="nx">ip_address</span><span class="p">(),</span><span class="w"> </span><span class="nx">TRUE</span><span class="p">);</span>
<span class="w">        </span><span class="err">$</span><span class="nx">this</span><span class="o">-&gt;</span><span class="nx">db</span><span class="o">-&gt;</span><span class="nx">set</span><span class="p">(</span><span class="err">&#39;</span><span class="nx">timestamp_create</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="nx">this</span><span class="o">-&gt;</span><span class="nx">timeNow</span><span class="p">(),</span><span class="w"> </span><span class="nx">TRUE</span><span class="p">);</span>
<span class="w">        </span><span class="err">$</span><span class="nx">this</span><span class="o">-&gt;</span><span class="nx">db</span><span class="o">-&gt;</span><span class="nx">insert</span><span class="p">(</span><span class="err">&#39;</span><span class="nx">email_logs</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="nx">data</span><span class="p">);</span>
<span class="w">        </span><span class="err">$</span><span class="nx">this</span><span class="o">-&gt;</span><span class="nx">db</span><span class="o">-&gt;</span><span class="nx">cache_delete_all</span><span class="p">();</span>
</code></pre></div>

<p>$this-&gt;db-&gt;set方法位于：system/database/DB_query_builder.php：</p>
<div class="codehilite"><pre><span></span><code><span class="o">/**</span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="s">&quot;set&quot;</span><span class="w"> </span><span class="k">function</span><span class="p">.</span>
<span class="w"> </span><span class="o">*</span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Allows</span><span class="w"> </span><span class="n">key</span><span class="o">/</span><span class="n">value</span><span class="w"> </span><span class="n">pairs</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">inserting</span><span class="w"> </span><span class="nb">or</span><span class="w"> </span><span class="n">updating</span>
<span class="w"> </span><span class="o">*</span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">@</span><span class="n">param</span><span class="w">   </span><span class="n">mixed</span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">@</span><span class="n">param</span><span class="w">   </span><span class="nb">string</span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">@</span><span class="n">param</span><span class="w">   </span><span class="n">bool</span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">@</span><span class="k">return</span><span class="w">  </span><span class="n">CI_DB_query_builder</span>
<span class="w"> </span><span class="o">*/</span>
<span class="n">public</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="k">set</span><span class="p">(</span><span class="no">$</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="no">$</span><span class="n">value</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="no">$</span><span class="n">escape</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">NULL</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="no">$</span><span class="n">key</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="no">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">_object_to_array</span><span class="p">(</span><span class="no">$</span><span class="n">key</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span>!<span class="w"> </span><span class="n">is_array</span><span class="p">(</span><span class="no">$</span><span class="n">key</span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="no">$</span><span class="n">key</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">array</span><span class="p">(</span><span class="no">$</span><span class="n">key</span><span class="w"> </span><span class="p">=</span><span class="o">&gt;</span><span class="w"> </span><span class="no">$</span><span class="n">value</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">is_bool</span><span class="p">(</span><span class="no">$</span><span class="n">escape</span><span class="p">)</span><span class="w"> </span><span class="n">OR</span><span class="w"> </span><span class="no">$</span><span class="n">escape</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="no">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">_protect_identifiers</span><span class="p">;</span>

<span class="w">    </span><span class="n">foreach</span><span class="w"> </span><span class="p">(</span><span class="no">$</span><span class="n">key</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="no">$</span><span class="n">k</span><span class="w"> </span><span class="p">=</span><span class="o">&gt;</span><span class="w"> </span><span class="no">$</span><span class="n">v</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="no">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">qb_set</span><span class="p">[</span><span class="no">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">protect_identifiers</span><span class="p">(</span><span class="no">$</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">FALSE</span><span class="p">,</span><span class="w"> </span><span class="no">$</span><span class="n">escape</span><span class="p">)]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">(</span><span class="no">$</span><span class="n">escape</span><span class="p">)</span>
<span class="w">            </span>?<span class="w"> </span><span class="no">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">escape</span><span class="p">(</span><span class="no">$</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">$</span><span class="n">v</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="no">$</span><span class="n">this</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>简单理解即为插入或更新值作初始化</p>
<p>继续，$this-&gt;input-&gt;user_agent()位于：system/core/Input.php，其具体实现如下：</p>
<div class="codehilite"><pre><span></span><code><span class="o">/**</span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Fetch</span><span class="w"> </span><span class="n">User</span><span class="w"> </span><span class="n">Agent</span><span class="w"> </span><span class="nb">string</span>
<span class="w"> </span><span class="o">*</span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">@</span><span class="k">return</span><span class="w">  </span><span class="nb">string</span><span class="o">|</span><span class="nb">null</span><span class="w"> </span><span class="n">User</span><span class="w"> </span><span class="n">Agent</span><span class="w"> </span><span class="nb">string</span><span class="w"> </span><span class="nb">or</span><span class="w"> </span><span class="n">NULL</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">doesn</span><span class="o">&#39;</span><span class="n">t</span><span class="w"> </span><span class="n">exist</span>
<span class="w"> </span><span class="o">*/</span>
<span class="n">public</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="n">user_agent</span><span class="p">(</span><span class="no">$</span><span class="n">xss_clean</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">NULL</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="no">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">_fetch_from_array</span><span class="p">(</span><span class="no">$</span><span class="n">_SERVER</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;HTTP_USER_AGENT&#39;</span><span class="p">,</span><span class="w"> </span><span class="no">$</span><span class="n">xss_clean</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>这里的xss过滤操作默认是null，也就是没有过滤</p>
<p>这就是问题所在，我们即可以通过篡改user_agent的值实现xss，往下看，<code>$this-&gt;db-&gt;insert('email_logs', $data)</code>即向emali_logs表插入数据，<code>$this-&gt;db-&gt;insert</code>实现如下（system/core/Input.php）：</p>
<div class="codehilite"><pre><span></span><code><span class="o">/**</span>
<span class="w">     </span><span class="o">*</span><span class="w"> </span><span class="n">Insert</span>
<span class="w">     </span><span class="o">*</span>
<span class="w">     </span><span class="o">*</span><span class="w"> </span><span class="n">Compiles</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">insert</span><span class="w"> </span><span class="nb">string</span><span class="w"> </span><span class="nb">and</span><span class="w"> </span><span class="n">runs</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">query</span>
<span class="w">     </span><span class="o">*</span>
<span class="w">     </span><span class="o">*</span><span class="w"> </span><span class="p">@</span><span class="n">param</span><span class="w">   </span><span class="nb">string</span><span class="w">  </span><span class="n">the</span><span class="w"> </span><span class="n">table</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">insert</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">into</span>
<span class="w">     </span><span class="o">*</span><span class="w"> </span><span class="p">@</span><span class="n">param</span><span class="w">   </span><span class="n">array</span><span class="w">   </span><span class="n">an</span><span class="w"> </span><span class="n">associative</span><span class="w"> </span><span class="n">array</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">insert</span><span class="w"> </span><span class="n">values</span>
<span class="w">     </span><span class="o">*</span><span class="w"> </span><span class="p">@</span><span class="n">param</span><span class="w">   </span><span class="n">bool</span><span class="w">    </span><span class="no">$</span><span class="n">escape</span><span class="w"> </span><span class="n">Whether</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">escape</span><span class="w"> </span><span class="n">values</span><span class="w"> </span><span class="nb">and</span><span class="w"> </span><span class="n">identifiers</span>
<span class="w">     </span><span class="o">*</span><span class="w"> </span><span class="p">@</span><span class="k">return</span><span class="w">  </span><span class="n">bool</span><span class="w">    </span><span class="n">TRUE</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">success</span><span class="p">,</span><span class="w"> </span><span class="n">FALSE</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">failure</span>
<span class="w">     </span><span class="o">*/</span>
<span class="w">    </span><span class="n">public</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="n">insert</span><span class="p">(</span><span class="no">$</span><span class="n">table</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="no">$</span><span class="k">set</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">NULL</span><span class="p">,</span><span class="w"> </span><span class="no">$</span><span class="n">escape</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">NULL</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="no">$</span><span class="k">set</span><span class="w"> </span>!<span class="o">==</span><span class="w"> </span><span class="n">NULL</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="no">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="k">set</span><span class="p">(</span><span class="no">$</span><span class="k">set</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="no">$</span><span class="n">escape</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="no">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">_validate_insert</span><span class="p">(</span><span class="no">$</span><span class="n">table</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="p">=</span><span class="w"> </span><span class="n">FALSE</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">FALSE</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="no">$</span><span class="n">sql</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="no">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">_insert</span><span class="p">(</span>
<span class="w">            </span><span class="no">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">protect_identifiers</span><span class="p">(</span>
<span class="w">                </span><span class="no">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">qb_from</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">TRUE</span><span class="p">,</span><span class="w"> </span><span class="no">$</span><span class="n">escape</span><span class="p">,</span><span class="w"> </span><span class="n">FALSE</span>
<span class="w">            </span><span class="p">),</span>
<span class="w">            </span><span class="n">array_keys</span><span class="p">(</span><span class="no">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">qb_set</span><span class="p">),</span>
<span class="w">            </span><span class="n">array_values</span><span class="p">(</span><span class="no">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">qb_set</span><span class="p">)</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="no">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">_reset_write</span><span class="p">();</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="no">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">query</span><span class="p">(</span><span class="no">$</span><span class="n">sql</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>

<p>依然没有任何过滤</p>
<p>然而，关于为什么登入后台即会弹窗，搜索一番后发现，开发者直接将其echo出来（cszcms/views/admin/home.php）：</p>
<p>5.png</p>
<p>6.png</p>
<h3 id="_5">漏洞复现<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p>新建一个用户1.png</p>
<p>点击inbox发送私信，选定管理员用户</p>
<p>2.png修改User-Agent为<code>alert(1)</code>3.png</p>
<p>管理员登陆后台即触发xss4.png</p>
<h2 id="_6">参考链接<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h2>
<blockquote>
<p><a href="https://xz.aliyun.com/t/7730">https://xz.aliyun.com/t/7730</a>#toc-6</p>
</blockquote>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../%EF%BC%88CVE-2019-13086%EF%BC%89CSZ%20CMS%201.2.2%20sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../%EF%BC%88CVE-2019-13086%EF%BC%89CSZ%20CMS%201.2.2%20sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        （CVE-2019-13086）CSZ CMS 1.2.2 sql注入漏洞
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../CRMEB/CRMEB%E7%94%B5%E5%95%86%E7%B3%BB%E7%BB%9FPublicController.php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%28CVE-2024-6944%29/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../CRMEB/CRMEB%E7%94%B5%E5%95%86%E7%B3%BB%E7%BB%9FPublicController.php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%28CVE-2024-6944%29/" class="btn btn-xs btn-link">
        CRMEB电商系统PublicController.php反序列化漏洞(CVE-2024-6944)
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>