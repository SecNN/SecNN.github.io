<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/Web%E5%BA%94%E7%94%A8%E6%BC%8F%E6%B4%9E/Python/PIL-CVE-2017-8291/">
    <link rel="shortcut icon" href="../../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Python PIL/Pillow Remote Command Execution (GhostButt / CVE-2017-8291) - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Python PIL/Pillow Remote Command Execution (GhostButt / CVE-2017-8291)", url: "#_top", children: [
              {title: "Environment Setup", url: "#environment-setup" },
              {title: "Vulnerability Exploitation", url: "#vulnerability-exploitation" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
      <script src="../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="README.zh-cn/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="README.zh-cn/" class="btn btn-xs btn-link">
        Python PIL 远程命令执行漏洞（GhostButt / CVE-2017-8291）
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../pythonaiohttp%E6%8F%92%E4%BB%B6%E5%AD%98%E5%9C%A8%E7%9B%AE%E5%BD%95%E9%81%8D%E5%8E%86%E6%BC%8F%E6%B4%9E%28CVE-2024-23334%29/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../pythonaiohttp%E6%8F%92%E4%BB%B6%E5%AD%98%E5%9C%A8%E7%9B%AE%E5%BD%95%E9%81%8D%E5%8E%86%E6%BC%8F%E6%B4%9E%28CVE-2024-23334%29/" class="btn btn-xs btn-link">
        python aiohttp插件存在目录遍历漏洞(CVE-2024-23334)
      </a>
    </div>
    
  </div>

    

    <h1 id="python-pilpillow-remote-command-execution-ghostbutt-cve-2017-8291">Python PIL/Pillow Remote Command Execution (GhostButt / CVE-2017-8291)<a class="headerlink" href="#python-pilpillow-remote-command-execution-ghostbutt-cve-2017-8291" title="Permanent link">&para;</a></h1>
<p><a href="README.zh-cn/">中文版本(Chinese version)</a></p>
<p>Python PIL (Pillow) is a popular image processing library for Python. It supports various image formats and provides powerful image manipulation capabilities.</p>
<p>The Python image processing module PIL (Pillow) is affected by the GhostButt vulnerability (CVE-2017-8291) because it internally calls GhostScript to process EPS images. This vulnerability allows attackers to execute arbitrary commands on the target system.</p>
<p>When PIL processes an image, it determines the image type based on the file header (Magic Bytes). If it identifies an EPS file (header starting with <code>%!PS</code>), it passes the file to <code>PIL/EpsImagePlugin.py</code> for processing.</p>
<p>In this module, PIL calls the system's GhostScript command (<code>gs</code>) to process the image file:</p>
<div class="highlight"><pre><span></span><code><span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;gs&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-q&quot;</span><span class="p">,</span>                         <span class="c1"># quiet mode</span>
            <span class="s2">&quot;-g</span><span class="si">%d</span><span class="s2">x</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">size</span><span class="p">,</span>             <span class="c1"># set output geometry (pixels)</span>
            <span class="s2">&quot;-r</span><span class="si">%f</span><span class="s2">x</span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">res</span><span class="p">,</span>              <span class="c1"># set input DPI (dots per inch)</span>
            <span class="s2">&quot;-dBATCH&quot;</span><span class="p">,</span>                    <span class="c1"># exit after processing</span>
            <span class="s2">&quot;-dNOPAUSE&quot;</span><span class="p">,</span>                  <span class="c1"># don&#39;t pause between pages,</span>
            <span class="s2">&quot;-dSAFER&quot;</span><span class="p">,</span>                    <span class="c1"># safe mode</span>
            <span class="s2">&quot;-sDEVICE=ppmraw&quot;</span><span class="p">,</span>            <span class="c1"># ppm driver</span>
            <span class="s2">&quot;-sOutputFile=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">outfile</span><span class="p">,</span>  <span class="c1"># output file</span>
            <span class="s2">&quot;-c&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> translate&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="o">-</span><span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                                            <span class="c1"># adjust for image origin</span>
            <span class="s2">&quot;-f&quot;</span><span class="p">,</span> <span class="n">infile</span><span class="p">,</span>                 <span class="c1"># input file</span>
            <span class="p">]</span>

<span class="c1"># Code to check if GhostScript is installed is omitted</span>
<span class="k">try</span><span class="p">:</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="s1">&#39;w+b&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">devnull</span><span class="p">:</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">devnull</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">devnull</span><span class="p">)</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>
</code></pre></div>
<p>Although the <code>-dSAFER</code> flag is set (safe mode), a sandbox bypass vulnerability in GhostScript (GhostButt CVE-2017-8291) allows this safety mechanism to be bypassed, enabling arbitrary command execution.</p>
<p>As of this writing, even the latest official GhostScript version 9.21 is still affected by this vulnerability. Therefore, as long as GhostScript is installed on the operating system, PIL is vulnerable to command execution.</p>
<p>References:</p>
<ul>
<li><a href="http://blog.neargle.com/2017/09/28/Exploiting-Python-PIL-Module-Command-Execution-Vulnerability/">Exploiting Python PIL Module Command Execution Vulnerability</a></li>
<li><a href="https://nvd.nist.gov/vuln/detail/CVE-2017-8291">CVE-2017-8291 Details</a></li>
<li><a href="https://www.ghostscript.com/security-advisories.html">GhostScript Security Advisory</a></li>
</ul>
<h2 id="environment-setup">Environment Setup<a class="headerlink" href="#environment-setup" title="Permanent link">&para;</a></h2>
<p>Execute following command to start a web application that is vulnerable to the CVE-2017-8291 vulnerability:</p>
<div class="highlight"><pre><span></span><code>docker compose up -d
</code></pre></div>
<p>After starting, visit <code>http://your-ip:8000/</code> to access the upload page.</p>
<h2 id="vulnerability-exploitation">Vulnerability Exploitation<a class="headerlink" href="#vulnerability-exploitation" title="Permanent link">&para;</a></h2>
<p>The normal functionality of this application allows users to upload a PNG file. The backend uses PIL to load the image and output its dimensions. However, we can exploit this by changing the extension of an executable EPS file to PNG and uploading it. Since the backend determines the image type based on the file header rather than the extension, the file extension check can be bypassed.</p>
<p>For example, we can upload <a href="poc.png">poc.png</a>, which will execute the command <code>touch /tmp/aaaaa</code> on the server. By modifying the command in the POC to a reverse shell command, we can obtain shell access to the server:</p>
<p><img alt="Vulnerability Exploitation" src="01.png" /></p>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="README.zh-cn/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="README.zh-cn/" class="btn btn-xs btn-link">
        Python PIL 远程命令执行漏洞（GhostButt / CVE-2017-8291）
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../pythonaiohttp%E6%8F%92%E4%BB%B6%E5%AD%98%E5%9C%A8%E7%9B%AE%E5%BD%95%E9%81%8D%E5%8E%86%E6%BC%8F%E6%B4%9E%28CVE-2024-23334%29/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../pythonaiohttp%E6%8F%92%E4%BB%B6%E5%AD%98%E5%9C%A8%E7%9B%AE%E5%BD%95%E9%81%8D%E5%8E%86%E6%BC%8F%E6%B4%9E%28CVE-2024-23334%29/" class="btn btn-xs btn-link">
        python aiohttp插件存在目录遍历漏洞(CVE-2024-23334)
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>