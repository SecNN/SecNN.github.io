<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/Web%E5%BA%94%E7%94%A8%E6%BC%8F%E6%B4%9E/Git/CVE-2017-8386/">
    <link rel="shortcut icon" href="../../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>GIT-SHELL Sandbox Bypass Leads to RCE (CVE-2017-8386) - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "GIT-SHELL Sandbox Bypass Leads to RCE (CVE-2017-8386)", url: "#_top", children: [
              {title: "Environment Setup", url: "#environment-setup" },
              {title: "Vulnerability Reproduction", url: "#vulnerability-reproduction" },
              {title: "Principle", url: "#principle" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
      <script src="../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="README.zh-cn/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="README.zh-cn/" class="btn btn-xs btn-link">
        GIT-SHELL 沙盒绕过导致命令执行漏洞（CVE-2017-8386）
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../Git%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%28CVE-2024-32002%29/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../Git%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%28CVE-2024-32002%29/" class="btn btn-xs btn-link">
        Git远程代码执行漏洞(CVE 2024 32002)
      </a>
    </div>
    
  </div>

    

    <h1 id="git-shell-sandbox-bypass-leads-to-rce-cve-2017-8386">GIT-SHELL Sandbox Bypass Leads to RCE (CVE-2017-8386)<a class="headerlink" href="#git-shell-sandbox-bypass-leads-to-rce-cve-2017-8386" title="Permanent link">&para;</a></h1>
<p><a href="README.zh-cn/">中文版本(Chinese version)</a></p>
<p>Git shell is a login shell for SSH accounts to provide restricted Git access. git-shell in git before 2.4.12, 2.5.x before 2.5.6, 2.6.x before 2.6.7, 2.7.x before 2.7.5, 2.8.x before 2.8.5, 2.9.x before 2.9.4, 2.10.x before 2.10.3, 2.11.x before 2.11.2, and 2.12.x before 2.12.3 might allow remote authenticated users to bypass the git-shell sandbox and execute arbitrary commands, after leveraging a less command-line-based command execution vulnerability.</p>
<p>References:</p>
<ul>
<li><a href="https://insinuator.net/2017/05/git-shell-bypass-by-abusing-less-cve-2017-8386/">https://insinuator.net/2017/05/git-shell-bypass-by-abusing-less-cve-2017-8386/</a></li>
<li><a href="https://www.leavesongs.com/PENETRATION/git-shell-cve-2017-8386.html">https://www.leavesongs.com/PENETRATION/git-shell-cve-2017-8386.html</a></li>
</ul>
<h2 id="environment-setup">Environment Setup<a class="headerlink" href="#environment-setup" title="Permanent link">&para;</a></h2>
<p>Run the following command to start a SSH server that has a git-shell login shell:</p>
<div class="highlight"><pre><span></span><code>docker compose up -d
</code></pre></div>
<p>To avoid port conflicts with the Docker host's SSH port, Vulhub sets the container's SSH port to 3322. In this directory, Vulhub has generated an <code>id_rsa</code> file, which is the SSH private key that you need to specify when connecting.</p>
<p>Before connecting, you need to set the private key permissions to 0600: <code>chmod 0600 id_rsa</code>, otherwise the connection may fail.</p>
<p>When normally connecting to its SSH service <code>ssh -p 3322 -i id_rsa git@127.0.0.1</code>, you will be intercepted by git-shell, returning the error <code>fatal: unrecognized command ''</code>, and the connection will be closed.</p>
<h2 id="vulnerability-reproduction">Vulnerability Reproduction<a class="headerlink" href="#vulnerability-reproduction" title="Permanent link">&para;</a></h2>
<p>Use the --help trick to connect to the target and enter the help page:</p>
<div class="highlight"><pre><span></span><code>ssh -p 3322 -i id_rsa -t git@127.0.0.1 &quot;git-upload-archive &#39;--help&#39;&quot;
</code></pre></div>
<p>Press <code>shift</code>+e to read arbitrary files:</p>
<p><img alt="" src="img/03.png" /></p>
<p>Return to the help page, enter <code>!id</code> to execute commands:</p>
<p><img alt="" src="img/04.png" /></p>
<p>(Why is it the www-data user? Because the git user and www-data user both have ID 33, so they are actually the same user)</p>
<h2 id="principle">Principle<a class="headerlink" href="#principle" title="Permanent link">&para;</a></h2>
<h3 id="git-pull-process-based-on-ssh-protocol">Git Pull Process Based on SSH Protocol<a class="headerlink" href="#git-pull-process-based-on-ssh-protocol" title="Permanent link">&para;</a></h3>
<p>git-shell is an important component of git services. As we know, git services support three protocols for project transmission: SSH, git, and HTTPS, among which SSH is the most secure and convenient.</p>
<p>If we open any project on Github and find the address listed in <code>Clone with SSH</code>: <a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#103;&#105;&#116;&#64;&#103;&#105;&#116;&#104;&#117;&#98;&#46;&#99;&#111;&#109;">&#103;&#105;&#116;&#64;&#103;&#105;&#116;&#104;&#117;&#98;&#46;&#99;&#111;&#109;</a>:phith0n/vulhub.git, this URL actually tells git that the SSH username is git, the address is github.com (default port is 22), and the project is located in the <code>phith0n/vulhub.git</code> directory; then git connects to github.com via SSH protocol and pulls the project from the corresponding directory.</p>
<p>Therefore, git clone and other operations based on SSH protocol are essentially processes of connecting to the git server via SSH protocol and pulling from the specified directory.</p>
<p>So, since this is an SSH interactive process, can I directly execute <code>ssh git@github.com</code> to log in to the github server? Obviously not, you can try:</p>
<p><img alt="" src="img/01.png" /></p>
<p>Saying "not possible" is actually not entirely accurate. I did connect to its SSH service and pass authentication, but it gave me a prompt message "Hi phith0n! You've successfully authenticated, but GitHub does not provide shell access." and then closed my connection.</p>
<p>Therefore, normally, the git pull process based on SSH is secure for the git server.</p>
<p>For information on how to set up a git server, you can refer to <a href="http://www.liaoxuefeng.com/wiki/0013739516305929606dd18361248578c67b8067c8c017b000/00137583770360579bc4b458f044ce7afed3df579123eca000">this article</a></p>
<h3 id="how-to-prevent-git-users-from-executing-system-shell">How to Prevent Git Users from Executing System Shell<a class="headerlink" href="#how-to-prevent-git-users-from-executing-system-shell" title="Permanent link">&para;</a></h3>
<p>So, how do git service providers like GitHub implement the above "secure" communication process?</p>
<p>There are two ways to allow users to authenticate via SSH but not give them a shell:</p>
<ol>
<li>Set the shell to git-shell when creating the system user git</li>
<li>Set command in the authorized_keys file before each ssh-key to override or hijack the original command</li>
</ol>
<p>The first method is more straightforward - when creating the user, instead of giving them a normal bash or sh shell, give them a git-shell. git-shell is a sandbox environment where only commands included in the sandbox can be executed.</p>
<p>The second method is not only used on git servers but also in many Linux distributions. For example, AWS by default does not allow root login, implemented by setting <code>command="echo 'Please login as the user \"ec2-user\" rather than the user \"root\".';echo;sleep 10"</code> in /root/.ssh/authorized_keys. This effectively overrides the original shell execution with an echo command.</p>
<p>Of course, git-shell can also be used within the second method. For example, when adding a git user, give them a normal <code>/bin/bash</code> but set <code>command="git-shell -c \"$SSH_ORIGINAL_COMMAND\""</code> in authorized_keys, which still effectively uses git-shell.</p>
<h3 id="git-shell-sandbox-bypass-vulnerability-cve-2017-8386">git-shell Sandbox Bypass Vulnerability (CVE-2017-8386)<a class="headerlink" href="#git-shell-sandbox-bypass-vulnerability-cve-2017-8386" title="Permanent link">&para;</a></h3>
<p>git-shell is a shell that can restrict user command execution. If we create a new directory called <code>git-shell-commands</code> in the git user's home directory and put the commands you allow users to execute in this directory, we've created a sandbox. In git-shell, only commands in the <code>/home/git/git-shell-commands</code> directory can be executed.</p>
<p>If the system doesn't have a <code>git-shell-commands</code> directory, then git-shell by default only allows the execution of these three commands:</p>
<ul>
<li><code>git-receive-pack &lt;argument&gt;</code></li>
<li><code>git-upload-pack &lt;argument&gt;</code></li>
<li><code>git-upload-archive &lt;argument&gt;</code></li>
</ul>
<p>This is the whitelist.</p>
<p>However, the author of CVE-2017-8386 discovered that executing <code>git-upload-archive --help</code> (or <code>git-receive-pack --help</code>) will enter an interactive man page, which calls the less command, resulting in a help document that can be scrolled up and down.</p>
<p>This seems harmless, but the less command has a feature that supports some interactive methods. For example, in the less page, pressing <code>shift</code>+e opens the Examine function, through which arbitrary files can be read; entering <code>!id</code> can execute the id command.</p>
<p>You can try this on any Linux computer - execute <code>less /etc/passwd</code> to get to the less page, then in English input mode, type <code>!id</code>, and you can execute the id command:</p>
<p><img alt="" src="img/02.png" /></p>
<p>So, using this feature, we can bypass the git-shell sandbox to read arbitrary files or execute arbitrary commands!</p>
<p>We can first try executing <code>git-receive-pack --help</code> directly in Linux, then enter <code>!id</code>, and we'll see similar effects to the above image.</p>
<p><a href="https://evi1cg.me/archives/CVE-2017-8386.html">evi1cg's blog</a> has animated GIFs that make this more intuitive.</p>
<h3 id="exploitation-via-ssh">Exploitation via SSH<a class="headerlink" href="#exploitation-via-ssh" title="Permanent link">&para;</a></h3>
<p>So, how do we exploit this vulnerability remotely?</p>
<p>We tried earlier that directly using <code>ssh git@gitserver</code> only gets us git-shell (or returns a reminder message), so we'll use the sandbox bypass vulnerability mentioned in the previous section to execute commands:</p>
<div class="highlight"><pre><span></span><code>ssh -p 3322 -i id_rsa -t git@127.0.0.1 &quot;git-upload-archive &#39;--help&#39;&quot;
</code></pre></div>
<p>Enter the help page, then press shift+e or enter <code>!id</code>.</p>
<h3 id="some-limitations">Some Limitations<a class="headerlink" href="#some-limitations" title="Permanent link">&para;</a></h3>
<p>As mentioned earlier, there are two ways to configure git users to prevent SSH shell access: one is to set their shell to <code>/usr/bin/git-shell</code> when creating the user, and the other is to override the command in authorized_keys.</p>
<p>If the target server uses the first method, even if we successfully execute <code>git-upload-archive '--help'</code> and enter the help page, we still can't execute commands. This is because <code>!id</code> is still executed under git-shell, and since git-shell doesn't have the id command, it still won't succeed.</p>
<p>However, reading files is always possible because file reading is not done through commands, so it's not affected by the git-shell sandbox.</p>
<p>If the target server configures git-shell using the second method, like in this test environment where I set the git user's shell to bash in the <code>/etc/passwd</code> file but override the command in authorized_keys to execute git-shell.</p>
<p>In this case, if we enter the help page and input <code>!id</code>, we can successfully execute the id command because it's executed under bash rather than git-shell, so there are no sandbox restrictions.</p>
<p>In summary, this vulnerability can at least achieve arbitrary file reading, and potentially arbitrary command execution.</p>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="README.zh-cn/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="README.zh-cn/" class="btn btn-xs btn-link">
        GIT-SHELL 沙盒绕过导致命令执行漏洞（CVE-2017-8386）
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../Git%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%28CVE-2024-32002%29/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../Git%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%28CVE-2024-32002%29/" class="btn btn-xs btn-link">
        Git远程代码执行漏洞(CVE 2024 32002)
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>