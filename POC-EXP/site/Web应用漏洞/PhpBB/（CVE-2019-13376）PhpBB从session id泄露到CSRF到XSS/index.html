<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/Web%E5%BA%94%E7%94%A8%E6%BC%8F%E6%B4%9E/PhpBB/%EF%BC%88CVE-2019-13376%EF%BC%89PhpBB%E4%BB%8Esession%20id%E6%B3%84%E9%9C%B2%E5%88%B0CSRF%E5%88%B0XSS/">
    <link rel="shortcut icon" href="../../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>（CVE-2019-13376）PhpBB从session id泄露到CSRF到XSS - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "\uff08CVE-2019-13376\uff09PhpBB\u4ecesession id\u6cc4\u9732\u5230CSRF\u5230XSS", url: "#_top", children: [
              {title: "\u4e00\u3001\u6f0f\u6d1e\u7b80\u4ecb", url: "#_1" },
              {title: "\u4e8c\u3001\u6f0f\u6d1e\u5f71\u54cd", url: "#_2" },
              {title: "\u4e09\u3001\u590d\u73b0\u8fc7\u7a0b", url: "#_3" },
              {title: "\u53c2\u8003\u94fe\u63a5", url: "#_4" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
      <script src="../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../PhpYun/Phpyun%20v3.1%20xml%20%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../PhpYun/Phpyun%20v3.1%20xml%20%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        Phpyun v3.1 xml 注入漏洞
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../%EF%BC%88CVE-2018-19274%EF%BC%89PhpBB%20Phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../%EF%BC%88CVE-2018-19274%EF%BC%89PhpBB%20Phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        （CVE-2018-19274）PhpBB Phar反序列化远程代码漏洞
      </a>
    </div>
    
  </div>

    

    <h1 id="cve-2019-13376phpbbsession-idcsrfxss">（CVE-2019-13376）PhpBB从session id泄露到CSRF到XSS<a class="headerlink" href="#cve-2019-13376phpbbsession-idcsrfxss" title="Permanent link">&para;</a></h1>
<h2 id="_1">一、漏洞简介<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>该漏洞源于WEB应用未充分验证请求是否来自可信用户。攻击者可利用该漏洞通过受影响客户端向服务器发送非预期的请求。</p>
<h2 id="_2">二、漏洞影响<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>PhpBB 3.2.7</p>
<h2 id="_3">三、复现过程<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<p>首先来看一下phpBB的后台，也就是ACP页面</p>
<p><img alt="1.png" src="../resource/%28CVE-2019-13376%29PhpBB%E4%BB%8Esessionid%E6%B3%84%E9%9C%B2%E5%88%B0CSRF%E5%88%B0XSS/media/rId24.png" /></p>
<p>可以发现所有后台功能的url中都会携带着sid（session id）参数：</p>
<div class="codehilite"><pre><span></span><code>http://www.0-sec.org/phpbb/phpBB/adm/index.php?sid=9c4869b4054e9ff8d4d588c32ffcf7e7&amp;i=1
</code></pre></div>

<p>如果url中sid值错误，即使已经登录后台也无法正常的访问后台页面</p>
<p>phpbb程序这样做的确有着这样做的优点，但也存在着很严重的安全隐患</p>
<p>优点：</p>
<p>在后台功能url中加入sid，相当于增加了一层安全屏障，降低了后台页面出现CSRF漏洞的几率，为什么这样说呢？假使因为开发疏忽，一个表单提交页面没有利用随机数对用户提交的表单进行保护，这通常会导致CSRF漏洞的产生。但是在phpbb应用中，所有的后台功能url中都加入了sid参数且phpbb对sid参数值合法性进行校验，即使攻击者在后台发现了一处没有随机数保护的表单提交页面，但在不知道管理</p>
<p>员sid值的情况下，也无法构造出一个有效的恶意表单提交页面地址</p>
<p>安全隐患：</p>
<p>这样的操作相当于在url中存放了本来只应该出现在cookie中的session
id。如果url中的sid被泄露，攻击者有机会利用这个值伪造管理员身份进行登录后台操作（但不一定可以直接利用，这里涉及到phpBB的一个安全机制，后文会讲到）。</p>
<p>注意看，url中的sid值与cookie中的值完全一样，它们都是此用户的session id值</p>
<p><img alt="2.png" src="../resource/%28CVE-2019-13376%29PhpBB%E4%BB%8Esessionid%E6%B3%84%E9%9C%B2%E5%88%B0CSRF%E5%88%B0XSS/media/rId25.png" /></p>
<p>至于cookie中session值的key ：phpbb3_qnsnz_sid</p>
<p><img alt="3.png" src="../resource/%28CVE-2019-13376%29PhpBB%E4%BB%8Esessionid%E6%B3%84%E9%9C%B2%E5%88%B0CSRF%E5%88%B0XSS/media/rId26.png" /></p>
<p>这个值在系统安装完成之后是固定的，无论什么身份的用户访问都是这个值</p>
<p>因此，如果管理员访问的url中sid值被泄露，攻击者可以有机会利用这个值构造cookie以便使用管理员身份登录后台</p>
<p>但是如何获取这个暴露在url中sid值呢?</p>
<p>由于phpbb的设计特色：当管理员使用完后台功能后想要切换到前台，后台页面中提供了一个跳转到前台地址的按钮</p>
<p>当管理员点击这个按钮切换到前台时，url中会带有sid<img alt="5.png" src="../resource/%28CVE-2019-13376%29PhpBB%E4%BB%8Esessionid%E6%B3%84%E9%9C%B2%E5%88%B0CSRF%E5%88%B0XSS/media/rId27.png" /></p>
<p>其实前台页面的访问并不需要在url中使用sid，但从后台切换过来后url中会默认带上这个值。这就导致本应该只在后台功能url中出现的管理员sid泄露到了管理员访问的前台功能url中，而这个存在于url中的sid值很容易在前台页面加载远程资源时在HTTP_REFERER中被泄露</p>
<p>例如：在一些phpbb站点中可能会开启远程头像选项</p>
<p><img alt="6.png" src="../resource/%28CVE-2019-13376%29PhpBB%E4%BB%8Esessionid%E6%B3%84%E9%9C%B2%E5%88%B0CSRF%E5%88%B0XSS/media/rId28.png" /></p>
<p>这个功能并不是默认开启的，当此功能开启后，用户可以设置远程头像</p>
<p><img alt="7.png" src="../resource/%28CVE-2019-13376%29PhpBB%E4%BB%8Esessionid%E6%B3%84%E9%9C%B2%E5%88%B0CSRF%E5%88%B0XSS/media/rId29.png" /><img alt="8.png" src="../resource/%28CVE-2019-13376%29PhpBB%E4%BB%8Esessionid%E6%B3%84%E9%9C%B2%E5%88%B0CSRF%E5%88%B0XSS/media/rId30.png" />程序会在使用这个远程头像的时候将其加载进来</p>
<p><img alt="9.png" src="../resource/%28CVE-2019-13376%29PhpBB%E4%BB%8Esessionid%E6%B3%84%E9%9C%B2%E5%88%B0CSRF%E5%88%B0XSS/media/rId31.png" /></p>
<p>如果管理员此时访问的页面在渲染时加载了攻击者的远程头像，且此时管理员访问的url中带有sid，sid将会被泄露</p>
<p><img alt="10.png" src="../resource/%28CVE-2019-13376%29PhpBB%E4%BB%8Esessionid%E6%B3%84%E9%9C%B2%E5%88%B0CSRF%E5%88%B0XSS/media/rId32.png" /></p>
<p>我们是否可以构造一个恶意的远程图片链接poc，用以接收管理员的sid呢？</p>
<p>首先看一下phpBB在后台程序如何校验远程图片链接，phpBB使用getImageSize对用户添加的远程图片链接进行校验</p>
<p><img alt="11.png" src="../resource/%28CVE-2019-13376%29PhpBB%E4%BB%8Esessionid%E6%B3%84%E9%9C%B2%E5%88%B0CSRF%E5%88%B0XSS/media/rId33.png" />因此我们可以构造如下poc</p>
<p><img alt="12.png" src="../resource/%28CVE-2019-13376%29PhpBB%E4%BB%8Esessionid%E6%B3%84%E9%9C%B2%E5%88%B0CSRF%E5%88%B0XSS/media/rId34.png" /></p>
<p>poc.php除了需要记录加载该图片请求中的HTTP_REFERER，同时需要将图片进行返回展示</p>
<p><img alt="13.png" src="../resource/%28CVE-2019-13376%29PhpBB%E4%BB%8Esessionid%E6%B3%84%E9%9C%B2%E5%88%B0CSRF%E5%88%B0XSS/media/rId35.png" /></p>
<p>构造远程图片链接</p>
<div class="codehilite"><pre><span></span><code>http://wwww.0-sec.org/poc.php?avatar.png
</code></pre></div>

<p><img alt="14.png" src="../resource/%28CVE-2019-13376%29PhpBB%E4%BB%8Esessionid%E6%B3%84%E9%9C%B2%E5%88%B0CSRF%E5%88%B0XSS/media/rId36.png" /></p>
<p>攻击者的头像加载成功</p>
<p>但是如何使得管理员加载这个头像资源呢？</p>
<p>只要给管理员留言，或者评论管理员发布的文章即可</p>
<p>以评论文章为例：当针对管理员发布的文章发表一条评论之后，管理员在前端页面即可收到一个消息提示</p>
<p><img alt="15.png" src="../resource/%28CVE-2019-13376%29PhpBB%E4%BB%8Esessionid%E6%B3%84%E9%9C%B2%E5%88%B0CSRF%E5%88%B0XSS/media/rId37.png" /></p>
<p>点看之后可以看到被加载的头像</p>
<p><img alt="16.png" src="../resource/%28CVE-2019-13376%29PhpBB%E4%BB%8Esessionid%E6%B3%84%E9%9C%B2%E5%88%B0CSRF%E5%88%B0XSS/media/rId38.png" /></p>
<p>但无论管理员点开与否，在phpbb首页加载时，都会远程加载这个资源，HTTP_REFERER都会被发送到攻击者的服务器上</p>
<p><img alt="17.png" src="../resource/%28CVE-2019-13376%29PhpBB%E4%BB%8Esessionid%E6%B3%84%E9%9C%B2%E5%88%B0CSRF%E5%88%B0XSS/media/rId39.png" /></p>
<p><img alt="18.png" src="../resource/%28CVE-2019-13376%29PhpBB%E4%BB%8Esessionid%E6%B3%84%E9%9C%B2%E5%88%B0CSRF%E5%88%B0XSS/media/rId40.png" /></p>
<p>到此为止，攻击者可以顺利获得sid值。但为什么上文说获取了sid值也不一定可以盗用管理员身份登录系统呢？</p>
<p>在phpBB中有如下的安全策略</p>
<p><img alt="19.png" src="../resource/%28CVE-2019-13376%29PhpBB%E4%BB%8Esessionid%E6%B3%84%E9%9C%B2%E5%88%B0CSRF%E5%88%B0XSS/media/rId41.png" /></p>
<p>Session IP
validation选项用来验证当前用户会话绑定的IP；All选项代表匹配完整地址，A.B.C选项匹配前面的x.x.x段，A.B选项匹配x.x，None选项关闭IP检查。</p>
<p>这项安全策略是用来检验用户sid与IP的绑定关系，系统默认采用A.B.C选项，因此攻击者在获取了管理员sid后，想要冒用身份也是很困难的。</p>
<p>然而这也不是无解的：</p>
<p>phpBB后台管理中包含着编辑BBCode的功能。</p>
<p>BBCode是Bulletin Board
Code的缩写，也有译为「BB代码」的，属于轻量标记语言（Lightweight Markup
Language）的一种，如字面上所显示的，它主要是使用在BBS、论坛、Blog等网络应用上。BBcode的语法通常为
[标记]
这种形式，即语法左右用两个中括号包围，以作为与正常文字间的区别。系统解译时遇上中括号便知道该处是BBcode，会在解译结果输出到用户端时转换成最为通用的HTML语法。</p>
<p><img alt="20.png" src="../resource/%28CVE-2019-13376%29PhpBB%E4%BB%8Esessionid%E6%B3%84%E9%9C%B2%E5%88%B0CSRF%E5%88%B0XSS/media/rId42.png" /></p>
<p>当然，作为后台管理功能，访问此处url也需要sid</p>
<p><img alt="21.png" src="../resource/%28CVE-2019-13376%29PhpBB%E4%BB%8Esessionid%E6%B3%84%E9%9C%B2%E5%88%B0CSRF%E5%88%B0XSS/media/rId43.png" />由于上文的利用，攻击者可以获取sid，因此这里可以确定管理员此处后台功能的确切url</p>
<p>在此页面上，管理员可以添加，删除和编辑自定义BBCode。假如定义了这样的BBCode</p>
<p><img alt="22.png" src="../resource/%28CVE-2019-13376%29PhpBB%E4%BB%8Esessionid%E6%B3%84%E9%9C%B2%E5%88%B0CSRF%E5%88%B0XSS/media/rId44.png" />用户可以在PM、话题或者帖子中使用这个BBCode</p>
<p><img alt="23.png" src="../resource/%28CVE-2019-13376%29PhpBB%E4%BB%8Esessionid%E6%B3%84%E9%9C%B2%E5%88%B0CSRF%E5%88%B0XSS/media/rId45.png" /></p>
<p>结果如下</p>
<p><img alt="24.png" src="../resource/%28CVE-2019-13376%29PhpBB%E4%BB%8Esessionid%E6%B3%84%E9%9C%B2%E5%88%B0CSRF%E5%88%B0XSS/media/rId46.png" /></p>
<p>然而phpBB中编辑BBCode的功能存在CSRF问题，首先看一下编辑BBCode功能的后台代码</p>
<p><img alt="25.png" src="../resource/%28CVE-2019-13376%29PhpBB%E4%BB%8Esessionid%E6%B3%84%E9%9C%B2%E5%88%B0CSRF%E5%88%B0XSS/media/rId47.png" /></p>
<p>可以看到，这里的确有对csrf进行防范</p>
<p><img alt="26.png" src="../resource/%28CVE-2019-13376%29PhpBB%E4%BB%8Esessionid%E6%B3%84%E9%9C%B2%E5%88%B0CSRF%E5%88%B0XSS/media/rId48.png" /></p>
<p>但是问题出在了前面的$submit参数：</p>
<p><img alt="27.png" src="../resource/%28CVE-2019-13376%29PhpBB%E4%BB%8Esessionid%E6%B3%84%E9%9C%B2%E5%88%B0CSRF%E5%88%B0XSS/media/rId49.png" /></p>
<p>只有提交的POST请求中存在submit参数，系统才会检查CSRF nonce。反之不会</p>
<p>因此，只要构造csrf时，请求中不带submit参数即可</p>
<p>$action、$bbcode_id、$bbcode_match与$bbcode_tpl参数均有$request-&gt;variable方式获取而来</p>
<p><img alt="28.png" src="../resource/%28CVE-2019-13376%29PhpBB%E4%BB%8Esessionid%E6%B3%84%E9%9C%B2%E5%88%B0CSRF%E5%88%B0XSS/media/rId50.png" /></p>
<p><img alt="29.png" src="../resource/%28CVE-2019-13376%29PhpBB%E4%BB%8Esessionid%E6%B3%84%E9%9C%B2%E5%88%B0CSRF%E5%88%B0XSS/media/rId51.png" /></p>
<p>variable方法不仅会获取POST中提交的变量，也会获取通过GET提交的变量，这意味着攻击者可以通过GET参数传参来进行CSRF攻击。</p>
<p>当csrf攻击成功后，恶意的bbcode将会被添加。之后攻击者可以滥用这个bbcode短代码，在消息、话题、帖子、回复中执行任意XSS代码。</p>
<h2 id="_4">参考链接<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<blockquote>
<p><a href="https://xz.aliyun.com/t/7829">https://xz.aliyun.com/t/7829</a></p>
</blockquote>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../PhpYun/Phpyun%20v3.1%20xml%20%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../PhpYun/Phpyun%20v3.1%20xml%20%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        Phpyun v3.1 xml 注入漏洞
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../%EF%BC%88CVE-2018-19274%EF%BC%89PhpBB%20Phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../%EF%BC%88CVE-2018-19274%EF%BC%89PhpBB%20Phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        （CVE-2018-19274）PhpBB Phar反序列化远程代码漏洞
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>