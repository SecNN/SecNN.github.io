<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/Web%E5%BA%94%E7%94%A8%E6%BC%8F%E6%B4%9E/Php/inclusion/">
    <link rel="shortcut icon" href="../../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>PHP Local File Inclusion RCE with PHPINFO - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "PHP Local File Inclusion RCE with PHPINFO", url: "#_top", children: [
              {title: "Vulnerable Environment", url: "#vulnerable-environment" },
              {title: "Exploit Details", url: "#exploit-details" },
              {title: "Exploit", url: "#exploit" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
      <script src="../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="README.zh-cn/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="README.zh-cn/" class="btn btn-xs btn-link">
        PHP文件包含漏洞（利用phpinfo）
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../fpm/README.zh-cn/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../fpm/README.zh-cn/" class="btn btn-xs btn-link">
        PHP-FPM FastCGI 未授权访问漏洞
      </a>
    </div>
    
  </div>

    

    <h1 id="php-local-file-inclusion-rce-with-phpinfo">PHP Local File Inclusion RCE with PHPINFO<a class="headerlink" href="#php-local-file-inclusion-rce-with-phpinfo" title="Permanent link">&para;</a></h1>
<p><a href="README.zh-cn/">中文版本(Chinese version)</a></p>
<p>In PHP file inclusion vulnerabilities, when we cannot find a valid file to include for triggering RCE, we might be able to include a temporary file to exploit it if there exists PHPINFO which can tell us the randomly generated filename of the temporary file and its location.</p>
<p>Reference:</p>
<ul>
<li><a href="https://dl.packetstormsecurity.net/papers/general/LFI_With_PHPInfo_Assitance.pdf">https://dl.packetstormsecurity.net/papers/general/LFI_With_PHPInfo_Assitance.pdf</a></li>
</ul>
<h2 id="vulnerable-environment">Vulnerable Environment<a class="headerlink" href="#vulnerable-environment" title="Permanent link">&para;</a></h2>
<p>To start the vulnerable environment:</p>
<div class="highlight"><pre><span></span><code>docker compose up -d
</code></pre></div>
<p>The target environment is the latest PHP 7.2, which tell us this vulnerability exists regardless of the version.</p>
<p>After the environment is started, access <code>http://your-ip:8080/phpinfo.php</code> to get a PHPINFO page and <code>http://your-ip:8080/lfi.php?file=/etc/passwd</code> shows there is an LFI vulnerability.</p>
<h2 id="exploit-details">Exploit Details<a class="headerlink" href="#exploit-details" title="Permanent link">&para;</a></h2>
<p>When sending a POST request to PHP and the request contains a FILE block, PHP will save the file posted into a temporary file (usually <code>/tmp/php[6 random digits]</code>), the filename can be found at <code>$_FILES</code> variable. This temp file will be deleted after the request is over.</p>
<p>In the meantime, PHPINFO page prints all the variables in the context, including <code>$_FILES</code>. So, the temp file's name can be found in the response if we send the POST request to the PHPINFO page.</p>
<p>In this way, an LFI vulnerability can be promoted into an RCE without an existed useable local file.</p>
<p>File inclusion and PHPINFO are usually in different web pages. In theory, we need to send the filename to the file inclusion page after retrieving the it in the response of the file uploading request to the PHPINFO page. However, after the first request finishes, the file would be removed from the disk, so we need to win the race.</p>
<p>Steps:</p>
<ol>
<li>Send the file upload request to PHPINFO page with the HEADER and GET fields filled with large chunks of junk data.</li>
<li>The response content would be huge because PHPINFO will print out all the data.</li>
<li>PHP's default output buffer size is 4096 bytes. It can be understood as PHP return 4096 bytes each time during a socket connection.</li>
<li>So we use raw socket to achieve our goal. Each time we read 4096 bytes and send the filename to the LFI page once we get it.</li>
<li>By the time we got the filename, the first socket connection has not ended, which means the temp file still exists at that time.</li>
<li>By taking advantage of the time gap, the temp file can be included and executed.</li>
</ol>
<h2 id="exploit">Exploit<a class="headerlink" href="#exploit" title="Permanent link">&para;</a></h2>
<p>The python script <a href="exp.py">exp.py</a> implements the above process. After successfully include the temp file, <code>&lt;?php file_put_contents('/tmp/g', '&lt;?=eval($_REQUEST[1])?&gt;')?&gt;</code> will be executed to generate a permanent file <code>/tmp/g</code> for further use.</p>
<p>use python2：<code>python exp.py your-ip 8080 100</code>:</p>
<p><img alt="" src="1.png" /></p>
<p>The script success at the 189<sup>th</sup> packet, after that arbitrary code can be executed:</p>
<p><img alt="" src="2.png" /></p>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="README.zh-cn/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="README.zh-cn/" class="btn btn-xs btn-link">
        PHP文件包含漏洞（利用phpinfo）
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../fpm/README.zh-cn/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../fpm/README.zh-cn/" class="btn btn-xs btn-link">
        PHP-FPM FastCGI 未授权访问漏洞
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>