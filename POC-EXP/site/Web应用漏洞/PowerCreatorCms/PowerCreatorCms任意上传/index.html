<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/Web%E5%BA%94%E7%94%A8%E6%BC%8F%E6%B4%9E/PowerCreatorCms/PowerCreatorCms%E4%BB%BB%E6%84%8F%E4%B8%8A%E4%BC%A0/">
    <link rel="shortcut icon" href="../../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>PowerCreatorCms任意上传 - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "PowerCreatorCms\u4efb\u610f\u4e0a\u4f20", url: "#_top", children: [
              {title: "\u7f16\u8f91\u5668\u4efb\u610f\u6587\u4ef6\u4e0a\u4f20", url: "#_1" },
              {title: "\u4efb\u610f\u6587\u4ef6\u4e0a\u4f20\u6f0f\u6d1e", url: "#_2" },
              {title: "\u6587\u7ae0\u6765\u6e90", url: "#_3" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
      <script src="../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../PowerJob/PowerJob%20list%20%E4%BF%A1%E6%81%AF%E6%B3%84%E6%BC%8F%E6%BC%8F%E6%B4%9E%20CVE-2023-29923/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../PowerJob/PowerJob%20list%20%E4%BF%A1%E6%81%AF%E6%B3%84%E6%BC%8F%E6%BC%8F%E6%B4%9E%20CVE-2023-29923/" class="btn btn-xs btn-link">
        PowerJob list 信息泄漏漏洞 CVE-2023-29923
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../PowerCreator/PowerCreator%E6%8E%A5%E5%8F%A3UploadResourcePic.ashx%E5%AD%98%E5%9C%A8%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../PowerCreator/PowerCreator%E6%8E%A5%E5%8F%A3UploadResourcePic.ashx%E5%AD%98%E5%9C%A8%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        PowerCreator接口UploadResourcePic.ashx存在任意文件上传漏洞
      </a>
    </div>
    
  </div>

    

    <h1 id="powercreatorcms">PowerCreatorCms任意上传<a class="headerlink" href="#powercreatorcms" title="Permanent link">&para;</a></h1>
<h2 id="_1">编辑器任意文件上传<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>根据描述，是编辑器的漏洞，查看源码发现该CMS采用了kindeditor编辑器，该编辑器存在任意文件上传漏洞</p>
<p><img alt="20201104204822-05ba7d7a-1e9c-1" src="../resource/PowerCreatorCms%E4%BB%BB%E6%84%8F%E4%B8%8A%E4%BC%A0/media/20201104204822-05ba7d7a-1e9c-1.png" /></p>
<p>因为这个是烂大街的东西，关于对<code>kindeditor</code>编辑器任意文件上传的分析文章网上一搜一大堆，因此这里就略了。另外经过复现发现，只能传<code>txt</code>和<code>html</code>，不能传<code>aspx</code>，很鸡肋。</p>
<p><img alt="20201104205137-79d2316c-1e9c-1" src="../resource/PowerCreatorCms%E4%BB%BB%E6%84%8F%E4%B8%8A%E4%BC%A0/media/20201104205137-79d2316c-1e9c-1.png" /></p>
<p><img alt="20201104205140-7bf49d2c-1e9c-1" src="../resource/PowerCreatorCms%E4%BB%BB%E6%84%8F%E4%B8%8A%E4%BC%A0/media/20201104205140-7bf49d2c-1e9c-1.png" /></p>
<h2 id="_2">任意文件上传漏洞<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<h3 id="uploadresourcepicashx">UploadResourcePic.ashx<a class="headerlink" href="#uploadresourcepicashx" title="Permanent link">&para;</a></h3>
<p>根据发现的两个shell，很明显shell的命名不是通过kindeditor编辑器上传的，一定是通过其他的方法上传上去的，那么我们来分析一下漏洞到底在哪呢？查找具有上传功能的点，发现了upload目录里全是上传功能文件</p>
<p><img alt="20201104205815-66f1683c-1e9d-1" src="../resource/PowerCreatorCms%E4%BB%BB%E6%84%8F%E4%B8%8A%E4%BC%A0/media/20201104205815-66f1683c-1e9d-1.png" /></p>
<p>再结合第一个webshell路径：第一个shell：<a href="http://xxx.xxx.xxx.xxx./resourcePic/MQ==.ASPX">http://xxx.xxx.xxx.xxx./resourcePic/MQ==.ASPX</a>
根据这个ResourcePic目录，发现是上传功能目录下UploadResourcePic.ashx这样一个文件上传后保存的位置，对其进行代码审计</p>
<div class="highlight"><pre><span></span><code><span class="o">&lt;%</span><span class="err">@</span><span class="w"> </span><span class="n">WebHandler</span><span class="w"> </span><span class="n">Language</span><span class="o">=</span><span class="s">&quot;C#&quot;</span><span class="w"> </span><span class="n">Class</span><span class="o">=</span><span class="s">&quot;UploadResourcePic&quot;</span><span class="w"> </span><span class="o">%&gt;</span>

<span class="k">using</span><span class="w"> </span><span class="nn">System</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">System.Web</span><span class="p">;</span>

<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">UploadResourcePic</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">IHttpHandler</span>
<span class="p">{</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">ProcessRequest</span><span class="p">(</span><span class="n">HttpContext</span><span class="w"> </span><span class="n">context</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">ContentType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;text/plain&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="kt">string</span><span class="w"> </span><span class="n">rid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Request</span><span class="p">[</span><span class="s">&quot;ResourceID&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="kt">string</span><span class="p">.</span><span class="n">IsNullOrEmpty</span><span class="p">(</span><span class="n">rid</span><span class="p">))</span>
<span class="w">        </span><span class="p">{</span>


<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Files</span><span class="p">.</span><span class="n">Count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="n">HttpPostedFile</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Files</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="w">                </span><span class="kt">string</span><span class="w"> </span><span class="n">Url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PowerCreator</span><span class="p">.</span><span class="n">MediaServer</span><span class="p">.</span><span class="n">PublicClass</span><span class="p">.</span><span class="n">WebUtils</span><span class="p">.</span><span class="n">WebRoot</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;./resourcePic/&quot;</span><span class="p">;</span>
<span class="w">                </span><span class="kt">string</span><span class="w"> </span><span class="n">Path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Server</span><span class="p">.</span><span class="n">MapPath</span><span class="p">(</span><span class="n">Url</span><span class="p">);</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">IO</span><span class="p">.</span><span class="n">Directory</span><span class="p">.</span><span class="n">Exists</span><span class="p">(</span><span class="n">Path</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">false</span><span class="p">)</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                    </span><span class="n">System</span><span class="p">.</span><span class="n">IO</span><span class="p">.</span><span class="n">Directory</span><span class="p">.</span><span class="n">CreateDirectory</span><span class="p">(</span><span class="n">Path</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">                </span><span class="kt">string</span><span class="w"> </span><span class="n">ext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">file</span><span class="p">.</span><span class="n">FileName</span><span class="p">.</span><span class="n">Substring</span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="n">FileName</span><span class="p">.</span><span class="n">LastIndexOf</span><span class="p">(</span><span class="sc">&#39;.&#39;</span><span class="p">)).</span><span class="n">ToUpper</span><span class="p">();</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="n">ContentType</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;image/jpeg&quot;</span><span class="p">)</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                    </span><span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="k">else</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                    </span><span class="kt">string</span><span class="w"> </span><span class="n">newFileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PowerCreator</span><span class="p">.</span><span class="n">MediaServer</span><span class="p">.</span><span class="n">PublicClass</span><span class="p">.</span><span class="n">Base64</span><span class="p">.</span><span class="n">Encode</span><span class="p">(</span><span class="n">rid</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ext</span><span class="p">;</span>
<span class="w">                    </span><span class="n">file</span><span class="p">.</span><span class="n">SaveAs</span><span class="p">(</span><span class="n">Path</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">newFileName</span><span class="p">);</span>
<span class="w">                    </span><span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="n">newFileName</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">else</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="s">&quot;参数错误&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">End</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">IsReusable</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">get</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">false</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="p">}</span>
</code></pre></div>
<p>代码逻辑及漏洞如图所示：</p>
<p><img alt="20201104212911-b9c0d7d8-1ea1-1" src="../resource/PowerCreatorCms%E4%BB%BB%E6%84%8F%E4%B8%8A%E4%BC%A0/media/20201104212911-b9c0d7d8-1ea1-1.png" /></p>
<p><img alt="20201104212921-bf728582-1ea1-1" src="../resource/PowerCreatorCms%E4%BB%BB%E6%84%8F%E4%B8%8A%E4%BC%A0/media/20201104212921-bf728582-1ea1-1.png" /></p>
<p>根据上面的分析，其实漏洞的关键点就是上传接口未授权访问可以直接进行上传操作，存在一个Content-Type为image/jpeg的判断，另外需要注意的是传递一个ResourceID变量才能成功进入到上传逻辑。</p>
<p>直接访问，没传递rid变量，回显参数错误，因此上传接口前面没有任何校验，可以直接进行文件上传操作</p>
<p><img alt="20201104210127-d9de64b2-1e9d-1" src="../resource/PowerCreatorCms%E4%BB%BB%E6%84%8F%E4%B8%8A%E4%BC%A0/media/20201104210127-d9de64b2-1e9d-1.png" /></p>
<p>给rid变量赋个值，也即任意使用get方法或者post方法传递ResourceID变量，但是由于不存在文件上传操作，报文类型不符合multipart/form-data规范，因此返回-1</p>
<p><img alt="20201104210302-12435cb8-1e9e-1" src="../resource/PowerCreatorCms%E4%BB%BB%E6%84%8F%E4%B8%8A%E4%BC%A0/media/20201104210302-12435cb8-1e9e-1.png" /></p>
<p>那么只要本地构造一个上传表单，在上传的时候将Content-Type改成image/jpeg，就可以进行任意文件上传，上传过后文件命会是ResourceID变量的值进行base64编码+上传文件的扩展名</p>
<p>本地构造表单</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">&quot;http://xxx.xxx.xxx.xxx/upload/UploadResourcePic.ashx?ResourceID=1&quot;</span> <span class="na">enctype</span><span class="o">=</span><span class="s">&quot;multipart/form-data&quot;</span> <span class="na">method</span><span class="o">=</span><span class="s">&quot;POST&quot;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;file&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;file1&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;file1&quot;</span> <span class="p">/&gt;</span>
<span class="p">&lt;</span><span class="nt">button</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;but1&quot;</span><span class="p">&gt;</span>上传<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</code></pre></div>
<p>改一个Content-Type为image/jpeg，即可成功getshell</p>
<p><img alt="20201104213121-06d7b6f4-1ea2-1" src="../resource/PowerCreatorCms%E4%BB%BB%E6%84%8F%E4%B8%8A%E4%BC%A0/media/20201104213121-06d7b6f4-1ea2-1.png" /></p>
<h3 id="uploadcoursepicashx">uploadCoursePic.ashx<a class="headerlink" href="#uploadcoursepicashx" title="Permanent link">&para;</a></h3>
<p>接下来还有一个webshell，<a href="http://xxx.xxx.xxx.xxx/fileManager/UploadFile/CoursePic/485b1b71-8035-44c1-9ceb-637cd68eda19.ASPX">http://xxx.xxx.xxx.xxx/fileManager/UploadFile/CoursePic/485b1b71-8035-44c1-9ceb-637cd68eda19.ASPX</a></p>
<div class="highlight"><pre><span></span><code><span class="o">&lt;%</span><span class="err">@</span><span class="w"> </span><span class="n">WebHandler</span><span class="w"> </span><span class="n">Language</span><span class="o">=</span><span class="s">&quot;C#&quot;</span><span class="w"> </span><span class="n">Class</span><span class="o">=</span><span class="s">&quot;uploadCoursePic&quot;</span><span class="w"> </span><span class="o">%&gt;</span>

<span class="k">using</span><span class="w"> </span><span class="nn">System</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">System.Web</span><span class="p">;</span>

<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">uploadCoursePic</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">IHttpHandler</span>
<span class="p">{</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">ProcessRequest</span><span class="p">(</span><span class="n">HttpContext</span><span class="w"> </span><span class="n">context</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">ContentType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;text/plain&quot;</span><span class="p">;</span>

<span class="w">        </span><span class="kt">string</span><span class="w"> </span><span class="n">delFileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Request</span><span class="p">[</span><span class="s">&quot;fileName&quot;</span><span class="p">];</span>
<span class="w">        </span><span class="kt">string</span><span class="w"> </span><span class="n">CourseID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Request</span><span class="p">[</span><span class="s">&quot;CourseID&quot;</span><span class="p">];</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="kt">string</span><span class="p">.</span><span class="n">IsNullOrEmpty</span><span class="p">(</span><span class="n">CourseID</span><span class="p">))</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">delFileName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PowerCreator</span><span class="p">.</span><span class="n">MediaServer</span><span class="p">.</span><span class="n">Course</span><span class="p">.</span><span class="n">Logic</span><span class="p">.</span><span class="n">Course</span><span class="p">().</span><span class="n">Load</span><span class="p">(</span><span class="kt">int</span><span class="p">.</span><span class="n">Parse</span><span class="p">(</span><span class="n">CourseID</span><span class="p">)).</span><span class="n">PicPath</span><span class="p">)</span>
<span class="w">                </span><span class="n">delFileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="kt">string</span><span class="p">.</span><span class="n">IsNullOrEmpty</span><span class="p">(</span><span class="n">delFileName</span><span class="p">))</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">try</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="n">System</span><span class="p">.</span><span class="n">IO</span><span class="p">.</span><span class="n">File</span><span class="p">.</span><span class="n">Delete</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">Server</span><span class="p">.</span><span class="n">MapPath</span><span class="p">(</span><span class="n">delFileName</span><span class="p">));</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Files</span><span class="p">.</span><span class="n">Count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">HttpPostedFile</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Files</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="w">            </span><span class="kt">string</span><span class="w"> </span><span class="n">Url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PowerCreator</span><span class="p">.</span><span class="n">MediaServer</span><span class="p">.</span><span class="n">PublicClass</span><span class="p">.</span><span class="n">WebUtils</span><span class="p">.</span><span class="n">WebRoot</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;/fileManager/UploadFile/CoursePic/&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="kt">string</span><span class="w"> </span><span class="n">Path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Server</span><span class="p">.</span><span class="n">MapPath</span><span class="p">(</span><span class="n">Url</span><span class="p">);</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">IO</span><span class="p">.</span><span class="n">Directory</span><span class="p">.</span><span class="n">Exists</span><span class="p">(</span><span class="n">Path</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">false</span><span class="p">)</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="n">System</span><span class="p">.</span><span class="n">IO</span><span class="p">.</span><span class="n">Directory</span><span class="p">.</span><span class="n">CreateDirectory</span><span class="p">(</span><span class="n">Path</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="kt">string</span><span class="w"> </span><span class="n">ext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">file</span><span class="p">.</span><span class="n">FileName</span><span class="p">.</span><span class="n">Substring</span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="n">FileName</span><span class="p">.</span><span class="n">LastIndexOf</span><span class="p">(</span><span class="sc">&#39;.&#39;</span><span class="p">)).</span><span class="n">ToUpper</span><span class="p">();</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="s">&quot;.PNG.JPG&quot;</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="n">ext</span><span class="p">))</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="kt">string</span><span class="w"> </span><span class="n">newFileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Guid</span><span class="p">.</span><span class="n">NewGuid</span><span class="p">().</span><span class="n">ToString</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ext</span><span class="p">;</span>
<span class="w">            </span><span class="n">file</span><span class="p">.</span><span class="n">SaveAs</span><span class="p">(</span><span class="n">Path</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">newFileName</span><span class="p">);</span>
<span class="w">            </span><span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="n">Url</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">newFileName</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">IsReusable</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">get</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">false</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="p">}</span>
</code></pre></div>
<p>前面一部分代码做了一个文件删除的操作，没什么用，重点在28行开始，分析如下：</p>
<p><img alt="20201104213208-22b78188-1ea2-1" src="../resource/PowerCreatorCms%E4%BB%BB%E6%84%8F%E4%B8%8A%E4%BC%A0/media/20201104213208-22b78188-1ea2-1.png" /></p>
<p>漏洞原因在于：如果没有通过扩展名为图片的判断的话，会返回-2，但是返回以后程序并没有退出或跳过文件上传操作，依然进行了文件上传操作。我真是没想明白，开发做了这一步判断的目的是什么。。。。。。。。</p>
<p>那么payload的构造就很简单了，直接对着uploadCoursePic.ashx接口发一个multipart/form-data规范报文，无需任何绕过</p>
<p><img alt="20201104212109-9a30a296-1ea0-1" src="../resource/PowerCreatorCms%E4%BB%BB%E6%84%8F%E4%B8%8A%E4%BC%A0/media/20201104212109-9a30a296-1ea0-1.png" /></p>
<p>返回了一个-2，紧接着跟着了成功上传的webshell的地址，和我们分析的预期一模一样</p>
<h3 id="uploadlogoashx">UploadLogo.ashx<a class="headerlink" href="#uploadlogoashx" title="Permanent link">&para;</a></h3>
<p>本来分析应该到此为止了的，正好作为一个合格的划水的蓝方，闲着也是闲着，不如把其他上传接口也一并看一遍吧，UploadLogo.ashx，代码如下：</p>
<div class="highlight"><pre><span></span><code><span class="o">&lt;%</span><span class="err">@</span><span class="w"> </span><span class="n">WebHandler</span><span class="w"> </span><span class="n">Language</span><span class="o">=</span><span class="s">&quot;C#&quot;</span><span class="w"> </span><span class="n">Class</span><span class="o">=</span><span class="s">&quot;UploadLogo&quot;</span><span class="w"> </span><span class="o">%&gt;</span>

<span class="k">using</span><span class="w"> </span><span class="nn">System</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="nn">System.Web</span><span class="p">;</span>

<span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">UploadLogo</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">IHttpHandler</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">ProcessRequest</span><span class="w"> </span><span class="p">(</span><span class="n">HttpContext</span><span class="w"> </span><span class="n">context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">ContentType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;text/plain&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Files</span><span class="p">.</span><span class="n">Count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">HttpPostedFile</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Files</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="w">            </span><span class="kt">string</span><span class="w"> </span><span class="n">Url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PowerCreator</span><span class="p">.</span><span class="n">MediaServer</span><span class="p">.</span><span class="n">PublicClass</span><span class="p">.</span><span class="n">WebUtils</span><span class="p">.</span><span class="n">WebRoot</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;/images/logo/&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="kt">string</span><span class="w"> </span><span class="n">Path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Server</span><span class="p">.</span><span class="n">MapPath</span><span class="p">(</span><span class="n">Url</span><span class="p">);</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">IO</span><span class="p">.</span><span class="n">Directory</span><span class="p">.</span><span class="n">Exists</span><span class="p">(</span><span class="n">Path</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">false</span><span class="p">)</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="n">System</span><span class="p">.</span><span class="n">IO</span><span class="p">.</span><span class="n">Directory</span><span class="p">.</span><span class="n">CreateDirectory</span><span class="p">(</span><span class="n">Path</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="kt">string</span><span class="w"> </span><span class="n">ext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">file</span><span class="p">.</span><span class="n">FileName</span><span class="p">.</span><span class="n">Substring</span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="n">FileName</span><span class="p">.</span><span class="n">LastIndexOf</span><span class="p">(</span><span class="sc">&#39;.&#39;</span><span class="p">)).</span><span class="n">ToUpper</span><span class="p">();</span>
<span class="w">            </span><span class="kt">string</span><span class="w"> </span><span class="n">newFileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Request</span><span class="p">[</span><span class="s">&quot;fileName&quot;</span><span class="p">];</span>
<span class="w">            </span><span class="n">file</span><span class="p">.</span><span class="n">SaveAs</span><span class="p">(</span><span class="n">Path</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">newFileName</span><span class="p">);</span>
<span class="w">            </span><span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="n">Url</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">newFileName</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">End</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">IsReusable</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">get</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">false</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="p">}</span>
</code></pre></div>
<p><img alt="20201104211833-3ce4e96c-1ea0-1" src="../resource/PowerCreatorCms%E4%BB%BB%E6%84%8F%E4%B8%8A%E4%BC%A0/media/20201104211833-3ce4e96c-1ea0-1.png" /></p>
<p>文件会传到logo目录，如图</p>
<p><img alt="20201104214631-25a495e6-1ea4-1" src="../resource/PowerCreatorCms%E4%BB%BB%E6%84%8F%E4%B8%8A%E4%BC%A0/media/20201104214631-25a495e6-1ea4-1.png" /></p>
<p>如果不赋值fileName变量会报错，如图</p>
<p><img alt="20201104212327-ec6e00a8-1ea0-1" src="../resource/PowerCreatorCms%E4%BB%BB%E6%84%8F%E4%B8%8A%E4%BC%A0/media/20201104212327-ec6e00a8-1ea0-1.png" /></p>
<p>只要在上传的时候通过get或者post给fileName赋值即可，payload如下</p>
<p><img alt="20201104212342-f5a4e6be-1ea0-1" src="../resource/PowerCreatorCms%E4%BB%BB%E6%84%8F%E4%B8%8A%E4%BC%A0/media/20201104212342-f5a4e6be-1ea0-1.png" /></p>
<h3 id="uploadactpicaspx">uploadActPic.aspx不存在漏洞<a class="headerlink" href="#uploadactpicaspx" title="Permanent link">&para;</a></h3>
<p>其实其他几个文件都不存在任意文件上传漏洞了，这里就不再赘述，但是uploadActPic.aspx这个文件比较特殊，里面全是HTML代码，真正的代码通过父类来引入，在dll中，分析过程如下:</p>
<p><img alt="20201104212612-4e7a1d40-1ea1-1" src="../resource/PowerCreatorCms%E4%BB%BB%E6%84%8F%E4%B8%8A%E4%BC%A0/media/20201104212612-4e7a1d40-1ea1-1.png" /></p>
<p>哥斯拉导出bin目录</p>
<p><img alt="20201104212642-605d172e-1ea1-1" src="../resource/PowerCreatorCms%E4%BB%BB%E6%84%8F%E4%B8%8A%E4%BC%A0/media/20201104212642-605d172e-1ea1-1.png" /></p>
<p>使用dnspy反编译dll文件，uploadActPic方法在LMS_MediaServer.dll这个文件里，查看逻辑使用白名单校验，不存在任意文件上传</p>
<p><img alt="20201104212652-6652c19c-1ea1-1" src="../resource/PowerCreatorCms%E4%BB%BB%E6%84%8F%E4%B8%8A%E4%BC%A0/media/20201104212652-6652c19c-1ea1-1.png" /></p>
<p>至此，代码审计结束</p>
<h2 id="_3">文章来源<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<blockquote>
<p><a href="https://xz.aliyun.com/t/8478">https://xz.aliyun.com/t/8478</a></p>
</blockquote>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../PowerJob/PowerJob%20list%20%E4%BF%A1%E6%81%AF%E6%B3%84%E6%BC%8F%E6%BC%8F%E6%B4%9E%20CVE-2023-29923/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../PowerJob/PowerJob%20list%20%E4%BF%A1%E6%81%AF%E6%B3%84%E6%BC%8F%E6%BC%8F%E6%B4%9E%20CVE-2023-29923/" class="btn btn-xs btn-link">
        PowerJob list 信息泄漏漏洞 CVE-2023-29923
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../PowerCreator/PowerCreator%E6%8E%A5%E5%8F%A3UploadResourcePic.ashx%E5%AD%98%E5%9C%A8%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../PowerCreator/PowerCreator%E6%8E%A5%E5%8F%A3UploadResourcePic.ashx%E5%AD%98%E5%9C%A8%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        PowerCreator接口UploadResourcePic.ashx存在任意文件上传漏洞
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>