<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/Web%E5%BA%94%E7%94%A8%E6%BC%8F%E6%B4%9E/ECShop/Ecshop%204.0.7%20%E4%BB%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%B0%E7%B1%BB%E5%9E%8B%E6%B7%B7%E6%B7%86%E6%BC%8F%E6%B4%9E/">
    <link rel="shortcut icon" href="../../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Ecshop 从反序列化到类型混淆漏洞 - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Ecshop \u4ece\u53cd\u5e8f\u5217\u5316\u5230\u7c7b\u578b\u6df7\u6dc6\u6f0f\u6d1e", url: "#_top", children: [
              {title: "\u4e00\u3001\u6f0f\u6d1e\u7b80\u4ecb", url: "#_1" },
              {title: "\u4e8c\u3001\u6f0f\u6d1e\u5f71\u54cd", url: "#_3" },
              {title: "\u4e09\u3001\u590d\u73b0\u8fc7\u7a0b", url: "#_4" },
              {title: "\u53c2\u8003\u94fe\u63a5", url: "#_7" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
      <script src="../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../collection_list-sqli/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../collection_list-sqli/" class="btn btn-xs btn-link">
        ECShop 4.x collection_list SQL Injection
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../ECShop%20_%3D%202.7.x%20%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../ECShop%20_%3D%202.7.x%20%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        ECShop \&lt;= 2.7.x 代码执行漏洞
      </a>
    </div>
    
  </div>

    

    <h1 id="ecshop">Ecshop 从反序列化到类型混淆漏洞<a class="headerlink" href="#ecshop" title="Permanent link">&para;</a></h1>
<h2 id="_1">一、漏洞简介<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<h3 id="_2">漏洞利用条件<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<p>•php 5.6.x</p>
<p>•反序列化入口点</p>
<p>•可以触发__wakeup的触发点（在php \&lt; 5.6.11以下，可以使用内置类）</p>
<h2 id="_3">二、漏洞影响<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<p>Ecshop 4.0.7</p>
<h2 id="_4">三、复现过程<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<p>首先我们需要找到一个反序列化入口点，这里我们可以全局搜索<code>unserialize</code>，挨个看一下我们可以找到两个可控的反序列化入口。</p>
<p>其中一个是search.php line 45</p>
<div class="codehilite"><pre><span></span><code>...
{
    $string = base64_decode(trim($_GET[&#39;encode&#39;]));

    if ($string !== false)
    {
        $string = unserialize($string);
        if ($string !== false)
...
</code></pre></div>

<p>这是一个前台的入口，但可惜的是引入初始化文件在反序列化之后，这也就导致我们没办法找到可以覆盖类变量属性的目标，也就没办法进一步利用。</p>
<p>还有一个是<code>admin/order.php</code> line 229</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="o">/*</span><span class="w"> </span>取得上一个、下一个订单号<span class="w"> </span><span class="o">*/</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>!<span class="n">empty</span><span class="p">(</span><span class="no">$</span><span class="n">_COOKIE</span><span class="p">[</span><span class="s">&#39;ECSCP&#39;</span><span class="p">][</span><span class="s">&#39;lastfilter&#39;</span><span class="p">]))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="no">$</span><span class="nb">filter</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">unserialize</span><span class="p">(</span><span class="n">urldecode</span><span class="p">(</span><span class="no">$</span><span class="n">_COOKIE</span><span class="p">[</span><span class="s">&#39;ECSCP&#39;</span><span class="p">][</span><span class="s">&#39;lastfilter&#39;</span><span class="p">]));</span>

<span class="w">       </span><span class="p">...</span>
</code></pre></div>

<p>后台的表单页的这个功能就满足我们的要求了，不但可控，还可以用urlencode来绕过ecshop对全局变量的过滤。</p>
<p>这样一来我们就找到了一个可控并且合适的反序列化入口点。</p>
<h3 id="_5">寻找合适的类属性利用链<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p>在寻找利用链之前，我们可以用</p>
<div class="codehilite"><pre><span></span><code>get_declared_classes()
</code></pre></div>

<p>来确定在反序列化时，已经声明定义过的类。</p>
<p>在我本地环境下，除了PHP内置类以外我一共找到13个类</p>
<div class="codehilite"><pre><span></span><code>  [129]=&gt;
  string(3) &quot;ECS&quot;
  [130]=&gt;
  string(9) &quot;ecs_error&quot;
  [131]=&gt;
  string(8) &quot;exchange&quot;
  [132]=&gt;
  string(9) &quot;cls_mysql&quot;
  [133]=&gt;
  string(11) &quot;cls_session&quot;
  [134]=&gt;
  string(12) &quot;cls_template&quot;
  [135]=&gt;
  string(11) &quot;certificate&quot;
  [136]=&gt;
  string(6) &quot;oauth2&quot;
  [137]=&gt;
  string(15) &quot;oauth2_response&quot;
  [138]=&gt;
  string(14) &quot;oauth2_request&quot;
  [139]=&gt;
  string(9) &quot;transport&quot;
  [140]=&gt;
  string(6) &quot;matrix&quot;
  [141]=&gt;
  string(16) &quot;leancloud_client&quot;
</code></pre></div>

<p>从代码中也可以看到在文件头引入了多个库文件</p>
<div class="codehilite"><pre><span></span><code>require(dirname(__FILE__) . &#39;/includes/init.php&#39;);
require_once(ROOT_PATH . &#39;includes/lib_order.php&#39;);
require_once(ROOT_PATH . &#39;includes/lib_goods.php&#39;);
require_once(ROOT_PATH . &#39;includes/cls_matrix.php&#39;);
include_once(ROOT_PATH . &#39;includes/cls_certificate.php&#39;);
require(&#39;leancloud_push.php&#39;);
</code></pre></div>

<p>这里我们主要关注init.php，因为在这个文件中声明了ecshop的大部分通用类。</p>
<p>在逐个看这里面的类变量时，我们可以敏锐的看到一个特殊的变量，由于ecshop的后台结构特殊，页面内容大多都是由模板编译而成，而这个模板类恰好也在init.php中声明</p>
<div class="codehilite"><pre><span></span><code>require(ROOT_PATH . &#39;includes/cls_template.php&#39;);
$smarty = new cls_template;
</code></pre></div>

<p>回到order.php中我们寻找与<code>$smarty</code>相关的方法，不难发现，主要集中在两个方法中</p>
<div class="codehilite"><pre><span></span><code><span class="p">...</span>
<span class="w">    </span><span class="n">$smarty</span><span class="o">-&gt;</span><span class="k">assign</span><span class="p">(&#39;</span><span class="n">shipping</span><span class="p">&#39;,</span><span class="w"> </span><span class="n">$shipping</span><span class="p">);</span>

<span class="w">    </span><span class="n">$smarty</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">(&#39;</span><span class="n">print</span><span class="p">.</span><span class="n">htm</span><span class="p">&#39;);</span>
<span class="p">...</span>
</code></pre></div>

<p>而这里我们主要把视角集中在display方法上。</p>
<p>粗略的浏览下display方法的逻辑大致是</p>
<div class="codehilite"><pre><span></span><code><span class="err">请求相应的模板文件</span>
<span class="o">--&gt;</span>
<span class="err">经过一系列判断，将相应的模板文件做相应的编译</span>
<span class="o">--&gt;</span>
<span class="err">输出编译后的文件地址</span>
</code></pre></div>

<p>比较重要的代码会在<code>make_compiled</code>这个函数中被定义</p>
<div class="codehilite"><pre><span></span><code><span class="k">function</span><span class="w"> </span><span class="nf">make_compiled</span><span class="p">(</span>$filename<span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span>$<span class="n">name</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>$<span class="n">this</span><span class="o">-&gt;</span><span class="n">compile_dir</span><span class="w"> </span><span class="p">.</span><span class="w"> </span><span class="s">&#39;/&#39;</span><span class="w"> </span><span class="p">.</span><span class="w"> </span><span class="n">basename</span><span class="p">(</span>$<span class="n">filename</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="w"> </span><span class="s">&#39;.php&#39;</span><span class="p">;</span>

<span class="w">        </span><span class="k">...</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>$<span class="n">this</span><span class="o">-&gt;</span><span class="n">force_compile</span><span class="w"> </span><span class="o">||</span><span class="w"> </span>$<span class="n">filestat</span><span class="p">[</span><span class="s">&#39;mtime&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span>$<span class="n">expires</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span>$<span class="n">this</span><span class="o">-&gt;</span><span class="n">_current_file</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>$<span class="n">filename</span><span class="p">;</span>
<span class="w">            </span>$<span class="n">source</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>$<span class="n">this</span><span class="o">-&gt;</span><span class="n">fetch_str</span><span class="p">(</span><span class="n">file_get_contents</span><span class="p">(</span>$<span class="n">filename</span><span class="p">));</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">file_put_contents</span><span class="p">(</span>$<span class="n">name</span><span class="p">,</span><span class="w"> </span>$<span class="n">source</span><span class="p">,</span><span class="w"> </span><span class="n">LOCK_EX</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="p">=</span><span class="w"> </span><span class="nb">false</span><span class="p">)</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="n">trigger_error</span><span class="p">(</span><span class="s">&#39;can\&#39;</span><span class="n">t</span><span class="w"> </span><span class="nb">write</span><span class="p">:</span><span class="s">&#39;</span><span class="err"> . $name);</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span>$<span class="n">source</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>$<span class="n">this</span><span class="o">-&gt;</span><span class="n">_eval</span><span class="p">(</span>$<span class="n">source</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span>$<span class="n">source</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>

<p>当流程走到这一步的时候，我们需要先找到我们的目标是什么？</p>
<p>重新审视<code>cls_template.php</code>的代码，我们可以发现涉及到代码执行的只有几个函数。</p>
<div class="codehilite"><pre><span></span><code><span class="w">   </span><span class="k">function</span><span class="w"> </span><span class="nf">get_para</span><span class="p">(</span>$val, $type = 1<span class="p">)</span><span class="w"> </span><span class="o">//</span><span class="w"> </span>处理<span class="n">insert外部函数</span><span class="o">/</span>需要<span class="n">include运行的函数的调用数据</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span>$<span class="n">pa</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>$<span class="n">this</span><span class="o">-&gt;</span><span class="n">str_trim</span><span class="p">(</span>$<span class="n">val</span><span class="p">);</span>
<span class="w">        </span><span class="n">foreach</span><span class="w"> </span><span class="p">(</span>$<span class="n">pa</span><span class="w"> </span><span class="n">AS</span><span class="w"> </span>$<span class="n">value</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strrpos</span><span class="p">(</span>$<span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;=&#39;</span><span class="p">))</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="n">list</span><span class="p">(</span>$<span class="n">a</span><span class="p">,</span><span class="w"> </span>$<span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">explode</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">str_replace</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;&quot;&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&#39;&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;&quot;&#39;</span><span class="p">),</span><span class="w"> </span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="w"> </span>$<span class="n">value</span><span class="p">));</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>$<span class="n">b</span><span class="p">{</span><span class="mi">0</span><span class="p">}</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&#39;$&#39;</span><span class="p">)</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>$<span class="nb">type</span><span class="p">)</span>
<span class="w">                    </span><span class="p">{</span>
<span class="w">                        </span><span class="nb">eval</span><span class="p">(</span><span class="s">&#39;$para[\&#39;&#39; . $a . &#39;</span><span class="o">\</span><span class="s">&#39;]=&#39;</span><span class="w"> </span><span class="p">.</span><span class="w"> </span>$<span class="n">this</span><span class="o">-&gt;</span><span class="n">get_val</span><span class="p">(</span><span class="n">substr</span><span class="p">(</span>$<span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="p">.</span><span class="w"> </span><span class="s">&#39;;&#39;</span><span class="p">);</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                    </span><span class="k">else</span>
<span class="w">                    </span><span class="p">{</span>
<span class="w">                        </span>$<span class="n">para</span><span class="p">[</span>$<span class="n">a</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>$<span class="n">this</span><span class="o">-&gt;</span><span class="n">get_val</span><span class="p">(</span><span class="n">substr</span><span class="p">(</span>$<span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="k">else</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                    </span>$<span class="n">para</span><span class="p">[</span>$<span class="n">a</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>$<span class="n">b</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span>$<span class="n">para</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>

<p>get_para只在select中调用，但是没找到能触发select的地方。</p>
<p>然后是pop_vars</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="k">function</span><span class="w"> </span><span class="nf">pop_vars</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span>$<span class="n">key</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">array_pop</span><span class="p">(</span>$<span class="n">this</span><span class="o">-&gt;</span><span class="n">_temp_key</span><span class="p">);</span>
<span class="w">        </span>$<span class="n">val</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">array_pop</span><span class="p">(</span>$<span class="n">this</span><span class="o">-&gt;</span><span class="n">_temp_val</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>!<span class="nb">empty</span><span class="p">(</span>$<span class="n">key</span><span class="p">))</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nb">eval</span><span class="p">(</span>$<span class="n">key</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>

<p>恰好配合GMP我们可以控制<code>$this-&gt;_temp_key</code>变量，所以我们只要能在上面的流程中找到任意地方调用这个方法，我们就可以配合变量覆盖构造一个代码执行。</p>
<p>在回看刚才的代码流程时，我们从编译后的PHP文件中找到了这样的代码</p>
<p>order_info.htm.php</p>
<div class="codehilite"><pre><span></span><code><span class="w">  </span><span class="cp">&lt;?php</span> <span class="k">endforeach</span><span class="p">;</span> <span class="k">endif</span><span class="p">;</span> <span class="nb">unset</span><span class="p">(</span><span class="nv">$_from</span><span class="p">);</span> <span class="cp">?&gt;&lt;?php</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">pop_vars</span><span class="p">();;</span> <span class="cp">?&gt;</span>
</code></pre></div>

<p>在遍历完表单之后，正好会触发<code>pop_vars</code>。</p>
<p>这样一来，只要我们控制覆盖<code>cls_template</code>变量的<code>_temp_key</code>属性，我们就可以完成一次getshell</p>
<h3 id="_6">最终利用效果<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<p>1.png</p>
<h2 id="_7">参考链接<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h2>
<blockquote>
<p><a href="https://mp.weixin.qq.com/s/KD0fKbSA9SUGY1lGas1xSA">https://mp.weixin.qq.com/s/KD0fKbSA9SUGY1lGas1xSA</a></p>
</blockquote>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../collection_list-sqli/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../collection_list-sqli/" class="btn btn-xs btn-link">
        ECShop 4.x collection_list SQL Injection
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../ECShop%20_%3D%202.7.x%20%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../ECShop%20_%3D%202.7.x%20%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        ECShop \&lt;= 2.7.x 代码执行漏洞
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>