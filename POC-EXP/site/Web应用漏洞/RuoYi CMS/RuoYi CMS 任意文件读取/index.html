<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/Web%E5%BA%94%E7%94%A8%E6%BC%8F%E6%B4%9E/RuoYi%20CMS/RuoYi%20CMS%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96/">
    <link rel="shortcut icon" href="../../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>RuoYi CMS 任意文件读取 - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "RuoYi CMS \u4efb\u610f\u6587\u4ef6\u8bfb\u53d6", url: "#_top", children: [
              {title: "1.\u524d\u8a00", url: "#1" },
              {title: "2.\u5206\u6790\u8fc7\u5ea6", url: "#2" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
      <script src="../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../RuvarOA%E5%8D%8F%E5%90%8C%E5%8A%9E%E5%85%AC%E5%B9%B3%E5%8F%B0/RuvarOA%E5%8D%8F%E5%90%8C%E5%8A%9E%E5%85%AC%E5%B9%B3%E5%8F%B0%E5%A4%9A%E5%A4%84%E5%AD%98%E5%9C%A8SQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../RuvarOA%E5%8D%8F%E5%90%8C%E5%8A%9E%E5%85%AC%E5%B9%B3%E5%8F%B0/RuvarOA%E5%8D%8F%E5%90%8C%E5%8A%9E%E5%85%AC%E5%B9%B3%E5%8F%B0%E5%A4%9A%E5%A4%84%E5%AD%98%E5%9C%A8SQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        RuvarOA协同办公平台多处存在SQL注入漏洞
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../RuoYi/%E8%8B%A5%E4%BE%9D%E5%90%8E%E5%8F%B0%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%AD%98%E5%9C%A8SSRF%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../RuoYi/%E8%8B%A5%E4%BE%9D%E5%90%8E%E5%8F%B0%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%AD%98%E5%9C%A8SSRF%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        若依后台定时任务存在SSRF漏洞
      </a>
    </div>
    
  </div>

    

    <h1 id="ruoyi-cms">RuoYi CMS 任意文件读取<a class="headerlink" href="#ruoyi-cms" title="Permanent link">&para;</a></h1>
<p>POC：</p>
<div class="highlight"><pre><span></span><code>https://domain/common/download/resource?resource=/profile/../../../../etc/passwd
</code></pre></div>
<h2 id="1">1.前言<a class="headerlink" href="#1" title="Permanent link">&para;</a></h2>
<p>看到T00ls有位老哥求助某CMS的getshell方法，于是下载了该CMS进行审计，由于审计技术很菜，只找到了任意文件读取漏洞。</p>
<h2 id="2">2.分析过度<a class="headerlink" href="#2" title="Permanent link">&para;</a></h2>
<p>1、<strong>看山不是山</strong>  打开源码，看到“通用下载请求”的实现方法，先研究一下。<img alt="image-20201109164827975" src="../resource/RuoYi%20CMS%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96/media/image-20201109164827975.png" />
流程如下：1、传入两个参数，一个文件名参数，一个delete参数，控制是否删除2、将全局变量中的下载路径和用户传入的文件名进行拼接<img alt="999990.png" src="https://www.hackexp.cn/content/uploadfile/202006/0a061592016072.png" />
其中getProfile()获取资源下载路径，该下载路径在配置文件中声明了，如下：<img alt="image-20201109164820331" src="../resource/RuoYi%20CMS%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96/media/image-20201109164820331.png" /></p>
<p>3、先读取文件，然后再到FileUtils.writeBytes方法，将文件内容放到response流中。</p>
<p><img alt="image-20201109164816483" src="../resource/RuoYi%20CMS%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96/media/image-20201109164816483.png" />
4、然后判断是否删除文件。</p>
<p><img alt="image-20201109164812062" src="../resource/RuoYi%20CMS%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96/media/image-20201109164812062.png" />
 POC构造：</p>
<p><code>任意文件读取：/common/download?fileName=1.txt&amp;delete=false</code></p>
<p><img alt="image-20201109164804728" src="../resource/RuoYi%20CMS%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96/media/image-20201109164804728.png" /></p>
<p>任意文件删除：/common/download?fileName=1.txt&amp;delete=true</p>
<p><img alt="image-20201109164750336" src="../resource/RuoYi%20CMS%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96/media/image-20201109164750336.png" /></p>
<p>原以为到这里就可以任意文件读取和删除了，但是忽略了一个点，就是isValidFilename函数，该函数的实现如下：   </p>
<ul>
<li><code>public static String FILENAME_PATTERN = "[a-zA-Z0-9_\\-\\|\\.\\u4e00-\\u9fa5]+";
        /**
         * 文件名称验证
         * 
         * @param filename 文件名称
         * @return true 正常 false 非法
         */
        public static boolean isValidFilename(String filename)
    {
            return filename.matches(FILENAME_PATTERN);
        }</code></li>
</ul>
<p>过滤了/和\，无法跨目录。</p>
<p><img alt="image-20201109164743172" src="../resource/RuoYi%20CMS%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96/media/image-20201109164743172.png" /></p>
<div class="codehilite"><pre><span></span><code><span class="err">那这个点就没什么用了，只能删除</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">ruoyi</span><span class="o">/</span><span class="n">uploadPath</span><span class="o">/</span><span class="n">download</span><span class="o">/</span><span class="err">目录下的文件。</span>
</code></pre></div>

<p>2、看山还是山**  往下一翻，还有一个点下载的点，如下：<img alt="999990.png" src="../resource/RuoYi%20CMS%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96/media/0a061592016876.png" />从代码可以看出，下载流程如下：1、从GET请求中获取resource参数的值（可控点）*</p>
<p><em>2、传入StringUtils.*substringAfter</em> 方法进行处理后，与localPath拼接</p>
<p>3、带入将FileUtils.writeBytes处理结果作为response的返回值。
   其中StringUtils.substringAfter(finalString str, final String separator) 方法，其实是从str中查找separtator，然后取标志位后面的字符。<img alt="999990.png" src="../resource/RuoYi%20CMS%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96/media/0a061592016957.png" />
   在resourceDownload中，传入的标志位是：Constants.RESOURCE_PREFIX，一个全局变量，该变量的值是
   <img alt="999990.png" src="../resource/RuoYi%20CMS%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96/media/0a061592017037.png" />
   那么我们在构造URL时候，需要在想要下载的路径前面加上/profile。
   所以poc为：</p>
<p><code>/common/download/resource?resource=/profile/test.txt</code>
   穿越目录下载文件的POC：</p>
<p><code>/common/download/resource?resource=/profile/../../../../test.txt</code></p>
<p><img alt="image-20201109164730890" src="../resource/RuoYi%20CMS%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96/media/image-20201109164730890.png" /> </p>
<p>利用点比较鸡肋，只能下载本地资源所在盘符下的文件，但是linux系统下就不受这个影响了。</p>
<p><img alt="image-20201109155051451" src="../resource/RuoYi%20CMS%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96/media/image-20201109155051451.png" /></p>
<div class="codehilite"><pre><span></span><code><span class="mf">3.</span><span class="n">总结</span>
</code></pre></div>

<p>虽然利用很鸡肋，但还是学到了很多东西。在Windows环境下，默认的资源路径在D:/ruoyi/uploadPath,所以只能下载D:/下的文件，一般都可以下载到数据库配置文件吧。在Linux环境下，完全不受限制了，可以下载任意目录下的文件（只要权限够），数据库配置在xxx-admin/src/main/resources下application-druid.yml文件中，有时候目录名会变化，可以先下载根目录下的pom.xml查看目录名，如下：<img alt="999990.png" src="../resource/RuoYi%20CMS%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96/media/0a061592017258.png" />
    温馨提示：bash_history可以看下，或许有惊喜。</p>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../RuvarOA%E5%8D%8F%E5%90%8C%E5%8A%9E%E5%85%AC%E5%B9%B3%E5%8F%B0/RuvarOA%E5%8D%8F%E5%90%8C%E5%8A%9E%E5%85%AC%E5%B9%B3%E5%8F%B0%E5%A4%9A%E5%A4%84%E5%AD%98%E5%9C%A8SQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../RuvarOA%E5%8D%8F%E5%90%8C%E5%8A%9E%E5%85%AC%E5%B9%B3%E5%8F%B0/RuvarOA%E5%8D%8F%E5%90%8C%E5%8A%9E%E5%85%AC%E5%B9%B3%E5%8F%B0%E5%A4%9A%E5%A4%84%E5%AD%98%E5%9C%A8SQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        RuvarOA协同办公平台多处存在SQL注入漏洞
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../RuoYi/%E8%8B%A5%E4%BE%9D%E5%90%8E%E5%8F%B0%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%AD%98%E5%9C%A8SSRF%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../RuoYi/%E8%8B%A5%E4%BE%9D%E5%90%8E%E5%8F%B0%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%AD%98%E5%9C%A8SSRF%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        若依后台定时任务存在SSRF漏洞
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>